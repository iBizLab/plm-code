!function(){function e(t){return e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e(t)}function t(e,n,r){return t=g()?Reflect.construct.bind():function(e,t,n){var r=[null];r.push.apply(r,t);var o=new(Function.bind.apply(e,r));return n&&v(o,n.prototype),o},t.apply(null,arguments)}function n(e){return function(e){if(Array.isArray(e))return i(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||o(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function r(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=o(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,u=!0,c=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return u=e.done,e},e:function(e){c=!0,a=e},f:function(){try{u||null==n.return||n.return()}finally{if(c)throw a}}}}function o(e,t){if(e){if("string"==typeof e)return i(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?i(e,t):void 0}}function i(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function a(e,t,n){return(t=p(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function u(){"use strict";/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */u=function(){return n};var t,n={},r=Object.prototype,o=r.hasOwnProperty,i=Object.defineProperty||function(e,t,n){e[t]=n.value},a="function"==typeof Symbol?Symbol:{},c=a.iterator||"@@iterator",l=a.asyncIterator||"@@asyncIterator",d=a.toStringTag||"@@toStringTag";function s(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{s({},"")}catch(t){s=function(e,t,n){return e[t]=n}}function f(e,t,n,r){var o=t&&t.prototype instanceof b?t:b,a=Object.create(o.prototype),u=new R(r||[]);return i(a,"_invoke",{value:T(e,n,u)}),a}function p(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}n.wrap=f;var h="suspendedStart",v="suspendedYield",y="executing",g="completed",m={};function b(){}function w(){}function x(){}var N={};s(N,c,(function(){return this}));var _=Object.getPrototypeOf,D=_&&_(_(M([])));D&&D!==r&&o.call(D,c)&&(N=D);var E=x.prototype=b.prototype=Object.create(N);function k(e){["next","throw","return"].forEach((function(t){s(e,t,(function(e){return this._invoke(t,e)}))}))}function I(t,n){function r(i,a,u,c){var l=p(t[i],t,a);if("throw"!==l.type){var d=l.arg,s=d.value;return s&&"object"==e(s)&&o.call(s,"__await")?n.resolve(s.__await).then((function(e){r("next",e,u,c)}),(function(e){r("throw",e,u,c)})):n.resolve(s).then((function(e){d.value=e,u(d)}),(function(e){return r("throw",e,u,c)}))}c(l.arg)}var a;i(this,"_invoke",{value:function(e,t){function o(){return new n((function(n,o){r(e,t,n,o)}))}return a=a?a.then(o,o):o()}})}function T(e,n,r){var o=h;return function(i,a){if(o===y)throw new Error("Generator is already running");if(o===g){if("throw"===i)throw a;return{value:t,done:!0}}for(r.method=i,r.arg=a;;){var u=r.delegate;if(u){var c=C(u,r);if(c){if(c===m)continue;return c}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(o===h)throw o=g,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);o=y;var l=p(e,n,r);if("normal"===l.type){if(o=r.done?g:v,l.arg===m)continue;return{value:l.arg,done:r.done}}"throw"===l.type&&(o=g,r.method="throw",r.arg=l.arg)}}}function C(e,n){var r=n.method,o=e.iterator[r];if(o===t)return n.delegate=null,"throw"===r&&e.iterator.return&&(n.method="return",n.arg=t,C(e,n),"throw"===n.method)||"return"!==r&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+r+"' method")),m;var i=p(o,e.iterator,n.arg);if("throw"===i.type)return n.method="throw",n.arg=i.arg,n.delegate=null,m;var a=i.arg;return a?a.done?(n[e.resultName]=a.value,n.next=e.nextLoc,"return"!==n.method&&(n.method="next",n.arg=t),n.delegate=null,m):a:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,m)}function O(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function S(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function R(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(O,this),this.reset(!0)}function M(n){if(n||""===n){var r=n[c];if(r)return r.call(n);if("function"==typeof n.next)return n;if(!isNaN(n.length)){var i=-1,a=function e(){for(;++i<n.length;)if(o.call(n,i))return e.value=n[i],e.done=!1,e;return e.value=t,e.done=!0,e};return a.next=a}}throw new TypeError(e(n)+" is not iterable")}return w.prototype=x,i(E,"constructor",{value:x,configurable:!0}),i(x,"constructor",{value:w,configurable:!0}),w.displayName=s(x,d,"GeneratorFunction"),n.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===w||"GeneratorFunction"===(t.displayName||t.name))},n.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,x):(e.__proto__=x,s(e,d,"GeneratorFunction")),e.prototype=Object.create(E),e},n.awrap=function(e){return{__await:e}},k(I.prototype),s(I.prototype,l,(function(){return this})),n.AsyncIterator=I,n.async=function(e,t,r,o,i){void 0===i&&(i=Promise);var a=new I(f(e,t,r,o),i);return n.isGeneratorFunction(t)?a:a.next().then((function(e){return e.done?e.value:a.next()}))},k(E),s(E,d,"Generator"),s(E,c,(function(){return this})),s(E,"toString",(function(){return"[object Generator]"})),n.keys=function(e){var t=Object(e),n=[];for(var r in t)n.push(r);return n.reverse(),function e(){for(;n.length;){var r=n.pop();if(r in t)return e.value=r,e.done=!1,e}return e.done=!0,e}},n.values=M,R.prototype={constructor:R,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(S),!e)for(var n in this)"t"===n.charAt(0)&&o.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=t)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var n=this;function r(r,o){return u.type="throw",u.arg=e,n.next=r,o&&(n.method="next",n.arg=t),!!o}for(var i=this.tryEntries.length-1;i>=0;--i){var a=this.tryEntries[i],u=a.completion;if("root"===a.tryLoc)return r("end");if(a.tryLoc<=this.prev){var c=o.call(a,"catchLoc"),l=o.call(a,"finallyLoc");if(c&&l){if(this.prev<a.catchLoc)return r(a.catchLoc,!0);if(this.prev<a.finallyLoc)return r(a.finallyLoc)}else if(c){if(this.prev<a.catchLoc)return r(a.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return r(a.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var r=this.tryEntries[n];if(r.tryLoc<=this.prev&&o.call(r,"finallyLoc")&&this.prev<r.finallyLoc){var i=r;break}}i&&("break"===e||"continue"===e)&&i.tryLoc<=t&&t<=i.finallyLoc&&(i=null);var a=i?i.completion:{};return a.type=e,a.arg=t,i?(this.method="next",this.next=i.finallyLoc,m):this.complete(a)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),m},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),S(n),m}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var o=r.arg;S(n)}return o}}throw new Error("illegal catch attempt")},delegateYield:function(e,n,r){return this.delegate={iterator:M(e),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=t),m}},n}function c(e,t,n,r,o,i,a){try{var u=e[i](a),c=u.value}catch(l){return void n(l)}u.done?t(c):Promise.resolve(c).then(r,o)}function l(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var i=e.apply(t,n);function a(e){c(i,r,o,a,u,"next",e)}function u(e){c(i,r,o,a,u,"throw",e)}a(void 0)}))}}function d(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,p(r.key),r)}}function f(e,t,n){return t&&s(e.prototype,t),n&&s(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function p(t){var n=function(t,n){if("object"!==e(t)||null===t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var o=r.call(t,n||"default");if("object"!==e(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===n?String:Number)(t)}(t,"string");return"symbol"===e(n)?n:String(n)}function h(){return h="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=m(e)););return e}(e,t);if(r){var o=Object.getOwnPropertyDescriptor(r,t);return o.get?o.get.call(arguments.length<3?e:n):o.value}},h.apply(this,arguments)}function v(e,t){return v=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},v(e,t)}function y(t){var n=g();return function(){var r,o=m(t);if(n){var i=m(this).constructor;r=Reflect.construct(o,arguments,i)}else r=o.apply(this,arguments);return function(t,n){if(n&&("object"===e(n)||"function"==typeof n))return n;if(void 0!==n)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(t)}(this,r)}}function g(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function m(e){return m=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},m(e)}System.register(["@ibiz-template/runtime","@ibiz-template/vue3-util","vue","qx-util","lodash-es","@ibiz-template/core","ramda"],(function(e,o){"use strict";var i,c,s,p,g,b,w,x,N,_,D,E,k,I,T,C,O,S,R,M,j,L,P,K,A,B,z,F,U;return{setters:[function(e){i=e.TreeController,c=e.getChildNodeRSs,s=e.calcDeCodeNameById,p=e.handleAllSettled,g=e.Srfuf,b=e.getControlPanel,w=e.registerControlProvider},function(e){x=e.useControlController,N=e.useNamespace,_=e.withInstall},function(e){D=e.defineComponent,E=e.reactive,k=e.ref,I=e.watch,T=e.computed,C=e.nextTick,O=e.resolveComponent,S=e.onMounted,R=e.onUnmounted,M=e.withDirectives,j=e.createVNode,L=e.resolveDirective,P=e.isVNode,K=e.createTextVNode},function(e){A=e.createUUID},function(e){B=e.debounce},function(e){z=e.RuntimeError,F=e.RuntimeModelError},function(e){U=e.isNil}],execute:function(){function V(e,t){var n=t.state.items.find((function(t){return t._id===e}));return n||t.state.items.find((function(t){return t._uuid===e}))}var G=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&v(e,t)}(N,e);var t,o,i,b,w,x=y(N);function N(){return d(this,N),x.apply(this,arguments)}return f(N,[{key:"initState",value:function(){h(m(N.prototype),"initState",this).call(this),this.state.newingNodeModel=null,this.state.newingNodeText=null,this.state.newingNodeDefault=null,this.state.editingNodeKey=null,this.state.editingNodeText=null,this.state.editingNodeDefault=null}},{key:"onDataChange",value:function(e){}},{key:"initDropNodeRss",value:function(){var e,t=this;null===(e=this.model.detreeNodes)||void 0===e||e.forEach((function(e){if(e.allowDrop){var n=[];c(t.model,{parentId:e.id,hasQuery:!1}).forEach((function(e){var r;if(null!==(r=e.parentDER1N)&&void 0!==r&&r.pickupDEFName){var o=t.getNodeModel(e.childDETreeNodeId);"DE"===(null==o?void 0:o.treeNodeType)&&o.appDataEntityId&&n.push({minorEntityId:o.appDataEntityId,pickupDEFName:e.parentDER1N.pickupDEFName.toLowerCase(),childDETreeNodeId:e.childDETreeNodeId,detreeNodeRSParams:e.detreeNodeRSParams})}})),n.length>0&&t.dropNodeRss.set(e.id,n)}}))}},{key:"updateTreeNode",value:function(e){var t=e.nodeKey,n=e.defaultValue;if(t&&t!==this.state.editingNodeKey){var r=V(t,this),o=this.getNodeModel(r._nodeId);null!=o&&o.allowEditText&&(this.state.editingNodeKey=r._id,this.state.editingNodeText=r._text,this.state.editingNodeDefault=n,this.state.newingNodeModel=null,this.state.newingNodeText=null,this.state.newingNodeDefault=null)}}},{key:"removeTreeNode",value:function(e){if(e&&e!==this.state.editingNodeKey){var t=V(e,this),n={context:this.context||{},params:this.params||{},data:[t]};this.onRemoveTreeNode(n)}}},{key:"newTreeNode",value:function(e){var t=e.nodeType,n=e.defaultValue,r=void 0===n?{}:n,o=this.getNodeModel(t);this.state.newingNodeModel=o,this.state.newingNodeDefault=r,this.state.editingNodeKey=null,this.state.editingNodeText=null,this.state.editingNodeDefault=null}},{key:"createDeNodeData",value:(w=l(u().mark((function e(t){var n,r=this;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=ibiz.hub.getApp(this.context.srfappid),e.next=3,Promise.all(t.map(function(){var e=l(u().mark((function e(t){var o,i,a;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=r.getNodeModel(t._nodeId),i=t._deData,a=r.context.clone(),e.next=5,n.deService.exec(o.appDataEntityId,"create",a,i);case 5:e.sent.data&&r.refresh();case 7:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 3:case"end":return e.stop()}}),e,this)}))),function(e){return w.apply(this,arguments)})},{key:"onCreateTreeNode",value:(b=l(u().mark((function e(){var t,n,r,o,i;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.state.newingNodeModel,n=t.textAppDEFieldId,r=t.id,o=this.state.newingNodeText,i={_deData:{}},Object.assign(i,{_nodeId:r,_text:o}),Object.assign(i._deData,a({},n,o)),this.state.newingNodeDefault&&Object.assign(i._deData,this.state.newingNodeDefault),Object.assign(i._deData,a({},n,o)),e.next=9,this.createDeNodeData([i]);case 9:this.state.newingNodeModel=null,this.state.newingNodeText=null,this.state.newingNodeDefault=null;case 12:case"end":return e.stop()}}),e,this)}))),function(){return b.apply(this,arguments)})},{key:"onModifyTreeNode",value:(i=l(u().mark((function e(t,n){var r,o,i=this;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((r=this.getNodeModel(t._nodeId)).allowEditText){e.next=3;break}throw new F(r,"树节点没有配置编辑模式：名称");case 3:if("DE"===t._nodeType){e.next=5;break}throw new z("不是实体树节点数据");case 5:return t._text=n,this.state.editingNodeDefault&&(o=Object.keys(this.state.editingNodeDefault))&&o.length>0&&o.forEach((function(e){U(t._deData[e])&&(t._deData[e]=i.state.editingNodeDefault[e])})),e.next=9,this.updateDeNodeData([t]);case 9:this.state.editingNodeKey=null,this.state.editingNodeText=null,this.state.editingNodeDefault=null;case 12:case"end":return e.stop()}}),e,this)}))),function(e,t){return i.apply(this,arguments)})},{key:"onRemoveTreeNode",value:(o=l(u().mark((function e(t){var n,r,o,i,a,c,d,f=this;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this.handlerAbilityParams(t),r=n.context,o=n.params,i=n.data,a=this.getNodeModel(i[0]._nodeId),!0===(null==t?void 0:t.silent)){e.next=8;break}return e.next=5,ibiz.confirm.error({title:"数据删除",desc:"确认删除数据？"});case 5:if(e.sent){e.next=8;break}return e.abrupt("return");case 8:return e.next=10,this._evt.emit("onBeforeRemove",void 0);case 10:return e.next=12,this.startLoading();case 12:return c=!1,e.prev=13,d=s(a.appDataEntityId),e.next=17,p(i.map(function(){var e=l(u().mark((function e(t){var n;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.srfuf===g.CREATE){e.next=8;break}return(n=r.clone())[d]=t.srfkey,e.next=5,ibiz.hub.getApp(a.appId).deService.exec(a.appDataEntityId,"remove",n,i,o);case 5:return e.next=7,e.sent;case 7:c=!0;case 8:f.afterRemove(t);case 9:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 17:if(!0!==(null==t?void 0:t.silent)&&this.actionNotification("REMOVESUCCESS",{data:i,default:"数据[".concat(i.map((function(e){return e.srfmajortext})).join("、"),"]删除成功!")}),!c||null!=t&&t.notRefresh){e.next=21;break}return e.next=21,this.refresh();case 21:e.next=29;break;case 23:return e.prev=23,e.t0=e.catch(13),e.next=27,this._evt.emit("onRemoveError",void 0);case 27:throw this.actionNotification("REMOVEERROR",{error:e.t0,data:i}),e.t0;case 29:return e.prev=29,e.next=32,this.endLoading();case 32:return e.finish(29);case 33:return this.state.selectedData=[],e.next=36,this._evt.emit("onRemoveSuccess",void 0);case 36:case"end":return e.stop()}}),e,this,[[13,23,29,33]])}))),function(e){return o.apply(this,arguments)})},{key:"calcAllowDrop",value:function(e,t,n){var r,o,i=this.getNodeModel(e._nodeId);if("inner"===n)return!!this.findDropNodeRS(t._nodeId,i.appDataEntityId);if((null===(r=e._parent)||void 0===r?void 0:r._id)===(null===(o=t._parent)||void 0===o?void 0:o._id)){var a=this.getNodeModel(t._nodeId);return!0===(null==a?void 0:a.allowOrder)}if(!t._parent)return!1;if(t._parent&&t._parent._id&&this.getNodeModel(t._parent._nodeId).rootNode)return!0;return!!this.findDropNodeRS(t._parent._nodeId,i.appDataEntityId)}},{key:"onNodeDrop",value:(t=l(u().mark((function e(t,o,i){var a,c,l,d,s,f,p,h,v,y,g,m,b,w,x,N,_,D,E,k,I,T,C,O,S,R;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("inner"!==i||o._leaf||void 0!==o._children){e.next=3;break}return e.next=3,this.expandNodeByKey([o._id]);case 3:if(d=!("inner"===i),s=[],f=this.getNodeModel(t._nodeId),p="inner"===i?o:o._parent,h=!1,this.getNodeModel(p._nodeId).rootNode&&(h=!0),v=(null==p?void 0:p._id)!==(null===(a=t._parent)||void 0===a?void 0:a._id),y=this.getNodeModel(o._nodeId),"inner"===i||(null===(c=o._parent)||void 0===c?void 0:c._id)!==(null===(l=t._parent)||void 0===l?void 0:l._id)||h){g=[],m=r(this.dropNodeRss.values());try{for(m.s();!(b=m.n()).done;)w=b.value,g.push.apply(g,n(w.filter((function(e){return e.minorEntityId===f.appDataEntityId}))))}catch(u){m.e(u)}finally{m.f()}h&&v?g&&(g.forEach((function(e){t._deData[e.pickupDEFName]=null})),s.push(t),y=this.getNodeModel(f.id)):(x=this.findDropNodeRS(p._nodeId,f.appDataEntityId))&&(g&&g.forEach((function(e){t._deData[e.pickupDEFName]=null})),t._deData[x.pickupDEFName]=p._value,x.detreeNodeRSParams&&x.detreeNodeRSParams.forEach((function(e){var n,r;e.name&&e.value&&null!==(n=t._deData)&&void 0!==n&&n.hasOwnProperty(e.name.toLowerCase())&&null!==(r=p._deData)&&void 0!==r&&r.hasOwnProperty(e.value.toLowerCase())&&(t._deData[e.name.toLowerCase()]=p._deData[e.value.toLowerCase()])})),s.push(t),y=this.getNodeModel(x.childDETreeNodeId))}if((N=t._parent._children).splice(N.indexOf(t),1),"inner"===i?(o._children||(o._children=[],o._leaf=!0,this.state.expandedKeys.push(o._id)),o._children.push(t)):(_=p._children.indexOf(o),"next"===i&&(_+=1),p._children.splice(_,0,t)),("inner"===i||v)&&(t._parent=p,t._nodeId=y.id,this.state.expandedKeys=this.calcExpandedKeys([p])),E=(D=y).sortAppDEFieldId,k=D.sortDir,!0!==D.allowOrder){e.next=28;break}if(E){e.next=21;break}throw new F(y,"缺少配置排序属性");case 21:I=E.toLowerCase(),T="ASC"===k,C=n(p._children).filter((function(e){return"DE"===e._nodeType})),T||C.reverse(),O=function(e){return e+(100-e%100)},S=function(e){return e[I]||0},C.forEach((function(e,n){var r=e._deData;void 0===R?e===t&&(R=0===n?100:O(S(C[n-1]._deData)),r[I]=R,-1===s.indexOf(e)&&s.push(e)):(R>=S(r)&&(r[I]=O(R),s.push(e)),R=S(r))}));case 28:return e.next=30,this.updateDeNodeData(s);case 30:this._evt.emit("onAfterNodeDrop",{isChangedParent:v}),this.refreshNodeChildren(o,d),this.setSelection([]);case 33:case"end":return e.stop()}}),e,this)}))),function(e,n,r){return t.apply(this,arguments)})}]),N}(i);var q=D({name:"IBizGroupTreeControl",props:{modelData:{type:Object,required:!0},context:{type:Object,required:!0},params:{type:Object,default:function(){return{}}},provider:{type:Object},mdctrlActiveMode:{type:Number,default:void 0},singleSelect:{type:Boolean,default:void 0},navigational:{type:Boolean,default:void 0},defaultExpandedKeys:{type:Array},loadDefault:{type:Boolean,default:!0}},setup:function(){var e=x((function(){for(var e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];return t(G,n)})),n=E({});e.evt.on("onCreated",(function(){e.counter&&e.counter.onChange((function(e){Object.assign(n,e)}),!0)}));var r=N("control-group-tree"),i=k(null),a=k(null),c=k(""),d=k(null);I((function(){return d.value}),(function(e){e&&e.$el.getElementsByTagName("input")[0].focus()}));var s=function(){var t=l(u().mark((function t(){var n;return u().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!e.state.editingNodeKey){t.next=8;break}if(!e.state.editingNodeText){t.next=7;break}return n=V(e.state.editingNodeKey,e),t.next=5,e.onModifyTreeNode(n,e.state.editingNodeText);case 5:t.next=8;break;case 7:e.state.editingNodeKey=null;case 8:e.state.newingNodeText?e.onCreateTreeNode():e.state.newingNodeModel=null;case 9:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}(),f=function(){var t=l(u().mark((function t(){return u().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:e.state.editingNodeKey&&(e.state.editingNodeKey=null),e.state.newingNodeModel&&(e.state.newingNodeModel=null,e.state.newingNodeText="");case 2:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}(),p=function(e,t){var n=function(){var t=e.value;if(!t)throw new z("找不到el-tree实例对象");return t},r=B((function n(){var r,o=e.value;o?(Object.values(o.store.nodesMap).forEach((function(e){var n=t.state.expandedKeys.includes(e.data._id);n!==e.expanded&&(n?e.expand():e.collapse())})),t.state.singleSelect?e.value.setCurrentKey((null===(r=t.state.selectedData[0])||void 0===r?void 0:r._id)||void 0):o.setCheckedKeys(t.state.selectedData.map((function(e){return e._id})))):setTimeout((function(){n()}),200)}),500);return{getTreeInstance:n,updateUI:r,triggerNodeExpand:function(e){var t=n(),r=null==t?void 0:t.store.nodesMap[e];if(r)return r.expanded?(r.collapse(),!1):(r.expand(),!0)}}}(i,e),h=p.updateUI,v=p.triggerNodeExpand,y=function(e){return e.map((function(e){return{_id:e._id,_uuid:e._uuid,_leaf:e._leaf,_text:e._text}}))};e.evt.on("onAfterRefreshParent",(function(e){if(i.value){var t=e.parentNode,n=e.children,r=y(n);i.value.updateKeyChildren(t._id,r),h()}})),e.evt.on("onAfterNodeDrop",(function(e){e.isChangedParent&&(c.value=A())}));var g=T((function(){return e.state.isLoaded?e.model.rootVisible?e.state.rootNodes:e.state.rootNodes.reduce((function(e,t){return t._children?e.concat(t._children):e}),[]):[]}));I(g,(function(e,t){e!==t&&(c.value=A())}));var m=function(){var t=l(u().mark((function t(n,r){var o,i;return u().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(0!==n.level){t.next=5;break}o=g.value,ibiz.log.debug("初始加载"),t.next=15;break;case 5:if(!(i=V(n.data._uuid,e))._children){t.next=11;break}ibiz.log.debug("节点展开加载-本地",i),o=i._children,t.next=15;break;case 11:return ibiz.log.debug("节点展开加载-远程",i),t.next=14,e.loadNodes(i);case 14:o=t.sent;case 15:ibiz.log.debug("给树返回值",o),r(y(o)),h();case 18:case"end":return t.stop()}}),t)})));return function(e,n){return t.apply(this,arguments)}}(),b=!1;e.evt.on("onLoadSuccess",(function(){b=!0,setTimeout((function(){b=!1}),200)})),e.evt.on("onSelectionChange",l(u().mark((function t(){var n;return u().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!b){t.next=3;break}return t.next=3,C();case 3:e.state.singleSelect?i.value.setCurrentKey((null===(n=e.state.selectedData[0])||void 0===n?void 0:n._id)||void 0):i.value.setCheckedKeys(e.state.selectedData.map((function(e){return e._id})));case 4:case"end":return t.stop()}}),t)}))));var w,_=!1;e.evt.on("onMounted",(function(){if(Object.values(e.contextMenus).length>0){o.import("@imengyu/vue3-context-menu").then((function(e){(w=e.default).default&&!w.showContextMenu&&(w=w.default)}))}}));var D=O("IBizRawItem"),M=O("IBizIcon"),L=function t(n,r,o,i){var a=[];return n.forEach((function(n){if("SEPERATOR"!==n.itemType){var u=i[n.id];if((!u||u.visible)&&!(n.actionLevel>100)){var c={};if(n.showCaption&&n.caption&&(c.label=n.caption),n.sysImage&&n.showIcon&&(c.icon=j(M,{icon:n.sysImage},null)),"DEUIACTION"===n.itemType){c.disabled=u.disabled,c.clickClose=!0;var l=n.uiactionId;l&&(c.onClick=function(){e.doUIAction(l,r,o,n.appId)})}else if("RAWITEM"===n.itemType){n.rawItem&&(c.label=j(D,{rawItem:n},null))}else if("ITEMS"===n.itemType){var d;null!==(d=n.detoolbarItems)&&void 0!==d&&d.length&&(c.children=t(n.detoolbarItems,r,o,i))}a.push(c)}}else a.push({divided:"self"})})),a},P=function(){var t=l(u().mark((function t(n,o){var i,a,c,l;return u().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(o.preventDefault(),o.stopPropagation(),null!=(i=e.getNodeModel(n._nodeId))&&i.decontextMenu){t.next=5;break}return t.abrupt("return");case 5:if((a=e.contextMenus[i.decontextMenu.id]).model.detoolbarItems){t.next=8;break}return t.abrupt("return");case 8:return t.next=10,a.calcButtonState(n._deData||(n.srfkey?n:void 0),i.appDataEntityId);case 10:if(c=a.state.buttonsState,(l=L(a.model.detoolbarItems,n,o,c)).length){t.next=14;break}return t.abrupt("return");case 14:w.showContextMenu({x:o.x,y:o.y,customClass:r.b("context-menu"),items:l});case 15:case"end":return t.stop()}}),t)})));return function(e,n){return t.apply(this,arguments)}}(),F=B((function(){e.load()}),500),q=function(t){if("F2"===t.code||"Enter"===t.code){var n,r=null===(n=i.value)||void 0===n?void 0:n.getCurrentKey();e.updateTreeNode(r)}};S((function(){var e;null===(e=a.value)||void 0===e||e.$el.addEventListener("keydown",q)})),R((function(){var e;null===(e=a.value)||void 0===e||e.$el.removeEventListener("keydown",q)}));return{c:e,ns:r,treeRef:i,treeviewRef:a,treeNodeTextInputRef:d,treeData:g,treeRefreshKey:c,findNodeData:V,handleEditKeyDown:function(e){"Enter"!==e.key&&13!==e.keyCode||(e.stopPropagation(),s()),"Escape"!==e.key&&27!==e.keyCode||(e.stopPropagation(),f())},onCheck:function(t,n){var r=n.checkedNodes;e.setSelection(r)},onNodeClick:function(t,n){var r;if(n.stopPropagation(),!_){if((null===(r=i.value)||void 0===r?void 0:r.getCurrentKey())===t._id){var o,a=null===(o=i.value)||void 0===o?void 0:o.getCurrentKey();e.updateTreeNode({nodeKey:a,defaultValue:{}})}var u;if(!e.state.singleSelect)null===(u=i.value)||void 0===u||u.setCurrentKey(t._id);if(e.state.navigational){var c=e.getNodeModel(t._nodeId);if(null==c||!c.navAppViewId){var l=v(t._id);e.onExpandChange(t,l)}}e.onTreeNodeClick(t,n),_=!0,setTimeout((function(){_=!1}),200)}},onNodeDbClick:function(t,n){n.stopPropagation(),e.onDbTreeNodeClick(t)},onNodeContextmenu:P,loadData:m,renderContextMenu:function(t,n){var r;if(null!=t&&null!==(r=t.decontextMenu)&&void 0!==r&&null!==(r=r.detoolbarItems)&&void 0!==r&&r.length){var o=e.contextMenuInfos[t.id];return o.clickTBUIActionItem&&o.onlyOneActionItem?null:j(O("iBizContextMenuControl"),{modelData:t.decontextMenu,groupLevelKeys:[50,100],nodeModel:t,nodeData:n,context:e.context,onActionClick:function(t,r){return e.doUIAction(t.uiactionId,n,r,t.appId)}},null)}},renderCounter:function(e){if(e.counterId){var t=n[e.counterId];return U(t)||1===e.counterMode&&0===t?null:j("div",{class:r.em("counter","box")},[j("span",{class:r.e("dot")},[K("·")]),j(O("iBizBadge"),{class:r.e("counter"),value:t},null)])}},updateNodeExpand:function(t,n){var r=V(t._uuid,e);if(!r)throw new z("没有找到_uuid为".concat(t._uuid,"的节点"));e.onExpandChange(r,n)},onInput:function(t){e.state.query=t,F()},allowDrop:function(t,n,r){var o=V(t.data._uuid,e),i=V(n.data._uuid,e);return e.calcAllowDrop(o,i,r)},allowDrag:function(t){var n=V(t.data._uuid,e);return e.calcAllowDrag(n)},handleDrop:function(t,n,r){var o=function(e){switch(e){case"inner":return"inner";case"before":return"prev";case"after":return"next";default:throw new z("暂不支持dropType:".concat(e))}}(r),i=V(t.data._uuid,e),a=V(n.data._uuid,e);e.onNodeDrop(i,a,o)},onNodeTextEditBlur:s}},render:function(){var e,t=this,n={searchbar:function(){return t.c.enableQuickSearch?j(O("el-input"),{"model-value":t.c.state.query,class:[t.ns.b("quick-search"),t.ns.b("quick-search")],placeholder:t.c.state.placeHolder,onInput:t.onInput},{prefix:function(){return j(O("ion-icon"),{class:t.ns.e("search-icon"),name:"search"},null)}}):null}},r=this.c.controlPanel?"tree":"default";return n[r]=function(){var e,n;if(t.c.state.isLoaded&&t.treeRefreshKey)return j("div",{class:t.ns.b("tree-box")},[j(O("el-tree"),{ref:"treeRef",key:t.treeRefreshKey,"node-key":"_id","highlight-current":!0,"expand-on-click-node":!1,"auto-expand-parent":!1,"show-checkbox":!t.c.state.singleSelect,"check-strictly":!0,"default-expanded-keys":t.c.state.expandedKeys,props:{label:"_text",children:"_children",isLeaf:"_leaf"},lazy:!0,load:t.loadData,onCheck:t.onCheck,onNodeExpand:function(e){t.updateNodeExpand(e,!0)},onNodeCollapse:function(e){t.updateNodeExpand(e,!1)},draggable:!0,"allow-drop":t.allowDrop,"allow-drag":t.allowDrag,onNodeDrop:t.handleDrop},{default:function(e){var n,r=e.data,o=t.findNodeData(r._uuid,t.c);if(!o)return null;var i,a=t.c.getNodeModel(o._nodeId);if(t.c.state.editingNodeKey===o._id)return j("div",{class:[t.ns.b("node"),null===(i=a.sysCss)||void 0===i?void 0:i.cssName]},[o._icon?j(O("iBizIcon"),{class:t.ns.be("node","icon"),icon:o._icon},null):null,j(O("el-input"),{modelValue:t.c.state.editingNodeText,"onUpdate:modelValue":function(e){return t.c.state.editingNodeText=e},ref:"treeNodeTextInputRef",class:t.ns.b("editing-node"),onBlur:function(){t.onNodeTextEditBlur()},onKeydown:function(e){t.handleEditKeyDown(e)}},null)]);var u,c=b(a);return u=c?j(O("iBizControlShell"),{data:o,modelData:c,context:t.c.context,params:t.c.params},null):[o._icon?j(O("iBizIcon"),{class:t.ns.be("node","icon"),icon:o._icon},null):null,o._textHtml?j("span",{class:t.ns.be("node","label"),innerHTML:o._textHtml},null):j("span",{class:t.ns.be("node","label")},[o._text])],j("div",{onDblclick:function(e){return t.onNodeDbClick(o,e)},onClick:function(e){return t.onNodeClick(o,e)},onContextmenu:function(e){return t.onNodeContextmenu(o,e)},class:[t.ns.b("node"),null===(n=a.sysCss)||void 0===n?void 0:n.cssName]},[u,t.renderCounter(a),t.renderContextMenu(a,o)])}}),t.c.state.newingNodeModel?j("div",{class:[t.ns.be("node","newing")]},[null!==(e=t.c.state.newingNodeModel)&&void 0!==e&&e.sysImage?j(O("iBizIcon"),{class:t.ns.be("node","icon"),icon:null===(n=t.c.state.newingNodeModel)||void 0===n?void 0:n.sysImage},null):null,j(O("el-input"),{modelValue:t.c.state.newingNodeText,"onUpdate:modelValue":function(e){return t.c.state.newingNodeText=e},ref:"treeNodeTextInputRef",class:t.ns.b("editing-node"),onBlur:t.onNodeTextEditBlur,onKeydown:function(e){t.handleEditKeyDown(e)}},null)]):null])},M(j(O("iBizControlBase"),{ref:"treeviewRef",controller:this.c},"function"==typeof(e=n)||"[object Object]"===Object.prototype.toString.call(e)&&!P(e)?n:{default:function(){return[n]}}),[[L("loading"),this.c.state.isLoading]])}}),H=f((function e(){d(this,e),a(this,"component","IBizGroupTreeControl")})),$=_(q,(function(e){e.component(q.name,q),w("TREE_RENDER_GROUP_TREE",(function(){return new H}))}));e({IBizGroupTreeControl:$,default:$})}}}))}();
