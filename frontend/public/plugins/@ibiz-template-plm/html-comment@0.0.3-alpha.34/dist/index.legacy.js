!function(){var e=["children"],t=["withoutSavingOrigin","trackedOrigins"];function n(e){var t="function"==typeof Map?new Map:void 0;return n=function(e){if(null===e||!function(e){try{return-1!==Function.toString.call(e).indexOf("[native code]")}catch(t){return"function"==typeof e}}(e))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,n)}function n(){return r(e,arguments,h(this).constructor)}return n.prototype=Object.create(e.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),c(n,e)},n(e)}function r(e,t,n){return r=f()?Reflect.construct.bind():function(e,t,n){var r=[null];r.push.apply(r,t);var i=new(Function.bind.apply(e,r));return n&&c(i,n.prototype),i},r.apply(null,arguments)}function i(e,t){if(null==e)return{};var n,r,i=function(e,t){if(null==e)return{};var n,r,i={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function a(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){M(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(){return s="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=h(e)););return e}(e,t);if(r){var i=Object.getOwnPropertyDescriptor(r,t);return i.get?i.get.call(arguments.length<3?e:n):i.value}},s.apply(this,arguments)}function u(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&c(e,t)}function c(e,t){return c=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},c(e,t)}function l(e){var t=f();return function(){var n,r=h(e);if(t){var i=h(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return function(e,t){if(t&&("object"===v(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return d(e)}(this,n)}}function d(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function f(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function h(e){return h=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},h(e)}function v(e){return v="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},v(e)}function p(e){return function(e){if(Array.isArray(e))return S(e)}(e)||g(e)||b(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function g(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function y(e,t){return w(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,i,o,a,s=[],u=!0,c=!1;try{if(o=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;u=!1}else for(;!(u=(r=o.call(n)).done)&&(s.push(r.value),s.length!==t);u=!0);}catch(e){c=!0,i=e}finally{try{if(!u&&null!=n.return&&(a=n.return(),Object(a)!==a))return}finally{if(c)throw i}}return s}}(e,t)||b(e,t)||m()}function m(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function w(e){if(Array.isArray(e))return e}function k(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=b(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return a=e.done,e},e:function(e){s=!0,o=e},f:function(){try{a||null==n.return||n.return()}finally{if(s)throw o}}}}function b(e,t){if(e){if("string"==typeof e)return S(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?S(e,t):void 0}}function S(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function x(){"use strict";/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */x=function(){return t};var e,t={},n=Object.prototype,r=n.hasOwnProperty,i=Object.defineProperty||function(e,t,n){e[t]=n.value},o="function"==typeof Symbol?Symbol:{},a=o.iterator||"@@iterator",s=o.asyncIterator||"@@asyncIterator",u=o.toStringTag||"@@toStringTag";function c(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{c({},"")}catch(e){c=function(e,t,n){return e[t]=n}}function l(e,t,n,r){var o=t&&t.prototype instanceof m?t:m,a=Object.create(o.prototype),s=new I(r||[]);return i(a,"_invoke",{value:A(e,n,s)}),a}function d(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}t.wrap=l;var f="suspendedStart",h="suspendedYield",p="executing",g="completed",y={};function m(){}function w(){}function k(){}var b={};c(b,a,(function(){return this}));var S=Object.getPrototypeOf,E=S&&S(S(R([])));E&&E!==n&&r.call(E,a)&&(b=E);var C=k.prototype=m.prototype=Object.create(b);function _(e){["next","throw","return"].forEach((function(t){c(e,t,(function(e){return this._invoke(t,e)}))}))}function O(e,t){function n(i,o,a,s){var u=d(e[i],e,o);if("throw"!==u.type){var c=u.arg,l=c.value;return l&&"object"==v(l)&&r.call(l,"__await")?t.resolve(l.__await).then((function(e){n("next",e,a,s)}),(function(e){n("throw",e,a,s)})):t.resolve(l).then((function(e){c.value=e,a(c)}),(function(e){return n("throw",e,a,s)}))}s(u.arg)}var o;i(this,"_invoke",{value:function(e,r){function i(){return new t((function(t,i){n(e,r,t,i)}))}return o=o?o.then(i,i):i()}})}function A(t,n,r){var i=f;return function(o,a){if(i===p)throw new Error("Generator is already running");if(i===g){if("throw"===o)throw a;return{value:e,done:!0}}for(r.method=o,r.arg=a;;){var s=r.delegate;if(s){var u=M(s,r);if(u){if(u===y)continue;return u}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(i===f)throw i=g,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);i=p;var c=d(t,n,r);if("normal"===c.type){if(i=r.done?g:h,c.arg===y)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(i=g,r.method="throw",r.arg=c.arg)}}}function M(t,n){var r=n.method,i=t.iterator[r];if(i===e)return n.delegate=null,"throw"===r&&t.iterator.return&&(n.method="return",n.arg=e,M(t,n),"throw"===n.method)||"return"!==r&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+r+"' method")),y;var o=d(i,t.iterator,n.arg);if("throw"===o.type)return n.method="throw",n.arg=o.arg,n.delegate=null,y;var a=o.arg;return a?a.done?(n[t.resultName]=a.value,n.next=t.nextLoc,"return"!==n.method&&(n.method="next",n.arg=e),n.delegate=null,y):a:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,y)}function L(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function D(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function I(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(L,this),this.reset(!0)}function R(t){if(t||""===t){var n=t[a];if(n)return n.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var i=-1,o=function n(){for(;++i<t.length;)if(r.call(t,i))return n.value=t[i],n.done=!1,n;return n.value=e,n.done=!0,n};return o.next=o}}throw new TypeError(v(t)+" is not iterable")}return w.prototype=k,i(C,"constructor",{value:k,configurable:!0}),i(k,"constructor",{value:w,configurable:!0}),w.displayName=c(k,u,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===w||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,k):(e.__proto__=k,c(e,u,"GeneratorFunction")),e.prototype=Object.create(C),e},t.awrap=function(e){return{__await:e}},_(O.prototype),c(O.prototype,s,(function(){return this})),t.AsyncIterator=O,t.async=function(e,n,r,i,o){void 0===o&&(o=Promise);var a=new O(l(e,n,r,i),o);return t.isGeneratorFunction(n)?a:a.next().then((function(e){return e.done?e.value:a.next()}))},_(C),c(C,u,"Generator"),c(C,a,(function(){return this})),c(C,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),n=[];for(var r in t)n.push(r);return n.reverse(),function e(){for(;n.length;){var r=n.pop();if(r in t)return e.value=r,e.done=!1,e}return e.done=!0,e}},t.values=R,I.prototype={constructor:I,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(D),!t)for(var n in this)"t"===n.charAt(0)&&r.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var n=this;function i(r,i){return s.type="throw",s.arg=t,n.next=r,i&&(n.method="next",n.arg=e),!!i}for(var o=this.tryEntries.length-1;o>=0;--o){var a=this.tryEntries[o],s=a.completion;if("root"===a.tryLoc)return i("end");if(a.tryLoc<=this.prev){var u=r.call(a,"catchLoc"),c=r.call(a,"finallyLoc");if(u&&c){if(this.prev<a.catchLoc)return i(a.catchLoc,!0);if(this.prev<a.finallyLoc)return i(a.finallyLoc)}else if(u){if(this.prev<a.catchLoc)return i(a.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return i(a.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var i=this.tryEntries[n];if(i.tryLoc<=this.prev&&r.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var o=i;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var a=o?o.completion:{};return a.type=e,a.arg=t,o?(this.method="next",this.next=o.finallyLoc,y):this.complete(a)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),y},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),D(n),y}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var i=r.arg;D(n)}return i}}throw new Error("illegal catch attempt")},delegateYield:function(t,n,r){return this.delegate={iterator:R(t),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=e),y}},t}function E(e,t,n,r,i,o,a){try{var s=e[o](a),u=s.value}catch(c){return void n(c)}s.done?t(u):Promise.resolve(u).then(r,i)}function C(e){return function(){var t=this,n=arguments;return new Promise((function(r,i){var o=e.apply(t,n);function a(e){E(o,r,i,a,s,"next",e)}function s(e){E(o,r,i,a,s,"throw",e)}a(void 0)}))}}function _(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function O(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,L(r.key),r)}}function A(e,t,n){return t&&O(e.prototype,t),n&&O(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function M(e,t,n){return(t=L(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function L(e){var t=function(e,t){if("object"!==v(e)||null===e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!==v(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"===v(t)?t:String(t)}System.register(["vue","@ibiz-template/runtime","@ibiz-template/vue3-util","@wangeditor/editor-for-vue","@wangeditor/editor","qx-util","ramda","@ibiz-template/core","element-plus","lodash-es"],(function(r,o){"use strict";var c,f,S,E,O,L,D,I,R,T,P,j,N,U,F,H,z,B,V,q,J,W,K,Y,$,Z,G,Q,X,ee,te,ne,re,ie,oe,ae,se,ue,ce,le,de,fe,he,ve,pe,ge,ye,me,we,ke,be,Se,xe,Ee,Ce,_e,Oe,Ae,Me,Le,De;return{setters:[function(e){c=e.defineComponent,f=e.ref,S=e.shallowRef,E=e.watch,O=e.onBeforeUnmount,L=e.onMounted,D=e.nextTick,I=e.createVNode,R=e.resolveComponent,T=e.createTextVNode,P=e.computed,j=e.Fragment,N=e.onUnmounted,U=e.mergeProps,F=e.reactive,H=e.withDirectives,z=e.resolveDirective,B=e.h,V=e.defineAsyncComponent},function(e){q=e.ScriptFactory,J=e.Srfuf,W=e.convertNavData,K=e.EditorController,Y=e.ControllerEvent,$=e.getDeACMode,Z=e.registerEditorProvider},function(e){G=e.getHtmlProps,Q=e.useNamespace,X=e.useClickOutside,ee=e.getEditorEmits,te=e.withInstall},function(e){ne=e.Editor,re=e.Toolbar},function(e){ie=e.SlateEditor,oe=e.SlateElement,ae=e.SlateText,se=e.SlateNode,ue=e.SlatePath,ce=e.SlateTransforms,le=e.SlateRange,de=e.SlatePoint,fe=e.Boot,he=e.DomEditor,ve=e.createEditor},function(e){pe=e.getCookie,ge=e.createUUID,ye=e.QXEvent},function(e){me=e.isNil},function(e){we=e.CoreConst,ke=e.debounce,be=e.getToken,Se=e.awaitTimeout,xe=e.RuntimeError,Ee=e.listenJSEvent,Ce=e.NOOP,_e=e.strToBase64,Oe=e.base64ToStr,Ae=e.downloadFileFromBlob},function(e){Me=e.ElMessageBox},function(e){Le=e.debounce,De=e.toNumber}],execute:function(){var Ie=x().mark(ei),Re=function(){function e(t,n){_(this,e),M(this,"modalOrPanel",void 0),M(this,"htmlRef",void 0),this.modalOrPanel=t,this.htmlRef=n,this.calcModalPosition(),window.addEventListener("resize",this.handleResize.bind(this))}return A(e,[{key:"calcModalPosition",value:function(){if(["dropPanel","selectList"].includes(this.modalOrPanel.type)){var e=this.modalOrPanel.$elem[0],t=this.htmlRef.$el,n=t.querySelector(".w-e-bar"),r=e.previousElementSibling,i=r.getAttribute("data-menu-key"),o=e.parentNode.parentNode.parentNode;if(["bgColor","color","headerSelect"].includes(i)&&t&&n&&r&&"true"!==o.getAttribute("data-w-e-toolbar")){var a=e.clientWidth,s=e.clientHeight,u=n.clientHeight,c=r.getBoundingClientRect(),l=c.bottom,d=c.right,f=c.top,h=c.left,v="".concat(f+u,"px"),p="".concat(h,"px"),g="".concat(l-s-u,"px"),y="".concat(d-a,"px"),m={position:"fixed",left:p,top:v},w=window.innerWidth,k=window.innerHeight;w-h<a&&Object.assign(m,{left:y}),k-f-u<s&&Object.assign(m,{top:g}),Object.assign(e.style,{top:"",bottom:"",left:"",right:""}),Object.assign(e.style,m)}}}},{key:"handleResize",value:function(){this.calcModalPosition()}},{key:"destroy",value:function(){window.removeEventListener("resize",this.handleResize)}}]),e}(),Te=c({name:"IBizHtmlContent",props:G(),emits:["change","blur","focus","enter","infoTextChange","link"],setup:function(e,t){var n=t.emit,r=Q("html"),i=e.controller,a=f(),s=f({}),u=0,c=f(),l=f(),d=S(),h=f(),v=f(""),p=f({Authorization:"Bearer ".concat(pe(we.TOKEN))}),g=f(""),m=f(""),w=f(!0),b=f(!1),_=f(!1),A=f(!1),P=f(!1),j=f(""),N=f([]),U=f(!1),F=i.model;F.editorParams&&(F.editorParams.enableEdit&&(b.value=!0,_.value=!0,w.value=i.toBoolean(F.editorParams.enableEdit)&&!e.readonly&&!e.disabled),F.editorParams.enableFullScreen&&(A.value=i.toBoolean(F.editorParams.enableFullScreen)));var H=function(e){if(d.value){var t=e.eventArg;t&&(d.value.setHtml(t),d.value.focus(!0),n("focus"))}},z=function(){d.value&&(d.value.blur(),d.value.setHtml(""))},B=function(){d.value&&(d.value.focus(!0),n("focus"))};i.evt.on("setHtml",H),i.evt.on("clear",z),i.evt.on("onSetReply",B),E((function(){return e.data}),(function(e){if(e){var t=ibiz.util.file.calcFileUpDownUrl(i.context,i.params,e);g.value=t.uploadUrl,m.value=t.downloadUrl}}),{immediate:!0,deep:!0});var V=function(e,t){if(t)return!0},J=function(e){return e},W={toolbarKeys:[{key:"group-add-style",title:"添加",iconSvg:'<svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" fit="" height="1em" width="1em" preserveAspectRatio="xMidYMid meet" focusable="false"><g id="arvaction/plus-circle-fill" stroke-width="1" fill-rule="evenodd"><path d="M8 16A8 8 0 1 1 8 0a8 8 0 0 1 0 16zm-.6-8.6H4v1.2h3.4V12h1.2V8.6H12V7.4H8.6V4H7.4v3.4z" id="arv形状结合"></path></g></svg>',menuKeys:["attachments","codesnippet","page"]},"|",{key:"group-inline-style",title:"文本格式",iconSvg:'<svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" fit="" height="1em" width="1em" preserveAspectRatio="xMidYMid meet" focusable="false"><g id="ahdeditor/color-tt" stroke-width="1" fill-rule="evenodd"><path id="ahdsecondary-color" d="M1.999 15.011h11.998V13.81H1.999z"></path><path d="M6.034 7.59h4.104L8.086 2.297 6.034 7.59zm-.465 1.2l-1.437 3.707H2.845L7.301 1h1.287l-.001.004h.286l4.454 11.492h-1.288L10.603 8.79H5.569z" id="ahd合并形状"></path></g></svg>',menuKeys:["bold","italic","underline","through","code","numberedList","bulletedList","insertLink"]},"codeBlock","mention","marker","emoji"]};i.chatCompletion&&W.toolbarKeys.push("aichart");var K,Y={placeholder:i.placeHolder,readOnly:b.value?_.value:e.readonly,MENU_CONF:{uploadImage:{server:g.value,fieldName:"file",maxFileSize:10485760,maxNumberOfFiles:10,allowedFileTypes:[],headers:p.value,withCredentials:!0,onBeforeUpload:function(e){return e},onProgress:function(e){console.log("progress",e)},onSuccess:function(e,t){console.log("".concat(e.name," 上传成功"),t)},onFailed:function(e,t){console.log("".concat(e.name," 上传失败"),t)},onError:function(e,t,n){console.log("".concat(e.name," 上传出错"),t,n)},customInsert:function(e,t){return C(x().mark((function n(){var r,i;return x().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:r=m.value.replace("%fileId%",e.id),i=e.filename,t(r,i,"");case 3:case"end":return n.stop()}}),n)})))()}},insertLink:{checkLink:V,parseLinkUrl:J},editLink:{checkLink:V,parseLinkUrl:J}},hoverbarKeys:{link:{menuKeys:["editLink","unLink","customViewLink"]}}},$=function(){var e=C(x().mark((function e(t){var n,r,i,o,a,s,u;return x().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.src,_.value)Z(n);else if(r=ie.nodes(d.value,{match:function(e){return!(!oe.isElement(e)||"image"!==e.type)},universal:!0}),r){i=k(r);try{for(i.s();!(o=i.n()).done;)a=o.value,s=y(a,1),"image"===(u=s[0]).type&&n.endsWith(u.src)&&Z(u.src)}catch(c){i.e(c)}finally{i.f()}}case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),Z=function(){var e=C(x().mark((function e(t){var n;return x().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return j.value=t,N.value=[t],e.next=4,D();case 4:h.value&&(n=h.value.$refs.container)&&n.children[0].click();case 5:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),G=function(e){if(h.value){var t=h.value.$refs.container;if(t){var n=t.querySelector(".el-image-viewer__wrapper");null==n||n[e]("keydown",X)}}},X=function(){var e=C(x().mark((function e(t){return x().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("Escape"!==t.key&&27!==t.keyCode){e.next=7;break}return t.stopPropagation(),t.preventDefault(),e.next=5,D();case 5:G("removeEventListener"),N.value=[];case 7:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),ee=function(){var e=C(x().mark((function e(){return x().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,D();case 2:G("addEventListener");case 3:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),te=function(){var t=C(x().mark((function t(){var r,a,s,u,c;return x().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!i.deService){t.next=11;break}return t.next=3,o.import("@ibiz-template-plugin/ai-chat");case 3:return a=t.sent,s=a.chat||a.default.chat,K=s,u=s.create({question:function(){var e=C(x().mark((function e(t){var n,r;return x().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=ge(),e.next=3,null===(n=i.deService)||void 0===n?void 0:n.aiChatSse((function(e){if(ibiz.log.info("aiChatSse",e),20===e.actionstate&&e.actionresult)u.addMessage({messageid:r,state:e.actionstate,type:"DEFAULT",role:"ASSISTANT",content:e.actionresult});else if(30===e.actionstate&&e.actionresult){var t=JSON.parse(e.actionresult).choices;t&&t.length>0&&u.replaceMessage({messageid:r,state:e.actionstate,type:"DEFAULT",role:"ASSISTANT",content:t[0].content||""})}else 40===e.actionstate&&u.replaceMessage({messageid:r,state:e.actionstate,type:"ERROR",role:"ASSISTANT",content:e.actionresult})}),i.context,{},{messages:t});case 3:return u.addMessage({messageid:r,state:10,type:"DEFAULT",role:"ASSISTANT",content:""}),e.abrupt("return",!0);case 5:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),action:function(e,t){"backfill"===e&&(n("change",t.content),U.value=!0)},closed:function(){d.value&&e.value&&d.value&&d.value.focus(!0)}}),t.next=9,null===(r=i.deService)||void 0===r?void 0:r.aiChatHistory(i.context,{});case 9:(c=t.sent).data&&Array.isArray(c.data)&&c.data.forEach((function(e){var t={messageid:ge(),state:30,type:"DEFAULT",role:e.role,content:e.content};u.addMessage(t)}));case 11:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}();O((function(){K&&K.close();var e=d.value;null!=e&&e.destroy()}));var ae=function(t){var n;d.value=t,t.on("modalOrPanelShow",(function(e){n=new Re(e,l.value)})),t.on("modalOrPanelHide",(function(){n&&n.destroy()})),t.setHtml(v.value),t.on("aiClick",(function(){te()})),i.onCreated(d.value,e.data,W)},se=function(t){var r=t.getHtml();!function(e){var t=e.getEditableContainer();t&&t.querySelectorAll("img").forEach((function(e){e.onclick=function(e){var t=e.target;t&&$(t)}}))}(t);var o="<p><br></p>"===r?"":r;o===e.value||""===o&&me(e.value)||b.value||(n("change",o),i.evt.emit("onChange",{eventArg:o}))},ue=function(e){i.evt.off("setHtml",H),i.evt.off("clear",z),i.evt.off("onSetReply",B)},ce=function(){n("focus"),i.evt.emit("onFocus",{eventArg:e.value})},le=function(){n("blur"),i.evt.emit("onBlur",{eventArg:e.value})},de=function(e,t){alert("【自定义提示】".concat(t," - ").concat(e))},fe=function(e,t,n){n(!0)},he=function(){var e=d.value;null!=e&&e.disable()},ve=function(){var e=d.value;null!=e&&e.enable()},ye=function(){_.value=!_.value,_.value?he():(ve(),d.value.focus(),function(){if(e.value){var t=e.value.indexOf("</p>");if(t>=0){var n,r,i=null===(n=d.value.selection.anchor)||void 0===n?void 0:n.offset,o=null===(r=d.value.selection.anchor)||void 0===r?void 0:r.path;0===i&&o.length>0&&0===o[0]&&d.value.move(t-3)}}}())},ke=function(){P.value=!P.value,D((function(){_.value?he():(ve(),d.value.focus())}))},be=function(){if(i.reply.value){var e=q.execScriptFn({value:i.reply.value},i.replyScript,{singleRowReturn:!0,isAsync:!1});return I("div",{class:r.b("reply")},[I("div",{class:r.be("reply","content"),innerHTML:e},null),I(R("ion-icon"),{name:"close-outline",onClick:function(){return i.removeReply()}},null)])}};return L((function(){!function(){if(a.value&&c.value){var e=a.value.offsetHeight;new ResizeObserver((function(t){var n=t[0].contentRect.height;if(n!==u){var i={height:"".concat(e-t[0].contentRect.height,"px")};s.value=r.cssVarBlock(i),u=n}})).observe(c.value.selector)}}(),E((function(){return e.value}),(function(t,n){t===n||"string"!=typeof e.value&&null!=t||(v.value=null==t?"":t,U.value&&(d.value&&D((function(){d.value.focus(!0)})),U.value=!1))}),{immediate:!0}),E((function(){return e.disabled}),(function(e,t){e!==t&&(!0===e?he():ve())}),{immediate:!0})})),{ns:r,editorRef:d,previewRef:h,mode:"default",valueHtml:v,toolbarConfig:W,editorConfig:Y,handleCreated:ae,handleChange:se,handleDestroyed:ue,handleFocus:ce,handleBlur:le,customAlert:de,customPaste:fe,insertText:function(e){var t=d.value;null!=t&&t.insertText(e)},printHtml:function(){var e=d.value;null!=e&&console.log(e.getHtml())},disable:he,enable:ve,renderHeaserToolbar:function(){return b.value||A.value?I("div",{class:r.b("custom-toolbar")},[b.value&&w.value&&_.value?I("i",{class:"fa fa-edit","aria-hidden":"true",title:"启用编辑",onClick:function(){return ye()}},null):null,A.value?P.value?I("i",{class:"fa fa-compress","aria-hidden":"true",title:"缩小",onClick:function(){return ke()}},null):I("i",{class:"fa fa-expand","aria-hidden":"true",title:"放大",onClick:function(){return ke()}},null):null]):null},renderEditorContent:function(){return i.hidden.value?null:I("div",{class:r.b("content"),ref:"htmlContent",style:s.value},[I(ne,{ref:"htmlRef",class:r.b("editor"),modelValue:v.value,"onUpdate:modelValue":function(e){return v.value=e},"default-config":Y,mode:"default",onOnCreated:ae,onOnChange:se,onOnDestroyed:ue,onOnFocus:ce,onOnBlur:le,oncustomAlert:de,oncustomPaste:fe},null),be(),I(re,{ref:"toolbarRef",editor:d.value,"default-config":W,mode:"default",class:r.b("toolbar")},null)])},renderFooter:function(){return b.value?I("div",{class:[r.b("footer"),M({},r.b("footer-dialog"),P.value)]},[I("div",{class:r.be("footer","cancel"),onClick:function(){e.value!==v.value?Me({title:"确认取消",type:"warning",customClass:r.b("message"),message:I("div",{class:r.be("message","message-content")},[I("p",null,[T("确定要取消编辑吗？")]),I("p",{class:r.bem("message","message-content","message-tip")},[T("取消编辑将无法保存修改的内容，且不能找回。")])]),showCancelButton:!0,cancelButtonClass:r.be("message","message-cancel"),confirmButtonClass:r.be("message","message-comfire")}).then((function(){if(e.value){var t=i.parseNode(e.value);v.value=t}else v.value="";ye()})).catch((function(){d.value.focus()})):ye()}},[T("取消")]),I("div",{class:r.be("footer","save"),onClick:function(){return function(){_.value=!0,d.value.disable();var e=v.value;n("change",e),P.value&&(P.value=!1)}()}},[T("保存")])]):null},htmlContent:a,hasEnableEdit:b,cssVars:s,toolbarRef:c,htmlRef:l,isFullScreen:P,readonlyState:_,changeFullScreenState:ke,renderPreview:function(){return I(R("el-image"),{class:r.e("preview"),ref:"previewRef","zoom-rate":1.1,src:j.value,"preview-src-list":N.value,"hide-on-click-modal":!0,onShow:ee,fit:"cover"},null)}}},render:function(){var e=this;return this.isFullScreen?I(R("el-dialog"),{modelValue:this.isFullScreen,"onUpdate:modelValue":function(t){return e.isFullScreen=t},width:"80%",top:"10vh",class:this.ns.b("dialog-full-screen"),onClose:function(){return e.changeFullScreenState()}},{default:function(){return[I("div",{class:[e.ns.b(),M({},e.ns.b("editor-readonly"),e.readonlyState)]},[e.renderHeaserToolbar(),e.renderEditorContent(),e.hasEnableEdit&&!e.readonlyState?e.renderFooter():null])]}}):I("div",{class:[this.ns.b(),M({},this.ns.b("editor-readonly"),this.readonlyState)]},[this.renderHeaserToolbar(),this.renderEditorContent(),this.renderPreview(),this.hasEnableEdit&&!this.readonlyState?this.renderFooter():null])}}),Pe=Object.freeze(Object.defineProperty({__proto__:null,default:Te},Symbol.toStringTag,{value:"Module"})),je=["headerSelect","blockquote","|","bold","underline","italic",{key:"group-more-style",title:"更多",iconSvg:'<svg viewBox="0 0 1024 1024"><path d="M204.8 505.6m-76.8 0a76.8 76.8 0 1 0 153.6 0 76.8 76.8 0 1 0-153.6 0Z"></path><path d="M505.6 505.6m-76.8 0a76.8 76.8 0 1 0 153.6 0 76.8 76.8 0 1 0-153.6 0Z"></path><path d="M806.4 505.6m-76.8 0a76.8 76.8 0 1 0 153.6 0 76.8 76.8 0 1 0-153.6 0Z"></path></svg>',menuKeys:["through","code","sup","sub","clearStyle"]},"color","bgColor","|","fontSize","fontFamily","lineHeight","|","bulletedList","numberedList","todo",{key:"group-justify",title:"对齐",iconSvg:'<svg viewBox="0 0 1024 1024"><path d="M768 793.6v102.4H51.2v-102.4h716.8z m204.8-230.4v102.4H51.2v-102.4h921.6z m-204.8-230.4v102.4H51.2v-102.4h716.8zM972.8 102.4v102.4H51.2V102.4h921.6z"></path></svg>',menuKeys:["justifyLeft","justifyRight","justifyCenter","justifyJustify"]},{key:"group-indent",title:"缩进",iconSvg:'<svg viewBox="0 0 1024 1024"><path d="M0 64h1024v128H0z m384 192h640v128H384z m0 192h640v128H384z m0 192h640v128H384zM0 832h1024v128H0z m0-128V320l256 192z"></path></svg>',menuKeys:["indent","delIndent"]},"|","emoji","insertLink",{key:"group-image",title:"图片",iconSvg:'<svg viewBox="0 0 1024 1024"><path d="M959.877 128l0.123 0.123v767.775l-0.123 0.122H64.102l-0.122-0.122V128.123l0.122-0.123h895.775zM960 64H64C28.795 64 0 92.795 0 128v768c0 35.205 28.795 64 64 64h896c35.205 0 64-28.795 64-64V128c0-35.205-28.795-64-64-64zM832 288.01c0 53.023-42.988 96.01-96.01 96.01s-96.01-42.987-96.01-96.01S682.967 192 735.99 192 832 234.988 832 288.01zM896 832H128V704l224.01-384 256 320h64l224.01-192z"></path></svg>',menuKeys:["insertImage","uploadImage"]},{key:"group-video",title:"视频",iconSvg:'<svg viewBox="0 0 1024 1024"><path d="M981.184 160.096C837.568 139.456 678.848 128 512 128S186.432 139.456 42.816 160.096C15.296 267.808 0 386.848 0 512s15.264 244.16 42.816 351.904C186.464 884.544 345.152 896 512 896s325.568-11.456 469.184-32.096C1008.704 756.192 1024 637.152 1024 512s-15.264-244.16-42.816-351.904zM384 704V320l320 192-320 192z"></path></svg>',menuKeys:["insertVideo","uploadVideo"]},"insertTable","codeBlock","divider","|","undo","redo"],Ne=function(){return new Map},Ue=function(e){var t=Ne();return e.forEach((function(e,n){t.set(n,e)})),t},Fe=function(e,t,n){var r=e.get(t);return void 0===r&&e.set(t,r=n()),r},He=function(){return new Set},ze=function(e){return e[e.length-1]},Be=function(e,t){for(var n=0;n<t.length;n++)e.push(t[n])},Ve=Array.from,qe=Array.isArray,Je=function(){function e(){_(this,e),this._observers=Ne()}return A(e,[{key:"on",value:function(e,t){return Fe(this._observers,e,He).add(t),t}},{key:"once",value:function(e,t){var n=this;this.on(e,(function r(){n.off(e,r),t.apply(void 0,arguments)}))}},{key:"off",value:function(e,t){var n=this._observers.get(e);void 0!==n&&(n.delete(t),0===n.size&&this._observers.delete(e))}},{key:"emit",value:function(e,t){return Ve((this._observers.get(e)||Ne()).values()).forEach((function(e){return e.apply(void 0,p(t))}))}},{key:"destroy",value:function(){this._observers=Ne()}}]),e}(),We=Math.floor,Ke=Math.abs,Ye=function(e,t){return e<t?e:t},$e=function(e,t){return e>t?e:t},Ze=function(e){return 0!==e?e<0:1/e<0},Ge=32,Qe=64,Xe=128,et=31,tt=127,nt=Number.MAX_SAFE_INTEGER,rt=Number.isInteger||function(e){return"number"==typeof e&&isFinite(e)&&We(e)===e},it=/^\s*/g,ot=/([A-Z])/g,at=function(e,t){return function(e){return e.replace(it,"")}(e.replace(ot,(function(e){return"".concat(t).concat(function(e){return e.toLowerCase()}(e))})))},st="undefined"!=typeof TextEncoder?new TextEncoder:null,ut=st?function(e){return st.encode(e)}:function(e){for(var t=unescape(encodeURIComponent(e)),n=t.length,r=new Uint8Array(n),i=0;i<n;i++)r[i]=t.codePointAt(i);return r},ct="undefined"==typeof TextDecoder?null:new TextDecoder("utf-8",{fatal:!0,ignoreBOM:!0});ct&&1===ct.decode(new Uint8Array).length&&(ct=null);var lt=A((function e(){_(this,e),this.cpos=0,this.cbuf=new Uint8Array(100),this.bufs=[]})),dt=function(){return new lt},ft=function(e){for(var t=new Uint8Array(function(e){for(var t=e.cpos,n=0;n<e.bufs.length;n++)t+=e.bufs[n].length;return t}(e)),n=0,r=0;r<e.bufs.length;r++){var i=e.bufs[r];t.set(i,n),n+=i.length}return t.set(new Uint8Array(e.cbuf.buffer,0,e.cpos),n),t},ht=function(e,t){var n=e.cbuf.length;e.cpos===n&&(e.bufs.push(e.cbuf),e.cbuf=new Uint8Array(2*n),e.cpos=0),e.cbuf[e.cpos++]=t},vt=ht,pt=function(e,t){for(;t>tt;)ht(e,Xe|tt&t),t=We(t/128);ht(e,tt&t)},gt=function(e,t){var n=Ze(t);for(n&&(t=-t),ht(e,(t>63?Xe:0)|(n?Qe:0)|63&t),t=We(t/64);t>0;)ht(e,(t>tt?Xe:0)|tt&t),t=We(t/128)},yt=new Uint8Array(3e4),mt=yt.length/3,wt=st&&st.encodeInto?function(e,t){if(t.length<mt){var n=st.encodeInto(t,yt).written||0;pt(e,n);for(var r=0;r<n;r++)ht(e,yt[r])}else bt(e,ut(t))}:function(e,t){var n=unescape(encodeURIComponent(t)),r=n.length;pt(e,r);for(var i=0;i<r;i++)ht(e,n.codePointAt(i))},kt=function(e,t){var n=e.cbuf.length,r=e.cpos,i=Ye(n-r,t.length),o=t.length-i;e.cbuf.set(t.subarray(0,i),r),e.cpos+=i,o>0&&(e.bufs.push(e.cbuf),e.cbuf=new Uint8Array($e(2*n,o)),e.cbuf.set(t.subarray(i)),e.cpos=o)},bt=function(e,t){pt(e,t.byteLength),kt(e,t)},St=function(e,t){!function(e,t){var n=e.cbuf.length;n-e.cpos<t&&(e.bufs.push(new Uint8Array(e.cbuf.buffer,0,e.cpos)),e.cbuf=new Uint8Array(2*$e(n,t)),e.cpos=0)}(e,t);var n=new DataView(e.cbuf.buffer,e.cpos,t);return e.cpos+=t,n},xt=new DataView(new ArrayBuffer(4)),Et=function(e,t){switch(v(t)){case"string":ht(e,119),wt(e,t);break;case"number":rt(t)&&Ke(t)<=2147483647?(ht(e,125),gt(e,t)):(a=t,xt.setFloat32(0,a),xt.getFloat32(0)===a?(ht(e,124),function(e,t){St(e,4).setFloat32(0,t,!1)}(e,t)):(ht(e,123),function(e,t){St(e,8).setFloat64(0,t,!1)}(e,t)));break;case"bigint":ht(e,122),function(e,t){St(e,8).setBigInt64(0,t,!1)}(e,t);break;case"object":if(null===t)ht(e,126);else if(qe(t)){ht(e,117),pt(e,t.length);for(var n=0;n<t.length;n++)Et(e,t[n])}else if(t instanceof Uint8Array)ht(e,116),bt(e,t);else{ht(e,118);var r=Object.keys(t);pt(e,r.length);for(var i=0;i<r.length;i++){var o=r[i];wt(e,o),Et(e,t[o])}}break;case"boolean":ht(e,t?120:121);break;default:ht(e,127)}var a},Ct=function(e){u(n,e);var t=l(n);function n(e){var r;return _(this,n),(r=t.call(this)).w=e,r.s=null,r.count=0,r}return A(n,[{key:"write",value:function(e){this.s===e?this.count++:(this.count>0&&pt(this,this.count-1),this.count=1,this.w(this,e),this.s=e)}}]),n}(lt),_t=function(e){e.count>0&&(gt(e.encoder,1===e.count?e.s:-e.s),e.count>1&&pt(e.encoder,e.count-2))},Ot=function(){function e(){_(this,e),this.encoder=new lt,this.s=0,this.count=0}return A(e,[{key:"write",value:function(e){this.s===e?this.count++:(_t(this),this.count=1,this.s=e)}},{key:"toUint8Array",value:function(){return _t(this),ft(this.encoder)}}]),e}(),At=function(e){if(e.count>0){var t=2*e.diff+(1===e.count?0:1);gt(e.encoder,t),e.count>1&&pt(e.encoder,e.count-2)}},Mt=function(){function e(){_(this,e),this.encoder=new lt,this.s=0,this.count=0,this.diff=0}return A(e,[{key:"write",value:function(e){this.diff===e-this.s?(this.s=e,this.count++):(At(this),this.count=1,this.diff=e-this.s,this.s=e)}},{key:"toUint8Array",value:function(){return At(this),ft(this.encoder)}}]),e}(),Lt=function(){function e(){_(this,e),this.sarr=[],this.s="",this.lensE=new Ot}return A(e,[{key:"write",value:function(e){this.s+=e,this.s.length>19&&(this.sarr.push(this.s),this.s=""),this.lensE.write(e.length)}},{key:"toUint8Array",value:function(){var e=new lt;return this.sarr.push(this.s),this.s="",wt(e,this.sarr.join("")),kt(e,this.lensE.toUint8Array()),ft(e)}}]),e}(),Dt=function(e){return new Error(e)},It=function(){throw Dt("Method unimplemented")},Rt=function(){throw Dt("Unexpected case")},Tt=Dt("Unexpected end of array"),Pt=Dt("Integer out of Range"),jt=A((function e(t){_(this,e),this.arr=t,this.pos=0})),Nt=function(e){return new jt(e)},Ut=function(e){return e.pos!==e.arr.length},Ft=function(e){return function(e,t){var n=new Uint8Array(e.arr.buffer,e.pos+e.arr.byteOffset,t);return e.pos+=t,n}(e,zt(e))},Ht=function(e){return e.arr[e.pos++]},zt=function(e){for(var t=0,n=1,r=e.arr.length;e.pos<r;){var i=e.arr[e.pos++];if(t+=(i&tt)*n,n*=128,i<Xe)return t;if(t>nt)throw Pt}throw Tt},Bt=function(e){var t=e.arr[e.pos++],n=63&t,r=64,i=(t&Qe)>0?-1:1;if(0==(t&Xe))return i*n;for(var o=e.arr.length;e.pos<o;){if(n+=((t=e.arr[e.pos++])&tt)*r,r*=128,t<Xe)return i*n;if(n>nt)throw Pt}throw Tt},Vt=ct?function(e){return ct.decode(Ft(e))}:function(e){var t=zt(e);if(0===t)return"";var n=String.fromCodePoint(Ht(e));if(--t<100)for(;t--;)n+=String.fromCodePoint(Ht(e));else for(;t>0;){var r=t<1e4?t:1e4,i=e.arr.subarray(e.pos,e.pos+r);e.pos+=r,n+=String.fromCodePoint.apply(null,i),t-=r}return decodeURIComponent(escape(n))},qt=function(e,t){var n=new DataView(e.arr.buffer,e.arr.byteOffset+e.pos,t);return e.pos+=t,n},Jt=[function(e){},function(e){return null},Bt,function(e){return qt(e,4).getFloat32(0,!1)},function(e){return qt(e,8).getFloat64(0,!1)},function(e){return qt(e,8).getBigInt64(0,!1)},function(e){return!1},function(e){return!0},Vt,function(e){for(var t=zt(e),n={},r=0;r<t;r++){n[Vt(e)]=Wt(e)}return n},function(e){for(var t=zt(e),n=[],r=0;r<t;r++)n.push(Wt(e));return n},Ft],Wt=function(e){return Jt[127-Ht(e)](e)},Kt=function(e){u(n,e);var t=l(n);function n(e,r){var i;return _(this,n),(i=t.call(this,e)).reader=r,i.s=null,i.count=0,i}return A(n,[{key:"read",value:function(){return 0===this.count&&(this.s=this.reader(this),Ut(this)?this.count=zt(this)+1:this.count=-1),this.count--,this.s}}]),n}(jt),Yt=function(e){u(n,e);var t=l(n);function n(e){var r;return _(this,n),(r=t.call(this,e)).s=0,r.count=0,r}return A(n,[{key:"read",value:function(){if(0===this.count){this.s=Bt(this);var e=Ze(this.s);this.count=1,e&&(this.s=-this.s,this.count=zt(this)+2)}return this.count--,this.s}}]),n}(jt),$t=function(e){u(n,e);var t=l(n);function n(e){var r;return _(this,n),(r=t.call(this,e)).s=0,r.count=0,r.diff=0,r}return A(n,[{key:"read",value:function(){if(0===this.count){var e=Bt(this),t=1&e;this.diff=We(e/2),this.count=1,t&&(this.count=zt(this)+2)}return this.s+=this.diff,this.count--,this.s}}]),n}(jt),Zt=function(){function e(t){_(this,e),this.decoder=new Yt(t),this.str=Vt(this.decoder),this.spos=0}return A(e,[{key:"read",value:function(){var e=this.spos+this.decoder.read(),t=this.str.slice(this.spos,e);return this.spos=e,t}}]),e}(),Gt=crypto.getRandomValues.bind(crypto),Qt=function(){return Gt(new Uint32Array(1))[0]},Xt=[1e7]+-1e3+-4e3+-8e3+-1e11,en=Date.now,tn=function(e){return new Promise(e)};Promise.all.bind(Promise);var nn=function(e){return void 0===e?null:e},rn=function(){function e(){_(this,e),this.map=new Map}return A(e,[{key:"setItem",value:function(e,t){this.map.set(e,t)}},{key:"getItem",value:function(e){return this.map.get(e)}}]),e}(),on=new rn;try{"undefined"!=typeof localStorage&&localStorage&&(on=localStorage,!1)}catch(Lc){}var an,sn=on,un=Object.assign,cn=Object.keys,ln=function(e){return cn(e).length},dn=function(e,t){return e===t||ln(e)===ln(t)&&function(e,t){for(var n in e)if(!t(e[n],n))return!1;return!0}(e,(function(e,n){return(void 0!==e||function(e,t){return Object.prototype.hasOwnProperty.call(e,t)}(t,n))&&t[n]===e}))},fn=function e(t,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;try{for(;r<t.length;r++)t[r].apply(t,p(n))}finally{r<t.length&&e(t,n,r+1)}},hn=function(e){return e},vn="undefined"!=typeof process&&process.release&&/node|io\.js/.test(process.release.name)&&"[object process]"===Object.prototype.toString.call("undefined"!=typeof process?process:0),pn=function(e){return function(){if(void 0===an)if(vn){an=Ne();for(var e=process.argv,t=null,n=0;n<e.length;n++){var r=e[n];"-"===r[0]?(null!==t&&an.set(t,""),t=r):null!==t&&(an.set(t,r),t=null)}null!==t&&an.set(t,"")}else"object"===("undefined"==typeof location?"undefined":v(location))?(an=Ne(),(location.search||"?").slice(1).split("&").forEach((function(e){if(0!==e.length){var t=y(e.split("="),2),n=t[0],r=t[1];an.set("--".concat(at(n,"-")),r),an.set("-".concat(at(n,"-")),r)}}))):an=Ne();return an}().has(e)},gn=function(e){return nn(vn?process.env[e.toUpperCase().replaceAll("-","_")]:sn.getItem(e))},yn=function(e){return pn("--"+e)||null!==gn(e)};yn("production");var mn,wn=vn&&(mn=process.env.FORCE_COLOR,["true","1","2"].includes(mn))||!pn("--no-colors")&&!yn("no-color")&&(!vn||process.stdout.isTTY)&&(!vn||pn("--color")||null!==gn("COLORTERM")||(gn("TERM")||"").includes("color")),kn=function(e){var t,n=(t=e.byteLength,new Uint8Array(t));return n.set(e),n},bn=A((function e(t,n){_(this,e),this.left=t,this.right=n})),Sn=function(e,t){return new bn(e,t)};"undefined"!=typeof DOMParser&&new DOMParser;var xn=function(e){return function(e,t){var n,r=[],i=k(e);try{for(i.s();!(n=i.n()).done;){var o=y(n.value,2),a=o[0],s=o[1];r.push(t(s,a))}}catch(u){i.e(u)}finally{i.f()}return r}(e,(function(e,t){return"".concat(t,":").concat(e,";")})).join("")},En=Symbol,Cn=En(),_n=En(),On=En(),An=En(),Mn=En(),Ln=En(),Dn=En(),In=En(),Rn=En(),Tn=M(M(M(M(M(M(M(M(M({},Cn,Sn("font-weight","bold")),_n,Sn("font-weight","normal")),On,Sn("color","blue")),Mn,Sn("color","green")),An,Sn("color","grey")),Ln,Sn("color","red")),Dn,Sn("color","purple")),In,Sn("color","orange")),Rn,Sn("color","black")),Pn=wn?function(e){var t;1===e.length&&(null===(t=e[0])||void 0===t?void 0:t.constructor)===Function&&(e=e[0]());for(var n=[],r=[],i=Ne(),o=[],a=0;a<e.length;a++){var s=e[a],u=Tn[s];if(void 0!==u)i.set(u.left,u.right);else{if(void 0===s)break;if(s.constructor!==String&&s.constructor!==Number)break;var c=xn(i);a>0||c.length>0?(n.push("%c"+s),r.push(c)):n.push(s)}}for(a>0&&(o=r).unshift(n.join(""));a<e.length;a++){var l=e[a];l instanceof Symbol||o.push(l)}return o}:function(e){var t;1===e.length&&(null===(t=e[0])||void 0===t?void 0:t.constructor)===Function&&(e=e[0]());for(var n=[],r=[],i=0;i<e.length;i++){var o=e[i];if(void 0===o)break;if(o.constructor===String||o.constructor===Number)n.push(o);else if(o.constructor===Object)break}for(i>0&&r.push(n.join(""));i<e.length;i++){var a=e[i];a instanceof Symbol||r.push(a)}return r},jn=He(),Nn=function(e){return M(M({},Symbol.iterator,(function(){return this})),"next",e)},Un=function(e,t){return Nn((function(){var n=e.next(),r=n.done,i=n.value;return{done:r,value:r?void 0:t(i)}}))},Fn=A((function e(t,n){_(this,e),this.clock=t,this.len=n})),Hn=A((function e(){_(this,e),this.clients=new Map})),zn=function(e,t,n){return t.clients.forEach((function(t,r){for(var i=e.doc.store.clients.get(r),o=0;o<t.length;o++){var a=t[o];Vr(e,i,a.clock,a.len,n)}}))},Bn=function(e,t){var n=e.clients.get(t.client);return void 0!==n&&null!==function(e,t){for(var n=0,r=e.length-1;n<=r;){var i=We((n+r)/2),o=e[i],a=o.clock;if(a<=t){if(t<a+o.len)return i;n=i+1}else r=i-1}return null}(n,t.clock)},Vn=function(e){e.clients.forEach((function(e){var t,n;for(e.sort((function(e,t){return e.clock-t.clock})),t=1,n=1;t<e.length;t++){var r=e[n-1],i=e[t];r.clock+r.len>=i.clock?r.len=$e(r.len,i.clock+i.len-r.clock):(n<t&&(e[n]=i),n++)}e.length=n}))},qn=function(e){for(var t=new Hn,n=function(n){e[n].clients.forEach((function(r,i){if(!t.clients.has(i)){for(var o=r.slice(),a=n+1;a<e.length;a++)Be(o,e[a].clients.get(i)||[]);t.clients.set(i,o)}}))},r=0;r<e.length;r++)n(r);return Vn(t),t},Jn=function(e,t,n,r){Fe(e.clients,t,(function(){return[]})).push(new Fn(n,r))},Wn=function(e){var t=new Hn;return e.clients.forEach((function(e,n){for(var r=[],i=0;i<e.length;i++){var o=e[i];if(o.deleted){var a=o.id.clock,s=o.length;if(i+1<e.length)for(var u=e[i+1];i+1<e.length&&u.deleted;u=e[1+ ++i])s+=u.length;r.push(new Fn(a,s))}}r.length>0&&t.clients.set(n,r)})),t},Kn=function(e,t){pt(e.restEncoder,t.clients.size),Ve(t.clients.entries()).sort((function(e,t){return t[0]-e[0]})).forEach((function(t){var n=y(t,2),r=n[0],i=n[1];e.resetDsCurVal(),pt(e.restEncoder,r);var o=i.length;pt(e.restEncoder,o);for(var a=0;a<o;a++){var s=i[a];e.writeDsClock(s.clock),e.writeDsLen(s.len)}}))},Yn=function(e){for(var t=new Hn,n=zt(e.restDecoder),r=0;r<n;r++){e.resetDsCurVal();var i=zt(e.restDecoder),o=zt(e.restDecoder);if(o>0)for(var a=Fe(t.clients,i,(function(){return[]})),s=0;s<o;s++)a.push(new Fn(e.readDsClock(),e.readDsLen()))}return t},$n=function(e,t,n){for(var r=new Hn,i=zt(e.restDecoder),o=0;o<i;o++){e.resetDsCurVal();for(var a=zt(e.restDecoder),s=zt(e.restDecoder),u=n.clients.get(a)||[],c=jr(n,a),l=0;l<s;l++){var d=e.readDsClock(),f=d+e.readDsLen();if(d<c){c<f&&Jn(r,a,c,f-c);var h=Ur(u,d),v=u[h];for(!v.deleted&&v.id.clock<d&&(u.splice(h+1,0,Do(t,v,d-v.id.clock)),h++);h<u.length&&(v=u[h++]).id.clock<f;)v.deleted||(f<v.id.clock+v.length&&u.splice(h,0,Do(t,v,f-v.id.clock)),v.delete(t))}else Jn(r,a,d,f-d)}}if(r.clients.size>0){var p=new ir;return pt(p.restEncoder,0),Kn(p,r),p.toUint8Array()}return null},Zn=Qt,Gn=function(e){u(n,e);var t=l(n);function n(){var e,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},i=r.guid,o=void 0===i?Xt.replace(/[018]/g,(function(e){return(e^Qt()&15>>e/4).toString(16)})):i,a=r.collectionid,s=void 0===a?null:a,u=r.gc,c=void 0===u||u,l=r.gcFilter,f=void 0===l?function(){return!0}:l,h=r.meta,v=void 0===h?null:h,p=r.autoLoad,g=void 0!==p&&p,y=r.shouldLoad,m=void 0===y||y;_(this,n),(e=t.call(this)).gc=c,e.gcFilter=f,e.clientID=Zn(),e.guid=o,e.collectionid=s,e.share=new Map,e.store=new Tr,e._transaction=null,e._transactionCleanups=[],e.subdocs=new Set,e._item=null,e.shouldLoad=m,e.autoLoad=g,e.meta=v,e.isLoaded=!1,e.isSynced=!1,e.whenLoaded=tn((function(t){e.on("load",(function(){e.isLoaded=!0,t(d(e))}))}));var w=function(){return tn((function(t){e.on("sync",(function n(r){void 0!==r&&!0!==r||(e.off("sync",n),t())}))}))};return e.on("sync",(function(t){!1===t&&e.isSynced&&(e.whenSynced=w()),e.isSynced=void 0===t||!0===t,e.isSynced&&!e.isLoaded&&e.emit("load",[d(e)])})),e.whenSynced=w(),e}return A(n,[{key:"load",value:function(){var e=this,t=this._item;null===t||this.shouldLoad||$r(t.parent.doc,(function(t){t.subdocsLoaded.add(e)}),null,!0),this.shouldLoad=!0}},{key:"getSubdocs",value:function(){return this.subdocs}},{key:"getSubdocGuids",value:function(){return new Set(Ve(this.subdocs).map((function(e){return e.guid})))}},{key:"transact",value:function(e){return $r(this,e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:null)}},{key:"get",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:ki,r=Fe(this.share,e,(function(){var e=new n;return e._integrate(t,null),e})),i=r.constructor;if(n!==ki&&i!==n){if(i===ki){var o=new n;o._map=r._map,r._map.forEach((function(e){for(;null!==e;e=e.left)e.parent=o})),o._start=r._start;for(var a=o._start;null!==a;a=a.right)a.parent=o;return o._length=r._length,this.share.set(e,o),o._integrate(this,null),o}throw new Error("Type with the name ".concat(e," has already been defined with a different constructor"))}return r}},{key:"getArray",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";return this.get(e,Ni)}},{key:"getText",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";return this.get(e,to)}},{key:"getMap",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";return this.get(e,Fi)}},{key:"getXmlElement",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";return this.get(e,io)}},{key:"getXmlFragment",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";return this.get(e,ro)}},{key:"toJSON",value:function(){var e={};return this.share.forEach((function(t,n){e[n]=t.toJSON()})),e}},{key:"destroy",value:function(){var e=this;Ve(this.subdocs).forEach((function(e){return e.destroy()}));var t=this._item;if(null!==t){this._item=null;var r=t.content;r.doc=new n(a(a({guid:this.guid},r.opts),{},{shouldLoad:!1})),r.doc._item=t,$r(t.parent.doc,(function(n){var i=r.doc;t.deleted||n.subdocsAdded.add(i),n.subdocsRemoved.add(e)}),null,!0)}this.emit("destroyed",[!0]),this.emit("destroy",[this]),s(h(n.prototype),"destroy",this).call(this)}}]),n}(Je),Qn=function(){function e(t){_(this,e),this.restDecoder=t}return A(e,[{key:"resetDsCurVal",value:function(){}},{key:"readDsClock",value:function(){return zt(this.restDecoder)}},{key:"readDsLen",value:function(){return zt(this.restDecoder)}}]),e}(),Xn=function(e){u(n,e);var t=l(n);function n(){return _(this,n),t.apply(this,arguments)}return A(n,[{key:"readLeftID",value:function(){return wr(zt(this.restDecoder),zt(this.restDecoder))}},{key:"readRightID",value:function(){return wr(zt(this.restDecoder),zt(this.restDecoder))}},{key:"readClient",value:function(){return zt(this.restDecoder)}},{key:"readInfo",value:function(){return Ht(this.restDecoder)}},{key:"readString",value:function(){return Vt(this.restDecoder)}},{key:"readParentInfo",value:function(){return 1===zt(this.restDecoder)}},{key:"readTypeRef",value:function(){return zt(this.restDecoder)}},{key:"readLen",value:function(){return zt(this.restDecoder)}},{key:"readAny",value:function(){return Wt(this.restDecoder)}},{key:"readBuf",value:function(){return kn(Ft(this.restDecoder))}},{key:"readJSON",value:function(){return JSON.parse(Vt(this.restDecoder))}},{key:"readKey",value:function(){return Vt(this.restDecoder)}}]),n}(Qn),er=function(e){u(n,e);var t=l(n);function n(e){var r;return _(this,n),(r=t.call(this,e)).keys=[],zt(e),r.keyClockDecoder=new $t(Ft(e)),r.clientDecoder=new Yt(Ft(e)),r.leftClockDecoder=new $t(Ft(e)),r.rightClockDecoder=new $t(Ft(e)),r.infoDecoder=new Kt(Ft(e),Ht),r.stringDecoder=new Zt(Ft(e)),r.parentInfoDecoder=new Kt(Ft(e),Ht),r.typeRefDecoder=new Yt(Ft(e)),r.lenDecoder=new Yt(Ft(e)),r}return A(n,[{key:"readLeftID",value:function(){return new yr(this.clientDecoder.read(),this.leftClockDecoder.read())}},{key:"readRightID",value:function(){return new yr(this.clientDecoder.read(),this.rightClockDecoder.read())}},{key:"readClient",value:function(){return this.clientDecoder.read()}},{key:"readInfo",value:function(){return this.infoDecoder.read()}},{key:"readString",value:function(){return this.stringDecoder.read()}},{key:"readParentInfo",value:function(){return 1===this.parentInfoDecoder.read()}},{key:"readTypeRef",value:function(){return this.typeRefDecoder.read()}},{key:"readLen",value:function(){return this.lenDecoder.read()}},{key:"readAny",value:function(){return Wt(this.restDecoder)}},{key:"readBuf",value:function(){return Ft(this.restDecoder)}},{key:"readJSON",value:function(){return Wt(this.restDecoder)}},{key:"readKey",value:function(){var e=this.keyClockDecoder.read();if(e<this.keys.length)return this.keys[e];var t=this.stringDecoder.read();return this.keys.push(t),t}}]),n}(function(){function e(t){_(this,e),this.dsCurrVal=0,this.restDecoder=t}return A(e,[{key:"resetDsCurVal",value:function(){this.dsCurrVal=0}},{key:"readDsClock",value:function(){return this.dsCurrVal+=zt(this.restDecoder),this.dsCurrVal}},{key:"readDsLen",value:function(){var e=zt(this.restDecoder)+1;return this.dsCurrVal+=e,e}}]),e}()),tr=function(){function e(){_(this,e),this.restEncoder=dt()}return A(e,[{key:"toUint8Array",value:function(){return ft(this.restEncoder)}},{key:"resetDsCurVal",value:function(){}},{key:"writeDsClock",value:function(e){pt(this.restEncoder,e)}},{key:"writeDsLen",value:function(e){pt(this.restEncoder,e)}}]),e}(),nr=function(e){u(n,e);var t=l(n);function n(){return _(this,n),t.apply(this,arguments)}return A(n,[{key:"writeLeftID",value:function(e){pt(this.restEncoder,e.client),pt(this.restEncoder,e.clock)}},{key:"writeRightID",value:function(e){pt(this.restEncoder,e.client),pt(this.restEncoder,e.clock)}},{key:"writeClient",value:function(e){pt(this.restEncoder,e)}},{key:"writeInfo",value:function(e){vt(this.restEncoder,e)}},{key:"writeString",value:function(e){wt(this.restEncoder,e)}},{key:"writeParentInfo",value:function(e){pt(this.restEncoder,e?1:0)}},{key:"writeTypeRef",value:function(e){pt(this.restEncoder,e)}},{key:"writeLen",value:function(e){pt(this.restEncoder,e)}},{key:"writeAny",value:function(e){Et(this.restEncoder,e)}},{key:"writeBuf",value:function(e){bt(this.restEncoder,e)}},{key:"writeJSON",value:function(e){wt(this.restEncoder,JSON.stringify(e))}},{key:"writeKey",value:function(e){wt(this.restEncoder,e)}}]),n}(tr),rr=function(){function e(){_(this,e),this.restEncoder=dt(),this.dsCurrVal=0}return A(e,[{key:"toUint8Array",value:function(){return ft(this.restEncoder)}},{key:"resetDsCurVal",value:function(){this.dsCurrVal=0}},{key:"writeDsClock",value:function(e){var t=e-this.dsCurrVal;this.dsCurrVal=e,pt(this.restEncoder,t)}},{key:"writeDsLen",value:function(e){0===e&&Rt(),pt(this.restEncoder,e-1),this.dsCurrVal+=e}}]),e}(),ir=function(e){u(n,e);var t=l(n);function n(){var e;return _(this,n),(e=t.call(this)).keyMap=new Map,e.keyClock=0,e.keyClockEncoder=new Mt,e.clientEncoder=new Ot,e.leftClockEncoder=new Mt,e.rightClockEncoder=new Mt,e.infoEncoder=new Ct(vt),e.stringEncoder=new Lt,e.parentInfoEncoder=new Ct(vt),e.typeRefEncoder=new Ot,e.lenEncoder=new Ot,e}return A(n,[{key:"toUint8Array",value:function(){var e=dt();return pt(e,0),bt(e,this.keyClockEncoder.toUint8Array()),bt(e,this.clientEncoder.toUint8Array()),bt(e,this.leftClockEncoder.toUint8Array()),bt(e,this.rightClockEncoder.toUint8Array()),bt(e,ft(this.infoEncoder)),bt(e,this.stringEncoder.toUint8Array()),bt(e,ft(this.parentInfoEncoder)),bt(e,this.typeRefEncoder.toUint8Array()),bt(e,this.lenEncoder.toUint8Array()),kt(e,ft(this.restEncoder)),ft(e)}},{key:"writeLeftID",value:function(e){this.clientEncoder.write(e.client),this.leftClockEncoder.write(e.clock)}},{key:"writeRightID",value:function(e){this.clientEncoder.write(e.client),this.rightClockEncoder.write(e.clock)}},{key:"writeClient",value:function(e){this.clientEncoder.write(e)}},{key:"writeInfo",value:function(e){this.infoEncoder.write(e)}},{key:"writeString",value:function(e){this.stringEncoder.write(e)}},{key:"writeParentInfo",value:function(e){this.parentInfoEncoder.write(e?1:0)}},{key:"writeTypeRef",value:function(e){this.typeRefEncoder.write(e)}},{key:"writeLen",value:function(e){this.lenEncoder.write(e)}},{key:"writeAny",value:function(e){Et(this.restEncoder,e)}},{key:"writeBuf",value:function(e){bt(this.restEncoder,e)}},{key:"writeJSON",value:function(e){Et(this.restEncoder,e)}},{key:"writeKey",value:function(e){var t=this.keyMap.get(e);void 0===t?(this.keyClockEncoder.write(this.keyClock++),this.stringEncoder.write(e)):this.keyClockEncoder.write(t)}}]),n}(rr),or=function(e,t,n){var r=new Map;n.forEach((function(e,n){jr(t,n)>e&&r.set(n,e)})),Pr(t).forEach((function(e,t){n.has(t)||r.set(t,0)})),pt(e.restEncoder,r.size),Ve(r.entries()).sort((function(e,t){return t[0]-e[0]})).forEach((function(n){var r=y(n,2),i=r[0],o=r[1];!function(e,t,n,r){r=$e(r,t[0].id.clock);var i=Ur(t,r);pt(e.restEncoder,t.length-i),e.writeClient(n),pt(e.restEncoder,r);var o=t[i];o.write(e,r-o.id.clock);for(var a=i+1;a<t.length;a++)t[a].write(e,0)}(e,t.clients.get(i),i,o)}))},ar=function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:new er(e);return $r(t,(function(e){e.local=!1;var t=!1,n=e.doc,i=n.store,o=function(e,t){for(var n=Ne(),r=zt(e.restDecoder),i=0;i<r;i++){var o=zt(e.restDecoder),a=new Array(o),s=e.readClient(),u=zt(e.restDecoder);n.set(s,{i:0,refs:a});for(var c=0;c<o;c++){var l=e.readInfo();switch(et&l){case 0:var d=e.readLen();a[c]=new co(wr(s,u),d),u+=d;break;case 10:var f=zt(e.restDecoder);a[c]=new No(wr(s,u),f),u+=f;break;default:var h=0==(l&(Qe|Xe)),v=new To(wr(s,u),null,(l&Xe)===Xe?e.readLeftID():null,null,(l&Qe)===Qe?e.readRightID():null,h?e.readParentInfo()?t.get(e.readString()):e.readLeftID():null,h&&(l&Ge)===Ge?e.readString():null,Po(e,l));a[c]=v,u+=v.length}}}return n}(r,n),a=function(e,t,n){var r=[],i=Ve(n.keys()).sort((function(e,t){return e-t}));if(0===i.length)return null;var o=function(){if(0===i.length)return null;for(var e=n.get(i[i.length-1]);e.refs.length===e.i;){if(i.pop(),!(i.length>0))return null;e=n.get(i[i.length-1])}return e},a=o();if(null===a)return null;for(var s=new Tr,u=new Map,c=function(e,t){var n=u.get(e);(null==n||n>t)&&u.set(e,t)},l=a.refs[a.i++],d=new Map,f=function(){for(var e=function(){var e=o[t],r=e.id.client,a=n.get(r);a?(a.i--,s.clients.set(r,a.refs.slice(a.i)),n.delete(r),a.i=0,a.refs=[]):s.clients.set(r,[e]),i=i.filter((function(e){return e!==r}))},t=0,o=r;t<o.length;t++)e();r.length=0};;){if(l.constructor!==No){var h=Fe(d,l.id.client,(function(){return jr(t,l.id.client)}))-l.id.clock;if(h<0)r.push(l),c(l.id.client,l.id.clock-1),f();else{var v=l.getMissing(e,t);if(null!==v){r.push(l);var p=n.get(v)||{refs:[],i:0};if(p.refs.length!==p.i){l=p.refs[p.i++];continue}c(v,jr(t,v)),f()}else(0===h||h<l.length)&&(l.integrate(e,h),d.set(l.id.client,l.id.clock+l.length))}}if(r.length>0)l=r.pop();else if(null!==a&&a.i<a.refs.length)l=a.refs[a.i++];else{if(null===(a=o()))break;l=a.refs[a.i++]}}if(s.clients.size>0){var g=new ir;return or(g,s,new Map),pt(g.restEncoder,0),{missing:u,update:g.toUint8Array()}}return null}(e,i,o),s=i.pendingStructs;if(s){var u,c=k(s.missing);try{for(c.s();!(u=c.n()).done;){var l=y(u.value,2),d=l[0];if(l[1]<jr(i,d)){t=!0;break}}}catch(E){c.e(E)}finally{c.f()}if(a){var f,h=k(a.missing);try{for(h.s();!(f=h.n()).done;){var v=y(f.value,2),p=v[0],g=v[1],m=s.missing.get(p);(null==m||m>g)&&s.missing.set(p,g)}}catch(E){h.e(E)}finally{h.f()}s.update=oi([s.update,a.update])}}else i.pendingStructs=a;var w=$n(r,e,i);if(i.pendingDs){var b=new er(Nt(i.pendingDs));zt(b.restDecoder);var S=$n(b,e,i);i.pendingDs=w&&S?oi([w,S]):w||S}else i.pendingDs=w;if(t){var x=i.pendingStructs.update;i.pendingStructs=null,sr(e.doc,x)}}),n,!1)},sr=function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:er,i=Nt(t);ar(i,e,n,new r(i))},ur=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new Uint8Array([0]),n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new ir;!function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new Map;or(e,t.store,n),Kn(e,Wn(t.store))}(n,e,cr(t));var r=[n.toUint8Array()];if(e.store.pendingDs&&r.push(e.store.pendingDs),e.store.pendingStructs&&r.push(ai(e.store.pendingStructs.update,t)),r.length>1){if(n.constructor===nr)return ri(r.map((function(e,t){return 0===t?e:li(e)})));if(n.constructor===ir)return oi(r)}return r[0]},cr=function(e){return function(e){for(var t=new Map,n=zt(e.restDecoder),r=0;r<n;r++){var i=zt(e.restDecoder),o=zt(e.restDecoder);t.set(i,o)}return t}(new Qn(Nt(e)))},lr=function(e,t){return pt(e.restEncoder,t.size),Ve(t.entries()).sort((function(e,t){return t[0]-e[0]})).forEach((function(t){var n=y(t,2),r=n[0],i=n[1];pt(e.restEncoder,r),pt(e.restEncoder,i)})),e},dr=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new rr;return e instanceof Map?lr(t,e):function(e,t){lr(e,Pr(t.store))}(t,e),t.toUint8Array()},fr=A((function e(){_(this,e),this.l=[]})),hr=function(){return new fr},vr=function(e,t){return e.l.push(t)},pr=function(e,t){var n=e.l,r=n.length;e.l=n.filter((function(e){return t!==e})),r===e.l.length&&console.error("[yjs] Tried to remove event handler that doesn't exist.")},gr=function(e,t,n){return fn(e.l,[t,n])},yr=A((function e(t,n){_(this,e),this.client=t,this.clock=n})),mr=function(e,t){return e===t||null!==e&&null!==t&&e.client===t.client&&e.clock===t.clock},wr=function(e,t){return new yr(e,t)},kr=function(e,t){pt(e,t.client),pt(e,t.clock)},br=function(e){return wr(zt(e),zt(e))},Sr=function(e){var t,n=k(e.doc.share.entries());try{for(n.s();!(t=n.n()).done;){var r=y(t.value,2),i=r[0];if(r[1]===e)return i}}catch(o){n.e(o)}finally{n.f()}throw Rt()},xr=function(e,t){for(;null!==t;){if(t.parent===e)return!0;t=t.parent._item}return!1},Er=A((function e(t,n,r){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;_(this,e),this.type=t,this.tname=n,this.item=r,this.assoc=i})),Cr=A((function e(t,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;_(this,e),this.type=t,this.index=n,this.assoc=r})),_r=function(e,t,n){var r=null,i=null;return null===e._item?i=Sr(e):r=wr(e._item.id.client,e._item.id.clock),new Er(r,i,t,n)},Or=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=e._start;if(n<0){if(0===t)return _r(e,null,n);t--}for(;null!==r;){if(!r.deleted&&r.countable){if(r.length>t)return _r(e,wr(r.id.client,r.id.clock+t),n);t-=r.length}if(null===r.right&&n<0)return _r(e,r.lastId,n);r=r.right}return _r(e,null,n)},Ar=function(e){var t=dt();return function(e,t){var n=t.type,r=t.tname,i=t.item,o=t.assoc;if(null!==i)pt(e,0),kr(e,i);else if(null!==r)vt(e,1),wt(e,r);else{if(null===n)throw Rt();vt(e,2),kr(e,n)}gt(e,o)}(t,e),ft(t)},Mr=function(e){return function(e){var t=null,n=null,r=null;switch(zt(e)){case 0:r=br(e);break;case 1:n=Vt(e);break;case 2:t=br(e)}var i=Ut(e)?Bt(e):0;return new Er(t,n,r,i)}(Nt(e))},Lr=function(e,t){var n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],r=t.store,i=e.item,o=e.type,a=e.tname,s=e.assoc,u=null,c=0;if(null!==i){if(jr(r,i.client)<=i.clock)return null;var l=n?Mo(r,i):{item:Fr(r,i),diff:0},d=l.item;if(!(d instanceof To))return null;if(null===(u=d.parent)._item||!u._item.deleted){c=d.deleted||!d.countable?0:l.diff+(s>=0?0:1);for(var f=d.left;null!==f;)!f.deleted&&f.countable&&(c+=f.length),f=f.left}}else{if(null!==a)u=t.get(a);else{if(null===o)throw Rt();if(jr(r,o.client)<=o.clock)return null;var h=(n?Mo(r,o):{item:Fr(r,o)}).item;if(!(h instanceof To&&h.content instanceof Ao))return null;u=h.content.type}c=s>=0?u._length:0}return function(e,t){return new Cr(e,t,arguments.length>2&&void 0!==arguments[2]?arguments[2]:0)}(u,c,e.assoc)},Dr=function(e,t){return e===t||null!==e&&null!==t&&e.tname===t.tname&&mr(e.item,t.item)&&mr(e.type,t.type)&&e.assoc===t.assoc},Ir=function(e,t){return void 0===t?!e.deleted:t.sv.has(e.id.client)&&(t.sv.get(e.id.client)||0)>e.id.clock&&!Bn(t.ds,e.id)},Rr=function e(t,n){var r=Fe(t.meta,e,He),i=t.doc.store;r.has(n)||(n.sv.forEach((function(e,n){e<jr(i,n)&&zr(t,wr(n,e))})),zn(t,n.ds,(function(e){})),r.add(n))},Tr=A((function e(){_(this,e),this.clients=new Map,this.pendingStructs=null,this.pendingDs=null})),Pr=function(e){var t=new Map;return e.clients.forEach((function(e,n){var r=e[e.length-1];t.set(n,r.id.clock+r.length)})),t},jr=function(e,t){var n=e.clients.get(t);if(void 0===n)return 0;var r=n[n.length-1];return r.id.clock+r.length},Nr=function(e,t){var n=e.clients.get(t.id.client);if(void 0===n)n=[],e.clients.set(t.id.client,n);else{var r=n[n.length-1];if(r.id.clock+r.length!==t.id.clock)throw Rt()}n.push(t)},Ur=function(e,t){var n=0,r=e.length-1,i=e[r],o=i.id.clock;if(o===t)return r;for(var a=We(t/(o+i.length-1)*r);n<=r;){if((o=(i=e[a]).id.clock)<=t){if(t<o+i.length)return a;n=a+1}else r=a-1;a=We((n+r)/2)}throw Rt()},Fr=function(e,t){var n=e.clients.get(t.client);return n[Ur(n,t.clock)]},Hr=function(e,t,n){var r=Ur(t,n),i=t[r];return i.id.clock<n&&i instanceof To?(t.splice(r+1,0,Do(e,i,n-i.id.clock)),r+1):r},zr=function(e,t){var n=e.doc.store.clients.get(t.client);return n[Hr(e,n,t.clock)]},Br=function(e,t,n){var r=t.clients.get(n.client),i=Ur(r,n.clock),o=r[i];return n.clock!==o.id.clock+o.length-1&&o.constructor!==co&&r.splice(i+1,0,Do(e,o,n.clock-o.id.clock+1)),o},Vr=function(e,t,n,r,i){if(0!==r){var o,a=n+r,s=Hr(e,t,n);do{a<(o=t[s++]).id.clock+o.length&&Hr(e,t,a),i(o)}while(s<t.length&&t[s].id.clock<a)}},qr=A((function e(t,n,r){_(this,e),this.doc=t,this.deleteSet=new Hn,this.beforeState=Pr(t.store),this.afterState=new Map,this.changed=new Map,this.changedParentTypes=new Map,this._mergeStructs=[],this.origin=n,this.meta=new Map,this.local=r,this.subdocsAdded=new Set,this.subdocsRemoved=new Set,this.subdocsLoaded=new Set,this._needFormattingCleanup=!1})),Jr=function(e,t){return!(0===t.deleteSet.clients.size&&!function(e,t){var n,r=k(e);try{for(r.s();!(n=r.n()).done;){var i=y(n.value,2),o=i[0];if(t(i[1],o))return!0}}catch(a){r.e(a)}finally{r.f()}return!1}(t.afterState,(function(e,n){return t.beforeState.get(n)!==e})))&&(Vn(t.deleteSet),function(e,t){or(e,t.doc.store,t.beforeState)}(e,t),Kn(e,t.deleteSet),!0)},Wr=function(e,t,n){var r=t._item;(null===r||r.id.clock<(e.beforeState.get(r.id.client)||0)&&!r.deleted)&&Fe(e.changed,t,He).add(n)},Kr=function(e,t){for(var n=e[t],r=e[t-1],i=t;i>0&&(r.deleted===n.deleted&&r.constructor===n.constructor&&r.mergeWith(n));n=r,r=e[--i-1])n instanceof To&&null!==n.parentSub&&n.parent._map.get(n.parentSub)===n&&n.parent._map.set(n.parentSub,r);var o=t-i;return o&&e.splice(t+1-o,o),o},Yr=function e(t,n){if(n<t.length){var r=t[n],i=r.doc,o=i.store,a=r.deleteSet,s=r._mergeStructs;try{Vn(a),r.afterState=Pr(r.doc.store),i.emit("beforeObserverCalls",[r,i]);var u=[];r.changed.forEach((function(e,t){return u.push((function(){null!==t._item&&t._item.deleted||t._callObserver(r,e)}))})),u.push((function(){r.changedParentTypes.forEach((function(e,t){t._dEH.l.length>0&&(null===t._item||!t._item.deleted)&&((e=e.filter((function(e){return null===e.target._item||!e.target._item.deleted}))).forEach((function(e){e.currentTarget=t,e._path=null})),e.sort((function(e,t){return e.path.length-t.path.length})),gr(t._dEH,e,r))}))})),u.push((function(){return i.emit("afterTransaction",[r,i])})),fn(u,[]),r._needFormattingCleanup&&Qi(r)}finally{i.gc&&function(e,t,n){var r,i=k(e.clients.entries());try{for(i.s();!(r=i.n()).done;)for(var o=y(r.value,2),a=o[0],s=o[1],u=t.clients.get(a),c=s.length-1;c>=0;c--)for(var l=s[c],d=l.clock+l.len,f=Ur(u,l.clock),h=u[f];f<u.length&&h.id.clock<d;h=u[++f]){var v=u[f];if(l.clock+l.len<=v.id.clock)break;v instanceof To&&v.deleted&&!v.keep&&n(v)&&v.gc(t,!1)}}catch(p){i.e(p)}finally{i.f()}}(a,o,i.gcFilter),function(e,t){e.clients.forEach((function(e,n){for(var r=t.clients.get(n),i=e.length-1;i>=0;i--)for(var o=e[i],a=Ye(r.length-1,1+Ur(r,o.clock+o.len-1)),s=r[a];a>0&&s.id.clock>=o.clock;s=r[a])a-=1+Kr(r,a)}))}(a,o),r.afterState.forEach((function(e,t){var n=r.beforeState.get(t)||0;if(n!==e)for(var i=o.clients.get(t),a=$e(Ur(i,n),1),s=i.length-1;s>=a;)s-=1+Kr(i,s)}));for(var c=s.length-1;c>=0;c--){var l=s[c].id,d=l.client,f=l.clock,h=o.clients.get(d),v=Ur(h,f);v+1<h.length&&Kr(h,v+1)>1||v>0&&Kr(h,v)}if(r.local||r.afterState.get(i.clientID)===r.beforeState.get(i.clientID)||(!function(){for(var e,t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];(e=console).log.apply(e,p(Pn(n))),jn.forEach((function(e){return e.print(n)}))}(In,Cn,"[yjs] ",_n,Ln,"Changed the client-id because another client seems to be using it."),i.clientID=Zn()),i.emit("afterTransactionCleanup",[r,i]),i._observers.has("update")){var g=new nr;Jr(g,r)&&i.emit("update",[g.toUint8Array(),r.origin,i,r])}if(i._observers.has("updateV2")){var m=new ir;Jr(m,r)&&i.emit("updateV2",[m.toUint8Array(),r.origin,i,r])}var w=r.subdocsAdded,b=r.subdocsLoaded,S=r.subdocsRemoved;(w.size>0||S.size>0||b.size>0)&&(w.forEach((function(e){e.clientID=i.clientID,null==e.collectionid&&(e.collectionid=i.collectionid),i.subdocs.add(e)})),S.forEach((function(e){return i.subdocs.delete(e)})),i.emit("subdocs",[{loaded:b,added:w,removed:S},i,r]),S.forEach((function(e){return e.destroy()}))),t.length<=n+1?(i._transactionCleanups=[],i.emit("afterAllTransactions",[i,t])):e(t,n+1)}}},$r=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,r=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],i=e._transactionCleanups,o=!1,a=null;null===e._transaction&&(o=!0,e._transaction=new qr(e,n,r),i.push(e._transaction),1===i.length&&e.emit("beforeAllTransactions",[e]),e.emit("beforeTransaction",[e._transaction,e]));try{a=t(e._transaction)}finally{if(o){var s=e._transaction===i[0];e._transaction=null,s&&Yr(i,0)}}return a},Zr=A((function e(t,n){_(this,e),this.insertions=n,this.deletions=t,this.meta=new Map})),Gr=function(e,t,n){zn(e,n.deletions,(function(e){e instanceof To&&t.scope.some((function(t){return xr(t,e)}))&&Lo(e,!1)}))},Qr=function(e,t,n){var r=null,i=e.doc,o=e.scope;$r(i,(function(n){for(var a=function(){var r=i.store,a=t.pop(),s=new Set,u=[],c=!1;zn(n,a.insertions,(function(e){if(e instanceof To){if(null!==e.redone){var t=Mo(r,e.id),i=t.item,a=t.diff;a>0&&(i=zr(n,wr(i.id.client,i.id.clock+a))),e=i}!e.deleted&&o.some((function(t){return xr(t,e)}))&&u.push(e)}})),zn(n,a.deletions,(function(e){e instanceof To&&o.some((function(t){return xr(t,e)}))&&!Bn(a.insertions,e.id)&&s.add(e)})),s.forEach((function(t){c=null!==Ro(n,t,s,a.insertions,e.ignoreRemoteMapChanges,e)||c}));for(var l=u.length-1;l>=0;l--){var d=u[l];e.deleteFilter(d)&&(d.delete(n),c=!0)}e.currStackItem=c?a:null};t.length>0&&null===e.currStackItem;)a();n.changed.forEach((function(e,t){e.has(null)&&t._searchMarker&&(t._searchMarker.length=0)})),r=n}),e);var a=e.currStackItem;if(null!=a){var s=r.changedParentTypes;e.emit("stack-item-popped",[{stackItem:a,type:n,changedParentTypes:s,origin:e},e]),e.currStackItem=null}return a},Xr=function(e){u(n,e);var t=l(n);function n(e){var r,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},o=i.captureTimeout,a=void 0===o?500:o,s=i.captureTransaction,u=void 0===s?function(e){return!0}:s,c=i.deleteFilter,l=void 0===c?function(){return!0}:c,f=i.trackedOrigins,h=void 0===f?new Set([null]):f,v=i.ignoreRemoteMapChanges,p=void 0!==v&&v,g=i.doc,y=void 0===g?qe(e)?e[0].doc:e.doc:g;return _(this,n),(r=t.call(this)).scope=[],r.doc=y,r.addToScope(e),r.deleteFilter=l,h.add(d(r)),r.trackedOrigins=h,r.captureTransaction=u,r.undoStack=[],r.redoStack=[],r.undoing=!1,r.redoing=!1,r.currStackItem=null,r.lastChange=0,r.ignoreRemoteMapChanges=p,r.captureTimeout=a,r.afterTransactionHandler=function(e){if(r.captureTransaction(e)&&r.scope.some((function(t){return e.changedParentTypes.has(t)}))&&(r.trackedOrigins.has(e.origin)||e.origin&&r.trackedOrigins.has(e.origin.constructor))){var t=r.undoing,n=r.redoing,i=t?r.redoStack:r.undoStack;t?r.stopCapturing():n||r.clear(!1,!0);var o=new Hn;e.afterState.forEach((function(t,n){var r=e.beforeState.get(n)||0,i=t-r;i>0&&Jn(o,n,r,i)}));var a=en(),s=!1;if(r.lastChange>0&&a-r.lastChange<r.captureTimeout&&i.length>0&&!t&&!n){var u=i[i.length-1];u.deletions=qn([u.deletions,e.deleteSet]),u.insertions=qn([u.insertions,o])}else i.push(new Zr(e.deleteSet,o)),s=!0;t||n||(r.lastChange=a),zn(e,e.deleteSet,(function(e){e instanceof To&&r.scope.some((function(t){return xr(t,e)}))&&Lo(e,!0)}));var c=[{stackItem:i[i.length-1],origin:e.origin,type:t?"redo":"undo",changedParentTypes:e.changedParentTypes},d(r)];s?r.emit("stack-item-added",c):r.emit("stack-item-updated",c)}},r.doc.on("afterTransaction",r.afterTransactionHandler),r.doc.on("destroy",(function(){r.destroy()})),r}return A(n,[{key:"addToScope",value:function(e){var t=this;(e=qe(e)?e:[e]).forEach((function(e){t.scope.every((function(t){return t!==e}))&&(e.doc!==t.doc&&function(){for(var e,t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];(e=console).warn.apply(e,p(Pn(n))),n.unshift(In),jn.forEach((function(e){return e.print(n)}))}("[yjs#509] Not same Y.Doc"),t.scope.push(e))}))}},{key:"addTrackedOrigin",value:function(e){this.trackedOrigins.add(e)}},{key:"removeTrackedOrigin",value:function(e){this.trackedOrigins.delete(e)}},{key:"clear",value:function(){var e=this,t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];(t&&this.canUndo()||n&&this.canRedo())&&this.doc.transact((function(r){t&&(e.undoStack.forEach((function(t){return Gr(r,e,t)})),e.undoStack=[]),n&&(e.redoStack.forEach((function(t){return Gr(r,e,t)})),e.redoStack=[]),e.emit("stack-cleared",[{undoStackCleared:t,redoStackCleared:n}])}))}},{key:"stopCapturing",value:function(){this.lastChange=0}},{key:"undo",value:function(){var e;this.undoing=!0;try{e=Qr(this,this.undoStack,"undo")}finally{this.undoing=!1}return e}},{key:"redo",value:function(){var e;this.redoing=!0;try{e=Qr(this,this.redoStack,"redo")}finally{this.redoing=!1}return e}},{key:"canUndo",value:function(){return this.undoStack.length>0}},{key:"canRedo",value:function(){return this.redoStack.length>0}},{key:"destroy",value:function(){this.trackedOrigins.delete(this),this.doc.off("afterTransaction",this.afterTransactionHandler),s(h(n.prototype),"destroy",this).call(this)}}]),n}(Je);function ei(e){var t,n,r,i,o,a,s,u,c,l,d;return x().wrap((function(f){for(;;)switch(f.prev=f.next){case 0:t=zt(e.restDecoder),n=0;case 2:if(!(n<t)){f.next=34;break}r=zt(e.restDecoder),i=e.readClient(),o=zt(e.restDecoder),a=0;case 7:if(!(a<r)){f.next=31;break}if(10!==(s=e.readInfo())){f.next=16;break}return u=zt(e.restDecoder),f.next=13,new No(wr(i,o),u);case 13:o+=u,f.next=28;break;case 16:if(0==(et&s)){f.next=24;break}return c=0==(s&(Qe|Xe)),l=new To(wr(i,o),null,(s&Xe)===Xe?e.readLeftID():null,null,(s&Qe)===Qe?e.readRightID():null,c?e.readParentInfo()?e.readString():e.readLeftID():null,c&&(s&Ge)===Ge?e.readString():null,Po(e,s)),f.next=21,l;case 21:o+=l.length,f.next=28;break;case 24:return d=e.readLen(),f.next=27,new co(wr(i,o),d);case 27:o+=d;case 28:a++,f.next=7;break;case 31:n++,f.next=2;break;case 34:case"end":return f.stop()}}),Ie)}var ti=function(){function e(t,n){_(this,e),this.gen=ei(t),this.curr=null,this.done=!1,this.filterSkips=n,this.next()}return A(e,[{key:"next",value:function(){do{this.curr=this.gen.next().value||null}while(this.filterSkips&&null!==this.curr&&this.curr.constructor===No);return this.curr}}]),e}(),ni=A((function e(t){_(this,e),this.currClient=0,this.startClock=0,this.written=0,this.encoder=t,this.clientStructs=[]})),ri=function(e){return oi(e,Xn,nr)},ii=function(e,t){if(e.constructor===co){var n=e.id,r=n.client,i=n.clock;return new co(wr(r,i+t),e.length-t)}if(e.constructor===No){var o=e.id,a=o.client,s=o.clock;return new No(wr(a,s+t),e.length-t)}var u=e,c=u.id,l=c.client,d=c.clock;return new To(wr(l,d+t),null,wr(l,d+t-1),null,u.rightOrigin,u.parent,u.parentSub,u.content.splice(t))},oi=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:er,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:ir;if(1===e.length)return e[0];for(var r=e.map((function(e){return new t(Nt(e))})),i=r.map((function(e){return new ti(e,!0)})),o=null,a=new n,s=new ni(a);(i=i.filter((function(e){return null!==e.curr}))).sort((function(e,t){if(e.curr.id.client===t.curr.id.client){var n=e.curr.id.clock-t.curr.id.clock;return 0===n?e.curr.constructor===t.curr.constructor?0:e.curr.constructor===No?1:-1:n}return t.curr.id.client-e.curr.id.client})),0!==i.length;){var u=i[0],c=u.curr.id.client;if(null!==o){for(var l=u.curr,d=!1;null!==l&&l.id.clock+l.length<=o.struct.id.clock+o.struct.length&&l.id.client>=o.struct.id.client;)l=u.next(),d=!0;if(null===l||l.id.client!==c||d&&l.id.clock>o.struct.id.clock+o.struct.length)continue;if(c!==o.struct.id.client)ui(s,o.struct,o.offset),o={struct:l,offset:0},u.next();else if(o.struct.id.clock+o.struct.length<l.id.clock)if(o.struct.constructor===No)o.struct.length=l.id.clock+l.length-o.struct.id.clock;else{ui(s,o.struct,o.offset);var f=l.id.clock-o.struct.id.clock-o.struct.length;o={struct:new No(wr(c,o.struct.id.clock+o.struct.length),f),offset:0}}else{var h=o.struct.id.clock+o.struct.length-l.id.clock;h>0&&(o.struct.constructor===No?o.struct.length-=h:l=ii(l,h)),o.struct.mergeWith(l)||(ui(s,o.struct,o.offset),o={struct:l,offset:0},u.next())}}else o={struct:u.curr,offset:0},u.next();for(var v=u.curr;null!==v&&v.id.client===c&&v.id.clock===o.struct.id.clock+o.struct.length&&v.constructor!==No;v=u.next())ui(s,o.struct,o.offset),o={struct:v,offset:0}}null!==o&&(ui(s,o.struct,o.offset),o=null),ci(s);var p=r.map((function(e){return Yn(e)})),g=qn(p);return Kn(a,g),a.toUint8Array()},ai=function(e,t){for(var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:er,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:ir,i=cr(t),o=new r,a=new ni(o),s=new n(Nt(e)),u=new ti(s,!1);u.curr;){var c=u.curr,l=c.id.client,d=i.get(l)||0;if(u.curr.constructor!==No)if(c.id.clock+c.length>d)for(ui(a,c,$e(d-c.id.clock,0)),u.next();u.curr&&u.curr.id.client===l;)ui(a,u.curr,0),u.next();else for(;u.curr&&u.curr.id.client===l&&u.curr.id.clock+u.curr.length<=d;)u.next();else u.next()}ci(a);var f=Yn(s);return Kn(o,f),o.toUint8Array()},si=function(e){e.written>0&&(e.clientStructs.push({written:e.written,restEncoder:ft(e.encoder.restEncoder)}),e.encoder.restEncoder=dt(),e.written=0)},ui=function(e,t,n){e.written>0&&e.currClient!==t.id.client&&si(e),0===e.written&&(e.currClient=t.id.client,e.encoder.writeClient(t.id.client),pt(e.encoder.restEncoder,t.id.clock+n)),t.write(e.encoder,n),e.written++},ci=function(e){si(e);var t=e.encoder.restEncoder;pt(t,e.clientStructs.length);for(var n=0;n<e.clientStructs.length;n++){var r=e.clientStructs[n];pt(t,r.written),kt(t,r.restEncoder)}},li=function(e){return function(e,t,n,r){for(var i=new n(Nt(e)),o=new ti(i,!1),a=new r,s=new ni(a),u=o.curr;null!==u;u=o.next())ui(s,t(u),0);ci(s);var c=Yn(i);return Kn(a,c),a.toUint8Array()}(e,hn,er,nr)},di="You must not compute changes after the event-handler fired.",fi=function(){function e(t,n){_(this,e),this.target=t,this.currentTarget=t,this.transaction=n,this._changes=null,this._keys=null,this._delta=null,this._path=null}return A(e,[{key:"path",get:function(){return this._path||(this._path=hi(this.currentTarget,this.target))}},{key:"deletes",value:function(e){return Bn(this.transaction.deleteSet,e.id)}},{key:"keys",get:function(){var e=this;if(null===this._keys){if(0===this.transaction.doc._transactionCleanups.length)throw Dt(di);var t=new Map,n=this.target;this.transaction.changed.get(n).forEach((function(r){if(null!==r){var i,o,a=n._map.get(r);if(e.adds(a)){for(var s=a.left;null!==s&&e.adds(s);)s=s.left;if(e.deletes(a)){if(null===s||!e.deletes(s))return;i="delete",o=ze(s.content.getContent())}else null!==s&&e.deletes(s)?(i="update",o=ze(s.content.getContent())):(i="add",o=void 0)}else{if(!e.deletes(a))return;i="delete",o=ze(a.content.getContent())}t.set(r,{action:i,oldValue:o})}})),this._keys=t}return this._keys}},{key:"delta",get:function(){return this.changes.delta}},{key:"adds",value:function(e){return e.id.clock>=(this.transaction.beforeState.get(e.id.client)||0)}},{key:"changes",get:function(){var e=this._changes;if(null===e){if(0===this.transaction.doc._transactionCleanups.length)throw Dt(di);var t=this.target,n=He(),r=He(),i=[];if(e={added:n,deleted:r,delta:i,keys:this.keys},this.transaction.changed.get(t).has(null)){for(var o=null,a=function(){o&&i.push(o)},s=t._start;null!==s;s=s.right)s.deleted?this.deletes(s)&&!this.adds(s)&&(null!==o&&void 0!==o.delete||(a(),o={delete:0}),o.delete+=s.length,r.add(s)):this.adds(s)?(null!==o&&void 0!==o.insert||(a(),o={insert:[]}),o.insert=o.insert.concat(s.content.getContent()),n.add(s)):(null!==o&&void 0!==o.retain||(a(),o={retain:0}),o.retain+=s.length);null!==o&&void 0===o.retain&&a()}this._changes=e}return e}}]),e}(),hi=function(e,t){for(var n=[];null!==t._item&&t!==e;){if(null!==t._item.parentSub)n.unshift(t._item.parentSub);else{for(var r=0,i=t._item.parent._start;i!==t._item&&null!==i;)!i.deleted&&i.countable&&(r+=i.length),i=i.right;n.unshift(r)}t=t._item.parent}return n},vi=0,pi=A((function e(t,n){_(this,e),t.marker=!0,this.p=t,this.index=n,this.timestamp=vi++})),gi=function(e,t,n){e.p.marker=!1,e.p=t,t.marker=!0,e.index=n,e.timestamp=vi++},yi=function(e,t){if(null===e._start||0===t||null===e._searchMarker)return null;var n=0===e._searchMarker.length?null:e._searchMarker.reduce((function(e,n){return Ke(t-e.index)<Ke(t-n.index)?e:n})),r=e._start,i=0;for(null!==n&&(r=n.p,i=n.index,function(e){e.timestamp=vi++}(n));null!==r.right&&i<t;){if(!r.deleted&&r.countable){if(t<i+r.length)break;i+=r.length}r=r.right}for(;null!==r.left&&i>t;)!(r=r.left).deleted&&r.countable&&(i-=r.length);for(;null!==r.left&&r.left.id.client===r.id.client&&r.left.id.clock+r.left.length===r.id.clock;)!(r=r.left).deleted&&r.countable&&(i-=r.length);return null!==n&&Ke(n.index-i)<r.parent.length/80?(gi(n,r,i),n):function(e,t,n){if(e.length>=80){var r=e.reduce((function(e,t){return e.timestamp<t.timestamp?e:t}));return gi(r,t,n),r}var i=new pi(t,n);return e.push(i),i}(e._searchMarker,r,i)},mi=function(e,t,n){for(var r=e.length-1;r>=0;r--){var i=e[r];if(n>0){var o=i.p;for(o.marker=!1;o&&(o.deleted||!o.countable);)(o=o.left)&&!o.deleted&&o.countable&&(i.index-=o.length);if(null===o||!0===o.marker){e.splice(r,1);continue}i.p=o,o.marker=!0}(t<i.index||n>0&&t===i.index)&&(i.index=$e(t,i.index+n))}},wi=function(e,t,n){for(var r=e,i=t.changedParentTypes;Fe(i,e,(function(){return[]})).push(n),null!==e._item;)e=e._item.parent;gr(r._eH,n,t)},ki=function(){function e(){_(this,e),this._item=null,this._map=new Map,this._start=null,this.doc=null,this._length=0,this._eH=hr(),this._dEH=hr(),this._searchMarker=null}return A(e,[{key:"parent",get:function(){return this._item?this._item.parent:null}},{key:"_integrate",value:function(e,t){this.doc=e,this._item=t}},{key:"_copy",value:function(){throw It()}},{key:"clone",value:function(){throw It()}},{key:"_write",value:function(e){}},{key:"_first",get:function(){for(var e=this._start;null!==e&&e.deleted;)e=e.right;return e}},{key:"_callObserver",value:function(e,t){!e.local&&this._searchMarker&&(this._searchMarker.length=0)}},{key:"observe",value:function(e){vr(this._eH,e)}},{key:"observeDeep",value:function(e){vr(this._dEH,e)}},{key:"unobserve",value:function(e){pr(this._eH,e)}},{key:"unobserveDeep",value:function(e){pr(this._dEH,e)}},{key:"toJSON",value:function(){}}]),e}(),bi=function(e,t,n){t<0&&(t=e._length+t),n<0&&(n=e._length+n);for(var r=n-t,i=[],o=e._start;null!==o&&r>0;){if(o.countable&&!o.deleted){var a=o.content.getContent();if(a.length<=t)t-=a.length;else{for(var s=t;s<a.length&&r>0;s++)i.push(a[s]),r--;t=0}}o=o.right}return i},Si=function(e){for(var t=[],n=e._start;null!==n;){if(n.countable&&!n.deleted)for(var r=n.content.getContent(),i=0;i<r.length;i++)t.push(r[i]);n=n.right}return t},xi=function(e,t){for(var n=0,r=e._start;null!==r;){if(r.countable&&!r.deleted)for(var i=r.content.getContent(),o=0;o<i.length;o++)t(i[o],n++,e);r=r.right}},Ei=function(e,t){var n=[];return xi(e,(function(r,i){n.push(t(r,i,e))})),n},Ci=function(e,t){var n=yi(e,t),r=e._start;for(null!==n&&(r=n.p,t-=n.index);null!==r;r=r.right)if(!r.deleted&&r.countable){if(t<r.length)return r.content.getContent()[t];t-=r.length}},_i=function(e,t,n,r){var i=n,o=e.doc,a=o.clientID,s=o.store,u=null===n?t._start:n.right,c=[],l=function(){c.length>0&&((i=new To(wr(a,jr(s,a)),i,i&&i.lastId,u,u&&u.id,t,null,new mo(c))).integrate(e,0),c=[])};r.forEach((function(n){if(null===n)c.push(n);else switch(n.constructor){case Number:case Object:case Boolean:case Array:case String:c.push(n);break;default:switch(l(),n.constructor){case Uint8Array:case ArrayBuffer:(i=new To(wr(a,jr(s,a)),i,i&&i.lastId,u,u&&u.id,t,null,new lo(new Uint8Array(n)))).integrate(e,0);break;case Gn:(i=new To(wr(a,jr(s,a)),i,i&&i.lastId,u,u&&u.id,t,null,new vo(n))).integrate(e,0);break;default:if(!(n instanceof ki))throw new Error("Unexpected content type in insert operation");(i=new To(wr(a,jr(s,a)),i,i&&i.lastId,u,u&&u.id,t,null,new Ao(n))).integrate(e,0)}}})),l()},Oi=function(){return Dt("Length exceeded!")},Ai=function(e,t,n,r){if(n>t._length)throw Oi();if(0===n)return t._searchMarker&&mi(t._searchMarker,n,r.length),_i(e,t,null,r);var i=n,o=yi(t,n),a=t._start;for(null!==o&&(a=o.p,0===(n-=o.index)&&(n+=(a=a.prev)&&a.countable&&!a.deleted?a.length:0));null!==a;a=a.right)if(!a.deleted&&a.countable){if(n<=a.length){n<a.length&&zr(e,wr(a.id.client,a.id.clock+n));break}n-=a.length}return t._searchMarker&&mi(t._searchMarker,i,r.length),_i(e,t,a,r)},Mi=function(e,t,n,r){if(0!==r){var i=n,o=r,a=yi(t,n),s=t._start;for(null!==a&&(s=a.p,n-=a.index);null!==s&&n>0;s=s.right)!s.deleted&&s.countable&&(n<s.length&&zr(e,wr(s.id.client,s.id.clock+n)),n-=s.length);for(;r>0&&null!==s;)s.deleted||(r<s.length&&zr(e,wr(s.id.client,s.id.clock+r)),s.delete(e),r-=s.length),s=s.right;if(r>0)throw Oi();t._searchMarker&&mi(t._searchMarker,i,-o+r)}},Li=function(e,t,n){var r=t._map.get(n);void 0!==r&&r.delete(e)},Di=function(e,t,n,r){var i,o=t._map.get(n)||null,a=e.doc,s=a.clientID;if(null==r)i=new mo([r]);else switch(r.constructor){case Number:case Object:case Boolean:case Array:case String:i=new mo([r]);break;case Uint8Array:i=new lo(r);break;case Gn:i=new vo(r);break;default:if(!(r instanceof ki))throw new Error("Unexpected content type");i=new Ao(r)}new To(wr(s,jr(a.store,s)),o,o&&o.lastId,null,null,t,n,i).integrate(e,0)},Ii=function(e,t){var n=e._map.get(t);return void 0===n||n.deleted?void 0:n.content.getContent()[n.length-1]},Ri=function(e){var t={};return e._map.forEach((function(e,n){e.deleted||(t[n]=e.content.getContent()[e.length-1])})),t},Ti=function(e,t){var n=e._map.get(t);return void 0!==n&&!n.deleted},Pi=function(e){return t=e.entries(),n=function(e){return!e[1].deleted},Nn((function(){var e;do{e=t.next()}while(!e.done&&!n(e.value));return e}));var t,n},ji=function(e){u(n,e);var t=l(n);function n(){return _(this,n),t.apply(this,arguments)}return A(n)}(fi),Ni=function(e,t){u(r,e);var n=l(r);function r(){var e;return _(this,r),(e=n.call(this))._prelimContent=[],e._searchMarker=[],e}return A(r,[{key:"_integrate",value:function(e,t){s(h(r.prototype),"_integrate",this).call(this,e,t),this.insert(0,this._prelimContent),this._prelimContent=null}},{key:"_copy",value:function(){return new r}},{key:"clone",value:function(){var e=new r;return e.insert(0,this.toArray().map((function(e){return e instanceof ki?e.clone():e}))),e}},{key:"length",get:function(){return null===this._prelimContent?this._length:this._prelimContent.length}},{key:"_callObserver",value:function(e,t){s(h(r.prototype),"_callObserver",this).call(this,e,t),wi(this,e,new ji(this,e))}},{key:"insert",value:function(e,t){var n,r=this;null!==this.doc?$r(this.doc,(function(n){Ai(n,r,e,t)})):(n=this._prelimContent).splice.apply(n,[e,0].concat(p(t)))}},{key:"push",value:function(e){var t,n=this;null!==this.doc?$r(this.doc,(function(t){!function(e,t,n){var r=(t._searchMarker||[]).reduce((function(e,t){return t.index>e.index?t:e}),{index:0,p:t._start}).p;if(r)for(;r.right;)r=r.right;_i(e,t,r,n)}(t,n,e)})):(t=this._prelimContent).push.apply(t,p(e))}},{key:"unshift",value:function(e){this.insert(0,e)}},{key:"delete",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;null!==this.doc?$r(this.doc,(function(r){Mi(r,t,e,n)})):this._prelimContent.splice(e,n)}},{key:"get",value:function(e){return Ci(this,e)}},{key:"toArray",value:function(){return Si(this)}},{key:"slice",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.length;return bi(this,e,t)}},{key:"toJSON",value:function(){return this.map((function(e){return e instanceof ki?e.toJSON():e}))}},{key:"map",value:function(e){return Ei(this,e)}},{key:"forEach",value:function(e){xi(this,e)}},{key:t,value:function(){return e=this._start,t=null,n=0,M(M({},Symbol.iterator,(function(){return this})),"next",(function(){if(null===t){for(;null!==e&&e.deleted;)e=e.right;if(null===e)return{done:!0,value:void 0};t=e.content.getContent(),n=0,e=e.right}var r=t[n++];return t.length<=n&&(t=null),{done:!1,value:r}}));var e,t,n}},{key:"_write",value:function(e){e.writeTypeRef(bo)}}],[{key:"from",value:function(e){var t=new r;return t.push(e),t}}]),r}(ki,Symbol.iterator),Ui=function(e){u(n,e);var t=l(n);function n(e,r,i){var o;return _(this,n),(o=t.call(this,e,r)).keysChanged=i,o}return A(n)}(fi),Fi=function(e,t){u(r,e);var n=l(r);function r(e){var t;return _(this,r),(t=n.call(this))._prelimContent=null,t._prelimContent=void 0===e?new Map:new Map(e),t}return A(r,[{key:"_integrate",value:function(e,t){var n=this;s(h(r.prototype),"_integrate",this).call(this,e,t),this._prelimContent.forEach((function(e,t){n.set(t,e)})),this._prelimContent=null}},{key:"_copy",value:function(){return new r}},{key:"clone",value:function(){var e=new r;return this.forEach((function(t,n){e.set(n,t instanceof ki?t.clone():t)})),e}},{key:"_callObserver",value:function(e,t){wi(this,e,new Ui(this,e,t))}},{key:"toJSON",value:function(){var e={};return this._map.forEach((function(t,n){if(!t.deleted){var r=t.content.getContent()[t.length-1];e[n]=r instanceof ki?r.toJSON():r}})),e}},{key:"size",get:function(){return p(Pi(this._map)).length}},{key:"keys",value:function(){return Un(Pi(this._map),(function(e){return e[0]}))}},{key:"values",value:function(){return Un(Pi(this._map),(function(e){return e[1].content.getContent()[e[1].length-1]}))}},{key:"entries",value:function(){return Un(Pi(this._map),(function(e){return[e[0],e[1].content.getContent()[e[1].length-1]]}))}},{key:"forEach",value:function(e){var t=this;this._map.forEach((function(n,r){n.deleted||e(n.content.getContent()[n.length-1],r,t)}))}},{key:t,value:function(){return this.entries()}},{key:"delete",value:function(e){var t=this;null!==this.doc?$r(this.doc,(function(n){Li(n,t,e)})):this._prelimContent.delete(e)}},{key:"set",value:function(e,t){var n=this;return null!==this.doc?$r(this.doc,(function(r){Di(r,n,e,t)})):this._prelimContent.set(e,t),t}},{key:"get",value:function(e){return Ii(this,e)}},{key:"has",value:function(e){return Ti(this,e)}},{key:"clear",value:function(){var e=this;null!==this.doc?$r(this.doc,(function(t){e.forEach((function(e,n,r){Li(t,r,n)}))})):this._prelimContent.clear()}},{key:"_write",value:function(e){e.writeTypeRef(So)}}]),r}(ki,Symbol.iterator),Hi=function(e,t){return e===t||"object"===v(e)&&"object"===v(t)&&e&&t&&dn(e,t)},zi=function(){function e(t,n,r,i){_(this,e),this.left=t,this.right=n,this.index=r,this.currentAttributes=i}return A(e,[{key:"forward",value:function(){if(null===this.right&&Rt(),this.right.content.constructor===go)this.right.deleted||Ji(this.currentAttributes,this.right.content);else this.right.deleted||(this.index+=this.right.length);this.left=this.right,this.right=this.right.right}}]),e}(),Bi=function(e,t,n){for(;null!==t.right&&n>0;){if(t.right.content.constructor===go)t.right.deleted||Ji(t.currentAttributes,t.right.content);else t.right.deleted||(n<t.right.length&&zr(e,wr(t.right.id.client,t.right.id.clock+n)),t.index+=t.right.length,n-=t.right.length);t.left=t.right,t.right=t.right.right}return t},Vi=function(e,t,n,r){var i=new Map,o=r?yi(t,n):null;if(o){var a=new zi(o.p.left,o.p,o.index,i);return Bi(e,a,n-o.index)}var s=new zi(null,t._start,0,i);return Bi(e,s,n)},qi=function(e,t,n,r){for(;null!==n.right&&(!0===n.right.deleted||n.right.content.constructor===go&&Hi(r.get(n.right.content.key),n.right.content.value));)n.right.deleted||r.delete(n.right.content.key),n.forward();var i=e.doc,o=i.clientID;r.forEach((function(r,a){var s=n.left,u=n.right,c=new To(wr(o,jr(i.store,o)),s,s&&s.lastId,u,u&&u.id,t,null,new go(a,r));c.integrate(e,0),n.right=c,n.forward()}))},Ji=function(e,t){var n=t.key,r=t.value;null===r?e.delete(n):e.set(n,r)},Wi=function(e,t){for(;;){var n;if(null===e.right)break;if(!(e.right.deleted||e.right.content.constructor===go&&Hi(null!==(n=t[e.right.content.key])&&void 0!==n?n:null,e.right.content.value)))break;e.forward()}},Ki=function(e,t,n,r){var i=e.doc,o=i.clientID,a=new Map;for(var s in r){var u,c=r[s],l=null!==(u=n.currentAttributes.get(s))&&void 0!==u?u:null;if(!Hi(l,c)){a.set(s,l);var d=n.left,f=n.right;n.right=new To(wr(o,jr(i.store,o)),d,d&&d.lastId,f,f&&f.id,t,null,new go(s,c)),n.right.integrate(e,0),n.forward()}}return a},Yi=function(e,t,n,r,i){n.currentAttributes.forEach((function(e,t){void 0===i[t]&&(i[t]=null)}));var o=e.doc,a=o.clientID;Wi(n,i);var s=Ki(e,t,n,i),u=r.constructor===String?new wo(r):r instanceof ki?new Ao(r):new po(r),c=n.left,l=n.right,d=n.index;t._searchMarker&&mi(t._searchMarker,n.index,u.getLength()),(l=new To(wr(a,jr(o.store,a)),c,c&&c.lastId,l,l&&l.id,t,null,u)).integrate(e,0),n.right=l,n.index=d,n.forward(),qi(e,t,n,s)},$i=function(e,t,n,r,i){var o=e.doc,a=o.clientID;Wi(n,i);var s=Ki(e,t,n,i);e:for(;null!==n.right&&(r>0||s.size>0&&(n.right.deleted||n.right.content.constructor===go));){if(!n.right.deleted)if(n.right.content.constructor===go){var u=n.right.content,c=u.key,l=u.value,d=i[c];if(void 0!==d){if(Hi(d,l))s.delete(c);else{if(0===r)break e;s.set(c,l)}n.right.delete(e)}else n.currentAttributes.set(c,l)}else r<n.right.length&&zr(e,wr(n.right.id.client,n.right.id.clock+r)),r-=n.right.length;n.forward()}if(r>0){for(var f="";r>0;r--)f+="\n";n.right=new To(wr(a,jr(o.store,a)),n.left,n.left&&n.left.lastId,n.right,n.right&&n.right.id,t,null,new wo(f)),n.right.integrate(e,0),n.forward()}qi(e,t,n,s)},Zi=function(e,t,n,r,i){for(var o=t,a=Ne();o&&(!o.countable||o.deleted);){if(!o.deleted&&o.content.constructor===go){var s=o.content;a.set(s.key,s)}o=o.right}for(var u=0,c=!1;t!==o;){if(n===t&&(c=!0),!t.deleted){var l=t.content;if(l.constructor===go){var d,f,h=l.key,v=l.value,p=null!==(d=r.get(h))&&void 0!==d?d:null;a.get(h)===l&&p!==v||(t.delete(e),u++,c||(null!==(f=i.get(h))&&void 0!==f?f:null)!==v||p===v||(null===p?i.delete(h):i.set(h,p))),c||t.deleted||Ji(i,l)}}t=t.right}return u},Gi=function(e){var t=0;return $r(e.doc,(function(n){for(var r=e._start,i=e._start,o=Ne(),a=Ue(o);i;){if(!1===i.deleted)if(i.content.constructor===go)Ji(a,i.content);else t+=Zi(n,r,i,o,a),o=Ue(a),r=i;i=i.right}})),t},Qi=function(e){var t,n=new Set,r=e.doc,i=k(e.afterState.entries());try{for(i.s();!(t=i.n()).done;){var o=y(t.value,2),a=o[0],s=o[1],u=e.beforeState.get(a)||0;s!==u&&Vr(e,r.store.clients.get(a),u,s,(function(e){e.deleted||e.content.constructor!==go||e.constructor===co||n.add(e.parent)}))}}catch(c){i.e(c)}finally{i.f()}$r(r,(function(t){zn(e,e.deleteSet,(function(e){if(!(e instanceof co||!e.parent._hasFormatting||n.has(e.parent))){var r=e.parent;e.content.constructor===go?n.add(r):function(e,t){for(;t&&t.right&&(t.right.deleted||!t.right.countable);)t=t.right;for(var n=new Set;t&&(t.deleted||!t.countable);){if(!t.deleted&&t.content.constructor===go){var r=t.content.key;n.has(r)?t.delete(e):n.add(r)}t=t.left}}(t,e)}}));var r,i=k(n);try{for(i.s();!(r=i.n()).done;){var o=r.value;Gi(o)}}catch(c){i.e(c)}finally{i.f()}}))},Xi=function(e,t,n){for(var r=n,i=Ue(t.currentAttributes),o=t.right;n>0&&null!==t.right;){if(!1===t.right.deleted)switch(t.right.content.constructor){case Ao:case po:case wo:n<t.right.length&&zr(e,wr(t.right.id.client,t.right.id.clock+n)),n-=t.right.length,t.right.delete(e)}t.forward()}o&&Zi(e,o,t.right,i,t.currentAttributes);var a=(t.left||t.right).parent;return a._searchMarker&&mi(a._searchMarker,t.index,-r+n),t},eo=function(e){u(n,e);var t=l(n);function n(e,r,i){var o;return _(this,n),(o=t.call(this,e,r)).childListChanged=!1,o.keysChanged=new Set,i.forEach((function(e){null===e?o.childListChanged=!0:o.keysChanged.add(e)})),o}return A(n,[{key:"changes",get:function(){if(null===this._changes){var e={keys:this.keys,delta:this.delta,added:new Set,deleted:new Set};this._changes=e}return this._changes}},{key:"delta",get:function(){var e=this;if(null===this._delta){var t=this.target.doc,n=[];$r(t,(function(t){for(var r=new Map,i=new Map,o=e.target._start,a=null,s={},u="",c=0,l=0,d=function(){if(null!==a){var e=null;switch(a){case"delete":l>0&&(e={delete:l}),l=0;break;case"insert":("object"===v(u)||u.length>0)&&(e={insert:u},r.size>0&&(e.attributes={},r.forEach((function(t,n){null!==t&&(e.attributes[n]=t)})))),u="";break;case"retain":c>0&&(e={retain:c},function(e){for(var t in e)return!1;return!0}(s)||(e.attributes=un({},s))),c=0}e&&n.push(e),a=null}};null!==o;){switch(o.content.constructor){case Ao:case po:e.adds(o)?e.deletes(o)||(d(),a="insert",u=o.content.getContent()[0],d()):e.deletes(o)?("delete"!==a&&(d(),a="delete"),l+=1):o.deleted||("retain"!==a&&(d(),a="retain"),c+=1);break;case wo:e.adds(o)?e.deletes(o)||("insert"!==a&&(d(),a="insert"),u+=o.content.str):e.deletes(o)?("delete"!==a&&(d(),a="delete"),l+=o.length):o.deleted||("retain"!==a&&(d(),a="retain"),c+=o.length);break;case go:var f=o.content,h=f.key,p=f.value;if(e.adds(o)){if(!e.deletes(o)){var g,y,m=null!==(g=r.get(h))&&void 0!==g?g:null;if(Hi(m,p))null!==p&&o.delete(t);else"retain"===a&&d(),Hi(p,null!==(y=i.get(h))&&void 0!==y?y:null)?delete s[h]:s[h]=p}}else if(e.deletes(o)){var w;i.set(h,p);var k=null!==(w=r.get(h))&&void 0!==w?w:null;Hi(k,p)||("retain"===a&&d(),s[h]=k)}else if(!o.deleted){i.set(h,p);var b=s[h];void 0!==b&&(Hi(b,p)?null!==b&&o.delete(t):("retain"===a&&d(),null===p?delete s[h]:s[h]=p))}o.deleted||("insert"===a&&d(),Ji(r,o.content))}o=o.right}for(d();n.length>0;){var S=n[n.length-1];if(void 0===S.retain||void 0!==S.attributes)break;n.pop()}})),this._delta=n}return this._delta}}]),n}(fi),to=function(e){u(n,e);var t=l(n);function n(e){var r;return _(this,n),(r=t.call(this))._pending=void 0!==e?[function(){return r.insert(0,e)}]:[],r._searchMarker=[],r._hasFormatting=!1,r}return A(n,[{key:"length",get:function(){return this._length}},{key:"_integrate",value:function(e,t){s(h(n.prototype),"_integrate",this).call(this,e,t);try{this._pending.forEach((function(e){return e()}))}catch(Lc){console.error(Lc)}this._pending=null}},{key:"_copy",value:function(){return new n}},{key:"clone",value:function(){var e=new n;return e.applyDelta(this.toDelta()),e}},{key:"_callObserver",value:function(e,t){s(h(n.prototype),"_callObserver",this).call(this,e,t);var r=new eo(this,e,t);wi(this,e,r),!e.local&&this._hasFormatting&&(e._needFormattingCleanup=!0)}},{key:"toString",value:function(){for(var e="",t=this._start;null!==t;)!t.deleted&&t.countable&&t.content.constructor===wo&&(e+=t.content.str),t=t.right;return e}},{key:"toJSON",value:function(){return this.toString()}},{key:"applyDelta",value:function(e){var t=this,n=(arguments.length>1&&void 0!==arguments[1]?arguments[1]:{}).sanitize,r=void 0===n||n;null!==this.doc?$r(this.doc,(function(n){for(var i=new zi(null,t._start,0,new Map),o=0;o<e.length;o++){var a=e[o];if(void 0!==a.insert){var s=r||"string"!=typeof a.insert||o!==e.length-1||null!==i.right||"\n"!==a.insert.slice(-1)?a.insert:a.insert.slice(0,-1);("string"!=typeof s||s.length>0)&&Yi(n,t,i,s,a.attributes||{})}else void 0!==a.retain?$i(n,t,i,a.retain,a.attributes||{}):void 0!==a.delete&&Xi(n,i,a.delete)}})):this._pending.push((function(){return t.applyDelta(e)}))}},{key:"toDelta",value:function(e,t,n){var r=[],i=new Map,o=this.doc,a="",s=this._start;function u(){if(a.length>0){var e={},t=!1;i.forEach((function(n,r){t=!0,e[r]=n}));var n={insert:a};t&&(n.attributes=e),r.push(n),a=""}}var c=function(){for(var o=function(){if(Ir(s,e)||void 0!==t&&Ir(s,t))switch(s.content.constructor){case wo:var o=i.get("ychange");void 0===e||Ir(s,e)?void 0===t||Ir(s,t)?void 0!==o&&(u(),i.delete("ychange")):void 0!==o&&o.user===s.id.client&&"added"===o.type||(u(),i.set("ychange",n?n("added",s.id):{type:"added"})):void 0!==o&&o.user===s.id.client&&"removed"===o.type||(u(),i.set("ychange",n?n("removed",s.id):{type:"removed"})),a+=s.content.str;break;case Ao:case po:u();var c={insert:s.content.getContent()[0]};if(i.size>0){var l={};c.attributes=l,i.forEach((function(e,t){l[t]=e}))}r.push(c);break;case go:Ir(s,e)&&(u(),Ji(i,s.content))}s=s.right};null!==s;)o();u()};return e||t?$r(o,(function(n){e&&Rr(n,e),t&&Rr(n,t),c()}),"cleanup"):c(),r}},{key:"insert",value:function(e,t,n){var r=this;if(!(t.length<=0)){var i=this.doc;null!==i?$r(i,(function(i){var o=Vi(i,r,e,!n);n||(n={},o.currentAttributes.forEach((function(e,t){n[t]=e}))),Yi(i,r,o,t,n)})):this._pending.push((function(){return r.insert(e,t,n)}))}}},{key:"insertEmbed",value:function(e,t,n){var r=this,i=this.doc;null!==i?$r(i,(function(i){var o=Vi(i,r,e,!n);Yi(i,r,o,t,n||{})})):this._pending.push((function(){return r.insertEmbed(e,t,n||{})}))}},{key:"delete",value:function(e,t){var n=this;if(0!==t){var r=this.doc;null!==r?$r(r,(function(r){Xi(r,Vi(r,n,e,!0),t)})):this._pending.push((function(){return n.delete(e,t)}))}}},{key:"format",value:function(e,t,n){var r=this;if(0!==t){var i=this.doc;null!==i?$r(i,(function(i){var o=Vi(i,r,e,!1);null!==o.right&&$i(i,r,o,t,n)})):this._pending.push((function(){return r.format(e,t,n)}))}}},{key:"removeAttribute",value:function(e){var t=this;null!==this.doc?$r(this.doc,(function(n){Li(n,t,e)})):this._pending.push((function(){return t.removeAttribute(e)}))}},{key:"setAttribute",value:function(e,t){var n=this;null!==this.doc?$r(this.doc,(function(r){Di(r,n,e,t)})):this._pending.push((function(){return n.setAttribute(e,t)}))}},{key:"getAttribute",value:function(e){return Ii(this,e)}},{key:"getAttributes",value:function(){return Ri(this)}},{key:"_write",value:function(e){e.writeTypeRef(xo)}}]),n}(ki),no=function(e){function t(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(){return!0};_(this,t),this._filter=n,this._root=e,this._currentNode=e._start,this._firstCall=!0}return A(t,[{key:Symbol.iterator,value:function(){return this}},{key:"next",value:function(){var e=this._currentNode,t=e&&e.content&&e.content.type;if(null!==e&&(!this._firstCall||e.deleted||!this._filter(t)))do{if(t=e.content.type,e.deleted||t.constructor!==io&&t.constructor!==ro||null===t._start)for(;null!==e;){if(null!==e.right){e=e.right;break}e=e.parent===this._root?null:e.parent._item}else e=t._start}while(null!==e&&(e.deleted||!this._filter(e.content.type)));return this._firstCall=!1,null===e?{value:void 0,done:!0}:(this._currentNode=e,{value:e.content.type,done:!1})}}]),t}(),ro=function(e){u(n,e);var t=l(n);function n(){var e;return _(this,n),(e=t.call(this))._prelimContent=[],e}return A(n,[{key:"firstChild",get:function(){var e=this._first;return e?e.content.getContent()[0]:null}},{key:"_integrate",value:function(e,t){s(h(n.prototype),"_integrate",this).call(this,e,t),this.insert(0,this._prelimContent),this._prelimContent=null}},{key:"_copy",value:function(){return new n}},{key:"clone",value:function(){var e=new n;return e.insert(0,this.toArray().map((function(e){return e instanceof ki?e.clone():e}))),e}},{key:"length",get:function(){return null===this._prelimContent?this._length:this._prelimContent.length}},{key:"createTreeWalker",value:function(e){return new no(this,e)}},{key:"querySelector",value:function(e){e=e.toUpperCase();var t=new no(this,(function(t){return t.nodeName&&t.nodeName.toUpperCase()===e})).next();return t.done?null:t.value}},{key:"querySelectorAll",value:function(e){return e=e.toUpperCase(),Ve(new no(this,(function(t){return t.nodeName&&t.nodeName.toUpperCase()===e})))}},{key:"_callObserver",value:function(e,t){wi(this,e,new oo(this,t,e))}},{key:"toString",value:function(){return Ei(this,(function(e){return e.toString()})).join("")}},{key:"toJSON",value:function(){return this.toString()}},{key:"toDOM",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:document,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2?arguments[2]:void 0,r=e.createDocumentFragment();return void 0!==n&&n._createAssociation(r,this),xi(this,(function(i){r.insertBefore(i.toDOM(e,t,n),null)})),r}},{key:"insert",value:function(e,t){var n,r=this;null!==this.doc?$r(this.doc,(function(n){Ai(n,r,e,t)})):(n=this._prelimContent).splice.apply(n,[e,0].concat(p(t)))}},{key:"insertAfter",value:function(e,t){var n=this;if(null!==this.doc)$r(this.doc,(function(r){var i=e&&e instanceof ki?e._item:e;_i(r,n,i,t)}));else{var r=this._prelimContent,i=null===e?0:r.findIndex((function(t){return t===e}))+1;if(0===i&&null!==e)throw Dt("Reference item not found");r.splice.apply(r,[i,0].concat(p(t)))}}},{key:"delete",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;null!==this.doc?$r(this.doc,(function(r){Mi(r,t,e,n)})):this._prelimContent.splice(e,n)}},{key:"toArray",value:function(){return Si(this)}},{key:"push",value:function(e){this.insert(this.length,e)}},{key:"unshift",value:function(e){this.insert(0,e)}},{key:"get",value:function(e){return Ci(this,e)}},{key:"slice",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.length;return bi(this,e,t)}},{key:"forEach",value:function(e){xi(this,e)}},{key:"_write",value:function(e){e.writeTypeRef(Co)}}]),n}(ki),io=function(e){u(n,e);var t=l(n);function n(){var e,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"UNDEFINED";return _(this,n),(e=t.call(this)).nodeName=r,e._prelimAttrs=new Map,e}return A(n,[{key:"nextSibling",get:function(){var e=this._item?this._item.next:null;return e?e.content.type:null}},{key:"prevSibling",get:function(){var e=this._item?this._item.prev:null;return e?e.content.type:null}},{key:"_integrate",value:function(e,t){var r=this;s(h(n.prototype),"_integrate",this).call(this,e,t),this._prelimAttrs.forEach((function(e,t){r.setAttribute(t,e)})),this._prelimAttrs=null}},{key:"_copy",value:function(){return new n(this.nodeName)}},{key:"clone",value:function(){var e=new n(this.nodeName);return function(e,t){for(var n in e)t(e[n],n)}(this.getAttributes(),(function(t,n){"string"==typeof t&&e.setAttribute(n,t)})),e.insert(0,this.toArray().map((function(e){return e instanceof ki?e.clone():e}))),e}},{key:"toString",value:function(){var e=this.getAttributes(),t=[],r=[];for(var i in e)r.push(i);r.sort();for(var o=r.length,a=0;a<o;a++){var u=r[a];t.push(u+'="'+e[u]+'"')}var c=this.nodeName.toLocaleLowerCase(),l=t.length>0?" "+t.join(" "):"";return"<".concat(c).concat(l,">").concat(s(h(n.prototype),"toString",this).call(this),"</").concat(c,">")}},{key:"removeAttribute",value:function(e){var t=this;null!==this.doc?$r(this.doc,(function(n){Li(n,t,e)})):this._prelimAttrs.delete(e)}},{key:"setAttribute",value:function(e,t){var n=this;null!==this.doc?$r(this.doc,(function(r){Di(r,n,e,t)})):this._prelimAttrs.set(e,t)}},{key:"getAttribute",value:function(e){return Ii(this,e)}},{key:"hasAttribute",value:function(e){return Ti(this,e)}},{key:"getAttributes",value:function(e){return e?function(e,t){var n={};return e._map.forEach((function(e,r){for(var i=e;null!==i&&(!t.sv.has(i.id.client)||i.id.clock>=(t.sv.get(i.id.client)||0));)i=i.left;null!==i&&Ir(i,t)&&(n[r]=i.content.getContent()[i.length-1])})),n}(this,e):Ri(this)}},{key:"toDOM",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:document,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2?arguments[2]:void 0,r=e.createElement(this.nodeName),i=this.getAttributes();for(var o in i){var a=i[o];"string"==typeof a&&r.setAttribute(o,a)}return xi(this,(function(i){r.appendChild(i.toDOM(e,t,n))})),void 0!==n&&n._createAssociation(r,this),r}},{key:"_write",value:function(e){e.writeTypeRef(Eo),e.writeKey(this.nodeName)}}]),n}(ro),oo=function(e){u(n,e);var t=l(n);function n(e,r,i){var o;return _(this,n),(o=t.call(this,e,i)).childListChanged=!1,o.attributesChanged=new Set,r.forEach((function(e){null===e?o.childListChanged=!0:o.attributesChanged.add(e)})),o}return A(n)}(fi),ao=function(e){u(n,e);var t=l(n);function n(e){var r;return _(this,n),(r=t.call(this)).hookName=e,r}return A(n,[{key:"_copy",value:function(){return new n(this.hookName)}},{key:"clone",value:function(){var e=new n(this.hookName);return this.forEach((function(t,n){e.set(n,t)})),e}},{key:"toDOM",value:function(){arguments.length>0&&void 0!==arguments[0]||document;var e,t=arguments.length>2?arguments[2]:void 0,n=(arguments.length>1&&void 0!==arguments[1]?arguments[1]:{})[this.hookName];return(e=void 0!==n?n.createDom(this):document.createElement(this.hookName)).setAttribute("data-yjs-hook",this.hookName),void 0!==t&&t._createAssociation(e,this),e}},{key:"_write",value:function(e){e.writeTypeRef(_o),e.writeKey(this.hookName)}}]),n}(Fi),so=function(e){u(n,e);var t=l(n);function n(){return _(this,n),t.apply(this,arguments)}return A(n,[{key:"nextSibling",get:function(){var e=this._item?this._item.next:null;return e?e.content.type:null}},{key:"prevSibling",get:function(){var e=this._item?this._item.prev:null;return e?e.content.type:null}},{key:"_copy",value:function(){return new n}},{key:"clone",value:function(){var e=new n;return e.applyDelta(this.toDelta()),e}},{key:"toDOM",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:document,t=arguments.length>2?arguments[2]:void 0,n=e.createTextNode(this.toString());return void 0!==t&&t._createAssociation(n,this),n}},{key:"toString",value:function(){return this.toDelta().map((function(e){var t=[];for(var n in e.attributes){var r=[];for(var i in e.attributes[n])r.push({key:i,value:e.attributes[n][i]});r.sort((function(e,t){return e.key<t.key?-1:1})),t.push({nodeName:n,attrs:r})}t.sort((function(e,t){return e.nodeName<t.nodeName?-1:1}));for(var o="",a=0;a<t.length;a++){var s=t[a];o+="<".concat(s.nodeName);for(var u=0;u<s.attrs.length;u++){var c=s.attrs[u];o+=" ".concat(c.key,'="').concat(c.value,'"')}o+=">"}o+=e.insert;for(var l=t.length-1;l>=0;l--)o+="</".concat(t[l].nodeName,">");return o})).join("")}},{key:"toJSON",value:function(){return this.toString()}},{key:"_write",value:function(e){e.writeTypeRef(Oo)}}]),n}(to),uo=function(){function e(t,n){_(this,e),this.id=t,this.length=n}return A(e,[{key:"deleted",get:function(){throw It()}},{key:"mergeWith",value:function(e){return!1}},{key:"write",value:function(e,t,n){throw It()}},{key:"integrate",value:function(e,t){throw It()}}]),e}(),co=function(e){u(n,e);var t=l(n);function n(){return _(this,n),t.apply(this,arguments)}return A(n,[{key:"deleted",get:function(){return!0}},{key:"delete",value:function(){}},{key:"mergeWith",value:function(e){return this.constructor===e.constructor&&(this.length+=e.length,!0)}},{key:"integrate",value:function(e,t){t>0&&(this.id.clock+=t,this.length-=t),Nr(e.doc.store,this)}},{key:"write",value:function(e,t){e.writeInfo(0),e.writeLen(this.length-t)}},{key:"getMissing",value:function(e,t){return null}}]),n}(uo),lo=function(){function e(t){_(this,e),this.content=t}return A(e,[{key:"getLength",value:function(){return 1}},{key:"getContent",value:function(){return[this.content]}},{key:"isCountable",value:function(){return!0}},{key:"copy",value:function(){return new e(this.content)}},{key:"splice",value:function(e){throw It()}},{key:"mergeWith",value:function(e){return!1}},{key:"integrate",value:function(e,t){}},{key:"delete",value:function(e){}},{key:"gc",value:function(e){}},{key:"write",value:function(e,t){e.writeBuf(this.content)}},{key:"getRef",value:function(){return 3}}]),e}(),fo=function(){function e(t){_(this,e),this.len=t}return A(e,[{key:"getLength",value:function(){return this.len}},{key:"getContent",value:function(){return[]}},{key:"isCountable",value:function(){return!1}},{key:"copy",value:function(){return new e(this.len)}},{key:"splice",value:function(t){var n=new e(this.len-t);return this.len=t,n}},{key:"mergeWith",value:function(e){return this.len+=e.len,!0}},{key:"integrate",value:function(e,t){Jn(e.deleteSet,t.id.client,t.id.clock,this.len),t.markDeleted()}},{key:"delete",value:function(e){}},{key:"gc",value:function(e){}},{key:"write",value:function(e,t){e.writeLen(this.len-t)}},{key:"getRef",value:function(){return 1}}]),e}(),ho=function(e,t){return new Gn(a(a({guid:e},t),{},{shouldLoad:t.shouldLoad||t.autoLoad||!1}))},vo=function(){function e(t){_(this,e),t._item&&console.error("This document was already integrated as a sub-document. You should create a second instance instead with the same guid."),this.doc=t;var n={};this.opts=n,t.gc||(n.gc=!1),t.autoLoad&&(n.autoLoad=!0),null!==t.meta&&(n.meta=t.meta)}return A(e,[{key:"getLength",value:function(){return 1}},{key:"getContent",value:function(){return[this.doc]}},{key:"isCountable",value:function(){return!0}},{key:"copy",value:function(){return new e(ho(this.doc.guid,this.opts))}},{key:"splice",value:function(e){throw It()}},{key:"mergeWith",value:function(e){return!1}},{key:"integrate",value:function(e,t){this.doc._item=t,e.subdocsAdded.add(this.doc),this.doc.shouldLoad&&e.subdocsLoaded.add(this.doc)}},{key:"delete",value:function(e){e.subdocsAdded.has(this.doc)?e.subdocsAdded.delete(this.doc):e.subdocsRemoved.add(this.doc)}},{key:"gc",value:function(e){}},{key:"write",value:function(e,t){e.writeString(this.doc.guid),e.writeAny(this.opts)}},{key:"getRef",value:function(){return 9}}]),e}(),po=function(){function e(t){_(this,e),this.embed=t}return A(e,[{key:"getLength",value:function(){return 1}},{key:"getContent",value:function(){return[this.embed]}},{key:"isCountable",value:function(){return!0}},{key:"copy",value:function(){return new e(this.embed)}},{key:"splice",value:function(e){throw It()}},{key:"mergeWith",value:function(e){return!1}},{key:"integrate",value:function(e,t){}},{key:"delete",value:function(e){}},{key:"gc",value:function(e){}},{key:"write",value:function(e,t){e.writeJSON(this.embed)}},{key:"getRef",value:function(){return 5}}]),e}(),go=function(){function e(t,n){_(this,e),this.key=t,this.value=n}return A(e,[{key:"getLength",value:function(){return 1}},{key:"getContent",value:function(){return[]}},{key:"isCountable",value:function(){return!1}},{key:"copy",value:function(){return new e(this.key,this.value)}},{key:"splice",value:function(e){throw It()}},{key:"mergeWith",value:function(e){return!1}},{key:"integrate",value:function(e,t){var n=t.parent;n._searchMarker=null,n._hasFormatting=!0}},{key:"delete",value:function(e){}},{key:"gc",value:function(e){}},{key:"write",value:function(e,t){e.writeKey(this.key),e.writeJSON(this.value)}},{key:"getRef",value:function(){return 6}}]),e}(),yo=function(){function e(t){_(this,e),this.arr=t}return A(e,[{key:"getLength",value:function(){return this.arr.length}},{key:"getContent",value:function(){return this.arr}},{key:"isCountable",value:function(){return!0}},{key:"copy",value:function(){return new e(this.arr)}},{key:"splice",value:function(t){var n=new e(this.arr.slice(t));return this.arr=this.arr.slice(0,t),n}},{key:"mergeWith",value:function(e){return this.arr=this.arr.concat(e.arr),!0}},{key:"integrate",value:function(e,t){}},{key:"delete",value:function(e){}},{key:"gc",value:function(e){}},{key:"write",value:function(e,t){var n=this.arr.length;e.writeLen(n-t);for(var r=t;r<n;r++){var i=this.arr[r];e.writeString(void 0===i?"undefined":JSON.stringify(i))}}},{key:"getRef",value:function(){return 2}}]),e}(),mo=function(){function e(t){_(this,e),this.arr=t}return A(e,[{key:"getLength",value:function(){return this.arr.length}},{key:"getContent",value:function(){return this.arr}},{key:"isCountable",value:function(){return!0}},{key:"copy",value:function(){return new e(this.arr)}},{key:"splice",value:function(t){var n=new e(this.arr.slice(t));return this.arr=this.arr.slice(0,t),n}},{key:"mergeWith",value:function(e){return this.arr=this.arr.concat(e.arr),!0}},{key:"integrate",value:function(e,t){}},{key:"delete",value:function(e){}},{key:"gc",value:function(e){}},{key:"write",value:function(e,t){var n=this.arr.length;e.writeLen(n-t);for(var r=t;r<n;r++){var i=this.arr[r];e.writeAny(i)}}},{key:"getRef",value:function(){return 8}}]),e}(),wo=function(){function e(t){_(this,e),this.str=t}return A(e,[{key:"getLength",value:function(){return this.str.length}},{key:"getContent",value:function(){return this.str.split("")}},{key:"isCountable",value:function(){return!0}},{key:"copy",value:function(){return new e(this.str)}},{key:"splice",value:function(t){var n=new e(this.str.slice(t));this.str=this.str.slice(0,t);var r=this.str.charCodeAt(t-1);return r>=55296&&r<=56319&&(this.str=this.str.slice(0,t-1)+"�",n.str="�"+n.str.slice(1)),n}},{key:"mergeWith",value:function(e){return this.str+=e.str,!0}},{key:"integrate",value:function(e,t){}},{key:"delete",value:function(e){}},{key:"gc",value:function(e){}},{key:"write",value:function(e,t){e.writeString(0===t?this.str:this.str.slice(t))}},{key:"getRef",value:function(){return 4}}]),e}(),ko=[function(e){return new Ni},function(e){return new Fi},function(e){return new to},function(e){return new io(e.readKey())},function(e){return new ro},function(e){return new ao(e.readKey())},function(e){return new so}],bo=0,So=1,xo=2,Eo=3,Co=4,_o=5,Oo=6,Ao=function(){function e(t){_(this,e),this.type=t}return A(e,[{key:"getLength",value:function(){return 1}},{key:"getContent",value:function(){return[this.type]}},{key:"isCountable",value:function(){return!0}},{key:"copy",value:function(){return new e(this.type._copy())}},{key:"splice",value:function(e){throw It()}},{key:"mergeWith",value:function(e){return!1}},{key:"integrate",value:function(e,t){this.type._integrate(e.doc,t)}},{key:"delete",value:function(e){for(var t=this.type._start;null!==t;)t.deleted?t.id.clock<(e.beforeState.get(t.id.client)||0)&&e._mergeStructs.push(t):t.delete(e),t=t.right;this.type._map.forEach((function(t){t.deleted?t.id.clock<(e.beforeState.get(t.id.client)||0)&&e._mergeStructs.push(t):t.delete(e)})),e.changed.delete(this.type)}},{key:"gc",value:function(e){for(var t=this.type._start;null!==t;)t.gc(e,!0),t=t.right;this.type._start=null,this.type._map.forEach((function(t){for(;null!==t;)t.gc(e,!0),t=t.left})),this.type._map=new Map}},{key:"write",value:function(e,t){this.type._write(e)}},{key:"getRef",value:function(){return 7}}]),e}(),Mo=function(e,t){var n,r=t,i=0;do{i>0&&(r=wr(r.client,r.clock+i)),n=Fr(e,r),i=r.clock-n.id.clock,r=n.redone}while(null!==r&&n instanceof To);return{item:n,diff:i}},Lo=function(e,t){for(;null!==e&&e.keep!==t;)e.keep=t,e=e.parent._item},Do=function(e,t,n){var r=t.id,i=r.client,o=r.clock,a=new To(wr(i,o+n),t,wr(i,o+n-1),t.right,t.rightOrigin,t.parent,t.parentSub,t.content.splice(n));return t.deleted&&a.markDeleted(),t.keep&&(a.keep=!0),null!==t.redone&&(a.redone=wr(t.redone.client,t.redone.clock+n)),t.right=a,null!==a.right&&(a.right.left=a),e._mergeStructs.push(a),null!==a.parentSub&&null===a.right&&a.parent._map.set(a.parentSub,a),t.length=n,a},Io=function(e,t){return function(e,t){for(var n=0;n<e.length;n++)if(t(e[n],n,e))return!0;return!1}(e,(function(e){return Bn(e.deletions,t)}))},Ro=function e(t,n,r,i,o,a){var s=t.doc,u=s.store,c=s.clientID,l=n.redone;if(null!==l)return zr(t,l);var d,f=n.parent._item,h=null;if(null!==f&&!0===f.deleted){if(null===f.redone&&(!r.has(f)||null===e(t,f,r,i,o,a)))return null;for(;null!==f.redone;)f=zr(t,f.redone)}var v=null===f?n.parent:f.content.type;if(null===n.parentSub){for(h=n.left,d=n;null!==h;){for(var p=h;null!==p&&p.parent._item!==f;)p=null===p.redone?null:zr(t,p.redone);if(null!==p&&p.parent._item===f){h=p;break}h=h.left}for(;null!==d;){for(var g=d;null!==g&&g.parent._item!==f;)g=null===g.redone?null:zr(t,g.redone);if(null!==g&&g.parent._item===f){d=g;break}d=d.right}}else if(d=null,n.right&&!o){for(h=n;null!==h&&null!==h.right&&(h.right.redone||Bn(i,h.right.id)||Io(a.undoStack,h.right.id)||Io(a.redoStack,h.right.id));)for(h=h.right;h.redone;)h=zr(t,h.redone);if(h&&null!==h.right)return null}else h=v._map.get(n.parentSub)||null;var y=jr(u,c),m=wr(c,y),w=new To(m,h,h&&h.lastId,d,d&&d.id,v,n.parentSub,n.content.copy());return n.redone=m,Lo(w,!0),w.integrate(t,0),w},To=function(e){u(n,e);var t=l(n);function n(e,r,i,o,a,s,u,c){var l;return _(this,n),(l=t.call(this,e,c.getLength())).origin=i,l.left=r,l.right=o,l.rightOrigin=a,l.parent=s,l.parentSub=u,l.redone=null,l.content=c,l.info=l.content.isCountable()?2:0,l}return A(n,[{key:"marker",get:function(){return(8&this.info)>0},set:function(e){(8&this.info)>0!==e&&(this.info^=8)}},{key:"keep",get:function(){return(1&this.info)>0},set:function(e){this.keep!==e&&(this.info^=1)}},{key:"countable",get:function(){return(2&this.info)>0}},{key:"deleted",get:function(){return(4&this.info)>0},set:function(e){this.deleted!==e&&(this.info^=4)}},{key:"markDeleted",value:function(){this.info|=4}},{key:"getMissing",value:function(e,t){if(this.origin&&this.origin.client!==this.id.client&&this.origin.clock>=jr(t,this.origin.client))return this.origin.client;if(this.rightOrigin&&this.rightOrigin.client!==this.id.client&&this.rightOrigin.clock>=jr(t,this.rightOrigin.client))return this.rightOrigin.client;if(this.parent&&this.parent.constructor===yr&&this.id.client!==this.parent.client&&this.parent.clock>=jr(t,this.parent.client))return this.parent.client;if(this.origin&&(this.left=Br(e,t,this.origin),this.origin=this.left.lastId),this.rightOrigin&&(this.right=zr(e,this.rightOrigin),this.rightOrigin=this.right.id),this.left&&this.left.constructor===co||this.right&&this.right.constructor===co)this.parent=null;else if(this.parent){if(this.parent.constructor===yr){var r=Fr(t,this.parent);r.constructor===co?this.parent=null:this.parent=r.content.type}}else this.left&&this.left.constructor===n&&(this.parent=this.left.parent,this.parentSub=this.left.parentSub),this.right&&this.right.constructor===n&&(this.parent=this.right.parent,this.parentSub=this.right.parentSub);return null}},{key:"integrate",value:function(e,t){if(t>0&&(this.id.clock+=t,this.left=Br(e,e.doc.store,wr(this.id.client,this.id.clock-1)),this.origin=this.left.lastId,this.content=this.content.splice(t),this.length-=t),this.parent){if(!this.left&&(!this.right||null!==this.right.left)||this.left&&this.left.right!==this.right){var n,r=this.left;if(null!==r)n=r.right;else if(null!==this.parentSub)for(n=this.parent._map.get(this.parentSub)||null;null!==n&&null!==n.left;)n=n.left;else n=this.parent._start;for(var i=new Set,o=new Set;null!==n&&n!==this.right;){if(o.add(n),i.add(n),mr(this.origin,n.origin)){if(n.id.client<this.id.client)r=n,i.clear();else if(mr(this.rightOrigin,n.rightOrigin))break}else{if(null===n.origin||!o.has(Fr(e.doc.store,n.origin)))break;i.has(Fr(e.doc.store,n.origin))||(r=n,i.clear())}n=n.right}this.left=r}if(null!==this.left){var a=this.left.right;this.right=a,this.left.right=this}else{var s;if(null!==this.parentSub)for(s=this.parent._map.get(this.parentSub)||null;null!==s&&null!==s.left;)s=s.left;else s=this.parent._start,this.parent._start=this;this.right=s}null!==this.right?this.right.left=this:null!==this.parentSub&&(this.parent._map.set(this.parentSub,this),null!==this.left&&this.left.delete(e)),null===this.parentSub&&this.countable&&!this.deleted&&(this.parent._length+=this.length),Nr(e.doc.store,this),this.content.integrate(e,this),Wr(e,this.parent,this.parentSub),(null!==this.parent._item&&this.parent._item.deleted||null!==this.parentSub&&null!==this.right)&&this.delete(e)}else new co(this.id,this.length).integrate(e,0)}},{key:"next",get:function(){for(var e=this.right;null!==e&&e.deleted;)e=e.right;return e}},{key:"prev",get:function(){for(var e=this.left;null!==e&&e.deleted;)e=e.left;return e}},{key:"lastId",get:function(){return 1===this.length?this.id:wr(this.id.client,this.id.clock+this.length-1)}},{key:"mergeWith",value:function(e){var t=this;if(this.constructor===e.constructor&&mr(e.origin,this.lastId)&&this.right===e&&mr(this.rightOrigin,e.rightOrigin)&&this.id.client===e.id.client&&this.id.clock+this.length===e.id.clock&&this.deleted===e.deleted&&null===this.redone&&null===e.redone&&this.content.constructor===e.content.constructor&&this.content.mergeWith(e.content)){var n=this.parent._searchMarker;return n&&n.forEach((function(n){n.p===e&&(n.p=t,!t.deleted&&t.countable&&(n.index-=t.length))})),e.keep&&(this.keep=!0),this.right=e.right,null!==this.right&&(this.right.left=this),this.length+=e.length,!0}return!1}},{key:"delete",value:function(e){if(!this.deleted){var t=this.parent;this.countable&&null===this.parentSub&&(t._length-=this.length),this.markDeleted(),Jn(e.deleteSet,this.id.client,this.id.clock,this.length),Wr(e,t,this.parentSub),this.content.delete(e)}}},{key:"gc",value:function(e,t){if(!this.deleted)throw Rt();this.content.gc(e),t?function(e,t,n){var r=e.clients.get(t.id.client);r[Ur(r,t.id.clock)]=n}(e,this,new co(this.id,this.length)):this.content=new fo(this.length)}},{key:"write",value:function(e,t){var n=t>0?wr(this.id.client,this.id.clock+t-1):this.origin,r=this.rightOrigin,i=this.parentSub,o=this.content.getRef()&et|(null===n?0:Xe)|(null===r?0:Qe)|(null===i?0:Ge);if(e.writeInfo(o),null!==n&&e.writeLeftID(n),null!==r&&e.writeRightID(r),null===n&&null===r){var a=this.parent;if(void 0!==a._item){var s=a._item;if(null===s){var u=Sr(a);e.writeParentInfo(!0),e.writeString(u)}else e.writeParentInfo(!1),e.writeLeftID(s.id)}else a.constructor===String?(e.writeParentInfo(!0),e.writeString(a)):a.constructor===yr?(e.writeParentInfo(!1),e.writeLeftID(a)):Rt();null!==i&&e.writeString(i)}this.content.write(e,t)}}]),n}(uo),Po=function(e,t){return jo[t&et](e)},jo=[function(){Rt()},function(e){return new fo(e.readLen())},function(e){for(var t=e.readLen(),n=[],r=0;r<t;r++){var i=e.readString();"undefined"===i?n.push(void 0):n.push(JSON.parse(i))}return new yo(n)},function(e){return new lo(e.readBuf())},function(e){return new wo(e.readString())},function(e){return new po(e.readJSON())},function(e){return new go(e.readKey(),e.readJSON())},function(e){return new Ao(ko[e.readTypeRef()](e))},function(e){for(var t=e.readLen(),n=[],r=0;r<t;r++)n.push(e.readAny());return new mo(n)},function(e){return new vo(ho(e.readString(),e.readAny()))},function(){Rt()}],No=function(e){u(n,e);var t=l(n);function n(){return _(this,n),t.apply(this,arguments)}return A(n,[{key:"deleted",get:function(){return!0}},{key:"delete",value:function(){}},{key:"mergeWith",value:function(e){return this.constructor===e.constructor&&(this.length+=e.length,!0)}},{key:"integrate",value:function(e,t){Rt()}},{key:"write",value:function(e,t){e.writeInfo(10),pt(e.restEncoder,this.length-t)}},{key:"getMissing",value:function(e,t){return null}}]),n}(uo),Uo="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{},Fo="__ $YJS$ __";function Ho(e){return"[object Object]"===Object.prototype.toString.call(e)}function zo(e){if(!Ho(e))return!1;var t=e.constructor;if(void 0===t)return!0;var n=t.prototype;return!1!==Ho(n)&&!1!==n.hasOwnProperty("isPrototypeOf")}function Bo(e,t){for(var n in e){var r=e[n],i=t[n];if(zo(r)&&zo(i)){if(!Bo(r,i))return!1}else if(Array.isArray(r)&&Array.isArray(i)){if(r.length!==i.length)return!1;for(var o=0;o<r.length;o++)if(r[o]!==i[o])return!1}else if(r!==i)return!1}for(var a in t)if(void 0===e[a]&&void 0!==t[a])return!1;return!0}function Vo(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return Object.fromEntries(Object.entries(e).filter((function(e){var t=y(e,1)[0];return n.includes(t)})))}function qo(e){return function(e){var t,n=[],r=k(e);try{for(r.s();!(t=r.n()).done;){var i,o,a=t.value;if("string"!=typeof a.insert||0!==a.insert.length){var s=n[n.length-1];s&&"string"==typeof s.insert&&"string"==typeof a.insert&&(s.attributes===a.attributes||!s.attributes==!a.attributes&&Bo(null!==(i=s.attributes)&&void 0!==i?i:{},null!==(o=a.attributes)&&void 0!==o?o:{}))?s.insert+=a.insert:n.push(a)}}}catch(u){r.e(u)}finally{r.f()}return n}(e.toDelta())}function Jo(e){var t=e.insert;return"string"==typeof t?t.length:1}function Wo(e){return e.reduce((function(e,t){return e+Jo(t)}),0)}function Ko(e,t,n){if(n<1)return[];for(var r=0,i=[],o=t+n,s=0;s<e.length&&!(r>=o);s++){var u=e[s],c=Jo(u);if(r+c<=t)r+=c;else if("string"==typeof u.insert){var l=Math.max(0,t-r),d=Math.min(c,c-(r+c-o));i.push(a(a({},u),{},{insert:u.insert.slice(l,d)})),r+=c}else r+=c,i.push(u)}return i}function Yo(e){return function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return Object.fromEntries(Object.entries(e).filter((function(e){var t=y(e,1)[0];return!n.includes(t)})))}(e,ae.isText(e)?"text":"children")}function $o(e){var t=qo(e),n=t.length>0?t.map(Zo):[{text:""}];return a(a({},e.getAttributes()),{},{children:n})}function Zo(e){return"string"==typeof e.insert?a(a({},e.attributes),{},{text:e.insert}):$o(e.insert)}function Go(e){return e.map((function(e){return ae.isText(e)?{insert:e.text,attributes:Yo(e)}:{insert:Qo(e)}}))}function Qo(t){var n=t.children,r=i(t,e),o=new so;return Object.entries(r).forEach((function(e){var t=y(e,2),n=t[0],r=t[1];o.setAttribute(n,r)})),o.applyDelta(Go(n),{sanitize:!1}),o}function Xo(e){return e?ae.isText(e)?e.text.length:1:0}function ea(e,t,n){var r;if(0===n.length)throw new Error("Path has to a have a length >= 1");if(ae.isText(t))throw new Error("Cannot descent into slate text");var i,o=w(i=n)||g(i)||b(i)||m(),a=o[0],s=o.slice(1),u=function(e,t){return e.children.slice(0,t).reduce((function(e,t){return e+Xo(t)}),0)}(t,a),c=t.children[a],l=qo(e),d=Xo(c),f=Ko(l,u,d);if(f.length>1)throw new Error("Path doesn't match yText, yTarget spans multiple nodes");var h=null===(r=f[0])||void 0===r?void 0:r.insert;if(s.length>0){if(!(h instanceof so))throw new Error("Path doesn't match yText, cannot descent into non-yText");return ea(h,c,s)}return{yParent:e,textRange:{start:u,end:u+d},yTarget:h instanceof so?h:void 0,slateParent:t,slateTarget:c,targetDelta:f}}function ta(e,t){for(var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=n.assoc,i=void 0===r?0:r,o=n.insert,a=void 0!==o&&o,s=0,u=0,c=0;c<e.children.length;c++){var l=e.children[c],d=ae.isText(l)?l.text.length:1;d>0&&(u=c);var f=s+d;if(d>0&&(i>=0?f>t:f>=t))return[c,t-s];s+=d}if(t>s+(a?1:0))throw new Error("yOffset out of bounds");if(a)return[e.children.length,0];var h=e.children[u];return[u,ae.isText(h)?h.text.length:1]}function na(e,t,n){for(var r=[n];r[0]!==e;){var i=r[0].parent;if(!i)throw new Error("yText isn't a descendant of root element");if(!(i instanceof so))throw new Error("Unexpected y parent type");r.unshift(i)}if(r.length<2)return[];var o=t;return r.reduce((function(e,t,n){var i=r[n+1];if(!i)return e;var a,s=0,u=k(qo(t));try{for(u.s();!(a=u.n()).done;){var c=a.value;if(c.insert===i)break;s+="string"==typeof c.insert?c.insert.length:1}}catch(d){u.e(d)}finally{u.f()}if(ae.isText(o))throw new Error("Cannot descent into slate text");var l=y(ta(o,s),1)[0];return o=o.children[l],e.concat(l)}),[])}function ra(e){if(!e.doc)throw new Error("shared type isn't attached to a document")}!0===Uo[Fo]&&console.error("Yjs was already imported. This breaks constructor checks and will lead to issues! - https://github.com/yjs/yjs/issues/438"),Uo[Fo]=!0;var ia="__slateYjsStoredPosition_";function oa(e,t,n){var r=ea(e,t,n.path),i=r.yTarget,o=r.yParent,a=r.textRange;if(i)throw new Error("Slate point points to a non-text element inside sharedRoot");var s=a.start+n.offset;return Or(o,s,s===a.end?-1:0)}function aa(e,t,n){if(!e.doc)throw new Error("sharedRoot isn't attach to a yDoc");var r=Lr(n,e.doc);return r&&function(e,t,n){var r=n.type,i=n.index,o=n.assoc;if(!(r instanceof so))throw new Error("Absolute position points to a non-XMLText");var a=na(e,t,r),s=se.get(t,a);if(ae.isText(s))throw new Error("Absolute position doesn't match slateRoot, cannot descent into text");var u=y(ta(s,i,{assoc:o}),2),c=u[0],l=u[1],d=s.children[c];return ae.isText(d)?{path:[].concat(p(a),[c]),offset:l}:null}(e,t,r)}function sa(e,t,n){e.setAttribute(ia+t,Ar(n))}function ua(e,t,n){return Object.fromEntries(Object.entries(e).filter((function(e){var r=y(e,2)[1];return r.type===t&&(!n||(r.assoc>=0?r.index>=n.start&&r.index<n.end:r.index>n.start&&r.index>=n.end))})))}function ca(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",r=M({},n,ua(e,t));return qo(t).forEach((function(t,i){var o=t.insert;o instanceof so&&Object.assign(r,ca(e,o,n?"".concat(n,".").concat(i):i.toString()))})),r}function la(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,i=function(e){return ra(e),Object.fromEntries(Object.entries(e.getAttributes()).filter((function(e){return y(e,1)[0].startsWith(ia)})).map((function(t){var n=y(t,2),r=n[0],i=n[1];return[r.slice(ia.length),Lr(Mr(i),e.doc)]})).filter((function(e){return y(e,2)[1]})))}(e),o={"":ua(i,t,{start:r,end:r+Wo(n)})};return n.forEach((function(e,t){var n=e.insert;n instanceof so&&Object.assign(o,ca(i,n,t.toString()))})),o}function da(e,t,n,r){var i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,a=arguments.length>6&&void 0!==arguments[6]?arguments[6]:"",s=n[a];s&&Object.entries(s).forEach((function(n){var r=y(n,2),a=r[0],s=r[1];sa(e,a,Or(t,s.index-o+i,s.assoc))})),r.forEach((function(t,r){var i=t.insert;i instanceof so&&da(e,i,n,qo(i),0,0,a?"".concat(a,".").concat(r):r.toString())}))}function fa(e,t,n){return{anchor:oa(e,t,n.anchor),focus:oa(e,t,n.focus)}}function ha(e,t,n){var r=aa(e,t,n.anchor);if(!r)return null;var i=aa(e,t,n.focus);return i?{anchor:r,focus:i}:null}function va(e,t,n){var r=n.target,i=n.changes,o=n.delta;if(!(r instanceof so))throw new Error("Unexpected target node type");var s=[],u=na(e,t,r),c=se.get(t,u);if(ae.isText(c))throw new Error("Cannot apply yTextEvent to text node");var l=Array.from(i.keys.entries());if(u.length>0&&l.length>0){var d=Object.fromEntries(l.map((function(e){var t=y(e,2),n=t[0];return[n,"delete"===t[1].action?null:r.getAttribute(n)]}))),f=Object.fromEntries(l.map((function(e){var t=y(e,1)[0];return[t,c[t]]})));s.push({type:"set_node",newProperties:d,properties:f,path:u})}return o.length>0&&s.push.apply(s,p(function(e,t,n){var r=[],i=n.reduce((function(e,t){return"retain"in t?e+t.retain:"delete"in t?e+t.delete:e}),0);return n.reverse().forEach((function(n){if("attributes"in n&&"retain"in n)for(var o=y(ta(e,i-n.retain),2),s=o[0],u=o[1],c=y(ta(e,i,{assoc:-1}),2),l=c[0],d=c[1],f=l;f>=s;f--){var h=e.children[f],v=[].concat(p(t),[f]);if(ae.isText(h)){var g=n.attributes,m=Vo.apply(void 0,[e].concat(p(Object.keys(n.attributes))));if(f===s||f===l){var w=f===s?u:0,k=f===l?d:h.text.length;if(k!==h.text.length&&r.push({type:"split_node",path:v,position:k,properties:Yo(h)}),0!==w){r.push({type:"split_node",path:v,position:w,properties:(b=a(a({},Yo(h)),g),Object.fromEntries(Object.entries(b).filter((function(e){return null!==y(e,2)[1]}))))});continue}}r.push({type:"set_node",newProperties:g,path:v,properties:m})}}var b;if("retain"in n&&(i-=n.retain),"delete"in n)for(var S=y(ta(e,i-n.delete),2),x=S[0],E=S[1],C=y(ta(e,i,{assoc:-1}),2),_=C[0],O=C[1],A=0===O?_-1:_;A>=x;A--){var M=e.children[A],L=[].concat(p(t),[A]);if(!ae.isText(M)||A!==x&&A!==_)r.push({type:"remove_node",node:M,path:L}),i-=Xo(M);else{var D=A===x?E:0,I=A===_?O:M.text.length;r.push({type:"remove_text",offset:D,text:M.text.slice(D,I),path:L}),i-=I-D}}else if("insert"in n){var R=y(ta(e,i,{insert:!0}),2),T=R[0],P=R[1],j=e.children[T],N=[].concat(p(t),[T]);if(ae.isText(j)){var U,F=r[r.length-1],H=null!=F&&"insert_node"===F.type?F.node:Yo(j),z=[];if(null==F||"insert_node"!==F.type&&"insert_text"!==F.type&&"split_node"!==F.type&&"set_node"!==F.type||(z=F.path),"string"==typeof n.insert&&Bo(null!==(U=n.attributes)&&void 0!==U?U:{},H)&&ue.equals(N,z))return r.push({type:"insert_text",offset:P,text:n.insert,path:N});var B=Zo(n);return 0===P?r.push({type:"insert_node",path:N,node:B}):(P<j.text.length&&r.push({type:"split_node",path:N,position:P,properties:Yo(j)}),r.push({type:"insert_node",path:ue.next(N),node:B}))}return r.push({type:"insert_node",path:N,node:Zo(n)})}})),r}(c,u,o))),s}function pa(e,t,n){ie.withoutNormalizing(t,(function(){n.forEach((function(n){(function(e,t,n){if(n instanceof eo)return va(e,t,n);throw new Error("Unexpected Y event type")})(e,t,n).forEach((function(e){t.apply(e)}))}))}))}function ga(e){return e.map((function(e){return"string"==typeof e.insert?e:a(a({},e),{},{insert:(t=e.insert,n=new so,r=t.getAttributes(),Object.entries(r).forEach((function(e){var t=y(e,2),r=t[0],i=t[1];n.setAttribute(r,i)})),n.applyDelta(ga(qo(t)),{sanitize:!1}),n)});var t,n,r}))}var ya={insert_node:function(e,t,n){var r=ea(e,t,n.path),i=r.yParent,o=r.textRange;if(ae.isText(n.node))return i.insert(o.start,n.node.text,Yo(n.node));i.insertEmbed(o.start,Qo(n.node))},remove_node:function(e,t,n){var r=ea(e,t,n.path),i=r.yParent,o=r.textRange;i.delete(o.start,o.end-o.start)},set_node:function(e,t,n){var r=ea(e,t,n.path),i=r.yTarget,o=r.textRange,s=r.yParent;if(i)return Object.entries(n.newProperties).forEach((function(e){var t=y(e,2),n=t[0],r=t[1];if(null===r)return i.removeAttribute(n);i.setAttribute(n,r)})),Object.entries(n.properties).forEach((function(e){var t=y(e,1)[0];n.newProperties.hasOwnProperty(t)||i.removeAttribute(t)}));var u=a(a({},Object.fromEntries(Object.keys(n.properties).map((function(e){return[e,null]})))),n.newProperties);s.format(o.start,o.end-o.start,u)},merge_node:function(e,t,n){var r=ea(e,t,n.path),i=ea(r.yParent,r.slateParent,ue.previous(n.path.slice(-1)));if(!r.yTarget!=!i.yTarget)throw new Error("Cannot merge y text with y element");if(!i.yTarget||!r.yTarget){var o=r.yParent,s=r.textRange,u=r.slateTarget;if(!u)throw new Error("Expected Slate target node for merge op.");var c=se.get(t,ue.previous(n.path));if(!ae.isText(c))throw new Error("Path points to Y.Text but not a Slate text node.");var l=Yo(u),d=Yo(c),f=Object.keys(l).reduce((function(e,t){return t in d?e:a(a({},e),{},M({},t,null))}),{});return o.format(s.start,s.end-s.start,a(a({},f),d))}var h=i.yTarget.length,v=qo(r.yTarget),g=ga(v),y=la(e,r.yTarget,v,h),m=[{retain:h}].concat(p(g));i.yTarget.applyDelta(m,{sanitize:!1}),r.yParent.delete(r.textRange.start,r.textRange.end-r.textRange.start),da(e,i.yTarget,y,g,h)},move_node:function(e,t,n){var r=ue.parent(n.newPath),i=n.newPath[n.newPath.length-1],o=se.get(t,r);if(ae.isText(o))throw new Error("Cannot move slate node into text element");var a=[].concat(p(r),[Math.min(i,o.children.length)]),s=ea(e,t,n.path),u=ea(e,t,a),c=ga(s.targetDelta),l=la(e,s.yParent,s.targetDelta);s.yParent.delete(s.textRange.start,s.textRange.end-s.textRange.start);var d=Wo(qo(u.yParent)),f=Math.min(u.textRange.start,d),h=[{retain:f}].concat(p(c));u.yParent.applyDelta(h,{sanitize:!1}),da(e,u.yParent,l,c,f,s.textRange.start)},split_node:function(e,t,n){var r=ea(e,t,n.path);if(!r.slateTarget)throw new Error("Y target without corresponding slate node");if(!r.yTarget){if(!ae.isText(r.slateTarget))throw new Error("Mismatch node type between y target and slate node");var i={};return r.targetDelta.forEach((function(e){e.attributes&&Object.keys(e.attributes).forEach((function(e){i[e]=null}))})),r.yParent.format(r.textRange.start,r.textRange.end-r.textRange.start,a(a({},i),n.properties))}if(ae.isText(r.slateTarget))throw new Error("Mismatch node type between y target and slate node");var o=ea(r.yTarget,r.slateTarget,[n.position]),s=r.slateTarget.children.slice(0,n.position).reduce((function(e,t){return e+Xo(t)}),0),u=r.slateTarget.children.reduce((function(e,t){return e+Xo(t)}),0),c=Ko(qo(r.yTarget),s,u-s),l=ga(c),d=la(e,r.yTarget,c,s),f=new so;f.applyDelta(l,{sanitize:!1}),Object.entries(n.properties).forEach((function(e){var t=y(e,2),n=t[0],r=t[1];f.setAttribute(n,r)})),r.yTarget.delete(o.textRange.start,r.yTarget.length-o.textRange.start),r.yParent.insertEmbed(r.textRange.end,f),da(e,f,d,l,0,s)}};var ma=a(a(a({},{insert_text:function(e,t,n){var r=ea(e,t,n.path),i=r.yParent,o=r.textRange,a=se.get(t,n.path);if(!ae.isText(a))throw new Error("Cannot insert text into non-text node");i.insert(o.start+n.offset,n.text,Yo(a))},remove_text:function(e,t,n){var r=ea(e,t,n.path),i=r.yParent,o=r.textRange;i.delete(o.start+n.offset,n.text.length)}}),ya),{},{set_selection:function(){}});var wa=Symbol("slate-yjs-operation"),ka=Symbol("slate-yjs-position-storage"),ba=new WeakMap,Sa=new WeakMap,xa=new WeakSet,Ea={isYjsEditor:function(e){return ie.isEditor(e)&&e.sharedRoot instanceof so&&"localOrigin"in e&&"positionStorageOrigin"in e&&"function"==typeof e.applyRemoteEvents&&"function"==typeof e.storeLocalChange&&"function"==typeof e.flushLocalChanges&&"function"==typeof e.isLocalOrigin&&"function"==typeof e.connect&&"function"==typeof e.disconnect},localChanges:function(e){var t;return null!==(t=Sa.get(e))&&void 0!==t?t:[]},applyRemoteEvents:function(e,t,n){e.applyRemoteEvents(t,n)},storeLocalChange:function(e,t){e.storeLocalChange(t)},flushLocalChanges:function(e){e.flushLocalChanges()},connected:function(e){return xa.has(e)},connect:function(e){e.connect()},disconnect:function(e){e.disconnect()},isLocal:function(e){return e.isLocalOrigin(Ea.origin(e))},origin:function(e){var t=ba.get(e);return void 0!==t?t:e.localOrigin},withOrigin:function(e,t,n){var r=Ea.origin(e);ba.set(e,t),n(),ba.set(e,r)},storePosition:function(e,t,n){var r,i=e.sharedRoot,o=e.positionStorageOrigin;ra(i);var a=oa(i,e,n);null===(r=i.doc)||void 0===r||r.transact((function(){sa(i,t,a)}),o)},removeStoredPosition:function(e,t){var n,r=e.sharedRoot,i=e.positionStorageOrigin;ra(r),null===(n=r.doc)||void 0===n||n.transact((function(){!function(e,t){e.removeAttribute(ia+t)}(r,t)}),i)},position:function(e,t){var n=function(e,t){var n=e.getAttribute(ia+t);return n?Mr(n):null}(e.sharedRoot,t);if(n)return aa(e.sharedRoot,e,n)},storedPositionsRelative:function(e){return t=e.sharedRoot,Object.fromEntries(Object.entries(t.getAttributes()).filter((function(e){return y(e,1)[0].startsWith(ia)})).map((function(e){var t,n,r=y(e,2),i=r[0],o=r[1];return[i.slice(ia.length),(t=o,new Er(null==t.type?null:wr(t.type.client,t.type.clock),null!==(n=t.tname)&&void 0!==n?n:null,null==t.item?null:wr(t.item.client,t.item.clock),null==t.assoc?0:t.assoc))]})));var t}};function Ca(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},i=r.localOrigin,o=r.positionStorageOrigin,a=r.autoConnect,s=void 0!==a&&a,u=e;u.sharedRoot=t,u.editorWindow=n,u.localOrigin=null!=i?i:wa,u.positionStorageOrigin=null!=o?o:ka,u.applyRemoteEvents=function(e,t){Ea.flushLocalChanges(u),ie.withoutNormalizing(u,(function(){Ea.withOrigin(u,t,(function(){pa(u.sharedRoot,u,e)}))}))},u.isLocalOrigin=function(e){return e===u.localOrigin};var c=function(e,t){u.isLocalOrigin(t.origin)||Ea.applyRemoteEvents(u,e,t.origin)},l=null;s&&(l=setTimeout((function(){l=null,Ea.connect(u)}))),u.connect=function(){if(Ea.connected(u))throw new Error("already connected");u.sharedRoot.observeDeep(c);var t=$o(u.sharedRoot);u.children=t.children,xa.add(u),ie.normalize(e,{force:!0}),e.operations.length||e.onChange()},u.disconnect=function(){l&&clearTimeout(l),Ea.flushLocalChanges(u),u.sharedRoot.unobserveDeep(c),xa.delete(u)},u.storeLocalChange=function(t){Sa.set(u,[].concat(p(Ea.localChanges(u)),[{op:t,doc:e.children,origin:Ea.origin(u)}]))},u.flushLocalChanges=function(){ra(u.sharedRoot);var e=Ea.localChanges(u);Sa.delete(u);var t=[];e.forEach((function(e){var n=t[t.length-1];if(n&&n[0].origin===e.origin)return n.push(e);t.push([e])})),t.forEach((function(e){var t;ra(u.sharedRoot),null===(t=u.sharedRoot.doc)||void 0===t||t.transact((function(){e.forEach((function(e){ra(u.sharedRoot),function(e,t,n){var r=ma[n.type];if(!r)throw new Error("Unknown operation: ".concat(n.type));r(e,t,n)}(u.sharedRoot,{children:e.doc},e.op)}))}),e[0].origin)}))};var d=u.apply,f=u.onChange;return u.apply=function(e){Ea.connected(u)&&Ea.isLocal(u)&&Ea.storeLocalChange(u,e),d(e)},u.onChange=function(){Ea.connected(u)&&Ea.flushLocalChanges(u),f()},u}var _a=new WeakMap,Oa=Symbol("slate-yjs-history-without-saving");function Aa(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=n.withoutSavingOrigin,o=void 0===r?Oa:r,s=n.trackedOrigins,u=void 0===s?new Set([e.localOrigin]):s,c=i(n,t),l=e,d=new Xr(l.sharedRoot,a({trackedOrigins:u},c));l.undoManager=d,l.withoutSavingOrigin=o;var f=l.onChange,h=l.isLocalOrigin;l.onChange=function(){f(),_a.set(l,l.selection&&fa(l.sharedRoot,l,l.selection))},l.isLocalOrigin=function(e){return e===l.withoutSavingOrigin||h(e)};var v=function(e){var t=e.stackItem;t.meta.set("selection",l.selection&&fa(l.sharedRoot,l,l.selection)),t.meta.set("selectionBefore",_a.get(l))},p=function(e){e.stackItem.meta.set("selection",l.selection&&fa(l.sharedRoot,l,l.selection))},g=function(e){var t=e.stackItem,n="undo"===e.type?l.undoManager.redoStack:l.undoManager.undoStack,r=n[n.length-1];r&&(r.meta.set("selection",t.meta.get("selectionBefore")),r.meta.set("selectionBefore",t.meta.get("selection")));var i=t.meta.get("selectionBefore");if(i){var o=ha(l.sharedRoot,l,i);o&&ce.select(l,o)}},y=l.connect,m=l.disconnect;return l.connect=function(){y(),l.undoManager.on("stack-item-added",v),l.undoManager.on("stack-item-popped",g),l.undoManager.on("stack-item-updated",p)},l.disconnect=function(){l.undoManager.off("stack-item-added",v),l.undoManager.off("stack-item-popped",g),l.undoManager.off("stack-item-updated",p),m()},l.undo=function(){Ea.connected(l)&&(Ea.flushLocalChanges(l),l.undoManager.undo())},l.redo=function(){Ea.connected(l)&&(Ea.flushLocalChanges(l),l.undoManager.redo())},l}var Ma=new WeakMap,La=new ye,Da=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.selection;e.sendCursorPosition(t)},Ia=function(e,t){e.sendCursorData(t)},Ra=function(e,t,n){var r;if("change"===t){var i=null!==(r=Ma.get(e))&&void 0!==r?r:new Set;i.add(n),Ma.set(e,i)}},Ta=function(e,t,n){if("change"===t){var r=Ma.get(e);r&&r.delete(n)}},Pa=function(e,t){var n;if(t===e.awareness.clientID||!Ea.connected(e))return null;var r=e.awareness.getStates().get(t);return r?{relativeSelection:null!==(n=r[e.selectionStateField])&&void 0!==n?n:null,data:r[e.cursorDataField],clientId:t}:null},ja=function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];La.emit.apply(La,[e].concat(n))},Na=function(e,t){La.on(e,t)},Ua=function(){La.reset()};function Fa(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=n.cursorStateField,i=void 0===r?"selection":r,o=n.cursorDataField,a=void 0===o?"data":o,s=n.autoSend,u=void 0===s||s,c=n.data,l=e;l.awareness=t,l.cursorDataField=a,l.selectionStateField=i,l.sendCursorData=function(e){l.awareness.setLocalStateField(l.cursorDataField,e)},l.sendCursorPosition=function(e){var t=l.awareness.getLocalState(),n=null==t?void 0:t[i];if(e){var r=fa(l.sharedRoot,l,e),o=r.anchor,a=r.focus;n&&Dr(o,n)&&Dr(a,n)||l.awareness.setLocalStateField(l.selectionStateField,{anchor:o,focus:a})}else n&&l.awareness.setLocalStateField(l.selectionStateField,null)};var d=function(e){var t=Ma.get(l);if(t){var n=l.awareness.clientID,r={added:e.added.filter((function(e){return e!==n})),removed:e.removed.filter((function(e){return e!==n})),updated:e.updated.filter((function(e){return e!==n}))};(r.added.length>0||r.removed.length>0||r.updated.length>0)&&t.forEach((function(e){return e(r)}))}},f=l.connect,h=l.disconnect;return l.connect=function(){if(f(),l.awareness.on("change",d),d({removed:[],added:Array.from(l.awareness.getStates().keys()),updated:[]}),u){c&&Ia(l,c);var e=l.onChange;l.onChange=function(){e(),Ea.connected(l)&&(Da(l),ja("updateCursor"))}}},l.disconnect=function(){l.awareness.off("change",d),Ua(),d({removed:Array.from(l.awareness.getStates().keys()),added:[],updated:[]}),h()},l}function Ha(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function za(e){var t=Ha(e);return new RegExp("(".concat(t,").+?(").concat(t,")$"))}function Ba(e){var t=Ha(e);return new RegExp("^(".concat(t,")$"))}function Va(e){return function(t,n){ce.setNodes(t,{type:e},{match:function(e){return ie.isBlock(t,e)},at:n})}}function qa(e){return function(t,n){ce.insertNodes(t,{text:" "},{match:ae.isText,at:le.end(n),select:!0}),ce.setNodes(t,M({},e,!0),{match:ae.isText,at:n,split:!0})}}var Ja,Wa=[{trigger:Ba("#"),apply:Va("heading-one")},{trigger:Ba("##"),apply:Va("heading-two")},{trigger:Ba(">"),apply:Va("block-quote")},{trigger:za("`"),apply:(Ja="inline-code",function(e,t){var n=ie.rangeRef(e,t);ce.unwrapNodes(e,{at:t,match:function(t){return ie.isInline(e,t)},mode:"all",split:!0}),n.current&&ce.insertNodes(e,{text:" "},{match:ae.isText,at:le.end(n.current),select:!0});var r=n.unref();r&&ce.wrapNodes(e,{type:Ja,children:[]},{at:r,split:!0})})},{trigger:za("**"),apply:qa("bold")},{trigger:za("__"),apply:qa("bold")},{trigger:za("*"),apply:qa("italic")},{trigger:za("_"),apply:qa("italic")},{trigger:za("~~"),apply:qa("strikethrough")}];function Ka(e,t,n){if(t.offset>=n)return{offset:t.offset-n,path:t.path};var r=ie.previous(e,{at:t.path,match:ae.isText});if(r){var i=y(r,2),o=i[0],a=i[1];return Ka(e,{offset:o.text.length,path:a},n-t.offset)}}function Ya(e){var t=e.deleteBackward,n=e.insertText,r=e.isInline;return e.insertText=function(t){var r=e.selection;if(" "!==t||!r||!le.isCollapsed(r))return n(t);for(var i,o=r.anchor,a=ie.above(e,{match:function(t){return ie.isBlock(e,t)}}),s=a?a[1]:[],u={anchor:o,focus:ie.start(e,s)},c=ie.string(e,u),l=function(){var t=f[d],n=t.trigger,r=t.apply,i=n.exec(c);if(!i)return 0;var a=y(i,3),s=a[0],u=a[1],l=a[2];return ie.withoutNormalizing(e,(function(){var t=o,n=l&&Ka(e,t,l.length),i=u&&Ka(e,t,s.length-u.length),a=Ka(e,t,s.length);if(t&&a){var c=ie.rangeRef(e,{anchor:a,focus:t});n&&ce.delete(e,{at:{anchor:n,focus:t}}),i&&ce.delete(e,{at:{anchor:a,focus:i}});var d=c.unref();d&&r(e,d)}})),{v:void 0}},d=0,f=Wa;d<f.length;d++)if(0!==(i=l())&&i)return i.v;n(t)},e.insertBreak=function(){var t=e.selection;if(t){var n=ie.above(e,{match:function(t){return ie.isBlock(e,t)}}),r=n?n[1]:[],i=ie.end(e,r),o=de.equals(i,le.end(t));if(ce.splitNodes(e,{always:!0}),o){var a;ce.unwrapNodes(e,{match:function(t){return ie.isInline(e,t)},mode:"all"}),ce.setNodes(e,{type:"paragraph"},{match:function(t){return ie.isBlock(e,t)}});var s=null!==(a=ie.marks(e))&&void 0!==a?a:{};ce.unsetNodes(e,Object.keys(s),{match:ae.isText})}}},e.deleteBackward=function(){var n=e.selection;if(n&&le.isCollapsed(n)){var r=ie.above(e,{match:function(t){return ie.isBlock(e,t)}});if(r){var i=y(r,2),o=i[0],a=i[1],s=ie.start(e,a);if(!ie.isEditor(o)&&oe.isElement(o)&&"paragraph"!==o.type&&de.equals(n.anchor,s)){return void ce.setNodes(e,{type:"paragraph"})}}t.apply(void 0,arguments)}},e.isInline=function(e){return oe.isElement(e)&&"inline-code"===e.type||r(e)},e}function $a(e){var t=e.normalizeNode;return e.normalizeNode=function(n){var r=y(n,1)[0];if(!ie.isEditor(r)||r.children.length>0)return t(n);ce.insertNodes(e,{type:"paragraph",children:[{text:""}]},{at:[0]})},e}var Za=function(){function e(){_(this,e)}return A(e,null,[{key:"getThemeVar",value:function(){var e=document.documentElement;return e?getComputedStyle(e).getPropertyValue("--ibiz-color-primary"):null}},{key:"isChineseCharacter",value:function(e){return/[\u4e00-\u9fa5]/.test(e)}},{key:"hasChineseAndEnglish",value:function(e){return/[\u4e00-\u9fa5]+.*[a-zA-Z]+|[a-zA-Z]+.*[\u4e00-\u9fa5]+/.test(e)}},{key:"stringToHexColor",value:function(e){if(!e)return"";for(var t=0,n=0;n<e.length;n++){if(this.isChineseCharacter(e))t=e.charCodeAt(n)+((t<<5)-t),t&=t;else t+=e.charCodeAt(n).toString(16)}var r=String(t).substring(0,6),i=parseInt(r.substring(0,2),16),o=parseInt(r.substring(2,4),16),a=parseInt(r.substring(4,6),16);i<0&&(i=10),o<0&&(o=10),a<0&&(a=10);var s="#".concat(i.toString(16).padStart(2,"0")).concat(o.toString(16).padStart(2,"0")).concat(a.toString(16).padStart(2,"0"));return"#FFFFFF"===s&&this.getThemeVar()||s}},{key:"avatarName",value:function(e){if(e&&e.toString().length<2)return e;if(e&&e.toString().length>=2){if(this.hasChineseAndEnglish(e)){var t=e.split("").find((function(e){return/[a-zA-Z]/.test(e)}))||"",n=e.split("").find((function(e){return/[\u4E00-\u9FA5]/.test(e)}))||"";return"".concat(t).concat(n).toLowerCase()}return/[a-zA-Z]/.test(e)?e.split("").filter((function(e){return/[a-zA-Z]/.test(e)})).slice(0,2).join("").toUpperCase():/[\u4E00-\u9FA5]/.test(e)?e.split("").filter((function(e){return/[\u4E00-\u9FA5]/.test(e)})).slice(-2).join(""):e.replaceAll(" ","").substring(0,2)}}},{key:"getEmojiCustomHtml",value:function(e){return e.replaceAll(/{"emoji":"(.+?)"}/g,(function(e,t){var n=decodeURIComponent(atob(t));return'<span class="emoji-tag">'.concat(n,"</span>")})).replaceAll(/<span data-w-e-type="emoji" class='emoji'>(.+?)<\/span>/g,(function(e,t){var n=decodeURIComponent(atob(t));return"<span data-w-e-type=\"emoji\" class='emoji'>".concat(n,"</span>")}))}}]),e}();var Ga=globalThis.Text,Qa=function(e){var t,n;return null!==(t=null==e||null===(n=e.ownerDocument)||void 0===n?void 0:n.defaultView)&&void 0!==t?t:null},Xa=function(e){return function(e){var t=Qa(e);return!!t&&e instanceof t.Node}(e)&&1===e.nodeType};function es(e,t){var n,r=y(ie.node(e,t.path),1)[0],i=e.toDOMNode(r);ie.void(e,{at:t})&&(t={path:t.path,offset:0});for(var o=Array.from(i.querySelectorAll("[data-slate-string], [data-slate-zero-width]")),a=0,s=0;s<o.length;s++){var u=o[s],c=u.childNodes[0];if(null!=c&&null!=c.textContent){var l=c.textContent.length,d=u.getAttribute("data-slate-length"),f=a+(null==d?l:parseInt(d,10)),h=o[s+1];if(t.offset===f&&null!=h&&h.hasAttribute("data-slate-mark-placeholder")){var v,p=h.childNodes[0];n=[p instanceof Ga?p:h,null!==(v=h.textContent)&&void 0!==v&&v.startsWith("\ufeff")?1:0];break}if(t.offset<=f){n=[c,Math.min(l,Math.max(0,t.offset-a))];break}a=f}}if(!n)throw new Error("Cannot resolve a DOM point from Slate point: ".concat(JSON.stringify(t)));return n}function ts(e,t){try{return function(e,t){var n=t.anchor,r=t.focus,i=le.isBackward(t),o=es(e,n),a=le.isCollapsed(t)?o:es(e,r),s=e.editorWindow.document.createRange(),u=y(i?a:o,2),c=u[0],l=u[1],d=y(i?o:a,2),f=d[0],h=d[1],v=!!(Xa(c)?c:c.parentElement).getAttribute("data-slate-zero-width"),p=!!(Xa(f)?f:f.parentElement).getAttribute("data-slate-zero-width");return s.setStart(c,v?1:l),s.setEnd(f,p?1:h),s}(e,t)}catch(Lc){return null}}var ns=new WeakMap;function rs(e,t){if(!t.relativeSelection||!e)return null;var n=ns.get(e.children);n||(n=new WeakMap,ns.set(e.children,n));var r=n.get(t);if(void 0===r)try{r=ha(e.sharedRoot,e,t.relativeSelection),n.set(t,r)}catch(Lc){return null}return r}var is=c({name:"CursorCaret",props:{data:{type:Object,required:!0},caretPosition:Object},setup:function(e){return{ns:Q("cursor-caret"),caretStyle:P((function(){return a(a({},e.caretPosition),{},{background:e.data.color})})),labelStyle:P((function(){return{transform:"translateY(-100%)",background:e.data.color}}))}},render:function(){return I("div",{style:this.caretStyle,class:this.ns.b()},[I("div",{class:this.ns.e("text"),style:this.labelStyle},[this.data.name])])}}),os=c({name:"CursorSelection",props:{data:Object,selectionRects:Array,caretPosition:Object},setup:function(e){return{ns:Q("cursor-selection"),selectionStyle:P((function(){return{backgroundColor:(t=e.data.color,n=.5,t+Math.round(255*Math.min(Math.max(n,0),1)).toString(16).toUpperCase())};var t,n}))}},render:function(){var e,t=this;return this.data?I(j,null,[null===(e=this.selectionRects)||void 0===e?void 0:e.map((function(e,n){return I("div",{style:a(a({},t.selectionStyle),e),class:t.ns.b(),key:n},null)})),this.caretPosition&&I(is,{caretPosition:this.caretPosition,data:this.data},null)]):null}});var as=Object.freeze([]);function ss(e){var t,n=e.slateYjs,r=e.containerRef,i=e.shouldGenerateOverlay,o=!("refreshOnResize"in e)||(null===(t=e.refreshOnResize)||void 0===t||t),s=new Map,u=f({}),c=function(){var e,t,o;if((!r||r.value)&&n.yjsEditor){var a=null==r||null===(e=r.value)||void 0===e?void 0:e.getBoundingClientRect(),c=null!==(t=null==a?void 0:a.x)&&void 0!==t?t:0,l=null!==(o=null==a?void 0:a.y)&&void 0!==o?o:0,d=Object.keys(u.value).length!==Object.keys(n.cursorStates).length,f=Object.fromEntries(Object.entries(n.cursorStates).map((function(e){var t=y(e,2),r=t[0],o=t[1],a=o.relativeSelection&&rs(n.yjsEditor,o);if(!a)return[r,as];var u=s.get(a);if(u)return[r,u];var f=function(e,t,n){var r=n.yOffset,i=n.xOffset,o=n.shouldGenerateOverlay,a=y(le.edges(t),2),s=a[0],u=a[1],c=ts(e,t);if(!c)return{caretPosition:null,selectionRects:[]};var l,d=[],f=ie.nodes(e,{at:t,match:function(e,t){return ae.isText(e)&&(!o||o(e,t))}}),h=null,v=le.isBackward(t),p=k(f);try{for(p.s();!(l=p.n()).done;){var g=y(l.value,2),m=g[0],w=g[1],b=e.toDOMNode(m),S=ue.equals(w,s.path),x=ue.equals(w,u.path),E=null;if(S||x){var C=document.createRange();C.selectNode(b),S&&C.setStart(c.startContainer,c.startOffset),x&&C.setEnd(c.endContainer,c.endOffset),E=C.getClientRects()}else E=b.getClientRects();for(var _=v?S:x,O=0;O<E.length;O++){var A=E.item(O);if(A){var M=_&&(v?0===O:O===E.length-1),L=A.top-r,D=A.left-i;M&&(h={height:"".concat(A.height,"px"),top:"".concat(L,"px"),left:"".concat(D+(v||le.isCollapsed(t)?0:A.width),"px")}),d.push({width:"".concat(A.width,"px"),height:"".concat(A.height,"px"),top:"".concat(L,"px"),left:"".concat(D,"px")})}}}}catch(I){p.e(I)}finally{p.f()}return{selectionRects:d,caretPosition:h}}(n.yjsEditor,a,{xOffset:c,yOffset:l,shouldGenerateOverlay:i});return d=!0,s.set(a,f),[r,f]})));d&&(u.value=f)}},l=function(){s.clear(),c()};return o&&function(e,t){var n=null;L((function(){e.value&&(n=new ResizeObserver((function(){t()}))).observe(e.value)})),N((function(){n&&e.value&&n.unobserve(e.value)}))}(r,l),Na("updateCursor",ke(c,0)),E((function(){return n.cursorStates}),(function(){return c()}),{deep:!0,immediate:!0}),{overlayData:P((function(){return Object.entries(n.cursorStates).map((function(e){var t,r,i=y(e,2),o=i[0],s=i[1],c=s.relativeSelection&&rs(n.yjsEditor,s),l=u.value[o];return a(a({},s),{},{range:c,caretPosition:null!==(t=null==l?void 0:l.caretPosition)&&void 0!==t?t:null,selectionRects:null!==(r=null==l?void 0:l.selectionRects)&&void 0!==r?r:as})}))})),refresh:l}}var us=c({name:"CursorOverlay",props:{slateYjs:{type:Object,required:!0}},setup:function(e){var t=Q("cursor-overlay"),n=f();return{ns:t,overlayData:ss({slateYjs:e.slateYjs,containerRef:n}).overlayData,containerRef:n}},render:function(){var e,t;return I("div",{class:this.ns.b(),ref:"containerRef"},[null===(e=(t=this.$slots).default)||void 0===e?void 0:e.call(t),this.overlayData.map((function(e){return I(os,U({key:e.clientId},e),null)}))])}}),cs=function(){function e(t,n,r,i){_(this,e),M(this,"collaborateUrl","/portal/collaborate"),M(this,"readyState",void 0),M(this,"evt",new ye),M(this,"client",void 0),M(this,"options",{connectTimeout:6e3,clientId:ge(),username:"",password:"",keepalive:60,clean:!0}),this.id=t,this.mqttTopic=n,this.token=r,this.appId=i,this.options.username=n,this.options.password=r,this.readyState=0}var t;return A(e,[{key:"send",value:function(e){ibiz.net.post("".concat(this.collaborateUrl,"/ROOM/").concat(this.id),{data:e})}},{key:"connect",value:(t=C(x().mark((function e(){var t,n,r,i,a=this;return x().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,o.import("./mqtt.min.legacy.js").then((function(e){return e.m}));case 2:t=e.sent,n=t.default?t.default:t,r=window,i=r.location,this.client=n.connect("ws://".concat(i.host).concat(ibiz.env.baseUrl,"/").concat(this.appId).concat(ibiz.env.mqttUrl),this.options),this.client.on("connect",(function(){a.client.subscribe(a.mqttTopic),a.readyState=1,a.evt.emit("connect"),ibiz.log.debug("collaborate connect")})),this.client.on("error",(function(e){a.readyState=3,a.evt.emit("error",e),ibiz.log.debug("collaborate error")})),this.client.on("message",(function(e,t){var n=JSON.parse(t.toString());n&&n.data&&n.data.data&&n.data.data.data&&a.evt.emit("message",new Uint8Array(Object.values(n.data.data.data))),ibiz.log.debug("collaborate message")})),this.client.on("reconnect",(function(){a.readyState=0,a.evt.emit("reconnect")})),this.client.on("close",(function(){a.readyState=3,a.evt.emit("close"),ibiz.log.debug("collaborate close")}));case 11:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{key:"close",value:function(){var e;null===(e=this.client)||void 0===e||e.end(),this.evt.reset()}}]),e}(),ls=function(){return new Map},ds=function(e,t,n){var r=e.get(t);return void 0===r&&e.set(t,r=n()),r},fs=String.fromCharCode,hs=/^\s*/g,vs=/([A-Z])/g,ps=function(e,t){return function(e){return e.replace(hs,"")}(e.replace(vs,(function(e){return"".concat(t).concat(function(e){return e.toLowerCase()}(e))})))},gs="undefined"!=typeof TextEncoder?new TextEncoder:null,ys=gs?function(e){return gs.encode(e)}:function(e){for(var t=unescape(encodeURIComponent(e)),n=t.length,r=new Uint8Array(n),i=0;i<n;i++)r[i]=t.codePointAt(i);return r},ms="undefined"==typeof TextDecoder?null:new TextDecoder("utf-8",{fatal:!0,ignoreBOM:!0});ms&&1===ms.decode(new Uint8Array).length&&(ms=null);var ws=function(e){return void 0===e?null:e},ks=new(function(){function e(){_(this,e),this.map=new Map}return A(e,[{key:"setItem",value:function(e,t){this.map.set(e,t)}},{key:"getItem",value:function(e){return this.map.get(e)}}]),e}()),bs=!0;try{"undefined"!=typeof localStorage&&(ks=localStorage,bs=!1)}catch(Lc){}var Ss,xs,Es=ks,Cs="undefined"!=typeof process&&process.release&&/node|io\.js/.test(process.release.name),_s="undefined"!=typeof window&&!Cs,Os=function(e){return function(){if(void 0===Ss)if(Cs){Ss=ls();for(var e=process.argv,t=null,n=0;n<e.length;n++){var r=e[n];"-"===r[0]?(null!==t&&Ss.set(t,""),t=r):null!==t&&(Ss.set(t,r),t=null)}null!==t&&Ss.set(t,"")}else"object"===("undefined"==typeof location?"undefined":v(location))?(Ss=ls(),(location.search||"?").slice(1).split("&").forEach((function(e){if(0!==e.length){var t=y(e.split("="),2),n=t[0],r=t[1];Ss.set("--".concat(ps(n,"-")),r),Ss.set("-".concat(ps(n,"-")),r)}}))):Ss=ls();return Ss}().has(e)};Os("--"+(xs="production"))||function(e){ws(Cs?process.env[e.toUpperCase()]:Es.getItem(e))}(xs);var As=Math.floor,Ms=function(e,t){return e<t?e:t},Ls=Math.pow,Ds=127,Is=Number.MAX_SAFE_INTEGER,Rs=A((function e(){_(this,e),this.cpos=0,this.cbuf=new Uint8Array(100),this.bufs=[]})),Ts=function(){return new Rs},Ps=function(e){for(var t=e.cpos,n=0;n<e.bufs.length;n++)t+=e.bufs[n].length;return t},js=function(e){for(var t=new Uint8Array(Ps(e)),n=0,r=0;r<e.bufs.length;r++){var i=e.bufs[r];t.set(i,n),n+=i.length}return t.set($s(e.cbuf.buffer,0,e.cpos),n),t},Ns=function(e,t){var n=e.cbuf.length;e.cpos===n&&(e.bufs.push(e.cbuf),e.cbuf=new Uint8Array(2*n),e.cpos=0),e.cbuf[e.cpos++]=t},Us=function(e,t){for(;t>Ds;)Ns(e,128|Ds&t),t=As(t/128);Ns(e,Ds&t)},Fs=new Uint8Array(3e4),Hs=Fs.length/3,zs=gs?function(e,t){if(t.length<Hs){var n=gs.encodeInto(t,Fs).written||0;Us(e,n);for(var r=0;r<n;r++)Ns(e,Fs[r])}else Bs(e,ys(t))}:function(e,t){var n=unescape(encodeURIComponent(t)),r=n.length;Us(e,r);for(var i=0;i<r;i++)Ns(e,n.codePointAt(i))},Bs=function(e,t){Us(e,t.byteLength),function(e,t){var n,r,i=e.cbuf.length,o=e.cpos,a=Ms(i-o,t.length),s=t.length-a;e.cbuf.set(t.subarray(0,a),o),e.cpos+=a,s>0&&(e.bufs.push(e.cbuf),e.cbuf=new Uint8Array((n=2*i)>(r=s)?n:r),e.cbuf.set(t.subarray(a)),e.cpos=s)}(e,t)},Vs=A((function e(t){_(this,e),this.arr=t,this.pos=0})),qs=function(e){return new Vs(e)},Js=function(e){return function(e,t){var n=$s(e.arr.buffer,e.pos+e.arr.byteOffset,t);return e.pos+=t,n}(e,Ks(e))},Ws=function(e){return e.arr[e.pos++]},Ks=function(e){for(var t=0,n=1;;){var r=e.arr[e.pos++];if(t+=(r&Ds)*n,n*=128,r<128)return t;if(t>Is)throw new Error("Integer out of range!")}},Ys=ms?function(e){return ms.decode(Js(e))}:function(e){var t=Ks(e);if(0===t)return"";var n=String.fromCodePoint(Ws(e));if(--t<100)for(;t--;)n+=String.fromCodePoint(Ws(e));else for(;t>0;){var r=t<1e4?t:1e4,i=e.arr.subarray(e.pos,e.pos+r);e.pos+=r,n+=String.fromCodePoint.apply(null,i),t-=r}return decodeURIComponent(escape(n))},$s=function(e,t,n){return new Uint8Array(e,t,n)},Zs=_s?function(e){for(var t="",n=0;n<e.byteLength;n++)t+=fs(e[n]);return btoa(t)}:function(e){return Buffer.from(e.buffer,e.byteOffset,e.byteLength).toString("base64")},Gs=_s?function(e){for(var t,n=atob(e),r=(t=n.length,new Uint8Array(t)),i=0;i<n.length;i++)r[i]=n.charCodeAt(i);return r}:function(e){var t=Buffer.from(e,"base64");return new Uint8Array(t.buffer,t.byteOffset,t.byteLength)},Qs=new Map,Xs="undefined"==typeof BroadcastChannel?function(){function e(t){var n,r=this;_(this,e),this.room=t,this.onmessage=null,n=function(e){return e.key===t&&null!==r.onmessage&&r.onmessage({data:Gs(e.newValue||"")})},bs||addEventListener("storage",n)}return A(e,[{key:"postMessage",value:function(e){Es.setItem(this.room,Zs(new Uint8Array(e)))}}]),e}():BroadcastChannel,eu=function(e){return ds(Qs,e,(function(){var t=new Set,n=new Xs(e);return n.onmessage=function(e){return t.forEach((function(t){return t(e.data,"broadcastchannel")}))},{bc:n,subs:t}}))},tu=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,r=eu(e);r.bc.postMessage(t),r.subs.forEach((function(e){return e(t,n)}))},nu=Date.now,ru=function(e,t){Us(e,0);var n=function(e){return dr(e,new tr)}(t);Bs(e,n)},iu=function(e,t,n){Us(e,1),Bs(e,function(e,t){return ur(e,t,new nr)}(t,n))},ou=function(e,t,n){try{!function(e,t,n){sr(e,t,n,Xn)}(t,Js(e),n)}catch(r){console.error("Caught error while handling a Yjs update",r)}},au=ou,su=function(e,t,n,r){var i=Ks(e);switch(i){case 0:!function(e,t,n){iu(t,n,Js(e))}(e,t,n);break;case 1:ou(e,n,r);break;case 2:au(e,n,r);break;default:throw new Error("Unknown message type")}return i},uu=function(){return new Set},cu=Array.from,lu=function(){function e(){_(this,e),this._observers=ls()}return A(e,[{key:"on",value:function(e,t){ds(this._observers,e,uu).add(t)}},{key:"once",value:function(e,t){var n=this;this.on(e,(function r(){n.off(e,r),t.apply(void 0,arguments)}))}},{key:"off",value:function(e,t){var n=this._observers.get(e);void 0!==n&&(n.delete(t),0===n.size&&this._observers.delete(e))}},{key:"emit",value:function(e,t){return cu((this._observers.get(e)||ls()).values()).forEach((function(e){return e.apply(void 0,p(t))}))}},{key:"destroy",value:function(){this._observers=ls()}}]),e}(),du=Object.keys,fu=function(e){return du(e).length},hu=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},vu=function e(t,n){if(null==t||null==n)return function(e,t){return e===t}(t,n);if(t.constructor!==n.constructor)return!1;if(t===n)return!0;switch(t.constructor){case ArrayBuffer:t=new Uint8Array(t),n=new Uint8Array(n);case Uint8Array:if(t.byteLength!==n.byteLength)return!1;for(var r=0;r<t.length;r++)if(t[r]!==n[r])return!1;break;case Set:if(t.size!==n.size)return!1;var i,o=k(t);try{for(o.s();!(i=o.n()).done;){var a=i.value;if(!n.has(a))return!1}}catch(f){o.e(f)}finally{o.f()}break;case Map:if(t.size!==n.size)return!1;var s,u=k(t.keys());try{for(u.s();!(s=u.n()).done;){var c=s.value;if(!n.has(c)||!e(t.get(c),n.get(c)))return!1}}catch(f){u.e(f)}finally{u.f()}break;case Object:if(fu(t)!==fu(n))return!1;for(var l in t)if(!hu(t,l)||!e(t[l],n[l]))return!1;break;case Array:if(t.length!==n.length)return!1;for(var d=0;d<t.length;d++)if(!e(t[d],n[d]))return!1;break;default:return!1}return!0},pu=3e4,gu=function(e){u(n,e);var t=l(n);function n(e){var r;return _(this,n),(r=t.call(this)).doc=e,r.clientID=e.clientID,r.states=new Map,r.meta=new Map,r._checkInterval=setInterval((function(){var e=nu();null!==r.getLocalState()&&15e3<=e-r.meta.get(r.clientID).lastUpdated&&r.setLocalState(r.getLocalState());var t=[];r.meta.forEach((function(n,i){i!==r.clientID&&pu<=e-n.lastUpdated&&r.states.has(i)&&t.push(i)})),t.length>0&&yu(d(r),t,"timeout")}),As(3e3)),e.on("destroy",(function(){r.destroy()})),r.setLocalState({}),r}return A(n,[{key:"destroy",value:function(){this.emit("destroy",[this]),this.setLocalState(null),s(h(n.prototype),"destroy",this).call(this),clearInterval(this._checkInterval)}},{key:"getLocalState",value:function(){return this.states.get(this.clientID)||null}},{key:"setLocalState",value:function(e){var t=this.clientID,n=this.meta.get(t),r=void 0===n?0:n.clock+1,i=this.states.get(t);null===e?this.states.delete(t):this.states.set(t,e),this.meta.set(t,{clock:r,lastUpdated:nu()});var o=[],a=[],s=[],u=[];null===e?u.push(t):null==i?null!=e&&o.push(t):(a.push(t),vu(i,e)||s.push(t)),(o.length>0||s.length>0||u.length>0)&&this.emit("change",[{added:o,updated:s,removed:u},"local"]),this.emit("update",[{added:o,updated:a,removed:u},"local"])}},{key:"setLocalStateField",value:function(e,t){var n=this.getLocalState();null!==n&&this.setLocalState(a(a({},n),{},M({},e,t)))}},{key:"getStates",value:function(){return this.states}}]),n}(lu),yu=function(e,t,n){for(var r=[],i=0;i<t.length;i++){var o=t[i];if(e.states.has(o)){if(e.states.delete(o),o===e.clientID){var a=e.meta.get(o);e.meta.set(o,{clock:a.clock+1,lastUpdated:nu()})}r.push(o)}}r.length>0&&(e.emit("change",[{added:[],updated:[],removed:r},n]),e.emit("update",[{added:[],updated:[],removed:r},n]))},mu=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e.states,r=t.length,i=Ts();Us(i,r);for(var o=0;o<r;o++){var a=t[o],s=n.get(a)||null,u=e.meta.get(a).clock;Us(i,a),Us(i,u),zs(i,JSON.stringify(s))}return js(i)},wu=[];wu[0]=function(e,t,n,r,i){Us(e,0);var o=su(t,e,n.doc,n);r&&1===o&&!n.synced&&(n.synced=!0)},wu[3]=function(e,t,n,r,i){Us(e,1),Bs(e,mu(n.awareness,Array.from(n.awareness.getStates().keys())))},wu[1]=function(e,t,n,r,i){!function(e,t,n){for(var r=qs(t),i=nu(),o=[],a=[],s=[],u=[],c=Ks(r),l=0;l<c;l++){var d=Ks(r),f=Ks(r),h=JSON.parse(Ys(r)),v=e.meta.get(d),p=e.states.get(d),g=void 0===v?0:v.clock;(g<f||g===f&&null===h&&e.states.has(d))&&(null===h?d===e.clientID&&null!=e.getLocalState()?f++:e.states.delete(d):e.states.set(d,h),e.meta.set(d,{clock:f,lastUpdated:i}),void 0===v&&null!==h?o.push(d):void 0!==v&&null===h?u.push(d):null!==h&&(vu(h,p)||s.push(d),a.push(d)))}(o.length>0||s.length>0||u.length>0)&&e.emit("change",[{added:o,updated:s,removed:u},n]),(o.length>0||a.length>0||u.length>0)&&e.emit("update",[{added:o,updated:a,removed:u},n])}(n.awareness,Js(t),n)},wu[2]=function(e,t,n,r,i){!function(e,t,n){0===Ks(e)&&n(t,Ys(e))}(t,n.doc,(function(e,t){return ku(n,t)}))};var ku=function(e,t){return console.warn("Permission denied to access ".concat(e.url,".\n").concat(t))},bu=function(e,t,n){var r=qs(t),i=Ts(),o=Ks(r),a=e.messageHandlers[o];return a?a(i,r,e,n,o):console.error("Unable to compute message"),i},Su=function e(t){if(t.shouldConnect&&null===t.ws){var n=t._WS;t.ws=n,t.wsconnecting=!0,t.wsconnected=!1,t.synced=!1,n.evt.on("message",(function(e){t.wsLastMessageReceived=nu();var r=bu(t,e,!0);Ps(r)>1&&n.send(js(r))})),n.evt.on("error",(function(e){t.emit("connection-error",[e,t])})),n.evt.on("close",(function(n){t.emit("connection-close",[n,t]),t.ws=null,t.wsconnecting=!1,t.wsconnected?(t.wsconnected=!1,t.synced=!1,yu(t.awareness,Array.from(t.awareness.getStates().keys()).filter((function(e){return e!==t.doc.clientID})),t),t.emit("status",[{status:"disconnected"}])):t.wsUnsuccessfulReconnects++,setTimeout(e,Ms(100*Ls(2,t.wsUnsuccessfulReconnects),t.maxBackoffTime),t)})),n.evt.on("connect",(function(){t.wsLastMessageReceived=nu(),t.wsconnecting=!1,t.wsconnected=!0,t.wsUnsuccessfulReconnects=0,t.emit("status",[{status:"connected"}]);var e=Ts();if(Us(e,0),ru(e,t.doc),n.send(js(e)),null!==t.awareness.getLocalState()){var r=Ts();Us(r,1),Bs(r,mu(t.awareness,[t.doc.clientID])),n.send(js(r))}})),t.emit("status",[{status:"connecting"}])}},xu=function(e,t){var n=e.ws;e.wsconnected&&n&&1===n.readyState&&n.send(t),e.bcconnected&&tu(e.bcChannel,t,e)},Eu=function(e){u(n,e);var t=l(n);function n(e,r,i){var o,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},s=a.connect,u=void 0===s||s,c=a.awareness,l=void 0===c?new gu(i):c,f=a.params,h=void 0===f?{}:f,v=a.protocols,p=void 0===v?[]:v,g=a.WebSocketPolyfill,y=a.resyncInterval,m=void 0===y?-1:y,w=a.maxBackoffTime,k=void 0===w?2500:w,b=a.disableBc,S=void 0!==b&&b;for(_(this,n),o=t.call(this);"/"===e[e.length-1];)e=e.slice(0,e.length-1);return o.serverUrl=e,o.bcChannel=e+"/"+r,o.maxBackoffTime=k,o.params=h,o.protocols=p,o.roomname=r,o.doc=i,o._WS=g,o.awareness=l,o.wsconnected=!1,o.wsconnecting=!1,o.bcconnected=!1,o.disableBc=S,o.wsUnsuccessfulReconnects=0,o.messageHandlers=wu.slice(),o._synced=!1,o.ws=null,o.wsLastMessageReceived=0,o.shouldConnect=u,o._resyncInterval=0,m>0&&(o._resyncInterval=setInterval((function(){if(o.ws&&1===o.ws.readyState){var e=Ts();Us(e,0),ru(e,i),o.ws.send(js(e))}}),m)),o._bcSubscriber=function(e,t){if(t!==d(o)){var n=bu(d(o),new Uint8Array(e),!1);Ps(n)>1&&tu(o.bcChannel,js(n),d(o))}},o._updateHandler=function(e,t){if(t!==d(o)){var n=Ts();Us(n,0),function(e,t){Us(e,2),Bs(e,t)}(n,e),xu(d(o),js(n))}},o.doc.on("update",o._updateHandler),o._awarenessUpdateHandler=function(e,t){var n=e.added,r=e.updated,i=e.removed,a=n.concat(r).concat(i),s=Ts();Us(s,1),Bs(s,mu(l,a)),xu(d(o),js(s))},o._exitHandler=function(){yu(o.awareness,[i.clientID],"app closed")},Cs&&"undefined"!=typeof process&&process.on("exit",o._exitHandler),l.on("update",o._awarenessUpdateHandler),o._checkInterval=setInterval((function(){o.wsconnected&&3e4<nu()-o.wsLastMessageReceived&&o.ws.close()}),3e3),u&&o.connect(),o}return A(n,[{key:"url",get:function(){var e=function(e){return function(e,t){var n=[];for(var r in e)n.push(t(e[r],r));return n}(e,(function(e,t){return"".concat(encodeURIComponent(t),"=").concat(encodeURIComponent(e))})).join("&")}(this.params);return this.serverUrl+"/"+this.roomname+(0===e.length?"":"?"+e)}},{key:"synced",get:function(){return this._synced},set:function(e){this._synced!==e&&(this._synced=e,this.emit("synced",[e]),this.emit("sync",[e]))}},{key:"destroy",value:function(){0!==this._resyncInterval&&clearInterval(this._resyncInterval),clearInterval(this._checkInterval),this.disconnect(),Cs&&"undefined"!=typeof process&&process.off("exit",this._exitHandler),this.awareness.off("update",this._awarenessUpdateHandler),this.doc.off("update",this._updateHandler),s(h(n.prototype),"destroy",this).call(this)}},{key:"connectBc",value:function(){if(!this.disableBc){var e,t;this.bcconnected||(e=this.bcChannel,t=this._bcSubscriber,eu(e).subs.add(t),this.bcconnected=!0);var n=Ts();Us(n,0),ru(n,this.doc),tu(this.bcChannel,js(n),this);var r=Ts();Us(r,0),iu(r,this.doc),tu(this.bcChannel,js(r),this);var i=Ts();Us(i,3),tu(this.bcChannel,js(i),this);var o=Ts();Us(o,1),Bs(o,mu(this.awareness,[this.doc.clientID])),tu(this.bcChannel,js(o),this)}}},{key:"disconnectBc",value:function(){var e,t,n=Ts();Us(n,1),Bs(n,mu(this.awareness,[this.doc.clientID],new Map)),xu(this,js(n)),this.bcconnected&&(e=this.bcChannel,t=this._bcSubscriber,eu(e).subs.delete(t),this.bcconnected=!1)}},{key:"disconnect",value:function(){this.shouldConnect=!1,this.disconnectBc(),null!==this.ws&&this.ws.close()}},{key:"connect",value:function(){this.shouldConnect=!0,this.wsconnected||null!==this.ws||(Su(this),this.connectBc())}}]),n}(lu),Cu=function(){function e(t,n,r,i){_(this,e),M(this,"id",void 0),M(this,"name",void 0),M(this,"doc",void 0),M(this,"context",void 0),M(this,"params",void 0),M(this,"connectionProvider",void 0),this.context=t,this.params=n,this.id=r,this.doc=i;var o=ibiz.appData.mqtttopic.split("/");this.name="/".concat(o[1],"/collaborate/ROOM/").concat(this.id)}var t,n;return A(e,[{key:"created",value:(n=C(x().mark((function e(){var t,n,r,i;return x().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=ibiz.hub.getApp(this.context.srfappid),n=t.model.appId||ibiz.env.appId,r="ws://".concat(window.location.host).concat(ibiz.env.baseUrl,"/").concat(n).concat(ibiz.env.mqttUrl),i=new cs(this.id,this.name,be(),n),e.next=6,i.connect();case 6:this.connectionProvider=new Eu(r,this.name,this.doc,{WebSocketPolyfill:i,resyncInterval:5e3});case 7:case"end":return e.stop()}}),e,this)}))),function(){return n.apply(this,arguments)})},{key:"destroy",value:(t=C(x().mark((function e(){var t;return x().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:null===(t=this.connectionProvider)||void 0===t||t.destroy();case 1:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})}]),e}(),_u=function(){function e(){_(this,e),M(this,"collaborateMap",new Map)}var t,n,r;return A(e,[{key:"getAppId",value:function(e){return ibiz.hub.getApp(e.srfappid).model.appId||ibiz.env.appId}},{key:"create",value:(r=C(x().mark((function e(t,n,r,i){var o,a;return x().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=new Cu(t,n,r,i),e.next=3,o.created();case 3:return a=this.getAppId(t),this.collaborateMap.has(a)||this.collaborateMap.set(a,new Map),this.collaborateMap.get(a).set(o.id,o),e.abrupt("return",o);case 8:case"end":return e.stop()}}),e,this)}))),function(e,t,n,i){return r.apply(this,arguments)})},{key:"get",value:(n=C(x().mark((function e(t,n,r){var i,o;return x().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=this.getAppId(t),this.collaborateMap.has(i)){e.next=3;break}throw new Error(ibiz.i18n.t("runtime.utils.collaborateManager.invalidCollaborateRoom",{id:r}));case 3:if(!(o=this.collaborateMap.get(i))||!o.has(r)){e.next=6;break}return e.abrupt("return",o.get(r));case 6:throw new Error(ibiz.i18n.t("runtime.utils.collaborateManager.invalidCollaborateRoom",{id:r}));case 7:case"end":return e.stop()}}),e,this)}))),function(e,t,r){return n.apply(this,arguments)})},{key:"destroy",value:(t=C(x().mark((function e(t,n,r){var i,o;return x().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:i=this.getAppId(t),this.collaborateMap.has(i)&&(o=this.collaborateMap.get(i))&&o.has(r)&&(o.get(r).destroy(),o.delete(r));case 2:case"end":return e.stop()}}),e,this)}))),function(e,n,r){return t.apply(this,arguments)})}]),e}(),Ou=function(){function e(t){_(this,e),M(this,"yDoc",new Gn),M(this,"collaborateManager",new _u),M(this,"wsProvider",void 0),M(this,"inited",f(!1)),M(this,"yjsEditor",void 0),M(this,"cursorStates",F({})),M(this,"cursorHandler",null),this.enableRealtime=t,this.inited.value=!t}var t;return A(e,[{key:"initYjs",value:(t=C(x().mark((function e(t){var n,r,i,o,a=this;return x().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.inited.value){e.next=10;break}return r=p(t.editor.children),i=this.yDoc.get("content",so),e.next=5,this.collaborateManager.create(t.context,t.params,t.roomname,this.yDoc);case 5:o=e.sent,this.wsProvider=o.connectionProvider,this.wsProvider.on("status",(function(e){"connected"!==e.status||a.inited.value||setTimeout((function(){a.inited.value=!0,!i.toJSON()&&r.length>0&&i.applyDelta(Go(r))}),1e3)})),this.yjsEditor=Ya($a(Aa(Fa(Ca(t.editor,i,Qa(null===(n=t.htmlRef)||void 0===n?void 0:n.$el),{autoConnect:!0}),this.wsProvider.awareness,{data:(s=t.context.srfusername,{color:Za.stringToHexColor(s),name:"".concat(s)})})))),this.initCursorHandler();case 10:case"end":return e.stop()}var s}),e,this)}))),function(e){return t.apply(this,arguments)})},{key:"initCursorHandler",value:function(){var e=this;if(!this.cursorHandler&&this.yjsEditor){var t=new Set;this.cursorHandler=function(n){n.added.forEach((function(e){return t.add(e)})),n.removed.forEach((function(e){return t.add(e)})),n.updated.forEach((function(e){return t.add(e)})),t.forEach((function(t){var n=Pa(e.yjsEditor,t);null===n?delete e.cursorStates[t.toString()]:e.cursorStates[t]=n}))},Ra(this.yjsEditor,"change",this.cursorHandler)}}},{key:"destroy",value:function(){var e,t;null===(e=this.yjsEditor)||void 0===e||e.disconnect(),this.wsProvider.disconnect(),this.cursorHandler&&(Ta(this.yjsEditor,"change",this.cursorHandler),this.cursorHandler=null),null===(t=this.yjsEditor)||void 0===t||t.destroy()}}]),e}(),Au=c({name:"IBizHtmlCollapse",props:G(),emits:["change","blur","focus","enter","infoTextChange","link"],setup:function(e,t){var n,r=t.emit,i=Q("html"),s=e.controller,u=f(),c=f({}),l=null,d=0,h=f(),v=S(),p=f(),g=f(),m=f(),w=f(""),b=f({Authorization:"Bearer ".concat(pe(we.TOKEN))}),_=f(""),A=f(""),P=f(!0),j=f(!1),U=f(!1),F=f(!1),B=f(!1),V=f(!0),q=f(!1),W=f(""),K=f(!1),Y=f([]),$=new Ou(s.enableRealtime),Z=s.model;Z.editorParams&&(Z.editorParams.enableEdit&&(j.value=!0,U.value=!0,P.value=s.toBoolean(Z.editorParams.enableEdit)&&!e.readonly&&!e.disabled),Z.editorParams.enableFullScreen&&(F.value=s.toBoolean(Z.editorParams.enableFullScreen))),e.readonly&&(j.value=!1,U.value=!0),E((function(){return e.data}),(function(e){if(e){var t=ibiz.util.file.calcFileUpDownUrl(s.context,s.params,e,s.editorParams);_.value=t.uploadUrl,A.value=t.downloadUrl}}),{immediate:!0,deep:!0});var G,ee=function(e,t){if(t)return!0},te=function(e){return e},ae=function(){var e=C(x().mark((function e(){var t,n,i,a,u;return x().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!s.deService){e.next=11;break}return e.next=3,o.import("@ibiz-template-plugin/ai-chat");case 3:return n=e.sent,i=n.chat||n.default.chat,G=i,a=i.create({question:function(){var e=C(x().mark((function e(t){var n,r;return x().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=ge(),e.next=3,null===(n=s.deService)||void 0===n?void 0:n.aiChatSse((function(e){if(ibiz.log.info("aiChatSse",e),20===e.actionstate&&e.actionresult)a.addMessage({messageid:r,state:e.actionstate,type:"DEFAULT",role:"ASSISTANT",content:e.actionresult});else if(30===e.actionstate&&e.actionresult){var t=JSON.parse(e.actionresult).choices;t&&t.length>0&&a.replaceMessage({messageid:r,state:e.actionstate,type:"DEFAULT",role:"ASSISTANT",content:t[0].content||""})}else 40===e.actionstate&&a.replaceMessage({messageid:r,state:e.actionstate,type:"ERROR",role:"ASSISTANT",content:e.actionresult})}),s.context,{},{messages:t});case 3:return a.addMessage({messageid:r,state:10,type:"DEFAULT",role:"ASSISTANT",content:""}),e.abrupt("return",!0);case 5:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),action:function(e,t){"backfill"===e&&(j.value?w.value=t.content:r("change",t.content),K.value=!0)},closed:function(){v.value&&v.value.focus(!0)}}),e.next=9,null===(t=s.deService)||void 0===t?void 0:t.aiChatHistory(s.context,{});case 9:(u=e.sent).data&&Array.isArray(u.data)&&u.data.forEach((function(e){var t={messageid:ge(),state:30,type:"DEFAULT",role:e.role,content:e.content};a.addMessage(t)}));case 11:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),se={toolbarKeys:je};s.chatCompletion&&(se.insertKeys={index:60,keys:["|","aichart"]}),s.insertKeys.length>0&&se.toolbarKeys&&s.insertKeys.forEach((function(e){e.keys&&e.keys.forEach((function(t,n){se.toolbarKeys.includes(t)||se.toolbarKeys.splice(e.index+n,0,t)}))}));var ue={placeholder:s.placeHolder,readOnly:j.value?U.value:e.readonly,MENU_CONF:{uploadImage:{server:_.value,fieldName:"file",maxFileSize:10485760,maxNumberOfFiles:10,allowedFileTypes:[],headers:b.value,withCredentials:!0,onBeforeUpload:function(e){return e},onProgress:function(e){console.log("progress",e)},onSuccess:function(e,t){console.log("".concat(e.name," 上传成功"),t)},onFailed:function(e,t){console.log("".concat(e.name," 上传失败"),t)},onError:function(e,t,n){console.log("".concat(e.name," 上传出错"),t,n)},customInsert:function(e,t){return C(x().mark((function n(){var r,i;return x().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:r=A.value.replace("%fileId%",e.id),i=e.filename,t(r,i,"");case 3:case"end":return n.stop()}}),n)})))()}},insertLink:{checkLink:ee,parseLinkUrl:te},editLink:{checkLink:ee,parseLinkUrl:te}},hoverbarKeys:{link:{menuKeys:["editLink","unLink","customViewLink"]}}};O((function(){var e=v.value;null!=e&&(s.enableRealtime?$.destroy():e.destroy())}));var ce=function(){var e=C(x().mark((function e(t){var n;return x().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:s.maxHeight&&(n=t.getEditableContainer(),q.value=n.offsetHeight>s.maxHeight);case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),le=function(){var e=C(x().mark((function e(t){var n,r,i,o,a,s,u;return x().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.src,U.value)de(n);else if(r=ie.nodes(v.value,{match:function(e){return!(!oe.isElement(e)||"image"!==e.type)},universal:!0}),r){i=k(r);try{for(i.s();!(o=i.n()).done;)a=o.value,s=y(a,1),"image"===(u=s[0]).type&&n.endsWith(u.src)&&de(u.src)}catch(c){i.e(c)}finally{i.f()}}case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),de=function(){var e=C(x().mark((function e(t){var n;return x().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return W.value=t,Y.value=[t],e.next=4,D();case 4:g.value&&(n=g.value.$refs.container)&&n.children[0].click();case 5:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),fe=function(e){if(g.value){var t=g.value.$refs.container;if(t){var n=t.querySelector(".el-image-viewer__wrapper");null==n||n[e]("keydown",he)}}},he=function(){var e=C(x().mark((function e(t){return x().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("Escape"!==t.key&&27!==t.keyCode){e.next=7;break}return t.stopPropagation(),t.preventDefault(),e.next=5,D();case 5:fe("removeEventListener"),Y.value=[];case 7:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),ve=function(){var e=C(x().mark((function e(){return x().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,D();case 2:fe("addEventListener");case 3:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),ye=function(){var t=w.value;if("JSON"===s.renderMode){var n=v.value;t=s.toJson(n.children)}e.value!==t&&r("change",t)},be=ke(ye,s.saveInterval),xe=function(t){v.value=t,s.onCreated(v.value,e.data,se);var n,r,i=s.parseNode(w.value);t.setHtml(i),n=e.data.srfuf===J.CREATE,$.initYjs({roomname:n?"draft":e.data.srfkey,editor:v.value,context:s.context,params:s.params,htmlRef:p.value}),t.on("modalOrPanelShow",(function(e){r=new Re(e,p.value)})),t.on("modalOrPanelHide",(function(){r&&r.destroy()})),t.on("aiClick",(function(){ae()}))},Ee=function(t){var n=t.getHtml();ce(t),function(e){var t=e.getEditableContainer();t&&t.querySelectorAll("img").forEach((function(t){t.onload=function(){ce(e)},t.onclick=function(e){var t=e.target;t&&le(t)}}))}(t);var r="<p><br></p>"===n?"":n;r===e.value||""===r&&me(e.value)||(!j.value&&t.isFocused()&&("AUTOMATIC"===s.emitMode?be():ye()),s.evt.emit("onChange",{eventArg:r}))},Ce=function(e){},_e=function(t){r("focus"),s.evt.emit("onFocus",{eventArg:e.value})},Oe=function(t){r("blur"),s.evt.emit("onBlur",{eventArg:e.value})},Ae=function(e,t){alert("【自定义提示】".concat(t," - ").concat(e))},Le=function(e,t,n){n(!0)},De=function(){var e=v.value;null!=e&&e.disable()},Ie=function(){var e=v.value;null!=e&&e.enable()},Te=function(){if(U.value=!U.value,U.value){if(p.value)p.value.$refs.box.scroll(0,0);De()}else Ie(),v.value.focus(),function(){if(e.value){var t=e.value.indexOf("</p>");if(t>=0){var n,r,i=null===(n=v.value.selection.anchor)||void 0===n?void 0:n.offset,o=null===(r=v.value.selection.anchor)||void 0===r?void 0:r.path;0===i&&o.length>0&&0===o[0]&&v.value.move(t-3)}}}(),V.value=!0},Pe=function(){B.value=!B.value,V.value=!B.value,D((function(){U.value?De():(Ie(),v.value.focus())}))};return L((function(){m.value&&(n=X(m,C(x().mark((function e(){return x().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:v.value&&v.value.emit("clickOutside");case 1:case"end":return e.stop()}}),e)}))))),Se(0,(function(){if(u.value&&h.value){var e=u.value.$el.offsetHeight;(l=new ResizeObserver((function(t){var n=t[0].contentRect.height;if(n!==d){var r={height:"".concat(e-t[0].contentRect.height,"px")};c.value=i.cssVarBlock(r),d=n}}))).observe(h.value.selector)}})),E((function(){return e.value}),(function(t,n){t===n||"string"!=typeof e.value&&null!=t||(null==t?w.value="":"JSON"===s.renderMode?w.value=s.jsonToHtml(t):w.value=t,K.value&&(v.value&&D((function(){v.value.focus(!0)})),K.value=!1))}),{immediate:!0}),E((function(){return e.disabled}),(function(e,t){e!==t&&(!0===e?De():Ie())}),{immediate:!0})})),N((function(){l&&l.disconnect(),n&&n.stop&&n.stop(),G&&G.close()})),{ns:i,editorRef:v,previewRef:g,containerRef:m,htmlRef:p,mode:"default",valueHtml:w,toolbarConfig:se,editorConfig:ue,handleCreated:xe,handleChange:Ee,handleDestroyed:Ce,handleFocus:_e,handleBlur:Oe,customAlert:Ae,customPaste:Le,insertText:function(e){var t=v.value;null!=t&&t.insertText(e)},printHtml:function(){v.value},disable:De,enable:Ie,renderHeaserToolbar:function(){return j.value||F.value?I("div",{class:i.b("custom-toolbar")},[j.value&&P.value&&U.value?I("i",{class:"fa fa-edit","aria-hidden":"true",title:"编辑",onClick:function(){return Te()}},null):null,F.value?B.value?I("i",{class:"fa fa-compress","aria-hidden":"true",title:"缩小",onClick:function(){return Pe()}},null):I("i",{class:"fa fa-expand","aria-hidden":"true",title:"放大",onClick:function(){return Pe()}},null):null]):null},renderEditorContent:function(){var e=a({},c.value);return V.value&&s.maxHeight&&Object.assign(e,{maxHeight:"".concat(s.maxHeight,"px")}),H(I(us,{ref:"htmlContent",style:e,slateYjs:$,"element-loading-text":"数据同步中...",class:[i.b("content"),i.is("readonly",U.value)]},{default:function(){return[I(re,{ref:"toolbarRef",editor:v.value,"default-config":se,mode:"default",class:i.b("toolbar")},null),I(ne,{ref:"htmlRef",class:i.b("editor"),modelValue:w.value,"onUpdate:modelValue":function(e){return w.value=e},"default-config":ue,mode:"default",onOnCreated:xe,onOnChange:Ee,onOnDestroyed:Ce,onOnFocus:_e,onOnBlur:Oe,oncustomAlert:Ae,oncustomPaste:Le},null)]}}),[[z("loading"),!$.inited.value]])},renderToggle:function(){return q.value?V.value?I("div",{class:i.e("toggle"),onClick:function(){V.value=!V.value}},[T("展开更多 "),I(R("ion-icon"),{name:"arrow-down-outline"},null)]):I("div",{class:i.e("toggle"),onClick:function(){V.value=!V.value}},[T("收起更多 "),I(R("ion-icon"),{name:"arrow-up-outline"},null)]):null},renderFooter:function(){return j.value&&"AUTOMATIC"!==s.emitMode?I("div",{class:[i.b("footer"),M({},i.b("footer-dialog"),B.value)]},[I("div",{class:i.be("footer","cancel"),onClick:function(){e.value!==w.value?Me({title:"确认取消",type:"warning",customClass:i.b("message"),message:I("div",{class:i.be("message","message-content")},[I("p",null,[T("确定要取消编辑吗？")]),I("p",{class:i.bem("message","message-content","message-tip")},[T("取消编辑将无法保存修改的内容，且不能找回。")])]),showCancelButton:!0,cancelButtonClass:i.be("message","message-cancel"),confirmButtonClass:i.be("message","message-comfire")}).then((function(){if(e.value){var t=s.parseNode(e.value);w.value=t}else w.value="";Te()})).catch((function(){v.value.focus()})):Te()}},[T("取消")]),I("div",{class:i.be("footer","save"),onClick:function(){return U.value=!0,v.value.disable(),"JSON"!==s.renderMode&&r("change",w.value),void(B.value&&(B.value=!1))}},[T("保存")])]):null},htmlContent:u,hasEnableEdit:j,cssVars:c,toolbarRef:h,isFullScreen:B,readonlyState:U,collapse:V,changeFullScreenState:Pe,renderPreview:function(){return I(R("el-image"),{class:i.e("preview"),ref:"previewRef","zoom-rate":1.1,src:W.value,"preview-src-list":Y.value,"hide-on-click-modal":!0,onShow:ve,fit:"cover"},null)}}},render:function(){var e=this;return this.isFullScreen?I(R("el-dialog"),{modelValue:this.isFullScreen,"onUpdate:modelValue":function(t){return e.isFullScreen=t},width:"80%",top:"10vh",class:this.ns.b("dialog-full-screen"),onClose:function(){return e.changeFullScreenState()}},{default:function(){return[I("div",{ref:"containerRef",class:[e.ns.b(),e.ns.b("collapse"),M({},e.ns.b("editor-readonly"),e.readonlyState)]},[e.renderHeaserToolbar(),e.renderEditorContent(),e.hasEnableEdit&&!e.readonlyState?e.renderFooter():null])]}}):I("div",{ref:"containerRef",class:[this.ns.b(),this.ns.is("allow-collapse",!0),M({},this.ns.b("editor-readonly"),this.readonlyState)]},[this.renderHeaserToolbar(),this.renderEditorContent(),this.readonlyState?this.renderToggle():null,this.hasEnableEdit&&!this.readonlyState?this.renderFooter():null,this.renderPreview()])}}),Mu=c({name:"HtmlComment",props:G(),emits:ee(),setup:function(e,t){var n=t.emit,r=Q("html-comment"),i=e.controller,o=f(),a=f(),s=f(!1),u=function(){s.value=!0};return{ns:r,c:i,comment:o,editorRef:a,onChange:function(e){n("change",e),e&&i.collapsed.value&&(i.collapsed.value=!1)},onFocus:function(){i.collapsed.value=!1,n("focus")},onBlur:function(){if(n("blur"),e.value)return null;i.collapsed.value=!0},renderAvatar:function(){if(i.userAvatar&&!s.value){var t=JSON.parse(i.userAvatar);if(0===t.length)return null;var n=ibiz.util.file.calcFileUpDownUrl(i.context,i.params,e.data,i.editorParams).downloadUrl.replace("%fileId%",t[0].id);return I("div",{class:r.e("avatar-name")},[I("img",{src:n,alt:"",onError:u},null)])}var o=Za.stringToHexColor(i.context.srfusername),a=Za.avatarName(i.context.srfusername);return i.context.srfusername?I("div",{class:r.e("avatar-name"),style:"background: ".concat(o,";")},[a]):I(R("el-avatar"),{class:r.e("avatar"),src:"./assets/images/user-avatar.png"},null)}}},render:function(){return"default"===this.c.mode?I(Au,{controller:this.c,data:this.data,value:this.value,readonly:this.readonly,onChange:this.onChange,onFocus:this.onFocus,onBlur:this.onBlur},null):I("div",{ref:"comment",class:[this.ns.b(),this.ns.is("collapse",this.c.collapsed.value)],style:{height:"".concat(this.c.collapsed.value?this.c.minHeight:this.c.maxHeight,"px")}},[this.renderAvatar(),I(Te,{controller:this.c,data:this.data,value:this.value,onChange:this.onChange,onFocus:this.onFocus,onBlur:this.onBlur},null)])}});function Lu(e,t,n,r,i){return{sel:e,data:t,children:n,text:r,elm:i,key:void 0===t?void 0:t.key}}var Du=Array.isArray;function Iu(e){return"string"==typeof e||"number"==typeof e||e instanceof String||e instanceof Number}function Ru(e,t,n){if(e.ns="http://www.w3.org/2000/svg","foreignObject"!==n&&void 0!==t)for(var r=0;r<t.length;++r){var i=t[r];if("string"!=typeof i){var o=i.data;void 0!==o&&Ru(o,i.children,i.sel)}}}function Tu(e,t,n){var r,i,o,a={};if(void 0!==n?(null!==t&&(a=t),Du(n)?r=n:Iu(n)?i=n.toString():n&&n.sel&&(r=[n])):null!=t&&(Du(t)?r=t:Iu(t)?i=t.toString():t&&t.sel?r=[t]:a=t),void 0!==r)for(o=0;o<r.length;++o)Iu(r[o])&&(r[o]=Lu(void 0,void 0,void 0,r[o],void 0));return"s"!==e[0]||"v"!==e[1]||"g"!==e[2]||3!==e.length&&"."!==e[3]&&"#"!==e[3]||Ru(a,r,e),Lu(e,a,r,i,void 0)}var Pu={type:"attachments",elemToHtml:function(e){var t=e.script,n=void 0===t?"":t,r=e.data,i=void 0===r?{}:r,o=q.execScriptFn({data:i},n,{singleRowReturn:!0,isAsync:!1});return"".concat(o)}};var ju={selector:'span[data-w-e-type="attachments"]',parseElemHtml:function(e){var t=decodeURIComponent(e.getAttribute("data-value")||""),n=JSON.parse(t);return{type:"attachments",script:n.script,data:n,children:[{text:""}]}}};var Nu={type:"attachments",renderElem:function(e){var t=e.data,n=void 0===t?{}:t,r={name:"".concat(n.name),id:n.id};return Tu("mention-elem",{dataset:{value:JSON.stringify(r)},props:{contentEditable:!1}},[])}},Uu=function(){function e(){_(this,e),M(this,"title","本地文件"),M(this,"tag","button"),M(this,"iconSvg",'<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="36px" height="36px" viewBox="0 0 36 36" version="1.1">\n    <title>附件</title>\n    <g id="附件" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">\n        <g id="icon">\n            <rect id="矩形" stroke="#EEEEEE" fill="#FFFFFF" x="0.5" y="0.5" width="35" height="35" rx="4"/>\n            <g id="编组-28" transform="translate(2.997929, 8.001508)">\n                <path d="M13.9611058,12.6330155 C13.9611058,14.5460163 12.4108408,16.0968098 10.498492,16.0968098 C8.58614322,16.0968098 7.03587822,14.5460163 7.03590808,12.6393438 L7.03590808,12.6393438 L6.98338468,7.07669061 C6.97992133,6.70644889 7.27712693,6.40347538 7.64724246,6.39998034 C8.017358,6.39648531 8.32022824,6.69379224 8.32372209,7.06403396 L8.32372209,7.06403396 L8.37624485,12.6330155 C8.37624485,13.8054998 9.32640727,14.7559862 10.498492,14.7559862 C11.6705768,14.7559862 12.6207392,13.8054998 12.6207392,12.6330155 L12.6207392,12.6330155 L12.6207392,6.46506253 C12.6207392,4.69957562 11.0562006,3.24725012 9.10227678,3.24725012 C7.148353,3.24725012 5.58381437,4.69957562 5.58381437,6.46506253 L5.58381437,6.46506253 L5.58381437,12.8655397 C5.58381437,15.5621365 7.78332719,17.7497339 10.498492,17.7497339 C13.2136568,17.7497339 15.4131697,15.5621365 15.4131697,12.8655397 L15.4131697,12.8655397 L15.4131697,7.10001026 C15.4131697,6.72975204 15.713221,6.42959845 16.083353,6.42959845 C16.453485,6.42959845 16.7535363,6.72975204 16.7535363,7.10001026 L16.7535363,7.10001026 L16.7535363,12.8655397 C16.7535363,16.3043913 13.9521943,19.0905575 10.498492,19.0905575 C7.04478976,19.0905575 4.24344774,16.3043913 4.24344774,12.8655397 L4.24344774,12.8655397 L4.24344774,6.46506253 C4.24344774,3.93573556 6.42955024,1.90642651 9.10227678,1.90642651 C11.7750033,1.90642651 13.9611058,3.93573556 13.9611058,6.46506253 L13.9611058,6.46506253 Z" id="形状结合" fill="#DDDDDD" transform="translate(10.498492, 10.498492) rotate(-315.000000) translate(-10.498492, -10.498492) "/>\n                <path d="M21.6662931,9.87797441 L24.6096402,9.87797441 C24.9410111,9.87797441 25.2096402,10.1466036 25.2096402,10.4779744 C25.2096402,10.8093453 24.9410111,11.0779744 24.6096402,11.0779744 L21.6662931,11.0779744 C21.3349223,11.0779744 21.0662931,10.8093453 21.0662931,10.4779744 C21.0662931,10.1466036 21.3349223,9.87797441 21.6662931,9.87797441 Z" id="矩形备份-74" fill="#73D897"/>\n                <path d="M21.6662931,4.29120933 L27.4020707,4.29120933 C27.7334415,4.29120933 28.0020707,4.55983848 28.0020707,4.89120933 C28.0020707,5.22258018 27.7334415,5.49120933 27.4020707,5.49120933 L21.6662931,5.49120933 C21.3349223,5.49120933 21.0662931,5.22258018 21.0662931,4.89120933 C21.0662931,4.55983848 21.3349223,4.29120933 21.6662931,4.29120933 Z" id="矩形备份-75" fill="#6698FF"/>\n                <path d="M21.6662931,15.4647395 L27.4020707,15.4647395 C27.7334415,15.4647395 28.0020707,15.7333686 28.0020707,16.0647395 C28.0020707,16.3961103 27.7334415,16.6647395 27.4020707,16.6647395 L21.6662931,16.6647395 C21.3349223,16.6647395 21.0662931,16.3961103 21.0662931,16.0647395 C21.0662931,15.7333686 21.3349223,15.4647395 21.6662931,15.4647395 Z" id="矩形备份-77" fill="#FF7575"/>\n            </g>\n        </g>\n    </g>\n</svg>')}return A(e,[{key:"isActive",value:function(e){return!1}},{key:"getValue",value:function(e){return""}},{key:"isDisabled",value:function(e){return!1}},{key:"exec",value:function(e,t){throw new xe("暂未支持上传本地文件！")}}]),e}(),Fu={renderElems:[Nu],elemsToHtml:[Pu],parseElemsHtml:[ju],menus:[{key:"attachments",factory:function(){return new Uu}}]},Hu=function(){function e(){_(this,e),M(this,"model",void 0),M(this,"context",void 0),M(this,"params",void 0),M(this,"data",{}),M(this,"editor",void 0),M(this,"editorParams",void 0),M(this,"items",[]),M(this,"evt",void 0),M(this,"execting",!1),this.registerNode()}var t;return A(e,[{key:"registerNode",value:function(){window.attachmentsIsRegiter||(fe.registerModule(Fu),window.attachmentsIsRegiter=!0)}},{key:"init",value:(t=C(x().mark((function e(t,n){return x().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.model=n.model,this.context=n.context,this.params=n.params,this.evt=n.evt,this.data=n.data,this.editor=t,this.editorParams=this.model.editorParams;case 7:case"end":return e.stop()}}),e,this)}))),function(e,n){return t.apply(this,arguments)})},{key:"onDestroyed",value:function(){}},{key:"insertNode",value:function(e){}},{key:"parseNode",value:function(e){return e}}]),e}();var zu={type:"codesnippet",elemToHtml:function(e){var t=e.script,n=void 0===t?"":t,r=e.data,i=void 0===r?{}:r,o=q.execScriptFn({data:i},n,{singleRowReturn:!0,isAsync:!1});return"".concat(o)}};var Bu={selector:'span[data-w-e-type="codesnippet"]',parseElemHtml:function(e){var t=decodeURIComponent(e.getAttribute("data-value")||""),n=JSON.parse(t);return{type:"codesnippet",script:n.script,data:n,children:[{text:""}]}}};var Vu={type:"CodeSnippet",renderElem:function(e){var t=e.data,n=void 0===t?{}:t,r={name:"".concat(n.name),id:n.id};return Tu("mention-elem",{dataset:{value:JSON.stringify(r)},props:{contentEditable:!1}},[])}},qu=function(){function e(){_(this,e),M(this,"title","代码段"),M(this,"tag","button"),M(this,"iconSvg",'<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="36px" height="36px" viewBox="0 0 36 36" version="1.1">\n  <title>代码段</title>\n  <g id="代码段" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">\n      <g id="icon备份">\n          <rect id="矩形" stroke="#EEEEEE" fill="#FFFFFF" x="0.5" y="0.5" width="35" height="35" rx="4"/>\n          <path d="M24.6642225,18.8794824 L27.6075695,18.8794824 C27.9389404,18.8794824 28.2075695,19.1481115 28.2075695,19.4794824 C28.2075695,19.8108532 27.9389404,20.0794824 27.6075695,20.0794824 L24.6642225,20.0794824 C24.3328516,20.0794824 24.0642225,19.8108532 24.0642225,19.4794824 C24.0642225,19.1481115 24.3328516,18.8794824 24.6642225,18.8794824 Z" id="矩形备份-74" fill="#73D897"/>\n          <path d="M24.6642225,13.2927173 L30.4,13.2927173 C30.7313708,13.2927173 31,13.5613465 31,13.8927173 C31,14.2240882 30.7313708,14.4927173 30.4,14.4927173 L24.6642225,14.4927173 C24.3328516,14.4927173 24.0642225,14.2240882 24.0642225,13.8927173 C24.0642225,13.5613465 24.3328516,13.2927173 24.6642225,13.2927173 Z" id="矩形备份-75" fill="#6698FF"/>\n          <path d="M24.6642225,24.4662475 L30.4,24.4662475 C30.7313708,24.4662475 31,24.7348766 31,25.0662475 C31,25.3976183 30.7313708,25.6662475 30.4,25.6662475 L24.6642225,25.6662475 C24.3328516,25.6662475 24.0642225,25.3976183 24.0642225,25.0662475 C24.0642225,24.7348766 24.3328516,24.4662475 24.6642225,24.4662475 Z" id="矩形备份-77" fill="#FF7575"/>\n          <g id="1.Base基础/1.icon图标/11.editor/header-1" transform="translate(5.000000, 11.000000)" fill="#DDDDDD">\n              <path d="M4.68266589,2.39258039 L1.51032474,7.44797324 L5.01586095,12.7216272 L4.05994646,13.3212428 L0.126424153,7.40475416 L3.68603474,1.72997946 L4.68266589,2.39258039 Z M11.3173341,12.6697762 L14.4896753,7.61438339 L10.984139,2.34072939 L11.9400535,1.7411138 L15.8735758,7.65760247 L12.3139653,13.3323772 L11.3173341,12.6697762 Z M8.86596086,1.31248434 L10.0376294,1.55020137 L7.19605832,13.6243456 L6.0243898,13.3866286 L8.86596086,1.31248434 Z" id="形状结合"/>\n          </g>\n      </g>\n  </g>\n</svg>')}return A(e,[{key:"isActive",value:function(e){return!1}},{key:"getValue",value:function(e){return""}},{key:"isDisabled",value:function(e){return!1}},{key:"exec",value:function(e,t){throw new xe("暂未支持上传代码段！")}}]),e}(),Ju={renderElems:[Vu],elemsToHtml:[zu],parseElemsHtml:[Bu],menus:[{key:"codesnippet",factory:function(){return new qu}}]},Wu=function(){function e(){_(this,e),M(this,"model",void 0),M(this,"context",void 0),M(this,"params",void 0),M(this,"data",{}),M(this,"editor",void 0),M(this,"editorParams",void 0),M(this,"items",[]),M(this,"evt",void 0),M(this,"execting",!1),this.registerNode()}var t;return A(e,[{key:"registerNode",value:function(){window.codesnippetIsRegiter||(fe.registerModule(Ju),window.codesnippetIsRegiter=!0)}},{key:"init",value:(t=C(x().mark((function e(t,n){return x().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.model=n.model,this.context=n.context,this.params=n.params,this.evt=n.evt,this.data=n.data,this.editor=t,this.editorParams=this.model.editorParams;case 7:case"end":return e.stop()}}),e,this)}))),function(e,n){return t.apply(this,arguments)})},{key:"onDestroyed",value:function(){}},{key:"insertNode",value:function(e){}},{key:"parseNode",value:function(e){return e}}]),e}();var Ku={type:"marker",elemToHtml:function(e){var t=e.script,n=void 0===t?"":t,r=e.data,i=void 0===r?{}:r,o=q.execScriptFn({data:i},n,{singleRowReturn:!0,isAsync:!1});return"".concat(o)}};var Yu={selector:'span[data-w-e-type="marker"]',parseElemHtml:function(e){var t=decodeURIComponent(e.getAttribute("data-value")||""),n=JSON.parse(t);return{type:"marker",script:n.script,data:n,children:[{text:""}]}}};var $u={type:"marker",renderElem:function(e){var t=e.data,n=void 0===t?{}:t;return Tu("mention-elem",{dataset:{value:JSON.stringify(n)},props:{contentEditable:!1}},[])}},Zu=function(){function e(){_(this,e),M(this,"title","提及工作项"),M(this,"tag","button"),M(this,"iconSvg",'<svg t="1706259772097" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="6854" width="200" height="200"><path d="M929.28 625.664l-234.496 0.512 24.064-229.888 210.432-0.512c20.992 0 38.4-17.408 38.4-38.4s-17.408-38.4-38.4-38.4H727.04l29.184-275.456c2.048-20.992-13.312-39.936-34.304-41.984-20.992-2.048-39.936 13.312-41.984 34.304L650.24 318.976l-232.448 0.512 29.184-275.456c2.048-20.992-13.312-39.936-34.304-41.984-20.992-2.048-39.936 13.312-41.984 34.304l-29.696 283.648-246.272 0.512c-20.992 0-38.4 17.408-38.4 38.4s17.408 38.4 38.4 38.4l238.08-0.512-24.064 229.888-214.016 0.512c-20.992 0-38.4 17.408-38.4 38.4s17.408 38.4 38.4 38.4l205.824-0.512-29.184 276.992c-2.048 20.992 13.312 39.936 34.304 41.984h4.096c19.456 0 35.84-14.848 37.888-34.304l30.208-285.184 232.448-0.512-29.184 277.504c-2.048 20.992 13.312 39.936 34.304 41.984h4.096c19.456 0 35.84-14.848 38.4-34.304l30.208-285.184 242.688-0.512c20.992 0 38.4-17.408 38.4-38.4-1.536-20.992-18.944-37.888-39.936-37.888z m-544.256 0.512l24.064-229.888 232.448-0.512-24.064 229.888-232.448 0.512z" fill="#979797" p-id="6855"></path></svg>')}return A(e,[{key:"isActive",value:function(e){return!1}},{key:"getValue",value:function(e){return""}},{key:"isDisabled",value:function(e){return!1}},{key:"exec",value:function(e,t){e.insertText("#")}}]),e}(),Gu={renderElems:[$u],elemsToHtml:[Ku],parseElemsHtml:[Yu],menus:[{key:"marker",factory:function(){return new Zu}}]},Qu=c({name:"MenTion",props:{controller:{type:Object,required:!0},modal:{type:Object}},setup:function(e){var t=Q("mention"),n=e.controller,r=f(!1),i=f([]),o=Ce,a=f({}),s=f(0),u=f([]),c=function(e){var t=e.eventArg;if(t){!t.includes("@")&&n.overlay&&n.execting&&n.overlay.dismiss();var r=t.match(/(?<=\@)([^\@&^{]*?)(?=\<)/g)||[];n.execting&&(0===r.length&&n.overlay.dismiss(),n.query=r.pop()||"",n.query&&/\s$/.test(n.query)?n.overlay.dismiss():n.query&&h({isInitialLoad:!0}))}else n.overlay&&n.execting&&n.overlay.dismiss()},l=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};r.value=!0,n.getUsers(e).then((function(t){var o;(200===t.status&&t.data||(r.value=!1),t.headers["x-total"]&&(s.value=Number(t.headers["x-total"])),!0===e.isLoadMore)?(o=i.value).push.apply(o,p(n.toUIData(t.data))):(i.value=n.toUIData(t.data),i.value.length>0&&(a.value=i.value[0]));r.value=!1})).catch((function(){r.value=!1}))},d=P((function(){return i.value.length>=s.value||r.value||s.value<=n.size})),h=Le(l,300,{leading:!0});n.evt&&n.evt.on("onChange",c),l({isInitialLoad:!0});var v=function(e){var t=i.value.findIndex((function(e){return e.id===a.value.id}));switch(e){case"up":-1!==--t&&-2!==t||(t=i.value.length-1),a.value=i.value[t];break;case"down":++t===i.value.length&&(t=0),a.value=i.value[t];break;case"enter":g(a.value)}},g=function(t){if(e.modal){var n,r={ok:!0,data:[t]};null===(n=e.modal)||void 0===n||n.dismiss(r)}};return L((function(){o=Ee(window,"keyup",(function(e){40===e.keyCode?v("down"):38===e.keyCode?v("up"):13===e.keyCode&&v("enter")}))})),O((function(){o!==Ce&&o(),n.evt.off("onChange",c)})),{ns:t,items:i,loading:r,isLodeMoreDisabled:d,renderItem:function(e){var r=e.name,i=Za.stringToHexColor(r),o=Za.avatarName(r),s="";if(n.operatorMap.has(e.id)){var c=n.operatorMap.get(e.id);c.data.iconurl&&(s=function(e){if(!e)return null;var t=JSON.parse(e);return 0===t.length?null:ibiz.util.file.calcFileUpDownUrl(n.context,n.params,n.editorParams).downloadUrl.replace("%fileId%",t[0].id)}(c.data.iconurl)||"")}return I("div",{class:[t.e("item"),t.is("active",e.id===a.value.id)],onClick:function(){return g(e)}},[I("div",{class:t.e("avatar"),style:"background: ".concat(i,";")},[s&&!u.value.includes(s)?I("img",{src:s,onError:function(){return function(e){u.value.push(e)}(s)}},null):o]),I("div",{class:t.e("name"),title:r},[r])])},loadMore:function(){l({isLoadMore:!0})}}},render:function(){var e=this;return H(I("div",{"infinite-scroll-distance":10,"infinite-scroll-disabled":this.isLodeMoreDisabled,"infinite-scroll-immediate":!1,class:this.ns.b()},[this.items.map((function(t){return e.renderItem(t)})),0===this.items.length&&I(R("iBizNoData"),{text:"暂无用户数据"},null)]),[[z("infinite-scroll"),function(){return e.loadMore()}],[z("loading"),this.loading]])}}),Xu=c({name:"Marker",props:{controller:{type:Object,required:!0},modal:{type:Object}},setup:function(e){var t=Q("marker"),n=e.controller,r=f(!1),i=f([]),o=Ce,a=f({}),s=f(0),u=function(e){var t=e.eventArg;if(t){!t.includes("#")&&n.overlay&&n.execting&&n.overlay.dismiss();var r=t.replace(/<svg((.|[\t\r\f\n\s])+?)<\/svg>/g,"").match(/(?<=\#)([^\#&^{]*?)(?=\<)/g)||[];n.execting&&(0===r.length&&n.overlay.dismiss(),n.query=r.pop()||"",n.query&&/\s$/.test(n.query)?n.overlay.dismiss():n.query&&d({isInitialLoad:!0}))}else n.overlay&&n.execting&&n.overlay.dismiss()},c=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};r.value=!0,n.load(e).then((function(t){var o;(200===t.status&&t.data||(r.value=!1),t.headers["x-total"]&&(s.value=Number(t.headers["x-total"])),!0===e.isLoadMore)?(o=i.value).push.apply(o,p(n.toUIData(t.data))):(i.value=n.toUIData(t.data),i.value.length>0&&(a.value=i.value[0]));r.value=!1})).catch((function(){r.value=!1}))},l=P((function(){return i.value.length>=s.value||r.value||s.value<=n.size})),d=Le(c,300,{leading:!0});n.evt&&n.evt.on("onChange",u),c({isInitialLoad:!0});var h=function(e){var t=i.value.findIndex((function(e){return e.id===a.value.id}));switch(e){case"up":-1!==--t&&-2!==t||(t=i.value.length-1),a.value=i.value[t];break;case"down":++t===i.value.length&&(t=0),a.value=i.value[t];break;case"enter":v(a.value)}},v=function(t){if(e.modal){var n,r={ok:!0,data:[t]};null===(n=e.modal)||void 0===n||n.dismiss(r)}},g=function(e,t){if(n.quoteCodelistMap.has(e)){var r=n.quoteCodelistMap.get(e);return I(R("iBizCodeList"),{codeListItems:r.codeListItems,codeList:r.codeList,value:t},null)}return t};return L((function(){o=Ee(window,"keyup",(function(e){40===e.keyCode?h("down"):38===e.keyCode?h("up"):13===e.keyCode&&h("enter")}))})),O((function(){o!==Ce&&o(),n.evt.off("onChange",u)})),{ns:t,items:i,loading:r,isLodeMoreDisabled:l,renderItem:function(e){return I("div",{class:[t.e("item"),t.is("active",e.id===a.value.id)],onClick:function(){return v(e)}},[I("div",{class:t.e("type")},[g("type",e.type)]),I("div",{class:t.e("identifier")},[g("identifier",e.identifier)]),I("div",{class:t.e("name"),title:e.name},[g("name",e.name)])])},loadMore:function(){c({isLoadMore:!0})}}},render:function(){var e=this;return H(I("div",{"infinite-scroll-distance":10,"infinite-scroll-disabled":this.isLodeMoreDisabled,"infinite-scroll-immediate":!1,class:this.ns.b()},[this.items.map((function(t){return e.renderItem(t)})),0===this.items.length&&I(R("iBizNoData"),{text:"暂无用户数据"},null)]),[[z("infinite-scroll"),function(){return e.loadMore()}],[z("loading"),this.loading]])}}),ec=c({name:"IBizHtmlEmoji",props:{modal:{type:Object,required:!0}},setup:function(e){return{ns:Q("html-emoji"),onSelect:function(t){var n={ok:!0,data:[{emoji:_e(t.data)}]};e.modal.dismiss(n)}}},render:function(){return I("div",{class:this.ns.b()},[I(R("iBizEmojiSelect"),{dark:!0,continuousList:!0,onSelect:this.onSelect},null)])}}),tc=function(){function e(){_(this,e),M(this,"model",void 0),M(this,"context",void 0),M(this,"params",void 0),M(this,"data",{}),M(this,"editor",void 0),M(this,"quoteUrl",""),M(this,"quoteFieldMap",{id:"id",name:"name"}),M(this,"quoteCodelistMap",new Map),M(this,"quoteMethod","post"),M(this,"quoteParams",{}),M(this,"quoteScript","`#{id=${data.id},name=${data.name},identifier=${data.identifier},icon=${data.icon}}`"),M(this,"quoteInScript","value.replaceAll(/#{id=(.+?),name=(.+?),identifier=(.+?),icon=((.|[\\t\\r\\f\\n\\s])+?)}/g,(x, id, name, identifier, icon) => {return controller.getNodeInfo({ id, name, identifier, icon })})"),M(this,"editorParams",void 0),M(this,"items",[]),M(this,"overlay",null),M(this,"evt",void 0),M(this,"execting",!1),M(this,"query",""),M(this,"curPage",0),M(this,"size",20),M(this,"presetPreventEvents",[13,38,40]),M(this,"presetPreventPropEvents",[27]),M(this,"cleanup",Ce),this.registerNode()}var t,n,r,i;return A(e,[{key:"markerPlugin",value:function(e){var t=this,n=e.insertText,r=e.isInline,i=e.isVoid;return e.insertText=function(r){t.editor?t.editor.isFocused()?(he.getSelectedElems(e).some((function(t){return e.isVoid(t)}))||"#"!==r||t.execting||(t.query="",t.showModal()),n(r)):n(r):n(r)},e.isInline=function(e){return"marker"===he.getNodeType(e)||r(e)},e.isVoid=function(e){return"marker"===he.getNodeType(e)||i(e)},e}},{key:"registerNode",value:function(){window.markerIsRegiter||(fe.registerModule(Gu),window.markerIsRegiter=!0),fe.registerPlugin(this.markerPlugin.bind(this))}},{key:"init",value:(i=C(x().mark((function e(t,n){var r,i,o,a,s,u,c,l,d,f,h=this;return x().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.model=n.model,this.context=n.context,this.params=n.params,this.evt=n.evt,this.data=n.data,this.editor=t,this.editorParams=this.model.editorParams,this.editorParams&&(r=this.editorParams,i=r.QUOTEURL,o=r.QUOTEFIELDMAP,a=r.QUOTEMETHOD,s=r.QUOTESCRIPT,u=r.QUOTEINSCRIPT,c=r.QUOTEPARAMS,l=r.QUOTECODELISTMAP,i&&(this.quoteUrl=i),o&&(this.quoteFieldMap=JSON.parse(o)),a&&(this.quoteMethod=a.toLowerCase()),c&&(this.quoteParams=JSON.parse(c)),s&&(this.quoteScript=s),u&&(this.quoteInScript=u),l&&(d=JSON.parse(l),this.setCodeListMap(d))),(f=this.editor.getEditableContainer())&&(this.cleanup=Ee(f,"keydown",(function(e){var t;h.execting&&h.presetPreventEvents.includes(e.keyCode)&&e.preventDefault(),h.execting&&h.presetPreventPropEvents.includes(e.keyCode)&&(e.stopPropagation(),null===(t=h.overlay)||void 0===t||t.dismiss())})));case 10:case"end":return e.stop()}}),e,this)}))),function(e,t){return i.apply(this,arguments)})},{key:"onDestroyed",value:function(){this.cleanup!==Ce&&this.cleanup(),this.overlay&&this.overlay.dismiss()}},{key:"setCodeListMap",value:(r=C(x().mark((function e(t){var n,r;return x().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.t0=x().keys(t);case 1:if((e.t1=e.t0()).done){e.next=9;break}return n=e.t1.value,e.next=5,this.loadCodeList(t[n]);case 5:(r=e.sent)&&this.quoteCodelistMap.set(n,r),e.next=1;break;case 9:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})},{key:"showModal",value:function(){var e=this;if(!this.quoteUrl)throw new xe("未配置提及工作项QUOTEURL编辑器参数！");var t=document.getSelection();if(t){var n=t.focusNode;n&&this.openPopover(n.parentNode).then((function(t){t.length>0&&e.insertNode(t[0])}))}}},{key:"findCodeListItem",value:function(e,t){if(e){var n=e.find((function(e){return e.value==t}));if(n)return n;for(var r=0;r<e.length;r++){var i=this.findCodeListItem(e[r].children,t);if(i)return i}}}},{key:"insertNode",value:function(e){if(this.quoteCodelistMap.has("type")&&e.type){var t=this.quoteCodelistMap.get("type"),n=this.findCodeListItem(t.codeListItems,e.type);n&&n.sysImage&&Object.assign(e,{icon:n.sysImage.rawContent})}var r={type:"marker",script:this.quoteScript,data:e,children:[{text:""}]};this.editor.restoreSelection(),this.editor.deleteBackward("character");for(var i=0;i<this.query.length;i++)this.editor.deleteBackward("character");this.editor.insertNode(r),this.editor.move(1)}},{key:"getNodeInfo",value:function(e){return Object.assign(e,{script:this.quoteScript}),'<span data-w-e-type="marker" data-w-e-is-void data-w-e-is-inline data-value="'.concat(encodeURIComponent(JSON.stringify(e)),'"></span>')}},{key:"parseNode",value:function(e){return q.execScriptFn({value:e,controller:this},this.quoteInScript,{singleRowReturn:!0,isAsync:!1})}},{key:"handlePublicParams",value:function(e,t,n){var r=this.model,i=r.navigateContexts,o=r.navigateParams,a={};i&&e&&(a=W(i,e,n,t));var s=Object.assign(t.clone(),a),u={};return o&&e&&(u=W(o,e,n,t)),{context:s,params:u}}},{key:"load",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=this.handlePublicParams(this.data,this.context,this.params),n=t.context,r=t.params,i=!0===e.isInitialLoad,o=!0===e.isLoadMore;i?this.curPage=0:o&&(this.curPage+=1);var s=q.execScriptFn({data:this.data,context:n,params:r},this.quoteUrl,{singleRowReturn:!0,isAsync:!1}),u=a(a({},r),{},{query:this.query,size:this.size,page:this.curPage},this.quoteParams);return ibiz.net[this.quoteMethod](s,u)}},{key:"toUIData",value:function(e){var t=this;return e.map((function(e){var n={};return Object.keys(t.quoteFieldMap).forEach((function(r){n[r]=e[t.quoteFieldMap[r]]})),n}))}},{key:"openPopover",value:(n=C(x().mark((function e(t){var n;return x().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.overlay=ibiz.overlay.createPopover(this.createOverlayView(),void 0,{placement:"bottom-start",autoClose:!0,width:"300px",noArrow:!0}),e.next=3,this.overlay.present(t);case 3:return this.execting=!0,e.next=6,this.overlay.onWillDismiss();case 6:return n=e.sent,this.execting=!1,e.abrupt("return",n.data||[]);case 9:case"end":return e.stop()}}),e,this)}))),function(e){return n.apply(this,arguments)})},{key:"createOverlayView",value:function(){var e=this;return function(t){return B(Xu,{controller:e,modal:t})}}},{key:"loadCodeList",value:(t=C(x().mark((function e(t){var n,r,i;return x().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=ibiz.hub.getApp(this.context.srfappid),r=n.codeList.getCodeList(t),e.next=4,n.codeList.get(t,this.context,this.params);case 4:return i=e.sent,e.abrupt("return",{codeList:r,codeListItems:i});case 6:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})}]),e}();var nc={type:"mention",elemToHtml:function(e){var t=e.script,n=void 0===t?"":t,r=e.data,i=void 0===r?{}:r,o=q.execScriptFn({data:i},n,{singleRowReturn:!0,isAsync:!1});return"".concat(o)}};var rc={selector:'span[data-w-e-type="mention"]',parseElemHtml:function(e){var t=decodeURIComponent(e.getAttribute("data-value")||""),n=JSON.parse(t);return{type:"mention",script:n.script,data:n,children:[{text:""}]}}};var ic={type:"mention",renderElem:function(e){var t=e.data,n=void 0===t?{}:t,r={name:"@".concat(n.name),id:n.id};return Tu("mention-elem",{dataset:{value:JSON.stringify(r)},props:{contentEditable:!1}},[])}},oc=function(){function e(){_(this,e),M(this,"title","提及成员"),M(this,"tag","button"),M(this,"iconSvg",'<svg t="1705979200437" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4218" xmlns:xlink="http://www.w3.org/1999/xlink" width="200" height="200"><path d="M23.7 555c0-339.3 247-550 533.8-550 295.6 0 442.8 165.9 442.8 401.6 0 210.8-93.5 361.7-237 361.7-63.6 0-108.5-26.2-137.2-78.6-48.6 51.1-96 79.8-174.6 79.8-116 0-178.4-77.3-178.4-193.3 0-209.5 131-323 251.9-323 64.9 0 102.3 24.9 122.2 68.6l11.2-58.6 114.7 1.2L727 510.1c-7.5 36.2-11.2 63.6-11.2 81.1 0 44.9 22.5 71.1 56.1 71.1 63.6 0 106-89.8 106-243.2 0-205.8-114.7-300.6-323-300.6-220.8 0-405.4 163.4-405.4 436.5 0 238.2 132.2 350.5 390.4 350.5 94.8 0 174.6-12.5 255.7-36.2v109.8c-88.6 26.2-177.1 39.9-263.2 39.9-329.1 0-508.7-168.4-508.7-464z m585-44.9c3.7-20 6.2-39.9 6.2-53.6 0-56.1-15-96-83.6-96-83.6 0-133.5 108.5-133.5 212 0 44.9 13.7 88.6 77.3 88.6 73.7-0.1 114.9-57.4 133.6-151z" fill="#333333" p-id="4219"></path></svg>')}return A(e,[{key:"isActive",value:function(e){return!1}},{key:"getValue",value:function(e){return""}},{key:"isDisabled",value:function(e){return!1}},{key:"exec",value:function(e,t){e.insertText("@")}}]),e}(),ac={renderElems:[ic],elemsToHtml:[nc],parseElemsHtml:[rc],menus:[{key:"mention",factory:function(){return new oc}}]},sc=function(){function e(){_(this,e),M(this,"operatorMap",new Map),M(this,"model",void 0),M(this,"context",void 0),M(this,"params",void 0),M(this,"data",{}),M(this,"editor",void 0),M(this,"userUrl",""),M(this,"userFieldMap",{id:"id",name:"name"}),M(this,"userMethod","post"),M(this,"userScript","`@{userid=${data.id},name=${data.name}}`"),M(this,"userInScript","value.replaceAll(/@{userid=(.+?),name=(.+?)}/g,(x, id, name) => {return controller.getNodeInfo({ id, name })})"),M(this,"editorParams",void 0),M(this,"items",[]),M(this,"overlay",null),M(this,"evt",void 0),M(this,"execting",!1),M(this,"query",""),M(this,"curPage",0),M(this,"size",20),M(this,"presetPreventEvents",[13,38,40]),M(this,"presetPreventPropEvents",[27]),M(this,"cleanup",Ce),this.registerNode()}var t,n,r;return A(e,[{key:"mentionPlugin",value:function(e){var t=this,n=e.insertText,r=e.isInline,i=e.isVoid;return e.insertText=function(r){t.editor?t.editor.isFocused()?(he.getSelectedElems(e).some((function(t){return e.isVoid(t)}))||"@"!==r||t.execting||(t.query="",t.showModal()),n(r)):n(r):n(r)},e.isInline=function(e){return"mention"===he.getNodeType(e)||r(e)},e.isVoid=function(e){return"mention"===he.getNodeType(e)||i(e)},e}},{key:"registerNode",value:function(){window.mentionIsRegiter||(fe.registerModule(ac),window.mentionIsRegiter=!0),fe.registerPlugin(this.mentionPlugin.bind(this))}},{key:"init",value:(r=C(x().mark((function e(t,n){var r,i,o,a,s,u,c,l=this;return x().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.model=n.model,this.context=n.context,this.params=n.params,this.evt=n.evt,this.data=n.data,this.editor=t,this.editorParams=this.model.editorParams,this.editorParams&&(r=this.editorParams,i=r.USERURL,o=r.USERFIELDMAP,a=r.USERMETHOD,s=r.USERSCRIPT,u=r.USERINSCRIPT,i&&(this.userUrl=i),o&&(this.userFieldMap=JSON.parse(o)),a&&(this.userMethod=a.toLowerCase()),s&&(this.userScript=s),u&&(this.userInScript=u)),(c=this.editor.getEditableContainer())&&(this.cleanup=Ee(c,"keydown",(function(e){var t;l.execting&&l.presetPreventEvents.includes(e.keyCode)&&e.preventDefault(),l.execting&&l.presetPreventPropEvents.includes(e.keyCode)&&(e.stopPropagation(),null===(t=l.overlay)||void 0===t||t.dismiss())}))),e.next=12,this.getOperatorUserList();case 12:case"end":return e.stop()}}),e,this)}))),function(e,t){return r.apply(this,arguments)})},{key:"getOperatorUserList",value:(n=C(x().mark((function e(){var t,n;return x().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,ibiz.hub.getApp(this.context.srfappid);case 2:return t=e.sent,n=[],e.next=6,t.codeList.get("SysOperator",this.context,this.params);case 6:n=e.sent,this.operatorMap=new Map(n.map((function(e){return[e.value,e]})));case 8:case"end":return e.stop()}}),e,this)}))),function(){return n.apply(this,arguments)})},{key:"onDestroyed",value:function(){this.cleanup!==Ce&&this.cleanup(),this.overlay&&this.overlay.dismiss()}},{key:"showModal",value:function(){var e=this;if(!this.userUrl)throw new xe("未配置提及用户USERURL编辑器参数！");var t=document.getSelection();if(t){var n=t.focusNode;n&&this.openUserPopover(n.parentNode).then((function(t){t.length>0&&e.insertNode(t[0])}))}}},{key:"insertNode",value:function(e){var t={type:"mention",script:this.userScript,data:e,children:[{text:""}]};this.editor.restoreSelection(),this.editor.deleteBackward("character");for(var n=0;n<this.query.length;n++)this.editor.deleteBackward("character");this.editor.insertNode(t),this.editor.move(1)}},{key:"getNodeInfo",value:function(e){return Object.assign(e,{script:this.userScript}),'<span data-w-e-type="mention" data-w-e-is-void data-w-e-is-inline data-value="'.concat(encodeURIComponent(JSON.stringify(e)),'"></span>')}},{key:"parseNode",value:function(e){return q.execScriptFn({value:e,controller:this},this.userInScript,{singleRowReturn:!0,isAsync:!1})}},{key:"handlePublicParams",value:function(e,t,n){var r=this.model,i=r.navigateContexts,o=r.navigateParams,a={};i&&e&&(a=W(i,e,n,t));var s=Object.assign(t.clone(),a),u={};return o&&e&&(u=W(o,e,n,t)),{context:s,params:u}}},{key:"getUsers",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=this.handlePublicParams(this.data,this.context,this.params),n=t.context,r=t.params,i=!0===e.isInitialLoad,o=!0===e.isLoadMore;i?this.curPage=0:o&&(this.curPage+=1);var s=q.execScriptFn({data:this.data,context:n,params:r},this.userUrl,{singleRowReturn:!0,isAsync:!1}),u=a(a({},r),{},{query:this.query,size:this.size,page:this.curPage});return ibiz.net[this.userMethod](s,u)}},{key:"toUIData",value:function(e){var t=this;return e.map((function(e){var n={};return Object.keys(t.userFieldMap).forEach((function(r){n[r]=e[t.userFieldMap[r]]})),n}))}},{key:"openUserPopover",value:(t=C(x().mark((function e(t){var n;return x().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.overlay=ibiz.overlay.createPopover(this.createOverlayView(),void 0,{placement:"bottom-start",autoClose:!0,width:"300px",noArrow:!0}),e.next=3,this.overlay.present(t);case 3:return this.execting=!0,e.next=6,this.overlay.onWillDismiss();case 6:return n=e.sent,this.execting=!1,e.abrupt("return",n.data||[]);case 9:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})},{key:"createOverlayView",value:function(){var e=this;return function(t){return B(Qu,{controller:e,modal:t})}}}]),e}();var uc={type:"page",elemToHtml:function(e){var t=e.script,n=void 0===t?"":t,r=e.data,i=void 0===r?{}:r,o=q.execScriptFn({data:i},n,{singleRowReturn:!0,isAsync:!1});return"".concat(o)}};var cc={selector:'span[data-w-e-type="page"]',parseElemHtml:function(e){var t=decodeURIComponent(e.getAttribute("data-value")||""),n=JSON.parse(t);return{type:"page",script:n.script,data:n,children:[{text:""}]}}};var lc={type:"Page",renderElem:function(e){var t=e.data,n=void 0===t?{}:t,r={name:"".concat(n.name),id:n.id};return Tu("mention-elem",{dataset:{value:JSON.stringify(r)},props:{contentEditable:!1}},[])}},dc=function(){function e(){_(this,e),M(this,"title","页面"),M(this,"tag","button"),M(this,"iconSvg",'<svg t="1707293566679" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="6103" width="200" height="200"><path d="M288 512l256 0C561.92 512 576 497.92 576 480 576 462.08 561.92 448 544 448l-256 0C270.08 448 256 462.08 256 480 256 497.92 270.08 512 288 512zM768 64 192 64C121.6 64 64 121.6 64 192l0 576c0 70.4 57.6 128 128 128l576 0c70.4 0 128-57.6 128-128L896 192C896 121.6 838.4 64 768 64zM832 768c0 35.2-28.8 64-64 64L192 832c-35.2 0-64-28.8-64-64L128 192c0-35.2 28.8-64 64-64l576 0c35.2 0 64 28.8 64 64L832 768zM672 256l-384 0C270.08 256 256 270.08 256 288 256 305.92 270.08 320 288 320l384 0C689.92 320 704 305.92 704 288 704 270.08 689.92 256 672 256zM608 640l-320 0C270.08 640 256 654.08 256 672l0 0C256 689.92 270.08 704 288 704l320 0c17.92 0 32-14.08 32-32l0 0C640 654.08 625.92 640 608 640z" p-id="6104"></path></svg>')}return A(e,[{key:"isActive",value:function(e){return!1}},{key:"getValue",value:function(e){return""}},{key:"isDisabled",value:function(e){return!1}},{key:"exec",value:function(e,t){throw new xe("暂未支持上传页面！")}}]),e}(),fc={renderElems:[lc],elemsToHtml:[uc],parseElemsHtml:[cc],menus:[{key:"page",factory:function(){return new dc}}]},hc=function(){function e(){_(this,e),M(this,"model",void 0),M(this,"context",void 0),M(this,"params",void 0),M(this,"data",{}),M(this,"editor",void 0),M(this,"editorParams",void 0),M(this,"items",[]),M(this,"evt",void 0),M(this,"execting",!1),this.registerNode()}var t;return A(e,[{key:"registerNode",value:function(){window.pageIsRegiter||(fe.registerModule(fc),window.pageIsRegiter=!0)}},{key:"init",value:(t=C(x().mark((function e(t,n){return x().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.model=n.model,this.context=n.context,this.params=n.params,this.evt=n.evt,this.data=n.data,this.editor=t,this.editorParams=this.model.editorParams;case 7:case"end":return e.stop()}}),e,this)}))),function(e,n){return t.apply(this,arguments)})},{key:"onDestroyed",value:function(){}},{key:"insertNode",value:function(e){}},{key:"parseNode",value:function(e){return e}}]),e}(),vc={type:"emoji",renderElem:function(e){var t=e.data,n=void 0===t?{}:t;return Tu("emoji-elem",{dataset:{value:n.emoji?Oe(n.emoji):""},props:{contentEditable:!1}},[])}},pc=function(){function e(){_(this,e),M(this,"title","表情"),M(this,"tag","button"),M(this,"iconSvg","<svg viewBox='0 0 1040 1024' version='1.1' xmlns='http://www.w3.org/2000/svg' p-id='1490' width='1em' height='1em' stroke='var(--w-e-toolbar-color)' > <path stroke-width='38' d='M512.075261 1024A511.774217 511.774217 0 1 1 730.482434 48.769072a37.630457 37.630457 0 1 1-32.061149 68.035867 436.513303 436.513303 0 1 0 250.468323 395.270322 37.630457 37.630457 0 0 1 75.260914 0 512.526826 512.526826 0 0 1-512.075261 511.924739z' p-id='1491' ></path> <path stroke-width='38' d='M333.857416 344.0929a57.348817 57.348817 0 1 0 57.348817 57.348817 57.499339 57.499339 0 0 0-57.348817-57.348817zM686.53006 344.0929a57.348817 57.348817 0 1 0 57.348817 57.348817 57.348817 57.348817 0 0 0-57.348817-57.348817zM515.236219 783.165074c-162.864619 0-262.359547-141.942084-262.359547-219.159782a30.104366 30.104366 0 0 1 60.208731 0c0 48.618551 76.314567 158.951051 202.150816 158.951051s193.571072-134.114949 193.571072-158.951051a30.104366 30.104366 0 0 1 60.208731 0c0 54.488902-90.012054 219.159782-253.779803 219.159782zM1009.549904 207.720123h-67.132735V139.985301a30.104366 30.104366 0 1 0-60.208732 0v67.734822h-67.734822a30.104366 30.104366 0 0 0-30.104366 30.104366 30.104366 30.104366 0 0 0 30.104366 30.104366h67.734822v67.734823a30.104366 30.104366 0 0 0 60.208732 0v-67.734823h67.734823a30.104366 30.104366 0 0 0 30.104365-30.104366 30.104366 30.104366 0 0 0-30.706453-30.104366z' p-id='1492' ></path> </svg>")}return A(e,[{key:"isActive",value:function(){return!1}},{key:"getValue",value:function(){return!1}},{key:"isDisabled",value:function(){return!1}},{key:"exec",value:function(e){e.emit("openEmojiSelect")}}]),e}(),gc={renderElems:[vc],elemsToHtml:[{type:"emoji",elemToHtml:function(e){var t=e.data;return"<span data-w-e-type=\"emoji\" class='emoji'>".concat(t.emoji,"</span>")}}],parseElemsHtml:[{selector:'span[data-w-e-type="emoji"]',parseElemHtml:function(e){return{data:{emoji:e.innerHTML},type:"emoji",children:[{text:""}]}}}],menus:[{key:"emoji",factory:function(){return new pc}}]},yc=function(){function e(){_(this,e),M(this,"editor",void 0),M(this,"overlay",null),M(this,"presetPreventEvents",[13,38,40]),M(this,"presetPreventPropEvents",[27]),M(this,"cleanup",Ce),this.registerNode()}var t,n;return A(e,[{key:"emojiPlugin",value:function(e){var t=e.isInline,n=e.isVoid;return e.isInline=function(e){return"emoji"===he.getNodeType(e)||t(e)},e.isVoid=function(e){return"emoji"===he.getNodeType(e)||n(e)},e}},{key:"registerNode",value:function(){window.emojiIsRegiter||(fe.registerModule(gc),window.emojiIsRegiter=!0),fe.registerPlugin(this.emojiPlugin.bind(this))}},{key:"init",value:(n=C(x().mark((function e(t){return x().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.editor=t,this.listenEvent();case 2:case"end":return e.stop()}}),e,this)}))),function(e){return n.apply(this,arguments)})},{key:"listenEvent",value:function(){var e=this,t=this.editor.getEditableContainer();this.editor.on("openEmojiSelect",(function(){return e.openEmojiSelect()})),this.cleanup=Ee(t,"keydown",(function(t){var n;(e.overlay&&e.presetPreventEvents.includes(t.keyCode)&&t.preventDefault(),e.overlay&&e.presetPreventPropEvents.includes(t.keyCode))&&(t.stopPropagation(),null===(n=e.overlay)||void 0===n||n.dismiss())}))}},{key:"openEmojiSelect",value:(t=C(x().mark((function e(){var t,n,r=this;return x().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=document.getSelection(),!(n=t.focusNode)){e.next=7;break}return this.overlay=ibiz.overlay.createPopover((function(e){return B(ec,{controller:r,modal:e})}),void 0,{width:"auto",noArrow:!0,autoClose:!0,placement:"bottom-start"}),e.next=6,this.overlay.present(n.parentNode);case 6:this.overlay.onWillDismiss().then((function(e){var t,n=e,i=null===(t=n.data)||void 0===t?void 0:t[0];n.ok&&i&&r.addEmojiNode(i),r.overlay=null}));case 7:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{key:"addEmojiNode",value:function(e){var t={data:e,type:"emoji",children:[{text:""}]};this.editor.restoreSelection(),this.editor.insertNode(t),this.editor.move(1)}},{key:"parseNode",value:function(e){return q.execScriptFn({value:e,controller:this},'value.replaceAll(/\\{\\"\\emoji\\":\\"(.+?)\\"\\}/g,(x, emoji) => {return \'<span data-w-e-type="emoji" class="emoji">\'+emoji+\'</span>\'})',{singleRowReturn:!0,isAsync:!1})}},{key:"onDestroyed",value:function(){this.cleanup!==Ce&&this.cleanup(),this.overlay&&this.overlay.dismiss()}}]),e}(),mc=function(){function e(){_(this,e)}return A(e,null,[{key:"init",value:function(e){var t=this;this.registerMap.set("mention",sc),this.registerMap.set("marker",tc),this.registerMap.set("attachments",Hu),this.registerMap.set("codesnippet",Wu),this.registerMap.set("page",hc),this.registerMap.set("emoji",yc),this.presetNodes.forEach((function(n){t.registerPlugin({type:n,id:"".concat(n).concat(e)})}))}},{key:"registerPlugin",value:function(e){var t=e.type,n=e.id;if(this.customNodeMap.has(n))return this.customNodeMap.get(n);var r=this.registerMap.get(t);if(r){var i=new r;return this.customNodeMap.set(n,i),i}}},{key:"getPluginsById",value:function(e){var t=this,n=[];return this.presetNodes.forEach((function(r){t.customNodeMap.has("".concat(r).concat(e))&&n.push(t.customNodeMap.get("".concat(r).concat(e)))})),n}},{key:"unregisterPlugin",value:function(e){var t=e.id;this.customNodeMap.has(t)&&this.customNodeMap.delete(t)}},{key:"destroy",value:function(e){var t=this;this.presetNodes.forEach((function(n){t.unregisterPlugin({id:"".concat(n).concat(e)})})),this.registerMap.delete("mention"),this.registerMap.delete("marker"),this.registerMap.delete("attachments"),this.registerMap.delete("codesnippet"),this.registerMap.delete("page"),this.registerMap.delete("emoji")}}]),e}();M(mc,"customNodeMap",new Map),M(mc,"registerMap",new Map),M(mc,"presetNodes",["mention","marker","attachments","codesnippet","page","emoji"]);var wc=function(e){u(n,e);var t=l(n);function n(){return _(this,n),t.apply(this,arguments)}return A(n,[{key:"attributeChangedCallback",value:function(e,t,n){if("data-value"===e){if(n&&t===n)return;var r=JSON.parse(n),i=this.attachShadow({mode:"open"}),o=i.ownerDocument;if(r.icon){var a=o.createElement("span");a.part.add("svg"),a.innerHTML=r.icon,i.appendChild(a)}if(r.identifier){var s=o.createElement("span");s.part.add("identifier"),s.innerHTML=r.identifier,i.appendChild(s)}if(r.name){var u=o.createElement("span");u.part.add("name"),u.innerHTML=r.name,i.appendChild(u)}var c=o.createElement("style");c.innerHTML="\n      svg {\n        height: 1em;\n        width: 1em;\n      }\n    ",i.appendChild(c)}}}],[{key:"observedAttributes",get:function(){return["data-value"]}}]),n}(n(HTMLElement)),kc=function(e){u(n,e);var t=l(n);function n(){return _(this,n),t.apply(this,arguments)}return A(n,[{key:"attributeChangedCallback",value:function(e,t,n){if("data-value"===e){if(n&&t===n)return;var r=this.attachShadow({mode:"open"}),i=r.ownerDocument.createElement("span");i.innerHTML=n,i.part.add("box"),i.classList.add("emoji-elem_box"),r.appendChild(i)}}}],[{key:"observedAttributes",get:function(){return["data-value"]}}]),n}(n(HTMLElement)),bc=function(){function e(){var t=this;_(this,e),M(this,"title","格式刷"),M(this,"tag","button"),M(this,"fragment",[]),M(this,"format",{}),M(this,"editor",null),M(this,"excting",!1),M(this,"iconSvg",'<svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" fit="" height="1em" width="1em" preserveAspectRatio="xMidYMid meet" focusable="false"><g id="aqseditor/paintformat" stroke-width="1" fill-rule="evenodd"><path d="M3 5.24h10V2H3v3.24zM13.299 1H2.701A.701.701 0 0 0 2 1.701v3.838c0 .387.314.701.701.701h6.236L7.621 7.438h-.002v2.233h-.768v5.184L9.404 13.1V9.671h-.585V7.97l1.9-1.73h2.58A.701.701 0 0 0 14 5.539V1.701A.701.701 0 0 0 13.299 1z" id="aqsFill-1"></path></g></svg>'),M(this,"setPaintFormat",(function(){if(t.editor){var e=t.editor.getSelectionText();if(e&&Object.keys(t.format).length>0){var n=a(a({},t.format),{},{text:e});t.editor.insertNode(n),t.excting||t.clearFormat()}}})),M(this,"onPaintFormat",ke(this.setPaintFormat,500,!1)),M(this,"throttleHandle",this.throttle(this.handle,300))}return A(e,[{key:"isActive",value:function(e){return Object.keys(this.format).length>0}},{key:"getValue",value:function(e){return""}},{key:"isDisabled",value:function(e){return!1}},{key:"calcFormat",value:function(e){var t=this;e.length>0&&e[0].children.forEach((function(e){Object.assign(t.format,e)}))}},{key:"clearFormat",value:function(){this.format={};var e=this.editor.getEditableContainer();e&&e.classList.remove("is-paint-format");var t=document.querySelector("button[data-menu-key='paintformat']");t&&t.classList.remove("active")}},{key:"throttle",value:function(e,t){var n=null;return function(){for(var r=this,i=arguments.length,o=new Array(i),a=0;a<i;a++)o[a]=arguments[a];n||(n=setTimeout((function(){e.apply(r,o),n=null,r.excting=!0}),t))}}},{key:"handle",value:function(e){var t=this;if(this.excting)return this.clearFormat(),void(this.excting=!1);var n=e.getFragment();this.calcFormat(n),this.editor=e;var r=this.editor.getEditableContainer();r&&r.classList.add("is-paint-format"),e.deselect(),e.on("change",this.onPaintFormat),e.on("clickOutside",(function(){t.clearFormat(),t.excting=!1}))}},{key:"exec",value:function(e){this.throttleHandle(e)}}]),e}(),Sc={key:"paintformat",factory:function(){return new bc}},xc=function(){function e(){_(this,e),M(this,"title","AI询问"),M(this,"iconSvg",'<svg xmlns="http://www.w3.org/2000/svg" version="1.1"> <text x="0" y="13" font-size="16" fill="black">AI</text></svg>'),M(this,"tag","button")}return A(e,[{key:"isActive",value:function(e){return!1}},{key:"getValue",value:function(e){return"aichart"}},{key:"isDisabled",value:function(e){return!1}},{key:"exec",value:function(e,t){e.emit("aiClick")}}]),e}();var Ec={type:"link",elemToHtml:function(e){var t=e.url,n=e.children,r="_blank";return t.startsWith("./#/")&&(r="_self"),'<a href="'.concat(t,'" target="').concat(r,'">').concat(n[0].text,"</a>")}},Cc=function(){function e(){_(this,e),M(this,"title","查看连接"),M(this,"iconSvg",'<svg viewBox="0 0 1024 1024"><path d="M924.402464 1023.068211H0.679665V99.345412h461.861399v98.909208H99.596867v725.896389h725.896389V561.206811h98.909208z" p-id="10909"></path><path d="M930.805104 22.977336l69.965436 69.965436-453.492405 453.492404-69.965435-69.901489z" p-id="10910"></path><path d="M1022.464381 304.030081h-98.917201V99.345412H709.230573V0.428211h313.233808z"></path></svg>'),M(this,"tag","button")}return A(e,[{key:"getSelectedLinkElem",value:function(e){var t=he.getSelectedNodeByType(e,"link");return null==t?null:t}},{key:"getValue",value:function(e){var t=this.getSelectedLinkElem(e);return t&&t.url||""}},{key:"isActive",value:function(){return!1}},{key:"isDisabled",value:function(e){return null==e.selection||null==this.getSelectedLinkElem(e)}},{key:"exec",value:function(e,t){if(!this.isDisabled(e)){if(!t||"string"!=typeof t)throw new Error("打开链接失败, 路径为 '".concat(t,"'"));t.toString().startsWith("./#/")?window.open("".concat(window.location.pathname).concat(t.slice(1)),"_self"):window.open(t,"_blank")}}}]),e}(),_c={menus:[{key:"customViewLink",factory:function(){return new Cc}}],elemsToHtml:[Ec]},Oc=function(e){u(o,e);var t,n,r,i=l(o);function o(){var e;_(this,o);for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];return M(d(e=i.call.apply(i,[this].concat(n))),"userAvatar",""),M(d(e),"uploadParams",void 0),M(d(e),"exportParams",void 0),M(d(e),"minHeight",48),M(d(e),"maxHeight",315),M(d(e),"collapsed",f(!0)),M(d(e),"hidden",f(!1)),M(d(e),"reply",f("")),M(d(e),"replyScript",""),M(d(e),"mode","comment"),M(d(e),"insertKeys",[]),M(d(e),"renderMode","HTML"),M(d(e),"saveInterval",3e3),M(d(e),"emitMode","BUTTON"),M(d(e),"uuid",ge()),M(d(e),"enableRealtime",!1),M(d(e),"editor",void 0),M(d(e),"autoSaveInterval",3e4),M(d(e),"timer",null),M(d(e),"deService",void 0),M(d(e),"deACMode",void 0),M(d(e),"chatCompletion",!1),M(d(e),"evt",new Y(e.getEventArgs.bind(d(e)))),e}return A(o,[{key:"getEventArgs",value:function(){return{context:this.context,params:this.params,data:[],eventArg:"",targetName:this.model.name,view:this.getView()}}},{key:"onInit",value:(r=C(x().mark((function e(){var t,n,r,i,a,u,c,l,d,f,v,p,g,y,m=this;return x().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,s(h(o.prototype),"onInit",this).call(this);case 2:return e.next=4,this.getCurrentUserAvatar();case 4:if(!(t=this.model).appDEACModeId){e.next=15;break}return e.next=8,$(t.appDEACModeId,t.appDataEntityId,this.context.srfappid);case 8:if(this.deACMode=e.sent,!this.deACMode){e.next=15;break}if("CHATCOMPLETION"!==this.deACMode.actype){e.next=15;break}return e.next=13,ibiz.hub.getApp(t.appId).deService.getService(this.context,t.appDataEntityId);case 13:this.deService=e.sent,this.chatCompletion=!0;case 15:if(this.registerCustomElem(),this.editorParams){if(n=this.editorParams,r=n.uploadParams,i=n.exportParams,a=n.MINHEIGHT,u=n.MAXHEIGHT,c=n.REPLYSCRIPT,l=n.MODE,d=n.INSERTKEYS,f=n.RENDERMODE,v=n.SAVEINTERVAL,p=n.EMITMODE,g=n.DEFAULTCOLLAPSE,y=n.ENABLEREALTIME,r)try{this.uploadParams=JSON.parse(r)}catch(w){ibiz.log.error("编辑器[".concat(ibiz.log.error(w),"]编辑器参数 uploadParams 非 json 格式"))}if(i)try{this.exportParams=JSON.parse(i)}catch(w){ibiz.log.error("编辑器[".concat(ibiz.log.error(w),"]编辑器参数 exportParams 非 json 格式"))}a&&(this.minHeight=Number(a)),u&&(this.maxHeight=Number(u)),c&&(this.replyScript=c),l&&(this.mode=l.toLowerCase()),d&&(this.insertKeys=JSON.parse(d)),f&&(this.renderMode=f),v&&(this.saveInterval=De(v)),p&&(this.emitMode=p),g&&(this.collapsed.value=!Object.is(g,"TRUE")&&!Object.is(g,"true")),y&&(this.enableRealtime=Object.is(y,"TRUE")||Object.is(y,"true"))}mc.init(this.uuid),this.evt.on("onChange",(function(){if(!m.parent.form){var e=ibiz.uiDomainManager.get(m.context.srfsessionid);e&&e.dataChange()}})),this.listenViewDestroyed();case 20:case"end":return e.stop()}}),e,this)}))),function(){return r.apply(this,arguments)})},{key:"registerCustomElem",value:function(){window.customElements.get("mention-elem")||window.customElements.define("mention-elem",wc),window.customElements.get("emoji-elem")||window.customElements.define("emoji-elem",kc),window.paintFormatIsRegiter||(fe.registerMenu(Sc),window.paintFormatIsRegiter=!0),window.aichartRegister||(fe.registerMenu({key:"aichart",factory:function(){return new xc}}),window.aichartRegister=!0),window.customLinkIsRegiter||(fe.registerModule(_c),window.customLinkIsRegiter=!0)}},{key:"onCreated",value:function(e,t,n){var r=this;mc.getPluginsById(this.uuid).forEach((function(i){i.init(e,{model:r.model,data:t,toolbarConfig:n,context:r.context,params:r.params,evt:r.evt})}))}},{key:"onDestroyed",value:function(){mc.getPluginsById(this.uuid).forEach((function(e){e.onDestroyed()})),mc.destroy(this.uuid)}},{key:"listenViewDestroyed",value:function(){var e=this,t=this.getView();t&&t.evt.on("onDestroyed",(function(){e.onDestroyed()}))}},{key:"parseNode",value:function(e){var t=e;return mc.getPluginsById(this.uuid).forEach((function(e){t=e.parseNode(t)})),t}},{key:"setValue",value:(n=C(x().mark((function e(t){var n;return x().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.collapsed.value=!1,this.hidden.value=!0,e.next=4,D();case 4:return this.hidden.value=!1,e.next=7,D();case 7:n=this.parseNode(t),this.evt.emit("setHtml",{eventArg:n});case 9:case"end":return e.stop()}}),e,this)}))),function(e){return n.apply(this,arguments)})},{key:"setReply",value:function(e){this.reply.value=Za.getEmojiCustomHtml("".concat(e.name,": ").concat(e.content)),this.evt.emit("onSetReply",{eventArg:this.reply.value})}},{key:"removeReply",value:function(){this.reply.value="",this.evt.emit("onRemoveReply",{eventArg:this.reply.value})}},{key:"clear",value:function(){this.reply.value="",this.evt.emit("onRemoveReply",{eventArg:this.reply.value}),this.evt.emit("clear",{eventArg:""}),this.collapsed.value=!0}},{key:"fileDownload",value:function(e){ibiz.net.request(e.url,{method:"get",responseType:"blob",baseURL:""}).then((function(t){if(200!==t.status)throw new xe("下载文件失败");if(!t.data)throw new xe("文件流数据不存在");var n=e.name;Ae(t.data,n)}))}},{key:"toggleCollapse",value:function(e){this.collapsed.value=!e&&!this.collapsed.value}},{key:"jsonToHtml",value:function(e){var t="";try{var n=JSON.parse(e);t=ve({content:n}).getHtml()}catch(r){t=e,ibiz.log.error("JSON字符串转换错误",r)}return t}},{key:"toJson",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t="";try{t=JSON.stringify(e)}catch(n){ibiz.log.error("JSON字符串转换错误")}return t}},{key:"getCurrentUserAvatar",value:(t=C(x().mark((function e(){var t,n,r,i,o=this;return x().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,ibiz.hub.getApp(this.context.srfappid);case 2:return t=e.sent,n=[],e.next=6,t.codeList.get("SysOperator",this.context,this.params);case 6:n=e.sent,this.context.srfuserid&&(r=n.filter((function(e){return e.value===o.context.srfuserid})))&&r.length>0&&(this.userAvatar=(null===(i=r[0])||void 0===i||null===(i=i.data)||void 0===i?void 0:i.iconurl)||"");case 8:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{key:"getView",value:function(){var e=this.parent.form||this.parent.grid||this.parent.panel;if(e)return e.view}}]),o}(K),Ac=function(){function e(){_(this,e),M(this,"formEditor","HtmlComment"),M(this,"gridEditor","HtmlComment")}var t;return A(e,[{key:"createController",value:(t=C(x().mark((function e(t,n){var r;return x().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=new Oc(t,n),e.next=3,r.init();case 3:return e.abrupt("return",r);case 4:case"end":return e.stop()}}),e)}))),function(e,n){return t.apply(this,arguments)})}]),e}(),Mc=r("IBizHtmlComment",te(Mu,(function(e){e.component(Au.name,Au),e.component(Te.name,Te),e.component(Mu.name,Mu),Z("EDITOR_CUSTOMSTYLE_COMMENT",(function(){return new Ac}))})));r("default",{install:function(e){e.use(Mc),e.component("IBizHtmlContent",V((function(){return Promise.resolve().then((function(){return Pe}))})))}})}}}))}();
