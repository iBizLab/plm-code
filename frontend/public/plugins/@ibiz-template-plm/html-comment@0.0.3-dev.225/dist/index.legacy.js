!function(){function e(t){return e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e(t)}function t(){return t="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=u(e)););return e}(e,t);if(r){var i=Object.getOwnPropertyDescriptor(r,t);return i.get?i.get.call(arguments.length<3?e:n):i.value}},t.apply(this,arguments)}function n(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&l(e,t)}function r(t){var n=s();return function(){var r,a=u(t);if(n){var o=u(this).constructor;r=Reflect.construct(a,arguments,o)}else r=a.apply(this,arguments);return function(t,n){if(n&&("object"===e(n)||"function"==typeof n))return n;if(void 0!==n)throw new TypeError("Derived constructors may only return object or undefined");return i(t)}(this,r)}}function i(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function a(e){var t="function"==typeof Map?new Map:void 0;return a=function(e){if(null===e||!function(e){try{return-1!==Function.toString.call(e).indexOf("[native code]")}catch(t){return"function"==typeof e}}(e))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,n)}function n(){return o(e,arguments,u(this).constructor)}return n.prototype=Object.create(e.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),l(n,e)},a(e)}function o(e,t,n){return o=s()?Reflect.construct.bind():function(e,t,n){var r=[null];r.push.apply(r,t);var i=new(Function.bind.apply(e,r));return n&&l(i,n.prototype),i},o.apply(null,arguments)}function s(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function l(e,t){return l=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},l(e,t)}function u(e){return u=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},u(e)}function c(e){return function(e){if(Array.isArray(e))return m(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||p(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function d(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function v(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?d(Object(n),!0).forEach((function(t){C(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):d(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function f(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,i,a,o,s=[],l=!0,u=!1;try{if(a=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;l=!1}else for(;!(l=(r=a.call(n)).done)&&(s.push(r.value),s.length!==t);l=!0);}catch(e){u=!0,i=e}finally{try{if(!l&&null!=n.return&&(o=n.return(),Object(o)!==o))return}finally{if(u)throw i}}return s}}(e,t)||p(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function h(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=p(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return o=e.done,e},e:function(e){s=!0,a=e},f:function(){try{o||null==n.return||n.return()}finally{if(s)throw a}}}}function p(e,t){if(e){if("string"==typeof e)return m(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?m(e,t):void 0}}function m(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function g(){"use strict";/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */g=function(){return n};var t,n={},r=Object.prototype,i=r.hasOwnProperty,a=Object.defineProperty||function(e,t,n){e[t]=n.value},o="function"==typeof Symbol?Symbol:{},s=o.iterator||"@@iterator",l=o.asyncIterator||"@@asyncIterator",u=o.toStringTag||"@@toStringTag";function c(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{c({},"")}catch(t){c=function(e,t,n){return e[t]=n}}function d(e,t,n,r){var i=t&&t.prototype instanceof b?t:b,o=Object.create(i.prototype),s=new T(r||[]);return a(o,"_invoke",{value:P(e,n,s)}),o}function v(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}n.wrap=d;var f="suspendedStart",h="suspendedYield",p="executing",m="completed",y={};function b(){}function w(){}function k(){}var x={};c(x,s,(function(){return this}));var C=Object.getPrototypeOf,S=C&&C(C(R([])));S&&S!==r&&i.call(S,s)&&(x=S);var E=k.prototype=b.prototype=Object.create(x);function O(e){["next","throw","return"].forEach((function(t){c(e,t,(function(e){return this._invoke(t,e)}))}))}function M(t,n){function r(a,o,s,l){var u=v(t[a],t,o);if("throw"!==u.type){var c=u.arg,d=c.value;return d&&"object"==e(d)&&i.call(d,"__await")?n.resolve(d.__await).then((function(e){r("next",e,s,l)}),(function(e){r("throw",e,s,l)})):n.resolve(d).then((function(e){c.value=e,s(c)}),(function(e){return r("throw",e,s,l)}))}l(u.arg)}var o;a(this,"_invoke",{value:function(e,t){function i(){return new n((function(n,i){r(e,t,n,i)}))}return o=o?o.then(i,i):i()}})}function P(e,n,r){var i=f;return function(a,o){if(i===p)throw new Error("Generator is already running");if(i===m){if("throw"===a)throw o;return{value:t,done:!0}}for(r.method=a,r.arg=o;;){var s=r.delegate;if(s){var l=L(s,r);if(l){if(l===y)continue;return l}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(i===f)throw i=m,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);i=p;var u=v(e,n,r);if("normal"===u.type){if(i=r.done?m:h,u.arg===y)continue;return{value:u.arg,done:r.done}}"throw"===u.type&&(i=m,r.method="throw",r.arg=u.arg)}}}function L(e,n){var r=n.method,i=e.iterator[r];if(i===t)return n.delegate=null,"throw"===r&&e.iterator.return&&(n.method="return",n.arg=t,L(e,n),"throw"===n.method)||"return"!==r&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+r+"' method")),y;var a=v(i,e.iterator,n.arg);if("throw"===a.type)return n.method="throw",n.arg=a.arg,n.delegate=null,y;var o=a.arg;return o?o.done?(n[e.resultName]=o.value,n.next=e.nextLoc,"return"!==n.method&&(n.method="next",n.arg=t),n.delegate=null,y):o:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,y)}function A(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function N(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function T(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(A,this),this.reset(!0)}function R(n){if(n||""===n){var r=n[s];if(r)return r.call(n);if("function"==typeof n.next)return n;if(!isNaN(n.length)){var a=-1,o=function e(){for(;++a<n.length;)if(i.call(n,a))return e.value=n[a],e.done=!1,e;return e.value=t,e.done=!0,e};return o.next=o}}throw new TypeError(e(n)+" is not iterable")}return w.prototype=k,a(E,"constructor",{value:k,configurable:!0}),a(k,"constructor",{value:w,configurable:!0}),w.displayName=c(k,u,"GeneratorFunction"),n.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===w||"GeneratorFunction"===(t.displayName||t.name))},n.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,k):(e.__proto__=k,c(e,u,"GeneratorFunction")),e.prototype=Object.create(E),e},n.awrap=function(e){return{__await:e}},O(M.prototype),c(M.prototype,l,(function(){return this})),n.AsyncIterator=M,n.async=function(e,t,r,i,a){void 0===a&&(a=Promise);var o=new M(d(e,t,r,i),a);return n.isGeneratorFunction(t)?o:o.next().then((function(e){return e.done?e.value:o.next()}))},O(E),c(E,u,"Generator"),c(E,s,(function(){return this})),c(E,"toString",(function(){return"[object Generator]"})),n.keys=function(e){var t=Object(e),n=[];for(var r in t)n.push(r);return n.reverse(),function e(){for(;n.length;){var r=n.pop();if(r in t)return e.value=r,e.done=!1,e}return e.done=!0,e}},n.values=R,T.prototype={constructor:T,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(N),!e)for(var n in this)"t"===n.charAt(0)&&i.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=t)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var n=this;function r(r,i){return s.type="throw",s.arg=e,n.next=r,i&&(n.method="next",n.arg=t),!!i}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],s=o.completion;if("root"===o.tryLoc)return r("end");if(o.tryLoc<=this.prev){var l=i.call(o,"catchLoc"),u=i.call(o,"finallyLoc");if(l&&u){if(this.prev<o.catchLoc)return r(o.catchLoc,!0);if(this.prev<o.finallyLoc)return r(o.finallyLoc)}else if(l){if(this.prev<o.catchLoc)return r(o.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return r(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var r=this.tryEntries[n];if(r.tryLoc<=this.prev&&i.call(r,"finallyLoc")&&this.prev<r.finallyLoc){var a=r;break}}a&&("break"===e||"continue"===e)&&a.tryLoc<=t&&t<=a.finallyLoc&&(a=null);var o=a?a.completion:{};return o.type=e,o.arg=t,a?(this.method="next",this.next=a.finallyLoc,y):this.complete(o)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),y},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),N(n),y}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var i=r.arg;N(n)}return i}}throw new Error("illegal catch attempt")},delegateYield:function(e,n,r){return this.delegate={iterator:R(e),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=t),y}},n}function y(e,t,n,r,i,a,o){try{var s=e[a](o),l=s.value}catch(u){return void n(u)}s.done?t(l):Promise.resolve(l).then(r,i)}function b(e){return function(){var t=this,n=arguments;return new Promise((function(r,i){var a=e.apply(t,n);function o(e){y(a,r,i,o,s,"next",e)}function s(e){y(a,r,i,o,s,"throw",e)}o(void 0)}))}}function w(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function k(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,S(r.key),r)}}function x(e,t,n){return t&&k(e.prototype,t),n&&k(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function C(e,t,n){return(t=S(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function S(t){var n=function(t,n){if("object"!==e(t)||null===t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var i=r.call(t,n||"default");if("object"!==e(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===n?String:Number)(t)}(t,"string");return"symbol"===e(n)?n:String(n)}System.register(["vue","@ibiz-template/runtime","@ibiz-template/vue3-util","@wangeditor/editor-for-vue","@wangeditor/editor","qx-util","ramda","@ibiz-template/core","element-plus","lodash-es"],(function(e,o){"use strict";var s,l,d,p,m,y,k,S,E,O,M,P,L,A,N,T,R,I,F,H,D,z,U,j,B,V,q,_,J,K,Z,$,G,Q,W,Y,X,ee,te,ne,re,ie,ae,oe,se,le,ue,ce,de,ve,fe;return{setters:[function(e){s=e.defineComponent,l=e.ref,d=e.shallowRef,p=e.watch,m=e.onBeforeUnmount,y=e.onMounted,k=e.nextTick,S=e.createVNode,E=e.resolveComponent,O=e.createTextVNode,M=e.onUnmounted,P=e.computed,L=e.withDirectives,A=e.resolveDirective,N=e.h,T=e.defineAsyncComponent},function(e){R=e.ScriptFactory,I=e.convertNavData,F=e.EditorController,H=e.ControllerEvent,D=e.getDeACMode,z=e.registerEditorProvider},function(e){U=e.getHtmlProps,j=e.getEditorEmits,B=e.useNamespace,V=e.useClickOutside,q=e.withInstall},function(e){_=e.Editor,J=e.Toolbar},function(e){K=e.SlateEditor,Z=e.SlateElement,$=e.SlateRange,G=e.SlateTransforms,Q=e.SlateNode,W=e.SlateText,Y=e.Boot,X=e.DomEditor,ee=e.createEditor},function(e){te=e.getCookie,ne=e.createUUID},function(e){re=e.isNil},function(e){ie=e.CoreConst,ae=e.debounce,oe=e.awaitTimeout,se=e.RuntimeError,le=e.listenJSEvent,ue=e.NOOP,ce=e.downloadFileFromBlob},function(e){de=e.ElMessageBox},function(e){ve=e.debounce,fe=e.toNumber}],execute:function(){var he=function(){function e(t,n){w(this,e),C(this,"modalOrPanel",void 0),C(this,"htmlRef",void 0),this.modalOrPanel=t,this.htmlRef=n,this.calcModalPosition(),window.addEventListener("resize",this.handleResize.bind(this))}return x(e,[{key:"calcModalPosition",value:function(){if(["dropPanel","selectList"].includes(this.modalOrPanel.type)){var e=this.modalOrPanel.$elem[0],t=this.htmlRef.$el,n=t.querySelector(".w-e-bar"),r=e.previousElementSibling,i=r.getAttribute("data-menu-key"),a=e.parentNode.parentNode.parentNode;if(["bgColor","color","headerSelect"].includes(i)&&t&&n&&r&&"true"!==a.getAttribute("data-w-e-toolbar")){var o=e.clientWidth,s=e.clientHeight,l=n.clientHeight,u=r.getBoundingClientRect(),c=u.bottom,d=u.right,v=u.top,f=u.left,h="".concat(v+l,"px"),p="".concat(f,"px"),m="".concat(c-s-l,"px"),g="".concat(d-o,"px"),y={position:"fixed",left:p,top:h},b=window.innerWidth,w=window.innerHeight;b-f<o&&Object.assign(y,{left:g}),w-v-l<s&&Object.assign(y,{top:m}),Object.assign(e.style,{top:"",bottom:"",left:"",right:""}),Object.assign(e.style,y)}}}},{key:"handleResize",value:function(){this.calcModalPosition()}},{key:"destroy",value:function(){window.removeEventListener("resize",this.handleResize)}}]),e}(),pe=s({name:"IBizHtmlContent",props:U(),emits:j(),setup:function(e,t){var n=t.emit,r=B("html"),i=e.controller,a=l(),s=l({}),u=0,c=l(),v=l(),w=d(),x=l(),M=l(""),P=l({Authorization:"Bearer ".concat(te(ie.TOKEN))}),L=l(""),A=l(""),N=l(!0),T=l(!1),I=l(!1),F=l(!1),H=l(!1),D=l(""),z=l([]),U=l(!1),j=i.model;j.editorParams&&(j.editorParams.enableEdit&&(T.value=!0,I.value=!0,N.value=i.toBoolean(j.editorParams.enableEdit)&&!e.readonly&&!e.disabled),j.editorParams.enableFullScreen&&(F.value=i.toBoolean(j.editorParams.enableFullScreen)));var V=function(e){if(w.value){var t=e.eventArg;t&&(w.value.setHtml(t),w.value.focus(!0),n("focus"))}},q=function(){w.value&&(w.value.blur(),w.value.setHtml(""))},$=function(){w.value&&(w.value.focus(!0),n("focus"))};i.evt.on("setHtml",V),i.evt.on("clear",q),i.evt.on("onSetReply",$),p((function(){return e.data}),(function(e){if(e){var t=ibiz.util.file.calcFileUpDownUrl(i.context,i.params,e);L.value=t.uploadUrl,A.value=t.downloadUrl}}),{immediate:!0,deep:!0});var G=function(e,t){if(t)return!0},Q=function(e){return e},W={toolbarKeys:[{key:"group-add-style",title:"添加",iconSvg:'<svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" fit="" height="1em" width="1em" preserveAspectRatio="xMidYMid meet" focusable="false"><g id="arvaction/plus-circle-fill" stroke-width="1" fill-rule="evenodd"><path d="M8 16A8 8 0 1 1 8 0a8 8 0 0 1 0 16zm-.6-8.6H4v1.2h3.4V12h1.2V8.6H12V7.4H8.6V4H7.4v3.4z" id="arv形状结合"></path></g></svg>',menuKeys:["attachments","codesnippet","page"]},"|",{key:"group-inline-style",title:"文本格式",iconSvg:'<svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" fit="" height="1em" width="1em" preserveAspectRatio="xMidYMid meet" focusable="false"><g id="ahdeditor/color-tt" stroke-width="1" fill-rule="evenodd"><path id="ahdsecondary-color" d="M1.999 15.011h11.998V13.81H1.999z"></path><path d="M6.034 7.59h4.104L8.086 2.297 6.034 7.59zm-.465 1.2l-1.437 3.707H2.845L7.301 1h1.287l-.001.004h.286l4.454 11.492h-1.288L10.603 8.79H5.569z" id="ahd合并形状"></path></g></svg>',menuKeys:["bold","italic","underline","through","code","numberedList","bulletedList","insertLink"]},"codeBlock","mention","marker","emotion"]};i.chatCompletion&&W.toolbarKeys.push("aichart");var Y,X={placeholder:i.placeHolder,readOnly:T.value?I.value:e.readonly,MENU_CONF:{uploadImage:{server:L.value,fieldName:"file",maxFileSize:10485760,maxNumberOfFiles:10,allowedFileTypes:[],headers:P.value,withCredentials:!0,onBeforeUpload:function(e){return e},onProgress:function(e){console.log("progress",e)},onSuccess:function(e,t){console.log("".concat(e.name," 上传成功"),t)},onFailed:function(e,t){console.log("".concat(e.name," 上传失败"),t)},onError:function(e,t,n){console.log("".concat(e.name," 上传出错"),t,n)},customInsert:function(e,t){return b(g().mark((function n(){var r,i;return g().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:r=A.value.replace("%fileId%",e.id),i=e.filename,t(r,i,"");case 3:case"end":return n.stop()}}),n)})))()}},insertLink:{checkLink:G,parseLinkUrl:Q},editLink:{checkLink:G,parseLinkUrl:Q}}},ee=function(){var e=b(g().mark((function e(t){var n,r,i,a,o,s,l;return g().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.src,I.value)ae(n);else if(r=K.nodes(w.value,{match:function(e){return!(!Z.isElement(e)||"image"!==e.type)},universal:!0}),r){i=h(r);try{for(i.s();!(a=i.n()).done;)o=a.value,s=f(o,1),"image"===(l=s[0]).type&&n.endsWith(l.src)&&ae(l.src)}catch(u){i.e(u)}finally{i.f()}}case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),ae=function(){var e=b(g().mark((function e(t){var n;return g().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return D.value=t,z.value=[t],e.next=4,k();case 4:x.value&&(n=x.value.$refs.container)&&n.children[0].click();case 5:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),oe=function(e){if(x.value){var t=x.value.$refs.container;if(t){var n=t.querySelector(".el-image-viewer__wrapper");null==n||n[e]("keydown",se)}}},se=function(){var e=b(g().mark((function e(t){return g().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("Escape"!==t.key&&27!==t.keyCode){e.next=7;break}return t.stopPropagation(),t.preventDefault(),e.next=5,k();case 5:oe("removeEventListener"),z.value=[];case 7:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),le=function(){var e=b(g().mark((function e(){return g().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,k();case 2:oe("addEventListener");case 3:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),ue=function(){var t=b(g().mark((function t(){var r,a,s,l,u;return g().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!i.deService){t.next=11;break}return t.next=3,o.import("@ibiz-template-plugin/ai-chat");case 3:return a=t.sent,s=a.chat||a.default.chat,Y=s,l=s.create({question:function(){var e=b(g().mark((function e(t){var n,r;return g().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=ne(),e.next=3,null===(n=i.deService)||void 0===n?void 0:n.aiChatSse((function(e){if(ibiz.log.info("aiChatSse",e),20===e.actionstate&&e.actionresult)l.addMessage({messageid:r,state:e.actionstate,type:"DEFAULT",role:"ASSISTANT",content:e.actionresult});else if(30===e.actionstate&&e.actionresult){var t=JSON.parse(e.actionresult).choices;t&&t.length>0&&l.replaceMessage({messageid:r,state:e.actionstate,type:"DEFAULT",role:"ASSISTANT",content:t[0].content||""})}else 40===e.actionstate&&l.replaceMessage({messageid:r,state:e.actionstate,type:"ERROR",role:"ASSISTANT",content:e.actionresult})}),i.context,{},{messages:t});case 3:return l.addMessage({messageid:r,state:10,type:"DEFAULT",role:"ASSISTANT",content:""}),e.abrupt("return",!0);case 5:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),action:function(e,t){"backfill"===e&&(n("change",t.content),U.value=!0)},closed:function(){w.value&&e.value&&w.value&&w.value.focus(!0)}}),t.next=9,null===(r=i.deService)||void 0===r?void 0:r.aiChatHistory(i.context,{});case 9:(u=t.sent).data&&Array.isArray(u.data)&&u.data.forEach((function(e){var t={messageid:ne(),state:30,type:"DEFAULT",role:e.role,content:e.content};l.addMessage(t)}));case 11:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}();m((function(){Y&&Y.close();var e=w.value;null!=e&&e.destroy()}));var ce=function(t){var n;w.value=t,t.on("modalOrPanelShow",(function(e){n=new he(e,v.value)})),t.on("modalOrPanelHide",(function(){n&&n.destroy()})),t.setHtml(M.value),t.on("aiClick",(function(){ue()})),i.onCreated(w.value,e.data,W)},ve=function(t){var r=t.getHtml();!function(e){var t=e.getEditableContainer();t&&t.querySelectorAll("img").forEach((function(e){e.onclick=function(e){var t=e.target;t&&ee(t)}}))}(t);var a="<p><br></p>"===r?"":r;a===e.value||""===a&&re(e.value)||T.value||(a=a.replaceAll('class="rich-html-table"',"").replace(/<table/g,'<table class="rich-html-table"'),n("change",a),i.evt.emit("onChange",{eventArg:a}))},fe=function(e){i.evt.off("setHtml",V),i.evt.off("clear",q),i.evt.off("onSetReply",$)},pe=function(){n("focus"),i.evt.emit("onFocus",{eventArg:e.value})},me=function(){n("blur"),i.evt.emit("onBlur",{eventArg:e.value})},ge=function(e,t){alert("【自定义提示】".concat(t," - ").concat(e))},ye=function(e,t,n){n(!0)},be=function(){var e=w.value;null!=e&&e.disable()},we=function(){var e=w.value;null!=e&&e.enable()},ke=function(){I.value=!I.value,I.value?be():(we(),w.value.focus(),function(){if(e.value){var t=e.value.indexOf("</p>");if(t>=0){var n,r,i=null===(n=w.value.selection.anchor)||void 0===n?void 0:n.offset,a=null===(r=w.value.selection.anchor)||void 0===r?void 0:r.path;0===i&&a.length>0&&0===a[0]&&w.value.move(t-3)}}}())},xe=function(){H.value=!H.value,k((function(){I.value?be():(we(),w.value.focus())}))},Ce=function(){if(i.reply.value){var e=R.execScriptFn({value:i.reply.value},i.replyScript,{singleRowReturn:!0,isAsync:!1});return S("div",{class:r.b("reply")},[S("div",{class:r.be("reply","content"),innerHTML:e},null),S(E("ion-icon"),{name:"close-outline",onClick:function(){return i.removeReply()}},null)])}};return y((function(){!function(){if(a.value&&c.value){var e=a.value.offsetHeight;new ResizeObserver((function(t){var n=t[0].contentRect.height;if(n!==u){var i={height:"".concat(e-t[0].contentRect.height,"px")};s.value=r.cssVarBlock(i),u=n}})).observe(c.value.selector)}}(),p((function(){return e.value}),(function(t,n){t===n||"string"!=typeof e.value&&null!=t||(M.value=null==t?"":t,U.value&&(w.value&&k((function(){w.value.focus(!0)})),U.value=!1))}),{immediate:!0}),p((function(){return e.disabled}),(function(e,t){e!==t&&(!0===e?be():we())}),{immediate:!0})})),{ns:r,editorRef:w,previewRef:x,mode:"default",valueHtml:M,toolbarConfig:W,editorConfig:X,handleCreated:ce,handleChange:ve,handleDestroyed:fe,handleFocus:pe,handleBlur:me,customAlert:ge,customPaste:ye,insertText:function(e){var t=w.value;null!=t&&t.insertText(e)},printHtml:function(){var e=w.value;null!=e&&console.log(e.getHtml())},disable:be,enable:we,renderHeaserToolbar:function(){return T.value||F.value?S("div",{class:r.b("custom-toolbar")},[T.value&&N.value&&I.value?S("i",{class:"fa fa-edit","aria-hidden":"true",onClick:function(){return ke()}},null):null,F.value?H.value?S("i",{class:"fa fa-compress","aria-hidden":"true",onClick:function(){return xe()}},null):S("i",{class:"fa fa-expand","aria-hidden":"true",onClick:function(){return xe()}},null):null]):null},renderEditorContent:function(){return i.hidden.value?null:S("div",{class:r.b("content"),ref:"htmlContent",style:s.value},[S(_,{ref:"htmlRef",class:r.b("editor"),modelValue:M.value,"onUpdate:modelValue":function(e){return M.value=e},"default-config":X,mode:"default",onOnCreated:ce,onOnChange:ve,onOnDestroyed:fe,onOnFocus:pe,onOnBlur:me,oncustomAlert:ge,oncustomPaste:ye},null),Ce(),S(J,{ref:"toolbarRef",editor:w.value,"default-config":W,mode:"default",class:r.b("toolbar")},null)])},renderFooter:function(){return T.value?S("div",{class:[r.b("footer"),C({},r.b("footer-dialog"),H.value)]},[S("div",{class:r.be("footer","cancel"),onClick:function(){e.value!==M.value?de({title:"确认取消",type:"warning",customClass:r.b("message"),message:S("div",{class:r.be("message","message-content")},[S("p",null,[O("确定要取消编辑吗？")]),S("p",{class:r.bem("message","message-content","message-tip")},[O("取消编辑将无法保存修改的内容，且不能找回。")])]),showCancelButton:!0,cancelButtonClass:r.be("message","message-cancel"),confirmButtonClass:r.be("message","message-comfire")}).then((function(){if(e.value){var t=i.parseNode(e.value);M.value=t}else M.value="";ke()})).catch((function(){w.value.focus()})):ke()}},[O("取消")]),S("div",{class:r.be("footer","save"),onClick:function(){return function(){I.value=!0,w.value.disable();var e=M.value.replaceAll('class="rich-html-table"',"").replace(/<table/g,'<table class="rich-html-table"');n("change",e),H.value&&(H.value=!1)}()}},[O("保存")])]):null},htmlContent:a,hasEnableEdit:T,cssVars:s,toolbarRef:c,htmlRef:v,isFullScreen:H,readonlyState:I,changeFullScreenState:xe,renderPreview:function(){return S(E("el-image"),{class:r.e("preview"),ref:"previewRef","zoom-rate":1.1,src:D.value,"preview-src-list":z.value,"hide-on-click-modal":!0,onShow:le,fit:"cover"},null)}}},render:function(){var e=this;return this.isFullScreen?S(E("el-dialog"),{modelValue:this.isFullScreen,"onUpdate:modelValue":function(t){return e.isFullScreen=t},width:"80%",top:"10vh",class:this.ns.b("dialog-full-screen"),onClose:function(){return e.changeFullScreenState()}},{default:function(){return[S("div",{class:[e.ns.b(),C({},e.ns.b("editor-readonly"),e.readonlyState)]},[e.renderHeaserToolbar(),e.renderEditorContent(),e.hasEnableEdit&&!e.readonlyState?e.renderFooter():null])]}}):S("div",{class:[this.ns.b(),C({},this.ns.b("editor-readonly"),this.readonlyState)]},[this.renderHeaserToolbar(),this.renderEditorContent(),this.renderPreview(),this.hasEnableEdit&&!this.readonlyState?this.renderFooter():null])}}),me=Object.freeze(Object.defineProperty({__proto__:null,default:pe},Symbol.toStringTag,{value:"Module"})),ge=["headerSelect","blockquote","|","bold","underline","italic",{key:"group-more-style",title:"更多",iconSvg:'<svg viewBox="0 0 1024 1024"><path d="M204.8 505.6m-76.8 0a76.8 76.8 0 1 0 153.6 0 76.8 76.8 0 1 0-153.6 0Z"></path><path d="M505.6 505.6m-76.8 0a76.8 76.8 0 1 0 153.6 0 76.8 76.8 0 1 0-153.6 0Z"></path><path d="M806.4 505.6m-76.8 0a76.8 76.8 0 1 0 153.6 0 76.8 76.8 0 1 0-153.6 0Z"></path></svg>',menuKeys:["through","code","sup","sub","clearStyle"]},"color","bgColor","|","fontSize","fontFamily","lineHeight","|","bulletedList","numberedList","todo",{key:"group-justify",title:"对齐",iconSvg:'<svg viewBox="0 0 1024 1024"><path d="M768 793.6v102.4H51.2v-102.4h716.8z m204.8-230.4v102.4H51.2v-102.4h921.6z m-204.8-230.4v102.4H51.2v-102.4h716.8zM972.8 102.4v102.4H51.2V102.4h921.6z"></path></svg>',menuKeys:["justifyLeft","justifyRight","justifyCenter","justifyJustify"]},{key:"group-indent",title:"缩进",iconSvg:'<svg viewBox="0 0 1024 1024"><path d="M0 64h1024v128H0z m384 192h640v128H384z m0 192h640v128H384z m0 192h640v128H384zM0 832h1024v128H0z m0-128V320l256 192z"></path></svg>',menuKeys:["indent","delIndent"]},"|","emotion","insertLink",{key:"group-image",title:"图片",iconSvg:'<svg viewBox="0 0 1024 1024"><path d="M959.877 128l0.123 0.123v767.775l-0.123 0.122H64.102l-0.122-0.122V128.123l0.122-0.123h895.775zM960 64H64C28.795 64 0 92.795 0 128v768c0 35.205 28.795 64 64 64h896c35.205 0 64-28.795 64-64V128c0-35.205-28.795-64-64-64zM832 288.01c0 53.023-42.988 96.01-96.01 96.01s-96.01-42.987-96.01-96.01S682.967 192 735.99 192 832 234.988 832 288.01zM896 832H128V704l224.01-384 256 320h64l224.01-192z"></path></svg>',menuKeys:["insertImage","uploadImage"]},{key:"group-video",title:"视频",iconSvg:'<svg viewBox="0 0 1024 1024"><path d="M981.184 160.096C837.568 139.456 678.848 128 512 128S186.432 139.456 42.816 160.096C15.296 267.808 0 386.848 0 512s15.264 244.16 42.816 351.904C186.464 884.544 345.152 896 512 896s325.568-11.456 469.184-32.096C1008.704 756.192 1024 637.152 1024 512s-15.264-244.16-42.816-351.904zM384 704V320l320 192-320 192z"></path></svg>',menuKeys:["insertVideo","uploadVideo"]},"insertTable","codeBlock","divider","|","undo","redo"],ye=/<span class='personnel-marker'>(.*?)<\/span>/,be=s({name:"IBizHtmlCollapse",props:U(),emits:j(),setup:function(e,t){var n,r=t.emit,i=B("html"),a=e.controller,s=l(),u=l({}),c=null,w=0,x=l(),P=d(),L=l(),A=l(),N=l(),T=l(""),R=l({Authorization:"Bearer ".concat(te(ie.TOKEN))}),I=l(""),F=l(""),H=l(!0),D=l(!1),z=l(!1),U=l(!1),j=l(!1),q=l(!0),$=l(!1),G=l(""),Q=l(!1),W=l([]),Y=a.model;Y.editorParams&&(Y.editorParams.enableEdit&&(D.value=!0,z.value=!0,H.value=a.toBoolean(Y.editorParams.enableEdit)&&!e.readonly&&!e.disabled),Y.editorParams.enableFullScreen&&(U.value=a.toBoolean(Y.editorParams.enableFullScreen))),e.readonly&&(D.value=!1,z.value=!0),p((function(){return e.data}),(function(e){if(e){var t=ibiz.util.file.calcFileUpDownUrl(a.context,a.params,e,a.editorParams);I.value=t.uploadUrl,F.value=t.downloadUrl}}),{immediate:!0,deep:!0});var X,ee=function(e,t){if(t)return!0},se=function(e){return e};m((function(){var e=P.value;null!=e&&e.destroy()}));var le=function(){var e=b(g().mark((function e(){var t,n,i,s,l;return g().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!a.deService){e.next=11;break}return e.next=3,o.import("@ibiz-template-plugin/ai-chat");case 3:return n=e.sent,i=n.chat||n.default.chat,X=i,s=i.create({question:function(){var e=b(g().mark((function e(t){var n,r;return g().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=ne(),e.next=3,null===(n=a.deService)||void 0===n?void 0:n.aiChatSse((function(e){if(ibiz.log.info("aiChatSse",e),20===e.actionstate&&e.actionresult)s.addMessage({messageid:r,state:e.actionstate,type:"DEFAULT",role:"ASSISTANT",content:e.actionresult});else if(30===e.actionstate&&e.actionresult){var t=JSON.parse(e.actionresult).choices;t&&t.length>0&&s.replaceMessage({messageid:r,state:e.actionstate,type:"DEFAULT",role:"ASSISTANT",content:t[0].content||""})}else 40===e.actionstate&&s.replaceMessage({messageid:r,state:e.actionstate,type:"ERROR",role:"ASSISTANT",content:e.actionresult})}),a.context,{},{messages:t});case 3:return s.addMessage({messageid:r,state:10,type:"DEFAULT",role:"ASSISTANT",content:""}),e.abrupt("return",!0);case 5:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),action:function(e,t){"backfill"===e&&(D.value?T.value=t.content:r("change",t.content),Q.value=!0)},closed:function(){P.value&&P.value.focus(!0)}}),e.next=9,null===(t=a.deService)||void 0===t?void 0:t.aiChatHistory(a.context,{});case 9:(l=e.sent).data&&Array.isArray(l.data)&&l.data.forEach((function(e){var t={messageid:ne(),state:30,type:"DEFAULT",role:e.role,content:e.content};s.addMessage(t)}));case 11:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),ue={toolbarKeys:ge};a.chatCompletion&&(ue.insertKeys={index:60,keys:["|","aichart"]}),a.insertKeys.length>0&&ue.toolbarKeys&&a.insertKeys.forEach((function(e){e.keys&&e.keys.forEach((function(t,n){ue.toolbarKeys.includes(t)||ue.toolbarKeys.splice(e.index+n,0,t)}))}));var ce={placeholder:a.placeHolder,readOnly:D.value?z.value:e.readonly,MENU_CONF:{uploadImage:{server:I.value,fieldName:"file",maxFileSize:10485760,maxNumberOfFiles:10,allowedFileTypes:[],headers:R.value,withCredentials:!0,onBeforeUpload:function(e){return e},onProgress:function(e){console.log("progress",e)},onSuccess:function(e,t){console.log("".concat(e.name," 上传成功"),t)},onFailed:function(e,t){console.log("".concat(e.name," 上传失败"),t)},onError:function(e,t,n){console.log("".concat(e.name," 上传出错"),t,n)},customInsert:function(e,t){return b(g().mark((function n(){var r,i;return g().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:r=F.value.replace("%fileId%",e.id),i=e.filename,t(r,i,"");case 3:case"end":return n.stop()}}),n)})))()}},insertLink:{checkLink:ee,parseLinkUrl:se},editLink:{checkLink:ee,parseLinkUrl:se}}};m((function(){var e=P.value;null!=e&&e.destroy()}));var ve=function(){var e=b(g().mark((function e(t){var n;return g().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:a.maxHeight&&(n=t.getEditableContainer(),$.value=n.offsetHeight>a.maxHeight);case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),fe=function(){var e=b(g().mark((function e(t){var n,r,i,a,o,s,l;return g().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.src,z.value)pe(n);else if(r=K.nodes(P.value,{match:function(e){return!(!Z.isElement(e)||"image"!==e.type)},universal:!0}),r){i=h(r);try{for(i.s();!(a=i.n()).done;)o=a.value,s=f(o,1),"image"===(l=s[0]).type&&n.endsWith(l.src)&&pe(l.src)}catch(u){i.e(u)}finally{i.f()}}case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),pe=function(){var e=b(g().mark((function e(t){var n;return g().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return G.value=t,W.value=[t],e.next=4,k();case 4:A.value&&(n=A.value.$refs.container)&&n.children[0].click();case 5:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),me=function(e){if(A.value){var t=A.value.$refs.container;if(t){var n=t.querySelector(".el-image-viewer__wrapper");null==n||n[e]("keydown",be)}}},be=function(){var e=b(g().mark((function e(t){return g().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("Escape"!==t.key&&27!==t.keyCode){e.next=7;break}return t.stopPropagation(),t.preventDefault(),e.next=5,k();case 5:me("removeEventListener"),W.value=[];case 7:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),we=function(){var e=b(g().mark((function e(){return g().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,k();case 2:me("addEventListener");case 3:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),ke=function(){var t=T.value;if(t=t.replace(ye,"").replaceAll('class="rich-html-table"',"").replace(/<table/g,'<table class="rich-html-table"'),"JSON"===a.renderMode){var n=P.value;t=a.toJson(n.children)}e.value!==t&&r("change",t)},xe=ae(ke,a.saveInterval),Ce=function(t){P.value=t,a.onCreated(P.value,e.data,ue);var n,r=a.parseNode(T.value);t.setHtml(r),t.on("modalOrPanelShow",(function(e){n=new he(e,L.value)})),t.on("modalOrPanelHide",(function(){n&&n.destroy()})),t.on("aiClick",(function(){le()}))},Se=function(t){var n=t.getHtml().replace(ye,"");ve(t),function(e){var t=e.getEditableContainer();t&&t.querySelectorAll("img").forEach((function(t){t.onload=function(){ve(e)},t.onclick=function(e){var t=e.target;t&&fe(t)}}))}(t);var r="<p><br></p>"===n?"":n;r===e.value||""===r&&re(e.value)||(r=r.replaceAll('class="rich-html-table"',"").replace(/<table/g,'<table class="rich-html-table"'),!D.value&&t.isFocused()&&("AUTOMATIC"===a.emitMode?xe():ke()),a.evt.emit("onChange",{eventArg:r}))},Ee=function(e){},Oe=function(t){r("focus"),a.evt.emit("onFocus",{eventArg:e.value})},Me=function(t){r("blur"),a.evt.emit("onBlur",{eventArg:e.value})},Pe=function(e,t){alert("【自定义提示】".concat(t," - ").concat(e))},Le=function(e,t,n){n(!0)},Ae=function(){var e=P.value;null!=e&&e.disable()},Ne=function(){var e=P.value;null!=e&&e.enable()},Te=function(){if(z.value=!z.value,z.value){if(L.value)L.value.$refs.box.scroll(0,0);Ae()}else Ne(),P.value.focus(),function(){if(e.value){var t=e.value.indexOf("</p>");if(t>=0){var n,r,i=null===(n=P.value.selection.anchor)||void 0===n?void 0:n.offset,a=null===(r=P.value.selection.anchor)||void 0===r?void 0:r.path;0===i&&a.length>0&&0===a[0]&&P.value.move(t-3)}}}(),q.value=!0},Re=function(){j.value=!j.value,q.value=!j.value,k((function(){z.value?Ae():(Ne(),P.value.focus())}))};return y((function(){N.value&&(n=V(N,b(g().mark((function e(){return g().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:P.value&&P.value.emit("clickOutside");case 1:case"end":return e.stop()}}),e)}))))),oe(0,(function(){if(s.value&&x.value){var e=s.value.offsetHeight;(c=new ResizeObserver((function(t){var n=t[0].contentRect.height;if(n!==w){var r={height:"".concat(e-t[0].contentRect.height,"px")};u.value=i.cssVarBlock(r),w=n}}))).observe(x.value.selector)}})),p((function(){return e.value}),(function(t,n){t===n||"string"!=typeof e.value&&null!=t||(null==t?T.value="":T.value||("JSON"===a.renderMode?T.value=a.jsonToHtml(t):T.value=t),Q.value&&(P.value&&k((function(){P.value.focus(!0)})),Q.value=!1))}),{immediate:!0}),p((function(){return e.disabled}),(function(e,t){e!==t&&(!0===e?Ae():Ne())}),{immediate:!0})})),M((function(){c&&c.disconnect(),n&&n.stop&&n.stop(),X&&X.close()})),{ns:i,editorRef:P,previewRef:A,containerRef:N,htmlRef:L,mode:"default",valueHtml:T,toolbarConfig:ue,editorConfig:ce,handleCreated:Ce,handleChange:Se,handleDestroyed:Ee,handleFocus:Oe,handleBlur:Me,customAlert:Pe,customPaste:Le,insertText:function(e){var t=P.value;null!=t&&t.insertText(e)},printHtml:function(){P.value},disable:Ae,enable:Ne,renderHeaserToolbar:function(){return D.value||U.value?S("div",{class:i.b("custom-toolbar")},[D.value&&H.value&&z.value?S("i",{class:"fa fa-edit","aria-hidden":"true",onClick:function(){return Te()}},null):null,U.value?j.value?S("i",{class:"fa fa-compress","aria-hidden":"true",onClick:function(){return Re()}},null):S("i",{class:"fa fa-expand","aria-hidden":"true",onClick:function(){return Re()}},null):null]):null},renderEditorContent:function(){var e=v({},u.value);return q.value&&a.maxHeight&&Object.assign(e,{maxHeight:"".concat(a.maxHeight,"px")}),S("div",{class:[i.b("content"),i.is("readonly",z.value)],ref:"htmlContent",style:e},[S(J,{ref:"toolbarRef",editor:P.value,"default-config":ue,mode:"default",class:i.b("toolbar")},null),S(_,{ref:"htmlRef",class:i.b("editor"),modelValue:T.value,"onUpdate:modelValue":function(e){return T.value=e},"default-config":ce,mode:"default",onOnCreated:Ce,onOnChange:Se,onOnDestroyed:Ee,onOnFocus:Oe,onOnBlur:Me,oncustomAlert:Pe,oncustomPaste:Le},null)])},renderToggle:function(){return $.value?q.value?S("div",{class:i.e("toggle"),onClick:function(){q.value=!q.value}},[O("展开更多 "),S(E("ion-icon"),{name:"arrow-down-outline"},null)]):S("div",{class:i.e("toggle"),onClick:function(){q.value=!q.value}},[O("收起更多 "),S(E("ion-icon"),{name:"arrow-up-outline"},null)]):null},renderFooter:function(){return D.value&&"AUTOMATIC"!==a.emitMode?S("div",{class:[i.b("footer"),C({},i.b("footer-dialog"),j.value)]},[S("div",{class:i.be("footer","cancel"),onClick:function(){e.value!==T.value?de({title:"确认取消",type:"warning",customClass:i.b("message"),message:S("div",{class:i.be("message","message-content")},[S("p",null,[O("确定要取消编辑吗？")]),S("p",{class:i.bem("message","message-content","message-tip")},[O("取消编辑将无法保存修改的内容，且不能找回。")])]),showCancelButton:!0,cancelButtonClass:i.be("message","message-cancel"),confirmButtonClass:i.be("message","message-comfire")}).then((function(){if(e.value){var t=a.parseNode(e.value);T.value=t}else T.value="";Te()})).catch((function(){P.value.focus()})):Te()}},[O("取消")]),S("div",{class:i.be("footer","save"),onClick:function(){return function(){z.value=!0,P.value.disable();var e=T.value.replace(ye,"").replaceAll('class="rich-html-table"',"").replace(/<table/g,'<table class="rich-html-table"');"JSON"!==a.renderMode&&r("change",e),j.value&&(j.value=!1)}()}},[O("保存")])]):null},htmlContent:s,hasEnableEdit:D,cssVars:u,toolbarRef:x,isFullScreen:j,readonlyState:z,collapse:q,changeFullScreenState:Re,renderPreview:function(){return S(E("el-image"),{class:i.e("preview"),ref:"previewRef","zoom-rate":1.1,src:G.value,"preview-src-list":W.value,"hide-on-click-modal":!0,onShow:we,fit:"cover"},null)}}},render:function(){var e=this;return this.isFullScreen?S(E("el-dialog"),{modelValue:this.isFullScreen,"onUpdate:modelValue":function(t){return e.isFullScreen=t},width:"80%",top:"10vh",class:this.ns.b("dialog-full-screen"),onClose:function(){return e.changeFullScreenState()}},{default:function(){return[S("div",{ref:"containerRef",class:[e.ns.b(),e.ns.b("collapse"),C({},e.ns.b("editor-readonly"),e.readonlyState)]},[e.renderHeaserToolbar(),e.renderEditorContent(),e.hasEnableEdit&&!e.readonlyState?e.renderFooter():null])]}}):S("div",{ref:"containerRef",class:[this.ns.b(),this.ns.is("allow-collapse",!0),C({},this.ns.b("editor-readonly"),this.readonlyState)]},[this.renderHeaserToolbar(),this.renderEditorContent(),this.readonlyState?this.renderToggle():null,this.hasEnableEdit&&!this.readonlyState?this.renderFooter():null,this.renderPreview()])}}),we=function(){function e(){w(this,e)}return x(e,null,[{key:"getThemeVar",value:function(){var e=document.documentElement;return e?getComputedStyle(e).getPropertyValue("--ibiz-color-primary"):null}},{key:"isChineseCharacter",value:function(e){return/[\u4e00-\u9fa5]/.test(e)}},{key:"hasChineseAndEnglish",value:function(e){return/[\u4e00-\u9fa5]+.*[a-zA-Z]+|[a-zA-Z]+.*[\u4e00-\u9fa5]+/.test(e)}},{key:"stringToHexColor",value:function(e){if(!e)return"";for(var t=0,n=0;n<e.length;n++){if(this.isChineseCharacter(e))t=e.charCodeAt(n)+((t<<5)-t),t&=t;else t+=e.charCodeAt(n).toString(16)}var r=String(t).substring(0,6),i=parseInt(r.substring(0,2),16),a=parseInt(r.substring(2,4),16),o=parseInt(r.substring(4,6),16),s="#".concat(i.toString(16).padStart(2,"0")).concat(a.toString(16).padStart(2,"0")).concat(o.toString(16).padStart(2,"0"));return"#FFFFFF"===s&&this.getThemeVar()||s}},{key:"avatarName",value:function(e){if(e&&e.toString().length<2)return e;if(e&&e.toString().length>=2){if(this.hasChineseAndEnglish(e)){var t=e.split("").find((function(e){return/[a-zA-Z]/.test(e)}))||"",n=e.split("").find((function(e){return/[\u4E00-\u9FA5]/.test(e)}))||"";return"".concat(t).concat(n).toLowerCase()}return/[a-zA-Z]/.test(e)?e.split("").filter((function(e){return/[a-zA-Z]/.test(e)})).slice(0,2).join("").toUpperCase():/[\u4E00-\u9FA5]/.test(e)?e.split("").filter((function(e){return/[\u4E00-\u9FA5]/.test(e)})).slice(-2).join(""):e.replaceAll(" ","").substring(0,2)}}}]),e}();function ke(e,t){null==e.data&&(e.data={});var n=e.data;null==n.style&&(n.style={}),Object.assign(n.style,t)}var xe=function(){function e(){w(this,e)}return x(e,null,[{key:"addMarks",value:function(e,t){var n=t.selection,r=t.mark;if($.isExpanded(n))G.setNodes(e,r,{match:function(t,n){if(!W.isText(t))return!1;var r=f(K.parent(e,n),2),i=r[0];return r[1],!e.isVoid(i)},at:n,split:!0,voids:!0});else{var i=v(v({},K.marks(e)||{}),r);e.marks=i}}},{key:"removeMarks",value:function(e,t){var n=t.selection,r=t.keys;if($.isExpanded(n))G.unsetNodes(e,r,{match:function(t,n){if(!W.isText(t))return!1;var r=f(K.parent(e,n),2),i=r[0];return r[1],!e.isVoid(i)},at:n,split:!0,voids:!0});else{var i=v({},K.marks(e)||{});r.forEach((function(e){delete i[e]})),e.marks=i}}},{key:"movePersNode",value:function(e,t){var n=t.param,r=t.node,i=n.id,a=n.cursor,o=n.preCursor,s=a.position,l=a.newPosition,u=a.selectionRange;if(!u&&null!=o&&o.selectionRange){var c=o.selectionRange;this.removeMarks(e,{keys:["backgroundColor"],selection:{anchor:this.calcPointByOffset(e,c.anchor),focus:this.calcPointByOffset(e,c.focus)}})}if(s){var d=Q.parent(e,s.path).children.findIndex((function(e){return e.id===i}));d>-1&&G.removeNodes(e,{at:[s.path[0],d]})}if(l){u&&this.addMarks(e,{mark:{backgroundColor:we.stringToHexColor(i)},selection:{anchor:this.calcPointByOffset(e,u.anchor),focus:this.calcPointByOffset(e,u.focus)}});var v=this.calcPointByOffset(e,l);G.insertNodes(e,[r],{at:v})}}},{key:"calcPointByOffset",value:function(e,t){var n=Q.parent(e,t.path),r=0,i=0;n.children.forEach((function(e,n){W.isText(e)&&i<t.offset&&(i+=e.text.length||1,r=n)}));var a=n.children[r].text.length-(i-t.offset);return{path:[t.path[0],r],offset:a}}},{key:"calcOffsetByPoint",value:function(e,t){var n=t.offset,r=Q.parent(e,t.path),i=Q.get(e,t.path);return W.isText(i)&&0===i.text.length&&0===n&&(n=1),r.children.forEach((function(e,r){W.isText(e)&&r<t.path[1]&&(n+=e.text.length||1)})),n}}]),e}(),Ce=s({name:"HtmlComment",props:U(),emits:j(),setup:function(e,t){var n=t.emit,r=B("html-comment"),i=e.controller,a=l(),o=l(),s=l(!1),u=function(){s.value=!0};return{ns:r,c:i,comment:a,editorRef:o,onChange:function(e){n("change",e),e&&i.collapsed.value&&(i.collapsed.value=!1)},onFocus:function(){i.collapsed.value=!1,n("focus")},onBlur:function(){if(n("blur"),e.value)return null;i.collapsed.value=!0},renderAvatar:function(){if(i.userAvatar&&!s.value){var t=JSON.parse(i.userAvatar);if(0===t.length)return null;var n=ibiz.util.file.calcFileUpDownUrl(i.context,i.params,e.data,i.editorParams).downloadUrl.replace("%fileId%",t[0].id);return S("div",{class:r.e("avatar-name")},[S("img",{src:n,alt:"",onError:u},null)])}var a=we.stringToHexColor(i.context.srfusername),o=we.avatarName(i.context.srfusername);return i.context.srfusername?S("div",{class:r.e("avatar-name"),style:"background: ".concat(a,";")},[o]):S(E("el-avatar"),{class:r.e("avatar"),src:"./assets/images/user-avatar.png"},null)}}},render:function(){return"default"===this.c.mode?S(be,{controller:this.c,data:this.data,value:this.value,readonly:this.readonly,onChange:this.onChange,onFocus:this.onFocus,onBlur:this.onBlur},null):S("div",{ref:"comment",class:[this.ns.b(),this.ns.is("collapse",this.c.collapsed.value)],style:{height:"".concat(this.c.collapsed.value?this.c.minHeight:this.c.maxHeight,"px")}},[this.renderAvatar(),S(pe,{controller:this.c,data:this.data,value:this.value,onChange:this.onChange,onFocus:this.onFocus,onBlur:this.onBlur},null)])}});function Se(e,t,n,r,i){return{sel:e,data:t,children:n,text:r,elm:i,key:void 0===t?void 0:t.key}}var Ee=Array.isArray;function Oe(e){return"string"==typeof e||"number"==typeof e||e instanceof String||e instanceof Number}function Me(e,t,n){if(e.ns="http://www.w3.org/2000/svg","foreignObject"!==n&&void 0!==t)for(var r=0;r<t.length;++r){var i=t[r];if("string"!=typeof i){var a=i.data;void 0!==a&&Me(a,i.children,i.sel)}}}function Pe(e,t,n){var r,i,a,o={};if(void 0!==n?(null!==t&&(o=t),Ee(n)?r=n:Oe(n)?i=n.toString():n&&n.sel&&(r=[n])):null!=t&&(Ee(t)?r=t:Oe(t)?i=t.toString():t&&t.sel?r=[t]:o=t),void 0!==r)for(a=0;a<r.length;++a)Oe(r[a])&&(r[a]=Se(void 0,void 0,void 0,r[a],void 0));return"s"!==e[0]||"v"!==e[1]||"g"!==e[2]||3!==e.length&&"."!==e[3]&&"#"!==e[3]||Me(o,r,e),Se(e,o,r,i,void 0)}var Le={type:"attachments",elemToHtml:function(e){var t=e.script,n=void 0===t?"":t,r=e.data,i=void 0===r?{}:r,a=R.execScriptFn({data:i},n,{singleRowReturn:!0,isAsync:!1});return"".concat(a)}};var Ae={selector:'span[data-w-e-type="attachments"]',parseElemHtml:function(e){var t=decodeURIComponent(e.getAttribute("data-value")||""),n=JSON.parse(t);return{type:"attachments",script:n.script,data:n,children:[{text:""}]}}};var Ne={type:"attachments",renderElem:function(e){var t=e.data,n=void 0===t?{}:t,r={name:"".concat(n.name),id:n.id};return Pe("mention-elem",{dataset:{value:JSON.stringify(r)},props:{contentEditable:!1}},[])}},Te=function(){function e(){w(this,e),C(this,"title","本地文件"),C(this,"tag","button"),C(this,"iconSvg",'<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="36px" height="36px" viewBox="0 0 36 36" version="1.1">\n    <title>附件</title>\n    <g id="附件" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">\n        <g id="icon">\n            <rect id="矩形" stroke="#EEEEEE" fill="#FFFFFF" x="0.5" y="0.5" width="35" height="35" rx="4"/>\n            <g id="编组-28" transform="translate(2.997929, 8.001508)">\n                <path d="M13.9611058,12.6330155 C13.9611058,14.5460163 12.4108408,16.0968098 10.498492,16.0968098 C8.58614322,16.0968098 7.03587822,14.5460163 7.03590808,12.6393438 L7.03590808,12.6393438 L6.98338468,7.07669061 C6.97992133,6.70644889 7.27712693,6.40347538 7.64724246,6.39998034 C8.017358,6.39648531 8.32022824,6.69379224 8.32372209,7.06403396 L8.32372209,7.06403396 L8.37624485,12.6330155 C8.37624485,13.8054998 9.32640727,14.7559862 10.498492,14.7559862 C11.6705768,14.7559862 12.6207392,13.8054998 12.6207392,12.6330155 L12.6207392,12.6330155 L12.6207392,6.46506253 C12.6207392,4.69957562 11.0562006,3.24725012 9.10227678,3.24725012 C7.148353,3.24725012 5.58381437,4.69957562 5.58381437,6.46506253 L5.58381437,6.46506253 L5.58381437,12.8655397 C5.58381437,15.5621365 7.78332719,17.7497339 10.498492,17.7497339 C13.2136568,17.7497339 15.4131697,15.5621365 15.4131697,12.8655397 L15.4131697,12.8655397 L15.4131697,7.10001026 C15.4131697,6.72975204 15.713221,6.42959845 16.083353,6.42959845 C16.453485,6.42959845 16.7535363,6.72975204 16.7535363,7.10001026 L16.7535363,7.10001026 L16.7535363,12.8655397 C16.7535363,16.3043913 13.9521943,19.0905575 10.498492,19.0905575 C7.04478976,19.0905575 4.24344774,16.3043913 4.24344774,12.8655397 L4.24344774,12.8655397 L4.24344774,6.46506253 C4.24344774,3.93573556 6.42955024,1.90642651 9.10227678,1.90642651 C11.7750033,1.90642651 13.9611058,3.93573556 13.9611058,6.46506253 L13.9611058,6.46506253 Z" id="形状结合" fill="#DDDDDD" transform="translate(10.498492, 10.498492) rotate(-315.000000) translate(-10.498492, -10.498492) "/>\n                <path d="M21.6662931,9.87797441 L24.6096402,9.87797441 C24.9410111,9.87797441 25.2096402,10.1466036 25.2096402,10.4779744 C25.2096402,10.8093453 24.9410111,11.0779744 24.6096402,11.0779744 L21.6662931,11.0779744 C21.3349223,11.0779744 21.0662931,10.8093453 21.0662931,10.4779744 C21.0662931,10.1466036 21.3349223,9.87797441 21.6662931,9.87797441 Z" id="矩形备份-74" fill="#73D897"/>\n                <path d="M21.6662931,4.29120933 L27.4020707,4.29120933 C27.7334415,4.29120933 28.0020707,4.55983848 28.0020707,4.89120933 C28.0020707,5.22258018 27.7334415,5.49120933 27.4020707,5.49120933 L21.6662931,5.49120933 C21.3349223,5.49120933 21.0662931,5.22258018 21.0662931,4.89120933 C21.0662931,4.55983848 21.3349223,4.29120933 21.6662931,4.29120933 Z" id="矩形备份-75" fill="#6698FF"/>\n                <path d="M21.6662931,15.4647395 L27.4020707,15.4647395 C27.7334415,15.4647395 28.0020707,15.7333686 28.0020707,16.0647395 C28.0020707,16.3961103 27.7334415,16.6647395 27.4020707,16.6647395 L21.6662931,16.6647395 C21.3349223,16.6647395 21.0662931,16.3961103 21.0662931,16.0647395 C21.0662931,15.7333686 21.3349223,15.4647395 21.6662931,15.4647395 Z" id="矩形备份-77" fill="#FF7575"/>\n            </g>\n        </g>\n    </g>\n</svg>')}return x(e,[{key:"isActive",value:function(e){return!1}},{key:"getValue",value:function(e){return""}},{key:"isDisabled",value:function(e){return!1}},{key:"exec",value:function(e,t){throw new se("暂未支持上传本地文件！")}}]),e}(),Re={renderElems:[Ne],elemsToHtml:[Le],parseElemsHtml:[Ae],menus:[{key:"attachments",factory:function(){return new Te}}]},Ie=function(){function e(){w(this,e),C(this,"model",void 0),C(this,"context",void 0),C(this,"params",void 0),C(this,"data",{}),C(this,"editor",void 0),C(this,"editorParams",void 0),C(this,"items",[]),C(this,"evt",void 0),C(this,"execting",!1),this.registerNode()}var t;return x(e,[{key:"registerNode",value:function(){window.attachmentsIsRegiter||(Y.registerModule(Re),window.attachmentsIsRegiter=!0)}},{key:"init",value:(t=b(g().mark((function e(t,n){return g().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.model=n.model,this.context=n.context,this.params=n.params,this.evt=n.evt,this.data=n.data,this.editor=t,this.editorParams=this.model.editorParams;case 7:case"end":return e.stop()}}),e,this)}))),function(e,n){return t.apply(this,arguments)})},{key:"onDestroyed",value:function(){}},{key:"insertNode",value:function(e){}},{key:"parseNode",value:function(e){return e}}]),e}();var Fe={type:"codesnippet",elemToHtml:function(e){var t=e.script,n=void 0===t?"":t,r=e.data,i=void 0===r?{}:r,a=R.execScriptFn({data:i},n,{singleRowReturn:!0,isAsync:!1});return"".concat(a)}};var He={selector:'span[data-w-e-type="codesnippet"]',parseElemHtml:function(e){var t=decodeURIComponent(e.getAttribute("data-value")||""),n=JSON.parse(t);return{type:"codesnippet",script:n.script,data:n,children:[{text:""}]}}};var De={type:"CodeSnippet",renderElem:function(e){var t=e.data,n=void 0===t?{}:t,r={name:"".concat(n.name),id:n.id};return Pe("mention-elem",{dataset:{value:JSON.stringify(r)},props:{contentEditable:!1}},[])}},ze=function(){function e(){w(this,e),C(this,"title","代码段"),C(this,"tag","button"),C(this,"iconSvg",'<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="36px" height="36px" viewBox="0 0 36 36" version="1.1">\n  <title>代码段</title>\n  <g id="代码段" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">\n      <g id="icon备份">\n          <rect id="矩形" stroke="#EEEEEE" fill="#FFFFFF" x="0.5" y="0.5" width="35" height="35" rx="4"/>\n          <path d="M24.6642225,18.8794824 L27.6075695,18.8794824 C27.9389404,18.8794824 28.2075695,19.1481115 28.2075695,19.4794824 C28.2075695,19.8108532 27.9389404,20.0794824 27.6075695,20.0794824 L24.6642225,20.0794824 C24.3328516,20.0794824 24.0642225,19.8108532 24.0642225,19.4794824 C24.0642225,19.1481115 24.3328516,18.8794824 24.6642225,18.8794824 Z" id="矩形备份-74" fill="#73D897"/>\n          <path d="M24.6642225,13.2927173 L30.4,13.2927173 C30.7313708,13.2927173 31,13.5613465 31,13.8927173 C31,14.2240882 30.7313708,14.4927173 30.4,14.4927173 L24.6642225,14.4927173 C24.3328516,14.4927173 24.0642225,14.2240882 24.0642225,13.8927173 C24.0642225,13.5613465 24.3328516,13.2927173 24.6642225,13.2927173 Z" id="矩形备份-75" fill="#6698FF"/>\n          <path d="M24.6642225,24.4662475 L30.4,24.4662475 C30.7313708,24.4662475 31,24.7348766 31,25.0662475 C31,25.3976183 30.7313708,25.6662475 30.4,25.6662475 L24.6642225,25.6662475 C24.3328516,25.6662475 24.0642225,25.3976183 24.0642225,25.0662475 C24.0642225,24.7348766 24.3328516,24.4662475 24.6642225,24.4662475 Z" id="矩形备份-77" fill="#FF7575"/>\n          <g id="1.Base基础/1.icon图标/11.editor/header-1" transform="translate(5.000000, 11.000000)" fill="#DDDDDD">\n              <path d="M4.68266589,2.39258039 L1.51032474,7.44797324 L5.01586095,12.7216272 L4.05994646,13.3212428 L0.126424153,7.40475416 L3.68603474,1.72997946 L4.68266589,2.39258039 Z M11.3173341,12.6697762 L14.4896753,7.61438339 L10.984139,2.34072939 L11.9400535,1.7411138 L15.8735758,7.65760247 L12.3139653,13.3323772 L11.3173341,12.6697762 Z M8.86596086,1.31248434 L10.0376294,1.55020137 L7.19605832,13.6243456 L6.0243898,13.3866286 L8.86596086,1.31248434 Z" id="形状结合"/>\n          </g>\n      </g>\n  </g>\n</svg>')}return x(e,[{key:"isActive",value:function(e){return!1}},{key:"getValue",value:function(e){return""}},{key:"isDisabled",value:function(e){return!1}},{key:"exec",value:function(e,t){throw new se("暂未支持上传代码段！")}}]),e}(),Ue={renderElems:[De],elemsToHtml:[Fe],parseElemsHtml:[He],menus:[{key:"codesnippet",factory:function(){return new ze}}]},je=function(){function e(){w(this,e),C(this,"model",void 0),C(this,"context",void 0),C(this,"params",void 0),C(this,"data",{}),C(this,"editor",void 0),C(this,"editorParams",void 0),C(this,"items",[]),C(this,"evt",void 0),C(this,"execting",!1),this.registerNode()}var t;return x(e,[{key:"registerNode",value:function(){window.codesnippetIsRegiter||(Y.registerModule(Ue),window.codesnippetIsRegiter=!0)}},{key:"init",value:(t=b(g().mark((function e(t,n){return g().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.model=n.model,this.context=n.context,this.params=n.params,this.evt=n.evt,this.data=n.data,this.editor=t,this.editorParams=this.model.editorParams;case 7:case"end":return e.stop()}}),e,this)}))),function(e,n){return t.apply(this,arguments)})},{key:"onDestroyed",value:function(){}},{key:"insertNode",value:function(e){}},{key:"parseNode",value:function(e){return e}}]),e}();var Be={type:"marker",elemToHtml:function(e){var t=e.script,n=void 0===t?"":t,r=e.data,i=void 0===r?{}:r,a=R.execScriptFn({data:i},n,{singleRowReturn:!0,isAsync:!1});return"".concat(a)}};var Ve={selector:'span[data-w-e-type="marker"]',parseElemHtml:function(e){var t=decodeURIComponent(e.getAttribute("data-value")||""),n=JSON.parse(t);return{type:"marker",script:n.script,data:n,children:[{text:""}]}}};var qe={type:"marker",renderElem:function(e){var t=e.data,n=void 0===t?{}:t;return Pe("mention-elem",{dataset:{value:JSON.stringify(n)},props:{contentEditable:!1}},[])}},_e=function(){function e(){w(this,e),C(this,"title","提及工作项"),C(this,"tag","button"),C(this,"iconSvg",'<svg t="1706259772097" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="6854" width="200" height="200"><path d="M929.28 625.664l-234.496 0.512 24.064-229.888 210.432-0.512c20.992 0 38.4-17.408 38.4-38.4s-17.408-38.4-38.4-38.4H727.04l29.184-275.456c2.048-20.992-13.312-39.936-34.304-41.984-20.992-2.048-39.936 13.312-41.984 34.304L650.24 318.976l-232.448 0.512 29.184-275.456c2.048-20.992-13.312-39.936-34.304-41.984-20.992-2.048-39.936 13.312-41.984 34.304l-29.696 283.648-246.272 0.512c-20.992 0-38.4 17.408-38.4 38.4s17.408 38.4 38.4 38.4l238.08-0.512-24.064 229.888-214.016 0.512c-20.992 0-38.4 17.408-38.4 38.4s17.408 38.4 38.4 38.4l205.824-0.512-29.184 276.992c-2.048 20.992 13.312 39.936 34.304 41.984h4.096c19.456 0 35.84-14.848 37.888-34.304l30.208-285.184 232.448-0.512-29.184 277.504c-2.048 20.992 13.312 39.936 34.304 41.984h4.096c19.456 0 35.84-14.848 38.4-34.304l30.208-285.184 242.688-0.512c20.992 0 38.4-17.408 38.4-38.4-1.536-20.992-18.944-37.888-39.936-37.888z m-544.256 0.512l24.064-229.888 232.448-0.512-24.064 229.888-232.448 0.512z" fill="#979797" p-id="6855"></path></svg>')}return x(e,[{key:"isActive",value:function(e){return!1}},{key:"getValue",value:function(e){return""}},{key:"isDisabled",value:function(e){return!1}},{key:"exec",value:function(e,t){e.insertText("#")}}]),e}(),Je={renderElems:[qe],elemsToHtml:[Be],parseElemsHtml:[Ve],menus:[{key:"marker",factory:function(){return new _e}}]},Ke=s({name:"MenTion",props:{controller:{type:Object,required:!0},modal:{type:Object}},setup:function(e){var t=B("mention"),n=e.controller,r=l(!1),i=l([]),a=ue,o=l({}),s=l(0),u=l([]),d=function(e){var t=e.eventArg;if(t){!t.includes("@")&&n.overlay&&n.execting&&n.overlay.dismiss();var r=t.match(/(?<=\@)([^\@&^{]*?)(?=\<)/g)||[];n.execting&&(0===r.length&&n.overlay.dismiss(),n.query=r.pop()||"",n.query&&/\s$/.test(n.query)?n.overlay.dismiss():n.query&&h({isInitialLoad:!0}))}else n.overlay&&n.execting&&n.overlay.dismiss()},v=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};r.value=!0,n.getUsers(e).then((function(t){var a;(200===t.status&&t.data||(r.value=!1),t.headers["x-total"]&&(s.value=Number(t.headers["x-total"])),!0===e.isLoadMore)?(a=i.value).push.apply(a,c(n.toUIData(t.data))):(i.value=n.toUIData(t.data),i.value.length>0&&(o.value=i.value[0]));r.value=!1})).catch((function(){r.value=!1}))},f=P((function(){return i.value.length>=s.value||r.value||s.value<=n.size})),h=ve(v,300,{leading:!0});n.evt&&n.evt.on("onChange",d),v({isInitialLoad:!0});var p=function(e){var t=i.value.findIndex((function(e){return e.id===o.value.id}));switch(e){case"up":-1!==--t&&-2!==t||(t=i.value.length-1),o.value=i.value[t];break;case"down":++t===i.value.length&&(t=0),o.value=i.value[t];break;case"enter":g(o.value)}},g=function(t){if(e.modal){var n,r={ok:!0,data:[t]};null===(n=e.modal)||void 0===n||n.dismiss(r)}};return y((function(){a=le(window,"keyup",(function(e){40===e.keyCode?p("down"):38===e.keyCode?p("up"):13===e.keyCode&&p("enter")}))})),m((function(){a!==ue&&a(),n.evt.off("onChange",d)})),{ns:t,items:i,loading:r,isLodeMoreDisabled:f,renderItem:function(e){var r=e.name,i=we.stringToHexColor(r),a=we.avatarName(r),s="";if(n.operatorMap.has(e.id)){var l=n.operatorMap.get(e.id);l.data.iconurl&&(s=function(e){if(!e)return null;var t=JSON.parse(e);return 0===t.length?null:ibiz.util.file.calcFileUpDownUrl(n.context,n.params,n.editorParams).downloadUrl.replace("%fileId%",t[0].id)}(l.data.iconurl)||"")}return S("div",{class:[t.e("item"),t.is("active",e.id===o.value.id)],onClick:function(){return g(e)}},[S("div",{class:t.e("avatar"),style:"background: ".concat(i,";")},[s&&!u.value.includes(s)?S("img",{src:s,onError:function(){return function(e){u.value.push(e)}(s)}},null):a]),S("div",{class:t.e("name"),title:r},[r])])},loadMore:function(){v({isLoadMore:!0})}}},render:function(){var e=this;return L(S("div",{"infinite-scroll-distance":10,"infinite-scroll-disabled":this.isLodeMoreDisabled,"infinite-scroll-immediate":!1,class:this.ns.b()},[this.items.map((function(t){return e.renderItem(t)})),0===this.items.length&&S(E("iBizNoData"),{text:"暂未用户数据"},null)]),[[A("infinite-scroll"),function(){return e.loadMore()}],[A("loading"),this.loading]])}}),Ze=s({name:"Marker",props:{controller:{type:Object,required:!0},modal:{type:Object}},setup:function(e){var t=B("marker"),n=e.controller,r=l(!1),i=l([]),a=ue,o=l({}),s=l(0),u=function(e){var t=e.eventArg;if(t){!t.includes("#")&&n.overlay&&n.execting&&n.overlay.dismiss();var r=t.replace(/<svg((.|[\t\r\f\n\s])+?)<\/svg>/g,"").match(/(?<=\#)([^\#&^{]*?)(?=\<)/g)||[];n.execting&&(0===r.length&&n.overlay.dismiss(),n.query=r.pop()||"",n.query&&/\s$/.test(n.query)?n.overlay.dismiss():n.query&&f({isInitialLoad:!0}))}else n.overlay&&n.execting&&n.overlay.dismiss()},d=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};r.value=!0,n.load(e).then((function(t){var a;(200===t.status&&t.data||(r.value=!1),t.headers["x-total"]&&(s.value=Number(t.headers["x-total"])),!0===e.isLoadMore)?(a=i.value).push.apply(a,c(n.toUIData(t.data))):(i.value=n.toUIData(t.data),i.value.length>0&&(o.value=i.value[0]));r.value=!1})).catch((function(){r.value=!1}))},v=P((function(){return i.value.length>=s.value||r.value||s.value<=n.size})),f=ve(d,300,{leading:!0});n.evt&&n.evt.on("onChange",u),d({isInitialLoad:!0});var h=function(e){var t=i.value.findIndex((function(e){return e.id===o.value.id}));switch(e){case"up":-1!==--t&&-2!==t||(t=i.value.length-1),o.value=i.value[t];break;case"down":++t===i.value.length&&(t=0),o.value=i.value[t];break;case"enter":p(o.value)}},p=function(t){if(e.modal){var n,r={ok:!0,data:[t]};null===(n=e.modal)||void 0===n||n.dismiss(r)}},g=function(e,t){if(n.quoteCodelistMap.has(e)){var r=n.quoteCodelistMap.get(e);return S(E("iBizCodeList"),{codeListItems:r.codeListItems,codeList:r.codeList,value:t},null)}return t};return y((function(){a=le(window,"keyup",(function(e){40===e.keyCode?h("down"):38===e.keyCode?h("up"):13===e.keyCode&&h("enter")}))})),m((function(){a!==ue&&a(),n.evt.off("onChange",u)})),{ns:t,items:i,loading:r,isLodeMoreDisabled:v,renderItem:function(e){return S("div",{class:[t.e("item"),t.is("active",e.id===o.value.id)],onClick:function(){return p(e)}},[S("div",{class:t.e("type")},[g("type",e.type)]),S("div",{class:t.e("identifier")},[g("identifier",e.identifier)]),S("div",{class:t.e("name"),title:e.name},[g("name",e.name)])])},loadMore:function(){d({isLoadMore:!0})}}},render:function(){var e=this;return L(S("div",{"infinite-scroll-distance":10,"infinite-scroll-disabled":this.isLodeMoreDisabled,"infinite-scroll-immediate":!1,class:this.ns.b()},[this.items.map((function(t){return e.renderItem(t)})),0===this.items.length&&S(E("iBizNoData"),{text:"暂未用户数据"},null)]),[[A("infinite-scroll"),function(){return e.loadMore()}],[A("loading"),this.loading]])}}),$e=function(){function e(){w(this,e),C(this,"model",void 0),C(this,"context",void 0),C(this,"params",void 0),C(this,"data",{}),C(this,"editor",void 0),C(this,"quoteUrl",""),C(this,"quoteFieldMap",{id:"id",name:"name"}),C(this,"quoteCodelistMap",new Map),C(this,"quoteMethod","post"),C(this,"quoteParams",{}),C(this,"quoteScript","`#{id=${data.id},name=${data.name},identifier=${data.identifier},icon=${data.icon}}`"),C(this,"quoteInScript","value.replaceAll(/#{id=(.+?),name=(.+?),identifier=(.+?),icon=((.|[\\t\\r\\f\\n\\s])+?)}/g,(x, id, name, identifier, icon) => {return controller.getNodeInfo({ id, name, identifier, icon })})"),C(this,"editorParams",void 0),C(this,"items",[]),C(this,"overlay",null),C(this,"evt",void 0),C(this,"execting",!1),C(this,"query",""),C(this,"curPage",0),C(this,"size",20),C(this,"presetPreventEvents",[13,38,40]),C(this,"presetPreventPropEvents",[27]),C(this,"cleanup",ue),this.registerNode()}var t,n,r,i;return x(e,[{key:"markerPlugin",value:function(e){var t=this,n=e.insertText,r=e.isInline,i=e.isVoid;return e.insertText=function(r){t.editor?t.editor.isFocused()?(X.getSelectedElems(e).some((function(t){return e.isVoid(t)}))||"#"!==r||t.execting||(t.query="",t.showModal()),n(r)):n(r):n(r)},e.isInline=function(e){return"marker"===X.getNodeType(e)||r(e)},e.isVoid=function(e){return"marker"===X.getNodeType(e)||i(e)},e}},{key:"registerNode",value:function(){window.markerIsRegiter||(Y.registerModule(Je),window.markerIsRegiter=!0),Y.registerPlugin(this.markerPlugin.bind(this))}},{key:"init",value:(i=b(g().mark((function e(t,n){var r,i,a,o,s,l,u,c,d,v,f=this;return g().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.model=n.model,this.context=n.context,this.params=n.params,this.evt=n.evt,this.data=n.data,this.editor=t,this.editorParams=this.model.editorParams,this.editorParams&&(r=this.editorParams,i=r.QUOTEURL,a=r.QUOTEFIELDMAP,o=r.QUOTEMETHOD,s=r.QUOTESCRIPT,l=r.QUOTEINSCRIPT,u=r.QUOTEPARAMS,c=r.QUOTECODELISTMAP,i&&(this.quoteUrl=i),a&&(this.quoteFieldMap=JSON.parse(a)),o&&(this.quoteMethod=o.toLowerCase()),u&&(this.quoteParams=JSON.parse(u)),s&&(this.quoteScript=s),l&&(this.quoteInScript=l),c&&(d=JSON.parse(c),this.setCodeListMap(d))),(v=this.editor.getEditableContainer())&&(this.cleanup=le(v,"keydown",(function(e){var t;f.execting&&f.presetPreventEvents.includes(e.keyCode)&&e.preventDefault(),f.execting&&f.presetPreventPropEvents.includes(e.keyCode)&&(e.stopPropagation(),null===(t=f.overlay)||void 0===t||t.dismiss())})));case 10:case"end":return e.stop()}}),e,this)}))),function(e,t){return i.apply(this,arguments)})},{key:"onDestroyed",value:function(){this.cleanup!==ue&&this.cleanup(),this.overlay&&this.overlay.dismiss()}},{key:"setCodeListMap",value:(r=b(g().mark((function e(t){var n,r;return g().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.t0=g().keys(t);case 1:if((e.t1=e.t0()).done){e.next=9;break}return n=e.t1.value,e.next=5,this.loadCodeList(t[n]);case 5:(r=e.sent)&&this.quoteCodelistMap.set(n,r),e.next=1;break;case 9:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})},{key:"showModal",value:function(){var e=this;if(!this.quoteUrl)throw new se("未配置提及工作项QUOTEURL编辑器参数！");var t=document.getSelection();if(t){var n=t.focusNode;n&&this.openPopover(n.parentNode).then((function(t){t.length>0&&e.insertNode(t[0])}))}}},{key:"findCodeListItem",value:function(e,t){if(e){var n=e.find((function(e){return e.value==t}));if(n)return n;for(var r=0;r<e.length;r++){var i=this.findCodeListItem(e[r].children,t);if(i)return i}}}},{key:"insertNode",value:function(e){if(this.quoteCodelistMap.has("type")&&e.type){var t=this.quoteCodelistMap.get("type"),n=this.findCodeListItem(t.codeListItems,e.type);n&&n.sysImage&&Object.assign(e,{icon:n.sysImage.rawContent})}var r={type:"marker",script:this.quoteScript,data:e,children:[{text:""}]};this.editor.restoreSelection(),this.editor.deleteBackward("character");for(var i=0;i<this.query.length;i++)this.editor.deleteBackward("character");this.editor.insertNode(r),this.editor.move(1)}},{key:"getNodeInfo",value:function(e){return Object.assign(e,{script:this.quoteScript}),'<span data-w-e-type="marker" data-w-e-is-void data-w-e-is-inline data-value="'.concat(encodeURIComponent(JSON.stringify(e)),'"></span>')}},{key:"parseNode",value:function(e){return R.execScriptFn({value:e,controller:this},this.quoteInScript,{singleRowReturn:!0,isAsync:!1})}},{key:"handlePublicParams",value:function(e,t,n){var r=this.model,i=r.navigateContexts,a=r.navigateParams,o={};i&&e&&(o=I(i,e,n,t));var s=Object.assign(t.clone(),o),l={};return a&&e&&(l=I(a,e,n,t)),{context:s,params:l}}},{key:"load",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=this.handlePublicParams(this.data,this.context,this.params),n=t.context,r=t.params,i=!0===e.isInitialLoad,a=!0===e.isLoadMore;i?this.curPage=0:a&&(this.curPage+=1);var o=R.execScriptFn({data:this.data,context:n,params:r},this.quoteUrl,{singleRowReturn:!0,isAsync:!1}),s=v(v({},r),{},{query:this.query,size:this.size,page:this.curPage},this.quoteParams);return ibiz.net[this.quoteMethod](o,s)}},{key:"toUIData",value:function(e){var t=this;return e.map((function(e){var n={};return Object.keys(t.quoteFieldMap).forEach((function(r){n[r]=e[t.quoteFieldMap[r]]})),n}))}},{key:"openPopover",value:(n=b(g().mark((function e(t){var n;return g().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.overlay=ibiz.overlay.createPopover(this.createOverlayView(),void 0,{placement:"bottom-start",autoClose:!0,width:"300px",noArrow:!0}),e.next=3,this.overlay.present(t);case 3:return this.execting=!0,e.next=6,this.overlay.onWillDismiss();case 6:return n=e.sent,this.execting=!1,e.abrupt("return",n.data||[]);case 9:case"end":return e.stop()}}),e,this)}))),function(e){return n.apply(this,arguments)})},{key:"createOverlayView",value:function(){var e=this;return function(t){return N(Ze,{controller:e,modal:t})}}},{key:"loadCodeList",value:(t=b(g().mark((function e(t){var n,r,i;return g().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=ibiz.hub.getApp(this.context.srfappid),r=n.codeList.getCodeList(t),e.next=4,n.codeList.get(t,this.context,this.params);case 4:return i=e.sent,e.abrupt("return",{codeList:r,codeListItems:i});case 6:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})}]),e}();var Ge={type:"mention",elemToHtml:function(e){var t=e.script,n=void 0===t?"":t,r=e.data,i=void 0===r?{}:r,a=R.execScriptFn({data:i},n,{singleRowReturn:!0,isAsync:!1});return"".concat(a)}};var Qe={selector:'span[data-w-e-type="mention"]',parseElemHtml:function(e){var t=decodeURIComponent(e.getAttribute("data-value")||""),n=JSON.parse(t);return{type:"mention",script:n.script,data:n,children:[{text:""}]}}};var We={type:"mention",renderElem:function(e){var t=e.data,n=void 0===t?{}:t,r={name:"@".concat(n.name),id:n.id};return Pe("mention-elem",{dataset:{value:JSON.stringify(r)},props:{contentEditable:!1}},[])}},Ye=function(){function e(){w(this,e),C(this,"title","提及成员"),C(this,"tag","button"),C(this,"iconSvg",'<svg t="1705979200437" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4218" xmlns:xlink="http://www.w3.org/1999/xlink" width="200" height="200"><path d="M23.7 555c0-339.3 247-550 533.8-550 295.6 0 442.8 165.9 442.8 401.6 0 210.8-93.5 361.7-237 361.7-63.6 0-108.5-26.2-137.2-78.6-48.6 51.1-96 79.8-174.6 79.8-116 0-178.4-77.3-178.4-193.3 0-209.5 131-323 251.9-323 64.9 0 102.3 24.9 122.2 68.6l11.2-58.6 114.7 1.2L727 510.1c-7.5 36.2-11.2 63.6-11.2 81.1 0 44.9 22.5 71.1 56.1 71.1 63.6 0 106-89.8 106-243.2 0-205.8-114.7-300.6-323-300.6-220.8 0-405.4 163.4-405.4 436.5 0 238.2 132.2 350.5 390.4 350.5 94.8 0 174.6-12.5 255.7-36.2v109.8c-88.6 26.2-177.1 39.9-263.2 39.9-329.1 0-508.7-168.4-508.7-464z m585-44.9c3.7-20 6.2-39.9 6.2-53.6 0-56.1-15-96-83.6-96-83.6 0-133.5 108.5-133.5 212 0 44.9 13.7 88.6 77.3 88.6 73.7-0.1 114.9-57.4 133.6-151z" fill="#333333" p-id="4219"></path></svg>')}return x(e,[{key:"isActive",value:function(e){return!1}},{key:"getValue",value:function(e){return""}},{key:"isDisabled",value:function(e){return!1}},{key:"exec",value:function(e,t){e.insertText("@")}}]),e}(),Xe={renderElems:[We],elemsToHtml:[Ge],parseElemsHtml:[Qe],menus:[{key:"mention",factory:function(){return new Ye}}]},et=function(){function e(){w(this,e),C(this,"operatorMap",new Map),C(this,"model",void 0),C(this,"context",void 0),C(this,"params",void 0),C(this,"data",{}),C(this,"editor",void 0),C(this,"userUrl",""),C(this,"userFieldMap",{id:"id",name:"name"}),C(this,"userMethod","post"),C(this,"userScript","`@{userid=${data.id},name=${data.name}}`"),C(this,"userInScript","value.replaceAll(/@{userid=(.+?),name=(.+?)}/g,(x, id, name) => {return controller.getNodeInfo({ id, name })})"),C(this,"editorParams",void 0),C(this,"items",[]),C(this,"overlay",null),C(this,"evt",void 0),C(this,"execting",!1),C(this,"query",""),C(this,"curPage",0),C(this,"size",20),C(this,"presetPreventEvents",[13,38,40]),C(this,"presetPreventPropEvents",[27]),C(this,"cleanup",ue),this.registerNode()}var t,n,r;return x(e,[{key:"mentionPlugin",value:function(e){var t=this,n=e.insertText,r=e.isInline,i=e.isVoid;return e.insertText=function(r){t.editor?t.editor.isFocused()?(X.getSelectedElems(e).some((function(t){return e.isVoid(t)}))||"@"!==r||t.execting||(t.query="",t.showModal()),n(r)):n(r):n(r)},e.isInline=function(e){return"mention"===X.getNodeType(e)||r(e)},e.isVoid=function(e){return"mention"===X.getNodeType(e)||i(e)},e}},{key:"registerNode",value:function(){window.mentionIsRegiter||(Y.registerModule(Xe),window.mentionIsRegiter=!0),Y.registerPlugin(this.mentionPlugin.bind(this))}},{key:"init",value:(r=b(g().mark((function e(t,n){var r,i,a,o,s,l,u,c=this;return g().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.model=n.model,this.context=n.context,this.params=n.params,this.evt=n.evt,this.data=n.data,this.editor=t,this.editorParams=this.model.editorParams,this.editorParams&&(r=this.editorParams,i=r.USERURL,a=r.USERFIELDMAP,o=r.USERMETHOD,s=r.USERSCRIPT,l=r.USERINSCRIPT,i&&(this.userUrl=i),a&&(this.userFieldMap=JSON.parse(a)),o&&(this.userMethod=o.toLowerCase()),s&&(this.userScript=s),l&&(this.userInScript=l)),(u=this.editor.getEditableContainer())&&(this.cleanup=le(u,"keydown",(function(e){var t;c.execting&&c.presetPreventEvents.includes(e.keyCode)&&e.preventDefault(),c.execting&&c.presetPreventPropEvents.includes(e.keyCode)&&(e.stopPropagation(),null===(t=c.overlay)||void 0===t||t.dismiss())}))),e.next=12,this.getOperatorUserList();case 12:case"end":return e.stop()}}),e,this)}))),function(e,t){return r.apply(this,arguments)})},{key:"getOperatorUserList",value:(n=b(g().mark((function e(){var t,n;return g().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,ibiz.hub.getApp(this.context.srfappid);case 2:return t=e.sent,n=[],e.next=6,t.codeList.get("SysOperator",this.context,this.params);case 6:n=e.sent,this.operatorMap=new Map(n.map((function(e){return[e.value,e]})));case 8:case"end":return e.stop()}}),e,this)}))),function(){return n.apply(this,arguments)})},{key:"onDestroyed",value:function(){this.cleanup!==ue&&this.cleanup(),this.overlay&&this.overlay.dismiss()}},{key:"showModal",value:function(){var e=this;if(!this.userUrl)throw new se("未配置提及用户USERURL编辑器参数！");var t=document.getSelection();if(t){var n=t.focusNode;n&&this.openUserPopover(n.parentNode).then((function(t){t.length>0&&e.insertNode(t[0])}))}}},{key:"insertNode",value:function(e){var t={type:"mention",script:this.userScript,data:e,children:[{text:""}]};this.editor.restoreSelection(),this.editor.deleteBackward("character");for(var n=0;n<this.query.length;n++)this.editor.deleteBackward("character");this.editor.insertNode(t),this.editor.move(1)}},{key:"getNodeInfo",value:function(e){return Object.assign(e,{script:this.userScript}),'<span data-w-e-type="mention" data-w-e-is-void data-w-e-is-inline data-value="'.concat(encodeURIComponent(JSON.stringify(e)),'"></span>')}},{key:"parseNode",value:function(e){return R.execScriptFn({value:e,controller:this},this.userInScript,{singleRowReturn:!0,isAsync:!1})}},{key:"handlePublicParams",value:function(e,t,n){var r=this.model,i=r.navigateContexts,a=r.navigateParams,o={};i&&e&&(o=I(i,e,n,t));var s=Object.assign(t.clone(),o),l={};return a&&e&&(l=I(a,e,n,t)),{context:s,params:l}}},{key:"getUsers",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=this.handlePublicParams(this.data,this.context,this.params),n=t.context,r=t.params,i=!0===e.isInitialLoad,a=!0===e.isLoadMore;i?this.curPage=0:a&&(this.curPage+=1);var o=R.execScriptFn({data:this.data,context:n,params:r},this.userUrl,{singleRowReturn:!0,isAsync:!1}),s=v(v({},r),{},{query:this.query,size:this.size,page:this.curPage});return ibiz.net[this.userMethod](o,s)}},{key:"toUIData",value:function(e){var t=this;return e.map((function(e){var n={};return Object.keys(t.userFieldMap).forEach((function(r){n[r]=e[t.userFieldMap[r]]})),n}))}},{key:"openUserPopover",value:(t=b(g().mark((function e(t){var n;return g().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.overlay=ibiz.overlay.createPopover(this.createOverlayView(),void 0,{placement:"bottom-start",autoClose:!0,width:"300px",noArrow:!0}),e.next=3,this.overlay.present(t);case 3:return this.execting=!0,e.next=6,this.overlay.onWillDismiss();case 6:return n=e.sent,this.execting=!1,e.abrupt("return",n.data||[]);case 9:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})},{key:"createOverlayView",value:function(){var e=this;return function(t){return N(Ke,{controller:e,modal:t})}}}]),e}();var tt={type:"page",elemToHtml:function(e){var t=e.script,n=void 0===t?"":t,r=e.data,i=void 0===r?{}:r,a=R.execScriptFn({data:i},n,{singleRowReturn:!0,isAsync:!1});return"".concat(a)}};var nt={selector:'span[data-w-e-type="page"]',parseElemHtml:function(e){var t=decodeURIComponent(e.getAttribute("data-value")||""),n=JSON.parse(t);return{type:"page",script:n.script,data:n,children:[{text:""}]}}};var rt={type:"Page",renderElem:function(e){var t=e.data,n=void 0===t?{}:t,r={name:"".concat(n.name),id:n.id};return Pe("mention-elem",{dataset:{value:JSON.stringify(r)},props:{contentEditable:!1}},[])}},it=function(){function e(){w(this,e),C(this,"title","页面"),C(this,"tag","button"),C(this,"iconSvg",'<svg t="1707293566679" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="6103" width="200" height="200"><path d="M288 512l256 0C561.92 512 576 497.92 576 480 576 462.08 561.92 448 544 448l-256 0C270.08 448 256 462.08 256 480 256 497.92 270.08 512 288 512zM768 64 192 64C121.6 64 64 121.6 64 192l0 576c0 70.4 57.6 128 128 128l576 0c70.4 0 128-57.6 128-128L896 192C896 121.6 838.4 64 768 64zM832 768c0 35.2-28.8 64-64 64L192 832c-35.2 0-64-28.8-64-64L128 192c0-35.2 28.8-64 64-64l576 0c35.2 0 64 28.8 64 64L832 768zM672 256l-384 0C270.08 256 256 270.08 256 288 256 305.92 270.08 320 288 320l384 0C689.92 320 704 305.92 704 288 704 270.08 689.92 256 672 256zM608 640l-320 0C270.08 640 256 654.08 256 672l0 0C256 689.92 270.08 704 288 704l320 0c17.92 0 32-14.08 32-32l0 0C640 654.08 625.92 640 608 640z" p-id="6104"></path></svg>')}return x(e,[{key:"isActive",value:function(e){return!1}},{key:"getValue",value:function(e){return""}},{key:"isDisabled",value:function(e){return!1}},{key:"exec",value:function(e,t){throw new se("暂未支持上传页面！")}}]),e}(),at={renderElems:[rt],elemsToHtml:[tt],parseElemsHtml:[nt],menus:[{key:"page",factory:function(){return new it}}]},ot=function(){function e(){w(this,e),C(this,"model",void 0),C(this,"context",void 0),C(this,"params",void 0),C(this,"data",{}),C(this,"editor",void 0),C(this,"editorParams",void 0),C(this,"items",[]),C(this,"evt",void 0),C(this,"execting",!1),this.registerNode()}var t;return x(e,[{key:"registerNode",value:function(){window.pageIsRegiter||(Y.registerModule(at),window.pageIsRegiter=!0)}},{key:"init",value:(t=b(g().mark((function e(t,n){return g().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.model=n.model,this.context=n.context,this.params=n.params,this.evt=n.evt,this.data=n.data,this.editor=t,this.editorParams=this.model.editorParams;case 7:case"end":return e.stop()}}),e,this)}))),function(e,n){return t.apply(this,arguments)})},{key:"onDestroyed",value:function(){}},{key:"insertNode",value:function(e){}},{key:"parseNode",value:function(e){return e}}]),e}(),st=function(){function e(){w(this,e)}return x(e,null,[{key:"init",value:function(e){var t=this;this.registerMap.set("mention",et),this.registerMap.set("marker",$e),this.registerMap.set("attachments",Ie),this.registerMap.set("codesnippet",je),this.registerMap.set("page",ot),this.presetNodes.forEach((function(n){t.registerPlugin({type:n,id:"".concat(n).concat(e)})}))}},{key:"registerPlugin",value:function(e){var t=e.type,n=e.id;if(this.customNodeMap.has(n))return this.customNodeMap.get(n);var r=this.registerMap.get(t);if(r){var i=new r;return this.customNodeMap.set(n,i),i}}},{key:"getPluginsById",value:function(e){var t=this,n=[];return this.presetNodes.forEach((function(r){t.customNodeMap.has("".concat(r).concat(e))&&n.push(t.customNodeMap.get("".concat(r).concat(e)))})),n}},{key:"unregisterPlugin",value:function(e){var t=e.id;this.customNodeMap.has(t)&&this.customNodeMap.delete(t)}},{key:"destroy",value:function(e){var t=this;this.presetNodes.forEach((function(n){t.unregisterPlugin({id:"".concat(n).concat(e)})})),this.registerMap.delete("mention"),this.registerMap.delete("marker"),this.registerMap.delete("attachments"),this.registerMap.delete("codesnippet"),this.registerMap.delete("page")}}]),e}();C(st,"customNodeMap",new Map),C(st,"registerMap",new Map),C(st,"presetNodes",["mention","marker","attachments","codesnippet","page"]);var lt=function(e){n(i,e);var t=r(i);function i(){return w(this,i),t.apply(this,arguments)}return x(i,[{key:"attributeChangedCallback",value:function(e,t,n){if("data-value"===e){if(n&&t===n)return;var r=JSON.parse(n),i=this.attachShadow({mode:"open"}),a=i.ownerDocument;if(r.icon){var o=a.createElement("span");o.part.add("svg"),o.innerHTML=r.icon,i.appendChild(o)}if(r.identifier){var s=a.createElement("span");s.part.add("identifier"),s.innerHTML=r.identifier,i.appendChild(s)}if(r.name){var l=a.createElement("span");l.part.add("name"),l.innerHTML=r.name,i.appendChild(l)}var u=a.createElement("style");u.innerHTML="\n      svg {\n        height: 1em;\n        width: 1em;\n      }\n    ",i.appendChild(u)}}}],[{key:"observedAttributes",get:function(){return["data-value"]}}]),i}(a(HTMLElement)),ut=function(e){n(i,e);var t=r(i);function i(){return w(this,i),t.apply(this,arguments)}return x(i,[{key:"attributeChangedCallback",value:function(e,t,n){if("data-value"===e){if(n&&t===n)return;var r=JSON.parse(n),i=this.attachShadow({mode:"open"}),a=i.ownerDocument,o=a.createElement("div");o.part.add("box"),o.classList.add("personnel-marker_box");var s="";if(r.name){s=we.stringToHexColor(r.name);var l=a.createElement("div");l.part.add("name"),l.classList.add("personnel-marker_name"),l.style.backgroundColor=s,l.innerHTML=r.name,o.appendChild(l)}var u=a.createElement("div");u.part.add("line"),u.classList.add("personnel-marker_line"),u.style.backgroundColor=s,o.appendChild(u),i.appendChild(o);var c=a.createElement("style");o.appendChild(c)}}}],[{key:"observedAttributes",get:function(){return["data-value"]}}]),i}(a(HTMLElement)),ct=function(){function e(){var t=this;w(this,e),C(this,"title","格式刷"),C(this,"tag","button"),C(this,"fragment",[]),C(this,"format",{}),C(this,"editor",null),C(this,"excting",!1),C(this,"iconSvg",'<svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" fit="" height="1em" width="1em" preserveAspectRatio="xMidYMid meet" focusable="false"><g id="aqseditor/paintformat" stroke-width="1" fill-rule="evenodd"><path d="M3 5.24h10V2H3v3.24zM13.299 1H2.701A.701.701 0 0 0 2 1.701v3.838c0 .387.314.701.701.701h6.236L7.621 7.438h-.002v2.233h-.768v5.184L9.404 13.1V9.671h-.585V7.97l1.9-1.73h2.58A.701.701 0 0 0 14 5.539V1.701A.701.701 0 0 0 13.299 1z" id="aqsFill-1"></path></g></svg>'),C(this,"setPaintFormat",(function(){if(t.editor){var e=t.editor.getSelectionText();if(e&&Object.keys(t.format).length>0){var n=v(v({},t.format),{},{text:e});t.editor.insertNode(n),t.excting||t.clearFormat()}}})),C(this,"onPaintFormat",ae(this.setPaintFormat,500,!1)),C(this,"throttleHandle",this.throttle(this.handle,300))}return x(e,[{key:"isActive",value:function(e){return Object.keys(this.format).length>0}},{key:"getValue",value:function(e){return""}},{key:"isDisabled",value:function(e){return!1}},{key:"calcFormat",value:function(e){var t=this;e.length>0&&e[0].children.forEach((function(e){Object.assign(t.format,e)}))}},{key:"clearFormat",value:function(){this.format={};var e=this.editor.getEditableContainer();e&&e.classList.remove("is-paint-format");var t=document.querySelector("button[data-menu-key='paintformat']");t&&t.classList.remove("active")}},{key:"throttle",value:function(e,t){var n=null;return function(){for(var r=this,i=arguments.length,a=new Array(i),o=0;o<i;o++)a[o]=arguments[o];n||(n=setTimeout((function(){e.apply(r,a),n=null,r.excting=!0}),t))}}},{key:"handle",value:function(e){var t=this;if(this.excting)return this.clearFormat(),void(this.excting=!1);var n=e.getFragment();this.calcFormat(n),this.editor=e;var r=this.editor.getEditableContainer();r&&r.classList.add("is-paint-format"),e.deselect(),e.on("change",this.onPaintFormat),e.on("clickOutside",(function(){t.clearFormat(),t.excting=!1}))}},{key:"exec",value:function(e){this.throttleHandle(e)}}]),e}(),dt={key:"paintformat",factory:function(){return new ct}};var vt={renderElems:[{type:"personnel-marker",renderElem:function(e){var t=e.data,n=void 0===t?{}:t,r={name:"".concat(n.name),id:n.id};return Pe("personnel-marker-elem",{dataset:{value:JSON.stringify(r)},props:{contentEditable:!1}},[])}}],elemsToHtml:[{type:"personnel-marker",elemToHtml:function(e){var t=e.data,n=void 0===t?{}:t;return"<span class='personnel-marker'>".concat(null==n?void 0:n.name,"</span>")}}],parseElemsHtml:[{selector:'span[data-w-e-type="personnel-marker"]',parseElemHtml:function(e){var t=decodeURIComponent(e.getAttribute("data-value")||"");return{type:"personnel-marker",data:JSON.parse(t),children:[{text:""}]}}}]},ft=function(e){var t=e.isInline,n=e.isVoid,r=e.deleteBackward;return e.deleteBackward=function(t){var n=e.selection;if(n&&0===n.focus.offset){var i=f(n.focus.path,2),a=i[0],o=i[1],s=o,l=a,u=!1;0===o&&0!==a?(l-=1,u=!0):o>0&&(s-=1);var c=e.children[l].children[u?e.children[l].children.length-1:s];"personnel-marker"===(null==c?void 0:c.type)&&e.moveReverse(1)}r(t)},e.isInline=function(e){return"personnel-marker"===X.getNodeType(e)||t(e)},e.isVoid=function(e){return"personnel-marker"!==X.getNodeType(e)&&n(e)},e},ht=function(){function e(){w(this,e),C(this,"title","AI询问"),C(this,"iconSvg",'<svg xmlns="http://www.w3.org/2000/svg" version="1.1"> <text x="0" y="13" font-size="16" fill="black">AI</text></svg>'),C(this,"tag","button")}return x(e,[{key:"isActive",value:function(e){return!1}},{key:"getValue",value:function(e){return"aichart"}},{key:"isDisabled",value:function(e){return!1}},{key:"exec",value:function(e,t){e.emit("aiClick")}}]),e}(),pt=function(e){n(d,e);var a,o,s,c=r(d);function d(){var e;w(this,d);for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];return C(i(e=c.call.apply(c,[this].concat(n))),"userAvatar",""),C(i(e),"uploadParams",void 0),C(i(e),"exportParams",void 0),C(i(e),"minHeight",48),C(i(e),"maxHeight",315),C(i(e),"collapsed",l(!0)),C(i(e),"hidden",l(!1)),C(i(e),"reply",l("")),C(i(e),"replyScript",""),C(i(e),"mode","comment"),C(i(e),"insertKeys",[]),C(i(e),"renderMode","HTML"),C(i(e),"saveInterval",3e3),C(i(e),"emitMode","BUTTON"),C(i(e),"uuid",ne()),C(i(e),"enableRealtime",!1),C(i(e),"editor",void 0),C(i(e),"processing",l(!1)),C(i(e),"persMarkMap",new Map),C(i(e),"msg",void 0),C(i(e),"hasSubscribe",!1),C(i(e),"deService",void 0),C(i(e),"deACMode",void 0),C(i(e),"chatCompletion",!1),C(i(e),"evt",new H(e.getEventArgs.bind(i(e)))),e}return x(d,[{key:"getEventArgs",value:function(){return{context:this.context,params:this.params,data:[],eventArg:"",targetName:this.model.name,view:this.getView()}}},{key:"onInit",value:(s=b(g().mark((function e(){var n,r,i,a,o,s,l,c,v,f,h,p,m,y,b=this;return g().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t(u(d.prototype),"onInit",this).call(this);case 2:return e.next=4,this.getCurrentUserAvatar();case 4:if(!(n=this.model).appDEACModeId){e.next=15;break}return e.next=8,D(n.appDEACModeId,n.appDataEntityId,this.context.srfappid);case 8:if(this.deACMode=e.sent,!this.deACMode){e.next=15;break}if("CHATCOMPLETION"!==this.deACMode.actype){e.next=15;break}return e.next=13,ibiz.hub.getApp(n.appId).deService.getService(this.context,n.appDataEntityId);case 13:this.deService=e.sent,this.chatCompletion=!0;case 15:if(this.registerCustomElem(),this.editorParams){if(r=this.editorParams,i=r.uploadParams,a=r.exportParams,o=r.MINHEIGHT,s=r.MAXHEIGHT,l=r.REPLYSCRIPT,c=r.MODE,v=r.INSERTKEYS,f=r.RENDERMODE,h=r.SAVEINTERVAL,p=r.EMITMODE,m=r.DEFAULTCOLLAPSE,y=r.ENABLEREALTIME,i)try{this.uploadParams=JSON.parse(i)}catch(g){ibiz.log.error("编辑器[".concat(ibiz.log.error(g),"]编辑器参数 uploadParams 非 json 格式"))}if(a)try{this.exportParams=JSON.parse(a)}catch(g){ibiz.log.error("编辑器[".concat(ibiz.log.error(g),"]编辑器参数 exportParams 非 json 格式"))}o&&(this.minHeight=Number(o)),s&&(this.maxHeight=Number(s)),l&&(this.replyScript=l),c&&(this.mode=c.toLowerCase()),v&&(this.insertKeys=JSON.parse(v)),f&&(this.renderMode=f),h&&(this.saveInterval=fe(h)),p&&(this.emitMode=p),m&&(this.collapsed.value=!Object.is(m,"TRUE")&&!Object.is(m,"true")),y&&(this.enableRealtime=Object.is(y,"TRUE")||Object.is(y,"true"))}st.init(this.uuid),this.evt.on("onChange",(function(){if(!b.parent.form){var e=ibiz.uiDomainManager.get(b.context.srfsessionid);e&&e.dataChange()}})),this.initMarkOpenData(),this.listenViewDestroyed();case 21:case"end":return e.stop()}}),e,this)}))),function(){return s.apply(this,arguments)})},{key:"registerCustomElem",value:function(){window.customElements.get("mention-elem")||window.customElements.define("mention-elem",lt),window.customElements.get("personnel-marker-elem")||window.customElements.define("personnel-marker-elem",ut),window.paintFormatIsRegiter||(Y.registerMenu(dt),window.paintFormatIsRegiter=!0),window.personnelMarkerIsRegiter||(Y.registerModule(vt),window.personnelMarkerIsRegiter=!0),Y.registerRenderStyle((function(e,t){return function(e,t){var n=e.backgroundColor,r=e.bgColor,i=t;return n&&ke(i,{backgroundColor:n}),r&&ke(i,{backgroundColor:r}),i}(e,t)})),Y.registerPlugin(ft),window.aichartRegister||(Y.registerMenu({key:"aichart",factory:function(){return new ht}}),window.aichartRegister=!0)}},{key:"onCreated",value:function(e,t,n){var r=this;this.editor=e,this.onLineEditing(e,t),st.getPluginsById(this.uuid).forEach((function(i){i.init(e,{model:r.model,data:t,toolbarConfig:n,context:r.context,params:r.params,evt:r.evt})}))}},{key:"handleEdit",value:function(e){var t=e.data;if(t){this.processing.value=!0;var n=this.persMarkMap.get(e.username);"set_selection"===t.type?this.drawPersonnelMarker({id:e.username,cursor:t.cursor}):"set_node"===t.type&&null!=n&&n.cursor.selectionRange?this.setPersSelectionMark({persMarkData:n,mark:t.newProperties}):this.editor.apply(t),this.processing.value=!1}}},{key:"handleView",value:function(e){}},{key:"handleUpdate",value:function(e){}},{key:"handleClose",value:function(e){}},{key:"markOpenDataCallback",value:function(e){var t=e.action;e.data;if(this.enableRealtime)switch(t){case"VIEW":this.handleView(e);break;case"EDIT":this.handleEdit(e);break;case"UPDATE":this.handleUpdate(e);break;case"CLOSE":this.handleClose(e)}}},{key:"initMarkOpenData",value:function(){var e=this;if(this.markOpenDataCallback=this.markOpenDataCallback.bind(this),this.enableRealtime){var t=this.parent.form||this.parent.grid;t&&(t.evt.on("onLoadSuccess",(function(t){var n=t.data[0];e.msg={deName:n.srfdecodename,srfkey:n.srfkey},ibiz.markOpenData.action(e.msg.deName,e.msg.srfkey,"VIEW"),e.hasSubscribe||ibiz.markOpenData.subscribe(e.msg.deName,e.msg.srfkey,e.markOpenDataCallback)})),t.evt.on("onSaveSuccess",(function(){e.msg.srfkey&&ibiz.markOpenData.action(e.msg.deName,e.msg.srfkey,"UPDATE")})),t.view.evt.on("onCloseView",(function(){e.msg.srfkey&&ibiz.markOpenData.action(e.msg.deName,e.msg.srfkey,"CLOSE")})))}}},{key:"onLineEditing",value:function(e,t){var n=this,r=e.apply;e.apply=function(e){if(r(e),n.enableRealtime&&!n.processing.value){var t=v({},e);if("set_selection"===e.type){var i=n.handleCursor(e);Object.assign(t,{cursor:i})}ibiz.markOpenData.send(n.msg.deName,n.msg.srfkey,"EDIT",t)}}}},{key:"handleCursor",value:function(e){var t={};e.properties&&(t.position={path:e.properties.focus.path,offset:xe.calcOffsetByPoint(this.editor,e.properties.focus)}),e.newProperties&&(t.newPosition={path:e.newProperties.focus.path,offset:xe.calcOffsetByPoint(this.editor,e.newProperties.focus)});var n=this.editor.selection;return!$.isRange(e.newProperties)&&!$.isRange(e.properties)&&n&&(t.selectionRange={anchor:{path:n.anchor.path,offset:xe.calcOffsetByPoint(this.editor,n.anchor)},focus:{path:n.focus.path,offset:xe.calcOffsetByPoint(this.editor,n.focus)}}),t}},{key:"onDestroyed",value:function(){st.getPluginsById(this.uuid).forEach((function(e){e.onDestroyed()})),st.destroy(this.uuid),this.enableRealtime&&ibiz.markOpenData.unsubscribe(this.msg.deName,this.msg.srfkey,this.markOpenDataCallback)}},{key:"listenViewDestroyed",value:function(){var e=this,t=this.getView();t&&t.evt.on("onDestroyed",(function(){e.onDestroyed()}))}},{key:"parseNode",value:function(e){var t=e;return st.getPluginsById(this.uuid).forEach((function(e){t=e.parseNode(t)})),t}},{key:"setValue",value:(o=b(g().mark((function e(t){var n;return g().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.collapsed.value=!1,this.hidden.value=!0,e.next=4,k();case 4:return this.hidden.value=!1,e.next=7,k();case 7:n=this.parseNode(t),this.evt.emit("setHtml",{eventArg:n});case 9:case"end":return e.stop()}}),e,this)}))),function(e){return o.apply(this,arguments)})},{key:"setReply",value:function(e){this.reply.value="".concat(e.name,": ").concat(e.content),this.evt.emit("onSetReply",{eventArg:this.reply.value})}},{key:"removeReply",value:function(){this.reply.value="",this.evt.emit("onRemoveReply",{eventArg:this.reply.value})}},{key:"clear",value:function(){this.reply.value="",this.evt.emit("onRemoveReply",{eventArg:this.reply.value}),this.evt.emit("clear",{eventArg:""}),this.collapsed.value=!0}},{key:"fileDownload",value:function(e){ibiz.net.request(e.url,{method:"get",responseType:"blob",baseURL:""}).then((function(t){if(200!==t.status)throw new se("下载文件失败");if(!t.data)throw new se("文件流数据不存在");var n=e.name;ce(t.data,n)}))}},{key:"toggleCollapse",value:function(e){this.collapsed.value=!e&&!this.collapsed.value}},{key:"jsonToHtml",value:function(e){var t="";try{var n=JSON.parse(e);t=ee({content:n}).getHtml()}catch(r){t=e,ibiz.log.error("JSON字符串转换错误",r)}return t}},{key:"toJson",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t="";try{t=JSON.stringify(e)}catch(n){ibiz.log.error("JSON字符串转换错误")}return t}},{key:"drawPersonnelMarker",value:function(e){var t,n=e.id,r={type:"personnel-marker",data:{name:n},children:[{text:""}],id:n},i=null===(t=this.persMarkMap.get(n))||void 0===t?void 0:t.cursor;Object.assign(e,{preCursor:i}),xe.movePersNode(this.editor,{node:r,param:e}),this.persMarkMap.set(n,e)}},{key:"setPersSelectionMark",value:function(e){var t=e.persMarkData,n=e.mark,r=t.cursor.selectionRange;r&&xe.addMarks(this.editor,{mark:n,selection:{anchor:xe.calcPointByOffset(this.editor,r.anchor),focus:xe.calcPointByOffset(this.editor,r.focus)}})}},{key:"getCurrentUserAvatar",value:(a=b(g().mark((function e(){var t,n,r,i,a=this;return g().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,ibiz.hub.getApp(this.context.srfappid);case 2:return t=e.sent,n=[],e.next=6,t.codeList.get("SysOperator",this.context,this.params);case 6:n=e.sent,this.context.srfuserid&&(r=n.filter((function(e){return e.value===a.context.srfuserid})))&&r.length>0&&(this.userAvatar=(null===(i=r[0])||void 0===i||null===(i=i.data)||void 0===i?void 0:i.iconurl)||"");case 8:case"end":return e.stop()}}),e,this)}))),function(){return a.apply(this,arguments)})},{key:"getView",value:function(){var e=this.parent.form||this.parent.grid||this.parent.panel;if(e)return e.view}}]),d}(F),mt=function(){function e(){w(this,e),C(this,"formEditor","HtmlComment"),C(this,"gridEditor","HtmlComment")}var t;return x(e,[{key:"createController",value:(t=b(g().mark((function e(t,n){var r;return g().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=new pt(t,n),e.next=3,r.init();case 3:return e.abrupt("return",r);case 4:case"end":return e.stop()}}),e)}))),function(e,n){return t.apply(this,arguments)})}]),e}(),gt=e("IBizHtmlComment",q(Ce,(function(e){e.component(Ce.name,Ce),z("EDITOR_CUSTOMSTYLE_COMMENT",(function(){return new mt}))})));e("default",{install:function(e){e.use(gt),e.component("IBizHtmlContent",T((function(){return Promise.resolve().then((function(){return me}))})))}})}}}))}();
