!function(){function t(e){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},t(e)}function e(t,n,r){return e=l()?Reflect.construct.bind():function(t,e,n){var r=[null];r.push.apply(r,e);var o=new(Function.bind.apply(t,r));return n&&i(o,n.prototype),o},e.apply(null,arguments)}function n(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,r)}return n}function r(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?n(Object(r),!0).forEach((function(e){f(t,e,r[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):n(Object(r)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))}))}return t}function o(t){return function(t){if(Array.isArray(t))return w(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||g(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function a(){return a="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(t,e,n){var r=function(t,e){for(;!Object.prototype.hasOwnProperty.call(t,e)&&null!==(t=s(t)););return t}(t,e);if(r){var o=Object.getOwnPropertyDescriptor(r,e);return o.get?o.get.call(arguments.length<3?t:n):o.value}},a.apply(this,arguments)}function i(t,e){return i=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},i(t,e)}function u(e){var n=l();return function(){var r,o=s(e);if(n){var a=s(this).constructor;r=Reflect.construct(o,arguments,a)}else r=o.apply(this,arguments);return function(e,n){if(n&&("object"===t(n)||"function"==typeof n))return n;if(void 0!==n)throw new TypeError("Derived constructors may only return object or undefined");return c(e)}(this,r)}}function c(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function l(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}function s(t){return s=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},s(t)}function f(t,e,n){return(e=m(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function d(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function p(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,m(r.key),r)}}function h(t,e,n){return e&&p(t.prototype,e),n&&p(t,n),Object.defineProperty(t,"prototype",{writable:!1}),t}function m(e){var n=function(e,n){if("object"!==t(e)||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var o=r.call(e,n||"default");if("object"!==t(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===n?String:Number)(e)}(e,"string");return"symbol"===t(n)?n:String(n)}function v(){"use strict";/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */v=function(){return n};var e,n={},r=Object.prototype,o=r.hasOwnProperty,a=Object.defineProperty||function(t,e,n){t[e]=n.value},i="function"==typeof Symbol?Symbol:{},u=i.iterator||"@@iterator",c=i.asyncIterator||"@@asyncIterator",l=i.toStringTag||"@@toStringTag";function s(t,e,n){return Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{s({},"")}catch(e){s=function(t,e,n){return t[e]=n}}function f(t,e,n,r){var o=e&&e.prototype instanceof w?e:w,i=Object.create(o.prototype),u=new N(r||[]);return a(i,"_invoke",{value:R(t,n,u)}),i}function d(t,e,n){try{return{type:"normal",arg:t.call(e,n)}}catch(t){return{type:"throw",arg:t}}}n.wrap=f;var p="suspendedStart",h="suspendedYield",m="executing",y="completed",g={};function w(){}function b(){}function C(){}var x={};s(x,u,(function(){return this}));var E=Object.getPrototypeOf,S=E&&E(E(T([])));S&&S!==r&&o.call(S,u)&&(x=S);var k=C.prototype=w.prototype=Object.create(x);function D(t){["next","throw","return"].forEach((function(e){s(t,e,(function(t){return this._invoke(e,t)}))}))}function O(e,n){function r(a,i,u,c){var l=d(e[a],e,i);if("throw"!==l.type){var s=l.arg,f=s.value;return f&&"object"==t(f)&&o.call(f,"__await")?n.resolve(f.__await).then((function(t){r("next",t,u,c)}),(function(t){r("throw",t,u,c)})):n.resolve(f).then((function(t){s.value=t,u(s)}),(function(t){return r("throw",t,u,c)}))}c(l.arg)}var i;a(this,"_invoke",{value:function(t,e){function o(){return new n((function(n,o){r(t,e,n,o)}))}return i=i?i.then(o,o):o()}})}function R(t,n,r){var o=p;return function(a,i){if(o===m)throw new Error("Generator is already running");if(o===y){if("throw"===a)throw i;return{value:e,done:!0}}for(r.method=a,r.arg=i;;){var u=r.delegate;if(u){var c=P(u,r);if(c){if(c===g)continue;return c}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(o===p)throw o=y,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);o=m;var l=d(t,n,r);if("normal"===l.type){if(o=r.done?y:h,l.arg===g)continue;return{value:l.arg,done:r.done}}"throw"===l.type&&(o=y,r.method="throw",r.arg=l.arg)}}}function P(t,n){var r=n.method,o=t.iterator[r];if(o===e)return n.delegate=null,"throw"===r&&t.iterator.return&&(n.method="return",n.arg=e,P(t,n),"throw"===n.method)||"return"!==r&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+r+"' method")),g;var a=d(o,t.iterator,n.arg);if("throw"===a.type)return n.method="throw",n.arg=a.arg,n.delegate=null,g;var i=a.arg;return i?i.done?(n[t.resultName]=i.value,n.next=t.nextLoc,"return"!==n.method&&(n.method="next",n.arg=e),n.delegate=null,g):i:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,g)}function L(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function j(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function N(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(L,this),this.reset(!0)}function T(n){if(n||""===n){var r=n[u];if(r)return r.call(n);if("function"==typeof n.next)return n;if(!isNaN(n.length)){var a=-1,i=function t(){for(;++a<n.length;)if(o.call(n,a))return t.value=n[a],t.done=!1,t;return t.value=e,t.done=!0,t};return i.next=i}}throw new TypeError(t(n)+" is not iterable")}return b.prototype=C,a(k,"constructor",{value:C,configurable:!0}),a(C,"constructor",{value:b,configurable:!0}),b.displayName=s(C,l,"GeneratorFunction"),n.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===b||"GeneratorFunction"===(e.displayName||e.name))},n.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,C):(t.__proto__=C,s(t,l,"GeneratorFunction")),t.prototype=Object.create(k),t},n.awrap=function(t){return{__await:t}},D(O.prototype),s(O.prototype,c,(function(){return this})),n.AsyncIterator=O,n.async=function(t,e,r,o,a){void 0===a&&(a=Promise);var i=new O(f(t,e,r,o),a);return n.isGeneratorFunction(e)?i:i.next().then((function(t){return t.done?t.value:i.next()}))},D(k),s(k,l,"Generator"),s(k,u,(function(){return this})),s(k,"toString",(function(){return"[object Generator]"})),n.keys=function(t){var e=Object(t),n=[];for(var r in e)n.push(r);return n.reverse(),function t(){for(;n.length;){var r=n.pop();if(r in e)return t.value=r,t.done=!1,t}return t.done=!0,t}},n.values=T,N.prototype={constructor:N,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(j),!t)for(var n in this)"t"===n.charAt(0)&&o.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=e)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var n=this;function r(r,o){return u.type="throw",u.arg=t,n.next=r,o&&(n.method="next",n.arg=e),!!o}for(var a=this.tryEntries.length-1;a>=0;--a){var i=this.tryEntries[a],u=i.completion;if("root"===i.tryLoc)return r("end");if(i.tryLoc<=this.prev){var c=o.call(i,"catchLoc"),l=o.call(i,"finallyLoc");if(c&&l){if(this.prev<i.catchLoc)return r(i.catchLoc,!0);if(this.prev<i.finallyLoc)return r(i.finallyLoc)}else if(c){if(this.prev<i.catchLoc)return r(i.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return r(i.finallyLoc)}}}},abrupt:function(t,e){for(var n=this.tryEntries.length-1;n>=0;--n){var r=this.tryEntries[n];if(r.tryLoc<=this.prev&&o.call(r,"finallyLoc")&&this.prev<r.finallyLoc){var a=r;break}}a&&("break"===t||"continue"===t)&&a.tryLoc<=e&&e<=a.finallyLoc&&(a=null);var i=a?a.completion:{};return i.type=t,i.arg=e,a?(this.method="next",this.next=a.finallyLoc,g):this.complete(i)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),g},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var n=this.tryEntries[e];if(n.finallyLoc===t)return this.complete(n.completion,n.afterLoc),j(n),g}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var n=this.tryEntries[e];if(n.tryLoc===t){var r=n.completion;if("throw"===r.type){var o=r.arg;j(n)}return o}}throw new Error("illegal catch attempt")},delegateYield:function(t,n,r){return this.delegate={iterator:T(t),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=e),g}},n}function y(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var n=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=n){var r,o,a,i,u=[],c=!0,l=!1;try{if(a=(n=n.call(t)).next,0===e){if(Object(n)!==n)return;c=!1}else for(;!(c=(r=a.call(n)).done)&&(u.push(r.value),u.length!==e);c=!0);}catch(t){l=!0,o=t}finally{try{if(!c&&null!=n.return&&(i=n.return(),Object(i)!==i))return}finally{if(l)throw o}}return u}}(t,e)||g(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function g(t,e){if(t){if("string"==typeof t)return w(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?w(t,e):void 0}}function w(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);n<e;n++)r[n]=t[n];return r}function b(t,e,n,r,o,a,i){try{var u=t[a](i),c=u.value}catch(l){return void n(l)}u.done?e(c):Promise.resolve(c).then(r,o)}function C(t){return function(){var e=this,n=arguments;return new Promise((function(r,o){var a=t.apply(e,n);function i(t){b(a,r,o,i,u,"next",t)}function u(t){b(a,r,o,i,u,"throw",t)}i(void 0)}))}}System.register(["@ibiz-template/vue3-util","@ibiz-template/runtime","vue","@ibiz-template/core","@floating-ui/dom","dayjs","ramda"],(function(t,n){"use strict";var l,p,m,g,w,b,x,E,S,k,D,O,R,P,L,j,N,T,I,M,_,Y,A,z,G,B,F,H,q,V,W,U;return{setters:[function(t){l=t.useNamespace,p=t.useControlController,m=t.useUIStore,g=t.withInstall},function(t){w=t.GridRowState,b=t.ControlVO,x=t.GridController,E=t.handleAllSettled,S=t.GridNotifyState,k=t.exportData,D=t.registerControlProvider},function(t){O=t.ref,R=t.watch,P=t.computed,L=t.watchEffect,j=t.onUnmounted,N=t.nextTick,T=t.reactive,I=t.createVNode,M=t.resolveComponent,_=t.defineComponent,Y=t.onMounted,A=t.createTextVNode,z=t.mergeProps,G=t.h},function(t){B=t.plus,F=t.RuntimeError,H=t.RuntimeModelError},function(t){q=t.computePosition},function(t){V=t.default},function(t){W=t.isNil,U=t.clone}],execute:function(){function n(t,e){var n=null,r=0,o=O({}),a=L((function(){t.value&&function(){if(window.ResizeObserver){var a=t.value.$el.querySelector(".el-table__header-wrapper");a&&(n=new ResizeObserver((function(t){var n=t[0].contentRect.height;if(n!==r){var a={"now-header-height":"".concat(n,"px")};o.value=e.cssVarBlock(a),r=n}}))).observe(a)}}()}));return j((function(){n&&n.disconnect(),a()})),{headerCssVars:o}}var $=_({name:"GanttColumns",props:{controller:{type:Object,required:!0},columns:{type:Array,required:!0}},setup:function(t){var e=l("gantt-column"),n=t.controller,r=P((function(){var t,e;return null===(t=n.model.controlRenders)||void 0===t||t.forEach((function(t){"LAYOUTPANEL"===t.renderType&&"gantt_column"===t.id&&(e=t.layoutPanel)})),e})),o=function(t,o){return I("div",{class:[e.e("default"),e.e("column")]},[I("div",{class:["time",e.is("today",o.isToday),e.is("weekend",o.isWeekend)],onClick:function(e){return n=e,void(t[o.date]&&r.value&&(n.stopPropagation(),n.preventDefault()));var n}},[t[o.date]?I(M("el-popover"),{trigger:"click",disabled:!r.value,placement:"bottom",width:"auto","popper-style":{"min-width":"300px"}},{reference:function(){return I("div",{class:"duration"},[t[o.date]])},default:function(){return e=t,I(M("iBizControlShell"),{data:e,modelData:r.value,context:n.context,params:n.params},null);var e}}):null])])};return{ns:e,renderColumn:function(t){return I(M("el-table-column"),{className:e.b(),"min-width":60,align:"center",type:"gantt",prop:t.date},{header:function(){return function(t){return I("div",{class:[e.e("header"),e.e("column")]},[I("div",{class:["time",e.is("today",t.isToday),e.is("weekend",t.isWeekend)]},[I("div",{class:"week"},[t.week]),I("div",{class:"date"},[V(t.date).format("MM/DD")])])])}(t)},default:function(e){var n=e.row;return o(n,t)}})}}},render:function(){var t=this;return this.columns.map((function(e){return t.renderColumn(e)}))}}),Q={0:"周日",1:"周一",2:"周二",3:"周三",4:"周四",5:"周五",6:"周六"},K=function(){function t(){d(this,t)}return h(t,null,[{key:"isDateSame",value:function(t,e){return V(t).format("YYYY-MM-DD")===V(e).format("YYYY-MM-DD")}},{key:"calcDate",value:function(t,e){for(var n=V(t,"YYYY-MM-DD"),r=V(e,"YYYY-MM-DD"),o=[],a=n;!a.isAfter(r);a=a.add(1,"day"))o.push({date:a.format("YYYY-MM-DD"),week:Q[a.day()],isWeekend:6===a.day()||0===a.day(),isToday:this.isDateSame(a,new Date)});return o}}]),t}(),J=function(t){!function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&i(t,e)}(g,t);var e,n,l,p,m,y=u(g);function g(){var t;d(this,g);for(var e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];return f(c(t=y.call.apply(y,[this].concat(n))),"codeListItems",void 0),f(c(t),"precision",1),t}return h(g,[{key:"onCreated",value:(m=C(v().mark((function t(){var e,n;return v().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,a(s(g.prototype),"onCreated",this).call(this);case 2:e=this.model.controlParam.ctrlParams,n=void 0===e?{}:e;try{n.PRECISION&&(this.precision=Number(n.PRECISION))}catch(r){ibiz.log.error(r)}case 4:case"end":return t.stop()}}),t,this)}))),function(){return m.apply(this,arguments)})},{key:"initState",value:function(){a(s(g.prototype),"initState",this).call(this),this.initGanttColumns()}},{key:"initGanttColumns",value:function(){var t=new Date,e=V(t.getTime()-6048e5).format("YYYY-MM-DD"),n=V(t).format("YYYY-MM-DD");this.state.ganttColumns=K.calcDate(e,n)}},{key:"initGroup",value:(p=C(v().mark((function t(){var e,n,r,o;return v().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(e=this.model,n=e.groupCodeListId,r=e.groupMode,!e.enableGroup){t.next=9;break}if("CODELIST"!==r){t.next=9;break}if(n){t.next=5;break}throw new H(this.model,"代码表分组模式需要配置代码表");case 5:return o=ibiz.hub.getApp(this.context.srfappid),t.next=8,o.codeList.get(n,this.context,this.params);case 8:this.codeListItems=t.sent;case 9:case"end":return t.stop()}}),t,this)}))),function(){return p.apply(this,arguments)})},{key:"calcGanttColumns",value:function(){var t,e=this.view.getController("searchform"),n=null===(t=this.model.controlParam)||void 0===t||null===(t=t.ctrlParams)||void 0===t?void 0:t.DATERANGE;if(this.state.ganttColumns=[],e&&n){var r,o=null===(r=e.state.data)||void 0===r?void 0:r[n];if(o){var a=o.split(",");2===a.length&&(this.state.ganttColumns=K.calcDate(a[0],a[1]))}}0===this.state.ganttColumns.length&&this.initGanttColumns()}},{key:"load",value:(l=C(v().mark((function t(){var e,n,r,a,i,u,c,l,s,f=arguments;return v().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(e=f.length>0&&void 0!==f[0]?f[0]:{},this.calcGanttColumns(),!this.state.isSimple){t.next=4;break}return t.abrupt("return",[]);case 4:if(n=!0===e.silent){t.next=8;break}return t.next=8,this.startLoading();case 8:return t.prev=8,r=!0===e.isInitialLoad,a=!0===e.isLoadMore,r?this.state.curPage=1:a&&(this.state.curPage+=1),i=this.handlerAbilityParams(e),u=i.context,t.next=15,this.getFetchParams(null==e?void 0:e.viewParam);case 15:return c=t.sent,t.next=18,this.service.fetch(u,c);case 18:return"number"==typeof(l=t.sent).total&&(this.state.total=l.total),a?(s=this.state.items).push.apply(s,o(l.data)):this.state.items=l.data,t.next=23,this.afterLoad(e,l.data);case 23:return this.state.isLoaded=!0,t.next=26,this._evt.emit("onLoadSuccess",{isInitialLoad:r});case 26:t.next=34;break;case 28:return t.prev=28,t.t0=t.catch(8),t.next=32,this._evt.emit("onLoadError",void 0);case 32:throw this.actionNotification("FETCHERROR",{error:t.t0}),t.t0;case 34:if(t.prev=34,n){t.next=38;break}return t.next=38,this.endLoading();case 38:return t.finish(34);case 39:return this.state.items.forEach((function(t,e){t.srfserialnum=e+1})),this.actionNotification("FETCHSUCCESS"),t.abrupt("return",this.state.items);case 42:case"end":return t.stop()}}),t,this,[[8,28,34,39]])}))),function(){return l.apply(this,arguments)})},{key:"afterLoad",value:(n=C(v().mark((function t(e,n){var r,o=this;return v().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,E(Object.values(this.fieldColumns).map(function(){var t=C(v().mark((function t(e){return v().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.loadCodeList();case 2:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}()),!1);case 2:return r=this.calcMergeByGroup(n),this.state.rows=r.map((function(t){var e=new w(t,o);return o.gridStateNotify(e,S.LOAD),e})),this.state.rows.forEach((function(t){Object.values(t.uaColStates).forEach((function(e){e.update(o.context,t.data.getOrigin(),o.model.appDataEntityId)}))})),this.state.rows.forEach((function(t){Object.values(t.uiActionGroupStates).forEach((function(e){e.update(o.context,t.data.getOrigin(),o.model.appDataEntityId)}))})),this.calcAggResult(n),t.abrupt("return",n);case 8:case"end":return t.stop()}}),t,this)}))),function(t,e){return n.apply(this,arguments)})},{key:"calcMergeByGroup",value:function(t){var e=this,n=[];t.forEach((function(t){Object.assign(t,f({},V(t.register_date).format("YYYY-MM-DD"),t.duration.toFixed(e.precision)))}));var r=this.model,o=r.enableGroup,a=r.groupMode,i=r.groupAppDEFieldId;if(o&&i){var u=new Map,c="CODELIST"===a,l=i.toLowerCase();c&&this.codeListItems.forEach((function(t){u.set(t.value,[])})),t.forEach((function(t){var e=t[l];c||u.has(e)||u.set(e,[]),u.has(e)&&u.get(e).push(t)})),u.forEach((function(t,r){if(t.length>0){var o=t[0].clone(),a=t.filter((function(t){return!W(t.duration)}));t.forEach((function(t){var n=V(t.register_date).format("YYYY-MM-DD");o.srfkey!==t.srfkey&&n&&Object.assign(o,f({},n,Object.prototype.hasOwnProperty.call(o,n)?(Number(o[n]||0)+t.duration).toFixed(e.precision):t.duration.toFixed(e.precision)))})),o.duration=a.map((function(t){return t.duration})).reduce((function(t,e){return B(t,e)}),0).toFixed(e.precision),n.push(o)}}))}else n=t;return n}},{key:"exportData",value:(e=C(v().mark((function t(e){var n,o,a,i,u,c,l,s,d,p,h=this;return v().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!this.model.dedataExportId||this.dataExport){t.next=6;break}if(this.dataExport=null===(n=this.dataEntity.appDEDataExports)||void 0===n?void 0:n.find((function(t){return t.id===h.model.dedataExportId})),!this.dataExport){t.next=6;break}return t.next=5,this.findAllExportColumns(this.dataExport);case 5:this.allExportColumns=t.sent;case 6:if(o=function(t){var e,n=new Map;h.allExportColumns&&h.allExportColumns.length>0?null===(e=h.allExportColumns)||void 0===e||e.forEach((function(t){t.codeListItems&&n.set(t.appDEFieldId,t.codeListItems)})):Object.keys(h.fieldColumns).forEach((function(t){h.fieldColumns[t].codeList&&n.set(t,h.fieldColumns[t].codeListItems)}));var r=U(t.map((function(t){return t})));return r.forEach((function(t){Object.keys(t).forEach((function(e){var r,o=t[e],a=h.fieldColumns[e];n.get(e)?o=(null===(r=n.get(e).find((function(n){return n.value===t[e]})))||void 0===r?void 0:r.text)||o:a&&(o=a.formatValue(o)+(a.model.unitName||"")),t[e]=o}))})),r},a=this.state.ganttColumns.map((function(t){return"".concat(t.week,"(").concat(V(t.date).format("MM/DD"),")")})),i=this.state.ganttColumns.map((function(t){return t.date})),u=function(){var t=C(v().mark((function t(){var n,a,u,c,l,s,d,p,m,y;return v().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(a=null===(n=e.params)||void 0===n?void 0:n.type,u=[],a&&"activatedPage"!==a){t.next=6;break}u=h.state.rows.map((function(t){return t.data})),t.next=17;break;case 6:if("maxRowCount"!==a&&"customPage"!==a){t.next=16;break}return c=h.state.size,l=e.params,s=l.startPage,d=l.endPage,p="customPage"===a?{page:0,offset:(s-1)*c,size:(d-s+1)*c}:{size:1e3,page:0},t.next=12,h.loadData({viewParam:p});case 12:m=t.sent,u=h.calcMergeByGroup(m),t.next=17;break;case 16:"selectedRows"===a&&(u=h.getData());case 17:if(0!==u.length){t.next=19;break}throw new F("无导出数据");case 19:return h.enableAgg&&(y=r(r({},h.state.aggResult),{},{summary:!0}),i.length>0&&i.forEach((function(t){Object.assign(y,f({},t,u.map((function(e){return e[t]||0})).reduce((function(t,e){return B(t,e)}),0).toFixed(h.precision)))})),u.push(y)),t.abrupt("return",o(u));case 21:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}(),c=function(t,e){return e.map((function(e){return t.map((function(t,n){return e.summary&&0===n?h.aggTitle:e[t]}))}))},l=[],s=[],!(this.allExportColumns&&this.allExportColumns.length>0)){t.next=18;break}l=this.allExportColumns.map((function(t){return t.appDEFieldId})),s=this.allExportColumns.map((function(t){return t.caption})),t.next=23;break;case 18:if(d=this.model.degridColumns){t.next=21;break}throw new F("无表格列");case 21:l=d.map((function(t){return t.id})),s=d.map((function(t){return t.caption}));case 23:return s=s.concat(a),l=l.concat(i),t.t0=c,t.t1=l,t.next=29,u();case 29:return t.t2=t.sent,p=(0,t.t0)(t.t1,t.t2),t.next=33,k(s,p,this.model.logicName);case 33:case"end":return t.stop()}}),t,this)}))),function(t){return e.apply(this,arguments)})}]),g}(x);function X(t,e,n,r){if("GROUPGRIDCOLUMN"===e.columnType){var o,a,i=(null===(o=e.degridColumns)||void 0===o?void 0:o.filter((function(t){return!t.hideDefault&&!t.hiddenDataItem})))||[],u=e.width,c=(null===(a=e.align)||void 0===a?void 0:a.toLowerCase())||"center";return I(M("el-table-column"),{prop:e.codeName,label:e.caption,"min-width":u,align:c},{default:function(){return i.map((function(e,n){return X(t,e)}))}})}return function(t,e,n,r){var o,a=e.codeName,i=e.width,u=t.columns[a],c=u.isAdaptiveColumn?"min-width":"width";return I(M("el-table-column"),z({label:e.caption,prop:a},f({},c,i),{fixed:"left",sortable:!!e.enableSort&&"custom",align:(null===(o=e.align)||void 0===o?void 0:o.toLowerCase())||"center"}),{default:function(e){var n=e.row,r=n;n.isGroupData&&(r=n.first);var o=t.findRowState(r);if(o){var i=M(t.providers[a].component);return G(i,{controller:u,row:o,key:r.tempsrfkey+a})}return null}})}(t,e)}var Z=_({name:"IBizWorkloadTableControl",props:{modelData:{type:Object,required:!0},context:{type:Object,required:!0},params:{type:Object,default:function(){return{}}},provider:{type:Object},mdctrlActiveMode:{type:Number,default:void 0},singleSelect:{type:Boolean,default:void 0},rowEditOpen:{type:Boolean,default:void 0},isSimple:{type:Boolean,required:!1},data:{type:Array,required:!1},loadDefault:{type:Boolean,default:!0}},setup:function(t){var r=p((function(){for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];return e(J,n)})),o=l("control-".concat(r.model.controlType.toLowerCase())),a=l("workload-table"),i=m().zIndex;r.state.zIndex=i.increment();var u=O(void 0),c=function(t){var e=O(),n=!1,r=!1;function o(){return(o=C(v().mark((function e(n,r,o){var a;return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("row"!==ibiz.config.grid.editShowMode||!t.model.enableRowEdit){e.next=7;break}if(!(a=t.findRowState(n))||!0===a.showRowEdit){e.next=5;break}return e.next=5,t.switchRowEdit(a,!0);case 5:e.next=8;break;case 7:t.onRowClick(n);case 8:case"end":return e.stop()}}),e)})))).apply(this,arguments)}return R([function(){return e.value},function(){return t.state.isLoaded},function(){return t.state.selectedData}],(function(r){var o=y(r,3),a=o[0],i=o[1],u=o[2];i&&a&&(t.state.singleSelect?u[0]?e.value.setCurrentRow(u[0],!0):e.value.setCurrentRow():(n=!0,e.value.clearSelection(),u.forEach((function(t){return e.value.toggleRowSelection(t,!0)})),n=!1))})),R((function(){return t.state.sortQuery}),(function(n){if(n){var o=t.state.sortQuery.split(",")[0],a=t.state.sortQuery.split(",")[1];if(o&&a){var i="desc"===a?"descending":"ascending";!function t(){e.value?N((function(){r=!0,e.value.sort(o,i)})):setTimeout(t,500)}()}}})),{tableRef:e,onRowClick:function(t,e,n){return o.apply(this,arguments)},onDbRowClick:function(e){t.onDbRowClick(e)},onSelectionChange:function(e){n||t.setSelection(e)},onSortChange:function(e){if(r)r=!1;else{var n,o=e.prop,a=e.order,i=t.fieldColumns[o].model.appDEFieldId;"ascending"===a?n="asc":"descending"===a&&(n="desc"),"".concat(i,",").concat(n)!==t.state.sortQuery&&(t.setSort(i,n),t.load())}},handleRowClassName:function(e){var n=e.row,r="";t.state.selectedData.length>0&&t.state.selectedData.forEach((function(t){t===n&&(r="current-row")}));var o=t.findRowState(n);return null!=o&&o.showRowEdit&&(r+=" editing-row"),n.srfkey&&(r+=" id-".concat(n.srfkey)),r},handleHeaderCellClassName:function(e){e._row;var n,r=e.column,o=(e._rowIndex,e._columnIndex,null===(n=t.model.degridColumns)||void 0===n?void 0:n.find((function(t){return t.codeName===r.property})));return o&&o.headerSysCss&&o.headerSysCss.cssName?o.headerSysCss.cssName:""}}}(r),s=c.tableRef,f=c.onRowClick,d=c.onDbRowClick,h=c.onSelectionChange,g=c.onSortChange,x=c.handleRowClassName,E=c.handleHeaderCellClassName,S=function(t){return{onPageChange:function(e){e&&e!==t.state.curPage&&(t.state.curPage=e,t.load())},onPageSizeChange:function(e){e&&e!==t.state.size&&(t.state.size=e,1===t.state.curPage&&t.load())},onPageRefresh:function(){t.load()}}}(r),k=S.onPageChange,D=S.onPageRefresh,L=S.onPageSizeChange,_=n(s,o).headerCssVars,z=function(t,e){var n=function(){e.data&&(t.state.items=e.data,t.state.rows=e.data.map((function(e){return new w(new b(e),t)})))},r=P((function(){var e,n=Object.values(t.fieldColumns).find((function(e){return e.model.appDEFieldId===t.model.minorSortAppDEFieldId}));return{prop:null==n?void 0:n.model.codeName,order:"desc"===(null===(e=t.model.minorSortDir)||void 0===e?void 0:e.toLowerCase())?"descending":"ascending"}}));return t.evt.on("onCreated",C(v().mark((function r(){return v().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:e.isSimple&&(n(),t.state.isLoaded=!0);case 1:case"end":return r.stop()}}),r)})))),R((function(){return e.data}),(function(){e.isSimple&&n()}),{deep:!0}),{tableData:P((function(){return t.state.rows.map((function(t){return t.data}))})),renderColumns:P((function(){if(t.isMultistageHeader)return t.model.degridColumns||[];var e=[];return t.state.columnStates.forEach((function(n){var r,o;if(!n.hidden){var a=(null===(r=t.fieldColumns[n.key])||void 0===r?void 0:r.model)||(null===(o=t.uaColumns[n.key])||void 0===o?void 0:o.model);a&&e.push(a)}})),e})),defaultSort:r,summaryMethod:function(e){return e.columns.map((function(e,n){return 0===n?t.aggTitle:t.state.aggResult[e.property]}))},ganttSummaryMethod:function(e){return e.columns.map((function(e,n){return t.state.rows.map((function(t){return t.data[e.property]||0})).reduce((function(t,e){return B(t,e)}),0)}))}}}(r,t),G=z.tableData,H=z.renderColumns,V=z.defaultSort,W=z.summaryMethod,U=z.ganttSummaryMethod,$=function(t,e){var n,r=O(!1),o=O(),a=T({}),i=function(e){if(!t.value)throw new F("找不到表格组件引用");var n=t.value.$el,r=".el-table__row";e.data.srfkey&&(r+=".id-".concat(e.data.srfkey));var o=n.querySelector(r);if(!o)throw new F("找不到对应的表格行dom元素");return o},u=function(){var t=C(v().mark((function t(e){var u,c,l,s,f;return v().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(u=i(e),n){t.next=3;break}throw new F("拿不到pop组件的实例");case 3:return c=n.$el,t.next=6,q(u,c,{placement:"bottom"});case 6:l=t.sent,s=l.x,f=l.y,Object.assign(a,{top:"".concat(f,"px"),left:"".concat(s,"px")}),o.value=e,r.value=!0;case 12:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}(),c=function(){var t=C(v().mark((function t(){return v().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:o.value&&e.switchRowEdit(o.value,!1,!0);case 1:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}(),l=function(){var t=C(v().mark((function t(){return v().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:o.value&&e.switchRowEdit(o.value,!1,!1);case 1:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}();return e.evt.on("onRowEditChange",(function(t){t.row.showRowEdit?setTimeout((function(){u(t.row)}),0):(o.value=void 0,r.value=!1,Object.assign(a,{top:void 0,left:void 0}))})),{renderPopover:function(){var t=r.value&&e.state.rows[e.state.rows.length-1].showRowEdit;return[I("div",{class:"row-edit-popover__placeholder",style:{display:t?"block":"none"}},null),I(M("iBizRowEditPopover"),{ref:function(t){n=t},style:a,show:r.value,onConfirm:c,onCancel:l},null)]}}}(s,r),Q=$.renderPopover,K=P((function(){var t;return null===(t=u.value)||void 0===t?void 0:t.scrollBarRef.wrapRef})),X=P((function(){var t;return null===(t=s.value)||void 0===t?void 0:t.scrollBarRef.wrapRef})),Z=function(){var t=0;if(arguments.length>0&&void 0!==arguments[0]&&arguments[0])H.value.forEach((function(e){return t+=e.width||0}));else{var e,n=null===(e=s.value)||void 0===e?void 0:e.store.states.columns.value;(null==n?void 0:n.length)>0&&n.forEach((function(e){return t+=e.realWidth||e.width}))}return t},tt=function(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];setTimeout((function(){var e,n,r=null===(e=s.value)||void 0===e?void 0:e.$el;r&&(r.style.width="".concat(Z(t),"px"));var o=null===(n=u.value)||void 0===n?void 0:n.$el;o&&(o.style.width="calc(100% - ".concat(Z(t),"px)"))}),300)},et=function(t){"gantt"===t?s.value.setScrollTop(K.value.scrollTop):u.value.setScrollTop(X.value.scrollTop)},nt=function(){et("gantt")},rt=function(){et("table")};return Y((function(){tt(!0),setTimeout((function(){K.value&&K.value.addEventListener("scroll",nt),X.value&&X.value.addEventListener("scroll",rt)}),300)})),j((function(){i.decrement(),K.value&&K.value.removeEventListener("scroll",nt),X.value&&X.value.removeEventListener("scroll",rt)})),{c:r,ns:o,ns2:a,tableRef:s,ganttRef:u,tableData:G,renderColumns:H,onDbRowClick:d,onRowClick:f,onSelectionChange:h,onSortChange:g,onPageChange:k,onPageSizeChange:L,onPageRefresh:D,handleRowClassName:x,handleHeaderCellClassName:E,renderNoData:function(){if(r.state.isLoaded){var t,e=null===(t=r.model.controls)||void 0===t?void 0:t.find((function(t){return t.name==="".concat(r.model.name,"_quicktoolbar")}));return e?I(M("iBizToolbarControl"),{modelData:e,context:r.context,params:r.params,class:o.b("quick-toolbar")},null):I(M("iBizNoData"),{text:r.model.emptyText,emptyTextLanguageRes:r.model.emptyTextLanguageRes},null)}return I("div",null,null)},summaryMethod:W,ganttSummaryMethod:U,renderPopover:Q,defaultSort:V,renderBatchToolBar:function(){var t,e=null===(t=r.model.controls)||void 0===t?void 0:t.find((function(t){return t.name==="".concat(r.model.name,"_batchtoolbar")}));if(e&&!r.state.singleSelect)return I("div",{class:[o.b("batch-toolbar"),o.is("show",r.state.selectedData.length>0)]},[I("div",{class:o.b("batch-toolbar-content")},[I("div",{class:o.b("batch-toolbar-text")},[A("已选中"),r.state.selectedData.length,A("项")]),I("div",{class:o.b("batch-toolbar-separator")},[A("|")]),I(M("iBizToolbarControl"),{modelData:e,context:r.context,params:r.params,class:o.b("batch-toolbar-items")},null)])])},headerCssVars:_,onHeaderDragend:function(){tt()}}},render:function(){var t=this;if(this.c.state.isCreated){var e=this.c.state,n=this.c.model,r=n.hideHeader,o=n.enablePagingBar,a=n.enableCustomized,i=n.enableGroup;return I(M("iBizControlBase"),{class:[this.ns2.b(),this.ns.is("show-header",!r),this.ns.is("enable-page",o),this.ns.is("enable-group",i),this.ns.is("single-select",e.singleSelect),this.ns.is("empty",0===e.items.length),this.ns.is("enable-customized",a)],controller:this.c,style:this.headerCssVars},{default:function(){return[I("div",{class:t.ns2.e("container")},[I(M("el-table"),{ref:"tableRef",class:[t.ns.e("table"),t.ns2.e("left")],"default-sort":t.defaultSort,border:!0,onHeaderDragend:t.onHeaderDragend,"show-header":!r,"show-summary":t.c.enableAgg,"summary-method":t.summaryMethod,"highlight-current-row":e.singleSelect,"row-class-name":t.handleRowClassName,"header-cell-class-name":t.handleHeaderCellClassName,"row-key":"tempsrfkey",data:t.tableData,onRowClick:t.onRowClick,onRowDblclick:t.onDbRowClick,onSelectionChange:t.onSelectionChange,onSortChange:t.onSortChange,"tooltip-effect":"light"},{empty:t.renderNoData,default:function(){return[!e.singleSelect&&I(M("el-table-column"),{"class-name":t.ns.e("selection"),type:"selection",width:"55"},null),t.renderColumns.map((function(e,n){return X(t.c,e,t.renderColumns)}))]},append:function(){return t.renderPopover()}}),I(M("el-table"),{ref:"ganttRef",class:[t.ns.e("table"),t.ns2.e("right")],"default-sort":t.defaultSort,border:!0,"show-header":!r,"show-summary":t.c.enableAgg,"summary-method":t.ganttSummaryMethod,"highlight-current-row":e.singleSelect,"row-class-name":t.handleRowClassName,"header-cell-class-name":t.handleHeaderCellClassName,"row-key":"tempsrfkey",data:t.tableData,onRowClick:t.onRowClick,onRowDblclick:t.onDbRowClick,onSelectionChange:t.onSelectionChange,onSortChange:t.onSortChange,"tooltip-effect":"light"},{empty:function(){return I("div",null,null)},default:function(){return[I($,{controller:t.c,columns:t.c.state.ganttColumns},null)]}})]),o&&I(M("iBizPagination"),{total:e.total,curPage:e.curPage,size:e.size,onChange:t.onPageChange,onPageSizeChange:t.onPageSizeChange,onPageRefresh:t.onPageRefresh},null),a&&!r&&I("div",{class:t.ns.b("setting-box")},[I(M("iBizGridSetting"),{columnStates:e.columnStates,controller:t.c},null)]),t.renderBatchToolBar()]}})}}}),tt=h((function t(){d(this,t),f(this,"component","IBizWorkloadTableControl")})),et=t("IBizWorkloadTableControl",g(Z,(function(t){t.component(Z.name,Z),D("GRID_RENDER_WORKLOAD_TABLE",(function(){return new tt}))})));t("default",{install:function(t){t.use(et)}})}}}))}();
