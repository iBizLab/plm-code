System.register(["vue","ramda","@ibiz-template/vue3-util","@ibiz-template/runtime","cherry-markdown","qx-util","@ibiz-template/core","lodash-es"],(function(e){"use strict";var t,i,a,s,o,n,r,l,c,d,h,u,m,p,v,f,y,w,g,b,D,E,C,S,I,P,j,N,x,O,T,M,R,k,A,z,B,F,V,L,_,U;return{setters:[function(e){t=e.defineComponent,i=e.ref,a=e.watch,s=e.nextTick,o=e.createVNode,n=e.resolveComponent,r=e.h,l=e.isVNode,c=e.renderSlot,d=e.reactive,h=e.computed,u=e.onMounted,m=e.createTextVNode},function(e){p=e.uniq,v=e.clone},function(e){f=e.useNamespace,y=e.useControlController,w=e.getInputProps,g=e.getEditorEmits,b=e.useUIStore},function(e){D=e.PanelItemController,E=e.registerPanelItemProvider,C=e.ControlType,S=e.ScriptFactory,I=e.findChildFormDetails,P=e.EditFormController,j=e.registerControlProvider,N=e.CodeListEditorController,x=e.registerEditorProvider,O=e.ViewController,T=e.getPFPlugin,M=e.ViewEngineBase,R=e.getControl,k=e.SysUIActionTag,A=e.convertNavData,z=e.PanelItemState},function(e){B=e.default},function(e){F=e.QXEvent,V=e.createUUID,L=e.generateOrderValue},function(e){_=e.RuntimeModelError},function(e){U=e.debounce}],execute:function(){var K=t({name:"IBizDesignTree",props:{readOnly:{type:Boolean,default:!1},draggable:{type:Boolean,default:!0},dropRules:{type:Object,default:()=>new Map},actions:{type:Array,default:()=>[]},renderItem:{type:Object,required:!1},nodes:{type:Object,required:!0},activeNode:{type:String}},emits:["nodeSelect","actionClick","nodeDrop"],setup(e,{emit:t}){const n=f("design_tree"),r=i([]),l=(t,i)=>{const{data:a,node:s}=t,o=e.dropRules.get(a.type);return(1!==s.level||"add"===i.type)&&(null!=o||"add"!==i.type)},c=(e,i,a)=>{e.stopPropagation(),t("actionClick",e,i,a)},d=(e,t)=>{e.forEach((e=>{if(null!=(null==e?void 0:e.children)){-1===t.findIndex((t=>e.id===t))&&r.value.push(e.id),d(e.children,t)}}))},h=()=>{if(e.nodes){const t=p(r.value);d(e.nodes,t)}};h();const u=i();return a(e.nodes,(()=>{s((()=>{var t,i;u.value&&(null==(i=(t=u.value).setCurrentKey)||i.call(t,e.activeNode))}))})),{ns:n,expendNodeKeys:r,tree:u,renderTreeItem:(t,i)=>{if(e.renderItem)return e.renderItem(t,i);const{data:a}=i;return o("div",{class:n.e("component")},[o("div",{class:n.e("item")},[o("div",{class:n.e("item-label"),title:a.label},[a.icon?o("ion-icon",{class:"".concat(n.e("item-icon")),name:a.icon},null):null,o("span",{class:n.e("item-caption")},[a.label])]),!e.readOnly&&e.actions.length>0?o("div",{class:{[n.e("actions")]:!0,first:1===i.node.level}},[o("div",{class:n.e("item-actions")},[e.actions.map((e=>l(i,e)&&!e.visible?o("div",{class:n.e("item-action-item"),title:e.tooltip,onClick:t=>c(t,e,a.data)},[o("ion-icon",{name:e.icon},null)]):null))]),o("div",{class:n.e("default-actions")},[e.actions.map((e=>l(i,e)&&e.visible?o("div",{class:n.e("item-action-item"),title:e.tooltip,onClick:t=>c(t,e,a.data)},[o("ion-icon",{name:e.icon},null)]):null))])]):null])])},allowDrag:e=>0!==e.level,allowDrop:(t,i,a)=>{if(Object.is(a,"inner")){if((null==i?void 0:i.data)&&(null==t?void 0:t.data)){const a=e.dropRules.get(i.data.type);return!!(null==a?void 0:a.test(t.data.type))}}else{if(0===(null==i?void 0:i.level))return!1;if((null==i?void 0:i.data)&&(null==t?void 0:t.data)&&i.parent){const a=e.dropRules.get(i.parent.data.type);return!!(null==a?void 0:a.test(t.data.type))}}return!1},handleDrop:(e,i,a)=>{t("nodeDrop",e,i,a)},handNodeSelect:(e,i)=>{t("nodeSelect",e,i)},handleNodeExpand:e=>{-1===r.value.findIndex((t=>e.id===t))&&r.value.push(e.id)},handleNodeCollapse:e=>{const t=r.value.findIndex((t=>e.id===t));-1!==t&&r.value.splice(t,1)},expandAll:h}},render(){const e={[this.ns.b()]:!0,[this.ns.is("readonly")]:this.readOnly};return o("div",{class:e},[o(n("el-tree"),{ref:"tree","current-node-key":this.activeNode,class:this.ns.b("tree"),data:this.nodes,draggable:this.draggable&&!this.readOnly,"allow-drop":this.allowDrop,"allow-drag":this.allowDrag,"default-expanded-keys":this.expendNodeKeys,"node-key":"id","highlight-current":!this.readOnly,"expand-on-click-node":!1,"auto-expand-parent":!1,indent:8,"render-content":this.renderTreeItem,onNodeExpand:e=>{this.handleNodeExpand(e)},onNodeCollapse:e=>{this.handleNodeCollapse(e)},onNodeDrop:this.handleDrop,onCurrentChange:this.handNodeSelect},null)])}}),q={install(e){e.component("IBizDesignTree",K)}};class H extends D{}var J=t({name:"IBizActiveHomeButton",props:{modelData:{type:Object,required:!0},controller:{type:H,required:!0}},setup:e=>({ns:f("active-home-button"),onActiveRoot:t=>{t.stopPropagation(),e.controller.panel.view.call("onActiveRoot")}}),render(){return o("div",{class:this.ns.b(),onClick:this.onActiveRoot},[o("i",{class:[this.ns.e("icon"),"fa fa-home"]},null)])}}),X=Object.defineProperty,$=(e,t,i)=>(((e,t,i)=>{t in e?X(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class Q{constructor(){$(this,"component","IBizActiveHomeButton")}async createController(e,t,i){const a=new H(e,t,i);return await a.init(),a}}var W={install(e){e.component("IBizActiveHomeButton",J),E("FIELD_ACTIVE_HOME_BUTTON",(()=>new Q))}},Y={install(e){e.use(W)}};const G=t({name:"IBizMemoFormControl",props:{controller:{type:Object,required:!0}},setup(e,{slots:t}){const i=f("memo-form"),a=e.controller,s={form:a},l=t=>{var i;const a={};return null==(i=t.controlAttributes)||i.forEach((t=>{t.attrName&&t.attrValue&&(a[t.attrName]=S.execSingleLine(t.attrValue,{...e.controller.getEventArgs(),data:e.controller.data}))})),a},d=(e,i=!0)=>{if(e.hidden)return;const s=e.id;if(t[s])return c(t,s,{model:e,data:a.state.data,value:a.state.data[s]});const h={};"FORMITEM"===e.detailType&&t["".concat(s,"_editor")]&&(h.default=(...e)=>t["".concat(s,"_editor")](...e));const u=I(e);u.length&&(h.default=()=>u.map((e=>d(e))));const m=a.providers[s];if(!m)return o("div",null,[ibiz.i18n.t("control.form.noSupportDetailType",{detailType:e.detailType})]);const p=n(m.component);if("FORMITEM"===e.detailType&&i){const t=e;if(t.editor&&"TEXTAREA"===t.editor.editorType&&"memo"===t.codeName)return}return r(p,{modelData:e,controller:a.details[s],key:e.id,attrs:l(e)},h)},h=e=>{const{modelData:t}=e;return(t instanceof Array?t:[t]).map((e=>d(e)))};return h.props=["modelData"],s.FormDetail=h,{ns:i,c:a,FormDetail:h,slotProps:s,renderByDetailType:d,renderAttrs:l}},render(){const{state:e,model:t,controlPanel:i}=this.c,{isCreated:a}=e,s={};if(a)if(this.$slots.default)s.default=()=>this.$slots.default({...this.slotProps});else{const e=t.controlType===C.SEARCHFORM?"searchform":"form",a=i?e:"default";let l;this.c.formItems.some((e=>{const t=e.model;if("FORMITEM"===t.detailType&&t.editor&&"TEXTAREA"===t.editor.editorType&&"memo"===t.codeName)return l=t,!0})),s[a]=()=>[o("div",{class:this.ns.b("container")},[o("div",{class:this.ns.b("content")},[o(n("iBizFormPage"),{modelData:this.c.model,controller:this.c},{default:()=>{var e;return[null==(e=this.c.model.deformPages)?void 0:e.map((e=>this.renderByDetailType(e)))]}})]),o("div",{class:this.ns.b("footer")},[l&&o(n("iBizFormItem"),{modelData:l,controller:this.c.details[l.id],key:l.id,attrs:this.renderAttrs(l)},{default:e=>{const t=n("IBizMarkdownMemoEditor");return r(t,{...e})}})])])]}return o(n("iBizControlBase"),{class:[this.ns.b()],controller:this.c},"function"==typeof(c=s)||"[object Object]"===Object.prototype.toString.call(c)&&!l(c)?s:{default:()=>[s]});var c}});var Z={install(e){e.component(G.name,G)}},ee=Object.defineProperty,te=(e,t,i)=>(((e,t,i)=>{t in e?ee(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class ie{constructor(){te(this,"component","IBizMemoEditFormControl")}}class ae extends P{constructor(e,t,i,a){const s=v(e),o=e=>{e.forEach((e=>{if("FORMITEM"===e.detailType){const t=e;t.editor&&(t.editor.editorParams||(t.editor.editorParams={}),Object.assign(t.editor.editorParams,{triggerMode:"input"}))}const t=I(e);t.length&&o(t)}))};o(s.deformPages||[]),super(s,t,i,a)}}const se=t({name:"IBizMemoEditFormControl",props:{modelData:{type:Object,required:!0},context:{type:Object,required:!0},params:{type:Object,default:()=>({})},provider:{type:Object},isSimple:{type:Boolean,required:!1},data:{type:Object,required:!1},loadDefault:{type:Boolean,default:!0}},setup(e){const t=y(((...e)=>new ae(...e)),{excludePropsKeys:["data"]});e.isSimple&&(t.evt.on("onMounted",(()=>{t.setSimpleData(e.data||{})})),a((()=>e.data),(e=>{const i=e||{};Object.keys(t.data).find((e=>i[e]!==t.data[e]))&&t.setSimpleData(i)}),{deep:!0}));const i=f("control-".concat(t.model.controlType.toLowerCase()));return t.evt.on("onCreated",(()=>{Object.keys(t.details).forEach((e=>{const i=t.details[e];i.state=d(i.state)}))})),{c:t,ns:i}},render(){return o(n("iBizMemoFormControl"),{class:this.ns.b(),controller:this.c},{...this.$slots})}});var oe={install(e){e.component(se.name,se),j("EDITFORM_RENDER_MEMOFORM",(()=>new ie))}},ne={install(e){e.use(Z),e.use(oe)}},re={install(e){e.use(ne)}};const le=t({name:"IBizMarkdownMemoEditor",props:w(),emits:g(),setup(e,{emit:t}){const s=f("markdown-memo-editor"),o=e.controller,n=h((()=>e.value?"".concat(e.value):"")),r=i(!1),l=localStorage.getItem("memo-form-collapsed");l&&(r.value="true"===l);const c=i();let d;const{UIStore:m}=b(),p=i(m.theme);a((()=>m.theme),(e=>{p.value=e,null==d||d.setTheme(p.value)}));const v=i("editOnly");a(n,((e,t)=>{if(!d)return;const i=d.getMarkdown();e!==t&&i!==e&&d.setMarkdown(e)}));const y=()=>{d&&t("change",d.getMarkdown())};return u((()=>{c.value&&((e.disabled||e.readonly)&&(v.value="previewOnly"),d=new B({el:c.value,value:n.value,theme:p.value,editor:{defaultModel:v.value,codemirror:{autofocus:!1}},toolbars:{theme:p.value,bubble:!1,float:!1,sidebar:!1,toolbar:["bold","italic","header","underline","link","togglePreview"]},callback:{afterChange:y}}),d.setTheme(p.value),d.switchModel(v.value))})),{c:o,ns:s,editorRef:c,isCollapsed:r,switchCollapsed:()=>{r.value=!r.value,localStorage.setItem("memo-form-collapsed",JSON.stringify(r.value))}}},render(){return o("div",{class:[this.ns.b(),this.ns.is("collapsed",this.isCollapsed),this.ns.is("readonly",this.disabled||this.readonly)]},[o("div",{class:[this.ns.b("title")]},[m("备注")]),o("div",{ref:"editorRef",class:[this.ns.b("content")]},null),o("div",{class:[this.ns.b("btn")],title:this.isCollapsed?"展开":"收缩",onClick:this.switchCollapsed},[o("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 1024 1024"},[o("path",{fill:"currentColor",d:"m192 384 320 384 320-384z"},null)])])])}});var ce=Object.defineProperty,de=(e,t,i)=>(((e,t,i)=>{t in e?ce(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class he{constructor(){de(this,"formEditor","IBizMarkdownMemoEditor"),de(this,"gridEditor","IBizMarkdownMemoEditor")}async createController(e,t){const i=new N(e,t);return await i.init(),i}}var ue={install(e){e.component(le.name,le),x("EDITOR_CUSTOMSTYLE_MARKDOWNMEMO",(()=>new he))}},me={install(e){e.use(ue)}},pe=Object.defineProperty,ve=(e,t,i)=>(((e,t,i)=>{t in e?pe(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class fe{constructor(){ve(this,"_data",null),ve(this,"evt",new F)}get data(){return this._data}set(e){this._data=e,this.evt.emit("change",this._data)}get(){return this.data}reset(){this._data=null,this.evt.emit("change",null)}on(e){return this.evt.on("change",e)}off(e){this.evt.off("change",e)}}e("SelectState",fe);var ye=Object.defineProperty,we=(e,t,i)=>(((e,t,i)=>{t in e?ye(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);e("DesignViewControllerBase",class extends O{constructor(){super(...arguments),we(this,"select",new fe),we(this,"preViewProvider")}getPreViewProvider(){return this.preViewProvider}async onCreated(){await super.onCreated();const{sysPFPluginId:e,appId:t}=this.model,i=T(e,t);if(i&&i.pluginParams){const e=i.pluginParams;Object.keys(e).forEach((t=>{e[t]&&"appId"!==t&&(this.context[t.toLowerCase()]=e[t])}))}await this.initPreViewProvider()}async initPreViewProvider(){throw new Error("Method not implemented.")}});var ge=Object.defineProperty,be=(e,t,i)=>(((e,t,i)=>{t in e?ge(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);e("DesignViewEngineBase",class extends M{constructor(){super(...arguments),be(this,"form"),be(this,"service"),be(this,"navPos"),be(this,"activePropertyView")}async onCreated(){await super.onCreated();{const e=R(this.view.model,"form");if(!e)throw new _(this.view,"未找到主数据表单模型");this.form=e;const t=ibiz.hub.getApp(this.view.model.appId);this.service=await t.deService.getService(this.view.context,this.form.appDataEntityId)}this.onSelect=this.onSelect.bind(this),this.view.select.on(this.onSelect),this.initViewShouldDismissHook(),await this.load()}async onMounted(){var e;await super.onMounted(),null==(e=this.toolbar)||e.calcButtonState(this.view.state.data,this.form.appDataEntityId),this.navPos=this.view.layoutPanel.panelItems.nav_pos,this.activeRoot(),this.initPropertyView(),this.view.evt.emit("onViewInfoChange",{dataInfo:this.view.state.data.srfmajortext||""})}initViewShouldDismissHook(){this.view.modal.hooks.shouldDismiss.tapPromise((async e=>{if(!0===ibiz.uiDomainManager.get(this.view.context.srfsessionid).dataModification&&null==e.allowClose){const t=await ibiz.confirm.error({title:"关闭提醒",desc:"数据已经修改，确定要关闭？"});e.allowClose=!!t}}))}initPropertyView(){var e;(null==(e=this.view.layoutPanel)?void 0:e.evt).on("onPresetPanelItemEvent",(e=>{const{panelItemEventName:t,panelItemName:i,presetParams:a}=e;"nav_pos"===i&&"onViewCreated"===t&&(this.activePropertyView=a.view)}))}onSelect(e){e&&this.onActive(e)}activeRoot(){this.view.select.set({id:this.view.state.data.srfkey,label:this.view.state.data.srfmajortext,type:"",data:this.view.state.data})}async load(){try{this.view.startLoading();const e=await this.service.get(this.view.context,this.view.params);return e.ok&&e.data?(this.service.local.add(this.view.context,e.data),this.view.state.data=e.data,e.data):null}finally{this.view.endLoading()}}async save(){try{this.view.startLoading();const e=await this.service.getTemp(this.view.context);if(e.ok&&e.data){const t=e.data;for(const e in t)if(Object.prototype.hasOwnProperty.call(t,e)){"object"==typeof t[e]&&(t[e]=void 0)}const i=await this.service.update(this.view.context,t);if(i.ok&&i.data)return this.service.local.add(this.view.context,i.data),this.view.state.data=i.data,this.view.evt.emit("onViewInfoChange",{dataInfo:this.view.state.data.srfmajortext||""}),ibiz.message.success("".concat(this.view.state.data.srfmajortext,"保存成功!")),i.data}return null}finally{this.view.endLoading()}}async call(e,t){if(e===k.SAVE)return this.save();if("onActive"!==e){if("onActiveRoot"!==e)return super.call(e,t);this.activeRoot()}else this.view.select.set(t)}async onActive(e){const t=e.data.srfdecodename,i=this.view.model.viewLayoutPanel.appViewRefs;if(i){const a=e.type?e.type.toUpperCase():null,s=i.find((e=>e.name==="EDITDATA:".concat(t.toUpperCase()).concat(a?":".concat(a):"")));if(s){const i=this.view.context.clone();i[t.toLowerCase()]=e.id;const{navigateContexts:a}=s;Object.assign(i,A(a,e.data,i)),this.navPos.openView({key:e.id,viewId:s.refAppViewId,context:i})}}}});var De=Object.defineProperty,Ee=(e,t,i)=>(((e,t,i)=>{t in e?De(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);const Ce=class e{constructor(){Ee(this,"preViewProviderMap",new Map)}static getInstance(){return e.DesignPreViewFactory||(e.DesignPreViewFactory=new e),this.DesignPreViewFactory}registerProvider(e,t){this.preViewProviderMap.set(e,t)}getProvider(e){return this.preViewProviderMap.get(e)}};Ee(Ce,"DesignPreViewFactory");e("DesignPreViewFactory",Ce);e("PreViewProviderBase",class{async init(e){}getTargetDataBySourceData(e,t){return t}getPropertyByTag(e){return[]}});var Se=Object.defineProperty,Ie=(e,t,i)=>(((e,t,i)=>{t in e?Se(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class Pe extends z{constructor(){super(...arguments),Ie(this,"majorData",{}),Ie(this,"itemDatas",[]),Ie(this,"refreshTag",V())}}e("DesignContentState",Pe);var je=Object.defineProperty,Ne=(e,t,i)=>(((e,t,i)=>{t in e?je(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);e("DesignContentController",class extends D{constructor(){super(...arguments),Ne(this,"majorService"),Ne(this,"itemService"),Ne(this,"majorEntity"),Ne(this,"itemEntity")}get majorForm(){return R(this.view.model,"form")}get itemForm(){return R(this.view.model,"item")}get view(){return this.panel.view}createState(){var e;return new Pe(null==(e=this.parent)?void 0:e.state)}async onInit(){await super.onInit(),await this.initBaseResource(),await this.load(),await this.subscribeDataChange()}async initBaseResource(){const e=ibiz.hub.getApp(this.view.model.appId);this.majorEntity=await ibiz.hub.getAppDataEntity(this.majorForm.appDataEntityId,this.view.model.appId),this.majorService=await e.deService.getService(this.panel.context,this.majorForm.appDataEntityId),this.itemEntity=await ibiz.hub.getAppDataEntity(this.itemForm.appDataEntityId,this.view.model.appId),this.itemService=await e.deService.getService(this.panel.context,this.itemForm.appDataEntityId)}async subscribeDataChange(){this.refresh=this.refresh.bind(this),this.onDEDataChange=this.onDEDataChange.bind(this),this.view.evt.on("onUpdateSuccess",this.refresh),this.view.evt.on("onCreateSuccess",this.refresh),this.view.evt.on("onRemoveSuccess",this.refresh),ibiz.mc.command.change.on(this.onDEDataChange)}async unSubscribeDataChange(){this.view.evt.off("onUpdateSuccess",this.refresh),this.view.evt.off("onCreateSuccess",this.refresh),this.view.evt.off("onRemoveSuccess",this.refresh),ibiz.mc.command.change.off(this.onDEDataChange)}async load(){const e=await this.majorService.getTemp(this.panel.context,this.panel.params);if(e.ok&&e.data){const t=e.data,i=await this.itemService.fetchDefault(this.panel.context,this.panel.params);if(i.ok&&i.data){const e=i.data;await this.afterLoad({majorData:t,itemDatas:e})}}}async afterLoad(e){const{majorData:t,itemDatas:i}=e;this.state.majorData=t,this.state.itemDatas.length=0,this.state.itemDatas.push(...i)}async refresh(){await this.load(),this.state.refreshTag=V()}onDEDataChange(e){const{data:t}=e;t&&t.srfdecodename===this.itemEntity.codeName&&this.refresh()}destroy(){super.destroy(),this.unSubscribeDataChange()}});var xe=Object.defineProperty,Oe=(e,t,i)=>(((e,t,i)=>{t in e?xe(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class Te extends z{constructor(){super(...arguments),Oe(this,"items",[]),Oe(this,"treeData",[]),Oe(this,"actions",[{type:"add",icon:"add-outline",tooltip:"新增"},{type:"remove",icon:"close-outline",tooltip:"删除"}]),Oe(this,"rules",new Map),Oe(this,"activeNode","")}}e("DesignOperationState",Te);var Me=Object.defineProperty,Re=(e,t,i)=>(((e,t,i)=>{t in e?Me(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);e("DesignOperationController",class extends D{constructor(){super(...arguments),Re(this,"majorService"),Re(this,"itemService"),Re(this,"majorEntity"),Re(this,"itemEntity"),Re(this,"typeKeyName","itemtype"),Re(this,"itemEntityKeyName",""),Re(this,"newItems",[]),Re(this,"ruleData"),Re(this,"defaultRoot",null),Re(this,"treeRef")}get view(){return this.panel.view}get majorForm(){return R(this.view.model,"form")}get itemForm(){return R(this.view.model,"item")}createState(){var e;return new Te(null==(e=this.parent)?void 0:e.state)}async onInit(){var e;await super.onInit(),this.state.activeNode=(null==(e=this.view.select.data)?void 0:e.id)||"",await this.initBaseResource(),this.initUserParam(),await this.load(),await this.subscribeDataChange()}async initBaseResource(){var e;const t=ibiz.hub.getApp(this.view.model.appId);this.majorEntity=await ibiz.hub.getAppDataEntity(this.majorForm.appDataEntityId,this.view.model.appId),this.majorService=await t.deService.getService(this.panel.context,this.majorForm.appDataEntityId),this.itemEntity=await ibiz.hub.getAppDataEntity(this.itemForm.appDataEntityId,this.view.model.appId),this.itemEntityKeyName="".concat(null==(e=this.itemEntity)?void 0:e.codeName.toLowerCase(),"id"),this.itemService=await t.deService.getService(this.panel.context,this.itemForm.appDataEntityId)}async subscribeDataChange(){this.refresh=this.refresh.bind(this),this.onDEDataChange=U(this.onDEDataChange.bind(this),200),this.view.evt.on("onUpdateSuccess",this.refresh),this.view.evt.on("onCreateSuccess",this.refresh),this.view.evt.on("onRemoveSuccess",this.refresh),ibiz.mc.command.change.on(this.onDEDataChange),this.onSelectDataChange=this.onSelectDataChange.bind(this),this.view.select.on(this.onSelectDataChange)}async unSubscribeDataChange(){this.view.evt.off("onUpdateSuccess",this.refresh),this.view.evt.off("onCreateSuccess",this.refresh),this.view.evt.off("onRemoveSuccess",this.refresh),ibiz.mc.command.change.off(this.onDEDataChange),this.view.select.off(this.onSelectDataChange)}initUserParam(){const e=this.majorForm.userParam;if(e){this.typeKeyName=e.fileType;try{if(this.ruleData=(null==e?void 0:e.ruleData)?JSON.parse(e.ruleData):{},this.newItems=(null==e?void 0:e.newItems)?JSON.parse(e.newItems):[],this.defaultRoot=(null==e?void 0:e.defaultRoot)?JSON.parse(e.defaultRoot):{},this.ruleData){const e=new Map;for(const t in this.ruleData)e.set(t,new RegExp(this.ruleData[t]));this.state.rules=e}}catch(e){ibiz.log.error("JSON序列化出错!".concat(e))}}}async load(){const e=await this.majorService.getTemp(this.panel.context,this.panel.params);let t={},i=[];if(e.ok&&e.data&&(t=e.data),t){const e=await this.itemService.fetchDefault(this.panel.context,this.panel.params);e.ok&&e.data&&(i=e.data)}await this.afterLoad({majorData:t,itemDatas:i})}async afterLoad(e){const{majorData:t,itemDatas:i}=e,a={};if(t){const e=this.generateTreeNode(t);Object.assign(a,{...e,children:[]})}i&&i.length>0&&(this.state.items=i,i.forEach((e=>{if(!e["p".concat(this.itemEntityKeyName)]){const t=this.generateTreeNode(e);this.calcTreeNodes(i,t),a.children.push(t)}}))),this.state.treeData.length=0,this.state.treeData.push(a),this.treeRef&&this.treeRef.expandAll()}async refresh(){var e;if(await this.load(),null==(e=this.view.select.data)?void 0:e.id){this.state.items.find((e=>{var t;return e.srfkey===(null==(t=this.view.select.data)?void 0:t.id)}))||this.panel.view.call("onActiveRoot")}}onSelectDataChange(e){this.state.activeNode=(null==e?void 0:e.id)||""}onDEDataChange(e){const{data:t}=e;if(t&&t.srfdecodename){const e=t.srfdecodename;e!==this.itemEntity.codeName&&e!==this.majorEntity.codeName||this.refresh()}}generateTreeNode(e){const t=e[this.typeKeyName],i=this.newItems.find((e=>e.type===t));let a="";i&&(a=i.icon),1===e.hiddenitem&&(a="eye-off-outline"),0===e.enablemode&&(a="ban-outline");return{id:e.srfkey,label:e.text,type:e.itemtype,icon:a,data:e}}calcTreeNodes(e,t){e&&(t.children=[],e.forEach((i=>{const a="p".concat(this.itemEntityKeyName);if(null!=i[a]&&i[a]===t.id){const a=this.generateTreeNode(i);t.children.push(a),this.calcTreeNodes(e,a)}})))}setTreeRef(e){this.treeRef=e}onNodeSelect(e,t){const i=e.data;1===t.level?this.view.call("onActiveRoot"):this.view.call("onActive",{id:i.srfkey,label:i.srfmajortext,type:i.itemtype,data:i})}onActionClick(e,t,i){const{type:a}=t;switch(a){case"add":return void this.createItem(e,i);case"remove":return void this.remove(i);default:ibiz.log.error("".concat(a,"类型暂不支持"))}}async createItem(e,t){throw new Error("Method not implemented.")}async create(e){const t=await this.itemService.createTemp(this.panel.context,e);if(t.ok&&Array.isArray(t.data)){this.view.evt.emit("onCreateSuccess",void 0);const e=t.data[t.data.length-1];e&&this.view.call("onActive",{id:e.srfkey,label:e.srfmajortext,type:e.itemtype,data:e})}else ibiz.log.error("新建表格列失败")}async remove(e){var t;const i=this.panel.context.clone();Object.assign(i,{[this.itemEntity.codeName.toLowerCase()]:e[this.itemEntityKeyName]});(await this.itemService.remove(i,this.panel.params,e)).ok?(this.view.evt.emit("onRemoveSuccess",void 0),(null==(t=this.view.select.data)?void 0:t.id)===(null==e?void 0:e.srfkey)&&this.panel.view.call("onActiveRoot")):ibiz.message.error("删除失败!")}async onNodeDrop(e,t,i){var a;let s=t.parent;"inner"===i&&(s=t);const o=null==(a=null==s?void 0:s.data)?void 0:a.data,n=async(e,t)=>{var i,a;e.ordervalue=L(t),e.srfordervalue=e.ordervalue,this.panel.context[this.majorEntity.codeName.toLowerCase()]!==(null==o?void 0:o.srfkey)?e["p".concat(null==(i=this.itemEntity.codeName)?void 0:i.toLowerCase(),"id")]=o.srfkey:(e["p".concat(null==(a=this.itemEntity.codeName)?void 0:a.toLowerCase(),"id")]=null,e.srfpmajortext=null),await this.itemService.update(this.panel.context,e)};if(s&&s.childNodes.length>0)for(let e=0;e<s.childNodes.length;e++){const{data:t}=s.childNodes[e].data;await n(t,e)}this.view.evt.emit("onUpdateSuccess",void 0)}destroy(){super.destroy(),this.unSubscribeDataChange()}});e("default",{install(e){e.use(q),e.use(Y),e.use(re),e.use(me)}})}}}));
