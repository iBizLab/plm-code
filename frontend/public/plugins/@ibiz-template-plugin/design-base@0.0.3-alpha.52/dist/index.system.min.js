System.register(["vue","ramda","@ibiz-template/vue3-util","@ibiz-template/runtime","cherry-markdown","@ibiz-template/core","lodash-es","qx-util"],(function(e,t){"use strict";var a,i,s,n,o,r,l,c,d,u,h,m,p,v,y,f,w,b,g,C,D,S,E,P,I,V,T,x,O,j,N,k,A,R,M,F,z,B,L,U,_,K,q,H,J,W;return{setters:[function(e){a=e.defineComponent,i=e.ref,s=e.watch,n=e.nextTick,o=e.createVNode,r=e.resolveComponent,l=e.h,c=e.isVNode,d=e.renderSlot,u=e.reactive,h=e.computed,m=e.onMounted,p=e.createTextVNode},function(e){v=e.uniq,y=e.clone},function(e){f=e.useNamespace,w=e.useControlController,b=e.getInputProps,g=e.getEditorEmits,C=e.useUIStore},function(e){D=e.PanelItemController,S=e.registerPanelItemProvider,E=e.ControlType,P=e.ScriptFactory,I=e.findChildFormDetails,V=e.EditFormController,T=e.registerControlProvider,x=e.CodeListEditorController,O=e.registerEditorProvider,j=e.EditorController,N=e.PluginStaticResource,k=e.ViewController,A=e.getPFPlugin,R=e.ViewEngineBase,M=e.getControl,F=e.SysUIActionTag,z=e.convertNavData,B=e.PanelItemState},function(e){L=e.default},function(e){U=e.debounce,_=e.clone,K=e.RuntimeModelError},function(e){q=e.debounce},function(e){H=e.createUUID,J=e.QXEvent,W=e.generateOrderValue}],execute:function(){var X=a({name:"IBizDesignTree",props:{readOnly:{type:Boolean,default:!1},draggable:{type:Boolean,default:!0},dropRules:{type:Object,default:()=>new Map},actions:{type:Array,default:()=>[]},renderItem:{type:Object,required:!1},nodes:{type:Object,required:!0},activeNode:{type:String}},emits:["nodeSelect","actionClick","nodeDrop"],setup(e,{emit:t}){const a=f("design_tree"),r=i([]),l=(t,a)=>{const{data:i,node:s}=t,n=e.dropRules.get(i.type);return(1!==s.level||"add"===a.type)&&(null!=n||"add"!==a.type)},c=(e,a,i)=>{e.stopPropagation(),t("actionClick",e,a,i)},d=(e,t)=>{e.forEach((e=>{if(null!=(null==e?void 0:e.children)){-1===t.findIndex((t=>e.id===t))&&r.value.push(e.id),d(e.children,t)}}))},u=()=>{if(e.nodes){const t=v(r.value);d(e.nodes,t)}};u();const h=i();return s(e.nodes,(()=>{n((()=>{var t,a;h.value&&(null==(a=(t=h.value).setCurrentKey)||a.call(t,e.activeNode))}))})),{ns:a,expendNodeKeys:r,tree:h,renderTreeItem:(t,i)=>{if(e.renderItem)return e.renderItem(t,i);const{data:s}=i;return o("div",{class:a.e("component")},[o("div",{class:a.e("item")},[o("div",{class:a.e("item-label"),title:s.label},[s.icon?o("ion-icon",{class:"".concat(a.e("item-icon")),name:s.icon},null):null,o("span",{class:a.e("item-caption")},[s.label])]),!e.readOnly&&e.actions.length>0?o("div",{class:{[a.e("actions")]:!0,first:1===i.node.level}},[o("div",{class:a.e("item-actions")},[e.actions.map((e=>l(i,e)&&!e.visible?o("div",{class:a.e("item-action-item"),title:e.tooltip,onClick:t=>c(t,e,s.data)},[o("ion-icon",{name:e.icon},null)]):null))]),o("div",{class:a.e("default-actions")},[e.actions.map((e=>l(i,e)&&e.visible?o("div",{class:a.e("item-action-item"),title:e.tooltip,onClick:t=>c(t,e,s.data)},[o("ion-icon",{name:e.icon},null)]):null))])]):null])])},allowDrag:e=>0!==e.level,allowDrop:(t,a,i)=>{if(Object.is(i,"inner")){if((null==a?void 0:a.data)&&(null==t?void 0:t.data)){const i=e.dropRules.get(a.data.type);return!!(null==i?void 0:i.test(t.data.type))}}else{if(0===(null==a?void 0:a.level))return!1;if((null==a?void 0:a.data)&&(null==t?void 0:t.data)&&a.parent){const i=e.dropRules.get(a.parent.data.type);return!!(null==i?void 0:i.test(t.data.type))}}return!1},handleDrop:(e,a,i)=>{t("nodeDrop",e,a,i)},handNodeSelect:(e,a)=>{t("nodeSelect",e,a)},handleNodeExpand:e=>{-1===r.value.findIndex((t=>e.id===t))&&r.value.push(e.id)},handleNodeCollapse:e=>{const t=r.value.findIndex((t=>e.id===t));-1!==t&&r.value.splice(t,1)},expandAll:u}},render(){const e={[this.ns.b()]:!0,[this.ns.is("readonly")]:this.readOnly};return o("div",{class:e},[o(r("el-tree"),{ref:"tree","current-node-key":this.activeNode,class:this.ns.b("tree"),data:this.nodes,draggable:this.draggable&&!this.readOnly,"allow-drop":this.allowDrop,"allow-drag":this.allowDrag,"default-expanded-keys":this.expendNodeKeys,"node-key":"id","highlight-current":!this.readOnly,"expand-on-click-node":!1,"auto-expand-parent":!1,indent:8,"render-content":this.renderTreeItem,onNodeExpand:e=>{this.handleNodeExpand(e)},onNodeCollapse:e=>{this.handleNodeCollapse(e)},onNodeDrop:this.handleDrop,onCurrentChange:this.handNodeSelect},null)])}}),Y={install(e){e.component("IBizDesignTree",X)}};class $ extends D{}var G=a({name:"IBizActiveHomeButton",props:{modelData:{type:Object,required:!0},controller:{type:$,required:!0}},setup:e=>({ns:f("active-home-button"),onActiveRoot:t=>{t.stopPropagation(),e.controller.panel.view.call("onActiveRoot")}}),render(){return o("div",{class:this.ns.b(),onClick:this.onActiveRoot},[o("i",{class:[this.ns.e("icon"),"fa fa-home"]},null)])}}),Q=Object.defineProperty,Z=(e,t,a)=>(((e,t,a)=>{t in e?Q(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a})(e,"symbol"!=typeof t?t+"":t,a),a);class ee{constructor(){Z(this,"component","IBizActiveHomeButton")}async createController(e,t,a){const i=new $(e,t,a);return await i.init(),i}}var te={install(e){e.component("IBizActiveHomeButton",G),S("FIELD_ACTIVE_HOME_BUTTON",(()=>new ee))}},ae={install(e){e.use(te)}};const ie=a({name:"IBizMemoFormControl",props:{controller:{type:Object,required:!0}},setup(e,{slots:t}){const a=f("memo-form"),i=e.controller,s={form:i},n=t=>{var a;const i={};return null==(a=t.controlAttributes)||a.forEach((t=>{t.attrName&&t.attrValue&&(i[t.attrName]=P.execSingleLine(t.attrValue,{...e.controller.getEventArgs(),data:e.controller.data}))})),i},c=(e,a=!0)=>{if(e.hidden)return;const s=e.id;if(t[s])return d(t,s,{model:e,data:i.state.data,value:i.state.data[s]});const u={};"FORMITEM"===e.detailType&&t["".concat(s,"_editor")]&&(u.default=(...e)=>t["".concat(s,"_editor")](...e));const h=I(e);h.length&&(u.default=()=>h.map((e=>c(e))));const m=i.providers[s];if(!m)return o("div",null,[ibiz.i18n.t("control.form.noSupportDetailType",{detailType:e.detailType})]);const p=r(m.component);if("FORMITEM"===e.detailType&&a){const t=e;if(t.editor&&"TEXTAREA"===t.editor.editorType&&"memo"===t.codeName)return}return l(p,{modelData:e,controller:i.details[s],key:e.id,attrs:n(e)},u)},u=e=>{const{modelData:t}=e;return(t instanceof Array?t:[t]).map((e=>c(e)))};return u.props=["modelData"],s.FormDetail=u,{ns:a,c:i,FormDetail:u,slotProps:s,renderByDetailType:c,renderAttrs:n}},render(){const{state:e,model:t,controlPanel:a}=this.c,{isCreated:i}=e,s={};if(i)if(this.$slots.default)s.default=()=>this.$slots.default({...this.slotProps});else{const e=t.controlType===E.SEARCHFORM?"searchform":"form",i=a?e:"default";let n;this.c.formItems.some((e=>{const t=e.model;if("FORMITEM"===t.detailType&&t.editor&&"TEXTAREA"===t.editor.editorType&&"memo"===t.codeName)return n=t,!0})),s[i]=()=>[o("div",{class:this.ns.b("container")},[o("div",{class:this.ns.b("content")},[o(r("iBizFormPage"),{modelData:this.c.model,controller:this.c},{default:()=>{var e;return[null==(e=this.c.model.deformPages)?void 0:e.map((e=>this.renderByDetailType(e)))]}})]),o("div",{class:this.ns.b("footer")},[n&&o(r("iBizFormItem"),{modelData:n,controller:this.c.details[n.id],key:n.id,attrs:this.renderAttrs(n)},{default:e=>{const t=r("IBizMarkdownMemoEditor");return l(t,{...e})}})])])]}return o(r("iBizControlBase"),{class:[this.ns.b()],controller:this.c},"function"==typeof(n=s)||"[object Object]"===Object.prototype.toString.call(n)&&!c(n)?s:{default:()=>[s]});var n}});var se={install(e){e.component(ie.name,ie)}},ne=Object.defineProperty,oe=(e,t,a)=>(((e,t,a)=>{t in e?ne(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a})(e,"symbol"!=typeof t?t+"":t,a),a);class re{constructor(){oe(this,"component","IBizMemoEditFormControl")}}class le extends V{constructor(e,t,a,i){const s=y(e),n=e=>{e.forEach((e=>{if("FORMITEM"===e.detailType){const t=e;t.editor&&(t.editor.editorParams||(t.editor.editorParams={}),Object.assign(t.editor.editorParams,{triggerMode:"input"}))}const t=I(e);t.length&&n(t)}))};n(s.deformPages||[]),super(s,t,a,i)}}const ce=a({name:"IBizMemoEditFormControl",props:{modelData:{type:Object,required:!0},context:{type:Object,required:!0},params:{type:Object,default:()=>({})},provider:{type:Object},isSimple:{type:Boolean,required:!1},data:{type:Object,required:!1},loadDefault:{type:Boolean,default:!0}},setup(e){const t=w(((...e)=>new le(...e)),{excludePropsKeys:["data"]});e.isSimple&&(t.evt.on("onMounted",(()=>{t.setSimpleData(e.data||{})})),s((()=>e.data),(e=>{const a=e||{};Object.keys(t.data).find((e=>a[e]!==t.data[e]))&&t.setSimpleData(a)}),{deep:!0}));const a=f("control-".concat(t.model.controlType.toLowerCase()));return t.evt.on("onCreated",(()=>{Object.keys(t.details).forEach((e=>{const a=t.details[e];a.state=u(a.state)}))})),{c:t,ns:a}},render(){return o(r("iBizMemoFormControl"),{class:this.ns.b(),controller:this.c},{...this.$slots})}});var de={install(e){e.component(ce.name,ce),T("EDITFORM_RENDER_MEMOFORM",(()=>new re))}},ue={install(e){e.use(se),e.use(de)}},he={install(e){e.use(ue)}};const me=a({name:"IBizMarkdownMemoEditor",props:b(),emits:g(),setup(e,{emit:t}){const a=f("markdown-memo-editor"),n=e.controller,o=h((()=>e.value?"".concat(e.value):"")),r=i(!1),l=localStorage.getItem("memo-form-collapsed");l&&(r.value="true"===l);const c=i();let d;const{UIStore:u}=C(),p=i(u.theme);s((()=>u.theme),(e=>{p.value=e,null==d||d.setTheme(p.value)}));const v=i("editOnly");s(o,((e,t)=>{if(!d)return;const a=d.getMarkdown();e!==t&&a!==e&&d.setMarkdown(e)}));const y=()=>{d&&t("change",d.getMarkdown())};return m((()=>{c.value&&((e.disabled||e.readonly)&&(v.value="previewOnly"),d=new L({el:c.value,value:o.value,theme:p.value,editor:{defaultModel:v.value,codemirror:{autofocus:!1}},toolbars:{theme:p.value,bubble:!1,float:!1,sidebar:!1,toolbar:["bold","italic","header","underline","link","togglePreview"]},callback:{afterChange:y}}),d.setTheme(p.value),d.switchModel(v.value))})),{c:n,ns:a,editorRef:c,isCollapsed:r,switchCollapsed:()=>{r.value=!r.value,localStorage.setItem("memo-form-collapsed",JSON.stringify(r.value))}}},render(){return o("div",{class:[this.ns.b(),this.ns.is("collapsed",this.isCollapsed),this.ns.is("readonly",this.disabled||this.readonly)]},[o("div",{class:[this.ns.b("title")]},[p("备注")]),o("div",{ref:"editorRef",class:[this.ns.b("content")]},null),o("div",{class:[this.ns.b("btn")],title:this.isCollapsed?"展开":"收缩",onClick:this.switchCollapsed},[o("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 1024 1024"},[o("path",{fill:"currentColor",d:"m192 384 320 384 320-384z"},null)])])])}});var pe=Object.defineProperty,ve=(e,t,a)=>(((e,t,a)=>{t in e?pe(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a})(e,"symbol"!=typeof t?t+"":t,a),a);class ye{constructor(){ve(this,"formEditor","IBizMarkdownMemoEditor"),ve(this,"gridEditor","IBizMarkdownMemoEditor")}async createController(e,t){const a=new x(e,t);return await a.init(),a}}var fe={install(e){e.component(me.name,me),O("EDITOR_CUSTOMSTYLE_MARKDOWNMEMO",(()=>new ye))}};const we=a({name:"ViewNavParams",props:b(),emits:["change"],setup(e,{emit:t}){const a=f("view-nav-params"),n=e.controller,l=i(!1),c=i(""),d=i([]),u=[{label:"默认",value:"DEFAULT"},{label:"上下文",value:"SRFNAVCTX"},{label:"视图参数",value:"SRFNAVPARAM"}],h=[{label:"直接值",value:1},{label:"填充值",value:2}];s((()=>e.value),(()=>{c.value=e.value,(e=>{const t=e.split("\n"),a=[];t.forEach((e=>{if(!e)return;const t=e.split("=");let i="DEFAULT",s="",n=t[1],o=1;if(t[0].indexOf(".")>=0){const e=t[0].split(".");i=e[0],s=e[1]}else s=t[0];t[1].startsWith("%")&&t[1].endsWith("%")&&(n=t[1].slice(1,-1),o=2),a.push({paramType:i,paramKey:s,paramValue:n,paramValueType:o})})),d.value=a})(e.value||"")}),{immediate:!0});const m=()=>d.value.map((e=>{const t="DEFAULT"===e.paramType?"":"".concat(e.paramType,"."),a=e.paramKey?"".concat(e.paramKey):"",i=1===e.paramValueType?e.paramValue:"%".concat(e.paramValue,"%");return"".concat(t).concat(a,"=").concat(i)})).join("\n"),p=U((()=>{t("change",c.value)}),500),v=()=>{c.value=m(),p()};return{ns:a,c:n,isCustom:l,items:d,curValue:c,onValueChange:v,renderSelectList:()=>d.value.map(((t,i)=>o("div",{class:a.e("item")},[o("div",{class:a.em("item","param-type")},[o(r("el-select"),{modelValue:t.paramType,"onUpdate:modelValue":e=>t.paramType=e,onChange:v,readonly:e.readonly,disabled:e.disabled},{default:()=>u.map((e=>o(r("el-option"),{key:e.value,label:e.label,value:e.value},null)))})]),o("div",{class:a.em("item","param-key")},[o(r("el-input"),{modelValue:t.paramKey,"onUpdate:modelValue":e=>t.paramKey=e,readonly:e.readonly,disabled:e.disabled,onInput:v},null)]),o("div",{class:a.em("item","param-value")},[o(r("el-input"),{modelValue:t.paramValue,"onUpdate:modelValue":e=>t.paramValue=e,readonly:e.readonly,disabled:e.disabled,onInput:v},null)]),o("div",{class:a.em("item","param-value-type")},[o(r("el-select"),{modelValue:t.paramValueType,"onUpdate:modelValue":e=>t.paramValueType=e,onChange:v,disabled:e.disabled},{default:()=>h.map((e=>o(r("el-option"),{key:e.value,label:e.label,value:e.value},null)))})]),o("div",{class:[a.em("item","remove"),a.is("disabled",e.disabled||e.readonly)],title:"删除",onClick:()=>(t=>{e.disabled||e.readonly||(d.value.splice(t,1),c.value=m(),p())})(i)},[o("ion-icon",{name:"close-outline"},null)]),o("div",{class:[a.em("item","copy"),a.is("disabled",e.disabled||e.readonly)],title:"复制",onClick:()=>(t=>{if(e.disabled||e.readonly)return;const a=_(d.value[t]);d.value.splice(t,0,a),c.value=m(),p()})(i)},[o("ion-icon",{name:"copy-outline"},null)])]))),onAddItem:()=>{e.disabled||e.readonly||(d.value.push({paramType:"DEFAULT",paramKey:"",paramValue:"",paramValueType:1}),c.value=m(),p())},onSwitchCustom:e=>{l.value=e},onCustomChange:()=>{p()}}},render(){return o("div",{class:this.ns.b()},[this.isCustom?o("div",{class:this.ns.e("custom")},[o("div",{class:this.ns.em("custom","textarea")},[o(r("el-input"),{type:"textarea",modelValue:this.curValue,"onUpdate:modelValue":e=>this.curValue=e,disabled:this.disabled,readonly:this.readonly,this:!0,rows:"6",onInput:this.onCustomChange},null)]),o("div",{class:this.ns.em("custom","close-custom")},[o("div",{class:this.ns.em("select","btn"),onClick:()=>this.onSwitchCustom(!1)},[p("关闭自定义")])])]):o("div",{class:this.ns.e("select")},[o("div",{class:this.ns.em("select","list")},[this.renderSelectList()]),o("div",{class:this.ns.em("select","use-custom")},[o("div",{class:[this.ns.em("select","btn")],onClick:()=>this.onSwitchCustom(!0)},[p("开启自定义")]),o("ion-icon",{class:[this.ns.em("select","add-icon"),this.ns.is("disabled",this.disabled||this.readonly)],name:"add-outline",onClick:this.onAddItem,title:"新增"},null)])])])}});class be extends j{}var ge=Object.defineProperty,Ce=(e,t,a)=>(((e,t,a)=>{t in e?ge(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a})(e,"symbol"!=typeof t?t+"":t,a),a);class De{constructor(){Ce(this,"formEditor","ViewNavParams"),Ce(this,"gridEditor","ViewNavParams")}async createController(e,t){const a=new be(e,t);return await a.init(),a}}var Se={install(e){e.component(we.name,we),O("EDITOR_CUSTOMSTYLE_VIEW_NAV_PARAMS",(()=>new De))}};const Ee=new N(t.meta.url);var Pe=a({name:"IBizEditorParmas",props:b(),emits:g(),setup(e,{emit:t}){var a;const n=e.controller,o=f("editor-params-custom"),r=i(!1);let l=null==(a=e.data)?void 0:a.editortype;const c=i(e.value),d=i({}),u={param:"",srfnavparam:"SRFNAVPARAM.",srfnavctx:"SRFNAVCTX."},h=i([]),m=i([]),p=e=>{if(!e)return;const t=e.split("\n"),a=[];t.forEach((e=>{if(!e)return;const t=e.indexOf("=");if(-1===t)return;const i=e.slice(0,t),s=e.slice(t+1);if(i)if(Object.prototype.hasOwnProperty.call(d.value,i))if(s)try{d.value[i]=JSON.parse(s)}catch(e){d.value[i]=s}else d.value[i]=void 0;else{let e=i,t="param";i.startsWith("SRFNAVPARAM.")?(e=i.slice(i.indexOf(".")+1),t="srfnavparam"):i.startsWith("SRFNAVCTX.")&&(e=i.slice(i.indexOf(".")+1),t="srfnavctx");const n={id:H(),key:e,value:s,type:t};a.push(n)}})),m.value=a},v=()=>{const e=[];m.value.forEach((t=>{t.key&&e.push("".concat(u[t.type]).concat(t.key,"=").concat(t.value))}));const a=[].join("\n"),i=e.join("\n");a?(c.value="".concat(a).concat(i?"\n".concat(i):""),t("change",c.value||null)):(c.value=i,t("change",c.value||null))};c.value&&p(c.value),s((()=>e.value),((e,t)=>{c.value&&p(c.value)})),s((()=>e.data),((t,a)=>{const i=null==t?void 0:t.editortype,s=e.value?e.value.toString():"";s?s===c.value&&i===l||p(s):m.value=[],l=i,c.value=s,v()}),{immediate:!0});return{ns:o,c:n,isCustom:r,changeIscustom:()=>{r.value=!r.value},dynamicItems:m,formItems:h,addDynamicParam:e=>{m.value.push({id:H(),key:"",value:"",type:e}),v()},editorParams:c,typeMap:u,formData:d,onEditorTypeChange:e=>{e?e!==l&&(h.value=[],d.value={}):(h.value=[],d.value={})},transformEditorParams:p,editorType:l,onCustomParamChange:e=>{q((()=>{t("change",e)}),0)()},onDynamicParamChange:(e,t,a)=>{t[a]=e;q((()=>{v()}),0)()},deleteDynamicParam:e=>{m.value.splice(e,1),v()}}},render(){return o("div",{class:this.ns.b()},[this.isCustom?o(r("el-input"),{class:[this.ns.e("param-textarea"),this.ns.is("readonly",this.readonly)],type:"textarea",rows:6,modelValue:this.editorParams,"onUpdate:modelValue":e=>this.editorParams=e,readonly:this.readonly,disabled:this.readonly,onInput:e=>this.onCustomParamChange(e)},null):o("div",{class:this.ns.e("param-container")},[o("div",{class:this.ns.e("param-list-from")},null),o("div",{class:this.ns.e("param-list-dynamic")},[this.dynamicItems.map(((e,t)=>o("div",{class:this.ns.e("param-item-dynamic"),key:e.id},[o("ion-icon",{src:Ee.dir("./assets/svg/".concat(e.type,".svg")),class:this.ns.em("param-item-dynamic","icon")},null),this.readonly?[o("div",{class:[this.ns.em("param-item-dynamic","key"),this.ns.is("readonly",this.readonly)]},[e.key]),o("div",{class:[this.ns.em("param-item-dynamic","value"),this.ns.is("readonly",this.readonly)]},[e.value])]:[o(r("el-input"),{class:this.ns.em("param-item-dynamic","key"),modelValue:e.key,"onUpdate:modelValue":t=>e.key=t,onChange:t=>this.onDynamicParamChange(t,e,"key")},null),o(r("el-input"),{class:this.ns.em("param-item-dynamic","value"),modelValue:e.value,"onUpdate:modelValue":t=>e.value=t,onChange:t=>this.onDynamicParamChange(t,e,"value")},null),o("ion-icon",{name:"close-outline",class:this.ns.em("param-item-dynamic","delete"),onClick:()=>this.deleteDynamicParam(t)},null)]])))])]),o("div",{class:this.ns.e("param-custom-button")},[o(r("el-button"),{size:"small",onClick:()=>this.changeIscustom()},{default:()=>["".concat(this.isCustom?"关闭":"开启","自定义")]}),this.readonly?null:o(r("el-dropdown"),{trigger:"click",size:"small",onCommand:this.addDynamicParam},{default:()=>o(r("el-button"),{size:"small"},{default:()=>[o("ion-icon",{name:"add-outline"},null)]}),dropdown:()=>o(r("el-dropdown-menu"),null,{default:()=>[o(r("el-dropdown-item"),{command:"param"},{default:()=>[p("参数")]}),o(r("el-dropdown-item"),{command:"srfnavparam"},{default:()=>[p("视图参数")]}),o(r("el-dropdown-item"),{command:"srfnavctx"},{default:()=>[p("视图上下文")]})]})})])])}});class Ie extends j{}var Ve=Object.defineProperty,Te=(e,t,a)=>(((e,t,a)=>{t in e?Ve(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a})(e,"symbol"!=typeof t?t+"":t,a),a);class xe{constructor(){Te(this,"formEditor","IBizEditorParmas"),Te(this,"gridEditor","IBizEditorParmas")}async createController(e,t){const a=new Ie(e,t);return await a.init(),a}}var Oe={install(e){e.component(Pe.name,Pe),O("EDITOR_CUSTOMSTYLE_EditorParamCustom",(()=>new xe))}},je={install(e){e.use(fe),e.use(Se),e.use(Oe)}},Ne=Object.defineProperty,ke=(e,t,a)=>(((e,t,a)=>{t in e?Ne(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a})(e,"symbol"!=typeof t?t+"":t,a),a);class Ae{constructor(){ke(this,"_data",null),ke(this,"evt",new J)}get data(){return this._data}set(e){this._data=e,this.evt.emit("change",this._data)}get(){return this.data}reset(){this._data=null,this.evt.emit("change",null)}on(e){return this.evt.on("change",e)}off(e){this.evt.off("change",e)}}e("SelectState",Ae);var Re=Object.defineProperty,Me=(e,t,a)=>(((e,t,a)=>{t in e?Re(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a})(e,"symbol"!=typeof t?t+"":t,a),a);e("DesignViewControllerBase",class extends k{constructor(){super(...arguments),Me(this,"select",new Ae),Me(this,"preViewProvider")}getPreViewProvider(){return this.preViewProvider}async onCreated(){await super.onCreated();const{sysPFPluginId:e,appId:t}=this.model,a=A(e,t);if(a&&a.pluginParams){const e=a.pluginParams;Object.keys(e).forEach((t=>{e[t]&&"appId"!==t&&(this.context[t.toLowerCase()]=e[t])}))}await this.initPreViewProvider()}async initPreViewProvider(){throw new Error("Method not implemented.")}});var Fe=Object.defineProperty,ze=(e,t,a)=>(((e,t,a)=>{t in e?Fe(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a})(e,"symbol"!=typeof t?t+"":t,a),a);e("DesignViewEngineBase",class extends R{constructor(){super(...arguments),ze(this,"form"),ze(this,"service"),ze(this,"navPos"),ze(this,"activePropertyView")}async onCreated(){await super.onCreated();{const e=M(this.view.model,"form");if(!e)throw new K(this.view,"未找到主数据表单模型");this.form=e;const t=ibiz.hub.getApp(this.view.model.appId);this.service=await t.deService.getService(this.view.context,this.form.appDataEntityId)}this.onSelect=this.onSelect.bind(this),this.view.select.on(this.onSelect),this.initViewShouldDismissHook(),await this.load(),this.initCustomParams()}async onMounted(){var e;await super.onMounted(),null==(e=this.toolbar)||e.calcButtonState(this.view.state.data,this.form.appDataEntityId),this.navPos=this.view.layoutPanel.panelItems.nav_pos,this.activeRoot(),this.initPropertyView(),this.view.evt.emit("onViewInfoChange",{dataInfo:this.view.state.data.srfmajortext||""})}initViewShouldDismissHook(){this.view.modal.hooks.shouldDismiss.tapPromise((async e=>{if(!0===ibiz.uiDomainManager.get(this.view.context.srfsessionid).dataModification&&null==e.allowClose){const t=await ibiz.confirm.error({title:"关闭提醒",desc:"数据已经修改，确定要关闭？"});e.allowClose=!!t}}))}initCustomParams(){}initPropertyView(){var e;(null==(e=this.view.layoutPanel)?void 0:e.evt).on("onPresetPanelItemEvent",(e=>{const{panelItemEventName:t,panelItemName:a,presetParams:i}=e;"nav_pos"===a&&"onViewCreated"===t&&(this.activePropertyView=i.view)}))}onSelect(e){e&&this.onActive(e)}activeRoot(){this.view.select.set({id:this.view.state.data.srfkey,label:this.view.state.data.srfmajortext,type:"",data:this.view.state.data})}async load(){try{this.view.startLoading();const e=await this.service.get(this.view.context,this.view.params);return e.ok&&e.data?(this.service.local.add(this.view.context,e.data),this.view.state.data=e.data,e.data):null}finally{this.view.endLoading()}}async save(){try{this.view.startLoading();const e=await this.service.getTemp(this.view.context);if(e.ok&&e.data){const t=e.data;for(const e in t)if(Object.prototype.hasOwnProperty.call(t,e)){"object"==typeof t[e]&&(t[e]=void 0)}const a=await this.service.update(this.view.context,t);if(a.ok&&a.data)return this.service.local.add(this.view.context,a.data),this.view.state.data=a.data,this.view.evt.emit("onViewInfoChange",{dataInfo:this.view.state.data.srfmajortext||""}),this.view.evt.emit("onSaveSuccess",void 0),ibiz.message.success("".concat(this.view.state.data.srfmajortext,"保存成功!")),a.data}return null}finally{this.view.endLoading()}}async call(e,t){if(e===F.SAVE)return this.save();if("onActive"!==e){if("onActiveRoot"!==e)return super.call(e,t);this.activeRoot()}else this.view.select.set(t)}async onActive(e){const t=e.data.srfdecodename,a=this.view.model.viewLayoutPanel.appViewRefs;if(a){const i=e.type?e.type.toUpperCase():null,s=a.find((e=>e.name==="EDITDATA:".concat(t.toUpperCase()).concat(i?":".concat(i):"")));if(s){const a=this.view.context.clone();a[t.toLowerCase()]=e.id,delete a.srfrunmode;const{navigateContexts:i}=s;Object.assign(a,z(i,e.data,a)),this.navPos.openView({key:e.id,viewId:s.refAppViewId,context:a})}}}});var Be=Object.defineProperty,Le=(e,t,a)=>(((e,t,a)=>{t in e?Be(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a})(e,"symbol"!=typeof t?t+"":t,a),a);class Ue extends R{constructor(){super(...arguments),Le(this,"service")}async onCreated(){await super.onCreated(),await this.initDeService(),await this.load()}async initDeService(){const{appId:e,appDataEntityId:t}=this.view.model,a=ibiz.hub.getApp(e);this.service=await a.deService.getService(this.view.context,t)}async load(){try{this.view.startLoading();const e=await this.service.get(this.view.context,this.view.params);e.ok&&e.data&&(this.view.state.data=e.data)}finally{this.view.endLoading()}}}e("PreviewViewEngineBase",Ue);var _e=Object.defineProperty,Ke=(e,t,a)=>(((e,t,a)=>{t in e?_e(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a})(e,"symbol"!=typeof t?t+"":t,a),a);e("PreviewViewControllerBase",class extends k{constructor(){super(...arguments),Ke(this,"preViewProvider")}getPreViewProvider(){return this.preViewProvider}async onCreated(){await super.onCreated(),this.context.srfrunmode="DESIGN",await this.initPreViewProvider()}initEngines(){this.engines.push(new Ue(this))}async initPreViewProvider(){throw new Error("Method not implemented.")}});var qe=Object.defineProperty,He=(e,t,a)=>(((e,t,a)=>{t in e?qe(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a})(e,"symbol"!=typeof t?t+"":t,a),a);const Je=class e{constructor(){He(this,"preViewProviderMap",new Map)}static getInstance(){return e.DesignPreViewFactory||(e.DesignPreViewFactory=new e),this.DesignPreViewFactory}registerProvider(e,t){this.preViewProviderMap.set(e,t)}getProvider(e){return this.preViewProviderMap.get(e)}};He(Je,"DesignPreViewFactory");e("DesignPreViewFactory",Je);e("PreViewProviderBase",class{async init(e){}getTargetDataBySourceData(e,t){return t}getPropertyByTag(e){return[]}});var We=Object.defineProperty,Xe=(e,t,a)=>(((e,t,a)=>{t in e?We(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a})(e,"symbol"!=typeof t?t+"":t,a),a);class Ye extends B{constructor(){super(...arguments),Xe(this,"majorData",{}),Xe(this,"itemDatas",[]),Xe(this,"refreshTag",H())}}e("DesignContentState",Ye);var $e=Object.defineProperty,Ge=(e,t,a)=>(((e,t,a)=>{t in e?$e(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a})(e,"symbol"!=typeof t?t+"":t,a),a);e("DesignContentController",class extends D{constructor(){super(...arguments),Ge(this,"majorService"),Ge(this,"itemService"),Ge(this,"majorEntity"),Ge(this,"itemEntity")}get majorForm(){return M(this.view.model,"form")}get itemForm(){return M(this.view.model,"item")}get view(){return this.panel.view}createState(){var e;return new Ye(null==(e=this.parent)?void 0:e.state)}async onInit(){await super.onInit(),await this.initBaseResource(),await this.load(),await this.subscribeDataChange()}async initBaseResource(){const e=ibiz.hub.getApp(this.view.model.appId);this.majorEntity=await ibiz.hub.getAppDataEntity(this.majorForm.appDataEntityId,this.view.model.appId),this.majorService=await e.deService.getService(this.panel.context,this.majorForm.appDataEntityId),this.itemEntity=await ibiz.hub.getAppDataEntity(this.itemForm.appDataEntityId,this.view.model.appId),this.itemService=await e.deService.getService(this.panel.context,this.itemForm.appDataEntityId)}async subscribeDataChange(){this.refresh=this.refresh.bind(this),this.onDEDataChange=this.onDEDataChange.bind(this),this.view.evt.on("onUpdateSuccess",this.refresh),this.view.evt.on("onCreateSuccess",this.refresh),this.view.evt.on("onRemoveSuccess",this.refresh),this.view.evt.on("onSaveSuccess",this.refresh),ibiz.mc.command.change.on(this.onDEDataChange)}async unSubscribeDataChange(){this.view.evt.off("onUpdateSuccess",this.refresh),this.view.evt.off("onCreateSuccess",this.refresh),this.view.evt.off("onRemoveSuccess",this.refresh),this.view.evt.off("onSaveSuccess",this.refresh),ibiz.mc.command.change.off(this.onDEDataChange)}async load(){const e=await this.majorService.getTemp(this.panel.context,this.panel.params);if(e.ok&&e.data){const t=e.data,a=await this.itemService.fetchDefault(this.panel.context,this.panel.params);if(a.ok&&a.data){const e=a.data;await this.afterLoad({majorData:t,itemDatas:e})}}}async afterLoad(e){const{majorData:t,itemDatas:a}=e;this.state.majorData=t,this.state.itemDatas.length=0,this.state.itemDatas.push(...a)}async refresh(){await this.load(),this.state.refreshTag=H()}onDEDataChange(e){const{data:t}=e;t&&t.srfdecodename===this.itemEntity.codeName&&this.refresh()}destroy(){super.destroy(),this.unSubscribeDataChange()}});var Qe=Object.defineProperty,Ze=(e,t,a)=>(((e,t,a)=>{t in e?Qe(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a})(e,"symbol"!=typeof t?t+"":t,a),a);class et extends B{constructor(){super(...arguments),Ze(this,"items",[]),Ze(this,"treeData",[]),Ze(this,"actions",[{type:"add",icon:"add-outline",tooltip:"新增"},{type:"remove",icon:"close-outline",tooltip:"删除"}]),Ze(this,"rules",new Map),Ze(this,"activeNode","")}}e("DesignOperationState",et);var tt=Object.defineProperty,at=(e,t,a)=>(((e,t,a)=>{t in e?tt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a})(e,"symbol"!=typeof t?t+"":t,a),a);e("DesignOperationController",class extends D{constructor(){super(...arguments),at(this,"majorService"),at(this,"itemService"),at(this,"majorEntity"),at(this,"itemEntity"),at(this,"typeKeyName","itemtype"),at(this,"itemEntityKeyName",""),at(this,"newItems",[]),at(this,"ruleData"),at(this,"defaultRoot",null),at(this,"treeRef")}get view(){return this.panel.view}get majorForm(){return M(this.view.model,"form")}get itemForm(){return M(this.view.model,"item")}createState(){var e;return new et(null==(e=this.parent)?void 0:e.state)}async onInit(){var e;await super.onInit(),this.state.activeNode=(null==(e=this.view.select.data)?void 0:e.id)||"",await this.initBaseResource(),this.initUserParam(),await this.load(),await this.subscribeDataChange()}async initBaseResource(){var e;const t=ibiz.hub.getApp(this.view.model.appId);this.majorEntity=await ibiz.hub.getAppDataEntity(this.majorForm.appDataEntityId,this.view.model.appId),this.majorService=await t.deService.getService(this.panel.context,this.majorForm.appDataEntityId),this.itemEntity=await ibiz.hub.getAppDataEntity(this.itemForm.appDataEntityId,this.view.model.appId),this.itemEntityKeyName="".concat(null==(e=this.itemEntity)?void 0:e.codeName.toLowerCase(),"id"),this.itemService=await t.deService.getService(this.panel.context,this.itemForm.appDataEntityId)}async subscribeDataChange(){this.refresh=this.refresh.bind(this),this.onDEDataChange=q(this.onDEDataChange.bind(this),200),this.view.evt.on("onUpdateSuccess",this.refresh),this.view.evt.on("onCreateSuccess",this.refresh),this.view.evt.on("onRemoveSuccess",this.refresh),this.view.evt.on("onSaveSuccess",this.refresh),ibiz.mc.command.change.on(this.onDEDataChange),this.onSelectDataChange=this.onSelectDataChange.bind(this),this.view.select.on(this.onSelectDataChange)}async unSubscribeDataChange(){this.view.evt.off("onUpdateSuccess",this.refresh),this.view.evt.off("onCreateSuccess",this.refresh),this.view.evt.off("onRemoveSuccess",this.refresh),this.view.evt.off("onSaveSuccess",this.refresh),ibiz.mc.command.change.off(this.onDEDataChange),this.view.select.off(this.onSelectDataChange)}initUserParam(){const e=this.majorForm.userParam;if(e){this.typeKeyName=e.fileType;try{if(this.ruleData=(null==e?void 0:e.ruleData)?JSON.parse(e.ruleData):{},this.newItems=(null==e?void 0:e.newItems)?JSON.parse(e.newItems):[],this.defaultRoot=(null==e?void 0:e.defaultRoot)?JSON.parse(e.defaultRoot):{},this.ruleData){const e=new Map;for(const t in this.ruleData)e.set(t,new RegExp(this.ruleData[t]));this.state.rules=e}}catch(e){ibiz.log.error("JSON序列化出错!".concat(e))}}}async load(){const e=await this.majorService.getTemp(this.panel.context,this.panel.params);let t={},a=[];if(e.ok&&e.data&&(t=e.data),t){const e=await this.itemService.fetchDefault(this.panel.context,this.panel.params);e.ok&&e.data&&(a=e.data)}await this.afterLoad({majorData:t,itemDatas:a})}async afterLoad(e){const{majorData:t,itemDatas:a}=e,i={};if(t){const e=this.generateTreeNode(t);Object.assign(i,{...e,children:[]})}a&&a.length>0&&(this.state.items=a,a.forEach((e=>{if(!e["p".concat(this.itemEntityKeyName)]){const t=this.generateTreeNode(e);this.calcTreeNodes(a,t),i.children.push(t)}}))),this.state.treeData.length=0,this.state.treeData.push(i),this.treeRef&&this.treeRef.expandAll()}async refresh(){var e;if(await this.load(),null==(e=this.view.select.data)?void 0:e.id){this.state.items.find((e=>{var t;return e.srfkey===(null==(t=this.view.select.data)?void 0:t.id)}))||this.panel.view.call("onActiveRoot")}}onSelectDataChange(e){this.state.activeNode=(null==e?void 0:e.id)||""}onDEDataChange(e){const{data:t}=e;if(t&&t.srfdecodename){const e=t.srfdecodename;e!==this.itemEntity.codeName&&e!==this.majorEntity.codeName||this.refresh()}}generateTreeNode(e){const t=e[this.typeKeyName],a=this.newItems.find((e=>e.type===t));let i="";a&&(i=a.icon),1===e.hiddenitem&&(i="eye-off-outline"),0===e.enablemode&&(i="ban-outline");return{id:e.srfkey,label:e.text,type:e.itemtype,icon:i,data:e}}calcTreeNodes(e,t){e&&(t.children=[],e.forEach((a=>{const i="p".concat(this.itemEntityKeyName);if(null!=a[i]&&a[i]===t.id){const i=this.generateTreeNode(a);t.children.push(i),this.calcTreeNodes(e,i)}})))}setTreeRef(e){this.treeRef=e}onNodeSelect(e,t){const a=e.data;1===t.level?this.view.call("onActiveRoot"):this.view.call("onActive",{id:a.srfkey,label:a.srfmajortext,type:a.itemtype,data:a})}onActionClick(e,t,a){const{type:i}=t;switch(i){case"add":return void this.createItem(e,a);case"remove":return void this.remove(a);default:ibiz.log.error("".concat(i,"类型暂不支持"))}}async createItem(e,t){throw new Error("Method not implemented.")}async create(e){const t=await this.itemService.createTemp(this.panel.context,e);if(t.ok&&Array.isArray(t.data)){this.view.evt.emit("onCreateSuccess",void 0);const e=t.data[t.data.length-1];e&&this.view.call("onActive",{id:e.srfkey,label:e.srfmajortext,type:e.itemtype,data:e})}else ibiz.log.error("新建表格列失败")}async remove(e){var t;const a=this.panel.context.clone();Object.assign(a,{[this.itemEntity.codeName.toLowerCase()]:e[this.itemEntityKeyName]});(await this.itemService.remove(a,this.panel.params,e)).ok?(this.view.evt.emit("onRemoveSuccess",void 0),(null==(t=this.view.select.data)?void 0:t.id)===(null==e?void 0:e.srfkey)&&this.panel.view.call("onActiveRoot")):ibiz.message.error("删除失败!")}async onNodeDrop(e,t,a){var i;let s=t.parent;"inner"===a&&(s=t);const n=null==(i=null==s?void 0:s.data)?void 0:i.data,o=async(e,t)=>{var a,i;e.ordervalue=W(t),e.srfordervalue=e.ordervalue,this.panel.context[this.majorEntity.codeName.toLowerCase()]!==(null==n?void 0:n.srfkey)?e["p".concat(null==(a=this.itemEntity.codeName)?void 0:a.toLowerCase(),"id")]=n.srfkey:(e["p".concat(null==(i=this.itemEntity.codeName)?void 0:i.toLowerCase(),"id")]=null,e.srfpmajortext=null),await this.itemService.update(this.panel.context,e)};if(s&&s.childNodes.length>0)for(let e=0;e<s.childNodes.length;e++){const{data:t}=s.childNodes[e].data;await o(t,e)}this.view.evt.emit("onUpdateSuccess",void 0)}destroy(){super.destroy(),this.unSubscribeDataChange()}});var it=Object.defineProperty,st=(e,t,a)=>(((e,t,a)=>{t in e?it(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a})(e,"symbol"!=typeof t?t+"":t,a),a);class nt extends B{constructor(){super(...arguments),st(this,"items",[])}}e("PreviewContentState",nt);e("PreviewContentController",class extends D{get view(){return this.panel.view}get majorData(){return this.view.state.data}createState(){var e;return new nt(null==(e=this.parent)?void 0:e.state)}async onInit(){await super.onInit(),await this.load(),await this.initItems()}async load(){}async initItems(){}});e("default",{install(e){e.use(Y),e.use(ae),e.use(he),e.use(je)}})}}}));
