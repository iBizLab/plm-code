System.register(["vue","ramda","@ibiz-template/vue3-util","@ibiz-template/runtime","cherry-markdown","@ibiz-template/core","lodash-es","qx-util"],(function(e,t){"use strict";var a,i,s,n,o,r,l,c,d,h,u,m,v,p,y,f,w,b,g,C,D,S,E,P,I,V,T,x,N,j,O,R,k,A,M,F,z,B,L,_,U,K,q,H,J,W,X;return{setters:[function(e){a=e.defineComponent,i=e.ref,s=e.watch,n=e.nextTick,o=e.createVNode,r=e.resolveComponent,l=e.h,c=e.isVNode,d=e.renderSlot,h=e.reactive,u=e.computed,m=e.onMounted,v=e.createTextVNode},function(e){p=e.uniq,y=e.clone},function(e){f=e.useNamespace,w=e.useControlController,b=e.getInputProps,g=e.getEditorEmits,C=e.useUIStore},function(e){D=e.PanelItemController,S=e.registerPanelItemProvider,E=e.ControlType,P=e.ScriptFactory,I=e.findChildFormDetails,V=e.EditFormController,T=e.registerControlProvider,x=e.CodeListEditorController,N=e.registerEditorProvider,j=e.EditorController,O=e.PluginStaticResource,R=e.ViewController,k=e.getPFPlugin,A=e.ViewEngineBase,M=e.getControl,F=e.SysUIActionTag,z=e.convertNavData,B=e.PanelItemState},function(e){L=e.default},function(e){_=e.debounce,U=e.clone,K=e.RuntimeModelError,q=e.HttpError},function(e){H=e.debounce},function(e){J=e.createUUID,W=e.QXEvent,X=e.generateOrderValue}],execute:function(){e("getSysImage",(function(e,t){if(!e)return;if(e.reficoncontent)return{imagePath:e.reficoncontent,appId:t};if(e.reficoncss)return{cssClass:e.reficoncss,appId:t};if(e.deuaiconcontent)return{imagePath:e.deuaiconcontent,appId:t};if(e.deuaiconcss)return{cssClass:e.deuaiconcss,appId:t}}));var Y=a({name:"IBizDesignTree",props:{readOnly:{type:Boolean,default:!1},draggable:{type:Boolean,default:!0},dropRules:{type:Object,default:()=>new Map},actions:{type:Array,default:()=>[]},renderItem:{type:Object,required:!1},nodes:{type:Object,required:!0},activeNode:{type:String}},emits:["nodeSelect","actionClick","nodeDrop"],setup(e,{emit:t}){const a=f("design_tree"),r=i([]),l=(t,a)=>{const{data:i,node:s}=t,n=e.dropRules.get(i.type);return(1!==s.level||"add"===a.type)&&(null!=n||"add"!==a.type)},c=(e,a,i)=>{e.stopPropagation(),t("actionClick",e,a,i)},d=(e,t)=>{e.forEach((e=>{if(null!=(null==e?void 0:e.children)){-1===t.findIndex((t=>e.id===t))&&r.value.push(e.id),d(e.children,t)}}))},h=()=>{if(e.nodes){const t=p(r.value);d(e.nodes,t)}};h();const u=i();return s(e.nodes,(()=>{n((()=>{var t,a;u.value&&(null==(a=(t=u.value).setCurrentKey)||a.call(t,e.activeNode))}))})),{ns:a,expendNodeKeys:r,tree:u,renderTreeItem:(t,i)=>{if(e.renderItem)return e.renderItem(t,i);const{data:s}=i;return o("div",{class:a.e("component")},[o("div",{class:a.e("item")},[o("div",{class:a.e("item-label"),title:s.label},[s.icon?o("ion-icon",{class:"".concat(a.e("item-icon")),name:s.icon},null):null,o("span",{class:a.e("item-caption")},[s.label])]),!e.readOnly&&e.actions.length>0?o("div",{class:{[a.e("actions")]:!0,first:1===i.node.level}},[o("div",{class:a.e("item-actions")},[e.actions.map((e=>l(i,e)&&!e.visible?o("div",{class:a.e("item-action-item"),title:e.tooltip,onClick:t=>c(t,e,s.data)},[o("ion-icon",{name:e.icon},null)]):null))]),o("div",{class:a.e("default-actions")},[e.actions.map((e=>l(i,e)&&e.visible?o("div",{class:a.e("item-action-item"),title:e.tooltip,onClick:t=>c(t,e,s.data)},[o("ion-icon",{name:e.icon},null)]):null))])]):null])])},allowDrag:e=>0!==e.level,allowDrop:(t,a,i)=>{if(Object.is(i,"inner")){if((null==a?void 0:a.data)&&(null==t?void 0:t.data)){const i=e.dropRules.get(a.data.type);return!!(null==i?void 0:i.test(t.data.type))}}else{if(0===(null==a?void 0:a.level))return!1;if((null==a?void 0:a.data)&&(null==t?void 0:t.data)&&a.parent){const i=e.dropRules.get(a.parent.data.type);return!!(null==i?void 0:i.test(t.data.type))}}return!1},handleDrop:(e,a,i)=>{t("nodeDrop",e,a,i)},handNodeSelect:(e,a)=>{t("nodeSelect",e,a)},handleNodeExpand:e=>{-1===r.value.findIndex((t=>e.id===t))&&r.value.push(e.id)},handleNodeCollapse:e=>{const t=r.value.findIndex((t=>e.id===t));-1!==t&&r.value.splice(t,1)},expandAll:h}},render(){const e={[this.ns.b()]:!0,[this.ns.is("readonly")]:this.readOnly};return o("div",{class:e},[o(r("el-tree"),{ref:"tree","current-node-key":this.activeNode,class:this.ns.b("tree"),data:this.nodes,draggable:this.draggable&&!this.readOnly,"allow-drop":this.allowDrop,"allow-drag":this.allowDrag,"default-expanded-keys":this.expendNodeKeys,"node-key":"id","highlight-current":!this.readOnly,"expand-on-click-node":!1,"auto-expand-parent":!1,indent:8,"render-content":this.renderTreeItem,onNodeExpand:e=>{this.handleNodeExpand(e)},onNodeCollapse:e=>{this.handleNodeCollapse(e)},onNodeDrop:this.handleDrop,onCurrentChange:this.handNodeSelect},null)])}}),$={install(e){e.component("IBizDesignTree",Y)}};class G extends D{}var Q=a({name:"IBizActiveHomeButton",props:{modelData:{type:Object,required:!0},controller:{type:G,required:!0}},setup:e=>({ns:f("active-home-button"),onActiveRoot:t=>{t.stopPropagation(),e.controller.panel.view.call("onActiveRoot")}}),render(){return o("div",{class:this.ns.b(),onClick:this.onActiveRoot},[o("i",{class:[this.ns.e("icon"),"fa fa-home"]},null)])}}),Z=Object.defineProperty,ee=(e,t,a)=>(((e,t,a)=>{t in e?Z(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a})(e,"symbol"!=typeof t?t+"":t,a),a);class te{constructor(){ee(this,"component","IBizActiveHomeButton")}async createController(e,t,a){const i=new G(e,t,a);return await i.init(),i}}var ae={install(e){e.component("IBizActiveHomeButton",Q),S("FIELD_ACTIVE_HOME_BUTTON",(()=>new te))}},ie={install(e){e.use(ae)}};const se=a({name:"IBizMemoFormControl",props:{controller:{type:Object,required:!0}},setup(e,{slots:t}){const a=f("memo-form"),i=e.controller,s={form:i},n=t=>{var a;const i={};return null==(a=t.controlAttributes)||a.forEach((t=>{t.attrName&&t.attrValue&&(i[t.attrName]=P.execSingleLine(t.attrValue,{...e.controller.getEventArgs(),data:e.controller.data}))})),i},c=(e,a=!0)=>{if(e.hidden)return;const s=e.id;if(t[s])return d(t,s,{model:e,data:i.state.data,value:i.state.data[s]});const h={};"FORMITEM"===e.detailType&&t["".concat(s,"_editor")]&&(h.default=(...e)=>t["".concat(s,"_editor")](...e));const u=I(e);u.length&&(h.default=()=>u.map((e=>c(e))));const m=i.providers[s];if(!m)return o("div",null,[ibiz.i18n.t("control.form.noSupportDetailType",{detailType:e.detailType})]);const v=r(m.component);if("FORMITEM"===e.detailType&&a){const t=e;if(t.editor&&"TEXTAREA"===t.editor.editorType&&"memo"===t.codeName)return}return l(v,{modelData:e,controller:i.details[s],key:e.id,attrs:n(e)},h)},h=e=>{const{modelData:t}=e;return(t instanceof Array?t:[t]).map((e=>c(e)))};return h.props=["modelData"],s.FormDetail=h,{ns:a,c:i,FormDetail:h,slotProps:s,renderByDetailType:c,renderAttrs:n}},render(){const{state:e,model:t,controlPanel:a}=this.c,{isCreated:i}=e,s={};if(i)if(this.$slots.default)s.default=()=>this.$slots.default({...this.slotProps});else{const e=t.controlType===E.SEARCHFORM?"searchform":"form",i=a?e:"default";let n;this.c.formItems.some((e=>{const t=e.model;if("FORMITEM"===t.detailType&&t.editor&&"TEXTAREA"===t.editor.editorType&&"memo"===t.codeName)return n=t,!0})),s[i]=()=>[o("div",{class:this.ns.b("container")},[o("div",{class:this.ns.b("content")},[o(r("iBizFormPage"),{modelData:this.c.model,controller:this.c},{default:()=>{var e;return[null==(e=this.c.model.deformPages)?void 0:e.map((e=>this.renderByDetailType(e)))]}})]),o("div",{class:this.ns.b("footer")},[n&&o(r("iBizFormItem"),{modelData:n,controller:this.c.details[n.id],key:n.id,attrs:this.renderAttrs(n)},{default:e=>{const t=r("IBizMarkdownMemoEditor");return l(t,{...e})}})])])]}return o(r("iBizControlBase"),{class:[this.ns.b()],controller:this.c},"function"==typeof(n=s)||"[object Object]"===Object.prototype.toString.call(n)&&!c(n)?s:{default:()=>[s]});var n}});var ne={install(e){e.component(se.name,se)}},oe=Object.defineProperty,re=(e,t,a)=>(((e,t,a)=>{t in e?oe(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a})(e,"symbol"!=typeof t?t+"":t,a),a);class le{constructor(){re(this,"component","IBizMemoEditFormControl")}}class ce extends V{constructor(e,t,a,i){const s=y(e),n=e=>{e.forEach((e=>{if("FORMITEM"===e.detailType){const t=e;t.editor&&(t.editor.editorParams||(t.editor.editorParams={}),Object.assign(t.editor.editorParams,{triggerMode:"input"}))}const t=I(e);t.length&&n(t)}))};n(s.deformPages||[]),super(s,t,a,i)}}const de=a({name:"IBizMemoEditFormControl",props:{modelData:{type:Object,required:!0},context:{type:Object,required:!0},params:{type:Object,default:()=>({})},provider:{type:Object},isSimple:{type:Boolean,required:!1},data:{type:Object,required:!1},loadDefault:{type:Boolean,default:!0}},setup(e){const t=w(((...e)=>new ce(...e)),{excludePropsKeys:["data"]});e.isSimple&&(t.evt.on("onMounted",(()=>{t.setSimpleData(e.data||{})})),s((()=>e.data),(e=>{const a=e||{};Object.keys(t.data).find((e=>a[e]!==t.data[e]))&&t.setSimpleData(a)}),{deep:!0}));const a=f("control-".concat(t.model.controlType.toLowerCase()));return t.evt.on("onCreated",(()=>{Object.keys(t.details).forEach((e=>{const a=t.details[e];a.state=h(a.state)}))})),{c:t,ns:a}},render(){return o(r("iBizMemoFormControl"),{class:this.ns.b(),controller:this.c},{...this.$slots})}});var he={install(e){e.component(de.name,de),T("EDITFORM_RENDER_MEMOFORM",(()=>new le))}},ue={install(e){e.use(ne),e.use(he)}},me={install(e){e.use(ue)}};const ve=a({name:"IBizMarkdownMemoEditor",props:b(),emits:g(),setup(e,{emit:t}){const a=f("markdown-memo-editor"),n=e.controller,o=u((()=>e.value?"".concat(e.value):"")),r=i(!1),l=localStorage.getItem("memo-form-collapsed");l&&(r.value="true"===l);const c=i();let d;const{UIStore:h}=C(),v=i(h.theme);s((()=>h.theme),(e=>{v.value=e,null==d||d.setTheme(v.value)}));const p=i("editOnly");s(o,((e,t)=>{if(!d)return;const a=d.getMarkdown();e!==t&&a!==e&&d.setMarkdown(e)}));const y=()=>{d&&t("change",d.getMarkdown())};return m((()=>{c.value&&((e.disabled||e.readonly)&&(p.value="previewOnly"),d=new L({el:c.value,value:o.value,theme:v.value,editor:{defaultModel:p.value,codemirror:{autofocus:!1}},toolbars:{theme:v.value,bubble:!1,float:!1,sidebar:!1,toolbar:["bold","italic","header","underline","link","togglePreview"]},callback:{afterChange:y}}),d.setTheme(v.value),d.switchModel(p.value))})),{c:n,ns:a,editorRef:c,isCollapsed:r,switchCollapsed:()=>{r.value=!r.value,localStorage.setItem("memo-form-collapsed",JSON.stringify(r.value))}}},render(){return o("div",{class:[this.ns.b(),this.ns.is("collapsed",this.isCollapsed),this.ns.is("readonly",this.disabled||this.readonly)]},[o("div",{class:[this.ns.b("title")]},[v("备注")]),o("div",{ref:"editorRef",class:[this.ns.b("content")]},null),o("div",{class:[this.ns.b("btn")],title:this.isCollapsed?"展开":"收缩",onClick:this.switchCollapsed},[o("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 1024 1024"},[o("path",{fill:"currentColor",d:"m192 384 320 384 320-384z"},null)])])])}});var pe=Object.defineProperty,ye=(e,t,a)=>(((e,t,a)=>{t in e?pe(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a})(e,"symbol"!=typeof t?t+"":t,a),a);class fe{constructor(){ye(this,"formEditor","IBizMarkdownMemoEditor"),ye(this,"gridEditor","IBizMarkdownMemoEditor")}async createController(e,t){const a=new x(e,t);return await a.init(),a}}var we={install(e){e.component(ve.name,ve),N("EDITOR_CUSTOMSTYLE_MARKDOWNMEMO",(()=>new fe))}};const be=a({name:"ViewNavParams",props:b(),emits:["change"],setup(e,{emit:t}){const a=f("view-nav-params"),n=e.controller,l=i(!1),c=i(""),d=i([]),h=[{label:"默认",value:"DEFAULT"},{label:"上下文",value:"SRFNAVCTX"},{label:"视图参数",value:"SRFNAVPARAM"}],u=[{label:"直接值",value:1},{label:"填充值",value:2}];s((()=>e.value),(()=>{c.value=e.value,(e=>{const t=e.split("\n"),a=[];t.forEach((e=>{if(!e)return;const t=e.split("=");let i="DEFAULT",s="",n=t[1],o=1;if(t[0].indexOf(".")>=0){const e=t[0].split(".");i=e[0],s=e[1]}else s=t[0];t[1].startsWith("%")&&t[1].endsWith("%")&&(n=t[1].slice(1,-1),o=2),a.push({paramType:i,paramKey:s,paramValue:n,paramValueType:o})})),d.value=a})(e.value||"")}),{immediate:!0});const m=()=>d.value.map((e=>{const t="DEFAULT"===e.paramType?"":"".concat(e.paramType,"."),a=e.paramKey?"".concat(e.paramKey):"",i=1===e.paramValueType?e.paramValue:"%".concat(e.paramValue,"%");return"".concat(t).concat(a,"=").concat(i)})).join("\n"),v=_((()=>{t("change",c.value)}),500),p=()=>{c.value=m(),v()};return{ns:a,c:n,isCustom:l,items:d,curValue:c,onValueChange:p,renderSelectList:()=>d.value.map(((t,i)=>o("div",{class:a.e("item")},[o("div",{class:a.em("item","param-type")},[o(r("el-select"),{modelValue:t.paramType,"onUpdate:modelValue":e=>t.paramType=e,onChange:p,readonly:e.readonly,disabled:e.disabled},{default:()=>h.map((e=>o(r("el-option"),{key:e.value,label:e.label,value:e.value},null)))})]),o("div",{class:a.em("item","param-key")},[o(r("el-input"),{modelValue:t.paramKey,"onUpdate:modelValue":e=>t.paramKey=e,readonly:e.readonly,disabled:e.disabled,onInput:p},null)]),o("div",{class:a.em("item","param-value")},[o(r("el-input"),{modelValue:t.paramValue,"onUpdate:modelValue":e=>t.paramValue=e,readonly:e.readonly,disabled:e.disabled,onInput:p},null)]),o("div",{class:a.em("item","param-value-type")},[o(r("el-select"),{modelValue:t.paramValueType,"onUpdate:modelValue":e=>t.paramValueType=e,onChange:p,disabled:e.disabled},{default:()=>u.map((e=>o(r("el-option"),{key:e.value,label:e.label,value:e.value},null)))})]),o("div",{class:[a.em("item","remove"),a.is("disabled",e.disabled||e.readonly)],title:"删除",onClick:()=>(t=>{e.disabled||e.readonly||(d.value.splice(t,1),c.value=m(),v())})(i)},[o("ion-icon",{name:"close-outline"},null)]),o("div",{class:[a.em("item","copy"),a.is("disabled",e.disabled||e.readonly)],title:"复制",onClick:()=>(t=>{if(e.disabled||e.readonly)return;const a=U(d.value[t]);d.value.splice(t,0,a),c.value=m(),v()})(i)},[o("ion-icon",{name:"copy-outline"},null)])]))),onAddItem:()=>{e.disabled||e.readonly||(d.value.push({paramType:"DEFAULT",paramKey:"",paramValue:"",paramValueType:1}),c.value=m(),v())},onSwitchCustom:e=>{l.value=e},onCustomChange:()=>{v()}}},render(){return o("div",{class:this.ns.b()},[this.isCustom?o("div",{class:this.ns.e("custom")},[o("div",{class:this.ns.em("custom","textarea")},[o(r("el-input"),{type:"textarea",modelValue:this.curValue,"onUpdate:modelValue":e=>this.curValue=e,disabled:this.disabled,readonly:this.readonly,this:!0,rows:"6",onInput:this.onCustomChange},null)]),o("div",{class:this.ns.em("custom","close-custom")},[o("div",{class:this.ns.em("select","btn"),onClick:()=>this.onSwitchCustom(!1)},[v("关闭自定义")])])]):o("div",{class:this.ns.e("select")},[o("div",{class:this.ns.em("select","list")},[this.renderSelectList()]),o("div",{class:this.ns.em("select","use-custom")},[o("div",{class:[this.ns.em("select","btn")],onClick:()=>this.onSwitchCustom(!0)},[v("开启自定义")]),o("ion-icon",{class:[this.ns.em("select","add-icon"),this.ns.is("disabled",this.disabled||this.readonly)],name:"add-outline",onClick:this.onAddItem,title:"新增"},null)])])])}});class ge extends j{}var Ce=Object.defineProperty,De=(e,t,a)=>(((e,t,a)=>{t in e?Ce(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a})(e,"symbol"!=typeof t?t+"":t,a),a);class Se{constructor(){De(this,"formEditor","ViewNavParams"),De(this,"gridEditor","ViewNavParams")}async createController(e,t){const a=new ge(e,t);return await a.init(),a}}var Ee={install(e){e.component(be.name,be),N("EDITOR_CUSTOMSTYLE_VIEW_NAV_PARAMS",(()=>new Se))}};const Pe=new O(t.meta.url);var Ie=a({name:"IBizEditorParmas",props:b(),emits:g(),setup(e,{emit:t}){var a;const n=e.controller,o=f("editor-params-custom"),r=i(!1);let l=null==(a=e.data)?void 0:a.editortype;const c=i(e.value),d=i({}),h={param:"",srfnavparam:"SRFNAVPARAM.",srfnavctx:"SRFNAVCTX."},u=i([]),m=i([]),v=i([]),p=e=>{if(!e)return;const t=e.split("\n"),a=[];t.forEach((e=>{if(!e)return;const t=e.indexOf("=");if(-1===t)return;const i=e.slice(0,t),s=e.slice(t+1);if(i)if(Object.prototype.hasOwnProperty.call(d.value,i))if(s)try{d.value[i]=JSON.parse(s)}catch(e){d.value[i]=s}else d.value[i]=void 0;else{let e=i,t="param";i.startsWith("SRFNAVPARAM.")?(e=i.slice(i.indexOf(".")+1),t="srfnavparam"):i.startsWith("SRFNAVCTX.")&&(e=i.slice(i.indexOf(".")+1),t="srfnavctx");const n={id:J(),key:e,value:s,type:t};a.push(n)}})),m.value=a},y=()=>{const e=[];m.value.forEach((t=>{t.key&&e.push("".concat(h[t.type]).concat(t.key,"=").concat(t.value))}));const a=[].join("\n"),i=e.join("\n");a?(c.value="".concat(a).concat(i?"\n".concat(i):""),t("change",c.value||null)):(c.value=i,t("change",c.value||null))};c.value&&p(c.value),s((()=>e.value),((e,t)=>{c.value&&p(c.value)})),s((()=>e.data),((t,a)=>{const i=null==t?void 0:t.editortype,s=e.value?e.value.toString():"";s?s===c.value&&i===l||p(s):m.value=[],l=i,c.value=s,y()}),{immediate:!0});return{ns:o,c:n,isCustom:r,changeIscustom:()=>{r.value=!r.value},dynamicItems:m,formItems:u,addDynamicParam:e=>{m.value.push({id:J(),key:"",value:"",type:e}),y()},editorParams:c,typeMap:h,formData:d,onEditorTypeChange:e=>{e?e!==l&&(u.value=[],d.value={}):(u.value=[],d.value={})},transformEditorParams:p,editorType:l,onCustomParamChange:e=>{H((()=>{t("change",e)}),0)()},onDynamicParamChange:(e,t,a)=>{t[a]=e;H((()=>{y()}),0)()},deleteDynamicParam:e=>{m.value.splice(e,1),y()},onFocus:async e=>{setTimeout((()=>{const t=v.value[e];null==t||t.focus()}),0)},valueEditorRefs:v}},render(){return o("div",{class:this.ns.b()},[this.isCustom?o(r("el-input"),{class:[this.ns.e("param-textarea"),this.ns.is("readonly",this.readonly)],type:"textarea",rows:6,modelValue:this.editorParams,"onUpdate:modelValue":e=>this.editorParams=e,readonly:this.readonly,disabled:this.readonly,onInput:e=>this.onCustomParamChange(e)},null):o("div",{class:this.ns.e("param-container")},[o("div",{class:this.ns.e("param-list-from")},null),o("div",{class:this.ns.e("param-list-dynamic")},[this.dynamicItems.map(((e,t)=>o("div",{class:this.ns.e("param-item-dynamic"),key:e.id},[o("ion-icon",{src:Pe.dir("./assets/svg/".concat(e.type,".svg")),class:this.ns.em("param-item-dynamic","icon")},null),this.readonly?[o("div",{class:[this.ns.em("param-item-dynamic","key"),this.ns.is("readonly",this.readonly)]},[e.key]),o("div",{class:[this.ns.em("param-item-dynamic","value"),this.ns.is("readonly",this.readonly)]},[e.value])]:[o(r("el-input"),{class:this.ns.em("param-item-dynamic","key"),modelValue:e.key,"onUpdate:modelValue":t=>e.key=t,onChange:t=>this.onDynamicParamChange(t,e,"key")},null),o(r("el-input"),{ref:e=>{this.valueEditorRefs[t]=e},class:this.ns.em("param-item-dynamic","value"),modelValue:e.value,"onUpdate:modelValue":t=>e.value=t,onFocus:()=>this.onFocus(t),onChange:t=>{this.onDynamicParamChange(t,e,"value")}},null),o("ion-icon",{name:"close-outline",class:this.ns.em("param-item-dynamic","delete"),onClick:()=>this.deleteDynamicParam(t)},null)]])))])]),o("div",{class:this.ns.e("param-custom-button")},[o(r("el-button"),{size:"small",onClick:()=>this.changeIscustom()},{default:()=>["".concat(this.isCustom?"关闭":"开启","自定义")]}),this.readonly?null:o(r("el-dropdown"),{trigger:"click",size:"small",onCommand:this.addDynamicParam},{default:()=>o(r("el-button"),{size:"small"},{default:()=>[o("ion-icon",{name:"add-outline"},null)]}),dropdown:()=>o(r("el-dropdown-menu"),null,{default:()=>[o(r("el-dropdown-item"),{command:"param"},{default:()=>[v("参数")]}),o(r("el-dropdown-item"),{command:"srfnavparam"},{default:()=>[v("视图参数")]}),o(r("el-dropdown-item"),{command:"srfnavctx"},{default:()=>[v("视图上下文")]})]})})])])}});class Ve extends j{}var Te=Object.defineProperty,xe=(e,t,a)=>(((e,t,a)=>{t in e?Te(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a})(e,"symbol"!=typeof t?t+"":t,a),a);class Ne{constructor(){xe(this,"formEditor","IBizEditorParmas"),xe(this,"gridEditor","IBizEditorParmas")}async createController(e,t){const a=new Ve(e,t);return await a.init(),a}}var je={install(e){e.component(Ie.name,Ie),N("EDITOR_CUSTOMSTYLE_EditorParamCustom",(()=>new Ne))}},Oe={install(e){e.use(we),e.use(Ee),e.use(je)}},Re=Object.defineProperty,ke=(e,t,a)=>(((e,t,a)=>{t in e?Re(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a})(e,"symbol"!=typeof t?t+"":t,a),a);class Ae{constructor(){ke(this,"_data",null),ke(this,"evt",new W)}get data(){return this._data}set(e){this._data=e,this.evt.emit("change",this._data)}get(){return this.data}reset(){this._data=null,this.evt.emit("change",null)}on(e){return this.evt.on("change",e)}off(e){this.evt.off("change",e)}}e("SelectState",Ae);var Me=Object.defineProperty,Fe=(e,t,a)=>(((e,t,a)=>{t in e?Me(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a})(e,"symbol"!=typeof t?t+"":t,a),a);e("DesignViewControllerBase",class extends R{constructor(){super(...arguments),Fe(this,"select",new Ae),Fe(this,"preViewProvider")}getPreViewProvider(){return this.preViewProvider}async onCreated(){await super.onCreated();const{sysPFPluginId:e,appId:t}=this.model,a=k(e,t);if(a&&a.pluginParams){const e=a.pluginParams;Object.keys(e).forEach((t=>{e[t]&&"appId"!==t&&(this.context[t.toLowerCase()]=e[t])}))}await this.initPreViewProvider()}async initPreViewProvider(){throw new Error("Method not implemented.")}});var ze=Object.defineProperty,Be=(e,t,a)=>(((e,t,a)=>{t in e?ze(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a})(e,"symbol"!=typeof t?t+"":t,a),a);e("DesignViewEngineBase",class extends A{constructor(){super(...arguments),Be(this,"form"),Be(this,"service"),Be(this,"navPos"),Be(this,"activePropertyView")}initNavTab(){var e,t,a,i;const s=this.view.parentView;if(!s)return;const n=null==(e=s.layoutPanel)?void 0:e.panelItems;if(!n||!n.nav_pos_index)return;const o=n.nav_pos_index;if(o.navTabs&&(null==(t=o.state)?void 0:t.currentKey)){const e=o.state.currentKey;null==(i=(a=o.navTabs).updateViewInfo)||i.call(a,e,{caption:this.view.model.caption,sysImage:this.view.model.sysImage})}}async onCreated(){await super.onCreated(),this.initNavTab();{const e=M(this.view.model,"form");if(!e)throw new K(this.view,"未找到主数据表单模型");this.form=e;const t=ibiz.hub.getApp(this.view.model.appId);this.service=await t.deService.getService(this.view.context,this.form.appDataEntityId)}this.onSelect=this.onSelect.bind(this),this.view.select.on(this.onSelect),this.initViewShouldDismissHook(),await this.load(),this.initCustomParams()}async onMounted(){var e;await super.onMounted(),null==(e=this.toolbar)||e.calcButtonState(this.view.state.data,this.form.appDataEntityId),this.navPos=this.view.layoutPanel.panelItems.nav_pos,this.activeRoot(),this.initPropertyView(),this.view.evt.emit("onViewInfoChange",{dataInfo:this.view.state.data.srfmajortext||""})}initViewShouldDismissHook(){this.view.modal.hooks.shouldDismiss.tapPromise((async e=>{const t=ibiz.uiDomainManager.get(this.view.context.srfsessionid);if(t&&!0===t.dataModification&&null==e.allowClose){const t=await ibiz.confirm.error({title:"关闭提醒",desc:"数据已经修改，确定要关闭？"});e.allowClose=!!t}}))}initCustomParams(){}initPropertyView(){var e;(null==(e=this.view.layoutPanel)?void 0:e.evt).on("onPresetPanelItemEvent",(e=>{const{panelItemEventName:t,panelItemName:a,presetParams:i}=e;"nav_pos"===a&&"onViewCreated"===t&&(this.activePropertyView=i.view)}))}onSelect(e){e&&this.onActive(e)}activeRoot(e=!1){this.view.select.set({id:this.view.state.data.srfkey,label:this.view.state.data.srfmajortext,type:"",data:this.view.state.data,forceRefresh:e})}async load(){try{this.view.startLoading();const e=await this.service.get(this.view.context,this.view.params);return e.ok&&e.data?(this.service.local.add(this.view.context,e.data),this.view.state.data=e.data,e.data):null}catch(e){throw e instanceof q&&(e.tag=this.view.context.srfviewid),e}finally{this.view.endLoading()}}async save(){try{this.view.startLoading();const e=await this.service.getTemp(this.view.context);if(e.ok&&e.data){const t=e.data;for(const e in t)if(Object.prototype.hasOwnProperty.call(t,e)){"object"==typeof t[e]&&(t[e]=void 0)}const a=await this.service.update(this.view.context,t);if(a.ok&&a.data)return this.service.local.add(this.view.context,a.data),this.view.state.data=a.data,this.view.evt.emit("onViewInfoChange",{dataInfo:this.view.state.data.srfmajortext||""}),this.view.evt.emit("onSaveSuccess",void 0),ibiz.message.success("".concat(this.view.state.data.srfmajortext,"保存成功!")),a.data}return null}catch(e){throw e instanceof q&&(e.tag=this.view.context.srfviewid),e}finally{this.view.endLoading()}}async call(e,t){if(e===F.SAVE)return this.save();if("onActive"!==e)if("onActiveRoot"!==e){if("Refresh"!==e)return super.call(e,t);this.refreshView()}else this.activeRoot();else this.view.select.set(t)}async refreshView(){var e;await this.load(),this.activeRoot(!0),this.view.evt.emit("onRefreshView",void 0),this.view.evt.emit("onViewInfoChange",{dataInfo:(null==(e=this.view.state.data)?void 0:e.srfmajortext)||""})}async onActive(e){const{forceRefresh:t}=e,a=e.data.srfdecodename,i=this.view.model.viewLayoutPanel.appViewRefs;if(i){const s=e.type?e.type.toUpperCase():null,n=i.find((e=>e.name==="EDITDATA:".concat(a.toUpperCase()).concat(s?":".concat(s):"")));if(n){const i=this.view.context.clone();i[a.toLowerCase()]=e.id,delete i.srfrunmode;const{navigateContexts:s}=n;Object.assign(i,z(s,e.data,i)),this.navPos.openView({key:t?J():e.id,viewId:n.refAppViewId,context:i})}}}});var Le=Object.defineProperty,_e=(e,t,a)=>(((e,t,a)=>{t in e?Le(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a})(e,"symbol"!=typeof t?t+"":t,a),a);class Ue extends A{constructor(){super(...arguments),_e(this,"service")}initNavTab(){var e,t,a,i;const s=this.view.parentView;if(!s)return;const n=null==(e=s.layoutPanel)?void 0:e.panelItems;if(!n||!n.nav_pos_index)return;const o=n.nav_pos_index;if(o.navTabs&&(null==(t=o.state)?void 0:t.currentKey)){const e=o.state.currentKey;null==(i=(a=o.navTabs).updateViewInfo)||i.call(a,e,{caption:this.view.model.caption,sysImage:this.view.model.sysImage})}}async onCreated(){await super.onCreated(),this.initNavTab(),await this.initDeService(),await this.load()}async initDeService(){const{appId:e,appDataEntityId:t}=this.view.model,a=ibiz.hub.getApp(e);this.service=await a.deService.getService(this.view.context,t)}async load(){try{this.view.startLoading();const e=await this.service.get(this.view.context,this.view.params);e.ok&&e.data&&(this.view.state.data=e.data)}finally{this.view.endLoading()}}}e("PreviewViewEngineBase",Ue);var Ke=Object.defineProperty,qe=(e,t,a)=>(((e,t,a)=>{t in e?Ke(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a})(e,"symbol"!=typeof t?t+"":t,a),a);e("PreviewViewControllerBase",class extends R{constructor(){super(...arguments),qe(this,"preViewProvider")}getPreViewProvider(){return this.preViewProvider}async onCreated(){await super.onCreated(),this.context.srfrunmode="DESIGN",await this.initPreViewProvider()}initEngines(){this.engines.push(new Ue(this))}async initPreViewProvider(){throw new Error("Method not implemented.")}});var He=Object.defineProperty,Je=(e,t,a)=>(((e,t,a)=>{t in e?He(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a})(e,"symbol"!=typeof t?t+"":t,a),a);const We=class e{constructor(){Je(this,"preViewProviderMap",new Map)}static getInstance(){return e.DesignPreViewFactory||(e.DesignPreViewFactory=new e),this.DesignPreViewFactory}registerProvider(e,t){this.preViewProviderMap.set(e,t)}getProvider(e){var t;return null==(t=this.preViewProviderMap.get(e))?void 0:t()}};Je(We,"DesignPreViewFactory");e("DesignPreViewFactory",We);e("PreViewProviderBase",class{async init(e){}getTargetDataBySourceData(e,t){return t}getPropertyByTag(e){return[]}});var Xe=Object.defineProperty,Ye=(e,t,a)=>(((e,t,a)=>{t in e?Xe(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a})(e,"symbol"!=typeof t?t+"":t,a),a);class $e extends B{constructor(){super(...arguments),Ye(this,"majorData",{}),Ye(this,"itemDatas",[]),Ye(this,"refreshTag",J())}}e("DesignContentState",$e);var Ge=Object.defineProperty,Qe=(e,t,a)=>(((e,t,a)=>{t in e?Ge(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a})(e,"symbol"!=typeof t?t+"":t,a),a);e("DesignContentController",class extends D{constructor(){super(...arguments),Qe(this,"majorService"),Qe(this,"itemService"),Qe(this,"majorEntity"),Qe(this,"itemEntity")}get majorForm(){return M(this.view.model,"form")}get itemForm(){return M(this.view.model,"item")}get view(){return this.panel.view}createState(){var e;return new $e(null==(e=this.parent)?void 0:e.state)}async onInit(){await super.onInit(),await this.initBaseResource(),await this.load(),await this.subscribeDataChange()}async initBaseResource(){const e=ibiz.hub.getApp(this.view.model.appId);this.majorEntity=await ibiz.hub.getAppDataEntity(this.majorForm.appDataEntityId,this.view.model.appId),this.majorService=await e.deService.getService(this.panel.context,this.majorForm.appDataEntityId),this.itemEntity=await ibiz.hub.getAppDataEntity(this.itemForm.appDataEntityId,this.view.model.appId),this.itemService=await e.deService.getService(this.panel.context,this.itemForm.appDataEntityId)}async subscribeDataChange(){this.refresh=this.refresh.bind(this),this.onDEDataChange=this.onDEDataChange.bind(this),this.view.evt.on("onUpdateSuccess",this.refresh),this.view.evt.on("onCreateSuccess",this.refresh),this.view.evt.on("onRemoveSuccess",this.refresh),this.view.evt.on("onSaveSuccess",this.refresh),this.view.evt.on("onRefreshView",this.refresh),ibiz.mc.command.change.on(this.onDEDataChange)}async unSubscribeDataChange(){this.view.evt.off("onUpdateSuccess",this.refresh),this.view.evt.off("onCreateSuccess",this.refresh),this.view.evt.off("onRemoveSuccess",this.refresh),this.view.evt.off("onSaveSuccess",this.refresh),this.view.evt.off("onRefreshView",this.refresh),ibiz.mc.command.change.off(this.onDEDataChange)}async load(){const e=await this.majorService.getTemp(this.panel.context,this.panel.params);if(e.ok&&e.data){const t=e.data,a=await this.itemService.fetchDefault(this.panel.context,this.panel.params);if(a.ok&&a.data){const e=a.data;await this.afterLoad({majorData:t,itemDatas:e})}}}async afterLoad(e){const{majorData:t,itemDatas:a}=e;this.state.majorData=t,this.state.itemDatas.length=0,this.state.itemDatas.push(...a)}async refresh(){await this.load(),this.state.refreshTag=J()}onDEDataChange(e){const{data:t}=e;t&&t.srfdecodename===this.itemEntity.codeName&&this.refresh()}onSelect(e){const t=this.state.itemDatas.find((t=>t.srfkey===e));t?this.view.call("onActive",{id:t.srfkey,label:t.srfmajortext,type:t.itemtype,data:t}):this.view.call("onActiveRoot")}destroy(){super.destroy(),this.unSubscribeDataChange()}});var Ze=Object.defineProperty,et=(e,t,a)=>(((e,t,a)=>{t in e?Ze(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a})(e,"symbol"!=typeof t?t+"":t,a),a);class tt extends B{constructor(){super(...arguments),et(this,"items",[]),et(this,"treeData",[]),et(this,"actions",[{type:"add",icon:"add-outline",tooltip:"新增"},{type:"remove",icon:"close-outline",tooltip:"删除"}]),et(this,"rules",new Map),et(this,"activeNode","")}}e("DesignOperationState",tt);var at=Object.defineProperty,it=(e,t,a)=>(((e,t,a)=>{t in e?at(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a})(e,"symbol"!=typeof t?t+"":t,a),a);e("DesignOperationController",class extends D{constructor(){super(...arguments),it(this,"majorService"),it(this,"itemService"),it(this,"majorEntity"),it(this,"itemEntity"),it(this,"typeKeyName","itemtype"),it(this,"itemEntityKeyName",""),it(this,"newItems",[]),it(this,"ruleData"),it(this,"defaultRoot",null),it(this,"treeRef")}get view(){return this.panel.view}get majorForm(){return M(this.view.model,"form")}get itemForm(){return M(this.view.model,"item")}createState(){var e;return new tt(null==(e=this.parent)?void 0:e.state)}async onInit(){var e;await super.onInit(),this.state.activeNode=(null==(e=this.view.select.data)?void 0:e.id)||"",await this.initBaseResource(),this.initUserParam(),await this.load(),await this.subscribeDataChange()}async initBaseResource(){var e;const t=ibiz.hub.getApp(this.view.model.appId);this.majorEntity=await ibiz.hub.getAppDataEntity(this.majorForm.appDataEntityId,this.view.model.appId),this.majorService=await t.deService.getService(this.panel.context,this.majorForm.appDataEntityId),this.itemEntity=await ibiz.hub.getAppDataEntity(this.itemForm.appDataEntityId,this.view.model.appId),this.itemEntityKeyName="".concat(null==(e=this.itemEntity)?void 0:e.codeName.toLowerCase(),"id"),this.itemService=await t.deService.getService(this.panel.context,this.itemForm.appDataEntityId)}async subscribeDataChange(){this.refresh=this.refresh.bind(this),this.onDEDataChange=H(this.onDEDataChange.bind(this),200),this.view.evt.on("onUpdateSuccess",this.refresh),this.view.evt.on("onCreateSuccess",this.refresh),this.view.evt.on("onRemoveSuccess",this.refresh),this.view.evt.on("onSaveSuccess",this.refresh),this.view.evt.on("onRefreshView",this.refresh),ibiz.mc.command.change.on(this.onDEDataChange),this.onSelectDataChange=this.onSelectDataChange.bind(this),this.view.select.on(this.onSelectDataChange)}async unSubscribeDataChange(){this.view.evt.off("onUpdateSuccess",this.refresh),this.view.evt.off("onCreateSuccess",this.refresh),this.view.evt.off("onRemoveSuccess",this.refresh),this.view.evt.off("onSaveSuccess",this.refresh),this.view.evt.off("onRefreshView",this.refresh),ibiz.mc.command.change.off(this.onDEDataChange),this.view.select.off(this.onSelectDataChange)}initUserParam(){const e=this.majorForm.userParam;if(e){this.typeKeyName=e.fileType;try{if(this.ruleData=(null==e?void 0:e.ruleData)?JSON.parse(e.ruleData):{},this.newItems=(null==e?void 0:e.newItems)?JSON.parse(e.newItems):[],this.defaultRoot=(null==e?void 0:e.defaultRoot)?JSON.parse(e.defaultRoot):{},this.ruleData){const e=new Map;for(const t in this.ruleData)e.set(t,new RegExp(this.ruleData[t]));this.state.rules=e}}catch(e){ibiz.log.error("JSON序列化出错!".concat(e))}}}async load(){const e=await this.majorService.getTemp(this.panel.context,this.panel.params);let t={},a=[];if(e.ok&&e.data&&(t=e.data),t){const e=await this.itemService.fetchDefault(this.panel.context,this.panel.params);e.ok&&e.data&&(a=e.data)}await this.afterLoad({majorData:t,itemDatas:a})}async afterLoad(e){const{majorData:t,itemDatas:a}=e,i={};if(t){const e=this.generateTreeNode(t);Object.assign(i,{...e,children:[]})}a&&a.length>0&&(this.state.items=a,a.forEach((e=>{if(!e["p".concat(this.itemEntityKeyName)]){const t=this.generateTreeNode(e);this.calcTreeNodes(a,t),i.children.push(t)}}))),this.state.treeData.length=0,this.state.treeData.push(i),this.treeRef&&this.treeRef.expandAll()}async refresh(){var e;if(await this.load(),null==(e=this.view.select.data)?void 0:e.id){this.state.items.find((e=>{var t;return e.srfkey===(null==(t=this.view.select.data)?void 0:t.id)}))||this.panel.view.call("onActiveRoot")}}onSelectDataChange(e){this.state.activeNode=(null==e?void 0:e.id)||""}onDEDataChange(e){const{data:t}=e;if(t&&t.srfdecodename){const e=t.srfdecodename;e!==this.itemEntity.codeName&&e!==this.majorEntity.codeName||this.refresh()}}generateTreeNode(e){const t=e[this.typeKeyName],a=this.newItems.find((e=>e.type===t));let i="";a&&(i=a.icon),1===e.hiddenitem&&(i="eye-off-outline"),0===e.enablemode&&(i="ban-outline");return{id:e.srfkey,label:e.text,type:e.itemtype,icon:i,data:e}}calcTreeNodes(e,t){e&&(t.children=[],e.forEach((a=>{const i="p".concat(this.itemEntityKeyName);if(null!=a[i]&&a[i]===t.id){const i=this.generateTreeNode(a);t.children.push(i),this.calcTreeNodes(e,i)}})))}setTreeRef(e){this.treeRef=e}onNodeSelect(e,t){const a=e.data;1===t.level?this.view.call("onActiveRoot"):this.view.call("onActive",{id:a.srfkey,label:a.srfmajortext,type:a.itemtype,data:a})}onActionClick(e,t,a){const{type:i}=t;switch(i){case"add":return void this.createItem(e,a);case"remove":return void this.remove(a);default:ibiz.log.error("".concat(i,"类型暂不支持"))}}async createItem(e,t){throw new Error("Method not implemented.")}async create(e){const t=await this.itemService.createTemp(this.panel.context,e);if(t.ok&&Array.isArray(t.data)){this.view.evt.emit("onCreateSuccess",void 0);const e=t.data[t.data.length-1];e&&this.view.call("onActive",{id:e.srfkey,label:e.srfmajortext,type:e.itemtype,data:e})}else ibiz.log.error("新建表格列失败")}async remove(e){var t;const a=this.panel.context.clone();Object.assign(a,{[this.itemEntity.codeName.toLowerCase()]:e[this.itemEntityKeyName]});(await this.itemService.remove(a,this.panel.params,e)).ok?(this.view.evt.emit("onRemoveSuccess",void 0),(null==(t=this.view.select.data)?void 0:t.id)===(null==e?void 0:e.srfkey)&&this.panel.view.call("onActiveRoot")):ibiz.message.error("删除失败!")}async onNodeDrop(e,t,a){var i;let s=t.parent;"inner"===a&&(s=t);const n=null==(i=null==s?void 0:s.data)?void 0:i.data,o=async(e,t)=>{var a,i;e.ordervalue=X(t),e.srfordervalue=e.ordervalue,this.panel.context[this.majorEntity.codeName.toLowerCase()]!==(null==n?void 0:n.srfkey)?e["p".concat(null==(a=this.itemEntity.codeName)?void 0:a.toLowerCase(),"id")]=n.srfkey:(e["p".concat(null==(i=this.itemEntity.codeName)?void 0:i.toLowerCase(),"id")]=null,e.srfpmajortext=null),await this.itemService.update(this.panel.context,e)};if(s&&s.childNodes.length>0)for(let e=0;e<s.childNodes.length;e++){const{data:t}=s.childNodes[e].data;await o(t,e)}this.view.evt.emit("onUpdateSuccess",void 0)}destroy(){super.destroy(),this.unSubscribeDataChange()}});var st=Object.defineProperty,nt=(e,t,a)=>(((e,t,a)=>{t in e?st(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a})(e,"symbol"!=typeof t?t+"":t,a),a);class ot extends B{constructor(){super(...arguments),nt(this,"items",[])}}e("PreviewContentState",ot);e("PreviewContentController",class extends D{get view(){return this.panel.view}get majorData(){return this.view.state.data}createState(){var e;return new ot(null==(e=this.parent)?void 0:e.state)}async onInit(){await super.onInit(),await this.load(),await this.initItems()}async load(){}async initItems(){}});e("default",{install(e){e.use($),e.use(ie),e.use(me),e.use(Oe)}})}}}));
