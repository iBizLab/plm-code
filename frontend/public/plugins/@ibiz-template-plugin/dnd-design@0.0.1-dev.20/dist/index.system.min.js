System.register(["@ibiz-template/runtime","@ibiz-template-plugin/design-base","@ibiz-template/core","qx-util","vue","@ibiz-template/vue3-util","lodash-es","vuedraggable","dayjs"],(function(e,t){"use strict";var s,i,n,a,r,o,l,c,d,h,u,m,p,f,g,v,y,b,w,I,D,E,C,P,x,A,O,R,M,k,T,S,L,N,_,z,B,F,j,U,G,V,Y,H,K,X,q,W;return{setters:[function(e){s=e.ViewEngineBase,i=e.getControl,n=e.SysUIActionTag,a=e.ViewController,r=e.EditorController,o=e.PluginStaticResource,l=e.PanelItemController,c=e.registerPanelItemProvider,d=e.PanelItemState,h=e.UIActionUtil,u=e.AppDataEntity,m=e.QXEventEx,p=e.ButtonContainerState,f=e.UIActionButtonState,g=e.UIActionProviderBase,v=e.registerUIActionProvider,y=e.DEService,b=e.DEServiceUtil,w=e.registerViewProvider,I=e.registerEditorProvider},function(e){D=e.default},function(e){E=e.RuntimeModelError},function(e){C=e.QXEvent,P=e.createUUID,x=e.ascSort,A=e.isNilOrEmpty,O=e.notNilEmpty},function(e){R=e.defineComponent,M=e.computed,k=e.createVNode,T=e.resolveComponent,S=e.ref,L=e.watch,N=e.createTextVNode,_=e.reactive,z=e.provide,B=e.h,F=e.isVNode,j=e.onMounted,U=e.onUnmounted,G=e.nextTick,V=e.inject},function(e){Y=e.useNamespace,H=e.getInputProps,K=e.getEditorEmits},function(e){X=e.debounce},function(e){q=e.default},function(e){W=e.default}],execute:function(){var J=Object.defineProperty,Z=(e,t,s)=>(((e,t,s)=>{t in e?J(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s})(e,"symbol"!=typeof t?t+"":t,s),s);class $ extends s{constructor(){super(...arguments),Z(this,"form"),Z(this,"navPos"),Z(this,"service")}async onCreated(){await super.onCreated();{const e=i(this.view.model,"form");if(!e)throw new E(this.view,"未找到主数据表单模型");this.form=e;const t=ibiz.hub.getApp(this.view.model.appId);this.service=await t.deService.getService(this.view.context,this.form.appDataEntityId)}this.onSelect=this.onSelect.bind(this),this.view.select.on(this.onSelect),this.view.modal.hooks.shouldDismiss.tapPromise((async e=>{if(!0===ibiz.uiDomainManager.get(this.view.context.srfsessionid).dataModification&&null==e.allowClose){const t=await ibiz.confirm.error({title:"关闭提醒",desc:"数据已经修改，确定要关闭？"});e.allowClose=!!t}})),await this.load()}onSelect(e){this.onActive(e)}async onMounted(){var e;await super.onMounted(),null==(e=this.toolbar)||e.calcButtonState(this.view.state.data,this.form.appDataEntityId),this.navPos=this.view.layoutPanel.panelItems.nav_pos,this.activeRoot(),this.view.evt.emit("onViewInfoChange",{dataInfo:this.view.state.data.srfmajortext||""})}async onDestroyed(){await super.onDestroyed(),this.view.select.off(this.onSelect)}activeRoot(){this.view.select.set(this.view.state.data)}async load(){try{this.view.startLoading();const e=await this.service.get(this.view.context,this.view.params);return this.service.local.add(this.view.context,e.data),this.view.state.data=e.data,e.data}finally{this.view.endLoading()}}async save(){var e;try{this.view.startLoading();const t=this.service.local.get(this.view.context,this.view.state.data.srfkey);for(const e in t)if(Object.prototype.hasOwnProperty.call(t,e)){"object"==typeof t[e]&&(t[e]=void 0)}const s=await this.service.update(this.view.context,t);return this.service.local.add(this.view.context,s.data),this.view.state.data=s.data,await this.view.evt.emit("onSaveSuccess",void 0),this.activeRoot(),this.view.evt.emit("onViewInfoChange",{dataInfo:this.view.state.data.srfmajortext||""}),null==(e=this.toolbar)||e.calcButtonState(this.view.state.data,this.form.appDataEntityId),s.data}finally{this.view.endLoading()}}async call(e,t){if(e===n.SAVE)return this.save();if("onActive"===e&&t)this.onActive(t);else{if("onActiveRoot"!==e)return super.call(e,t);this.activeRoot()}}onActive(e){const t=this.view.model.appViewRefs;if(t){const s=e.srftype?e.srftype.toUpperCase():null,i=t.find((t=>t.name==="EDITDATA:".concat(e.srfdecodename.toUpperCase()).concat(s?":".concat(s):"")));if(!i)throw new E(this.view.model,"未匹配到对应[".concat(e.srftype,"]的属性编辑视图"));{const t=this.view.context.clone();t[e.srfdecodename.toLowerCase()]=e.srfkey,this.navPos.openView({key:e.srfkey,viewId:i.refAppViewId,context:t})}}}}var Q=Object.defineProperty,ee=(e,t,s)=>(((e,t,s)=>{t in e?Q(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s})(e,"symbol"!=typeof t?t+"":t,s),s);const te=new class{constructor(){ee(this,"dndProviderMap",new Map)}registerItemProvider(e,t){this.dndProviderMap.set(e.toUpperCase(),t)}getItemProvider(e){const t=e.toUpperCase();if(this.dndProviderMap.has(t))return this.dndProviderMap.get(t);throw new Error("未找到".concat(t,"对应的拖拽组件绘制"))}};var se=Object.defineProperty,ie=(e,t,s)=>(((e,t,s)=>{t in e?se(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s})(e,"symbol"!=typeof t?t+"":t,s),s);class ne{constructor(){ie(this,"_data",null),ie(this,"evt",new C)}get data(){return this._data}set(e){this._data=e,this.evt.emit("change",this._data)}get(){return this.data}reset(){this._data=null,this.evt.emit("change",null)}on(e){return this.evt.on("change",e)}off(e){this.evt.off("change",e)}}var ae=Object.defineProperty,re=(e,t,s)=>(((e,t,s)=>{t in e?ae(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s})(e,"symbol"!=typeof t?t+"":t,s),s);const oe=new class{constructor(){re(this,"gridLayoutMode",["lg","md","sm","xs"])}getGridLayoutModeValue(e,t="",s=""){for(let i=0;i<this.gridLayoutMode.length;i++){const n=this.gridLayoutMode[i],a="".concat(t).concat(n).concat(s);if(null!=e[a])return e[a]}return""}getGridCol(e,t){let s=this.getGridLayoutModeValue(e,"col_");if(t&&!s&&(s=this.getGridLayoutModeValue(e,"child_col_")),(!s||s<="0"||s>"24")&&(s="24"),s){const e=parseInt(s,10);if("TABLE_12COL"===(null==t?void 0:t.layoutmode)&&e>0&&e<=12)return 2*e;if(e>0&&e<=24)return e}return null}getGridOffset(e,t){let s=this.getGridLayoutModeValue(e,"col_","_os");if(t&&!s&&(s=this.getGridLayoutModeValue(e,"child_col_","_os")),s){const e=parseInt(s,10);if("TABLE_12COL"===(null==t?void 0:t.layoutmode)&&e>0&&e<=12)return 2*e;if(e>0&&e<=24)return e}return null}calcColClass(e,t){const s={};if(t&&"FLEX"===t.layoutmode)return s;const i=this.getGridCol(e,t);i&&(s["el-col-".concat(i)]=!0);const n=this.getGridOffset(e,t);return n&&(s["el-col-offset-".concat(n)]=!0),s}getFlexLayoutStyle(e){return"FLEX"===e.layoutmode?{display:"flex","flex-direction":e.flexdir,"justify-content":e.flexalign,"align-items":e.flexvalign,"flex-grow":e.flexgrow,"flex-shrink":e.flexshrink,"flex-basis":"".concat(e.flexbasis,"px"),padding:"".concat(e.padding,"px")}:{padding:"".concat(e.padding,"px")}}getDraggableContainerClass(e,t){const s="FLEX"===e.layoutmode;return{[t.b("grid-layout")]:!s,[t.b("flex-layout")]:s,[t.b("flex-row")]:s&&e.flexdir&&-1===e.flexdir.indexOf("column"),[t.b("flex-column")]:s&&e.flexdir&&-1!==e.flexdir.indexOf("column")}}calcStyle(e,t){const s={};if(!e)return s;if(e){"FULL"===e.heightmode?s.height="auto":e.height?s.height=e.height+("PERCENTAGE"===e.heightmode?"%":"px"):t&&"PSSysViewPanel"===t.itemtype?"CONTAINER"!==t.itemtype&&"CTRLPOS"!==t.itemtype||(s["flex-grow"]=1):s.height="auto","FULL"===e.widthmode?s.width="auto":e.width&&(s.width=e.width+("PERCENTAGE"===e.widthmode?"%":"px"));const i="FLEX"===(null==t?void 0:t.layoutmode);i?(null!=e.flexgrow&&(s["flex-grow"]=e.flexgrow),null!=e.flexshrink&&(s["flex-shrink"]=e.flexshrink),null!=e.flexbasis&&(s["flex-basis"]="".concat(e.flexbasis,"px")),!t||t.flexdir&&-1===t.flexdir.indexOf("row")?Object.assign(s,this.getHorizontalAlign(e,t,i)):Object.assign(s,this.getVerticalAlign(e,t,i))):Object.assign(s,this.getHorizontalAlign(e,t,i)),Object.assign(s,this.getSwapMode(e)),Object.assign(s,this.getBorderStyle(e))}return s}getSwapMode(e){const t={};return e.swapmode&&("FLEX"===e.layoutmode?"NOWRAP"===e.swapmode?t["flex-wrap"]="nowrap":t["flex-wrap"]="wrap":"NOWRAP"===e.swapmode?t["white-space"]="nowrap":t["white-space"]="pre-wrap"),t}getBorderStyle(e){const t={};return e.spacingleft&&(-1!==e.spacingleft.indexOf("OUTER")?t["margin-left"]=this.getSpacingStyle(e.spacingleft.replace("OUTER","")):t["padding-left"]=this.getSpacingStyle(e.spacingleft.replace("INNER",""))),e.spacingright&&(-1!==e.spacingright.indexOf("OUTER")?t["margin-right"]=this.getSpacingStyle(e.spacingright.replace("OUTER","")):t["padding-right"]=this.getSpacingStyle(e.spacingright.replace("INNER",""))),e.spacingtop&&(-1!==e.spacingtop.indexOf("OUTER")?t["margin-top"]=this.getSpacingStyle(e.spacingtop.replace("OUTER","")):t["padding-top"]=this.getSpacingStyle(e.spacingtop.replace("INNER",""))),e.spacingbottom&&(-1!==e.spacingbottom.indexOf("OUTER")?t["margin-bottom"]=this.getSpacingStyle(e.spacingbottom.replace("OUTER","")):t["padding-bottom"]=this.getSpacingStyle(e.spacingbottom.replace("INNER",""))),t}getSpacingStyle(e){let t="0px";switch(e){case"NONE":default:t="0px";break;case"SMALL":t="8px";break;case"MEDIUM":t="16px";break;case"LARGE":t="24px"}return t}getHorizontalAlign(e,t,s=!1){const i={};switch(e.halignself||(null==t?void 0:t.height)){case"LEFT":s?i["align-self"]="flex-start":i.float="left";break;case"RIGHT":s?i["align-self"]="flex-end":i.float="right";break;case"CENTER":s?i["align-self"]="center":(i.margin="auto",i.float="none",i.display="table")}return i}getVerticalAlign(e,t,s=!1){const i={};switch(e.valignself||(null==t?void 0:t.valign)){case"TOP":s&&(i["align-self"]="flex-start");break;case"BOTTOM":s&&(i["align-self"]="flex-end");break;case"MIDDLE":s&&(i["align-self"]="center")}return i}};var le=Object.defineProperty,ce=(e,t,s)=>(((e,t,s)=>{t in e?le(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s})(e,"symbol"!=typeof t?t+"":t,s),s);class de extends a{constructor(){super(...arguments),ce(this,"select",new ne)}initEngines(){this.engines.push(new $(this))}}var he=Object.defineProperty,ue=(e,t,s)=>(((e,t,s)=>{t in e?he(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s})(e,"symbol"!=typeof t?t+"":t,s),s);class me{constructor(){ue(this,"component","IBizView")}createController(e,t,s,i){return new de(e,t,s,i)}}class pe extends r{}var fe=Object.defineProperty,ge=(e,t,s)=>(((e,t,s)=>{t in e?fe(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s})(e,"symbol"!=typeof t?t+"":t,s),s);class ve{constructor(){ge(this,"formEditor","IBizEditorParmas"),ge(this,"gridEditor","IBizEditorParmas")}async createController(e,t){const s=new pe(e,t);return await s.init(),s}}var ye=R({name:"IBizDraggableItem",props:{isSelect:{type:Boolean,default:!1},item:{type:Object,required:!0},actions:{type:Array,required:!1}},setup:(e,{emit:t})=>({ns:Y("dnd-design-draggable-item"),layoutStyle:M((()=>({width:e.item.width?"".concat(e.item.width,"px"):"",height:e.item.height?"".concat(e.item.height,"px"):""}))),onClick:(e,s)=>{e.stopPropagation(),t("action",s)}}),render(){var e,t;return k("div",{class:[this.ns.b(),this.ns.is("select",this.isSelect)],style:this.layoutStyle},[k("div",{class:[this.ns.e("handle"),"handle"]},[k("svg",{viewBox:"64 64 896 896","data-icon":"drag",width:"1em",height:"1em",fill:"currentColor","aria-hidden":"true",focusable:"false",class:""},[k("path",{d:"M909.3 506.3L781.7 405.6a7.23 7.23 0 0 0-11.7 5.7V476H548V254h64.8c6 0 9.4-7 5.7-11.7L517.7 114.7a7.14 7.14 0 0 0-11.3 0L405.6 242.3a7.23 7.23 0 0 0 5.7 11.7H476v222H254v-64.8c0-6-7-9.4-11.7-5.7L114.7 506.3a7.14 7.14 0 0 0 0 11.3l127.5 100.8c4.7 3.7 11.7.4 11.7-5.7V548h222v222h-64.8c-6 0-9.4 7-5.7 11.7l100.8 127.5c2.9 3.7 8.5 3.7 11.3 0l100.8-127.5c3.7-4.7.4-11.7-5.7-11.7H548V548h222v64.8c0 6 7 9.4 11.7 5.7l127.5-100.8a7.3 7.3 0 0 0 .1-11.4z"},null)])]),this.actions?k("ul",{class:this.ns.b("actions")},[this.actions.map((e=>k("li",{class:this.ns.be("actions","item"),title:e.tooltip,onClick:t=>this.onClick(t,e)},[e.icon])))]):null,k("div",{class:this.ns.b("content")},[null==(t=(e=this.$slots).default)?void 0:t.call(e)])])}}),be=R({name:"IBizDraggableTabs",props:{value:{type:String},items:{type:Array,required:!0,default:()=>[]},dragSwitchPage:{type:Boolean,default:!0},select:{type:Object}},emits:["change","drag-change","remove","add"],setup(e,{emit:t}){const s=Y("dnd-design-draggable-tabs"),i=P(),n=s=>{s.srfkey===e.value&&e.select&&e.select.srfkey===e.value||t("change",s)},a=new Map;return{ns:s,uuid:i,onDragChange:e=>{t("drag-change",e)},onItemClick:n,onConfirm:e=>{t("remove",e)},onAddButtonClick:e=>{e.stopPropagation(),t("add")},onDragenter:(t,s)=>{if(e.dragSwitchPage&&s.srfkey){const e=a.get(s.srfkey)||[],t=window.setTimeout((()=>{n(s),e.pop()}),500);e.push(t),a.set(s.srfkey,e)}},onDragLeave:(t,s)=>{if(e.dragSwitchPage&&s.srfkey){const e=a.get(s.srfkey);if(e){const t=e.pop();t&&clearTimeout(t)}}}}},render(){return k("div",{class:this.ns.b()},[k("div",{class:this.ns.b("header")},[k(T("iBizDraggable"),{class:this.ns.b("nav"),list:this.items,group:this.uuid,itemKey:"srfkey",onChange:this.onDragChange},{item:e=>{const{element:t,index:s}=e,i=this.value?this.value===t.srfkey:0===s;return k("div",{class:[this.ns.b("item"),this.ns.is("active",i)],onClick:e=>{e.stopPropagation(),this.onItemClick(t)},onDragenter:e=>this.onDragenter(e,t),onDragleave:e=>this.onDragLeave(e,t)},[k("div",{class:this.ns.be("item","text")},[t.srftext||""]),k("div",{class:this.ns.be("item","remove-button")},[k(T("el-popconfirm"),{title:"确认删除表单分页?子数据将一并删除!","confirm-button-text":"确认","cancel-button-text":"取消",width:"auto",placement:"left","popper-class":this.ns.be("item","pop-confirm"),icon:k("ion-icon",{name:"alert-circle"},null),"icon-color":"#faad14",onConfirm:()=>this.onConfirm(t)},{reference:()=>k("ion-icon",{name:"close-outline",onClick:e=>{e.stopPropagation()}},null)})])])},footer:()=>k("div",{class:this.ns.b("item-add-button"),onClick:e=>this.onAddButtonClick(e),title:"新建分页"},[k("ion-icon",{name:"add-outline",class:this.ns.be("item-add-button","icon")},null)])})]),k("div",{class:this.ns.b("content")},[this.items.map(((e,t)=>{var s,i;const n=this.value?e.srfkey!==this.value:0!==t;return k("div",{class:[this.ns.b("item-content"),this.ns.is("hidden",n),this.ns.is("select",this.select&&e.srfkey===this.select.srfkey)],onClick:t=>{t.stopPropagation(),this.onItemClick(e)}},[null==(i=(s=this.$slots).default)?void 0:i.call(s,e)])}))])])}}),we={install(e){e.component(ye.name,ye),e.component(be.name,be)}};const Ie=new o(t.meta.url);var De=R({name:"IBizEditorParmas",props:H(),emits:K(),setup(e,{emit:t}){var s;const i=e.controller,n=Y("editor-params-custom"),a=S(!1);let r=null==(s=e.data)?void 0:s.editortype;const o=S(e.value),l=S({}),c={param:"",srfnavparam:"SRFNAVPARAM.",srfnavctx:"SRFNAVCTX."},d=S([]),h=S([]),u=e=>{if(!e)return;const t=e.split("\n"),s=[];t.forEach((e=>{if(!e)return;const t=e.indexOf("=");if(-1===t)return;const i=e.slice(0,t),n=e.slice(t+1);if(i)if(Object.prototype.hasOwnProperty.call(l.value,i))if(n)try{l.value[i]=JSON.parse(n)}catch(e){l.value[i]=n}else l.value[i]=void 0;else{let e=i,t="param";i.startsWith("SRFNAVPARAM.")?(e=i.slice(i.indexOf(".")+1),t="srfnavparam"):i.startsWith("SRFNAVCTX.")&&(e=i.slice(i.indexOf(".")+1),t="srfnavctx");const a={id:P(),key:e,value:n,type:t};s.push(a)}})),h.value=s},m=()=>{const e=[];h.value.forEach((t=>{t.key&&e.push("".concat(c[t.type]).concat(t.key,"=").concat(t.value))}));const s=[].join("\n"),i=e.join("\n");s?(o.value="".concat(s).concat(i?"\n".concat(i):""),t("change",o.value||null)):(o.value=i,t("change",o.value||null))};o.value&&u(o.value),L((()=>e.value),((e,t)=>{o.value&&u(o.value)})),L((()=>e.data),((t,s)=>{const i=null==t?void 0:t.editortype,n=e.value?e.value.toString():"";n?n===o.value&&i===r||u(n):h.value=[],r=i,o.value=n,m()}),{immediate:!0});return{ns:n,c:i,isCustom:a,changeIscustom:()=>{a.value=!a.value},dynamicItems:h,formItems:d,addDynamicParam:e=>{h.value.push({id:P(),key:"",value:"",type:e}),m()},editorParams:o,typeMap:c,formData:l,onEditorTypeChange:e=>{e?e!==r&&(d.value=[],l.value={}):(d.value=[],l.value={})},transformEditorParams:u,editorType:r,onCustomParamChange:e=>{X((()=>{t("change",e)}),0)()},onDynamicParamChange:(e,t,s)=>{t[s]=e;X((()=>{m()}),0)()},deleteDynamicParam:e=>{h.value.splice(e,1),m()}}},render(){return k("div",{class:this.ns.b()},[this.isCustom?k(T("el-input"),{class:this.ns.e("param-textarea"),type:"textarea",rows:6,modelValue:this.editorParams,"onUpdate:modelValue":e=>this.editorParams=e,onInput:e=>this.onCustomParamChange(e)},null):k("div",{class:this.ns.e("param-container")},[k("div",{class:this.ns.e("param-list-from")},null),k("div",{class:this.ns.e("param-list-dynamic")},[this.dynamicItems.map(((e,t)=>k("div",{class:this.ns.e("param-item-dynamic"),key:e.id},[k("ion-icon",{src:Ie.dir("./assets/svg/".concat(e.type,".svg")),class:this.ns.em("param-item-dynamic","icon")},null),k(T("el-input"),{class:this.ns.em("param-item-dynamic","key"),modelValue:e.key,"onUpdate:modelValue":t=>e.key=t,onChange:t=>this.onDynamicParamChange(t,e,"key")},null),k(T("el-input"),{class:this.ns.em("param-item-dynamic","value"),modelValue:e.value,"onUpdate:modelValue":t=>e.value=t,onChange:t=>this.onDynamicParamChange(t,e,"value")},null),k("ion-icon",{name:"close-outline",class:this.ns.em("param-item-dynamic","delete"),onClick:()=>this.deleteDynamicParam(t)},null)])))])]),k("div",{class:this.ns.e("param-custom-button")},[k(T("el-button"),{size:"small",onClick:()=>this.changeIscustom()},{default:()=>["".concat(this.isCustom?"关闭":"开启","自定义")]}),k(T("el-dropdown"),{trigger:"click",size:"small",onCommand:this.addDynamicParam},{default:()=>k(T("el-button"),{size:"small"},{default:()=>[k("ion-icon",{name:"add-outline"},null)]}),dropdown:()=>k(T("el-dropdown-menu"),null,{default:()=>[k(T("el-dropdown-item"),{command:"param"},{default:()=>[N("参数")]}),k(T("el-dropdown-item"),{command:"srfnavparam"},{default:()=>[N("视图参数")]}),k(T("el-dropdown-item"),{command:"srfnavctx"},{default:()=>[N("视图上下文")]})]})})])])}}),Ee={install(e){e.component(De.name,De)}},Ce=Object.defineProperty,Pe=(e,t,s)=>(((e,t,s)=>{t in e?Ce(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s})(e,"symbol"!=typeof t?t+"":t,s),s);class xe extends l{constructor(){super(...arguments),Pe(this,"service"),Pe(this,"form"),Pe(this,"providers",{}),Pe(this,"controllers",{}),Pe(this,"items",[]),Pe(this,"timer",null),Pe(this,"isDisableMessage",!1)}get view(){return this.panel.view}async onInit(){await super.onInit();const e=i(this.panel.view.model,"item");if(!e)throw new E(this.panel.view,"未找到 item 表单模型");this.form=e;const t=await ibiz.hub.getApp(this.model.appId);this.service=await t.deService.getService(this.panel.context,e.appDataEntityId),this.view.evt.on("onSaveSuccess",(async()=>{await this.load(),this.state.uuid=P()})),await this.load(),this.subscribeMessage()}onDataUpdate(e){if(!this.isDisableMessage&&e.data&&"object"==typeof e.data){const t=e.data;if(t.srfkey){const e=this.items.findIndex((e=>e.srfkey===t.srfkey));-1!==e&&(this.removeController(this.items[e]),this.items.splice(e,1,t),this.initItem(t),this.timer&&window.clearTimeout(this.timer),this.timer=window.setTimeout((()=>{this.recalculateDeppItems()}),50))}}}sendMessage(e,t,s){this.isDisableMessage=!0,e.forEach((e=>{t?ibiz.mc.command.send(e,t):s&&ibiz.mc.command.next({...s,data:e})})),this.isDisableMessage=!1}subscribeMessage(){this.onDataUpdate=this.onDataUpdate.bind(this),ibiz.mc.command.update.on(this.onDataUpdate)}unsubscribeMessage(){ibiz.mc.command.update.off(this.onDataUpdate)}destroy(){super.destroy(),this.unsubscribeMessage()}async initItem(e){if("FORMPAGE"===e.srftype)return;const t="".concat(e.srfdecodename,"_").concat(e.srftype),s=te.getItemProvider(t),i=s.createController(this,this.form,e);this.providers[e.srfkey]=s,this.controllers[e.srfkey]=i}async load(){const e=await this.service.fetchDefault(this.panel.context);this.items=e.data,this.items.forEach((e=>{this.initItem(e)})),this.state.items=this.calcDeepItems(this.items)}recalculateDeppItems(){this.state.items=this.calcDeepItems(this.items)}calcDeepItems(e,t){const s=[];return e.filter((e=>null==t?null==e.srfpkey:e.srfpkey===t.srfkey)).forEach((t=>{s.push(t);let i=this.calcDeepItems(e,t);i.length>0?(i=x(i,"srfordervalue"),t.children=_(i)):t.children=_([])})),s}change(e,t,s){if(e){const{added:i,moved:n}=e;if(i&&i.element){const n=i.element;if(!n.srfkey||Object.is(n.srfkey,""))t.splice(i.newIndex,1),this.add(e,t,s);else{n.srfpkey=s?s.srfkey:void 0;const{oldIndex:e,newIndex:a}=i;this.move(t,e,a)}}else if(n&&n.element){const{oldIndex:e,newIndex:s}=n;this.move(t,e,s)}}}async add(e,t,s){const i=e.added.newIndex,n=e.added.element,a=await this.service.getDraft(this.panel.context,n);if(a.ok){const{data:e}=a;Object.assign(e,n),e.srfordervalue=10*(i+1),s&&(e.srfpkey=s.srfkey);const r=await this.service.create(this.panel.context,e);if(r.ok){const e=r.data;e.children=_([]),await this.initItem(e),this.items.push(e),this.sendMessage([e],void 0,{messageid:this.panel.context.srfsessionid,messagename:"command",type:"COMMAND",subtype:"OBJECTCREATED"}),t.splice(i,0,e),this.view.select.set(r.data),await this.move(t,i,t.length-1)}}}async move(e,t,s){const i=t>s?t:s,n=[];e.forEach(((e,t)=>{t>=0&&t<=i&&(e.srfordervalue=10*(t+1),n.push(e))}));const a=await this.service.update(this.panel.context,n);a.ok&&(Array.isArray(a.data)&&this.sendMessage(a.data,"OBJECTUPDATED"),ibiz.log.debug("排序成功"))}async remove(e,t){if((await this.service.remove(this.panel.context,{},t)).ok){const s=this.items.findIndex((e=>e.srfkey===t.srfkey)),i=e.findIndex((e=>e.srfkey===t.srfkey));if(s>-1){this.items.splice(s,1),e.splice(i,1),this.removeController(t),this.sendMessage([t],"OBJECTREMOVED");const n=e[0]||this.items.find((e=>e.srfkey===t.srfpkey));n?this.view.select.set(n):this.view.call("onActiveRoot"),this.recalculateDeppItems()}return!0}return!1}removeController(e){if("FORMPAGE"===e.srftype)return;this.controllers[e.srfkey].destroy(),delete this.controllers[e.srfkey]}}var Ae=Object.defineProperty,Oe=(e,t,s)=>(((e,t,s)=>{t in e?Ae(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s})(e,"symbol"!=typeof t?t+"":t,s),s);class Re{constructor(){Oe(this,"component","IBizDndDesignPanelItem")}async createController(e,t,s){const i=new xe(e,t,s);return await i.init(),i}}var Me=R({name:"IBizDndDesignPanelItem",props:{modelData:{type:Object,required:!0},controller:{type:xe,required:!0}},setup(e){const t=e.controller,s=S(),i=Y("dnd-design");t.view.select.on((e=>{s.value=e}));const n=(e,a,r)=>{const o="dnd-design-".concat(a?a.srfkey:"root");return k(T("iBizDraggable"),{class:{[i.b("drag-container")]:!0,...a?oe.getDraggableContainerClass(a,i):{}},style:a?oe.getFlexLayoutStyle(a):{},itemKey:"srfkey",handle:".handle",key:o,group:"dnd-design","ghost-class":i.b("ghost"),list:e,onChange:s=>t.change(s,e,a)},{item:i=>{var o;let l;const c=i.element,d=t.providers[c.srfkey];if(!d)return null;const h=t.controllers[c.srfkey],u=T(d.component);return k(T("iBizDraggableItem"),{class:a?oe.calcColClass(c,a):{},style:a?oe.calcStyle(c,a):{},controller:h,isSelect:(null==(o=s.value)?void 0:o.srfkey)===c.srfkey,key:c.srfkey,item:c,actions:h.actions,onClick:e=>((e,s)=>{e.stopPropagation(),t.view.select.set(s)})(e,c),onAction:s=>{h.onAction(s).then((i=>{!1===i&&"delete"===s.command&&t.remove(e,c)}))}},"function"==typeof(m=l=B(u,{controller:h},r?r(e,c):c.children?()=>n(c.children,c):void 0))||"[object Object]"===Object.prototype.toString.call(m)&&!F(m)?l:{default:()=>[l]});var m}})};return z("dndDesignRenderItems",n),{ns:i,renderItems:n,renderFormPage:()=>k(T("iBizDndDesignFormPage"),{key:t.state.uuid,items:t.state.items,select:s.value,onChange:e=>t.change(e,t.state.items),onRemove:e=>t.remove(t.state.items,e),onSelect:e=>{t.view.select.set(e)}},{default:e=>(e.children||(e.children=[]),n(e.children,e))}),onActiveRoot:e=>{e.stopPropagation(),t.view.call("onActiveRoot")}}},render(){return k("div",{class:this.ns.b(),onClick:e=>{this.onActiveRoot(e)}},[k("div",{class:this.ns.b("container")},[this.renderFormPage()])])}}),ke={install(e){e.component("IBizDndDesignPanelItem",Me),c("RAWITEM_DND_DESIGN_PANEL_ITEM",(()=>new Re))}},Te=Object.defineProperty,Se=(e,t,s)=>(((e,t,s)=>{t in e?Te(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s})(e,"symbol"!=typeof t?t+"":t,s),s);class Le extends d{constructor(){super(...arguments),Se(this,"items",[]),Se(this,"filterValue","")}}var Ne=Object.defineProperty,_e=(e,t,s)=>(((e,t,s)=>{t in e?Ne(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s})(e,"symbol"!=typeof t?t+"":t,s),s);class ze extends l{constructor(){super(...arguments),_e(this,"codeList"),_e(this,"codeItems",[]),_e(this,"enableGroup",!1),_e(this,"buttonGroupMap",new Map)}createState(){var e;return new Le(null==(e=this.parent)?void 0:e.state)}get view(){return this.panel.view}async onInit(){await super.onInit(),await this.load(),this.view.evt.on("onStencilSearch",(e=>{const t=e.eventArg||"";this.state.filterValue=t.trim().toLowerCase(),this.filter()}))}async load(){const e=this.model.editor;if(e){const{appCodeListId:t}=e;if(t){const e=await ibiz.hub.getApp(this.model.appId);this.codeList=e.codeList.getCodeList(t)}if(!this.codeList)throw new E(this.model,"未配置素材区代码表");this.codeItems=this.codeList.codeItems||[];const s=this.codeItems.findIndex((e=>!!(e.codeItems&&e.codeItems.length>1)));this.enableGroup=-1!==s,this.state.items=this.codeItems,this.filter()}else ibiz.log.warn("拖拽素材区控制器的 editor 为空")}filter(){this.state.filterValue?this.enableGroup?(this.state.items=[],this.codeItems.forEach((e=>{const t={...e};Array.isArray(t.codeItems)||(t.codeItems=[]),t.codeItems=t.codeItems.filter((e=>e.text&&e.text.toLowerCase().includes(this.state.filterValue))),this.state.items.push(t)}))):this.state.items=this.codeItems.filter((e=>e.text&&e.text.toLowerCase().includes(this.state.filterValue))):this.state.items=this.codeItems}async onActionClick(e,t){const s=e.uiactionId;await h.execAndResolved(s,{context:this.panel.context,params:this.panel.params,data:[],view:this.panel.view,event:t},e.appId)}}var Be=Object.defineProperty,Fe=(e,t,s)=>(((e,t,s)=>{t in e?Be(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s})(e,"symbol"!=typeof t?t+"":t,s),s);class je{constructor(){Fe(this,"component","IBizDndStencilPanelItem")}async createController(e,t,s){const i=new ze(e,t,s);return await i.init(),i}}var Ue=R({name:"IBizDndStencilPanelItem",props:{modelData:{type:Object,required:!0},controller:{type:ze,required:!0}},setup(e){const t=Y("dnd-stencil"),s=e=>{const t=JSON.parse(e.data||"{}");return t.srftype=t.detailtype,t},i=e=>{const t=e.item;t&&t.style.setProperty("--svg-visibility","hidden")},n=e=>{const t=e.item;t&&t.style.setProperty("--svg-visibility","")},a=async(t,s)=>{await e.controller.onActionClick(t,s)};return{ns:t,renderGroup:(r,o,l,c)=>{const d=e.controller.buttonGroupMap.get(c),h=d&&d.model,u=d&&d.state,m=h&&h.uiactionGroup;return k(T("el-collapse-item"),{title:r,name:l.toString()},{title:()=>k("div",{class:t.b("group-header")},[k("div",{class:t.b("group-header-text")},[r]),m&&u?k(T("iBizActionToolbar"),{class:t.b("group-header-toolbar"),actionDetails:m.uiactionGroupDetails,actionsState:u,onActionClick:a,caption:m.name,mode:"ITEMS"===h.actionGroupExtractMode?"dropdown":"buttons"},null):null]),default:()=>0===o.length?k("div",{class:t.bm("drag-container","empty")},[N("暂无数据")]):k(T("iBizDraggable"),{itemKey:"dnd-stencil",sort:!1,group:{name:"dnd-design",pull:"clone",put:!1},class:t.b("drag-container"),list:o,clone:s,onStart:i,onEnd:n},{item:e=>{const s=e.element;return k("div",{key:e.index,class:[t.b("handle")],title:s.text},[k("svg",{class:t.be("handle","svg"),height:"100%",width:"100%",xmlns:"http://www.w3.org/2000/svg"},[k("rect",{height:"100%",width:"100%"},null)]),k("div",{class:[t.b("handle-content")]},[k("div",{class:[t.be("handle","icon")]},[s.iconPath?k("ion-icon",{src:Ie.dir(s.iconPath)},null):null]),k("div",{class:[t.be("handle","text")]},[s.text])])])}})})},clone:s,actives:["0","1","2","3","4","5","6","7","8","9"]}},render(){const e=[];return this.controller.enableGroup?this.controller.state.items.forEach(((t,s)=>{e.push(this.renderGroup(t.text,t.codeItems,s,t.codeName))})):e.push(this.renderGroup(this.controller.codeList.name,this.controller.state.items,0,this.controller.codeList.codeName)),k("div",{class:this.ns.b()},[k(T("el-collapse"),{modelValue:this.actives,"onUpdate:modelValue":e=>this.actives=e},(t=e,"function"==typeof t||"[object Object]"===Object.prototype.toString.call(t)&&!F(t)?e:{default:()=>[e]}))]);var t}}),Ge={install(e){e.component("IBizDndStencilPanelItem",Ue),c("FIELD_DND_PANEL_ITEM_STENCIL",(()=>new je))}},Ve=Object.defineProperty,Ye=(e,t,s)=>(((e,t,s)=>{t in e?Ve(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s})(e,"symbol"!=typeof t?t+"":t,s),s);class He extends d{constructor(){super(...arguments),Ye(this,"items",[])}}class Ke extends u{get srftext(){let e=this.caption;const t=this.psdefformitemname||this.psdefuimodename,s=this.psdeformdetailname||this.psdefname;if("FORMITEM"===this.detailtype){const i=this.logicname;return A(e)&&O(i)&&A(t)&&(e=i),O(e)?O(t)?"".concat(e,"(").concat(s,")[").concat(t,"]"):"".concat(e,"(").concat(s,")"):O(t)?"".concat(s,"(").concat(t,")"):s}return O(e)?"".concat(e,"(").concat(s,")"):s}get srftype(){return this.detailtype}set srftype(e){this.detailtype=e}get srfpkey(){return this.ppsdeformdetailid}set srfpkey(e){this.ppsdeformdetailid=e}get srfordervalue(){return this.ordervalue}set srfordervalue(e){this.ordervalue=e}clone(){const e=new Ke(this._entity,this._data);return e.srfkey=this.srfkey,e}}class Xe extends u{constructor(e,t,s){super(e,t),Object.defineProperty(this,"_typeCodeItems",{enumerable:!1,configurable:!0,value:s})}get srftext(){return"GROUP"===this.srftype?"".concat(this.groupop||""):"".concat(this.fdname||""," ").concat(this.psdbvalueopname||""," ").concat(this.condvalue||"")}get srftype(){return this.logictype}set srftype(e){this.logictype=e}get srficon(){const e=this._typeCodeItems.find((e=>e.value===this.srftype));return e?e.sysImage:void 0}get srfallowdrop(){return"GROUP"===this.srftype}clone(){const e=new Xe(this._entity,this._data,this._typeCodeItems);return e.srfkey=this.srfkey,e}}var qe=Object.defineProperty,We=(e,t,s)=>(((e,t,s)=>{t in e?qe(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s})(e,"symbol"!=typeof t?t+"":t,s),s);class Je{constructor(e){We(this,"entity"),We(this,"parent",null),We(this,"children",[]),this.entity=e}get id(){return this.entity.srfkey||""}get text(){return this.entity.srftext||""}get type(){return this.entity.srftype||""}}var Ze=Object.defineProperty,$e=(e,t,s)=>(((e,t,s)=>{t in e?Ze(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s})(e,"symbol"!=typeof t?t+"":t,s),s);class Qe extends l{constructor(){super(...arguments),$e(this,"codeList"),$e(this,"service"),$e(this,"form"),$e(this,"evt",new m),$e(this,"items",[]),$e(this,"timer",null),$e(this,"isDisableMessage",!1),$e(this,"codeItemList",[])}get view(){return this.panel.view}createState(){var e;return new He(null==(e=this.parent)?void 0:e.state)}async onInit(){await super.onInit();const e=i(this.panel.view.model,"item");if(!e)throw new E(this.panel.view,"未找到 item 表单模型");this.form=e;const t=await ibiz.hub.getApp(this.model.appId);this.service=await t.deService.getService(this.panel.context,e.appDataEntityId);const s=this.model.editor;if(s){const{appCodeListId:e}=s;if(e&&(this.codeList=t.codeList.getCodeList(e)),!this.codeList)throw new E(this.model,"未配置结构区代码表");const i=this.codeList.codeItems||[],n=[];i.forEach((e=>{const t=e.value,s=e.codeItems;if(t&&Array.isArray(s)){const e=new Map;s.forEach((t=>{const s=t.value;s&&e.set(s,t)})),n.push({key:t,map:e})}})),this.codeItemList=n}this.view.evt.on("onSaveSuccess",(async()=>{await this.load()})),await this.load(),this.subscribeMessage()}getNodeIcon(e){const t=e.entity;for(let e=0;e<this.codeItemList.length;e++){const s=this.codeItemList[e],{key:i,map:n}=s,a=t[i];if(a&&n.get(a))return n.get(a).iconPath}}onDataUpdate(e){if(!this.isDisableMessage&&e.data&&"object"==typeof e.data){const t=e.data;if(t.srfkey){const e=this.items.findIndex((e=>e.srfkey===t.srfkey));-1!==e&&(this.items.splice(e,1),this.items.push(t),this.timer&&window.clearTimeout(this.timer),this.timer=window.setTimeout((()=>{this.items=x(this.items,"srfordervalue"),this.state.items=this.transformItemsToTree(this.items),this.evt.emit("updateSelect")}),50))}}}onDataCreate(e){if(!this.isDisableMessage&&e.messageid===this.panel.context.srfsessionid&&e.data&&"object"==typeof e.data){const t=e.data;t.srfkey&&(this.items.push(t),this.items=x(this.items,"srfordervalue"),this.state.items=this.transformItemsToTree(this.items),this.evt.emit("updateSelect"))}}onDataRemove(e){if(!this.isDisableMessage&&e.data&&"object"==typeof e.data){const t=e.data;if(t.srfkey){const e=this.items.findIndex((e=>e.srfkey===t.srfkey));-1!==e&&(this.items.splice(e,1),this.items=x(this.items,"srfordervalue"),this.state.items=this.transformItemsToTree(this.items),this.evt.emit("updateSelect"))}}}sendMessage(e,t,s){this.isDisableMessage=!0,e.forEach((e=>{t?ibiz.mc.command.send(e,t):s&&ibiz.mc.command.next({...s,data:e})})),this.isDisableMessage=!1}subscribeMessage(){this.onDataUpdate=this.onDataUpdate.bind(this),this.onDataCreate=this.onDataCreate.bind(this),this.onDataRemove=this.onDataRemove.bind(this),ibiz.mc.command.update.on(this.onDataUpdate),ibiz.mc.command.create.on(this.onDataCreate),ibiz.mc.command.remove.on(this.onDataRemove)}unsubscribeMessage(){ibiz.mc.command.update.off(this.onDataUpdate),ibiz.mc.command.create.off(this.onDataCreate),ibiz.mc.command.remove.off(this.onDataRemove)}destroy(){super.destroy(),this.unsubscribeMessage()}async load(){const e=await this.service.fetchDefault(this.panel.context);if(e.ok&&Array.isArray(e.data)){const t=x(e.data,"srfordervalue");this.items=t,this.state.items=this.transformItemsToTree(t)}else this.state.items=[]}transformItemsToTree(e){const t={},s=[];return e.forEach((e=>{const s=e.srfkey;s&&(t[s]=new Je(e))})),e.forEach((e=>{const i=t[e.srfkey];if(i)if(e.srfpkey){const s=e.srfpkey?t[e.srfpkey]:null;s&&(i.parent=s,s.children.push(i))}else i.parent=null,s.push(i)})),s}change(e,t,s){s?(e.parent=s,e.entity.srfpkey=s.entity.srfkey):(e.parent=null,e.entity.srfpkey=void 0),this.move(t.map((e=>e.entity)),0,t.length-1)}async move(e,t,s){const i=t>s?s:t,n=t>s?t:s,a=[];e.forEach(((e,t)=>{t>=i&&t<=n&&(e.srfordervalue=10*(t+1),a.push(e))}));const r=await this.service.update(this.panel.context,a);r.ok&&(Array.isArray(r.data)&&this.sendMessage(r.data,"OBJECTUPDATED"),ibiz.log.debug("排序成功"))}}var et=R({name:"IBizDndStructurePanelItem",props:{modelData:{type:Object,required:!0},controller:{type:Qe,required:!0}},setup(e){const t=Y("dnd-structure"),s=S(null),i=S("");L(i,(()=>{s.value&&s.value.filter(i.value)}));const n=e=>{if(s.value){if(e){if(s.value.getNode(e.srfkey))return void s.value.setCurrentKey(e.srfkey)}s.value.setCurrentKey()}};e.controller.view.select.on((e=>{n(e)})),j((()=>{n(e.controller.view.select.data)}));const a=()=>{G((()=>{n(e.controller.view.select.data)}))};e.controller.evt.on("updateSelect",a);return U((()=>{e.controller.evt.off("updateSelect",a)})),{ns:t,tree:s,searchValue:i,filterNode:(e,t)=>{if(!e)return!0;const s=e.trim().toLowerCase();return t.text.includes(s)},onCurrentNodeChange:t=>{t&&e.controller.view.select.set(t.entity)},allowDrag:e=>{const t=e.data;if(0===e.level||"FORMPAGE"===t.type)return!1;if(!i.value)return!0;return!i.value.trim().toLowerCase()},allowDrop:(e,t,s)=>{const i=e.data,n=t.data;if("inner"===s){return!!["GROUPPANEL","FORMPAGE"].includes(n.type)}return 0!==t.level&&("FORMPAGE"!==n.type||"FORMPAGE"===i.type)},onNodeDrop:(t,s,i)=>{const n=t.data,a=s.data;if("inner"===i)return void e.controller.change(n,a.children,a);const r=a.parent;r?e.controller.change(n,r.children,r):e.controller.change(n,e.controller.state.items)}}},render(){return k("div",{class:this.ns.b()},[k("div",{class:this.ns.b("header")},[k(T("el-input"),{modelValue:this.searchValue,"onUpdate:modelValue":e=>this.searchValue=e,"prefix-icon":k("ion-icon",{name:"search-outline"},null),clearable:!0},null)]),k("div",{class:this.ns.b("content")},[k(T("el-tree"),{ref:"tree",data:this.controller.state.items,"node-key":"id",props:{label:"text",children:"children"},indent:8,draggable:!0,"default-expand-all":!0,"expand-on-click-node":!1,"highlight-current":!0,"filter-node-method":this.filterNode,onCurrentChange:this.onCurrentNodeChange,"allow-drag":this.allowDrag,"allow-drop":this.allowDrop,onNodeDrop:this.onNodeDrop},{default:({data:e})=>{const t=this.controller.getNodeIcon(e);return k("div",{class:this.ns.b("node")},[k("div",{class:this.ns.be("node","icon")},[t?k("ion-icon",{src:Ie.dir(t)},null):null]),k("div",{class:this.ns.be("node","text"),title:e.text},[e.text])])}})])])}}),tt=Object.defineProperty,st=(e,t,s)=>(((e,t,s)=>{t in e?tt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s})(e,"symbol"!=typeof t?t+"":t,s),s);class it{constructor(){st(this,"component","IBizDndStructurePanelItem")}async createController(e,t,s){const i=new Qe(e,t,s);return await i.init(),i}}var nt={install(e){e.component("IBizDndStructurePanelItem",et),c("FIELD_DND_PANEL_STRUCTURE",(()=>new it))}};class at extends l{get view(){return this.panel.view}sendMessage(e){this.view.evt.emit("onStencilSearch",{eventArg:e})}}var rt=R({name:"IBizDndStencilSearchInput",props:{modelData:{type:Object,required:!0},controller:{type:at,required:!0}},setup(e){const t=Y("dnd-stencil-search-input"),s=S("");return L(s,(()=>{e.controller.sendMessage(s.value)})),{ns:t,searchValue:s}},render(){return k("div",{class:this.ns.b()},[k(T("el-input"),{modelValue:this.searchValue,"onUpdate:modelValue":e=>this.searchValue=e,placeholder:"输入关键词进行过滤","prefix-icon":k("ion-icon",{name:"search-outline"},null),clearable:!0},null)])}}),ot=Object.defineProperty,lt=(e,t,s)=>(((e,t,s)=>{t in e?ot(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s})(e,"symbol"!=typeof t?t+"":t,s),s);class ct{constructor(){lt(this,"component","IBizDndStencilSearchInput")}async createController(e,t,s){const i=new at(e,t,s);return await i.init(),i}}var dt={install(e){e.component("IBizDndStencilSearchInput",rt),c("FIELD_DND_PANEL_ITEM_STENCIL_SEARCH",(()=>new ct))}},ht={install(e){e.component("IBizDraggable",q),e.use(ke),e.use(Ge),e.use(nt),e.use(dt)}},ut=Object.defineProperty,mt=(e,t,s)=>(((e,t,s)=>{t in e?ut(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s})(e,"symbol"!=typeof t?t+"":t,s),s);class pt{constructor(e,t,s){mt(this,"actions",[{icon:k("ion-icon",{name:"trash-outline"},null),text:"删除",command:"delete"}]),this.c=e,this.data=s,this.model=t,this.select=e.view.select}async onAction(e){return!1}destroy(){}change(e,t,s){this.c.change(e,t,s)}async remove(e,t){return this.c.remove(e,t)}}var ft=R({name:"IBizDndDesignFormItem",props:{controller:{type:pt,required:!0}},setup(e){const t=Y("dnd-design-form-item"),s=()=>{const t=e.controller.data,s="".concat(t.logicname||"","(").concat(t.srftext,")");return k(T("el-input"),{placeholder:s,disabled:!0},null)},i=()=>{const i=e.controller.data,n=(()=>{const t=e.controller.data;if(t&&t.rawcssstyle){const e=t.rawcssstyle.split("\n"),s=[];for(let t=0;t<e.length;t++)s.push(...e[t].split(";").filter((e=>e)));return s.filter((e=>2===e.split(":").length)).join(";")}})(),a="".concat(i.logicname||"","(").concat(i.srftext,")"),r=new Date;if(i)switch(i.editortype){case"HIDDEN":return k("div",{style:"padding-left: 10px;",class:"design-item-hidden"},[N("隐藏表单项")]);case"SPAN":return k("span",{style:"padding-left: 10px;".concat(n),class:"design-design-editor"},[a]);case"RADIOBUTTONLIST":return k(T("el-radio-group"),{"model-value":"",disabled:!0},{default:()=>[k(T("el-radio"),{label:"1"},{default:()=>[N("选项一")]}),k(T("el-radio"),{label:"2"},{default:()=>[N("选项二")]}),k(T("el-radio"),{label:"3"},{default:()=>[N("选项三")]})]});case"ADDRESSPICKUP":case"ADDRESSPICKUP_AC":return k(T("el-select"),{mode:"tags",style:"width: 100%",placeholder:a,disabled:!0},{default:()=>[k(T("el-option"),{value:"1"},{default:()=>[N("选项一")]}),k(T("el-option"),{value:"2"},{default:()=>[N("选项二")]}),k(T("el-option"),{value:"3"},{default:()=>[N("选项三")]})]});case"TEXTAREA":return k(T("el-input"),{placeholder:a,style:i.ctrlheight?"height: ".concat(i.ctrlheight,"px;"):"",class:t.e("textarea"),disabled:!0},null);case"TEXTAREA_10":return k(T("el-input"),{placeholder:a,rows:10,disabled:!0},null);case"PASSWORD":return k(T("el-input"),{placeholder:a,disabled:!0},null);case"DATEPICKEREX":case"DATEPICKEREX_SECOND":return k(T("el-date-picker"),{"model-value":W(r).format("YYYY-MM-DD HH:mm:ss"),format:"YYYY-MM-DD HH:mm:ss",disabled:!0},null);case"DATEPICKEREX_MINUTE":return k(T("el-date-picker"),{"model-value":W(r).format("YYYY-MM-DD HH:mm"),format:"YYYY-MM-DD HH:mm",disabled:!0},null);case"DATEPICKEREX_NODAY":return k(T("el-date-picker"),{"model-value":W(r).format("HH:mm:ss"),format:"HH:mm:ss",disabled:!0},null);case"DATEPICKEREX_NODAY_NOSECOND":return k(T("el-date-picker"),{"model-value":W(r).format("HH:mm"),format:"HH:mm",disabled:!0},null);case"DATEPICKEREX_NOTIME":return k(T("el-date-picker"),{"model-value":W(r).format("YYYY-MM-DD"),format:"YYYY-MM-DD",disabled:!0},null);case"DATEPICKEREX_HOUR":return k(T("el-date-picker"),{"model-value":W(r).format("YYYY-MM-DD HH"),format:"YYYY-MM-DD HH",disabled:!0},null);case"DATEPICKER":return k(T("el-date-picker"),{class:t.e("datepicker"),"model-value":W(r).format("YYYY-MM-DD HH:mm:ss"),format:"YYYY-MM-DD HH:mm:ss",disabled:!0},null);case"TEXTBOX":return k(T("el-input"),{style:n,placeholder:a,disabled:!0},null);case"FILEUPLOADER":return k(T("el-button"),{disabled:!0,class:t.e("fileuploader")},{default:()=>[k("ion-icon",{name:"cloud-upload-outline"},null),a]});case"AC":case"AC_NOBUTTON":case"AC_FS_NOBUTTON":case"AC_FS":case"PICKEREX_LINKONLY":case"PICKER":case"PICKUPVIEW":case"PICKEREX_LINK":case"PICKEREX_NOAC_LINK":case"PICKEREX_NOAC":case"PICKEREX_NOBUTTON":case"PICKEREX_TRIGGER_LINK":case"PICKEREX_TRIGGER":case"DROPDOWNLIST":case"MDROPDOWNLIST":case"DROPDOWNLIST_100":return k(T("el-select"),{"model-value":"选项一",style:"width: 100%",disabled:!0},{default:()=>[k(T("el-option"),{value:"选项一"},{default:()=>[N("选项一")]}),k(T("el-option"),{value:"选项二"},{default:()=>[N("选项二")]}),k(T("el-option"),{value:"选项三"},{default:()=>[N("选项三")]})]});case"CHECKBOX":return k(T("el-checkbox"),{disabled:!0},{default:()=>[N("选项")]});case"CHECKBOXLIST":return k(T("el-checkbox-group"),{disabled:!0},{default:()=>[k(T("el-checkbox"),{disabled:!0},{default:()=>[N("选项一")]}),N(";"),k(T("el-checkbox"),{disabled:!0},{default:()=>[N("选项二")]}),N(";")]});case"NUMBER":return k(T("el-input-number"),{class:t.e("number"),style:"width: 100%",disabled:!0},null);case"USERCONTROL":return k("span",null,[N("用户自定义")]);case"RATING":return k(T("el-rate"),{"text-color":"#ff9900","model-value":4,disabled:!0},null);case"SLIDER":return k(T("el-slider"),{"model-value":30,"show-input":!0,class:t.e("slider")},null);case"DATERANGE":return k(T("el-date-picker"),{"model-value":[r,r],type:"datetimerange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",format:"YYYY-MM-DD HH:mm:ss",disabled:!0,class:t.e("daterange")},null);case"ARRAY":return k("div",{class:t.e("panel-array-input")},[k(T("el-input"),{placeholder:a,disabled:!0},null),k(T("el-button"),{type:"primary",circle:!0,class:t.e("panel-array-input-add-button")},{default:()=>[k("ion-icon",{name:"add-outline"},null)]}),k(T("el-button"),{type:"danger",circle:!0,class:t.e("panel-array-input-remove-button")},{default:()=>[k("ion-icon",{name:"remove-outline"},null)]})]);case"MAPPICKER":return k(T("el-cascader"),{class:t.e("mappicker"),options:[{value:"省",label:"省",children:[{value:"市",label:"市",children:[{value:"区",label:"区"}]}]}],"model-value":["省","市","区"],disabled:!0},null);case"SWITCH":return k(T("el-switch"),{disabled:!0},null);default:return s()}return s()};return{ns:t,renderDesignItem:i,renderContent:()=>{const s=e.controller.data,n=s.labelpos?s.labelpos.toLowerCase():"left",a=Object.is(n,"top")||Object.is(n,"bottom")?"":"width: ".concat(s.labelwidth||130,"px;"),r=((e,t)=>{let s="";return Object.is(t,"none")||Object.is(t,"top")||Object.is(t,"bottom")||"0"===e.showcaption?e.ctrlwidth?s+="width: ".concat(e.ctrlwidth,"px;"):s+="width: 100%;":e.ctrlwidth?s+="width: ".concat(e.ctrlwidth,"px;"):s+="width: calc(100% - ".concat(e.labelwidth||130,"px);"),e.ctrlheight?s+="height: ".concat(e.ctrlheight,"px;"):s+="height: 100%;",s})(s,n);return"FIELD"===s.itemtype?k("div",{class:"design-form-item ".concat(n||"left")},[k("div",{class:t.e("container-content"),style:{width:"100%",height:"100%"}},[i()])]):k("div",{class:"".concat(t.e("item-content")," ").concat(t.em("item-content",n||"left"))},["0"===s.showcaption?null:k("div",{class:t.e("label-content"),style:a},["1"===s.emptycaption?null:k("label",{class:t.e("label")},[Object.is(n,"right")?"：":"",s.caption||"",Object.is(n,"right")?"":"："])]),k("div",{class:t.e("container-content"),style:r},[i()])])}}},render(){return k("div",{class:this.ns.b()},[k("div",{class:this.ns.e("wrapper")},null),this.renderContent()])}}),gt=Object.defineProperty,vt=(e,t,s)=>(((e,t,s)=>{t in e?gt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s})(e,"symbol"!=typeof t?t+"":t,s),s);class yt{constructor(){vt(this,"type","PSDEFORMDETAIL_FORMITEM"),vt(this,"component","IBizDndDesignFormItem")}createController(e,t,s){return new pt(e,t,s)}}var bt={install(e){e.component(ft.name,ft);const t=new yt;te.registerItemProvider(t.type,t)}};function wt(){return V("dndDesignRenderItems")}var It=R({name:"IBizDndDesignFormPanel",props:{controller:{type:pt,required:!0}},setup:()=>({ns:Y("dnd-design-group-panel"),renderItems:wt()}),render(){const e=this.controller.data,t=0===e.showcaption;return k("div",{class:this.ns.b()},[t?k("div",{class:this.ns.b("info")},[e.srftext||""]):k("div",{class:this.ns.b("header")},[k("div",null,[k("div",{class:this.ns.be("header","text")},[e.srftext||""]),k("ion-icon",{class:this.ns.be("header","icon"),name:"caret-down"},null)])]),k("div",{class:this.ns.b("content")},[this.renderItems(e.children,e)])])}}),Dt=Object.defineProperty,Et=(e,t,s)=>(((e,t,s)=>{t in e?Dt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s})(e,"symbol"!=typeof t?t+"":t,s),s);class Ct{constructor(){Et(this,"type","PSDEFORMDETAIL_GROUPPANEL"),Et(this,"component","IBizDndDesignFormPanel")}createController(e,t,s){return new pt(e,t,s)}}var Pt={install(e){e.component(It.name,It);const t=new Ct;te.registerItemProvider(t.type,t)}};var xt=R({name:"IBizDndDesignRawItem",props:{controller:{type:pt,required:!0}},setup(e){const t=Y("dnd-design-raw-item");return{ns:t,renderContent:()=>{switch(e.controller.data.contenttype){case"RAW":return(()=>{const s=e.controller.data;return k("div",{class:t.e("raw")},[s.rawcontent||s.srftext||""])})();case"HTML":return(()=>{const s=e.controller.data;return s.htmlcontent?k("div",{class:t.e("html"),innerHTML:s.htmlcontent},null):k("div",{class:t.e("html")},[s.srftext||""])})();case"IMAGE":return k("div",{class:t.e("image")},[k("svg",{width:"56px",height:"56px",viewBox:"0 0 56 56",version:"1.1",xmlns:"http://www.w3.org/2000/svg"},[k("g",{stroke:"none","stroke-width":"1",fill:"none","fill-rule":"evenodd"},[k("g",{id:"image-fill",transform:"translate(4.000000, 0.000000)",style:"fill: currentColor;","fill-rule":"nonzero"},[k("rect",{id:"矩形",opacity:"0",x:"0",y:"0",width:"48",height:"48"},null),k("path",{d:"M43.5,7.5 L4.5,7.5 C3.6703125,7.5 3,8.1703125 3,9 L3,39 C3,39.8296875 3.6703125,40.5 4.5,40.5 L43.5,40.5 C44.3296875,40.5 45,39.8296875 45,39 L45,9 C45,8.1703125 44.3296875,7.5 43.5,7.5 Z M15.84375,14.25 C17.4984375,14.25 18.84375,15.5953125 18.84375,17.25 C18.84375,18.9046875 17.4984375,20.25 15.84375,20.25 C14.1890625,20.25 12.84375,18.9046875 12.84375,17.25 C12.84375,15.5953125 14.1890625,14.25 15.84375,14.25 Z M39.9328125,34.7390625 C39.8671875,34.7953125 39.778125,34.828125 39.6890625,34.828125 L8.30625,34.828125 C8.1,34.828125 7.93125,34.659375 7.93125,34.453125 C7.93125,34.3640625 7.9640625,34.2796875 8.0203125,34.209375 L16.003125,24.740625 C16.134375,24.58125 16.3734375,24.5625 16.5328125,24.69375 C16.546875,24.7078125 16.565625,24.721875 16.5796875,24.740625 L21.2390625,30.271875 L28.65,21.4828125 C28.78125,21.3234375 29.0203125,21.3046875 29.1796875,21.4359375 C29.19375,21.45 29.2125,21.4640625 29.2265625,21.4828125 L39.9890625,34.2140625 C40.1109375,34.36875 40.0921875,34.6078125 39.9328125,34.7390625 Z",id:"形状"},null)])])])]);case"VIDEO":return k("div",{class:t.e("video")},[k("svg",{width:"56px",height:"56px",viewBox:"0 0 56 56",version:"1.1",xmlns:"http://www.w3.org/2000/svg"},[k("g",{stroke:"none","stroke-width":"1",fill:"none","fill-rule":"evenodd"},[k("g",{id:"video",transform:"translate(4.000000, 4.000000)","fill-rule":"nonzero"},[k("rect",{id:"矩形",style:"fill: currentColor;",opacity:"0",x:"0",y:"0",width:"48",height:"48"},null),k("rect",{id:"矩形",style:"stroke: currentColor;","stroke-width":"2",x:"5",y:"5",width:"38",height:"38",rx:"2"},null),k("path",{d:"M19.842,16.7706563 L30.3061875,22.4005313 C31.4090625,22.993875 31.822125,24.369 31.2287812,25.4717812 C30.9959833,25.9045408 30.6289074,26.2499678 30.1828125,26.4560625 L19.7187188,31.290375 C18.5818125,31.8156563 17.2343438,31.3198125 16.7090625,30.1828125 C16.571335,29.8846905 16.5,29.560211 16.5,29.2318125 L16.5,18.767625 C16.5,17.5153125 17.5153125,16.5 18.767625,16.5 C19.142625,16.5 19.5118125,16.593 19.842,16.7706563 Z",id:"形状",style:"fill: currentColor;"},null)])])])]);case"PLACEHOLDER":return k("div",{class:t.e("placeholder")},[N("占位(PLACEHOLDER)")]);case"DIVIDER":return k(T("el-divider"),{class:t.e("divider")},{default:()=>[N("分割线(DIVIDER)")]});case"INFO":return k("div",{class:t.e("info")},[N("常规提示(INFO)")]);case"WARNING":return k("div",{class:t.e("warning")},[N("警告提示(WARNING)")]);case"ERROR":return k("div",{class:t.e("error")},[N("错误提示(ERROR)")]);default:return k("div",{class:t.e("default")},[N("直接内容")])}}}},render(){return k("div",{class:this.ns.b()},[this.renderContent()])}}),At=Object.defineProperty,Ot=(e,t,s)=>(((e,t,s)=>{t in e?At(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s})(e,"symbol"!=typeof t?t+"":t,s),s);class Rt{constructor(){Ot(this,"type","PSDEFORMDETAIL_RAWITEM"),Ot(this,"component","IBizDndDesignRawItem")}createController(e,t,s){return new pt(e,t,s)}}var Mt={install(e){e.component(xt.name,xt);const t=new Rt;te.registerItemProvider(t.type,t)}},kt=R({name:"IBizDndDesignTabPage",setup:()=>()=>k("div",null,[N("分页面板")])}),Tt=Object.defineProperty,St=(e,t,s)=>(((e,t,s)=>{t in e?Tt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s})(e,"symbol"!=typeof t?t+"":t,s),s);class Lt{constructor(){St(this,"type","PSDEFORMDETAIL_TABPAGE"),St(this,"component","IBizDndDesignTabPage")}createController(e,t,s){return new pt(e,t,s)}}var Nt={install(e){e.component(kt.name,kt);const t=new Lt;te.registerItemProvider(t.type,t)}},_t=R({name:"IBizDndDesignTabPanel",props:{controller:{type:Object,required:!0}},setup(e){const t=Y("dnd-design-tab-panel"),s=e.controller,i=wt(),n=S(),a=S(s.select.data);s.select.on((e=>{a.value=e}));L(a,(()=>{const e=s.data.children;if(Array.isArray(e)&&e.length&&a.value){const t=e.find((e=>e.srfkey===a.value.srfkey));t&&(n.value=t.srfkey)}}),{immediate:!0});return{ns:t,activePage:n,select:a,onActivePageChange:e=>{n.value=e.srfkey,s.select.set(e)},onPagePositionChange:async e=>{const t=s.data.children;Array.isArray(t)&&s.change(e,t,s.data)},onPageAdd:async()=>{const e=s.data.children;Array.isArray(e)&&(e.push({detailtype:"TABPAGE"}),s.change({added:{element:e[e.length-1],newIndex:e.length-1}},e,s.data))},onPageRemove:async e=>{const t=s.data.children;Array.isArray(t)&&s.remove(t,e)},renderItems:i}},render(){const e=this.controller.data.children||[];return k("div",{class:this.ns.b()},[k(T("iBizDraggableTabs"),{value:this.activePage,items:e,dragSwitchPage:!1,select:this.select,class:this.ns.b("content"),onChange:this.onActivePageChange,onDragChange:this.onPagePositionChange,onAdd:this.onPageAdd,onRemove:this.onPageRemove},{default:e=>this.renderItems(e.children,e)})])}}),zt=Object.defineProperty,Bt=(e,t,s)=>(((e,t,s)=>{t in e?zt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s})(e,"symbol"!=typeof t?t+"":t,s),s);class Ft{constructor(){Bt(this,"type","PSDEFORMDETAIL_TABPANEL"),Bt(this,"component","IBizDndDesignTabPanel")}createController(e,t,s){return new pt(e,t,s)}}var jt={install(e){e.component(_t.name,_t);const t=new Ft;te.registerItemProvider(t.type,t)}},Ut=R({name:"IBizDndDesignFormPage",props:{items:{type:Array,required:!0,default:()=>[]},select:{type:Object}},emits:["change","remove","select"],setup(e,{emit:t}){const s=Y("dnd-design-form-page"),i=S();L((()=>e.select),(()=>{const t=e.items;if(Array.isArray(t)&&t.length&&e.select){const s=t.find((t=>t.srfkey===e.select.srfkey));s&&(i.value=s.srfkey)}}),{immediate:!0});return{ns:s,activePage:i,onActivePageChange:e=>{i.value=e.srfkey,t("select",e)},onPagePositionChange:async e=>{t("change",e)},onPageAdd:async()=>{const s=e.items;s.push({detailtype:"FORMPAGE"}),t("change",{added:{element:s[s.length-1],newIndex:s.length-1}})},onPageRemove:async e=>{t("remove",e)}}},render(){return k("div",{class:this.ns.b()},[k(T("iBizDraggableTabs"),{value:this.activePage,items:this.items,select:this.select,onChange:this.onActivePageChange,onDragChange:this.onPagePositionChange,onAdd:this.onPageAdd,onRemove:this.onPageRemove},{default:e=>{var t,s;return null==(s=(t=this.$slots).default)?void 0:s.call(t,e)}})])}}),Gt={install(e){e.component(Ut.name,Ut)}},Vt=R({name:"IBizDndDesignButton",props:{controller:{type:pt,required:!0}},setup:()=>({ns:Y("dnd-design-button")}),render(){const e=this.controller.data;return k("div",{class:this.ns.b()},[k(T("el-button"),{class:this.ns.b("content")},{default:()=>[0!==e.showcaption?e.srftext||"":"*"]})])}}),Yt=Object.defineProperty,Ht=(e,t,s)=>(((e,t,s)=>{t in e?Yt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s})(e,"symbol"!=typeof t?t+"":t,s),s);class Kt{constructor(){Ht(this,"type","PSDEFORMDETAIL_BUTTON"),Ht(this,"component","IBizDndDesignButton")}createController(e,t,s){return new pt(e,t,s)}}var Xt={install(e){e.component(Vt.name,Vt);const t=new Kt;te.registerItemProvider(t.type,t)}},qt=R({name:"IBizDndDesignIframe",props:{controller:{type:pt,required:!0}},setup:()=>({ns:Y("dnd-design-iframe")}),render(){const e=this.controller.data;return k("div",{class:this.ns.b()},[k("div",{class:this.ns.b("content")},[e.srftext||"",N("[直接嵌入页面（iframe）]")])])}}),Wt=Object.defineProperty,Jt=(e,t,s)=>(((e,t,s)=>{t in e?Wt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s})(e,"symbol"!=typeof t?t+"":t,s),s);class Zt{constructor(){Jt(this,"type","PSDEFORMDETAIL_IFRAME"),Jt(this,"component","IBizDndDesignIframe")}createController(e,t,s){return new pt(e,t,s)}}var $t={install(e){e.component(qt.name,qt);const t=new Zt;te.registerItemProvider(t.type,t)}},Qt=R({name:"IBizDndDesignDRUIPart",props:{controller:{type:pt,required:!0}},setup:()=>({ns:Y("dnd-design-druipart")}),render(){const e=this.controller.data;return k("div",{class:this.ns.b()},[k("div",{class:this.ns.b("content")},[e.srftext||"",N("[关系]")])])}}),es=Object.defineProperty,ts=(e,t,s)=>(((e,t,s)=>{t in e?es(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s})(e,"symbol"!=typeof t?t+"":t,s),s);class ss{constructor(){ts(this,"type","PSDEFORMDETAIL_DRUIPART"),ts(this,"component","IBizDndDesignDRUIPart")}createController(e,t,s){return new pt(e,t,s)}}var is={install(e){e.component(Qt.name,Qt);const t=new ss;te.registerItemProvider(t.type,t)}},ns=R({name:"IBizDndDesignMDCtrl",props:{controller:{type:pt,required:!0}},setup:()=>({ns:Y("dnd-design-mdctrl")}),render(){const e=this.controller.data;return k("div",{class:this.ns.b()},[k("div",{class:this.ns.b("content")},[e.srftext||"",N("[多数据部件]")])])}}),as=Object.defineProperty,rs=(e,t,s)=>(((e,t,s)=>{t in e?as(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s})(e,"symbol"!=typeof t?t+"":t,s),s);class os{constructor(){rs(this,"type","PSDEFORMDETAIL_MDCTRL"),rs(this,"component","IBizDndDesignMDCtrl")}createController(e,t,s){return new pt(e,t,s)}}var ls={install(e){e.component(ns.name,ns);const t=new os;te.registerItemProvider(t.type,t)}},cs=R({name:"IBizDndDesignFormItemEx",props:{controller:{type:Object,required:!0}},setup:()=>({ns:Y("dnd-design-form-item-ex")}),render(){const e=this.controller.data;return k("div",{class:this.ns.b()},[k("div",{class:this.ns.b("content")},[e.srftext||"",N("[复合表单项]")])])}}),ds=Object.defineProperty,hs=(e,t,s)=>(((e,t,s)=>{t in e?ds(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s})(e,"symbol"!=typeof t?t+"":t,s),s);class us{constructor(){hs(this,"type","PSDEFORMDETAIL_FORMITEMEX"),hs(this,"component","IBizDndDesignFormItemEx")}createController(e,t,s){return new pt(e,t,s)}}var ms={install(e){e.component(cs.name,cs);const t=new us;te.registerItemProvider(t.type,t)}},ps={install(e){e.use(bt),e.use(Pt),e.use(Mt),e.use(Nt),e.use(jt),e.use(Gt),e.use(Xt),e.use($t),e.use(is),e.use(ls),e.use(ms)}},fs=Object.defineProperty,gs=(e,t,s)=>(((e,t,s)=>{t in e?fs(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s})(e,"symbol"!=typeof t?t+"":t,s),s);class vs extends ze{constructor(){super(...arguments),gs(this,"app"),gs(this,"form"),gs(this,"service"),gs(this,"fieldForm"),gs(this,"fieldService"),gs(this,"fieldItems",[]),gs(this,"items",[]),gs(this,"enableGroup",!0),gs(this,"mdCtrlFieldType",["ONE2MANYDATA","ONE2ONEDATA","ONE2MANYDATA_MAP","ONE2MANYOBJ","ONE2ONEOBJ","ONE2MANYOBJ_MAP"])}get view(){return this.panel.view}async onInit(){this.app=await ibiz.hub.getApp(this.model.appId);const e=i(this.panel.view.model,"item");if(!e)throw new E(this.panel.view,"未找到 item 表单模型");this.form=e,this.service=await this.app.deService.getService(this.panel.context,e.appDataEntityId);const t=i(this.panel.view.model,"field");if(!t)throw new E(this.panel.view,"未找到 field 表单模型");this.fieldForm=t,this.fieldService=await this.app.deService.getService(this.panel.context,t.appDataEntityId);const s=this.model.editor;if(s){const{appCodeListId:e}=s;if(e&&(this.codeList=this.app.codeList.getCodeList(e)),!this.codeList)throw new E(this.model,"未配置属性项代码表")}else ibiz.log.warn("拖拽素材区控制器的 editor 为空");await this.initButtonGroup(),this.view.evt.on("onSaveSuccess",(async()=>{await this.load()})),await super.onInit(),this.debounceTransformFieldItems=X(this.debounceTransformFieldItems,50),this.subscribeMessage()}async initButtonGroup(){var e;if(this.fieldForm){const t=this.fieldForm.deformPages;if(!Array.isArray(t)||!t[0])return void ibiz.log.warn("field 表单模型未配置表单分页");const s=t[0].deformDetails,i=null==s?void 0:s.find((e=>"filed_group"===e.codeName));if(!i)return void ibiz.log.warn("field 表单模型未配置标识为 filed_group 表单分组");const n=await this.initActionStates(i);null==(e=this.codeList.codeItems)||e.forEach((e=>{e.codeName&&n&&this.buttonGroupMap.set(e.codeName,{model:i,state:n})}))}}async initActionStates(e){var t;const{uiactionGroup:s}=e;if(!(null==(t=null==s?void 0:s.uiactionGroupDetails)?void 0:t.length))return;const i=new p;return s.uiactionGroupDetails.forEach((e=>{const t=e.uiactionId;if(t){const s=new f(e.id,this.panel.context.srfappid,t);i.addState(e.id,s)}})),await i.update(),i}onDataUpdate(e){if(e.data&&"object"==typeof e.data){const t=e.data;if(t.srfkey){const e=this.items.findIndex((e=>e.srfkey===t.srfkey));-1!==e&&(this.items[e]=t,this.debounceTransformFieldItems())}}}onDataCreate(e){if(e.messageid===this.panel.context.srfsessionid&&e.data&&"object"==typeof e.data){const t=e.data;t.srfkey&&(this.items.push(t),this.transformFieldItems())}}onDataRemove(e){if(e.data&&"object"==typeof e.data){const t=e.data;if(t.srfkey){-1!==this.items.findIndex((e=>e.srfkey===t.srfkey))&&this.loadItems()}}}subscribeMessage(){this.onDataUpdate=this.onDataUpdate.bind(this),this.onDataCreate=this.onDataCreate.bind(this),this.onDataRemove=this.onDataRemove.bind(this),ibiz.mc.command.update.on(this.onDataUpdate),ibiz.mc.command.create.on(this.onDataCreate),ibiz.mc.command.remove.on(this.onDataRemove)}unsubscribeMessage(){ibiz.mc.command.update.off(this.onDataUpdate),ibiz.mc.command.remove.off(this.onDataRemove),ibiz.mc.command.create.off(this.onDataCreate)}destroy(){super.destroy(),this.unsubscribeMessage()}async load(){const e=await this.fieldService.exec("fetchcurde",this.panel.context,{n_psdeid_eq:this.view.state.data.psdeid});this.state.items=this.codeList.codeItems||[],e.ok&&Array.isArray(e.data)&&(this.fieldItems=e.data,await this.loadItems())}async loadItems(){const e=await this.service.fetchDefault(this.panel.context);e.ok&&Array.isArray(e.data)&&(this.items=e.data,this.transformFieldItems())}filterFieldItems(){const e=[],t=this.view.state.data,s=this.items.map((s=>{if("FORMITEM"===s.detailtype){if("EDITFORM"===t.formtype)return"|".concat(s.psdefid);if("SEARCHFORM"===t.formtype)return"|".concat(s.psdefsfitemid)}return"MDCTRL"===s.detailtype&&s.psdefid&&e.push(s.psdefid),""})).join("");return this.fieldItems.filter((t=>this.mdCtrlFieldType.includes(t.psdatatypeid)?!e.includes(t.srfkey):!(!t.srfkey||-1!==s.indexOf("|".concat(t.srfkey)))))}debounceTransformFieldItems(){this.transformFieldItems()}transformFieldItems(){const e=this.filterFieldItems();this.state.items.forEach((t=>{t.codeItems=e.map((e=>{let s=e.logicname||e.caption;return(e.psdefsfitemname||e.psdefieldname)&&(s+="[".concat(e.psdefsfitemname||e.psdefieldname,"]")),"EDITFORM"===this.view.state.data.formtype?{appId:t.appId,text:s,iconPath:t.iconPath,data:JSON.stringify({caption:e.logicname,logicname:e.logicname,psdefid:e.psdefieldid,psdefname:e.psdefieldname,detailtype:this.mdCtrlFieldType.includes(e.psdatatypeid)?"MDCTRL":"FORMITEM",formtype:this.view.state.data.formtype})}:{appId:t.appId,text:s,iconPath:t.iconPath,data:JSON.stringify({caption:e.logicname,logicname:e.logicname,psdefsfitemid:e.psdefsfitemid,psdefsfitemname:e.psdefsfitemname,psdefname:e.psdefname,psdefid:e.psdefid,detailtype:"FORMITEM",formtype:this.view.state.data.formtype})}}))})),this.codeItems=this.state.items,this.filter()}}var ys=Object.defineProperty,bs=(e,t,s)=>(((e,t,s)=>{t in e?ys(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s})(e,"symbol"!=typeof t?t+"":t,s),s);class ws{constructor(){bs(this,"component","IBizDndStencilPanelItem")}async createController(e,t,s){const i=new vs(e,t,s);return await i.init(),i}}var Is={install(e){c("FIELD_DND_PANEL_ITEM_STENCIL_FIELD",(()=>new ws))}};class Ds extends g{async execAction(e,t){const s=t.view.layoutPanel;if(s){const e=s.panelItems;if(e){const t=e.dnd_panel_item_stencil_field;t&&await t.load()}}return{}}}var Es={install(e){v("FRONT_RefreshField",(()=>new Ds))}};class Cs extends y{async exec(e,t,s,i){return"Create"===e&&s&&(Array.isArray(s)?await Promise.all(s.map((e=>this.calcDefault(t,e)))):await this.calcDefault(t,s)),super.exec(e,t,s,i)}async calcDefault(e,t){let s=1;const i=t.detailtype;let n=i;if("FORMITEM"===i&&(s=0,n=t.detailtype,t.psdefname&&(n=t.psdefname),"SEARCHFORM"===t.formtype&&(n=t.psdefsfitemname),A(n)&&(n=t.srfdecodename)),A(n))return;n=n.toLowerCase();const a=await this.fetchTempDefault(e);if(a.ok&&a.data){const e=a.data,i=new Map,r=new Map;for(e.forEach((e=>{O(e.psdeformdetailname)&&i.set(e.psdeformdetailname.toLowerCase(),e),O(e.psdeformdetailid)&&r.set(e.psdeformdetailid.toLowerCase(),e)}));;){const e=n+(0===s?"":s);if(!i.has(e)&&!r.has(e)){t.psdeformdetailname=e,t.psdeformdetailid=e;break}s+=1}}A(t.srfdecodename)&&A(t.logicname)&&("FORMPAGE"===i?t.logicname="表单分页":"GROUPPANEL"===i?t.logicname="分组面板":"TABPAGE"===i?t.logicname="分页":"BUTTON"===i?t.logicname="按钮":"USERCONTROL"===i?t.logicname="自定义部件":"RAWITEM"===i?t.logicname="直接内容":"DRUIPART"===i?t.logicname="关系界面":"FORMITEM"===i?t.logicname="表单项":"FORMITEMEX"===i?t.logicname="复合表单项":"FORMPART"===i?t.logicname="表单部件":"IFRAME"===i?t.logicname="嵌入页面(iframe)":"TABPANEL"===i?t.logicname="分页面板":"DATAGRID"===i&&(t.logicname="数据表格"))}newEntity(e){return e instanceof Ke?e.clone():new Ke(this.model,e)}}var Ps=Object.defineProperty,xs=(e,t,s)=>(((e,t,s)=>{t in e?Ps(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s})(e,"symbol"!=typeof t?t+"":t,s),s);class As extends y{constructor(e,t){super(e,t),xs(this,"typeCodeItems");const s=ibiz.hub.getApp(t.appId);this.typeCodeItems=s.codeList.getCodeList("Config__FDLogicType").codeItems}newEntity(e){return e instanceof Xe?e.clone():new Xe(this.model,e,this.typeCodeItems)}}e("default",{install(e){b.register("formdesign.psdeformdetail",(async(e,t)=>new Cs(e,t))),b.register("formdesign.psdefdlogic",(async(e,t)=>new As(e,t))),e.use(Es),e.use(D),e.use(we),e.use(Ee),e.use(ht),e.use(ps),e.use(Is),w("VIEW_CUSTOM_DndDesign",(()=>new me)),I("EDITOR_CUSTOMSTYLE_EditorParamCustom",(()=>new ve))}})}}}));
