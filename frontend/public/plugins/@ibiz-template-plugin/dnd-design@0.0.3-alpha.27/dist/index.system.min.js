System.register(["@ibiz-template/runtime","@ibiz-template-plugin/design-base","@ibiz-template/core","qx-util","vue","@ibiz-template/vue3-util","lodash-es","vuedraggable","dayjs"],(function(e,t){"use strict";var i,s,n,a,r,o,l,c,d,h,u,m,p,f,g,v,y,b,w,I,D,E,P,C,x,A,O,M,S,k,R,T,L,N,_,F,B,z,j,U,V,G,H,Y,q,K,X,W,J,Z;return{setters:[function(e){i=e.ViewEngineBase,s=e.getControl,n=e.SysUIActionTag,a=e.ViewController,r=e.getPFPlugin,o=e.EditorController,l=e.PluginStaticResource,c=e.PanelItemController,d=e.registerPanelItemProvider,h=e.PanelItemState,u=e.UIActionUtil,m=e.AppDataEntity,p=e.QXEventEx,f=e.ButtonContainerState,g=e.UIActionButtonState,v=e.UIActionProviderBase,y=e.registerUIActionProvider,b=e.DEService,w=e.DEServiceUtil,I=e.registerViewProvider,D=e.registerEditorProvider},function(e){E=e.default},function(e){P=e.RuntimeModelError},function(e){C=e.QXEvent,x=e.createUUID,A=e.ascSort,O=e.isNilOrEmpty,M=e.notNilEmpty},function(e){S=e.defineComponent,k=e.computed,R=e.createVNode,T=e.resolveComponent,L=e.ref,N=e.watch,_=e.createTextVNode,F=e.reactive,B=e.provide,z=e.h,j=e.isVNode,U=e.onMounted,V=e.onUnmounted,G=e.nextTick,H=e.inject},function(e){Y=e.useNamespace,q=e.getInputProps,K=e.getEditorEmits},function(e){X=e.debounce,W=e.clone},function(e){J=e.default},function(e){Z=e.default}],execute:function(){var $=Object.defineProperty,Q=(e,t,i)=>(((e,t,i)=>{t in e?$(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);const ee=new class{constructor(){Q(this,"dndProviderMap",new Map)}registerItemProvider(e,t){this.dndProviderMap.set(e.toUpperCase(),t)}getItemProvider(e){const t=e.toUpperCase();if(this.dndProviderMap.has(t))return this.dndProviderMap.get(t);throw new Error("未找到".concat(t,"对应的拖拽组件绘制"))}};var te=Object.defineProperty,ie=(e,t,i)=>(((e,t,i)=>{t in e?te(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class se{constructor(){ie(this,"_data",null),ie(this,"evt",new C)}get data(){return this._data}set(e){this._data=e,this.evt.emit("change",this._data)}get(){return this.data}reset(){this._data=null,this.evt.emit("change",null)}on(e){return this.evt.on("change",e)}off(e){this.evt.off("change",e)}}var ne=Object.defineProperty,ae=(e,t,i)=>(((e,t,i)=>{t in e?ne(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);const re=new class{constructor(){ae(this,"gridLayoutMode",["lg","md","sm","xs"])}getGridLayoutModeValue(e,t="",i=""){for(let s=0;s<this.gridLayoutMode.length;s++){const n=this.gridLayoutMode[s],a="".concat(t).concat(n).concat(i);if(null!=e[a])return e[a]}return""}getGridCol(e,t){let i=this.getGridLayoutModeValue(e,"col_");if(t&&!i&&(i=this.getGridLayoutModeValue(e,"child_col_")),(!i||i<="0"||i>"24")&&(i="24"),i){const e=parseInt(i,10);if("TABLE_12COL"===(null==t?void 0:t.layoutmode)&&e>0&&e<=12)return 2*e;if(e>0&&e<=24)return e}return null}getGridOffset(e,t){let i=this.getGridLayoutModeValue(e,"col_","_os");if(t&&!i&&(i=this.getGridLayoutModeValue(e,"child_col_","_os")),i){const e=parseInt(i,10);if("TABLE_12COL"===(null==t?void 0:t.layoutmode)&&e>0&&e<=12)return 2*e;if(e>0&&e<=24)return e}return null}calcColClass(e,t){const i={};if(t&&"FLEX"===t.layoutmode)return i;const s=this.getGridCol(e,t);s&&(i["el-col-".concat(s)]=!0);const n=this.getGridOffset(e,t);return n&&(i["el-col-offset-".concat(n)]=!0),i}getFlexLayoutStyle(e){return"FLEX"===e.layoutmode?{display:"flex","flex-direction":e.flexdir,"justify-content":e.flexalign,"align-items":e.flexvalign,"flex-grow":e.flexgrow,"flex-shrink":e.flexshrink,"flex-basis":"".concat(e.flexbasis,"px"),padding:"".concat(e.padding,"px")}:{padding:"".concat(e.padding,"px")}}getDraggableContainerClass(e,t){const i="FLEX"===e.layoutmode;return{[t.b("grid-layout")]:!i,[t.b("flex-layout")]:i,[t.b("flex-row")]:i&&e.flexdir&&-1===e.flexdir.indexOf("column"),[t.b("flex-column")]:i&&e.flexdir&&-1!==e.flexdir.indexOf("column")}}calcStyle(e,t){const i={};if(!e)return i;if(e){"FULL"===e.heightmode?i.height="auto":e.height?i.height=e.height+("PERCENTAGE"===e.heightmode?"%":"px"):t&&"PSSysViewPanel"===t.itemtype?"CONTAINER"!==t.itemtype&&"CTRLPOS"!==t.itemtype||(i["flex-grow"]=1):i.height="auto","FULL"===e.widthmode?i.width="auto":e.width&&(i.width=e.width+("PERCENTAGE"===e.widthmode?"%":"px"));const s="FLEX"===(null==t?void 0:t.layoutmode);s?(null!=e.flexgrow&&(i["flex-grow"]=e.flexgrow),null!=e.flexshrink&&(i["flex-shrink"]=e.flexshrink),null!=e.flexbasis&&(i["flex-basis"]="".concat(e.flexbasis,"px")),!t||t.flexdir&&-1===t.flexdir.indexOf("row")?Object.assign(i,this.getHorizontalAlign(e,t,s)):Object.assign(i,this.getVerticalAlign(e,t,s))):Object.assign(i,this.getHorizontalAlign(e,t,s)),Object.assign(i,this.getSwapMode(e)),Object.assign(i,this.getBorderStyle(e))}return i}getSwapMode(e){const t={};return e.swapmode&&("FLEX"===e.layoutmode?"NOWRAP"===e.swapmode?t["flex-wrap"]="nowrap":t["flex-wrap"]="wrap":"NOWRAP"===e.swapmode?t["white-space"]="nowrap":t["white-space"]="pre-wrap"),t}getBorderStyle(e){const t={};return e.spacingleft&&(-1!==e.spacingleft.indexOf("OUTER")?t["margin-left"]=this.getSpacingStyle(e.spacingleft.replace("OUTER","")):t["padding-left"]=this.getSpacingStyle(e.spacingleft.replace("INNER",""))),e.spacingright&&(-1!==e.spacingright.indexOf("OUTER")?t["margin-right"]=this.getSpacingStyle(e.spacingright.replace("OUTER","")):t["padding-right"]=this.getSpacingStyle(e.spacingright.replace("INNER",""))),e.spacingtop&&(-1!==e.spacingtop.indexOf("OUTER")?t["margin-top"]=this.getSpacingStyle(e.spacingtop.replace("OUTER","")):t["padding-top"]=this.getSpacingStyle(e.spacingtop.replace("INNER",""))),e.spacingbottom&&(-1!==e.spacingbottom.indexOf("OUTER")?t["margin-bottom"]=this.getSpacingStyle(e.spacingbottom.replace("OUTER","")):t["padding-bottom"]=this.getSpacingStyle(e.spacingbottom.replace("INNER",""))),t}getSpacingStyle(e){let t="0px";switch(e){case"NONE":default:t="0px";break;case"SMALL":t="8px";break;case"MEDIUM":t="16px";break;case"LARGE":t="24px"}return t}getHorizontalAlign(e,t,i=!1){const s={};switch(e.halignself||(null==t?void 0:t.height)){case"LEFT":i?s["align-self"]="flex-start":s.float="left";break;case"RIGHT":i?s["align-self"]="flex-end":s.float="right";break;case"CENTER":i?s["align-self"]="center":(s.margin="auto",s.float="none",s.display="table")}return s}getVerticalAlign(e,t,i=!1){const s={};switch(e.valignself||(null==t?void 0:t.valign)){case"TOP":i&&(s["align-self"]="flex-start");break;case"BOTTOM":i&&(s["align-self"]="flex-end");break;case"MIDDLE":i&&(s["align-self"]="center")}return s}};const oe=new class{isEnableUpdate(e){return!e||32768==(32768&e)}isEnableRemove(e){return!e||65536==(65536&e)}isEnableDrag(e){return!e||131072==(131072&e)}isEnableDrop(e){return!e||262144==(262144&e)}isEnablePlaceholder(e){return!!e&&524288==(524288&e)}};var le=Object.defineProperty,ce=(e,t,i)=>(((e,t,i)=>{t in e?le(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class de extends i{constructor(){super(...arguments),ce(this,"form"),ce(this,"navPos"),ce(this,"service")}async onCreated(){await super.onCreated();{const e=s(this.view.model,"form");if(!e)throw new P(this.view,"未找到主数据表单模型");this.form=e;const t=ibiz.hub.getApp(this.view.model.appId);this.service=await t.deService.getService(this.view.context,this.form.appDataEntityId)}this.onSelect=this.onSelect.bind(this),this.view.select.on(this.onSelect),this.view.modal.hooks.shouldDismiss.tapPromise((async e=>{if(!0===ibiz.uiDomainManager.get(this.view.context.srfsessionid).dataModification&&null==e.allowClose){const t=await ibiz.confirm.error({title:"关闭提醒",desc:"数据已经修改，确定要关闭？"});e.allowClose=!!t}})),await this.load()}onSelect(e){this.onActive(e)}async onMounted(){var e;await super.onMounted(),null==(e=this.toolbar)||e.calcButtonState(this.view.state.data,this.form.appDataEntityId),this.navPos=this.view.layoutPanel.panelItems.nav_pos,this.activeRoot(),this.view.evt.emit("onViewInfoChange",{dataInfo:this.view.state.data.srfmajortext||""})}async onDestroyed(){await super.onDestroyed(),this.view.select.off(this.onSelect)}activeRoot(){this.view.select.set(this.view.state.data)}async load(){try{this.view.startLoading();const e=await this.service.get(this.view.context,this.view.params);return this.service.local.add(this.view.context,e.data),this.view.state.data=e.data,e.data}finally{this.view.endLoading()}}async save(){var e;try{this.view.startLoading();const t=this.service.local.get(this.view.context,this.view.state.data.srfkey);for(const e in t)if(Object.prototype.hasOwnProperty.call(t,e)){"object"==typeof t[e]&&(t[e]=void 0)}const i=await this.service.update(this.view.context,t);return this.service.local.add(this.view.context,i.data),this.view.state.data=i.data,await this.view.evt.emit("onSaveSuccess",void 0),this.activeRoot(),this.view.evt.emit("onViewInfoChange",{dataInfo:this.view.state.data.srfmajortext||""}),null==(e=this.toolbar)||e.calcButtonState(this.view.state.data,this.form.appDataEntityId),i.data}finally{this.view.endLoading()}}async call(e,t){if(e===n.SAVE)return this.save();if("onActive"===e&&t)this.onActive(t);else{if("onActiveRoot"!==e)return super.call(e,t);this.activeRoot()}}onActive(e){var t;const i=this.view.model.appViewRefs;if(i){const s=e.srftype?e.srftype.toUpperCase():null,n=i.find((t=>t.name==="EDITDATA:".concat(e.srfdecodename.toUpperCase()).concat(s?":".concat(s):"")));if(!n)throw new P(this.view.model,"未匹配到对应[".concat(e.srftype,"]的属性编辑视图"));{const i=this.view.context.clone();i[e.srfdecodename.toLowerCase()]=e.srfkey;const s=null==(t=this.view.layoutPanel)?void 0:t.panelItems.dnd_design_panel_item,a=s?s.getModelState(e):0;oe.isEnableUpdate(a)||(i.srfreadonly=!0),this.navPos.openView({key:e.srfkey,viewId:n.refAppViewId,context:i})}}}}var he=Object.defineProperty,ue=(e,t,i)=>(((e,t,i)=>{t in e?he(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);const me=class e{constructor(){ue(this,"preViewProviderMap",new Map)}static getInstance(){return e.DndPreViewFactory||(e.DndPreViewFactory=new e),this.DndPreViewFactory}registerProvider(e,t){this.preViewProviderMap.set(e,t)}getProvider(e){return this.preViewProviderMap.get(e)}};ue(me,"DndPreViewFactory");let pe=me;var fe=Object.defineProperty,ge=(e,t,i)=>(((e,t,i)=>{t in e?fe(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class ve extends a{constructor(){super(...arguments),ge(this,"select",new se),ge(this,"preViewProvider")}getPreViewProvider(){return this.preViewProvider}async onCreated(){await super.onCreated();const{sysPFPluginId:e,appId:t}=this.model,i=r(e,t);if(i&&i.pluginParams){const e=i.pluginParams;Object.keys(e).forEach((t=>{e[t]&&"appId"!==t&&(this.context[t.toLowerCase()]=e[t])}))}const s=this.context.srfrunmode?this.context.srfrunmode:"RUNTIME";this.preViewProvider=pe.getInstance().getProvider(s),await this.preViewProvider.init(this)}initEngines(){this.engines.push(new de(this))}}var ye=Object.defineProperty,be=(e,t,i)=>(((e,t,i)=>{t in e?ye(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class we{constructor(){be(this,"component","IBizView")}createController(e,t,i,s){return new ve(e,t,i,s)}}class Ie extends o{}var De=Object.defineProperty,Ee=(e,t,i)=>(((e,t,i)=>{t in e?De(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class Pe{constructor(){Ee(this,"formEditor","IBizEditorParmas"),Ee(this,"gridEditor","IBizEditorParmas")}async createController(e,t){const i=new Ie(e,t);return await i.init(),i}}var Ce=S({name:"IBizDraggableItem",props:{isSelect:{type:Boolean,default:!1},item:{type:Object,required:!0},actions:{type:Array,required:!1},modelState:{type:Number,required:!0},isShowMask:{type:Boolean}},setup:(e,{emit:t})=>({ns:Y("dnd-design-draggable-item"),layoutStyle:k((()=>({width:e.item.width?"".concat(e.item.width,"px"):"",height:e.item.height?"".concat(e.item.height,"px"):""}))),onClick:(e,i)=>{e.stopPropagation(),t("action",i)}}),render(){var e,t;return R("div",{class:[this.ns.b(),this.ns.is("select",this.isSelect)],style:this.layoutStyle},[oe.isEnableDrag(this.modelState)&&R("div",{class:[this.ns.e("handle"),"handle"]},[R("svg",{viewBox:"64 64 896 896","data-icon":"drag",width:"1em",height:"1em",fill:"currentColor","aria-hidden":"true",focusable:"false",class:""},[R("path",{d:"M909.3 506.3L781.7 405.6a7.23 7.23 0 0 0-11.7 5.7V476H548V254h64.8c6 0 9.4-7 5.7-11.7L517.7 114.7a7.14 7.14 0 0 0-11.3 0L405.6 242.3a7.23 7.23 0 0 0 5.7 11.7H476v222H254v-64.8c0-6-7-9.4-11.7-5.7L114.7 506.3a7.14 7.14 0 0 0 0 11.3l127.5 100.8c4.7 3.7 11.7.4 11.7-5.7V548h222v222h-64.8c-6 0-9.4 7-5.7 11.7l100.8 127.5c2.9 3.7 8.5 3.7 11.3 0l100.8-127.5c3.7-4.7.4-11.7-5.7-11.7H548V548h222v64.8c0 6 7 9.4 11.7 5.7l127.5-100.8a7.3 7.3 0 0 0 .1-11.4z"},null)])]),this.actions?R("ul",{class:this.ns.b("actions")},[this.actions.map((e=>{if("delete"!==e.command||oe.isEnableRemove(this.modelState))return R("li",{class:this.ns.be("actions","item"),title:e.tooltip,onClick:t=>this.onClick(t,e)},[e.icon])}))]):null,R("div",{class:[this.ns.b("content"),this.isShowMask?this.ns.bm("content","mask"):""]},[this.isShowMask&&R("div",{class:this.ns.be("content","mask")},null),null==(t=(e=this.$slots).default)?void 0:t.call(e)])])}}),xe=S({name:"IBizDraggableTabs",props:{value:{type:String},items:{type:Array,required:!0,default:()=>[]},dragSwitchPage:{type:Boolean,default:!0},select:{type:Object},dndDesignController:{type:Object,required:!0}},emits:["change","drag-change","remove","add"],setup(e,{emit:t}){const i=Y("dnd-design-draggable-tabs"),s=Y("light-theme-shell"),n=x(),a=i=>{i.srfkey===e.value&&e.select&&e.select.srfkey===e.value||t("change",i)},r=new Map;return{ns:i,shellNS:s,uuid:n,onDragChange:e=>{t("drag-change",e)},onItemClick:a,onConfirm:e=>{t("remove",e)},onAddButtonClick:e=>{e.stopPropagation(),t("add")},onDragenter:(t,i)=>{if(e.dragSwitchPage&&i.srfkey){const e=r.get(i.srfkey)||[],t=window.setTimeout((()=>{a(i),e.pop()}),500);e.push(t),r.set(i.srfkey,e)}},onDragLeave:(t,i)=>{if(e.dragSwitchPage&&i.srfkey){const e=r.get(i.srfkey);if(e){const t=e.pop();t&&clearTimeout(t)}}}}},render(){return R("div",{class:this.ns.b()},[R("div",{class:this.ns.b("header")},[R(T("iBizDraggable"),{class:this.ns.b("nav"),list:this.items,group:{name:this.uuid,pull:!1},filter:".".concat(this.ns.bm("item","forbid")),itemKey:"srfkey",onChange:this.onDragChange},{item:e=>{const{element:t,index:i}=e,s=this.value?this.value===t.srfkey:0===i,n=this.dndDesignController.getModelState(t);return R("div",{class:[this.ns.b("item"),this.ns.is("active",s),!oe.isEnableDrag(n)&&this.ns.bm("item","forbid")],onClick:e=>{e.stopPropagation(),this.onItemClick(t)},onDragenter:e=>this.onDragenter(e,t),onDragleave:e=>this.onDragLeave(e,t)},[R("div",{class:this.ns.be("item","text")},[t.srftext||""]),oe.isEnableRemove(n)&&R("div",{class:this.ns.be("item","remove-button")},[R(T("el-popconfirm"),{title:"确认删除表单分页?子数据将一并删除!","confirm-button-text":"确认","cancel-button-text":"取消",width:"auto",placement:"left","popper-class":[this.ns.be("item","pop-confirm"),this.shellNS.m("popper")],icon:R("ion-icon",{name:"alert-circle"},null),"icon-color":"#faad14",onConfirm:()=>this.onConfirm(t)},{reference:()=>R("ion-icon",{name:"close-outline",onClick:e=>{e.stopPropagation()}},null)})])])},footer:()=>R("div",{class:this.ns.b("item-add-button"),onClick:e=>this.onAddButtonClick(e),title:"新建分页"},[R("ion-icon",{name:"add-outline",class:this.ns.be("item-add-button","icon")},null)])})]),R("div",{class:this.ns.b("content")},[this.items.map(((e,t)=>{var i,s;const n=this.value?e.srfkey!==this.value:0!==t,a=this.dndDesignController.isShowMask(e);return R("div",{class:[this.ns.b("item-content"),this.ns.is("hidden",n),this.ns.is("select",this.select&&e.srfkey===this.select.srfkey),a?this.ns.bm("item-content","mask"):""],onClick:t=>{t.stopPropagation(),this.onItemClick(e)}},[a&&R("div",{class:this.ns.be("item-content","mask")},null),null==(s=(i=this.$slots).default)?void 0:s.call(i,e)])}))])])}}),Ae={install(e){e.component(Ce.name,Ce),e.component(xe.name,xe)}};const Oe=new l(t.meta.url);var Me=S({name:"IBizEditorParmas",props:q(),emits:K(),setup(e,{emit:t}){var i;const s=e.controller,n=Y("editor-params-custom"),a=L(!1);let r=null==(i=e.data)?void 0:i.editortype;const o=L(e.value),l=L({}),c={param:"",srfnavparam:"SRFNAVPARAM.",srfnavctx:"SRFNAVCTX."},d=L([]),h=L([]),u=e=>{if(!e)return;const t=e.split("\n"),i=[];t.forEach((e=>{if(!e)return;const t=e.indexOf("=");if(-1===t)return;const s=e.slice(0,t),n=e.slice(t+1);if(s)if(Object.prototype.hasOwnProperty.call(l.value,s))if(n)try{l.value[s]=JSON.parse(n)}catch(e){l.value[s]=n}else l.value[s]=void 0;else{let e=s,t="param";s.startsWith("SRFNAVPARAM.")?(e=s.slice(s.indexOf(".")+1),t="srfnavparam"):s.startsWith("SRFNAVCTX.")&&(e=s.slice(s.indexOf(".")+1),t="srfnavctx");const a={id:x(),key:e,value:n,type:t};i.push(a)}})),h.value=i},m=()=>{const e=[];h.value.forEach((t=>{t.key&&e.push("".concat(c[t.type]).concat(t.key,"=").concat(t.value))}));const i=[].join("\n"),s=e.join("\n");i?(o.value="".concat(i).concat(s?"\n".concat(s):""),t("change",o.value||null)):(o.value=s,t("change",o.value||null))};o.value&&u(o.value),N((()=>e.value),((e,t)=>{o.value&&u(o.value)})),N((()=>e.data),((t,i)=>{const s=null==t?void 0:t.editortype,n=e.value?e.value.toString():"";n?n===o.value&&s===r||u(n):h.value=[],r=s,o.value=n,m()}),{immediate:!0});return{ns:n,c:s,isCustom:a,changeIscustom:()=>{a.value=!a.value},dynamicItems:h,formItems:d,addDynamicParam:e=>{h.value.push({id:x(),key:"",value:"",type:e}),m()},editorParams:o,typeMap:c,formData:l,onEditorTypeChange:e=>{e?e!==r&&(d.value=[],l.value={}):(d.value=[],l.value={})},transformEditorParams:u,editorType:r,onCustomParamChange:e=>{X((()=>{t("change",e)}),0)()},onDynamicParamChange:(e,t,i)=>{t[i]=e;X((()=>{m()}),0)()},deleteDynamicParam:e=>{h.value.splice(e,1),m()}}},render(){return R("div",{class:this.ns.b()},[this.isCustom?R(T("el-input"),{class:[this.ns.e("param-textarea"),this.ns.is("readonly",this.readonly)],type:"textarea",rows:6,modelValue:this.editorParams,"onUpdate:modelValue":e=>this.editorParams=e,readonly:this.readonly,disabled:this.readonly,onInput:e=>this.onCustomParamChange(e)},null):R("div",{class:this.ns.e("param-container")},[R("div",{class:this.ns.e("param-list-from")},null),R("div",{class:this.ns.e("param-list-dynamic")},[this.dynamicItems.map(((e,t)=>R("div",{class:this.ns.e("param-item-dynamic"),key:e.id},[R("ion-icon",{src:Oe.dir("./assets/svg/".concat(e.type,".svg")),class:this.ns.em("param-item-dynamic","icon")},null),this.readonly?[R("div",{class:[this.ns.em("param-item-dynamic","key"),this.ns.is("readonly",this.readonly)]},[e.key]),R("div",{class:[this.ns.em("param-item-dynamic","value"),this.ns.is("readonly",this.readonly)]},[e.value])]:[R(T("el-input"),{class:this.ns.em("param-item-dynamic","key"),modelValue:e.key,"onUpdate:modelValue":t=>e.key=t,onChange:t=>this.onDynamicParamChange(t,e,"key")},null),R(T("el-input"),{class:this.ns.em("param-item-dynamic","value"),modelValue:e.value,"onUpdate:modelValue":t=>e.value=t,onChange:t=>this.onDynamicParamChange(t,e,"value")},null),R("ion-icon",{name:"close-outline",class:this.ns.em("param-item-dynamic","delete"),onClick:()=>this.deleteDynamicParam(t)},null)]])))])]),R("div",{class:this.ns.e("param-custom-button")},[R(T("el-button"),{size:"small",onClick:()=>this.changeIscustom()},{default:()=>["".concat(this.isCustom?"关闭":"开启","自定义")]}),this.readonly?null:R(T("el-dropdown"),{trigger:"click",size:"small",onCommand:this.addDynamicParam},{default:()=>R(T("el-button"),{size:"small"},{default:()=>[R("ion-icon",{name:"add-outline"},null)]}),dropdown:()=>R(T("el-dropdown-menu"),null,{default:()=>[R(T("el-dropdown-item"),{command:"param"},{default:()=>[_("参数")]}),R(T("el-dropdown-item"),{command:"srfnavparam"},{default:()=>[_("视图参数")]}),R(T("el-dropdown-item"),{command:"srfnavctx"},{default:()=>[_("视图上下文")]})]})})])])}}),Se={install(e){e.component(Me.name,Me)}},ke=Object.defineProperty,Re=(e,t,i)=>(((e,t,i)=>{t in e?ke(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class Te extends c{constructor(){super(...arguments),Re(this,"service"),Re(this,"form"),Re(this,"providers",{}),Re(this,"controllers",{}),Re(this,"items",[]),Re(this,"timer",null),Re(this,"isDisableMessage",!1),Re(this,"showMaskType",["MDCTRL","GROUPPANEL","TABPANEL","TABPAGE","FORMPAGE"])}get view(){return this.panel.view}async onInit(){await super.onInit();const e=s(this.panel.view.model,"item");if(!e)throw new P(this.panel.view,"未找到 item 表单模型");this.form=e;const t=await ibiz.hub.getApp(this.model.appId);this.service=await t.deService.getService(this.panel.context,e.appDataEntityId),this.view.evt.on("onSaveSuccess",(async()=>{await this.load(),this.state.uuid=x()})),await this.load(),this.subscribeMessage()}updateHiddenFormItemVisible(e){this.state.hiddenFormItemVisible=e}onDataUpdate(e){if(!this.isDisableMessage&&e.data&&"object"==typeof e.data){const t=e.data;if(t.srfkey){const e=this.items.findIndex((e=>e.srfkey===t.srfkey));-1!==e&&(this.removeController(this.items[e]),this.items.splice(e,1,t),this.initItem(t),this.timer&&window.clearTimeout(this.timer),this.timer=window.setTimeout((()=>{this.recalculateDeppItems()}),50))}}}sendMessage(e,t,i){this.isDisableMessage=!0,e.forEach((e=>{t?ibiz.mc.command.send(e,t):i&&ibiz.mc.command.next({...i,data:e})})),this.isDisableMessage=!1}subscribeMessage(){this.onDataUpdate=this.onDataUpdate.bind(this),ibiz.mc.command.update.on(this.onDataUpdate)}unsubscribeMessage(){ibiz.mc.command.update.off(this.onDataUpdate)}destroy(){super.destroy(),this.unsubscribeMessage()}async initItem(e){if("FORMPAGE"===e.srftype)return;const t="".concat(e.srfdecodename,"_").concat(e.srftype),i=ee.getItemProvider(t),s=i.createController(this,this.form,e);this.providers[e.srfkey]=i,this.controllers[e.srfkey]=s}async load(){const e=await this.service.fetchDefault(this.panel.context);this.items=e.data,this.items.forEach((e=>{this.initItem(e)})),this.state.items=this.calcDeepItems(this.items)}recalculateDeppItems(){this.state.items=this.calcDeepItems(this.items)}calcDeepItems(e,t){const i=[];return e.filter((e=>null==t?null==e.srfpkey:e.srfpkey===t.srfkey)).forEach((t=>{i.push(t);let s=this.calcDeepItems(e,t);s.length>0?(s=A(s,"srfordervalue"),t.children=F(s)):t.children=F([])})),i}change(e,t,i){if(e){const{added:s,moved:n}=e;if(s&&s.element){const n=s.element;if(!n.srfkey||Object.is(n.srfkey,""))t.splice(s.newIndex,1),this.add(e,t,i);else{n.srfpkey=i?i.srfkey:void 0;const{oldIndex:e,newIndex:a}=s;this.move(t,e,a)}}else if(n&&n.element){const{oldIndex:e,newIndex:i}=n;this.move(t,e,i)}}}async add(e,t,i){const s=e.added.newIndex,n=e.added.element,a=await this.service.getDraft(this.panel.context,n);if(a.ok){const{data:e}=a;n.caption&&"DESIGN"===this.panel.context.srfrunmode&&(n.caption=void 0),Object.assign(e,n),e.srfordervalue=10*(s+1),i&&(e.srfpkey=i.srfkey);const r=await this.service.create(this.panel.context,e);if(r.ok){const e=r.data;e.children=F([]),await this.initItem(e),this.items.push(e),this.sendMessage([e],void 0,{messageid:this.panel.context.srfsessionid,messagename:"command",type:"COMMAND",subtype:"OBJECTCREATED"}),t.splice(s,0,e),this.view.select.set(r.data),await this.move(t,s,t.length-1)}}}async move(e,t,i){const s=t>i?t:i,n=[];e.forEach(((e,t)=>{t>=0&&t<=s&&(e.srfordervalue=10*(t+1),n.push(e))}));const a=await this.service.update(this.panel.context,n);a.ok&&(Array.isArray(a.data)&&this.sendMessage(a.data,"OBJECTUPDATED"),ibiz.log.debug("排序成功"))}async remove(e,t){if((await this.service.remove(this.panel.context,{},t)).ok){const i=this.items.findIndex((e=>e.srfkey===t.srfkey)),s=e.findIndex((e=>e.srfkey===t.srfkey));if(i>-1){this.items.splice(i,1),e.splice(s,1),this.removeController(t),this.sendMessage([t],"OBJECTREMOVED");const n=e[0]||this.items.find((e=>e.srfkey===t.srfpkey));n?this.view.select.set(n):this.view.call("onActiveRoot"),this.recalculateDeppItems()}return!0}return!1}removeController(e){if("FORMPAGE"===e.srftype)return;this.controllers[e.srfkey].destroy(),delete this.controllers[e.srfkey]}getModelState(e){let t=0,i=e;for(;i;){if(i.modelstate){t=i.modelstate;break}let e=!1;const s=i.srfpkey;if(s){const t=this.controllers[s];if(t)i=t.data,e=!0;else{const t=this.items.find((e=>e.srfkey===s));t&&(i=t,e=!0)}}if(!e)break}return t}isShowMask(e){if(!e)return!1;const t=e.modelstate,i=oe.isEnablePlaceholder(t)&&this.showMaskType.includes(e.srftype);if(!i)return i;let s=e,n=!1;for(;s;){let e=!1;const t=s.srfpkey;if(t){const i=this.controllers[t];if(i)s=i.data,n=oe.isEnablePlaceholder(s.modelstate)&&this.showMaskType.includes(s.srftype)||n,e=!0;else{const i=this.items.find((e=>e.srfkey===t));i&&(s=i,n=oe.isEnablePlaceholder(s.modelstate)&&this.showMaskType.includes(s.srftype)||n,e=!0)}}if(!e)break}return!n}}var Le=Object.defineProperty,Ne=(e,t,i)=>(((e,t,i)=>{t in e?Le(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class _e{constructor(){Ne(this,"component","IBizDndDesignPanelItem")}async createController(e,t,i){const s=new Te(e,t,i);return await s.init(),s}}var Fe=S({name:"IBizDndDesignPanelItem",props:{modelData:{type:Object,required:!0},controller:{type:Te,required:!0}},setup(e){const t=e.controller,i=L(),s=Y("dnd-design"),n=Y("light-theme-shell"),a=L("light");t.view.select.on((e=>{i.value=e}));const r=(e,n,a)=>{const o="dnd-design-".concat(n?n.srfkey:"root"),l=n?t.getModelState(n):0;return R(T("iBizDraggable"),{class:{[s.b("drag-container")]:!0,...n?re.getDraggableContainerClass(n,s):{}},style:n?re.getFlexLayoutStyle(n):{},itemKey:"srfkey",handle:".handle",key:o,group:{name:"dnd-design",put:oe.isEnableDrop(l)},"ghost-class":s.b("ghost"),list:e,onChange:i=>t.change(i,e,n)},{item:s=>{var o;let l;const c=s.element,d=t.providers[c.srfkey];if(!d)return null;const h=t.controllers[c.srfkey],u=T(d.component),m=t.getModelState(c);return"HIDDEN"!==c.editortype||t.state.hiddenFormItemVisible?R(T("iBizDraggableItem"),{class:n?re.calcColClass(c,n):{},style:n?re.calcStyle(c,n):{},controller:h,isSelect:(null==(o=i.value)?void 0:o.srfkey)===c.srfkey,key:c.srfkey,item:c,actions:h.actions,modelState:m,isShowMask:t.isShowMask(c),onClick:e=>((e,i)=>{e.stopPropagation(),t.view.select.set(i)})(e,c),onAction:i=>{h.onAction(i).then((s=>{!1===s&&"delete"===i.command&&t.remove(e,c)}))}},"function"==typeof(p=l=z(u,{controller:h,dndDesignController:t},a?a(e,c):c.children?()=>r(c.children,c):void 0))||"[object Object]"===Object.prototype.toString.call(p)&&!j(p)?l:{default:()=>[l]}):null;var p}})};return B("dndDesignRenderItems",r),{ns:s,shellNS:n,theme:a,renderItems:r,renderFormPage:()=>R(T("iBizDndDesignFormPage"),{key:t.state.uuid,items:t.state.items,dndDesignController:t,select:i.value,onChange:e=>t.change(e,t.state.items),onRemove:e=>t.remove(t.state.items,e),onSelect:e=>{t.view.select.set(e)}},{default:e=>(e.children||(e.children=[]),r(e.children,e))}),onActiveRoot:e=>{e.stopPropagation(),t.view.call("onActiveRoot")}}},render(){return R("div",{class:[this.ns.b(),this.ns.m(this.theme),this.shellNS.b()],onClick:e=>{this.onActiveRoot(e)}},[R("div",{class:this.ns.b("container")},[this.renderFormPage()])])}}),Be={install(e){e.component("IBizDndDesignPanelItem",Fe),d("RAWITEM_DND_DESIGN_PANEL_ITEM",(()=>new _e))}},ze=Object.defineProperty,je=(e,t,i)=>(((e,t,i)=>{t in e?ze(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class Ue extends h{constructor(){super(...arguments),je(this,"items",[]),je(this,"filterValue","")}}var Ve=Object.defineProperty,Ge=(e,t,i)=>(((e,t,i)=>{t in e?Ve(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class He extends c{constructor(){super(...arguments),Ge(this,"codeList"),Ge(this,"codeItems",[]),Ge(this,"enableGroup",!1),Ge(this,"buttonGroupMap",new Map)}createState(){var e;return new Ue(null==(e=this.parent)?void 0:e.state)}get view(){return this.panel.view}async onInit(){await super.onInit(),await this.load(),this.view.evt.on("onStencilSearch",(e=>{const t=e.eventArg||"";this.state.filterValue=t.trim().toLowerCase(),this.filter()}))}async load(){const e=this.model.editor;if(e){const{appCodeListId:t}=e;if(t){const e=await ibiz.hub.getApp(this.model.appId);this.codeList=e.codeList.getCodeList(t)}if(!this.codeList)throw new P(this.model,"未配置素材区代码表");this.codeItems=this.codeList.codeItems||[];const i=this.codeItems.findIndex((e=>!!(e.codeItems&&e.codeItems.length>1)));this.enableGroup=-1!==i,this.state.items=this.codeItems,this.filter()}else ibiz.log.warn("拖拽素材区控制器的 editor 为空")}filter(){this.state.filterValue?this.enableGroup?(this.state.items=[],this.codeItems.forEach((e=>{const t={...e};Array.isArray(t.codeItems)||(t.codeItems=[]),t.codeItems=t.codeItems.filter((e=>e.text&&e.text.toLowerCase().includes(this.state.filterValue))),this.state.items.push(t)}))):this.state.items=this.codeItems.filter((e=>e.text&&e.text.toLowerCase().includes(this.state.filterValue))):this.state.items=this.codeItems}async onActionClick(e,t){const i=e.uiactionId;await u.execAndResolved(i,{context:this.panel.context,params:this.panel.params,data:[],view:this.panel.view,event:t},e.appId)}}var Ye=Object.defineProperty,qe=(e,t,i)=>(((e,t,i)=>{t in e?Ye(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class Ke{constructor(){qe(this,"component","IBizDndStencilPanelItem")}async createController(e,t,i){const s=new He(e,t,i);return await s.init(),s}}var Xe=S({name:"IBizDndStencilPanelItem",props:{modelData:{type:Object,required:!0},controller:{type:He,required:!0}},setup(e){const t=Y("dnd-stencil"),i=e=>{const t=JSON.parse(e.data||"{}");return t.srftype=t.detailtype,t},s=e=>{const t=e.item;t&&t.style.setProperty("--svg-visibility","hidden")},n=e=>{const t=e.item;t&&t.style.setProperty("--svg-visibility","")},a=async(t,i)=>{await e.controller.onActionClick(t,i)};return{ns:t,renderGroup:(r,o,l,c)=>{const d=e.controller.buttonGroupMap.get(c),h=d&&d.model,u=d&&d.state,m=h&&h.uiactionGroup;return R(T("el-collapse-item"),{title:r,name:l.toString()},{title:()=>R("div",{class:t.b("group-header")},[R("div",{class:t.b("group-header-text")},[r]),m&&u?R(T("iBizActionToolbar"),{class:t.b("group-header-toolbar"),actionDetails:m.uiactionGroupDetails,actionsState:u,onActionClick:a,caption:m.name,mode:"ITEMS"===h.actionGroupExtractMode?"dropdown":"buttons"},null):null]),default:()=>0===o.length?R("div",{class:t.bm("drag-container","empty")},[_("暂无数据")]):R(T("iBizDraggable"),{itemKey:"dnd-stencil",sort:!1,group:{name:"dnd-design",pull:"clone",put:!1},class:t.b("drag-container"),list:o,clone:i,onStart:s,onEnd:n},{item:e=>{const i=e.element;return R("div",{key:e.index,class:[t.b("handle")],title:i.text},[R("svg",{class:t.be("handle","svg"),height:"100%",width:"100%",xmlns:"http://www.w3.org/2000/svg"},[R("rect",{height:"100%",width:"100%"},null)]),R("div",{class:[t.b("handle-content")]},[R("div",{class:[t.be("handle","icon")]},[i.iconPath?R("ion-icon",{src:Oe.dir(i.iconPath)},null):null]),R("div",{class:[t.be("handle","text")]},[i.text])])])}})})},clone:i,actives:["0","1","2","3","4","5","6","7","8","9"]}},render(){const e=[];return this.controller.enableGroup?this.controller.state.items.forEach(((t,i)=>{e.push(this.renderGroup(t.text,t.codeItems,i,t.codeName))})):e.push(this.renderGroup(this.controller.codeList.name,this.controller.state.items,0,this.controller.codeList.codeName)),R("div",{class:this.ns.b()},[R(T("el-collapse"),{modelValue:this.actives,"onUpdate:modelValue":e=>this.actives=e},(t=e,"function"==typeof t||"[object Object]"===Object.prototype.toString.call(t)&&!j(t)?e:{default:()=>[e]}))]);var t}}),We={install(e){e.component("IBizDndStencilPanelItem",Xe),d("FIELD_DND_PANEL_ITEM_STENCIL",(()=>new Ke))}},Je=Object.defineProperty,Ze=(e,t,i)=>(((e,t,i)=>{t in e?Je(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class $e extends h{constructor(){super(...arguments),Ze(this,"items",[])}}class Qe extends m{get srftext(){let e=this.caption;const t=this.psdefformitemname||this.psdefuimodename,i=this.psdeformdetailname||this.psdefname;if("FORMITEM"===this.detailtype){const s=this.logicname;return O(e)&&M(s)&&O(t)&&(e=s),M(e)?M(t)?"".concat(e,"(").concat(i,")[").concat(t,"]"):"".concat(e,"(").concat(i,")"):M(t)?"".concat(i,"(").concat(t,")"):i}return M(e)?"".concat(e,"(").concat(i,")"):i}get srftype(){return this.detailtype}set srftype(e){this.detailtype=e}get srfpkey(){return this.ppsdeformdetailid}set srfpkey(e){this.ppsdeformdetailid=e}get srfordervalue(){return this.ordervalue}set srfordervalue(e){this.ordervalue=e}clone(){const e=new Qe(this._entity,this._data);return e.srfkey=this.srfkey,e}}class et extends m{constructor(e,t,i){super(e,t),Object.defineProperty(this,"_typeCodeItems",{enumerable:!1,configurable:!0,value:i})}get srftext(){return"GROUP"===this.srftype?"".concat(this.groupop||""):"".concat(this.fdname||""," ").concat(this.psdbvalueopname||""," ").concat(this.condvalue||"")}get srftype(){return this.logictype}set srftype(e){this.logictype=e}get srficon(){const e=this._typeCodeItems.find((e=>e.value===this.srftype));return e?e.sysImage:void 0}get srfallowdrop(){return"GROUP"===this.srftype}clone(){const e=new et(this._entity,this._data,this._typeCodeItems);return e.srfkey=this.srfkey,e}}var tt=Object.defineProperty,it=(e,t,i)=>(((e,t,i)=>{t in e?tt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class st{constructor(e){it(this,"entity"),it(this,"parent",null),it(this,"children",[]),this.entity=e}get id(){return this.entity.srfkey||""}get text(){return this.entity.srftext||""}get type(){return this.entity.srftype||""}}var nt=Object.defineProperty,at=(e,t,i)=>(((e,t,i)=>{t in e?nt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class rt extends c{constructor(){super(...arguments),at(this,"codeList"),at(this,"service"),at(this,"form"),at(this,"evt",new p),at(this,"items",[]),at(this,"timer",null),at(this,"isDisableMessage",!1),at(this,"codeItemList",[])}get view(){return this.panel.view}createState(){var e;return new $e(null==(e=this.parent)?void 0:e.state)}async onInit(){await super.onInit();const e=s(this.panel.view.model,"item");if(!e)throw new P(this.panel.view,"未找到 item 表单模型");this.form=e;const t=await ibiz.hub.getApp(this.model.appId);this.service=await t.deService.getService(this.panel.context,e.appDataEntityId);const i=this.model.editor;if(i){const{appCodeListId:e}=i;if(e&&(this.codeList=t.codeList.getCodeList(e)),!this.codeList)throw new P(this.model,"未配置结构区代码表");const s=this.codeList.codeItems||[],n=[];s.forEach((e=>{const t=e.value,i=e.codeItems;if(t&&Array.isArray(i)){const e=new Map;i.forEach((t=>{const i=t.value;i&&e.set(i,t)})),n.push({key:t,map:e})}})),this.codeItemList=n}this.view.evt.on("onSaveSuccess",(async()=>{await this.load()})),await this.load(),this.subscribeMessage()}getNodeIcon(e){const t=e.entity;for(let e=0;e<this.codeItemList.length;e++){const i=this.codeItemList[e],{key:s,map:n}=i,a=t[s];if(a&&n.get(a))return n.get(a).iconPath}}onDataUpdate(e){if(!this.isDisableMessage&&e.data&&"object"==typeof e.data){const t=e.data;if(t.srfkey){const e=this.items.findIndex((e=>e.srfkey===t.srfkey));-1!==e&&(this.items.splice(e,1),this.items.push(t),this.timer&&window.clearTimeout(this.timer),this.timer=window.setTimeout((()=>{this.items=A(this.items,"srfordervalue"),this.state.items=this.transformItemsToTree(this.items),this.evt.emit("updateSelect")}),50))}}}onDataCreate(e){if(!this.isDisableMessage&&e.messageid===this.panel.context.srfsessionid&&e.data&&"object"==typeof e.data){const t=e.data;t.srfkey&&(this.items.push(t),this.items=A(this.items,"srfordervalue"),this.state.items=this.transformItemsToTree(this.items),this.evt.emit("updateSelect"))}}onDataRemove(e){if(!this.isDisableMessage&&e.data&&"object"==typeof e.data){const t=e.data;if(t.srfkey){const e=this.items.findIndex((e=>e.srfkey===t.srfkey));-1!==e&&(this.items.splice(e,1),this.items=A(this.items,"srfordervalue"),this.state.items=this.transformItemsToTree(this.items),this.evt.emit("updateSelect"))}}}sendMessage(e,t,i){this.isDisableMessage=!0,e.forEach((e=>{t?ibiz.mc.command.send(e,t):i&&ibiz.mc.command.next({...i,data:e})})),this.isDisableMessage=!1}subscribeMessage(){this.onDataUpdate=this.onDataUpdate.bind(this),this.onDataCreate=this.onDataCreate.bind(this),this.onDataRemove=this.onDataRemove.bind(this),ibiz.mc.command.update.on(this.onDataUpdate),ibiz.mc.command.create.on(this.onDataCreate),ibiz.mc.command.remove.on(this.onDataRemove)}unsubscribeMessage(){ibiz.mc.command.update.off(this.onDataUpdate),ibiz.mc.command.create.off(this.onDataCreate),ibiz.mc.command.remove.off(this.onDataRemove)}destroy(){super.destroy(),this.unsubscribeMessage()}async load(){const e=await this.service.fetchDefault(this.panel.context);if(e.ok&&Array.isArray(e.data)){const t=A(e.data,"srfordervalue");this.items=t,this.state.items=this.transformItemsToTree(t)}else this.state.items=[]}transformItemsToTree(e){const t={},i=[];return e.forEach((e=>{const i=e.srfkey;i&&(t[i]=new st(e))})),e.forEach((e=>{const s=t[e.srfkey];if(s)if(e.srfpkey){const i=e.srfpkey?t[e.srfpkey]:null;i&&(s.parent=i,i.children.push(s))}else s.parent=null,i.push(s)})),i}change(e,t,i){i?(e.parent=i,e.entity.srfpkey=i.entity.srfkey):(e.parent=null,e.entity.srfpkey=void 0),this.move(t.map((e=>e.entity)),0,t.length-1)}async move(e,t,i){const s=t>i?i:t,n=t>i?t:i,a=[];e.forEach(((e,t)=>{t>=s&&t<=n&&(e.srfordervalue=10*(t+1),a.push(e))}));const r=await this.service.update(this.panel.context,a);r.ok&&(Array.isArray(r.data)&&this.sendMessage(r.data,"OBJECTUPDATED"),ibiz.log.debug("排序成功"))}}var ot=S({name:"IBizDndStructurePanelItem",props:{modelData:{type:Object,required:!0},controller:{type:rt,required:!0}},setup(e){const t=Y("dnd-structure"),i=L(null),s=L("");N(s,(()=>{i.value&&i.value.filter(s.value)}));const n=e=>{if(i.value){if(e){if(i.value.getNode(e.srfkey))return void i.value.setCurrentKey(e.srfkey)}i.value.setCurrentKey()}};e.controller.view.select.on((e=>{n(e)})),U((()=>{n(e.controller.view.select.data)}));const a=()=>{G((()=>{n(e.controller.view.select.data)}))};e.controller.evt.on("updateSelect",a);return V((()=>{e.controller.evt.off("updateSelect",a)})),{ns:t,tree:i,searchValue:s,filterNode:(e,t)=>{if(!e)return!0;const i=e.trim().toLowerCase();return t.text.includes(i)},onCurrentNodeChange:t=>{t&&e.controller.view.select.set(t.entity)},allowDrag:e=>{const t=e.data;if(0===e.level||"FORMPAGE"===t.type)return!1;if(!s.value)return!0;return!s.value.trim().toLowerCase()},allowDrop:(e,t,i)=>{const s=e.data,n=t.data;if("inner"===i){return!!["GROUPPANEL","FORMPAGE"].includes(n.type)}return 0!==t.level&&("FORMPAGE"!==n.type||"FORMPAGE"===s.type)},onNodeDrop:(t,i,s)=>{const n=t.data,a=i.data;if("inner"===s)return void e.controller.change(n,a.children,a);const r=a.parent;r?e.controller.change(n,r.children,r):e.controller.change(n,e.controller.state.items)}}},render(){return R("div",{class:this.ns.b()},[R("div",{class:this.ns.b("header")},[R(T("el-input"),{modelValue:this.searchValue,"onUpdate:modelValue":e=>this.searchValue=e,"prefix-icon":R("ion-icon",{name:"search-outline"},null),clearable:!0},null)]),R("div",{class:this.ns.b("content")},[R(T("el-tree"),{ref:"tree",data:this.controller.state.items,"node-key":"id",props:{label:"text",children:"children"},indent:8,draggable:!0,"default-expand-all":!0,"expand-on-click-node":!1,"highlight-current":!0,"filter-node-method":this.filterNode,onCurrentChange:this.onCurrentNodeChange,"allow-drag":this.allowDrag,"allow-drop":this.allowDrop,onNodeDrop:this.onNodeDrop},{default:({data:e})=>{const t=this.controller.getNodeIcon(e);return R("div",{class:this.ns.b("node")},[R("div",{class:this.ns.be("node","icon")},[t?R("ion-icon",{src:Oe.dir(t)},null):null]),R("div",{class:this.ns.be("node","text"),title:e.text},[e.text])])}})])])}}),lt=Object.defineProperty,ct=(e,t,i)=>(((e,t,i)=>{t in e?lt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class dt{constructor(){ct(this,"component","IBizDndStructurePanelItem")}async createController(e,t,i){const s=new rt(e,t,i);return await s.init(),s}}var ht={install(e){e.component("IBizDndStructurePanelItem",ot),d("FIELD_DND_PANEL_STRUCTURE",(()=>new dt))}};class ut extends c{get view(){return this.panel.view}sendMessage(e){this.view.evt.emit("onStencilSearch",{eventArg:e})}}var mt=S({name:"IBizDndStencilSearchInput",props:{modelData:{type:Object,required:!0},controller:{type:ut,required:!0}},setup(e){const t=Y("dnd-stencil-search-input"),i=L("");return N(i,(()=>{e.controller.sendMessage(i.value)})),{ns:t,searchValue:i}},render(){return R("div",{class:this.ns.b()},[R(T("el-input"),{modelValue:this.searchValue,"onUpdate:modelValue":e=>this.searchValue=e,placeholder:"输入关键词进行过滤","prefix-icon":R("ion-icon",{name:"search-outline"},null),clearable:!0},null)])}}),pt=Object.defineProperty,ft=(e,t,i)=>(((e,t,i)=>{t in e?pt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class gt{constructor(){ft(this,"component","IBizDndStencilSearchInput")}async createController(e,t,i){const s=new ut(e,t,i);return await s.init(),s}}var vt={install(e){e.component("IBizDndStencilSearchInput",mt),d("FIELD_DND_PANEL_ITEM_STENCIL_SEARCH",(()=>new gt))}},yt=S({name:"IBizHiddenFormItemSwitch",props:{modelData:{type:Object,required:!0},controller:{type:c,required:!0}},setup:e=>({ns:Y("hidden-form-item-switch"),isActive:L(!1),activeText:"显示",inactiveText:"隐藏",handleChange:t=>{var i;const s=e.controller.panel.view;if(!s)return;const n=null==(i=s.layoutPanel)?void 0:i.panelItems.dnd_design_panel_item;n&&n.updateHiddenFormItemVisible(t)}}),render(){return R("div",{class:this.ns.b()},[R(T("el-switch"),{modelValue:this.isActive,"onUpdate:modelValue":e=>this.isActive=e,"active-text":this.activeText,"inactive-text":this.inactiveText,"inline-prompt":!0,size:"large",title:"".concat(this.isActive?this.inactiveText:this.activeText,"隐藏表单项"),onChange:this.handleChange},null)])}}),bt=Object.defineProperty,wt=(e,t,i)=>(((e,t,i)=>{t in e?bt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class It{constructor(){wt(this,"component","IBizHiddenFormItemSwitch")}async createController(e,t,i){const s=new c(e,t,i);return await s.init(),s}}var Dt={install(e){e.component(yt.name,yt),d("FIELD_HIDDEN_FORM_ITEM_SWITCH",(()=>new It))}},Et={install(e){e.component("IBizDraggable",J),e.use(Be),e.use(We),e.use(ht),e.use(vt),e.use(Dt)}},Pt=Object.defineProperty,Ct=(e,t,i)=>(((e,t,i)=>{t in e?Pt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class xt{constructor(e,t,i){Ct(this,"actions",[{icon:R("ion-icon",{name:"trash-outline"},null),text:"删除",command:"delete"}]),this.c=e,this.data=i,this.model=t,this.select=e.view.select}async onAction(e){return!1}destroy(){}change(e,t,i){this.c.change(e,t,i)}async remove(e,t){return this.c.remove(e,t)}getItemCaption(){const e=this.c.view.getPreViewProvider();let t=W(this.data);return e&&this.data&&(t=e.getTargetDataBySourceData("FORMDETAIL",[t])[0]),t.caption}}var At=S({name:"IBizDndDesignFormItem",props:{controller:{type:xt,required:!0}},setup(e){const t=Y("dnd-design-form-item"),i=()=>{const t=e.controller.data,i="".concat(t.logicname||"","(").concat(t.srftext,")");return R(T("el-input"),{placeholder:i,disabled:!0},null)},s=()=>{const s=e.controller.data,n=(()=>{const t=e.controller.data;if(t&&t.rawcssstyle){const e=t.rawcssstyle.split("\n"),i=[];for(let t=0;t<e.length;t++)i.push(...e[t].split(";").filter((e=>e)));return i.filter((e=>2===e.split(":").length)).join(";")}})(),a="".concat(s.logicname||"","(").concat(s.srftext,")"),r=new Date;if(s)switch(s.editortype){case"HIDDEN":return R("div",{style:"padding-left: 10px;",class:"design-item-hidden"},[_("隐藏表单项")]);case"SPAN":return R("span",{style:"padding-left: 10px;".concat(n),class:"design-design-editor"},[a]);case"RADIOBUTTONLIST":return R(T("el-radio-group"),{"model-value":"",disabled:!0},{default:()=>[R(T("el-radio"),{label:"1"},{default:()=>[_("选项一")]}),R(T("el-radio"),{label:"2"},{default:()=>[_("选项二")]}),R(T("el-radio"),{label:"3"},{default:()=>[_("选项三")]})]});case"ADDRESSPICKUP":case"ADDRESSPICKUP_AC":return R(T("el-select"),{mode:"tags",style:"width: 100%",placeholder:a,disabled:!0},{default:()=>[R(T("el-option"),{value:"1"},{default:()=>[_("选项一")]}),R(T("el-option"),{value:"2"},{default:()=>[_("选项二")]}),R(T("el-option"),{value:"3"},{default:()=>[_("选项三")]})]});case"TEXTAREA":return R(T("el-input"),{placeholder:a,style:s.ctrlheight?"height: ".concat(s.ctrlheight,"px;"):"",class:t.e("textarea"),disabled:!0},null);case"TEXTAREA_10":return R(T("el-input"),{placeholder:a,rows:10,disabled:!0},null);case"PASSWORD":return R(T("el-input"),{placeholder:a,disabled:!0},null);case"DATEPICKEREX":case"DATEPICKEREX_SECOND":return R(T("el-date-picker"),{"model-value":Z(r).format("YYYY-MM-DD HH:mm:ss"),format:"YYYY-MM-DD HH:mm:ss",disabled:!0},null);case"DATEPICKEREX_MINUTE":return R(T("el-date-picker"),{"model-value":Z(r).format("YYYY-MM-DD HH:mm"),format:"YYYY-MM-DD HH:mm",disabled:!0},null);case"DATEPICKEREX_NODAY":return R(T("el-date-picker"),{"model-value":Z(r).format("HH:mm:ss"),format:"HH:mm:ss",disabled:!0},null);case"DATEPICKEREX_NODAY_NOSECOND":return R(T("el-date-picker"),{"model-value":Z(r).format("HH:mm"),format:"HH:mm",disabled:!0},null);case"DATEPICKEREX_NOTIME":return R(T("el-date-picker"),{"model-value":Z(r).format("YYYY-MM-DD"),format:"YYYY-MM-DD",disabled:!0},null);case"DATEPICKEREX_HOUR":return R(T("el-date-picker"),{"model-value":Z(r).format("YYYY-MM-DD HH"),format:"YYYY-MM-DD HH",disabled:!0},null);case"DATEPICKER":return R(T("el-date-picker"),{class:t.e("datepicker"),"model-value":Z(r).format("YYYY-MM-DD HH:mm:ss"),format:"YYYY-MM-DD HH:mm:ss",disabled:!0},null);case"TEXTBOX":return R(T("el-input"),{style:n,placeholder:a,disabled:!0},null);case"FILEUPLOADER":return R(T("el-button"),{disabled:!0,class:t.e("fileuploader")},{default:()=>[R("ion-icon",{name:"cloud-upload-outline"},null),a]});case"AC":case"AC_NOBUTTON":case"AC_FS_NOBUTTON":case"AC_FS":case"PICKEREX_LINKONLY":case"PICKER":case"PICKUPVIEW":case"PICKEREX_LINK":case"PICKEREX_NOAC_LINK":case"PICKEREX_NOAC":case"PICKEREX_NOBUTTON":case"PICKEREX_TRIGGER_LINK":case"PICKEREX_TRIGGER":case"DROPDOWNLIST":case"MDROPDOWNLIST":case"DROPDOWNLIST_100":return R(T("el-select"),{"model-value":"选项一",style:"width: 100%",disabled:!0},{default:()=>[R(T("el-option"),{value:"选项一"},{default:()=>[_("选项一")]}),R(T("el-option"),{value:"选项二"},{default:()=>[_("选项二")]}),R(T("el-option"),{value:"选项三"},{default:()=>[_("选项三")]})]});case"CHECKBOX":return R(T("el-checkbox"),{disabled:!0},{default:()=>[_("选项")]});case"CHECKBOXLIST":return R(T("el-checkbox-group"),{disabled:!0},{default:()=>[R(T("el-checkbox"),{disabled:!0},{default:()=>[_("选项一")]}),_(";"),R(T("el-checkbox"),{disabled:!0},{default:()=>[_("选项二")]}),_(";")]});case"NUMBER":return R(T("el-input-number"),{class:t.e("number"),style:"width: 100%",disabled:!0},null);case"USERCONTROL":return R("span",null,[_("用户自定义")]);case"RATING":return R(T("el-rate"),{"text-color":"#ff9900","model-value":4,disabled:!0},null);case"SLIDER":return R(T("el-slider"),{"model-value":30,"show-input":!0,class:t.e("slider")},null);case"DATERANGE":return R(T("el-date-picker"),{"model-value":[r,r],type:"datetimerange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",format:"YYYY-MM-DD HH:mm:ss",disabled:!0,class:t.e("daterange")},null);case"ARRAY":return R("div",{class:t.e("panel-array-input")},[R(T("el-input"),{placeholder:a,disabled:!0},null),R(T("el-button"),{type:"primary",circle:!0,class:t.e("panel-array-input-add-button")},{default:()=>[R("ion-icon",{name:"add-outline"},null)]}),R(T("el-button"),{type:"danger",circle:!0,class:t.e("panel-array-input-remove-button")},{default:()=>[R("ion-icon",{name:"remove-outline"},null)]})]);case"MAPPICKER":return R(T("el-cascader"),{class:t.e("mappicker"),options:[{value:"省",label:"省",children:[{value:"市",label:"市",children:[{value:"区",label:"区"}]}]}],"model-value":["省","市","区"],disabled:!0},null);case"SWITCH":return R(T("el-switch"),{disabled:!0},null);default:return i()}return i()};return{ns:t,renderDesignItem:s,renderContent:()=>{const i=e.controller.data,n=e.controller.getItemCaption(),a=i,r=a.labelpos?a.labelpos.toLowerCase():"left",o=Object.is(r,"top")||Object.is(r,"bottom")?"":"width: ".concat(a.labelwidth||130,"px;"),l=((e,t)=>{let i="";return Object.is(t,"none")||Object.is(t,"top")||Object.is(t,"bottom")||"0"===e.showcaption?e.ctrlwidth?i+="width: ".concat(e.ctrlwidth,"px;"):i+="width: 100%;":e.ctrlwidth?i+="width: ".concat(e.ctrlwidth,"px;"):i+="width: calc(100% - ".concat(e.labelwidth||130,"px);"),e.ctrlheight?i+="height: ".concat(e.ctrlheight,"px;"):i+="height: 100%;",i})(a,r);return"FIELD"===a.itemtype?R("div",{class:"design-form-item ".concat(r||"left")},[R("div",{class:t.e("container-content"),style:{width:"100%",height:"100%"}},[s()])]):R("div",{class:"".concat(t.e("item-content")," ").concat(t.em("item-content",r||"left"))},["0"===a.showcaption?null:R("div",{class:t.e("label-content"),style:o},["1"===a.emptycaption?null:R("label",{class:t.e("label")},[Object.is(r,"right")?"：":"",n||"",Object.is(r,"right")?"":"："])]),R("div",{class:t.e("container-content"),style:l},[s()])])}}},render(){return R("div",{class:this.ns.b()},[R("div",{class:this.ns.e("wrapper")},null),this.renderContent()])}}),Ot=Object.defineProperty,Mt=(e,t,i)=>(((e,t,i)=>{t in e?Ot(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class St{constructor(){Mt(this,"type","PSDEFORMDETAIL_FORMITEM"),Mt(this,"component","IBizDndDesignFormItem")}createController(e,t,i){return new xt(e,t,i)}}var kt={install(e){e.component(At.name,At);const t=new St;ee.registerItemProvider(t.type,t)}};function Rt(){return H("dndDesignRenderItems")}var Tt=S({name:"IBizDndDesignFormPanel",props:{controller:{type:xt,required:!0}},setup:()=>({ns:Y("dnd-design-group-panel"),renderItems:Rt()}),render(){const e=this.controller.data,t=0===e.showcaption;return R("div",{class:this.ns.b()},[t?R("div",{class:this.ns.b("info")},[e.srftext||""]):R("div",{class:this.ns.b("header")},[R("div",null,[R("div",{class:this.ns.be("header","text")},[e.srftext||""]),R("ion-icon",{class:this.ns.be("header","icon"),name:"caret-down"},null)])]),R("div",{class:this.ns.b("content")},[this.renderItems(e.children,e)])])}}),Lt=Object.defineProperty,Nt=(e,t,i)=>(((e,t,i)=>{t in e?Lt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class _t{constructor(){Nt(this,"type","PSDEFORMDETAIL_GROUPPANEL"),Nt(this,"component","IBizDndDesignFormPanel")}createController(e,t,i){return new xt(e,t,i)}}var Ft={install(e){e.component(Tt.name,Tt);const t=new _t;ee.registerItemProvider(t.type,t)}};var Bt=S({name:"IBizDndDesignRawItem",props:{controller:{type:xt,required:!0}},setup(e){const t=Y("dnd-design-raw-item");return{ns:t,renderContent:()=>{switch(e.controller.data.contenttype){case"RAW":return(()=>{const i=e.controller.data;return R("div",{class:t.e("raw")},[i.rawcontent||i.srftext||""])})();case"HTML":return(()=>{const i=e.controller.data;return i.htmlcontent?R("div",{class:t.e("html"),innerHTML:i.htmlcontent},null):R("div",{class:t.e("html")},[i.srftext||""])})();case"IMAGE":return R("div",{class:t.e("image")},[R("svg",{width:"56px",height:"56px",viewBox:"0 0 56 56",version:"1.1",xmlns:"http://www.w3.org/2000/svg"},[R("g",{stroke:"none","stroke-width":"1",fill:"none","fill-rule":"evenodd"},[R("g",{id:"image-fill",transform:"translate(4.000000, 0.000000)",style:"fill: currentColor;","fill-rule":"nonzero"},[R("rect",{id:"矩形",opacity:"0",x:"0",y:"0",width:"48",height:"48"},null),R("path",{d:"M43.5,7.5 L4.5,7.5 C3.6703125,7.5 3,8.1703125 3,9 L3,39 C3,39.8296875 3.6703125,40.5 4.5,40.5 L43.5,40.5 C44.3296875,40.5 45,39.8296875 45,39 L45,9 C45,8.1703125 44.3296875,7.5 43.5,7.5 Z M15.84375,14.25 C17.4984375,14.25 18.84375,15.5953125 18.84375,17.25 C18.84375,18.9046875 17.4984375,20.25 15.84375,20.25 C14.1890625,20.25 12.84375,18.9046875 12.84375,17.25 C12.84375,15.5953125 14.1890625,14.25 15.84375,14.25 Z M39.9328125,34.7390625 C39.8671875,34.7953125 39.778125,34.828125 39.6890625,34.828125 L8.30625,34.828125 C8.1,34.828125 7.93125,34.659375 7.93125,34.453125 C7.93125,34.3640625 7.9640625,34.2796875 8.0203125,34.209375 L16.003125,24.740625 C16.134375,24.58125 16.3734375,24.5625 16.5328125,24.69375 C16.546875,24.7078125 16.565625,24.721875 16.5796875,24.740625 L21.2390625,30.271875 L28.65,21.4828125 C28.78125,21.3234375 29.0203125,21.3046875 29.1796875,21.4359375 C29.19375,21.45 29.2125,21.4640625 29.2265625,21.4828125 L39.9890625,34.2140625 C40.1109375,34.36875 40.0921875,34.6078125 39.9328125,34.7390625 Z",id:"形状"},null)])])])]);case"VIDEO":return R("div",{class:t.e("video")},[R("svg",{width:"56px",height:"56px",viewBox:"0 0 56 56",version:"1.1",xmlns:"http://www.w3.org/2000/svg"},[R("g",{stroke:"none","stroke-width":"1",fill:"none","fill-rule":"evenodd"},[R("g",{id:"video",transform:"translate(4.000000, 4.000000)","fill-rule":"nonzero"},[R("rect",{id:"矩形",style:"fill: currentColor;",opacity:"0",x:"0",y:"0",width:"48",height:"48"},null),R("rect",{id:"矩形",style:"stroke: currentColor;","stroke-width":"2",x:"5",y:"5",width:"38",height:"38",rx:"2"},null),R("path",{d:"M19.842,16.7706563 L30.3061875,22.4005313 C31.4090625,22.993875 31.822125,24.369 31.2287812,25.4717812 C30.9959833,25.9045408 30.6289074,26.2499678 30.1828125,26.4560625 L19.7187188,31.290375 C18.5818125,31.8156563 17.2343438,31.3198125 16.7090625,30.1828125 C16.571335,29.8846905 16.5,29.560211 16.5,29.2318125 L16.5,18.767625 C16.5,17.5153125 17.5153125,16.5 18.767625,16.5 C19.142625,16.5 19.5118125,16.593 19.842,16.7706563 Z",id:"形状",style:"fill: currentColor;"},null)])])])]);case"PLACEHOLDER":return R("div",{class:t.e("placeholder")},[_("占位(PLACEHOLDER)")]);case"DIVIDER":return R(T("el-divider"),{class:t.e("divider")},{default:()=>[_("分割线(DIVIDER)")]});case"INFO":return R("div",{class:t.e("info")},[_("常规提示(INFO)")]);case"WARNING":return R("div",{class:t.e("warning")},[_("警告提示(WARNING)")]);case"ERROR":return R("div",{class:t.e("error")},[_("错误提示(ERROR)")]);default:return R("div",{class:t.e("default")},[_("直接内容")])}}}},render(){return R("div",{class:this.ns.b()},[this.renderContent()])}}),zt=Object.defineProperty,jt=(e,t,i)=>(((e,t,i)=>{t in e?zt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class Ut{constructor(){jt(this,"type","PSDEFORMDETAIL_RAWITEM"),jt(this,"component","IBizDndDesignRawItem")}createController(e,t,i){return new xt(e,t,i)}}var Vt={install(e){e.component(Bt.name,Bt);const t=new Ut;ee.registerItemProvider(t.type,t)}},Gt=S({name:"IBizDndDesignTabPage",setup:()=>()=>R("div",null,[_("分页面板")])}),Ht=Object.defineProperty,Yt=(e,t,i)=>(((e,t,i)=>{t in e?Ht(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class qt{constructor(){Yt(this,"type","PSDEFORMDETAIL_TABPAGE"),Yt(this,"component","IBizDndDesignTabPage")}createController(e,t,i){return new xt(e,t,i)}}var Kt={install(e){e.component(Gt.name,Gt);const t=new qt;ee.registerItemProvider(t.type,t)}},Xt=S({name:"IBizDndDesignTabPanel",props:{controller:{type:Object,required:!0},dndDesignController:{type:Object,required:!0}},setup(e){const t=Y("dnd-design-tab-panel"),i=e.controller,s=Rt(),n=L(),a=L(i.select.data);i.select.on((e=>{a.value=e}));N(a,(()=>{const e=i.data.children;if(Array.isArray(e)&&e.length&&a.value){const t=e.find((e=>e.srfkey===a.value.srfkey));t&&(n.value=t.srfkey)}}),{immediate:!0});return{ns:t,activePage:n,select:a,onActivePageChange:e=>{n.value=e.srfkey,i.select.set(e)},onPagePositionChange:async e=>{const t=i.data.children;Array.isArray(t)&&i.change(e,t,i.data)},onPageAdd:async()=>{const e=i.data.children;Array.isArray(e)&&(e.push({detailtype:"TABPAGE"}),i.change({added:{element:e[e.length-1],newIndex:e.length-1}},e,i.data))},onPageRemove:async e=>{const t=i.data.children;Array.isArray(t)&&i.remove(t,e)},renderItems:s}},render(){const e=this.controller.data.children||[];return R("div",{class:this.ns.b()},[R(T("iBizDraggableTabs"),{value:this.activePage,dndDesignController:this.dndDesignController,items:e,dragSwitchPage:!1,select:this.select,class:this.ns.b("content"),onChange:this.onActivePageChange,onDragChange:this.onPagePositionChange,onAdd:this.onPageAdd,onRemove:this.onPageRemove},{default:e=>this.renderItems(e.children,e)})])}}),Wt=Object.defineProperty,Jt=(e,t,i)=>(((e,t,i)=>{t in e?Wt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class Zt{constructor(){Jt(this,"type","PSDEFORMDETAIL_TABPANEL"),Jt(this,"component","IBizDndDesignTabPanel")}createController(e,t,i){return new xt(e,t,i)}}var $t={install(e){e.component(Xt.name,Xt);const t=new Zt;ee.registerItemProvider(t.type,t)}},Qt=S({name:"IBizDndDesignFormPage",props:{items:{type:Array,required:!0,default:()=>[]},select:{type:Object},dndDesignController:{type:Object,required:!0}},emits:["change","remove","select"],setup(e,{emit:t}){const i=Y("dnd-design-form-page"),s=L();N((()=>e.select),(()=>{const t=e.items;if(Array.isArray(t)&&t.length&&e.select){const i=t.find((t=>t.srfkey===e.select.srfkey));i&&(s.value=i.srfkey)}}),{immediate:!0});return{ns:i,activePage:s,onActivePageChange:e=>{s.value=e.srfkey,t("select",e)},onPagePositionChange:async e=>{t("change",e)},onPageAdd:async()=>{const i=e.items;i.push({detailtype:"FORMPAGE"}),t("change",{added:{element:i[i.length-1],newIndex:i.length-1}})},onPageRemove:async e=>{t("remove",e)}}},render(){return R("div",{class:this.ns.b()},[R(T("iBizDraggableTabs"),{value:this.activePage,items:this.items,dndDesignController:this.dndDesignController,select:this.select,onChange:this.onActivePageChange,onDragChange:this.onPagePositionChange,onAdd:this.onPageAdd,onRemove:this.onPageRemove},{default:e=>{var t,i;return null==(i=(t=this.$slots).default)?void 0:i.call(t,e)}})])}}),ei={install(e){e.component(Qt.name,Qt)}},ti=S({name:"IBizDndDesignButton",props:{controller:{type:xt,required:!0}},setup:()=>({ns:Y("dnd-design-button")}),render(){const e=this.controller.data;return R("div",{class:this.ns.b()},[R(T("el-button"),{class:this.ns.b("content")},{default:()=>[0!==e.showcaption?e.srftext||"":"*"]})])}}),ii=Object.defineProperty,si=(e,t,i)=>(((e,t,i)=>{t in e?ii(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class ni{constructor(){si(this,"type","PSDEFORMDETAIL_BUTTON"),si(this,"component","IBizDndDesignButton")}createController(e,t,i){return new xt(e,t,i)}}var ai={install(e){e.component(ti.name,ti);const t=new ni;ee.registerItemProvider(t.type,t)}},ri=S({name:"IBizDndDesignIframe",props:{controller:{type:xt,required:!0}},setup:()=>({ns:Y("dnd-design-iframe")}),render(){const e=this.controller.data;return R("div",{class:this.ns.b()},[R("div",{class:this.ns.b("content")},[e.srftext||"",_("[直接嵌入页面（iframe）]")])])}}),oi=Object.defineProperty,li=(e,t,i)=>(((e,t,i)=>{t in e?oi(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class ci{constructor(){li(this,"type","PSDEFORMDETAIL_IFRAME"),li(this,"component","IBizDndDesignIframe")}createController(e,t,i){return new xt(e,t,i)}}var di={install(e){e.component(ri.name,ri);const t=new ci;ee.registerItemProvider(t.type,t)}},hi=S({name:"IBizDndDesignDRUIPart",props:{controller:{type:xt,required:!0}},setup:()=>({ns:Y("dnd-design-druipart")}),render(){const e=this.controller.data;return R("div",{class:this.ns.b()},[R("div",{class:this.ns.b("content")},[e.srftext||"",_("[关系]")])])}}),ui=Object.defineProperty,mi=(e,t,i)=>(((e,t,i)=>{t in e?ui(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class pi{constructor(){mi(this,"type","PSDEFORMDETAIL_DRUIPART"),mi(this,"component","IBizDndDesignDRUIPart")}createController(e,t,i){return new xt(e,t,i)}}var fi={install(e){e.component(hi.name,hi);const t=new pi;ee.registerItemProvider(t.type,t)}},gi=S({name:"IBizDndDesignMDCtrl",props:{controller:{type:xt,required:!0}},setup:()=>({ns:Y("dnd-design-mdctrl")}),render(){const e=this.controller.data;return R("div",{class:this.ns.b()},[R("div",{class:this.ns.b("content")},[e.srftext||"",_("[多数据部件]")])])}}),vi=Object.defineProperty,yi=(e,t,i)=>(((e,t,i)=>{t in e?vi(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class bi{constructor(){yi(this,"type","PSDEFORMDETAIL_MDCTRL"),yi(this,"component","IBizDndDesignMDCtrl")}createController(e,t,i){return new xt(e,t,i)}}var wi={install(e){e.component(gi.name,gi);const t=new bi;ee.registerItemProvider(t.type,t)}},Ii=S({name:"IBizDndDesignFormItemEx",props:{controller:{type:Object,required:!0}},setup:()=>({ns:Y("dnd-design-form-item-ex")}),render(){const e=this.controller.data;return R("div",{class:this.ns.b()},[R("div",{class:this.ns.b("content")},[e.srftext||"",_("[复合表单项]")])])}}),Di=Object.defineProperty,Ei=(e,t,i)=>(((e,t,i)=>{t in e?Di(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class Pi{constructor(){Ei(this,"type","PSDEFORMDETAIL_FORMITEMEX"),Ei(this,"component","IBizDndDesignFormItemEx")}createController(e,t,i){return new xt(e,t,i)}}var Ci={install(e){e.component(Ii.name,Ii);const t=new Pi;ee.registerItemProvider(t.type,t)}},xi={install(e){e.use(kt),e.use(Ft),e.use(Vt),e.use(Kt),e.use($t),e.use(ei),e.use(ai),e.use(di),e.use(fi),e.use(wi),e.use(Ci)}},Ai=Object.defineProperty,Oi=(e,t,i)=>(((e,t,i)=>{t in e?Ai(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class Mi extends He{constructor(){super(...arguments),Oi(this,"app"),Oi(this,"form"),Oi(this,"service"),Oi(this,"fieldForm"),Oi(this,"fieldService"),Oi(this,"fieldItems",[]),Oi(this,"items",[]),Oi(this,"enableGroup",!0),Oi(this,"mdCtrlFieldType",["ONE2MANYDATA","ONE2ONEDATA","ONE2MANYDATA_MAP","ONE2MANYOBJ","ONE2ONEOBJ","ONE2MANYOBJ_MAP"])}get view(){return this.panel.view}async onInit(){this.app=await ibiz.hub.getApp(this.model.appId);const e=s(this.panel.view.model,"item");if(!e)throw new P(this.panel.view,"未找到 item 表单模型");this.form=e,this.service=await this.app.deService.getService(this.panel.context,e.appDataEntityId);const t=s(this.panel.view.model,"field");if(!t)throw new P(this.panel.view,"未找到 field 表单模型");this.fieldForm=t,this.fieldService=await this.app.deService.getService(this.panel.context,t.appDataEntityId);const i=this.model.editor;if(i){const{appCodeListId:e}=i;if(e&&(this.codeList=this.app.codeList.getCodeList(e)),!this.codeList)throw new P(this.model,"未配置属性项代码表")}else ibiz.log.warn("拖拽素材区控制器的 editor 为空");await this.initButtonGroup(),this.view.evt.on("onSaveSuccess",(async()=>{await this.load()})),await super.onInit(),this.debounceTransformFieldItems=X(this.debounceTransformFieldItems,50),this.subscribeMessage()}async initButtonGroup(){var e;if(this.fieldForm){const t=this.fieldForm.deformPages;if(!Array.isArray(t)||!t[0])return void ibiz.log.warn("field 表单模型未配置表单分页");const i=t[0].deformDetails,s=null==i?void 0:i.find((e=>"filed_group"===e.codeName));if(!s)return void ibiz.log.warn("field 表单模型未配置标识为 filed_group 表单分组");const n=await this.initActionStates(s);null==(e=this.codeList.codeItems)||e.forEach((e=>{e.codeName&&n&&this.buttonGroupMap.set(e.codeName,{model:s,state:n})}))}}async initActionStates(e){var t;const{uiactionGroup:i}=e;if(!(null==(t=null==i?void 0:i.uiactionGroupDetails)?void 0:t.length))return;const s=new f;return i.uiactionGroupDetails.forEach((e=>{const t=e.uiactionId;if(t){const i=new g(e.id,this.panel.context.srfappid,t);s.addState(e.id,i)}})),await s.update(this.panel.context),s}onDataUpdate(e){if(e.data&&"object"==typeof e.data){const t=e.data;if(t.srfkey){const e=this.items.findIndex((e=>e.srfkey===t.srfkey));-1!==e&&(this.items[e]=t,this.debounceTransformFieldItems())}}}onDataCreate(e){if(e.messageid===this.panel.context.srfsessionid&&e.data&&"object"==typeof e.data){const t=e.data;t.srfkey&&(this.items.push(t),this.transformFieldItems())}}onDataRemove(e){if(e.data&&"object"==typeof e.data){const t=e.data;if(t.srfkey){-1!==this.items.findIndex((e=>e.srfkey===t.srfkey))&&this.loadItems()}}}subscribeMessage(){this.onDataUpdate=this.onDataUpdate.bind(this),this.onDataCreate=this.onDataCreate.bind(this),this.onDataRemove=this.onDataRemove.bind(this),ibiz.mc.command.update.on(this.onDataUpdate),ibiz.mc.command.create.on(this.onDataCreate),ibiz.mc.command.remove.on(this.onDataRemove)}unsubscribeMessage(){ibiz.mc.command.update.off(this.onDataUpdate),ibiz.mc.command.remove.off(this.onDataRemove),ibiz.mc.command.create.off(this.onDataCreate)}destroy(){super.destroy(),this.unsubscribeMessage()}async load(){const e=await this.fieldService.exec("fetchcurde",this.panel.context,{n_psdeid_eq:this.view.state.data.psdeid,n_usertag4_noteq:"INTENAL"});this.state.items=this.codeList.codeItems||[],e.ok&&Array.isArray(e.data)&&(this.fieldItems=e.data,await this.loadItems())}async loadItems(){const e=await this.service.fetchDefault(this.panel.context);e.ok&&Array.isArray(e.data)&&(this.items=e.data,this.transformFieldItems())}filterFieldItems(){const e=[],t=this.view.state.data,i=this.items.map((i=>{if("FORMITEM"===i.detailtype){if("EDITFORM"===t.formtype)return"|".concat(i.psdefid);if("SEARCHFORM"===t.formtype)return"|".concat(i.psdefsfitemid)}return"MDCTRL"===i.detailtype&&i.psdefid&&e.push(i.psdefid),""})).join("");return this.fieldItems.filter((t=>this.mdCtrlFieldType.includes(t.psdatatypeid)?!e.includes(t.srfkey):!(!t.srfkey||-1!==i.indexOf("|".concat(t.srfkey)))))}debounceTransformFieldItems(){this.transformFieldItems()}transformFieldItems(){const e=this.filterFieldItems();this.state.items.forEach((t=>{const i=JSON.parse(t.data||"{}");t.codeItems=e.map((e=>{let s=e.logicname||e.caption;return(e.psdefsfitemname||e.psdefieldname)&&(s+="[".concat(e.psdefsfitemname||e.psdefieldname,"]")),"EDITFORM"===this.view.state.data.formtype?{appId:t.appId,text:s,iconPath:t.iconPath,data:JSON.stringify({...i,caption:e.logicname,logicname:e.logicname,psdefid:e.psdefieldid,psdefname:e.psdefieldname,detailtype:this.mdCtrlFieldType.includes(e.psdatatypeid)?"MDCTRL":"FORMITEM",formtype:this.view.state.data.formtype})}:{appId:t.appId,text:s,iconPath:t.iconPath,data:JSON.stringify({...i,caption:e.logicname,logicname:e.logicname,psdefsfitemid:e.psdefsfitemid,psdefsfitemname:e.psdefsfitemname,psdefname:e.psdefname,psdefid:e.psdefid,detailtype:"FORMITEM",formtype:this.view.state.data.formtype})}}))})),this.codeItems=this.state.items,this.filter()}}var Si=Object.defineProperty,ki=(e,t,i)=>(((e,t,i)=>{t in e?Si(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class Ri{constructor(){ki(this,"component","IBizDndStencilPanelItem")}async createController(e,t,i){const s=new Mi(e,t,i);return await s.init(),s}}var Ti={install(e){d("FIELD_DND_PANEL_ITEM_STENCIL_FIELD",(()=>new Ri))}};class Li extends v{async execAction(e,t){const i=t.view.layoutPanel;if(i){const e=i.panelItems;if(e){const t=e.dnd_panel_item_stencil_field;t&&await t.load()}}return{}}}var Ni={install(e){y("FRONT_RefreshField",(()=>new Li))}},_i=Object.defineProperty,Fi=(e,t,i)=>(((e,t,i)=>{t in e?_i(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class Bi{constructor(){Fi(this,"uiModes",[]),Fi(this,"fields",[])}async init(e){const t=e.model,i=ibiz.hub.getApp(t.appId),n=e.context.psdataentity,a=s(t,"uimode");if(a){const t=await i.deService.getService(e.context,a.appDataEntityId),s=await t.fetchDefault(e.context,{n_psdeid_eq:n,size:1e3});s.ok&&s.data&&(this.uiModes=s.data)}const r=s(t,"field");if(r){const t=await i.deService.getService(e.context,r.appDataEntityId),s=await t.fetchDefault(e.context,{size:1e3});s.ok&&s.data&&(this.fields=s.data)}}findUIMode(e){return this.uiModes.find((t=>{if(t.psdefid===e.psdefid)return t}))}getFormItemPreviewData(e){if("FORMITEM"===e.detailtype&&"SEARCHFORM"===e.formtype&&!e.caption&&e.logicname&&(e.caption=e.logicname),"FORMITEM"===e.detailtype&&M(e.psdefid)){const t=this.findUIMode(e);if(t&&(O(e.caption)&&t.caption&&(e.caption=t.caption),O(e.editortype)&&t.editortype&&(e.editortype=t.editortype),O(e.ctrlheight)&&t.ctrlheight&&(e.ctrlheight=t.ctrlheight),O(e.ctrlwidth)&&t.ctrlwidth&&(e.ctrlwidth=t.ctrlwidth)),!O(e.editortype)&&!O(e.caption))return e;const i=this.fields.find((t=>{if(t.psdefieldid===e.psdefid)return t}));i&&O(e.caption)&&(e.caption=i.logicname)}return e}getTargetDataBySourceData(e,t){return"FORMDETAIL"===e?t.map((e=>this.getFormItemPreviewData(e))):t}}class zi{async init(e){}getTargetDataBySourceData(e,t){return t}}var ji={install(e){pe.getInstance().registerProvider("DESIGN",new Bi),pe.getInstance().registerProvider("RUNTIME",new zi)}};class Ui extends b{async exec(e,t,i,s){return"Create"===e&&i&&(Array.isArray(i)?await Promise.all(i.map((e=>this.calcDefault(t,e)))):await this.calcDefault(t,i)),super.exec(e,t,i,s)}async calcDefault(e,t){let i=1;const s=t.detailtype;let n=s;if("FORMITEM"===s&&(i=0,n=t.detailtype,t.psdefname&&(n=t.psdefname),"SEARCHFORM"===t.formtype&&(n=t.psdefsfitemname),O(n)&&(n=t.srfdecodename)),O(n))return;n=n.toLowerCase();const a=await this.fetchTempDefault(e);if(a.ok&&a.data){const e=a.data,s=new Map,r=new Map;for(e.forEach((e=>{M(e.psdeformdetailname)&&s.set(e.psdeformdetailname.toLowerCase(),e),M(e.psdeformdetailid)&&r.set(e.psdeformdetailid.toLowerCase(),e)}));;){const e=n+(0===i?"":i);if(!s.has(e)&&!r.has(e)){t.psdeformdetailname=e,t.psdeformdetailid=e;break}i+=1}}O(t.srfdecodename)&&O(t.logicname)&&("FORMPAGE"===s?t.logicname="表单分页":"GROUPPANEL"===s?t.logicname="分组面板":"TABPAGE"===s?t.logicname="分页":"BUTTON"===s?t.logicname="按钮":"USERCONTROL"===s?t.logicname="自定义部件":"RAWITEM"===s?t.logicname="直接内容":"DRUIPART"===s?t.logicname="关系界面":"FORMITEM"===s?t.logicname="表单项":"FORMITEMEX"===s?t.logicname="复合表单项":"FORMPART"===s?t.logicname="表单部件":"IFRAME"===s?t.logicname="嵌入页面(iframe)":"TABPANEL"===s?t.logicname="分页面板":"DATAGRID"===s&&(t.logicname="数据表格"))}newEntity(e){return e instanceof Qe?e.clone():new Qe(this.model,e)}}var Vi=Object.defineProperty,Gi=(e,t,i)=>(((e,t,i)=>{t in e?Vi(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class Hi extends b{constructor(e,t){super(e,t),Gi(this,"typeCodeItems");const i=ibiz.hub.getApp(t.appId);this.typeCodeItems=i.codeList.getCodeList("Config__FDLogicType").codeItems}newEntity(e){return e instanceof et?e.clone():new et(this.model,e,this.typeCodeItems)}}e("default",{install(e){w.register("formdesign.psdeformdetail",(async(e,t)=>new Ui(e,t))),w.register("formdesign.psdefdlogic",(async(e,t)=>new Hi(e,t))),e.use(ji),e.use(Ni),e.use(E),e.use(Ae),e.use(Se),e.use(Et),e.use(xi),e.use(Ti),I("VIEW_CUSTOM_DndDesign",(()=>new we)),I("VIEW_CUSTOM_DndDesign_DESIGN",(()=>new we)),D("EDITOR_CUSTOMSTYLE_EditorParamCustom",(()=>new Pe))}})}}}));
