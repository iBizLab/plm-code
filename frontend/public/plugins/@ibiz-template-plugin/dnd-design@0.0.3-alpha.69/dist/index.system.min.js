System.register(["@ibiz-template/runtime","@ibiz-template-plugin/design-base","@ibiz-template/core","qx-util","vue","@ibiz-template/vue3-util","vuedraggable","dayjs","lodash-es"],(function(e,t){"use strict";var i,n,s,a,r,o,l,c,d,u,h,p,m,f,g,v,y,b,w,I,D,E,P,O,C,x,S,A,T,M,R,k,L,j,N,F,B,_,z,U,V,G,H,Y,q,K,X,W,J,Z,$,Q,ee,te,ie,ne,se,ae,re,oe;return{setters:[function(e){i=e.ViewEngineBase,n=e.getControl,s=e.SysUIActionTag,a=e.ViewController,r=e.getPFPlugin,o=e.PanelItemState,l=e.PanelItemController,c=e.getUIActionById,d=e.UIActionUtil,u=e.registerPanelItemProvider,h=e.PluginStaticResource,p=e.AppDataEntity,m=e.QXEventEx,f=e.ButtonContainerState,g=e.UIActionButtonState,v=e.EditorController,y=e.registerEditorProvider,b=e.UIActionProviderBase,w=e.registerUIActionProvider,I=e.DEService,D=e.DEServiceUtil,E=e.registerViewProvider},function(e){P=e.PreviewViewEngineBase,O=e.PreviewViewControllerBase,C=e.PreviewContentState,x=e.PreviewContentController,S=e.default},function(e){A=e.RuntimeModelError,T=e.RuntimeError,M=e.recursiveIterate},function(e){R=e.QXEvent,k=e.createUUID,L=e.ascSort,j=e.isNilOrEmpty,N=e.notNilEmpty},function(e){F=e.defineComponent,B=e.computed,_=e.createVNode,z=e.resolveComponent,U=e.ref,V=e.watch,G=e.reactive,H=e.provide,Y=e.h,q=e.isVNode,K=e.createTextVNode,X=e.onMounted,W=e.onUnmounted,J=e.nextTick,Z=e.inject,$=e.withDirectives,Q=e.resolveDirective},function(e){ee=e.useNamespace,te=e.getCodeProps,ie=e.getEditorEmits,ne=e.useUIStore},function(e){se=e.default},function(e){ae=e.default},function(e){re=e.clone,oe=e.debounce}],execute:function(){var le=Object.defineProperty,ce=(e,t,i)=>(((e,t,i)=>{t in e?le(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);const de=new class{constructor(){ce(this,"dndProviderMap",new Map)}registerItemProvider(e,t){this.dndProviderMap.set(e.toUpperCase(),t)}getItemProvider(e){const t=e.toUpperCase();if(this.dndProviderMap.has(t))return this.dndProviderMap.get(t);throw new Error("未找到".concat(t,"对应的拖拽组件绘制"))}};var ue=Object.defineProperty,he=(e,t,i)=>(((e,t,i)=>{t in e?ue(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class pe{constructor(){he(this,"_data",null),he(this,"evt",new R)}get data(){return this._data}set(e){this._data=e,this.evt.emit("change",this._data)}get(){return this.data}reset(){this._data=null,this.evt.emit("change",null)}on(e){return this.evt.on("change",e)}off(e){this.evt.off("change",e)}}var me=Object.defineProperty,fe=(e,t,i)=>(((e,t,i)=>{t in e?me(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);const ge=new class{constructor(){fe(this,"gridLayoutMode",["lg","md","sm","xs"])}getGridLayoutModeValue(e,t="",i=""){for(let n=0;n<this.gridLayoutMode.length;n++){const s=this.gridLayoutMode[n],a="".concat(t).concat(s).concat(i);if(null!=e[a])return e[a]}return""}getGridCol(e,t){let i=this.getGridLayoutModeValue(e,"col_");if(t&&!i&&(i=this.getGridLayoutModeValue(t,"child_col_")),(!i||i<="0"||i>"24")&&(i="24"),i){const e=parseInt(i,10);if("TABLE_12COL"===(null==t?void 0:t.layoutmode)&&e>0&&e<=12)return 2*e;if(e>0&&e<=24)return e}return null}getGridOffset(e,t){let i=this.getGridLayoutModeValue(e,"col_","_os");if(t&&!i&&(i=this.getGridLayoutModeValue(e,"child_col_","_os")),i){const e=parseInt(i,10);if("TABLE_12COL"===(null==t?void 0:t.layoutmode)&&e>0&&e<=12)return 2*e;if(e>0&&e<=24)return e}return null}calcColClass(e,t){const i={};if(t&&"FLEX"===t.layoutmode)return i;const n=this.getGridCol(e,t);n&&(i["el-col-".concat(n)]=!0);const s=this.getGridOffset(e,t);return s&&(i["el-col-offset-".concat(s)]=!0),i}getFlexLayoutStyle(e){return"FLEX"===e.layoutmode?{display:"flex","flex-direction":e.flexdir,"justify-content":e.flexalign,"align-items":e.flexvalign,"flex-grow":e.flexgrow,"flex-shrink":e.flexshrink,"flex-basis":"".concat(e.flexbasis,"px"),padding:"".concat(e.padding,"px")}:{padding:"".concat(e.padding,"px")}}getDraggableContainerClass(e,t){const i="FLEX"===e.layoutmode;return{[t.b("grid-layout")]:!i,[t.b("flex-layout")]:i,[t.b("flex-row")]:i&&e.flexdir&&-1===e.flexdir.indexOf("column"),[t.b("flex-column")]:i&&e.flexdir&&-1!==e.flexdir.indexOf("column")}}calcStyle(e,t){const i={};if(!e)return i;if(e){"FULL"===e.heightmode?i.height="auto":e.height?i.height=e.height+("PERCENTAGE"===e.heightmode?"%":"px"):t&&"PSSysViewPanel"===t.itemtype?"CONTAINER"!==t.itemtype&&"CTRLPOS"!==t.itemtype||(i["flex-grow"]=1):i.height="auto","FULL"===e.widthmode?i.width="auto":e.width&&(i.width=e.width+("PERCENTAGE"===e.widthmode?"%":"px"),"FLEX"!==(null==t?void 0:t.layoutmode)&&(i["flex-basis"]=i.width));const n="FLEX"===(null==t?void 0:t.layoutmode);n?(null!=e.flexgrow&&(i["flex-grow"]=e.flexgrow),null!=e.flexshrink&&(i["flex-shrink"]=e.flexshrink),null!=e.flexbasis&&(i["flex-basis"]="".concat(e.flexbasis,"px")),!t||t.flexdir&&-1===t.flexdir.indexOf("row")?Object.assign(i,this.getHorizontalAlign(e,t,n)):Object.assign(i,this.getVerticalAlign(e,t,n))):Object.assign(i,this.getHorizontalAlign(e,t,n)),Object.assign(i,this.getSwapMode(e)),Object.assign(i,this.getBorderStyle(e))}return i}getSwapMode(e){const t={};return e.swapmode&&("FLEX"===e.layoutmode?"NOWRAP"===e.swapmode?t["flex-wrap"]="nowrap":t["flex-wrap"]="wrap":"NOWRAP"===e.swapmode?t["white-space"]="nowrap":t["white-space"]="pre-wrap"),t}getBorderStyle(e){const t={};return e.spacingleft&&(-1!==e.spacingleft.indexOf("OUTER")?t["margin-left"]=this.getSpacingStyle(e.spacingleft.replace("OUTER","")):t["padding-left"]=this.getSpacingStyle(e.spacingleft.replace("INNER",""))),e.spacingright&&(-1!==e.spacingright.indexOf("OUTER")?t["margin-right"]=this.getSpacingStyle(e.spacingright.replace("OUTER","")):t["padding-right"]=this.getSpacingStyle(e.spacingright.replace("INNER",""))),e.spacingtop&&(-1!==e.spacingtop.indexOf("OUTER")?t["margin-top"]=this.getSpacingStyle(e.spacingtop.replace("OUTER","")):t["padding-top"]=this.getSpacingStyle(e.spacingtop.replace("INNER",""))),e.spacingbottom&&(-1!==e.spacingbottom.indexOf("OUTER")?t["margin-bottom"]=this.getSpacingStyle(e.spacingbottom.replace("OUTER","")):t["padding-bottom"]=this.getSpacingStyle(e.spacingbottom.replace("INNER",""))),t}getSpacingStyle(e){let t="0px";switch(e){case"NONE":default:t="0px";break;case"SMALL":t="8px";break;case"MEDIUM":t="16px";break;case"LARGE":t="24px"}return t}getHorizontalAlign(e,t,i=!1){const n={};switch(e.halignself||(null==t?void 0:t.height)){case"LEFT":i?n["align-self"]="flex-start":n.float="left";break;case"RIGHT":i?n["align-self"]="flex-end":n.float="right";break;case"CENTER":i?n["align-self"]="center":(n.margin="auto",n.float="none",n.display="table")}return n}getVerticalAlign(e,t,i=!1){const n={};switch(e.valignself||(null==t?void 0:t.valign)){case"TOP":i&&(n["align-self"]="flex-start");break;case"BOTTOM":i&&(n["align-self"]="flex-end");break;case"MIDDLE":i&&(n["align-self"]="center")}return n}};const ve=new class{isEnableUpdate(e){return!e||32768==(32768&e)}isEnableRemove(e){return!e||65536==(65536&e)}isEnableDrag(e){return!e||131072==(131072&e)}isEnableDrop(e){return!e||262144==(262144&e)}isEnablePlaceholder(e){return!!e&&524288==(524288&e)}};var ye=Object.defineProperty,be=(e,t,i)=>(((e,t,i)=>{t in e?ye(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class we extends i{constructor(){super(...arguments),be(this,"form"),be(this,"navPos"),be(this,"service")}initNavTab(){var e,t,i,n;const s=this.view.parentView;if(!s)return;const a=null==(e=s.layoutPanel)?void 0:e.panelItems;if(!a||!a.nav_pos_index)return;const r=a.nav_pos_index;if(r.navTabs&&(null==(t=r.state)?void 0:t.currentKey)){const e=r.state.currentKey;null==(n=(i=r.navTabs).updateViewInfo)||n.call(i,e,{caption:this.view.model.caption,sysImage:this.view.model.sysImage})}}async onCreated(){this.view.model={...this.view.model,showDataInfoBar:!0},await super.onCreated(),this.initNavTab();{const e=n(this.view.model,"form");if(!e)throw new A(this.view,"未找到主数据表单模型");this.form=e;const t=ibiz.hub.getApp(this.view.model.appId);this.service=await t.deService.getService(this.view.context,this.form.appDataEntityId)}this.onSelect=this.onSelect.bind(this),this.view.select.on(this.onSelect),this.view.modal.hooks.shouldDismiss.tapPromise((async e=>{const t=ibiz.uiDomainManager.get(this.view.context.srfsessionid);if(!0===(null==t?void 0:t.dataModification)&&null==e.allowClose){const t=await ibiz.confirm.error({title:"关闭提醒",desc:"数据已经修改，确定要关闭？"});e.allowClose=!!t}})),await this.load();const e=this.view.state.data;e&&e.psdeid&&(this.view.context.psdataentity=e.psdeid)}onSelect(e){this.onActive(e)}async onMounted(){var e;await super.onMounted(),null==(e=this.toolbar)||e.calcButtonState(this.view.state.data,this.form.appDataEntityId),this.navPos=this.view.layoutPanel.panelItems.nav_pos,this.activeRoot(),this.view.evt.emit("onViewInfoChange",{dataInfo:this.view.state.data.srfmajortext||""})}async onDestroyed(){await super.onDestroyed(),this.view.select.off(this.onSelect)}activeRoot(e=!1){this.view.state.data.forceRefresh=e,this.view.select.set(this.view.state.data)}async load(){try{this.view.startLoading();const e=await this.service.get(this.view.context,this.view.params);return this.service.local.add(this.view.context,e.data),this.view.state.data=e.data,e.data}finally{this.view.endLoading()}}async save(){var e;try{this.view.startLoading();const t=this.service.local.get(this.view.context,this.view.state.data.srfkey);for(const e in t)if(Object.prototype.hasOwnProperty.call(t,e)){"object"==typeof t[e]&&(t[e]=void 0)}const i=await this.service.update(this.view.context,t);return this.service.local.add(this.view.context,i.data),this.view.state.data=i.data,await this.view.evt.emit("onSaveSuccess",void 0),this.activeRoot(),this.view.evt.emit("onViewInfoChange",{dataInfo:this.view.state.data.srfmajortext||""}),null==(e=this.toolbar)||e.calcButtonState(this.view.state.data,this.form.appDataEntityId),i.data}finally{this.view.endLoading()}}async call(e,t){if(e===s.SAVE)return this.save();if("onActive"===e&&t)this.onActive(t);else if("onActiveRoot"!==e){if("Refresh"!==e)return super.call(e,t);this.refreshView()}else this.activeRoot()}async refreshView(){var e;await this.load(),this.activeRoot(!0),this.view.evt.emit("onRefreshView",void 0),this.view.evt.emit("onViewInfoChange",{dataInfo:(null==(e=this.view.state.data)?void 0:e.srfmajortext)||""})}onActive(e){var t;const{forceRefresh:i}=e;delete e.forceRefresh;const n=this.view.model.appViewRefs;if(n){const s=e.srftype?e.srftype.toUpperCase():null,a=n.find((t=>t.name==="EDITDATA:".concat(e.srfdecodename.toUpperCase()).concat(s?":".concat(s):"")));if(!a)throw new A(this.view.model,"未匹配到对应[".concat(e.srftype,"]的属性编辑视图"));{const n=this.view.context.clone();n[e.srfdecodename.toLowerCase()]=e.srfkey,delete n.srfrunmode;const s=null==(t=this.view.layoutPanel)?void 0:t.panelItems.dnd_design_panel_item,r=s?s.getModelState(e):0;ve.isEnableUpdate(r)||(n.srfreadonly=!0),this.navPos.openView({key:i?k():e.srfkey,viewId:a.refAppViewId,context:n})}}}}var Ie=Object.defineProperty,De=(e,t,i)=>(((e,t,i)=>{t in e?Ie(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);const Ee=class e{constructor(){De(this,"preViewProviderMap",new Map)}static getInstance(){return e.DndPreViewFactory||(e.DndPreViewFactory=new e),this.DndPreViewFactory}registerProvider(e,t){this.preViewProviderMap.set(e,t)}getProvider(e){var t;return null==(t=this.preViewProviderMap.get(e))?void 0:t()}};De(Ee,"DndPreViewFactory");let Pe=Ee;var Oe=Object.defineProperty,Ce=(e,t,i)=>(((e,t,i)=>{t in e?Oe(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class xe extends a{constructor(){super(...arguments),Ce(this,"select",new pe),Ce(this,"preViewProvider")}getPreViewProvider(){return this.preViewProvider}async onCreated(){await super.onCreated();const{sysPFPluginId:e,appId:t}=this.model,i=r(e,t);if(i&&i.pluginParams){const e=i.pluginParams;Object.keys(e).forEach((t=>{e[t]&&"appId"!==t&&(this.context[t.toLowerCase()]=e[t])}))}const n=this.context.srfrunmode?this.context.srfrunmode:"RUNTIME";this.preViewProvider=Pe.getInstance().getProvider(n),await this.preViewProvider.init(this)}initEngines(){this.engines.push(new we(this))}}var Se=Object.defineProperty,Ae=(e,t,i)=>(((e,t,i)=>{t in e?Se(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class Te{constructor(){Ae(this,"component","IBizView")}createController(e,t,i,n){return new xe(e,t,i,n)}}class Me extends P{}class Re extends O{async initPreViewProvider(){this.preViewProvider=Pe.getInstance().getProvider("DESIGN"),await this.preViewProvider.init(this)}initEngines(){this.engines.push(new Me(this))}}var ke=Object.defineProperty,Le=(e,t,i)=>(((e,t,i)=>{t in e?ke(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class je{constructor(){Le(this,"component","IBizView")}createController(e,t,i,n){return new Re(e,t,i,n)}}var Ne=F({name:"IBizDraggableItem",props:{isSelect:{type:Boolean,default:!1},item:{type:Object,required:!0},actions:{type:Array,required:!1},modelState:{type:Number,required:!0},isShowMask:{type:Boolean},isShowLogicButton:{type:Boolean}},setup:(e,{emit:t})=>({ns:ee("dnd-design-draggable-item"),layoutStyle:B((()=>({width:e.item.width?"".concat(e.item.width,"px"):"",height:e.item.height?"".concat(e.item.height,"px"):""}))),onClick:(e,i)=>{e.stopPropagation(),t("action",i)}}),render(){var e,t;return _("div",{class:[this.ns.b(),this.ns.is("select",this.isSelect)],style:this.layoutStyle},[_("div",{class:[this.ns.b("content"),this.isShowMask?this.ns.bm("content","mask"):""]},[this.isShowMask&&_("div",{class:this.ns.be("content","mask")},null),null==(t=(e=this.$slots).default)?void 0:t.call(e)]),ve.isEnableDrag(this.modelState)&&_("div",{class:[this.ns.e("handle"),"handle"]},[_("svg",{viewBox:"64 64 896 896","data-icon":"drag",width:"1em",height:"1em",fill:"currentColor","aria-hidden":"true",focusable:"false",class:""},[_("path",{d:"M909.3 506.3L781.7 405.6a7.23 7.23 0 0 0-11.7 5.7V476H548V254h64.8c6 0 9.4-7 5.7-11.7L517.7 114.7a7.14 7.14 0 0 0-11.3 0L405.6 242.3a7.23 7.23 0 0 0 5.7 11.7H476v222H254v-64.8c0-6-7-9.4-11.7-5.7L114.7 506.3a7.14 7.14 0 0 0 0 11.3l127.5 100.8c4.7 3.7 11.7.4 11.7-5.7V548h222v222h-64.8c-6 0-9.4 7-5.7 11.7l100.8 127.5c2.9 3.7 8.5 3.7 11.3 0l100.8-127.5c3.7-4.7.4-11.7-5.7-11.7H548V548h222v64.8c0 6 7 9.4 11.7 5.7l127.5-100.8a7.3 7.3 0 0 0 .1-11.4z"},null)])]),this.actions?_("ul",{class:this.ns.b("actions")},[this.actions.map((e=>{if(("delete"!==e.command||ve.isEnableRemove(this.modelState))&&("delete"!==e.command||this.isSelect)&&("logic"!==e.command||this.isShowLogicButton))return _("li",{class:this.ns.be("actions","item"),title:e.tooltip,onClick:t=>this.onClick(t,e)},[e.icon])}))]):null])}}),Fe=F({name:"IBizDraggableTabs",props:{value:{type:String},items:{type:Array,required:!0,default:()=>[]},dragSwitchPage:{type:Boolean,default:!0},select:{type:Object},dndDesignController:{type:Object,required:!0}},emits:["change","drag-change","remove","add"],setup(e,{emit:t}){const i=ee("dnd-design-draggable-tabs"),n=ee("light-theme-shell"),s=k(),a=i=>{i.srfkey===e.value&&e.select&&e.select.srfkey===e.value||t("change",i)},r=new Map;return{ns:i,shellNS:n,uuid:s,onDragChange:e=>{t("drag-change",e)},onItemClick:a,onConfirm:e=>{t("remove",e)},onAddButtonClick:e=>{e.stopPropagation(),t("add")},onDragenter:(t,i)=>{if(e.dragSwitchPage&&i.srfkey){const e=r.get(i.srfkey)||[],t=window.setTimeout((()=>{a(i),e.pop()}),500);e.push(t),r.set(i.srfkey,e)}},onDragLeave:(t,i)=>{if(e.dragSwitchPage&&i.srfkey){const e=r.get(i.srfkey);if(e){const t=e.pop();t&&clearTimeout(t)}}}}},render(){return _("div",{class:this.ns.b()},[_("div",{class:this.ns.b("header")},[_(z("iBizDraggable"),{class:this.ns.b("nav"),list:this.items,group:{name:this.uuid,pull:!1},filter:".".concat(this.ns.bm("item","forbid")),itemKey:"srfkey",onChange:this.onDragChange},{item:e=>{const{element:t,index:i}=e,n=this.value?this.value===t.srfkey:0===i,s=this.dndDesignController.getModelState(t);return _("div",{class:[this.ns.b("item"),this.ns.is("active",n),!ve.isEnableDrag(s)&&this.ns.bm("item","forbid")],onClick:e=>{e.stopPropagation(),this.onItemClick(t)},onDragenter:e=>this.onDragenter(e,t),onDragleave:e=>this.onDragLeave(e,t)},[_("div",{class:this.ns.be("item","text")},[t.srftext||""]),ve.isEnableRemove(s)&&_("div",{class:this.ns.be("item","remove-button")},[_(z("el-popconfirm"),{title:"确认删除表单分页?子数据将一并删除!","confirm-button-text":"确认","cancel-button-text":"取消",width:"auto",placement:"left","popper-class":[this.ns.be("item","pop-confirm"),this.shellNS.m("popper")],icon:_("ion-icon",{name:"alert-circle"},null),"icon-color":"#faad14",onConfirm:()=>this.onConfirm(t)},{reference:()=>_("ion-icon",{name:"close-outline",onClick:e=>{e.stopPropagation()}},null)})])])},footer:()=>_("div",{class:this.ns.b("item-add-button"),onClick:e=>this.onAddButtonClick(e),title:"新建分页"},[_("ion-icon",{name:"add-outline",class:this.ns.be("item-add-button","icon")},null)])})]),_("div",{class:this.ns.b("content")},[this.items.map(((e,t)=>{var i,n;const s=this.value?e.srfkey!==this.value:0!==t,a=this.dndDesignController.isShowMask(e);return _("div",{class:[this.ns.b("item-content"),this.ns.is("hidden",s),this.ns.is("select",this.select&&e.srfkey===this.select.srfkey),a?this.ns.bm("item-content","mask"):""],onClick:t=>{t.stopPropagation(),this.onItemClick(e)}},[a&&_("div",{class:this.ns.be("item-content","mask")},null),null==(n=(i=this.$slots).default)?void 0:n.call(i,e)])}))])])}}),Be=F({name:"IBizFormShell",props:{context:{type:Object,required:!0},data:{type:Object,required:!0},items:{type:Object,required:!0}},setup(e){const t=ee("form-shell"),i=ee("light-theme-shell"),n=U(),s=(e,t,i)=>e.map((e=>{const n=e.psdeformdetails?s(e.psdeformdetails,t,e):[],a=t(e,i);return n.length>0&&(a["TABPANEL"===a.detailType?"deformTabPages":"deformDetails"]=n),a})),a=t=>s(t,((t,i)=>{let n={width:t.width,height:t.height,caption:t.caption,detailType:t.detailtype,id:t.psdeformdetailname,name:t.psdeformdetailname,appId:e.context.srfappid,codeName:t.psdeformdetailname,showCaption:0!==t.showcaption,sysImage:{appId:e.context.srfappid,cssClass:t.pssysimagename},detailStyle:t.detailstyle,layout:{appId:e.context.srfappid,layout:t.layoutmode||t.playoutmode||"TABLE_24COL",dir:t.flexdir,align:t.flexalign,valign:t.flexvalign},layoutPos:{appId:e.context.srfappid,layout:t.layoutmode||t.playoutmode||"TABLE_24COL",colXS:t.col_xs||(null==i?void 0:i.child_col_xs),colXSOffset:t.col_xs_os,colSM:t.col_sm||(null==i?void 0:i.child_col_sm),colSMOffset:t.col_sm_os,colMD:t.col_md||(null==i?void 0:i.child_col_md),colMDOffset:t.col_md_os,colLG:t.col_lg||(null==i?void 0:i.child_col_lg),colLGOffset:t.col_lg_os,basis:t.flexbasis,grow:t.flexgrow,shrink:t.flexshrink}};switch(n.detailType){case"FORMITEM":n={...n,emptyCaption:t.emptycaption,labelPos:t.labelpos||"LEFT",labelWidth:t.labelwidth,allowEmpty:0!==t.allowempty,hidden:"HIDDEN"===t.editortype,valueFormat:t.valueformat,enableCond:t.enablecond,enableItemPriv:t.enableitempriv,resetItemNames:t.resetitemname?t.resetitemname.split(";"):void 0,editor:{appId:e.context.srfappid,editorType:t.editortype||"SPAN",placeHolder:t.placeholder,editorItems:t.valueitemname?t.valueitemname.split(";"):void 0,editorHeight:t.ctrlheight,editorWidth:t.ctrlwidth}};break;case"TABPAGE":case"TABPANEL":case"FORMPAGE":case"GROUPPANEL":n={...n,enableAnchor:t.enableanchor,captionItemName:t.valueitemname,titleBarCloseMode:t.titlebarclosemode};break;case"IFRAME":n={...n,iframeUrl:t.editorparams};break;case"RAWITEM":n={...n,rawItem:{appId:e.context.srfappid,contentType:t.contenttype,caption:t.rawcontent||"",content:t.htmlcontent||"",sysImage:{appId:e.context.srfappid,cssClass:t.pssysimagename}}};break;case"BUTTONLIST":n={...n,uiactionGroup:{appId:e.context.srfappid,uiactionGroupDetails:[]}};break;case"MDCTRL":n={...n,contentType:t.mdctrltype}}return n}));return V((()=>e.items),(()=>{(async()=>{const t=e.data,i={controlType:t.formtype,appId:e.context.srfappid,codeName:t.codename,autoSaveMode:0,navBarPos:t.navbarpos,navBarStyle:t.navbarstyle,navBarWidth:t.navbarwidth||0,navbarHeight:t.navbarheight,navBarSysCss:{appId:e.context.srfappid,cssName:t.navbarpssyscssname},enableAutoSave:!1,enableCustomized:!1,infoFormMode:t.infoformflag,showFormNavBar:t.formnavbar,formFuncMode:t.funcmode,formStyle:t.formstyle,formWidth:t.formwidth,noTabHeader:0===t.showtabheader,tabHeaderPos:t.tabheaderpos,logicName:t.psdeformname,deformPages:a(e.items)};n.value=i})()}),{immediate:!0,deep:!0}),{ns:t,shellNS:i,modelData:n}},render(){return this.modelData?_("div",{class:this.ns.b()},["FORM"===this.modelData.controlType?_(z("iBizEditFormControl"),{data:{},isSimple:!0,class:[this.ns.m("light"),this.shellNS.b()],modelData:this.modelData,context:this.context},null):_(z("iBizSearchFormControl"),{data:{},isSimple:!0,class:[this.ns.m("light"),this.shellNS.b()],modelData:this.modelData,context:this.context},null)]):null}}),_e={install(e){e.component(Ne.name,Ne),e.component(Fe.name,Fe),e.component(Be.name,Be)}},ze=Object.defineProperty,Ue=(e,t,i)=>(((e,t,i)=>{t in e?ze(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class Ve extends o{constructor(){super(...arguments),Ue(this,"items",[]),Ue(this,"activeData",null),Ue(this,"uuid",k()),Ue(this,"hiddenFormItemVisible",!0),Ue(this,"logicMap",{})}}var Ge=Object.defineProperty,He=(e,t,i)=>(((e,t,i)=>{t in e?Ge(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class Ye extends l{constructor(){super(...arguments),He(this,"service"),He(this,"form"),He(this,"providers",{}),He(this,"controllers",{}),He(this,"items",[]),He(this,"timer",null),He(this,"isDisableMessage",!1),He(this,"showMaskType",["MDCTRL","GROUPPANEL","TABPANEL","TABPAGE","FORMPAGE"])}get view(){return this.panel.view}createState(){var e;return new Ve(null==(e=this.parent)?void 0:e.state)}async onInit(){await super.onInit();const e=n(this.panel.view.model,"item");if(!e)throw new A(this.panel.view,"未找到 item 表单模型");this.form=e;const t=await ibiz.hub.getApp(this.model.appId);this.service=await t.deService.getService(this.panel.context,e.appDataEntityId),this.view.evt.on("onSaveSuccess",(async()=>{await this.load(),this.state.uuid=k()})),this.view.evt.on("onStencilAdd",(async e=>{var t;if(!e||!e.stencil)return;const i=null==(t=this.view.select.data)?void 0:t.srfkey;this.handleStencilAdd(e.stencil,i)})),await this.load(),this.subscribeMessage()}handleStencilAdd(e,t,i){if(!t)return;const n=this.items.find((e=>e.srfkey===t));if(!n)return;const s=n.srftype;if(!s)return;if(!["GROUPPANEL","FORMPAGE","TABPAGE","TABPANEL","MDCTRL"].includes(s))return void this.handleStencilAdd(e,n.srfpkey,i||n);if("TABPANEL"===s)return;if("MDCTRL"===s&&"REPEATER"!==n.mdctrltype)return;const a=n.children||[];let r=a.length;if(i){const e=a.findIndex((e=>e.srfkey===i.srfkey));-1!==e&&(r=e+1)}this.add({added:{element:e,newIndex:r}},a,n)}async updateLogicMap(){const e=this.view.context.srfappid;if(!e)return;const t=ibiz.hub.getApp(e);if(!t)return;const i=await ibiz.hub.getAppDataEntity("PSDEFDLogic",e);if(!i)return;const n=await t.deService.getService(this.view.context,i.id);if(!n)return;const s=await n.fetchDefault(this.view.context),a={};s&&Array.isArray(s.data)&&s.data.forEach((e=>{const t=e.psdeformdetailid;a[t]?a[t]+=1:a[t]=1})),this.state.logicMap=a}onDEDataChange(e){if(e&&e.data&&"object"==typeof e.data){"PSDEFDLogic"===e.data.srfdecodename&&this.updateLogicMap()}}async openLogicView(e){if(!e)return;const t=n(this.view.model,"structuretoolbar");if(!t)return;const i=t.detoolbarItems||[];if(i&&i.length){const t=i.find((t=>"FORMITEM"===e.srftype||"FORMITEMEX"===e.srftype?"formitem"===t.id:"default"===t.id));if(t&&"DEUIACTION"===t.itemType){const i=t.uiactionId;if(!i)return;if(!await c(i,t.appId))throw new T(ibiz.i18n.t("runtime.controller.control.toolbar.noFound",{actionId:i}));const n=this.view.context.clone();delete n.srfrunmode;const s=this.getModelState(e);ve.isEnableUpdate(s)||(n.srfreadonly=!0),await d.execAndResolved(i,{context:n,params:this.view.params,data:[e],view:this.view},t.appId)}}}updateHiddenFormItemVisible(e){this.state.hiddenFormItemVisible=e}onDataUpdate(e){if(!this.isDisableMessage&&e.data&&"object"==typeof e.data){const t=e.data;if(t.srfkey){const e=this.items.findIndex((e=>e.srfkey===t.srfkey));-1!==e&&(this.removeController(this.items[e]),this.items.splice(e,1,t),this.initItem(t),this.timer&&window.clearTimeout(this.timer),this.timer=window.setTimeout((()=>{this.recalculateDeppItems()}),50))}}}sendMessage(e,t,i){this.isDisableMessage=!0,e.forEach((e=>{t?ibiz.mc.command.send(e,t):i&&ibiz.mc.command.next({...i,data:e})})),this.isDisableMessage=!1}async refresh(){await this.load(),this.state.uuid=k()}subscribeMessage(){this.onDataUpdate=this.onDataUpdate.bind(this),this.onDEDataChange=this.onDEDataChange.bind(this),this.refresh=this.refresh.bind(this),this.view.evt.on("onRefreshView",this.refresh),ibiz.mc.command.update.on(this.onDataUpdate),ibiz.mc.command.change.on(this.onDEDataChange)}unsubscribeMessage(){this.view.evt.off("onRefreshView",this.refresh),ibiz.mc.command.update.off(this.onDataUpdate),ibiz.mc.command.change.off(this.onDEDataChange)}destroy(){super.destroy(),this.unsubscribeMessage()}async initItem(e){if("FORMPAGE"===e.srftype)return;const t="".concat(e.srfdecodename,"_").concat(e.srftype),i=de.getItemProvider(t),n=i.createController(this,this.form,e);this.providers[e.srfkey]=i,this.controllers[e.srfkey]=n}async load(){await this.updateLogicMap();const e=await this.service.fetchDefault(this.panel.context);this.items=e.data,this.items.forEach((e=>{this.initItem(e)})),this.state.items=this.calcDeepItems(this.items)}recalculateDeppItems(){this.state.items=this.calcDeepItems(this.items)}calcDeepItems(e,t){const i=[];return e.filter((e=>null==t?null==e.srfpkey:e.srfpkey===t.srfkey)).forEach((t=>{i.push(t);let n=this.calcDeepItems(e,t);n.length>0?(n=L(n,"srfordervalue"),t.children=G(n)):t.children=G([])})),i}change(e,t,i){if(e){const{added:n,moved:s}=e;if(n&&n.element){const s=n.element;!s.srfkey||Object.is(s.srfkey,"")?(t.splice(n.newIndex,1),this.add(e,t,i)):(s.srfpkey=i?i.srfkey:void 0,this.move(t,0,t.length-1))}else s&&s.element&&this.move(t,0,t.length-1)}}async add(e,t,i){const n=e.added.newIndex,s=e.added.element,a=await this.service.getDraft(this.panel.context,s);if(a.ok){const{data:e}=a;s.caption&&"DESIGN"===this.panel.context.srfrunmode&&(s.caption=void 0),Object.assign(e,s),e.srfordervalue=10*(n+1),i&&(e.srfpkey=i.srfkey);const r=await this.service.create(this.panel.context,e);if(r.ok){const e=r.data;e.children=G([]),await this.initItem(e),this.items.push(e),this.sendMessage([e],void 0,{messageid:this.panel.context.srfsessionid,messagename:"command",type:"COMMAND",subtype:"OBJECTCREATED"}),t.splice(n,0,e),this.view.select.set(r.data),await this.move(t,n,t.length-1)}}}async move(e,t,i){const n=t>i?t:i,s=[];e.forEach(((e,t)=>{t>=0&&t<=n&&(e.srfordervalue=10*(t+1),s.push(e))}));const a=await this.service.update(this.panel.context,s);a.ok&&(Array.isArray(a.data)&&this.sendMessage(a.data,"OBJECTUPDATED"),ibiz.log.debug("排序成功"))}async remove(e,t){if((await this.service.remove(this.panel.context,{},t)).ok){const i=this.items.findIndex((e=>e.srfkey===t.srfkey)),n=e.findIndex((e=>e.srfkey===t.srfkey));if(i>-1){this.items.splice(i,1),e.splice(n,1),this.removeController(t),this.sendMessage([t],"OBJECTREMOVED");const s=e[0]||this.items.find((e=>e.srfkey===t.srfpkey));s?this.view.select.set(s):this.view.call("onActiveRoot"),this.recalculateDeppItems()}return!0}return!1}removeController(e){if("FORMPAGE"===e.srftype)return;this.controllers[e.srfkey].destroy(),delete this.controllers[e.srfkey]}getModelState(e){let t=0,i=e;for(;i;){if(i.modelstate){t=i.modelstate;break}let e=!1;const n=i.srfpkey;if(n){const t=this.controllers[n];if(t)i=t.data,e=!0;else{const t=this.items.find((e=>e.srfkey===n));t&&(i=t,e=!0)}}if(!e)break}return t}isShowMask(e){if(!e)return!1;const t=e.modelstate,i=ve.isEnablePlaceholder(t)&&this.showMaskType.includes(e.srftype);if(!i)return i;let n=e,s=!1;for(;n;){let e=!1;const t=n.srfpkey;if(t){const i=this.controllers[t];if(i)n=i.data,s=ve.isEnablePlaceholder(n.modelstate)&&this.showMaskType.includes(n.srftype)||s,e=!0;else{const i=this.items.find((e=>e.srfkey===t));i&&(n=i,s=ve.isEnablePlaceholder(n.modelstate)&&this.showMaskType.includes(n.srftype)||s,e=!0)}}if(!e)break}return!s}}var qe=Object.defineProperty,Ke=(e,t,i)=>(((e,t,i)=>{t in e?qe(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class Xe{constructor(){Ke(this,"component","IBizDndDesignPanelItem")}async createController(e,t,i){const n=new Ye(e,t,i);return await n.init(),n}}var We=F({name:"IBizDndDesignPanelItem",props:{modelData:{type:Object,required:!0},controller:{type:Ye,required:!0}},setup(e){const t=e.controller,i=U(),n=ee("dnd-design"),s=ee("light-theme-shell"),a=U("light");t.view.select.on((e=>{i.value=e}));const r=(e,s,a)=>{const o="dnd-design-".concat(s?s.srfkey:"root"),l=s?t.getModelState(s):0;return _(z("iBizDraggable"),{class:{[n.b("drag-container")]:!0,...s?ge.getDraggableContainerClass(s,n):{}},style:s?ge.getFlexLayoutStyle(s):{},itemKey:"srfkey",handle:".handle",key:o,group:{name:"dnd-design",put:ve.isEnableDrop(l)},"ghost-class":n.b("ghost"),list:e,onChange:i=>t.change(i,e,s)},{item:n=>{var o;let l;const c=n.element,d=t.providers[c.srfkey];if(!d)return null;const u=t.controllers[c.srfkey],h=z(d.component),p=t.getModelState(c);return"HIDDEN"!==c.editortype||t.state.hiddenFormItemVisible?_(z("iBizDraggableItem"),{class:s?ge.calcColClass(c,s):{},style:s?ge.calcStyle(c,s):{},controller:u,isSelect:(null==(o=i.value)?void 0:o.srfkey)===c.srfkey,key:c.srfkey,item:c,actions:u.actions,modelState:p,isShowMask:t.isShowMask(c),isShowLogicButton:!!t.state.logicMap[c.srfkey],onClick:e=>((e,i)=>{e.stopPropagation(),t.view.select.set(i)})(e,c),onAction:i=>{"logic"!==i.command?u.onAction(i).then((n=>{!1===n&&"delete"===i.command&&t.remove(e,c)})):t.openLogicView(c)}},"function"==typeof(m=l=Y(h,{controller:u,dndDesignController:t},a?a(e,c):c.children?()=>r(c.children,c):void 0))||"[object Object]"===Object.prototype.toString.call(m)&&!q(m)?l:{default:()=>[l]}):null;var m}})};return H("dndDesignRenderItems",r),{ns:n,shellNS:s,theme:a,renderItems:r,renderFormPage:()=>_(z("iBizDndDesignFormPage"),{key:t.state.uuid,items:t.state.items,dndDesignController:t,select:i.value,onChange:e=>t.change(e,t.state.items),onRemove:e=>t.remove(t.state.items,e),onSelect:e=>{t.view.select.set(e)}},{default:e=>(e.children||(e.children=[]),r(e.children,e))}),onActiveRoot:e=>{e.stopPropagation(),t.view.call("onActiveRoot")}}},render(){return _("div",{class:[this.ns.b(),this.ns.m(this.theme),this.shellNS.b()],onClick:e=>{this.onActiveRoot(e)}},[_("div",{class:this.ns.b("container")},[this.renderFormPage()])])}}),Je={install(e){e.component("IBizDndDesignPanelItem",We),u("RAWITEM_DND_DESIGN_PANEL_ITEM",(()=>new Xe))}},Ze=Object.defineProperty,$e=(e,t,i)=>(((e,t,i)=>{t in e?Ze(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class Qe extends o{constructor(){super(...arguments),$e(this,"items",[]),$e(this,"filterValue","")}}var et=Object.defineProperty,tt=(e,t,i)=>(((e,t,i)=>{t in e?et(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class it extends l{constructor(){super(...arguments),tt(this,"codeList"),tt(this,"codeItems",[]),tt(this,"enableGroup",!1),tt(this,"buttonGroupMap",new Map)}createState(){var e;return new Qe(null==(e=this.parent)?void 0:e.state)}get view(){return this.panel.view}async onInit(){await super.onInit(),await this.load(),this.view.evt.on("onStencilSearch",(e=>{const t=e.eventArg||"";this.state.filterValue=t.trim().toLowerCase(),this.filter()}))}async load(){const e=this.model.editor;if(e){const{appCodeListId:t}=e;if(t){const e=await ibiz.hub.getApp(this.model.appId);this.codeList=e.codeList.getCodeList(t)}if(!this.codeList)throw new A(this.model,"未配置素材区代码表");this.codeItems=this.codeList.codeItems||[];const i=this.codeItems.findIndex((e=>!!(e.codeItems&&e.codeItems.length>1)));this.enableGroup=-1!==i,this.state.items=this.codeItems,this.filter()}else ibiz.log.warn("拖拽素材区控制器的 editor 为空")}filter(){this.state.filterValue?this.enableGroup?(this.state.items=[],this.codeItems.forEach((e=>{const t={...e};Array.isArray(t.codeItems)||(t.codeItems=[]),t.codeItems=t.codeItems.filter((e=>e.text&&e.text.toLowerCase().includes(this.state.filterValue))),this.state.items.push(t)}))):this.state.items=this.codeItems.filter((e=>e.text&&e.text.toLowerCase().includes(this.state.filterValue))):this.state.items=this.codeItems}async onActionClick(e,t){const i=e.uiactionId;await d.execAndResolved(i,{context:this.panel.context,params:this.panel.params,data:[],view:this.panel.view,event:t},e.appId)}}var nt=Object.defineProperty,st=(e,t,i)=>(((e,t,i)=>{t in e?nt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class at{constructor(){st(this,"component","IBizDndStencilPanelItem")}async createController(e,t,i){const n=new it(e,t,i);return await n.init(),n}}const rt=new h(t.meta.url);var ot=F({name:"IBizDndStencilPanelItem",props:{modelData:{type:Object,required:!0},controller:{type:it,required:!0}},setup(e){const t=ee("dnd-stencil"),i=e=>{const t=JSON.parse(e.data||"{}");return t.srftype=t.detailtype,t},n=e=>{const t=e.item;t&&t.style.setProperty("--svg-visibility","hidden")},s=e=>{const t=e.item;t&&t.style.setProperty("--svg-visibility","")},a=async(t,i)=>{await e.controller.onActionClick(t,i)},r=e=>{if(e){if(e.startsWith("http"))return _("img",{src:e},null);if(e.endsWith("</svg>")){const t=URL.createObjectURL(new Blob([e],{type:"image/svg+xml;charset=utf-8"}));return _("img",{src:t},null)}return e.startsWith("data:image")?_("img",{src:e},null):_("ion-icon",{src:rt.dir(e)},null)}};return{ns:t,renderGroup:(o,l,c,d)=>{const u=e.controller.buttonGroupMap.get(d),h=u&&u.model,p=u&&u.state,m=h&&h.uiactionGroup;return _(z("el-collapse-item"),{title:o,name:c.toString()},{title:()=>_("div",{class:t.b("group-header")},[_("div",{class:t.b("group-header-text")},[o]),m&&p?_(z("iBizActionToolbar"),{class:t.b("group-header-toolbar"),actionDetails:m.uiactionGroupDetails,actionsState:p,onActionClick:a,caption:m.name,mode:"ITEMS"===h.actionGroupExtractMode?"dropdown":"buttons"},null):null]),default:()=>0===l.length?_("div",{class:t.bm("drag-container","empty")},[K("暂无数据")]):_(z("iBizDraggable"),{itemKey:"dnd-stencil",sort:!1,group:{name:"dnd-design",pull:"clone",put:!1},class:t.b("drag-container"),list:l,clone:i,onStart:n,onEnd:s},{item:n=>{const s=n.element;return _("div",{key:n.index,class:[t.b("handle")],title:s.text,onDblclick:t=>{var n;t.stopPropagation(),null==(n=e.controller.view)||n.evt.emit("onStencilAdd",{stencil:i(s)})}},[_("svg",{class:t.be("handle","svg"),height:"100%",width:"100%",xmlns:"http://www.w3.org/2000/svg"},[_("rect",{height:"100%",width:"100%"},null)]),_("div",{class:[t.b("handle-content")]},[_("div",{class:[t.be("handle","icon")]},[s.iconPath?r(s.iconPath):null]),_("div",{class:[t.be("handle","text")]},[s.text])])])}})})},clone:i,actives:["0","1","2","3","4","5","6","7","8","9"]}},render(){const e=[];return this.controller.enableGroup?this.controller.state.items.forEach(((t,i)=>{e.push(this.renderGroup(t.text,t.codeItems||[],i,t.codeName))})):e.push(this.renderGroup(this.controller.codeList.name,this.controller.state.items,0,this.controller.codeList.codeName)),_("div",{class:this.ns.b()},[_(z("el-collapse"),{modelValue:this.actives,"onUpdate:modelValue":e=>this.actives=e},(t=e,"function"==typeof t||"[object Object]"===Object.prototype.toString.call(t)&&!q(t)?e:{default:()=>[e]}))]);var t}}),lt={install(e){e.component("IBizDndStencilPanelItem",ot),u("FIELD_DND_PANEL_ITEM_STENCIL",(()=>new at))}},ct=Object.defineProperty,dt=(e,t,i)=>(((e,t,i)=>{t in e?ct(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class ut extends o{constructor(){super(...arguments),dt(this,"items",[])}}class ht extends p{get srftext(){let e=this.caption;const t=this.psdefformitemname||this.psdefuimodename,i=this.psdeformdetailname||this.psdefname;if("FORMITEM"===this.detailtype){const n=this.logicname;return j(e)&&N(n)&&j(t)&&(e=n),N(e)?N(t)?"".concat(e,"(").concat(i,")[").concat(t,"]"):"".concat(e,"(").concat(i,")"):N(t)?"".concat(i,"(").concat(t,")"):i}return N(e)?"".concat(e,"(").concat(i,")"):i}get srftype(){return this.detailtype}set srftype(e){this.detailtype=e}get srfpkey(){return this.ppsdeformdetailid}set srfpkey(e){this.ppsdeformdetailid=e}get srfordervalue(){return this.ordervalue}set srfordervalue(e){this.ordervalue=e}clone(){const e=new ht(this._entity,this._data);return e.srfkey=this.srfkey,e.srfordervalue=this.srfordervalue,e}assign(e){return void 0===e.srfordervalue&&(e.srfordervalue=this.srfordervalue),super.assign(e)}}class pt extends p{constructor(e,t,i){super(e,t),Object.defineProperty(this,"_typeCodeItems",{enumerable:!1,configurable:!0,value:i})}get srftext(){return"GROUP"===this.srftype?"".concat(this.groupop||""):"".concat(this.fdname||""," ").concat(this.psdbvalueopname||""," ").concat(this.condvalue||"")}get srftype(){return this.logictype}set srftype(e){this.logictype=e}get srficon(){const e=this._typeCodeItems.find((e=>e.value===this.srftype));return e?e.sysImage:void 0}get srfallowdrop(){return"GROUP"===this.srftype}clone(){const e=new pt(this._entity,this._data,this._typeCodeItems);return e.srfkey=this.srfkey,e}}var mt=Object.defineProperty,ft=(e,t,i)=>(((e,t,i)=>{t in e?mt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class gt{constructor(e){ft(this,"entity"),ft(this,"parent",null),ft(this,"children",[]),this.entity=e}get id(){return this.entity.srfkey||""}get text(){return this.entity.srftext||""}get type(){return this.entity.srftype||""}}var vt=Object.defineProperty,yt=(e,t,i)=>(((e,t,i)=>{t in e?vt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class bt extends l{constructor(){super(...arguments),yt(this,"codeList"),yt(this,"service"),yt(this,"form"),yt(this,"evt",new m),yt(this,"items",[]),yt(this,"timer",null),yt(this,"isDisableMessage",!1),yt(this,"codeItemList",[])}get view(){return this.panel.view}createState(){var e;return new ut(null==(e=this.parent)?void 0:e.state)}async onInit(){await super.onInit();const e=n(this.panel.view.model,"item");if(!e)throw new A(this.panel.view,"未找到 item 表单模型");this.form=e;const t=await ibiz.hub.getApp(this.model.appId);this.service=await t.deService.getService(this.panel.context,e.appDataEntityId);const i=this.model.editor;if(i){const{appCodeListId:e}=i;if(e&&(this.codeList=t.codeList.getCodeList(e)),!this.codeList)throw new A(this.model,"未配置结构区代码表");const n=this.codeList.codeItems||[],s=[];n.forEach((e=>{const t=e.value,i=e.codeItems;if(t&&Array.isArray(i)){const e=new Map;i.forEach((t=>{const i=t.value;i&&e.set(i,t)})),s.push({key:t,map:e})}})),this.codeItemList=s}this.view.evt.on("onSaveSuccess",(async()=>{await this.load()})),await this.load(),this.subscribeMessage()}getNodeIcon(e){const t=e.entity;for(let e=0;e<this.codeItemList.length;e++){const i=this.codeItemList[e],{key:n,map:s}=i,a=t[n];if(a&&s.get(a))return s.get(a).iconPath}}onDataUpdate(e){if(!this.isDisableMessage&&e.data&&"object"==typeof e.data){const t=e.data;if(t.srfkey){const e=this.items.findIndex((e=>e.srfkey===t.srfkey));-1!==e&&(this.items.splice(e,1),this.items.push(t),this.timer&&window.clearTimeout(this.timer),this.timer=window.setTimeout((()=>{this.items=L(this.items,"srfordervalue"),this.state.items=this.transformItemsToTree(this.items),this.evt.emit("updateSelect")}),50))}}}onDataCreate(e){if(!this.isDisableMessage&&e.messageid===this.panel.context.srfsessionid&&e.data&&"object"==typeof e.data){const t=e.data;t.srfkey&&(this.items.push(t),this.items=L(this.items,"srfordervalue"),this.state.items=this.transformItemsToTree(this.items),this.evt.emit("updateSelect"))}}onDataRemove(e){if(!this.isDisableMessage&&e.data&&"object"==typeof e.data){const t=e.data;if(t.srfkey){const e=this.items.findIndex((e=>e.srfkey===t.srfkey));-1!==e&&(this.items.splice(e,1),this.items=L(this.items,"srfordervalue"),this.state.items=this.transformItemsToTree(this.items),this.evt.emit("updateSelect"))}}}sendMessage(e,t,i){this.isDisableMessage=!0,e.forEach((e=>{t?ibiz.mc.command.send(e,t):i&&ibiz.mc.command.next({...i,data:e})})),this.isDisableMessage=!1}subscribeMessage(){this.onDataUpdate=this.onDataUpdate.bind(this),this.onDataCreate=this.onDataCreate.bind(this),this.onDataRemove=this.onDataRemove.bind(this),this.load=this.load.bind(this),this.view.evt.on("onRefreshView",this.load),ibiz.mc.command.update.on(this.onDataUpdate),ibiz.mc.command.create.on(this.onDataCreate),ibiz.mc.command.remove.on(this.onDataRemove)}unsubscribeMessage(){this.view.evt.off("onRefreshView",this.load),ibiz.mc.command.update.off(this.onDataUpdate),ibiz.mc.command.create.off(this.onDataCreate),ibiz.mc.command.remove.off(this.onDataRemove)}destroy(){super.destroy(),this.unsubscribeMessage()}async load(){const e=await this.service.fetchDefault(this.panel.context);if(e.ok&&Array.isArray(e.data)){const t=L(e.data,"srfordervalue");this.items=t,this.state.items=this.transformItemsToTree(t)}else this.state.items=[]}transformItemsToTree(e){const t={},i=[];return e.forEach((e=>{const i=e.srfkey;i&&(t[i]=new gt(e))})),e.forEach((e=>{const n=t[e.srfkey];if(n)if(e.srfpkey){const i=e.srfpkey?t[e.srfpkey]:null;i&&(n.parent=i,i.children.push(n))}else n.parent=null,i.push(n)})),i}change(e,t,i){i?(e.parent=i,e.entity.srfpkey=i.entity.srfkey):(e.parent=null,e.entity.srfpkey=void 0),this.move(t.map((e=>e.entity)),0,t.length-1)}async move(e,t,i){const n=t>i?i:t,s=t>i?t:i,a=[];e.forEach(((e,t)=>{t>=n&&t<=s&&(e.srfordervalue=10*(t+1),a.push(e))}));const r=await this.service.update(this.panel.context,a);r.ok&&(Array.isArray(r.data)&&this.sendMessage(r.data,"OBJECTUPDATED"),ibiz.log.debug("排序成功"))}}var wt=F({name:"IBizDndStructurePanelItem",props:{modelData:{type:Object,required:!0},controller:{type:bt,required:!0}},setup(e){const t=ee("dnd-structure"),i=U(null),n=U("");V(n,(()=>{i.value&&i.value.filter(n.value)}));const s=e=>{if(i.value){if(e){if(i.value.getNode(e.srfkey))return void i.value.setCurrentKey(e.srfkey)}i.value.setCurrentKey()}};e.controller.view.select.on((e=>{s(e)})),X((()=>{s(e.controller.view.select.data)}));const a=()=>{J((()=>{s(e.controller.view.select.data)}))};e.controller.evt.on("updateSelect",a);return W((()=>{e.controller.evt.off("updateSelect",a)})),{ns:t,tree:i,searchValue:n,filterNode:(e,t)=>{if(!e)return!0;const i=e.trim().toLowerCase();return t.text.includes(i)},onCurrentNodeChange:t=>{t&&e.controller.view.select.set(t.entity)},allowDrag:e=>{const t=e.data;if(0===e.level||"FORMPAGE"===t.type)return!1;if(!n.value)return!0;return!n.value.trim().toLowerCase()},allowDrop:(e,t,i)=>{const n=e.data,s=t.data;if("inner"===i){return!!["GROUPPANEL","FORMPAGE"].includes(s.type)}return 0!==t.level&&("FORMPAGE"!==s.type||"FORMPAGE"===n.type)},onNodeDrop:(t,i,n)=>{const s=t.data,a=i.data;if("inner"===n)return void e.controller.change(s,a.children,a);const r=a.parent;r?e.controller.change(s,r.children,r):e.controller.change(s,e.controller.state.items)}}},render(){return _("div",{class:this.ns.b()},[_("div",{class:this.ns.b("header")},[_(z("el-input"),{modelValue:this.searchValue,"onUpdate:modelValue":e=>this.searchValue=e,"prefix-icon":_("ion-icon",{name:"search-outline"},null),clearable:!0},null)]),_("div",{class:this.ns.b("content")},[_(z("el-tree"),{ref:"tree",data:this.controller.state.items,"node-key":"id",props:{label:"text",children:"children"},indent:8,draggable:!0,"default-expand-all":!0,"expand-on-click-node":!1,"highlight-current":!0,"filter-node-method":this.filterNode,onCurrentChange:this.onCurrentNodeChange,"allow-drag":this.allowDrag,"allow-drop":this.allowDrop,onNodeDrop:this.onNodeDrop},{default:({data:e})=>{const t=this.controller.getNodeIcon(e);return _("div",{class:this.ns.b("node")},[_("div",{class:this.ns.be("node","icon")},[t?_("ion-icon",{src:rt.dir(t)},null):null]),_("div",{class:this.ns.be("node","text"),title:e.text},[e.text])])}})])])}}),It=Object.defineProperty,Dt=(e,t,i)=>(((e,t,i)=>{t in e?It(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class Et{constructor(){Dt(this,"component","IBizDndStructurePanelItem")}async createController(e,t,i){const n=new bt(e,t,i);return await n.init(),n}}var Pt={install(e){e.component("IBizDndStructurePanelItem",wt),u("FIELD_DND_PANEL_STRUCTURE",(()=>new Et))}};class Ot extends l{get view(){return this.panel.view}sendMessage(e){this.view.evt.emit("onStencilSearch",{eventArg:e})}}var Ct=F({name:"IBizDndStencilSearchInput",props:{modelData:{type:Object,required:!0},controller:{type:Ot,required:!0}},setup(e){const t=ee("dnd-stencil-search-input"),i=U("");return V(i,(()=>{e.controller.sendMessage(i.value)})),{ns:t,searchValue:i}},render(){return _("div",{class:this.ns.b()},[_(z("el-input"),{modelValue:this.searchValue,"onUpdate:modelValue":e=>this.searchValue=e,placeholder:"输入关键词进行过滤","prefix-icon":_("ion-icon",{name:"search-outline"},null),clearable:!0},null)])}}),xt=Object.defineProperty,St=(e,t,i)=>(((e,t,i)=>{t in e?xt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class At{constructor(){St(this,"component","IBizDndStencilSearchInput")}async createController(e,t,i){const n=new Ot(e,t,i);return await n.init(),n}}var Tt={install(e){e.component("IBizDndStencilSearchInput",Ct),u("FIELD_DND_PANEL_ITEM_STENCIL_SEARCH",(()=>new At))}},Mt=F({name:"IBizHiddenFormItemSwitch",props:{modelData:{type:Object,required:!0},controller:{type:l,required:!0}},setup:e=>({ns:ee("hidden-form-item-switch"),isActive:U(!0),activeText:"显示",inactiveText:"隐藏",handleChange:t=>{var i;const n=e.controller.panel.view;if(!n)return;const s=null==(i=n.layoutPanel)?void 0:i.panelItems.dnd_design_panel_item;s&&s.updateHiddenFormItemVisible(t)}}),render(){return _("div",{class:this.ns.b()},[_(z("el-switch"),{modelValue:this.isActive,"onUpdate:modelValue":e=>this.isActive=e,"active-text":this.activeText,"inactive-text":this.inactiveText,"inline-prompt":!0,size:"large",title:"".concat(this.isActive?this.inactiveText:this.activeText,"隐藏表单项"),onChange:this.handleChange},null)])}}),Rt=Object.defineProperty,kt=(e,t,i)=>(((e,t,i)=>{t in e?Rt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class Lt{constructor(){kt(this,"component","IBizHiddenFormItemSwitch")}async createController(e,t,i){const n=new l(e,t,i);return await n.init(),n}}var jt={install(e){e.component(Mt.name,Mt),u("FIELD_HIDDEN_FORM_ITEM_SWITCH",(()=>new Lt))}},Nt=F({name:"IBizFormPreviewContent",props:{modelData:{type:Object,required:!0},controller:{type:Object,required:!0}},setup:()=>({ns:ee("form-preview-content")}),render(){return _("div",{class:this.ns.b()},[_(z("iBizFormShell"),{data:this.controller.majorData,items:this.controller.state.items,context:this.controller.panel.context},null)])}});class Ft extends C{}class Bt extends x{createState(){var e;return new Ft(null==(e=this.parent)?void 0:e.state)}async initItems(){const e=this.majorData.psdeformdetails||[];M({psdeformdetails:e},(e=>{this.view.preViewProvider.getTargetDataBySourceData("FORMDETAIL",[e])}),{childrenFields:["psdeformdetails"]}),this.state.items=e}}var _t=Object.defineProperty,zt=(e,t,i)=>(((e,t,i)=>{t in e?_t(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class Ut{constructor(){zt(this,"component","IBizFormPreviewContent")}async createController(e,t,i){const n=new Bt(e,t,i);return await n.init(),n}}var Vt={install(e){e.component("IBizFormPreviewContent",Nt),u("RAWITEM_FORM_PREVIEW",(()=>new Ut))}},Gt={install(e){e.component("IBizDraggable",se),e.use(Je),e.use(lt),e.use(Pt),e.use(Tt),e.use(jt),e.use(Vt)}},Ht=Object.defineProperty,Yt=(e,t,i)=>(((e,t,i)=>{t in e?Ht(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class qt{constructor(e,t,i){Yt(this,"actions",[{icon:_("ion-icon",{src:rt.dir("./assets/svg/lightning.svg")},null),text:"表单项逻辑",tooltip:"表单项逻辑",command:"logic"},{icon:_("ion-icon",{name:"trash-outline"},null),text:"删除",tooltip:"删除",command:"delete"}]),this.c=e,this.data=i,this.model=t,this.select=e.view.select}async onAction(e){return!1}destroy(){}change(e,t,i){this.c.change(e,t,i)}async remove(e,t){return this.c.remove(e,t)}getItemCaption(){const e=this.c.view.getPreViewProvider();let t=re(this.data);return e&&this.data&&(t=e.getTargetDataBySourceData("FORMDETAIL",[t])[0]),t.caption}}var Kt=F({name:"IBizDndDesignFormItem",props:{controller:{type:qt,required:!0}},setup(e){const t=ee("dnd-design-form-item"),i=()=>{const t=e.controller.data;return _(z("el-input"),{placeholder:t.srftext,disabled:!0},null)},n=()=>{const n=e.controller.data,s=(()=>{const t=e.controller.data;if(t&&t.rawcssstyle){const e=t.rawcssstyle.split("\n"),i=[];for(let t=0;t<e.length;t++)i.push(...e[t].split(";").filter((e=>e)));return i.filter((e=>2===e.split(":").length)).join(";")}})(),a="".concat(n.srftext),r=new Date;if(n)switch(n.editortype){case"HIDDEN":return _("div",{style:"padding-left: 10px;",class:"design-item-hidden"},[K("隐藏表单项")]);case"SPAN":return _("span",{style:"padding-left: 10px;".concat(s),class:"design-design-editor"},[a]);case"RADIOBUTTONLIST":return _(z("el-radio-group"),{"model-value":"",disabled:!0},{default:()=>[_(z("el-radio"),{label:"1"},{default:()=>[K("选项一")]}),_(z("el-radio"),{label:"2"},{default:()=>[K("选项二")]}),_(z("el-radio"),{label:"3"},{default:()=>[K("选项三")]})]});case"ADDRESSPICKUP":case"ADDRESSPICKUP_AC":return _(z("el-select"),{mode:"tags",style:"width: 100%",placeholder:a,disabled:!0},{default:()=>[_(z("el-option"),{value:"1"},{default:()=>[K("选项一")]}),_(z("el-option"),{value:"2"},{default:()=>[K("选项二")]}),_(z("el-option"),{value:"3"},{default:()=>[K("选项三")]})]});case"TEXTAREA":return _(z("el-input"),{placeholder:a,style:n.ctrlheight?"height: ".concat(n.ctrlheight,"px;"):"",class:t.e("textarea"),type:"textarea",rows:1,disabled:!0},null);case"TEXTAREA_10":return _(z("el-input"),{placeholder:a,rows:10,type:"textarea",disabled:!0},null);case"PASSWORD":return _(z("el-input"),{placeholder:a,disabled:!0},null);case"DATEPICKEREX":case"DATEPICKEREX_SECOND":case"DATEPICKER":return _(z("el-date-picker"),{class:t.e("datepicker"),"model-value":ae(r).format("YYYY-MM-DD HH:mm:ss"),format:"YYYY-MM-DD HH:mm:ss",disabled:!0},null);case"DATEPICKEREX_MINUTE":return _(z("el-date-picker"),{class:t.e("datepicker"),"model-value":ae(r).format("YYYY-MM-DD HH:mm"),format:"YYYY-MM-DD HH:mm",disabled:!0},null);case"DATEPICKEREX_NODAY":return _(z("el-date-picker"),{class:t.e("datepicker"),"model-value":r,format:"HH:mm:ss",disabled:!0},null);case"DATEPICKEREX_NODAY_NOSECOND":return _(z("el-date-picker"),{class:t.e("datepicker"),"model-value":r,format:"HH:mm",disabled:!0},null);case"DATEPICKEREX_NOTIME":return _(z("el-date-picker"),{class:t.e("datepicker"),"model-value":ae(r).format("YYYY-MM-DD"),format:"YYYY-MM-DD",disabled:!0},null);case"DATEPICKEREX_HOUR":return _(z("el-date-picker"),{class:t.e("datepicker"),"model-value":ae(r).format("YYYY-MM-DD HH"),format:"YYYY-MM-DD HH",disabled:!0},null);case"TEXTBOX":return _(z("el-input"),{style:s,placeholder:a,disabled:!0},null);case"FILEUPLOADER":return _(z("el-button"),{disabled:!0,class:t.e("fileuploader")},{default:()=>[_("ion-icon",{name:"cloud-upload-outline"},null),a]});case"AC":case"AC_NOBUTTON":case"AC_FS_NOBUTTON":case"AC_FS":case"PICKEREX_LINKONLY":case"PICKER":case"PICKUPVIEW":case"PICKEREX_LINK":case"PICKEREX_NOAC_LINK":case"PICKEREX_NOAC":case"PICKEREX_NOBUTTON":case"PICKEREX_TRIGGER_LINK":case"PICKEREX_TRIGGER":case"DROPDOWNLIST":case"MDROPDOWNLIST":return _(z("el-select"),{"model-value":"选项一",style:"width: 100%",disabled:!0},{default:()=>[_(z("el-option"),{value:"选项一"},{default:()=>[K("选项一")]}),_(z("el-option"),{value:"选项二"},{default:()=>[K("选项二")]}),_(z("el-option"),{value:"选项三"},{default:()=>[K("选项三")]})]});case"DROPDOWNLIST_100":return _(z("el-select"),{"model-value":"选项一",style:"width: 100px",disabled:!0},{default:()=>[_(z("el-option"),{value:"选项一"},{default:()=>[K("选项一")]}),_(z("el-option"),{value:"选项二"},{default:()=>[K("选项二")]}),_(z("el-option"),{value:"选项三"},{default:()=>[K("选项三")]})]});case"CHECKBOX":return _(z("el-checkbox"),{disabled:!0},{default:()=>[K("选项")]});case"CHECKBOXLIST":return _(z("el-checkbox-group"),{disabled:!0},{default:()=>[_(z("el-checkbox"),{disabled:!0},{default:()=>[K("选项一")]}),K(";"),_(z("el-checkbox"),{disabled:!0},{default:()=>[K("选项二")]}),K(";")]});case"NUMBER":return _(z("el-input-number"),{class:t.e("number"),style:"width: 100%",disabled:!0},null);case"USERCONTROL":return _("span",null,[K("用户自定义")]);case"RATING":return _(z("el-rate"),{"text-color":"#ff9900","model-value":4,disabled:!0},null);case"SLIDER":return _(z("el-slider"),{"model-value":30,"show-input":!0,class:t.e("slider")},null);case"DATERANGE":return _(z("el-date-picker"),{"model-value":[r,r],type:"datetimerange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",format:"YYYY-MM-DD HH:mm:ss",disabled:!0,class:t.e("daterange")},null);case"ARRAY":return _("div",{class:t.e("panel-array-input")},[_(z("el-input"),{placeholder:a,disabled:!0},null),_(z("el-button"),{type:"primary",circle:!0,class:t.e("panel-array-input-add-button")},{default:()=>[_("ion-icon",{name:"add-outline"},null)]}),_(z("el-button"),{type:"danger",circle:!0,class:t.e("panel-array-input-remove-button")},{default:()=>[_("ion-icon",{name:"remove-outline"},null)]})]);case"MAPPICKER":return _(z("el-cascader"),{class:t.e("mappicker"),options:[{value:"省",label:"省",children:[{value:"市",label:"市",children:[{value:"区",label:"区"}]}]}],"model-value":["省","市","区"],disabled:!0},null);case"SWITCH":return _(z("el-switch"),{disabled:!0},null);default:return i()}return i()};return{ns:t,renderDesignItem:n,renderContent:()=>{const i=e.controller.data,s=e.controller.getItemCaption(),a=i,r=a.labelpos?a.labelpos.toLowerCase():"left",o=Object.is(r,"top")||Object.is(r,"bottom")?"":"width: ".concat(a.labelwidth||130,"px;"),l=((e,t)=>{let i="";return Object.is(t,"none")||Object.is(t,"top")||Object.is(t,"bottom")||"0"===e.showcaption?e.ctrlwidth?i+="width: ".concat(e.ctrlwidth,"px;"):i+="width: 100%;":e.ctrlwidth?i+="width: ".concat(e.ctrlwidth,"px;"):i+="width: calc(100% - ".concat(e.labelwidth||130,"px);"),e.ctrlheight?i+="height: ".concat(e.ctrlheight,"px;"):i+="height: 100%;",i})(a,r);return"FIELD"===a.itemtype?_("div",{class:"design-form-item ".concat(r||"left")},[_("div",{class:t.e("container-content"),style:{width:"100%",height:"100%"}},[n()])]):_("div",{class:"".concat(t.e("item-content")," ").concat(t.em("item-content",r||"left"))},["0"==a.showcaption?null:_("div",{class:t.e("label-content"),style:o},["1"==a.emptycaption?null:_("label",{class:t.e("label")},[Object.is(r,"right")?"：":"",s||"",Object.is(r,"right")?"":"："])]),_("div",{class:t.e("container-content"),style:l},[n()])])}}},render(){return _("div",{class:this.ns.b()},[_("div",{class:this.ns.e("wrapper")},null),this.renderContent()])}}),Xt=Object.defineProperty,Wt=(e,t,i)=>(((e,t,i)=>{t in e?Xt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class Jt{constructor(){Wt(this,"type","PSDEFORMDETAIL_FORMITEM"),Wt(this,"component","IBizDndDesignFormItem")}createController(e,t,i){return new qt(e,t,i)}}var Zt={install(e){e.component(Kt.name,Kt);const t=new Jt;de.registerItemProvider(t.type,t)}};function $t(){return Z("dndDesignRenderItems")}var Qt=F({name:"IBizDndDesignFormPanel",props:{controller:{type:qt,required:!0}},setup:()=>({ns:ee("dnd-design-group-panel"),renderItems:$t()}),render(){const e=this.controller.data,t=0===e.showcaption;return _("div",{class:this.ns.b()},[t?_("div",{class:this.ns.b("info")},[e.srftext||""]):_("div",{class:this.ns.b("header")},[_("div",null,[_("div",{class:this.ns.be("header","text")},[e.srftext||""]),_("ion-icon",{class:this.ns.be("header","icon"),name:"caret-down"},null)])]),_("div",{class:this.ns.b("content")},[this.renderItems(e.children,e)])])}}),ei=Object.defineProperty,ti=(e,t,i)=>(((e,t,i)=>{t in e?ei(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class ii{constructor(){ti(this,"type","PSDEFORMDETAIL_GROUPPANEL"),ti(this,"component","IBizDndDesignFormPanel")}createController(e,t,i){return new qt(e,t,i)}}var ni={install(e){e.component(Qt.name,Qt);const t=new ii;de.registerItemProvider(t.type,t)}};var si=F({name:"IBizDndDesignRawItem",props:{controller:{type:qt,required:!0}},setup(e){const t=ee("dnd-design-raw-item");return{ns:t,renderContent:()=>{switch(e.controller.data.contenttype){case"RAW":return(()=>{const i=e.controller.data;return _("div",{class:t.e("raw")},[i.rawcontent||i.srftext||""])})();case"HTML":return(()=>{const i=e.controller.data;return i.htmlcontent?_("div",{class:t.e("html"),innerHTML:i.htmlcontent},null):_("div",{class:t.e("html")},[i.srftext||""])})();case"IMAGE":return _("div",{class:t.e("image")},[_("svg",{width:"56px",height:"56px",viewBox:"0 0 56 56",version:"1.1",xmlns:"http://www.w3.org/2000/svg"},[_("g",{stroke:"none","stroke-width":"1",fill:"none","fill-rule":"evenodd"},[_("g",{id:"image-fill",transform:"translate(4.000000, 0.000000)",style:"fill: currentColor;","fill-rule":"nonzero"},[_("rect",{id:"矩形",opacity:"0",x:"0",y:"0",width:"48",height:"48"},null),_("path",{d:"M43.5,7.5 L4.5,7.5 C3.6703125,7.5 3,8.1703125 3,9 L3,39 C3,39.8296875 3.6703125,40.5 4.5,40.5 L43.5,40.5 C44.3296875,40.5 45,39.8296875 45,39 L45,9 C45,8.1703125 44.3296875,7.5 43.5,7.5 Z M15.84375,14.25 C17.4984375,14.25 18.84375,15.5953125 18.84375,17.25 C18.84375,18.9046875 17.4984375,20.25 15.84375,20.25 C14.1890625,20.25 12.84375,18.9046875 12.84375,17.25 C12.84375,15.5953125 14.1890625,14.25 15.84375,14.25 Z M39.9328125,34.7390625 C39.8671875,34.7953125 39.778125,34.828125 39.6890625,34.828125 L8.30625,34.828125 C8.1,34.828125 7.93125,34.659375 7.93125,34.453125 C7.93125,34.3640625 7.9640625,34.2796875 8.0203125,34.209375 L16.003125,24.740625 C16.134375,24.58125 16.3734375,24.5625 16.5328125,24.69375 C16.546875,24.7078125 16.565625,24.721875 16.5796875,24.740625 L21.2390625,30.271875 L28.65,21.4828125 C28.78125,21.3234375 29.0203125,21.3046875 29.1796875,21.4359375 C29.19375,21.45 29.2125,21.4640625 29.2265625,21.4828125 L39.9890625,34.2140625 C40.1109375,34.36875 40.0921875,34.6078125 39.9328125,34.7390625 Z",id:"形状"},null)])])])]);case"VIDEO":return _("div",{class:t.e("video")},[_("svg",{width:"56px",height:"56px",viewBox:"0 0 56 56",version:"1.1",xmlns:"http://www.w3.org/2000/svg"},[_("g",{stroke:"none","stroke-width":"1",fill:"none","fill-rule":"evenodd"},[_("g",{id:"video",transform:"translate(4.000000, 4.000000)","fill-rule":"nonzero"},[_("rect",{id:"矩形",style:"fill: currentColor;",opacity:"0",x:"0",y:"0",width:"48",height:"48"},null),_("rect",{id:"矩形",style:"stroke: currentColor;","stroke-width":"2",x:"5",y:"5",width:"38",height:"38",rx:"2"},null),_("path",{d:"M19.842,16.7706563 L30.3061875,22.4005313 C31.4090625,22.993875 31.822125,24.369 31.2287812,25.4717812 C30.9959833,25.9045408 30.6289074,26.2499678 30.1828125,26.4560625 L19.7187188,31.290375 C18.5818125,31.8156563 17.2343438,31.3198125 16.7090625,30.1828125 C16.571335,29.8846905 16.5,29.560211 16.5,29.2318125 L16.5,18.767625 C16.5,17.5153125 17.5153125,16.5 18.767625,16.5 C19.142625,16.5 19.5118125,16.593 19.842,16.7706563 Z",id:"形状",style:"fill: currentColor;"},null)])])])]);case"PLACEHOLDER":return _("div",{class:t.e("placeholder")},[K("占位(PLACEHOLDER)")]);case"DIVIDER":return _(z("el-divider"),{class:t.e("divider")},{default:()=>[K("分割线(DIVIDER)")]});case"INFO":return _("div",{class:t.e("info")},[K("常规提示(INFO)")]);case"WARNING":return _("div",{class:t.e("warning")},[K("警告提示(WARNING)")]);case"ERROR":return _("div",{class:t.e("error")},[K("错误提示(ERROR)")]);default:return _("div",{class:t.e("default")},[K("直接内容")])}}}},render(){return _("div",{class:this.ns.b()},[this.renderContent()])}}),ai=Object.defineProperty,ri=(e,t,i)=>(((e,t,i)=>{t in e?ai(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class oi{constructor(){ri(this,"type","PSDEFORMDETAIL_RAWITEM"),ri(this,"component","IBizDndDesignRawItem")}createController(e,t,i){return new qt(e,t,i)}}var li={install(e){e.component(si.name,si);const t=new oi;de.registerItemProvider(t.type,t)}},ci=F({name:"IBizDndDesignTabPage",setup:()=>()=>_("div",null,[K("分页面板")])}),di=Object.defineProperty,ui=(e,t,i)=>(((e,t,i)=>{t in e?di(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class hi{constructor(){ui(this,"type","PSDEFORMDETAIL_TABPAGE"),ui(this,"component","IBizDndDesignTabPage")}createController(e,t,i){return new qt(e,t,i)}}var pi={install(e){e.component(ci.name,ci);const t=new hi;de.registerItemProvider(t.type,t)}},mi=F({name:"IBizDndDesignTabPanel",props:{controller:{type:Object,required:!0},dndDesignController:{type:Object,required:!0}},setup(e){const t=ee("dnd-design-tab-panel"),i=e.controller,n=$t(),s=U(),a=U(i.select.data);i.select.on((e=>{a.value=e}));V(a,(()=>{const e=i.data.children;if(Array.isArray(e)&&e.length&&a.value){const t=e.find((e=>e.srfkey===a.value.srfkey));t&&(s.value=t.srfkey)}}),{immediate:!0});return{ns:t,activePage:s,select:a,onActivePageChange:e=>{s.value=e.srfkey,i.select.set(e)},onPagePositionChange:async e=>{const t=i.data.children;Array.isArray(t)&&i.change(e,t,i.data)},onPageAdd:async()=>{const e=i.data.children;Array.isArray(e)&&(e.push({detailtype:"TABPAGE"}),i.change({added:{element:e[e.length-1],newIndex:e.length-1}},e,i.data))},onPageRemove:async e=>{const t=i.data.children;Array.isArray(t)&&i.remove(t,e)},renderItems:n}},render(){const e=this.controller.data.children||[];return _("div",{class:this.ns.b()},[_(z("iBizDraggableTabs"),{value:this.activePage,dndDesignController:this.dndDesignController,items:e,dragSwitchPage:!1,select:this.select,class:this.ns.b("content"),onChange:this.onActivePageChange,onDragChange:this.onPagePositionChange,onAdd:this.onPageAdd,onRemove:this.onPageRemove},{default:e=>this.renderItems(e.children,e)})])}}),fi=Object.defineProperty,gi=(e,t,i)=>(((e,t,i)=>{t in e?fi(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class vi{constructor(){gi(this,"type","PSDEFORMDETAIL_TABPANEL"),gi(this,"component","IBizDndDesignTabPanel")}createController(e,t,i){return new qt(e,t,i)}}var yi={install(e){e.component(mi.name,mi);const t=new vi;de.registerItemProvider(t.type,t)}},bi=F({name:"IBizDndDesignFormPage",props:{items:{type:Array,required:!0,default:()=>[]},select:{type:Object},dndDesignController:{type:Object,required:!0}},emits:["change","remove","select"],setup(e,{emit:t}){const i=ee("dnd-design-form-page"),n=U();V((()=>e.select),(()=>{const t=e.items;if(Array.isArray(t)&&t.length&&e.select){const i=t.find((t=>t.srfkey===e.select.srfkey));i&&(n.value=i.srfkey)}}),{immediate:!0});return{ns:i,activePage:n,onActivePageChange:e=>{n.value=e.srfkey,t("select",e)},onPagePositionChange:async e=>{t("change",e)},onPageAdd:async()=>{const i=e.items;i.push({detailtype:"FORMPAGE"}),t("change",{added:{element:i[i.length-1],newIndex:i.length-1}})},onPageRemove:async e=>{t("remove",e)}}},render(){return _("div",{class:this.ns.b()},[_(z("iBizDraggableTabs"),{value:this.activePage,items:this.items,dndDesignController:this.dndDesignController,select:this.select,onChange:this.onActivePageChange,onDragChange:this.onPagePositionChange,onAdd:this.onPageAdd,onRemove:this.onPageRemove},{default:e=>{var t,i;return null==(i=(t=this.$slots).default)?void 0:i.call(t,e)}})])}}),wi={install(e){e.component(bi.name,bi)}},Ii=F({name:"IBizDndDesignButton",props:{controller:{type:qt,required:!0}},setup:()=>({ns:ee("dnd-design-button")}),render(){const e=this.controller.data;return _("div",{class:this.ns.b()},[_(z("el-button"),{class:this.ns.b("content")},{default:()=>[0!==e.showcaption?e.srftext||"":"*"]})])}}),Di=Object.defineProperty,Ei=(e,t,i)=>(((e,t,i)=>{t in e?Di(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class Pi{constructor(){Ei(this,"type","PSDEFORMDETAIL_BUTTON"),Ei(this,"component","IBizDndDesignButton")}createController(e,t,i){return new qt(e,t,i)}}var Oi={install(e){e.component(Ii.name,Ii);const t=new Pi;de.registerItemProvider(t.type,t)}},Ci=F({name:"IBizDndDesignIframe",props:{controller:{type:qt,required:!0}},setup:()=>({ns:ee("dnd-design-iframe")}),render(){const e=this.controller.data;return _("div",{class:this.ns.b()},[_("div",{class:this.ns.b("content")},[e.srftext||"",K("[直接嵌入页面（iframe）]")])])}}),xi=Object.defineProperty,Si=(e,t,i)=>(((e,t,i)=>{t in e?xi(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class Ai{constructor(){Si(this,"type","PSDEFORMDETAIL_IFRAME"),Si(this,"component","IBizDndDesignIframe")}createController(e,t,i){return new qt(e,t,i)}}var Ti={install(e){e.component(Ci.name,Ci);const t=new Ai;de.registerItemProvider(t.type,t)}},Mi=F({name:"IBizDndDesignDRUIPart",props:{controller:{type:qt,required:!0}},setup:()=>({ns:ee("dnd-design-druipart")}),render(){const e=this.controller.data;return _("div",{class:this.ns.b()},[_("div",{class:this.ns.b("content")},[e.srftext||"",K("[关系]")])])}}),Ri=Object.defineProperty,ki=(e,t,i)=>(((e,t,i)=>{t in e?Ri(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class Li{constructor(){ki(this,"type","PSDEFORMDETAIL_DRUIPART"),ki(this,"component","IBizDndDesignDRUIPart")}createController(e,t,i){return new qt(e,t,i)}}var ji={install(e){e.component(Mi.name,Mi);const t=new Li;de.registerItemProvider(t.type,t)}},Ni=F({name:"IBizDndDesignMDCtrl",props:{controller:{type:qt,required:!0}},setup:()=>({ns:ee("dnd-design-mdctrl"),renderItems:$t()}),render(){const e=this.controller.data;return _("div",{class:[this.ns.b(),this.ns.b(e.mdctrltype.toLowerCase())]},[_("div",{class:this.ns.e("info")},[e.srftext||"",K("[多数据部件]")]),"REPEATER"===e.mdctrltype&&_("div",{class:this.ns.e("content")},[this.renderItems(e.children,e)])])}}),Fi=Object.defineProperty,Bi=(e,t,i)=>(((e,t,i)=>{t in e?Fi(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class _i{constructor(){Bi(this,"type","PSDEFORMDETAIL_MDCTRL"),Bi(this,"component","IBizDndDesignMDCtrl")}createController(e,t,i){return new qt(e,t,i)}}var zi={install(e){e.component(Ni.name,Ni);const t=new _i;de.registerItemProvider(t.type,t)}},Ui=F({name:"IBizDndDesignFormItemEx",props:{controller:{type:Object,required:!0}},setup:()=>({ns:ee("dnd-design-form-item-ex")}),render(){const e=this.controller.data;return _("div",{class:this.ns.b()},[_("div",{class:this.ns.b("content")},[e.srftext||"",K("[复合表单项]")])])}}),Vi=Object.defineProperty,Gi=(e,t,i)=>(((e,t,i)=>{t in e?Vi(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class Hi{constructor(){Gi(this,"type","PSDEFORMDETAIL_FORMITEMEX"),Gi(this,"component","IBizDndDesignFormItemEx")}createController(e,t,i){return new qt(e,t,i)}}var Yi={install(e){e.component(Ui.name,Ui);const t=new Hi;de.registerItemProvider(t.type,t)}},qi=F({name:"IBizDndDesignButtonList",props:{controller:{type:qt,required:!0}},setup(e){const t=ee("dnd-design-button-list"),i=U([]),n=U(0);return V((()=>e.controller.data),((t,s)=>{n.value<=1&&(n.value+=1);const a=null==s?void 0:s.psdeuagroupid;(null==t?void 0:t.psdeuagroupid)!==a&&(async()=>{i.value=[];const t=e.controller.c.panel.context.clone(),s=e.controller.data,a=ibiz.hub.getApp(t.srfappid),r=await a.deService.getService(t,"PSDEUAGroup");if(r&&s.psdeuagroupid){t.psdeuagroup=s.psdeuagroupid;const e=await r.get(t);if(e&&e.ok&&e.data){if(n.value>1&&(!Array.isArray(e.data.psdeuagrpdetails)||!e.data.psdeuagrpdetails.length))return void ibiz.message.warning("当前绑定界面行为组未配置界面行为");Array.isArray(e.data.psdeuagrpdetails)&&(i.value=e.data.psdeuagrpdetails)}}})()}),{immediate:!0}),{ns:t,items:i}},render(){const e=this.controller.data;if(e)return e.psdeuagroupid?"ITEMS"===e.updatedvt?_("div",{class:this.ns.b()},[_("div",{class:this.ns.b("item")},[_(z("el-button"),null,{default:()=>[K("...")]})])]):_("div",{class:this.ns.b()},[this.items.map((e=>_("div",{class:this.ns.b("item")},[_(z("el-button"),null,{default:()=>[e.uacaption||""]})])))]):_("div",{class:this.ns.b()},[_("div",{class:this.ns.b("placeholder")},[_("ion-icon",{class:this.ns.be("placeholder","icon"),src:rt.dir("./assets/svg/action-button.svg")},null),_("div",{class:this.ns.be("placeholder","text")},[K("按钮组")])])])}}),Ki=Object.defineProperty,Xi=(e,t,i)=>(((e,t,i)=>{t in e?Ki(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class Wi{constructor(){Xi(this,"type","PSDEFORMDETAIL_BUTTONLIST"),Xi(this,"component","IBizDndDesignButtonList")}createController(e,t,i){return new qt(e,t,i)}}var Ji={install(e){e.component(qi.name,qi);const t=new Wi;de.registerItemProvider(t.type,t)}},Zi={install(e){e.use(Zt),e.use(ni),e.use(li),e.use(pi),e.use(yi),e.use(wi),e.use(Oi),e.use(Ti),e.use(ji),e.use(zi),e.use(Yi),e.use(Ji)}},$i=Object.defineProperty,Qi=(e,t,i)=>(((e,t,i)=>{t in e?$i(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class en extends it{constructor(){super(...arguments),Qi(this,"app"),Qi(this,"form"),Qi(this,"service"),Qi(this,"fieldForm"),Qi(this,"fieldService"),Qi(this,"fieldItems",[]),Qi(this,"items",[]),Qi(this,"enableGroup",!0),Qi(this,"mdCtrlFieldType",["ONE2MANYDATA","ONE2ONEDATA","ONE2MANYDATA_MAP","ONE2MANYOBJ","ONE2ONEOBJ","ONE2MANYOBJ_MAP"])}get view(){return this.panel.view}async onInit(){this.app=await ibiz.hub.getApp(this.model.appId);const e=n(this.panel.view.model,"item");if(!e)throw new A(this.panel.view,"未找到 item 表单模型");this.form=e,this.service=await this.app.deService.getService(this.panel.context,e.appDataEntityId);const t=n(this.panel.view.model,"EDITFORM"===this.view.state.data.formtype?"field":"uimode");if(!t)throw new A(this.panel.view,"未找到 field 表单模型");this.fieldForm=t,this.fieldService=await this.app.deService.getService(this.panel.context,t.appDataEntityId);const i=this.model.editor;if(i){const{appCodeListId:e}=i;if(e&&(this.codeList=this.app.codeList.getCodeList(e)),!this.codeList)throw new A(this.model,"未配置属性项代码表")}else ibiz.log.warn("拖拽素材区控制器的 editor 为空");await this.initButtonGroup(),this.view.evt.on("onSaveSuccess",(async()=>{await this.load()})),await super.onInit(),this.debounceTransformFieldItems=oe(this.debounceTransformFieldItems,50),this.subscribeMessage()}async initButtonGroup(){var e;if(this.fieldForm){const t=this.fieldForm.deformPages;if(!Array.isArray(t)||!t[0])return void ibiz.log.warn("field 表单模型未配置表单分页");const i=t[0].deformDetails,n=null==i?void 0:i.find((e=>"filed_group"===e.codeName));if(!n)return void ibiz.log.warn("field 表单模型未配置标识为 filed_group 表单分组");const s=await this.initActionStates(n);null==(e=this.codeList.codeItems)||e.forEach((e=>{e.codeName&&s&&this.buttonGroupMap.set(e.codeName,{model:n,state:s})}))}}async initActionStates(e){var t;const{uiactionGroup:i}=e;if(!(null==(t=null==i?void 0:i.uiactionGroupDetails)?void 0:t.length))return;const n=new f;return i.uiactionGroupDetails.forEach((e=>{const t=e.uiactionId;if(t){const i=new g(e.id,this.panel.context.srfappid,t);n.addState(e.id,i)}})),await n.update(this.panel.context),n}onDataUpdate(e){if(e.data&&"object"==typeof e.data){const t=e.data;if(t.srfkey){const e=this.items.findIndex((e=>e.srfkey===t.srfkey));-1!==e&&(this.items[e]=t,this.debounceTransformFieldItems())}}}onDataCreate(e){if(e.messageid===this.panel.context.srfsessionid&&e.data&&"object"==typeof e.data){const t=e.data;t.srfkey&&(this.items.push(t),this.transformFieldItems())}}onDataRemove(e){if(e.data&&"object"==typeof e.data){const t=e.data;if(t.srfkey){-1!==this.items.findIndex((e=>e.srfkey===t.srfkey))&&this.loadItems()}}}subscribeMessage(){this.onDataUpdate=this.onDataUpdate.bind(this),this.onDataCreate=this.onDataCreate.bind(this),this.onDataRemove=this.onDataRemove.bind(this),ibiz.mc.command.update.on(this.onDataUpdate),ibiz.mc.command.create.on(this.onDataCreate),ibiz.mc.command.remove.on(this.onDataRemove)}unsubscribeMessage(){ibiz.mc.command.update.off(this.onDataUpdate),ibiz.mc.command.remove.off(this.onDataRemove),ibiz.mc.command.create.off(this.onDataCreate)}destroy(){super.destroy(),this.unsubscribeMessage()}async load(){const e=await this.fieldService.exec("fetchcurde",this.panel.context,{n_psdeid_eq:this.view.state.data.psdeid,n_usertag4_noteq:"INTENAL"});this.state.items=this.codeList.codeItems||[],e.ok&&Array.isArray(e.data)&&(this.fieldItems=e.data,await this.loadItems())}async loadItems(){const e=await this.service.fetchDefault(this.panel.context);e.ok&&Array.isArray(e.data)&&(this.items=e.data,this.transformFieldItems())}filterFieldItems(){const e=[],t=this.view.state.data,i=this.items.map((i=>{if("FORMITEM"===i.detailtype){if("EDITFORM"===t.formtype)return"|".concat(i.psdefid);if("SEARCHFORM"===t.formtype)return"|".concat(i.psdefsfitemid)}return"MDCTRL"===i.detailtype&&i.psdefid&&e.push(i.psdefid),""})).join("");return this.fieldItems.filter((t=>this.mdCtrlFieldType.includes(t.psdatatypeid)?!e.includes(t.srfkey):!(!t.srfkey||-1!==i.indexOf("|".concat(t.srfkey)))))}debounceTransformFieldItems(){this.transformFieldItems()}transformFieldItems(){const e=this.filterFieldItems();this.state.items.forEach((t=>{const i=JSON.parse(t.data||"{}");t.codeItems=e.map((e=>{let n=e.logicname||e.caption;return(e.psdefsfitemname||e.psdefieldname)&&(n+="[".concat(e.psdefsfitemname||e.psdefieldname,"]")),"EDITFORM"===this.view.state.data.formtype?{appId:t.appId,text:n,iconPath:t.iconPath,data:JSON.stringify({...i,caption:e.logicname,logicname:e.logicname,psdefid:e.psdefieldid,psdefname:e.psdefieldname,detailtype:this.mdCtrlFieldType.includes(e.psdatatypeid)?"MDCTRL":"FORMITEM",formtype:this.view.state.data.formtype})}:{appId:t.appId,text:n,iconPath:t.iconPath,data:JSON.stringify({...i,caption:e.logicname,logicname:e.logicname,psdefsfitemid:e.psdefsfitemid,psdefsfitemname:e.psdefsfitemname,psdefname:e.psdefname,psdefid:e.psdefid,detailtype:"FORMITEM",formtype:this.view.state.data.formtype})}}))})),this.codeItems=this.state.items,this.filter()}}var tn=Object.defineProperty,nn=(e,t,i)=>(((e,t,i)=>{t in e?tn(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class sn{constructor(){nn(this,"component","IBizDndStencilPanelItem")}async createController(e,t,i){const n=new en(e,t,i);return await n.init(),n}}function an(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function rn(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function on(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?rn(Object(i),!0).forEach((function(t){an(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):rn(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function ln(e,t){if(null==e)return{};var i,n,s=function(e,t){if(null==e)return{};var i,n,s={},a=Object.keys(e);for(n=0;n<a.length;n++)i=a[n],t.indexOf(i)>=0||(s[i]=e[i]);return s}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(n=0;n<a.length;n++)i=a[n],t.indexOf(i)>=0||Object.prototype.propertyIsEnumerable.call(e,i)&&(s[i]=e[i])}return s}function cn(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,n=new Array(t);i<t;i++)n[i]=e[i];return n}function dn(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function un(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function hn(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?un(Object(i),!0).forEach((function(t){dn(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):un(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function pn(e){return function t(){for(var i=this,n=arguments.length,s=new Array(n),a=0;a<n;a++)s[a]=arguments[a];return s.length>=e.length?e.apply(this,s):function(){for(var e=arguments.length,n=new Array(e),a=0;a<e;a++)n[a]=arguments[a];return t.apply(i,[].concat(s,n))}}}function mn(e){return{}.toString.call(e).includes("Object")}function fn(e){return"function"==typeof e}var gn=pn((function(e,t){throw new Error(e[t]||e.default)}))({initialIsRequired:"initial state is required",initialType:"initial state should be an object",initialContent:"initial state shouldn't be an empty object",handlerType:"handler should be an object or a function",handlersType:"all handlers should be a functions",selectorType:"selector should be a function",changeType:"provided value of changes should be an object",changeField:'it seams you want to change a field in the state which is not specified in the "initial" state',default:"an unknown error accured in `state-local` package"}),vn={changes:function(e,t){return mn(t)||gn("changeType"),Object.keys(t).some((function(t){return i=e,n=t,!Object.prototype.hasOwnProperty.call(i,n);var i,n}))&&gn("changeField"),t},selector:function(e){fn(e)||gn("selectorType")},handler:function(e){fn(e)||mn(e)||gn("handlerType"),mn(e)&&Object.values(e).some((function(e){return!fn(e)}))&&gn("handlersType")},initial:function(e){var t;e||gn("initialIsRequired"),mn(e)||gn("initialType"),t=e,Object.keys(t).length||gn("initialContent")}};function yn(e,t){return fn(t)?t(e.current):t}function bn(e,t){return e.current=hn(hn({},e.current),t),t}function wn(e,t,i){return fn(t)?t(e.current):Object.keys(i).forEach((function(i){var n;return null===(n=t[i])||void 0===n?void 0:n.call(t,e.current[i])})),i}var In={create:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};vn.initial(e),vn.handler(t);var i={current:e},n=pn(wn)(i,t),s=pn(bn)(i),a=pn(vn.changes)(e),r=pn(yn)(i);return[function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:function(e){return e};return vn.selector(e),e(i.current)},function(e){!function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return function(e){return t.reduceRight((function(e,t){return t(e)}),e)}}(n,s,a,r)(e)}]}};var Dn,En={configIsRequired:"the configuration object is required",configType:"the configuration object should be an object",default:"an unknown error accured in `@monaco-editor/loader` package",deprecation:"Deprecation warning!\n    You are using deprecated way of configuration.\n\n    Instead of using\n      monaco.config({ urls: { monacoBase: '...' } })\n    use\n      monaco.config({ paths: { vs: '...' } })\n\n    For more please check the link https://github.com/suren-atoyan/monaco-loader#config\n  "},Pn=(Dn=function(e,t){throw new Error(e[t]||e.default)},function e(){for(var t=this,i=arguments.length,n=new Array(i),s=0;s<i;s++)n[s]=arguments[s];return n.length>=Dn.length?Dn.apply(this,n):function(){for(var i=arguments.length,s=new Array(i),a=0;a<i;a++)s[a]=arguments[a];return e.apply(t,[].concat(n,s))}})(En),On={config:function(e){var t;return e||Pn("configIsRequired"),t=e,{}.toString.call(t).includes("Object")||Pn("configType"),e.urls?(console.warn(En.deprecation),{paths:{vs:e.urls.monacoBase}}):e}};function Cn(e,t){return Object.keys(t).forEach((function(i){t[i]instanceof Object&&e[i]&&Object.assign(t[i],Cn(e[i],t[i]))})),on(on({},e),t)}var xn={type:"cancelation",msg:"operation is manually canceled"};function Sn(e){var t=!1,i=new Promise((function(i,n){e.then((function(e){return t?n(xn):i(e)})),e.catch(n)}));return i.cancel=function(){return t=!0},i}var An,Tn,Mn=In.create({config:{paths:{vs:"https://cdn.jsdelivr.net/npm/monaco-editor@0.43.0/min/vs"}},isInitialized:!1,resolve:null,reject:null,monaco:null}),Rn=(Tn=2,function(e){if(Array.isArray(e))return e}(An=Mn)||function(e,t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e)){var i=[],n=!0,s=!1,a=void 0;try{for(var r,o=e[Symbol.iterator]();!(n=(r=o.next()).done)&&(i.push(r.value),!t||i.length!==t);n=!0);}catch(e){s=!0,a=e}finally{try{n||null==o.return||o.return()}finally{if(s)throw a}}return i}}(An,Tn)||function(e,t){if(e){if("string"==typeof e)return cn(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);return"Object"===i&&e.constructor&&(i=e.constructor.name),"Map"===i||"Set"===i?Array.from(e):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?cn(e,t):void 0}}(An,Tn)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()),kn=Rn[0],Ln=Rn[1];function jn(e){return document.body.appendChild(e)}function Nn(e){var t,i,n=kn((function(e){return{config:e.config,reject:e.reject}})),s=(t="".concat(n.config.paths.vs,"/loader.js"),i=document.createElement("script"),t&&(i.src=t),i);return s.onload=function(){return e()},s.onerror=n.reject,s}function Fn(){var e=kn((function(e){return{config:e.config,resolve:e.resolve,reject:e.reject}})),t=window.require;t.config(e.config),t(["vs/editor/editor.main"],(function(t){Bn(t),e.resolve(t)}),(function(t){e.reject(t)}))}function Bn(e){kn().monaco||Ln({monaco:e})}var _n=new Promise((function(e,t){return Ln({resolve:e,reject:t})})),zn={config:function(e){var t=On.config(e),i=t.monaco,n=ln(t,["monaco"]);Ln((function(e){return{config:Cn(e.config,n),monaco:i}}))},init:function(){var e=kn((function(e){return{monaco:e.monaco,isInitialized:e.isInitialized,resolve:e.resolve}}));if(!e.isInitialized){if(Ln({isInitialized:!0}),e.monaco)return e.resolve(e.monaco),Sn(_n);if(window.monaco&&window.monaco.editor)return Bn(window.monaco),e.resolve(window.monaco),Sn(_n);!function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return function(e){return t.reduceRight((function(e,t){return t(e)}),e)}}(jn,Nn)(Fn)}return Sn(_n)},__getMonacoInstance:function(){return kn((function(e){return e.monaco}))}};const Un=F({name:"IBizFormLogicEventScript",props:te(),emits:ie(),setup(e){const t=ee("form-logic-event-script"),i=e.controller;let n,s;const a=U(!1),{UIStore:r}=ne(),o=e=>"dark"===e?"vs-".concat(r.theme):"vs";V((()=>r.theme),(e=>{s.setTheme(o(e))})),V([()=>e.readonly,()=>e.disabled],(()=>{null==n||n.updateOptions({readOnly:e.readonly||e.disabled})}),{immediate:!0});const l=U();return X((()=>{J((()=>{a.value=!0,zn.config({paths:{vs:"".concat(ibiz.env.pluginBaseUrl,"/monaco-editor@0.45.0/min/vs")}}),zn.init().then((t=>{a.value=!1,n||(s=t.editor,n=s.create(l.value,{language:e.controller.language,theme:o(r.theme),foldingStrategy:"indentation",renderLineHighlight:"all",selectOnLineNumbers:!0,minimap:{enabled:!0},readOnly:e.readonly||e.disabled,readOnlyMessage:{value:ibiz.i18n.t("editor.code.readOnlyPrompt")},fontSize:16,scrollBeyondLastLine:!1,overviewRulerBorder:!1})),setTimeout((()=>{var e;n.layout(),n.setValue(null==(e=i.logicData)?void 0:e.condvalue)})),n.onDidChangeModelContent((()=>{const e=n.getValue();i.saveScriptContent(e)})),window.addEventListener("resize",(()=>{n.layout()}))})).catch((()=>{a.value=!1}))}))})),W((()=>{null==n||n.dispose()})),{ns:t,isLoading:a,codeEditBox:l}},render(){return $(_("div",{class:[this.ns.b()]},[_("div",{ref:"codeEditBox",class:this.ns.e("box")},null)]),[[Q("loading"),this.isLoading]])}});var Vn=Object.defineProperty,Gn=(e,t,i)=>(((e,t,i)=>{t in e?Vn(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class Hn extends v{constructor(){super(...arguments),Gn(this,"logicService",null),Gn(this,"logicData",null)}get language(){return"javascript"}get theme(){return this.editorParams.theme||"vs-dark"}async onInit(){super.onInit(),await this.initService(),await this.loadScriptContent()}async initService(){const e=ibiz.hub.getApp(this.context.srfappid),t=await ibiz.hub.getAppDataEntity("PSDEFDLogic",this.context.srfappid);this.logicService=await e.deService.getService(this.context,t.id)}async loadScriptContent(){var e;const t=await(null==(e=this.logicService)?void 0:e.exec("FetchCurRootItemsByLogicCat",this.context,{logiccat:this.parent.model.userTag}));(null==t?void 0:t.ok)&&Array.isArray(t.data)&&(this.logicData=t.data[0])}async saveScriptContent(e){var t,i;const{model:n,data:s}=this.parent,a={condvalue:e,logiccat:n.userTag,logictype:"SINGLE",psdefdlogicid:null==(t=this.logicData)?void 0:t.srfkey,psdeformdetailid:s.psdeformdetailid,psdeformdetailname:s.psdeformdetailname},r=await(null==(i=this.logicService)?void 0:i.exec(a.psdefdlogicid?"update":"create",this.context,a));(null==r?void 0:r.ok)&&r.data&&(this.logicData=r.data)}}var Yn=Object.defineProperty,qn=(e,t,i)=>(((e,t,i)=>{t in e?Yn(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class Kn{constructor(){qn(this,"formEditor","IBizFormLogicEventScript"),qn(this,"gridEditor","IBizFormLogicEventScript")}async createController(e,t){const i=new Hn(e,t);return await i.init(),i}}var Xn={install(e){e.component(Un.name,Un),y("CODE_FORM_LOGIC_EVENT_SCRIPT",(()=>new Kn))}},Wn=Object.defineProperty,Jn=(e,t,i)=>(((e,t,i)=>{t in e?Wn(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class Zn extends it{constructor(){super(...arguments),Jn(this,"majorForm"),Jn(this,"majorService"),Jn(this,"editorForm"),Jn(this,"editorService"),Jn(this,"enableGroup",!0)}async onInit(){await this.initBaseResource(),await super.onInit()}async initBaseResource(){const e=ibiz.hub.getApp(this.view.model.appId),t=n(this.view.model,"form");if(!t)throw new A(this.view,"未找到 form 表单模型");this.majorForm=t,this.majorService=await e.deService.getService(this.panel.context,this.majorForm.appDataEntityId);const i=n(this.view.model,"editor");if(!i)throw new A(this.view,"未找到 editor 表单模型");this.editorForm=i,this.editorService=await e.deService.getService(this.panel.context,this.editorForm.appDataEntityId);const s=this.model.editor;if(s){const{appCodeListId:t}=s;if(t&&(this.codeList=e.codeList.getCodeList(t)),!this.codeList)throw new A(this.model,"未配置用户扩展编辑器代码表")}else ibiz.log.warn("拖拽素材区控制器的 editor 为空");await this.initButtonGroup()}async load(){const e=await this.majorService.getTemp(this.panel.context,this.panel.params);if(!e||!e.ok||!e.data)return;const t=await this.editorService.exec("FetchCurSysWithIcon",this.panel.context,this.panel.params);if(!t||!t.ok||!Array.isArray(t.data))return;const i=e.data,n=t.data.filter((e=>{const t=e.pseditortypeid;if("HIDDEN"===t||"USERCONTROL"===t||"SPAN"===t)return!0;if(i&&1==e.validflag){if(1==i.mobflag&&/^MOB/.test(t))return!0;if(1!=i.mobflag&&!/^MOB/.test(t))return!0}return!1})),s=this.codeList.codeItems||[];this.state.items=s.map((e=>{const t={...e},s=JSON.parse(t.data||"{}");return t.codeItems=n.map((e=>{let n="".concat(e.pssyseditorstylename||"");return n+=e.pseditortypename?"(".concat(e.pseditortypename,")"):"",{appId:t.appId,text:n,iconPath:e.studioicon||t.iconPath,data:JSON.stringify({...s,detailtype:"FORMITEM",formtype:i.formtype,pssyseditorstylename:e.pssyseditorstylename,pssyseditorstyleid:e.pssyseditorstyleid,editortype:e.pseditortypeid,editortypename:e.pseditortypename,width:e.width,height:e.height})}})),t})),this.codeItems=this.state.items,this.filter()}async initButtonGroup(){var e;if(this.editorForm){const t=this.editorForm.deformPages;if(!Array.isArray(t)||!t[0])return void ibiz.log.warn("editor 表单模型未配置表单分页");const i=t[0].deformDetails,n=null==i?void 0:i.find((e=>"editor_group"===e.codeName));if(!n)return void ibiz.log.warn("editor 表单模型未配置标识为 editor_group 表单分组");const s=await this.initActionStates(n);null==(e=this.codeList.codeItems)||e.forEach((e=>{e.codeName&&s&&this.buttonGroupMap.set(e.codeName,{model:n,state:s})}))}}async initActionStates(e){var t;const{uiactionGroup:i}=e;if(!(null==(t=null==i?void 0:i.uiactionGroupDetails)?void 0:t.length))return;const n=new f;return i.uiactionGroupDetails.forEach((e=>{const t=e.uiactionId;if(t){const i=new g(e.id,this.panel.context.srfappid,t);n.addState(e.id,i)}})),await n.update(this.panel.context),n}}var $n=Object.defineProperty,Qn=(e,t,i)=>(((e,t,i)=>{t in e?$n(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class es{constructor(){Qn(this,"component","IBizDndStencilPanelItem")}async createController(e,t,i){const n=new Zn(e,t,i);return await n.init(),n}}var ts={install(e){u("FIELD_DND_PANEL_ITEM_STENCIL_FIELD",(()=>new sn)),e.use(Xn),u("FIELD_DND_PANEL_ITEM_STENCIL_EDITOR",(()=>new es))}};class is extends b{async execAction(e,t){const i=t.view.layoutPanel;if(i){const e=i.panelItems;if(e){const t=e.dnd_panel_item_stencil_field;t&&await t.load()}}return{}}}var ns={install(e){w("FRONT_RefreshField",(()=>new is))}},ss=Object.defineProperty,as=(e,t,i)=>(((e,t,i)=>{t in e?ss(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class rs{constructor(){as(this,"uiModes",[]),as(this,"fields",[])}async init(e){const t=e.model,i=ibiz.hub.getApp(t.appId),s=e.context.psdataentity,a=n(t,"uimode");if(a){const t=await i.deService.getService(e.context,a.appDataEntityId),n=await t.fetchDefault(e.context,{n_psdeid_eq:s,size:1e3});n.ok&&n.data&&(this.uiModes=n.data)}const r=n(t,"field");if(r){const t=await i.deService.getService(e.context,r.appDataEntityId),n=await t.fetchDefault(e.context,{size:1e3});n.ok&&n.data&&(this.fields=n.data)}}findUIMode(e){return this.uiModes.find((t=>{if("SEARCHFORM"===e.formtype&&e.psdefsfitemid===t.psdefsfitemid||"EDITFORM"===e.formtype&&e.psdefid===t.psdefid)return t}))}getFormItemPreviewData(e){if("FORMITEM"===e.detailtype&&N(e.psdefid)){const t=this.findUIMode(e);if(t&&(j(e.caption)&&t.caption&&(e.caption=t.caption),j(e.editortype)&&t.editortype&&(e.editortype=t.editortype),j(e.ctrlheight)&&t.ctrlheight&&(e.ctrlheight=t.ctrlheight),j(e.ctrlwidth)&&t.ctrlwidth&&(e.ctrlwidth=t.ctrlwidth)),!j(e.editortype)&&!j(e.caption))return e;const i=this.fields.find((t=>{if(t.psdefieldid===e.psdefid)return t}));i&&j(e.caption)&&(e.caption=i.logicname)}return e}getTargetDataBySourceData(e,t){return"FORMDETAIL"===e?t.map((e=>this.getFormItemPreviewData(e))):t}getPropertyByTag(e){return[]}}class os{async init(e){}getTargetDataBySourceData(e,t){return t}getPropertyByTag(e){return[]}}var ls={install(e){Pe.getInstance().registerProvider("DESIGN",(()=>new rs)),Pe.getInstance().registerProvider("RUNTIME",(()=>new os))}};class cs extends I{async exec(e,t,i,n){return"Create"===e&&i&&(Array.isArray(i)?await Promise.all(i.map((e=>this.calcDefault(t,e)))):await this.calcDefault(t,i)),super.exec(e,t,i,n)}async calcDefault(e,t){let i=1;const n=t.detailtype;let s=n;if("FORMITEM"===n&&(i=0,s=t.detailtype,t.psdefname&&(s=t.psdefname),"SEARCHFORM"===t.formtype&&(s=t.psdefsfitemname),j(s)&&(s=t.srfdecodename)),j(s))return;s=s.toLowerCase();const a=await this.fetchTempDefault(e);if(a.ok&&a.data){const e=a.data,n=new Map,r=new Map;for(e.forEach((e=>{N(e.psdeformdetailname)&&n.set(e.psdeformdetailname.toLowerCase(),e),N(e.psdeformdetailid)&&r.set(e.psdeformdetailid.toLowerCase(),e)}));;){const e=s+(0===i?"":i);if(!n.has(e)&&!r.has(e)){t.psdeformdetailname=e,t.psdeformdetailid=e;break}i+=1}}j(t.srfdecodename)&&j(t.logicname)&&("FORMPAGE"===n?t.logicname="表单分页":"GROUPPANEL"===n?t.logicname="分组面板":"TABPAGE"===n?t.logicname="分页":"BUTTON"===n?t.logicname="按钮":"USERCONTROL"===n?t.logicname="自定义部件":"RAWITEM"===n?t.logicname="直接内容":"DRUIPART"===n?t.logicname="关系界面":"FORMITEM"===n?t.logicname="表单项":"FORMITEMEX"===n?t.logicname="复合表单项":"FORMPART"===n?t.logicname="表单部件":"IFRAME"===n?t.logicname="嵌入页面(iframe)":"TABPANEL"===n?t.logicname="分页面板":"DATAGRID"===n&&(t.logicname="数据表格"))}newEntity(e){return e instanceof ht?e.clone():new ht(this.model,e)}}var ds=Object.defineProperty,us=(e,t,i)=>(((e,t,i)=>{t in e?ds(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class hs extends I{constructor(e,t){super(e,t),us(this,"typeCodeItems");const i=ibiz.hub.getApp(t.appId);this.typeCodeItems=i.codeList.getCodeList("Config__FDLogicType").codeItems}newEntity(e){return e instanceof pt?e.clone():new pt(this.model,e,this.typeCodeItems)}}e("default",{install(e){D.register("formdesign.psdeformdetail",(async(e,t)=>new cs(e,t))),D.register("formdesign.psdefdlogic",(async(e,t)=>new hs(e,t))),e.use(ls),e.use(ns),e.use(S),e.use(_e),e.use(Gt),e.use(Zi),e.use(ts),E("VIEW_CUSTOM_DndDesign",(()=>new Te)),E("VIEW_CUSTOM_DndDesign_DESIGN",(()=>new Te)),E("VIEW_CUSTOM_FORM_PREVIEW_VIEW",(()=>new je))}})}}}));
