System.register(["@ibiz-template/runtime","@ibiz-template/core","qx-util","vue","@ibiz-template/vue3-util","lodash-es"],(function(e){"use strict";var t,n,o,a,s,i,r,l,d,c,u,h,p,f,v,m,y,_,g,x,b,N,D,w,C,I,k,S,T;return{setters:[function(e){t=e.UIActionProviderBase,n=e.TreeService,o=e.TreeController,a=e.UIActionUtil,s=e.getControlPanel,i=e.registerControlProvider,r=e.registerUIActionProvider},function(e){l=e.RuntimeModelError,d=e.RuntimeError},function(e){c=e.isArray,u=e.createUUID},function(e){h=e.defineComponent,p=e.ref,f=e.createVNode,v=e.createTextVNode,m=e.resolveComponent,y=e.watch,_=e.computed,g=e.nextTick,x=e.onMounted,b=e.onUnmounted,N=e.withDirectives,D=e.resolveDirective,w=e.isVNode},function(e){C=e.useNamespace,I=e.useControlController,k=e.withInstall},function(e){S=e.debounce,T=e.isNil}],execute:function(){const E=h({name:"IBizCodeListSelect",props:{codeListId:{type:String,required:!0},context:{type:Object,required:!0},params:{type:Object}},emits:["select"],setup(e,{emit:t}){const n=C("codelist-select"),o=p();ibiz.hub.getApp(e.context.srfappid).codeList.get(e.codeListId,e.context,e.params).then((e=>{o.value=e}));return{ns:n,codeListItems:o,onSelect:e=>{t("select",e)}}},render(){var e;return f("div",{class:[this.ns.b()]},[f("div",{class:[this.ns.e("header")]},[v("新建")]),f("div",{class:[this.ns.e("items")]},[null==(e=this.codeListItems)?void 0:e.map((e=>f("div",{class:[this.ns.b("item")],onClick:()=>this.onSelect(e)},[e.sysImage&&f(m("iBizIcon"),{class:[this.ns.be("item","icon")],icon:e.sysImage},null),f("div",{class:[this.ns.be("item","text")]},[e.text])])))])])}});class A extends t{async execAction(e,t){const{context:n,params:o,data:a,event:s}=t,i={},r=e.appDataEntityId,d=e.appDEMethodId;if(!r||!d)throw new l(e,"未配置实体或实体行为");const u=n.clone(),h=e.userTag;if(h){let e=null;const t=ibiz.overlay.createPopover(E,{codeListId:h,context:u,params:o,onSelect:n=>{e=n,t.dismiss()}},{autoClose:!0,placement:"right",noArrow:!0});if(t.present(s.target),await t.onWillDismiss(),!e)return{cancel:!0};u.srfselectedtype=e.value}
//! 处理参数，需要配置srfselectedtype的转换,才能在视图参数里有对应的参数
const{resultContext:p,resultParams:f}=await this.handleParams(e,u,a,o),v={...f},m=ibiz.hub.getApp(null==u?void 0:u.srfappid),y=await m.deService.exec(r,d,p,v);if(y.ok){const n=this.calcMessage("success",e,t);n&&ibiz.message.success(n)}return Object.assign(i,{data:c(y.data)?y.data:[y.data],nextContext:p,nextParams:v,toSelectSrfkey:y.data.srfkey}),i}}function P(e,t){const n=t.state.items.find((t=>t._id===e));return n||t.state.items.find((t=>t._uuid===e))}class z extends n{getNodeRSFilterParams(e,t,n){const o=super.getNodeRSFilterParams(e,t,n),a=/^n_.*_eq$/;return Object.keys(o.navParams).forEach((e=>{a.test(e)&&delete o.navParams[e]})),Object.keys(o.params).forEach((e=>{a.test(e)&&delete o.params[e]})),o}}var K=Object.defineProperty,L=(e,t,n)=>(((e,t,n)=>{t in e?K(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);class B extends o{constructor(){super(...arguments),L(this,"toSelectSrfkey","")}async initService(){this.service=new z(this.model),await this.service.init(this.context)}setToSelectData(){if(!this.toSelectSrfkey)return;const e=this.state.items.find((e=>e.srfkey===this.toSelectSrfkey));e&&(this.onTreeNodeClick(e,{}),this.toSelectSrfkey="")}async onCreated(){var e;null==(e=this.model.detreeNodes)||e.forEach((e=>{e.rootNode&&(e.allowDrop=!0)})),await super.onCreated()}async afterLoad(e,t){return this.setToSelectData(),t}onDataChange(e){if(e.data&&e.data.srfdecodename===this.dataEntity.codeName&&this.state.activated){const t=this.state.items.find((t=>t.srfkey===e.data.srfkey));t&&(t._deData=e.data)}}calcAllowDrop(e,t,n){const o="inner"===n?t:t._parent;if((null==o?void 0:o._deData)&&!T(o._deData.srfallowdrop))return o._deData.srfallowdrop;return super.calcAllowDrop(e,t,n)}async onNodeDrop(e,t,n){var o,a,s;"inner"!==n||t._leaf||void 0!==t._children||await this.expandNodeByKey([t._id]);const i=[],r=this.getNodeModel(e._nodeId),d="inner"===n?t:t._parent,c=(null==t?void 0:t._id)!==(null==(o=e._parent)?void 0:o._id);let u=this.getNodeModel(t._nodeId);if("inner"===n||(null==(a=t._parent)?void 0:a._id)!==(null==(s=e._parent)?void 0:s._id)){const t=this.findDropNodeRS(d._nodeId,r.appDataEntityId);t&&(e._deData[t.pickupDEFName]=T(d._value)?null:d._value,i.push(e),u=this.getNodeModel(t.childDETreeNodeId))}const h=e._parent._children;if(h.splice(h.indexOf(e),1),"inner"===n)t._children||(t._children=[],t._leaf=!0,this.state.expandedKeys.push(t._id)),t._children.push(e);else{let o=d._children.indexOf(t);"next"===n&&(o+=1),d._children.splice(o,0,e)}("inner"===n||c)&&(e._parent=d,e._nodeId=u.id,this.state.expandedKeys=this.calcExpandedKeys([d]));const{sortAppDEFieldId:p,sortDir:f,allowOrder:v}=u;if(!0===v){if(!p)throw new l(u,"缺少配置排序属性");const t=p.toLowerCase(),n="ASC"===f,o=[...d._children];n||o.reverse();const a=e=>e+(100-e%100),s=e=>e[t]||0;let r;o.forEach(((n,l)=>{const d=n._deData;void 0===r?n===e&&(r=0===l?100:a(s(o[l-1]._deData)),d[t]=r,-1===i.indexOf(n)&&i.push(n)):(r>=s(d)&&(d[t]=a(r),i.push(n)),r=s(d))}))}await this.updateDeNodeData(i),this._evt.emit("onAfterNodeDrop",{isChangedParent:c})}remove(e){return(e||{}).silent=!0,super.remove(e)}async doUIAction(e,t,n,o){const s=this.getEventArgs(),i=this.parseTreeNodeData(t),r=await a.exec(e,{...s,...i,event:n},o);if(r.closeView)this.view.closeView();else if(r.refresh)switch(r.refreshMode){case 1:await this.refreshNodeChildren(t);break;case 2:await this.refreshNodeChildren(t,!0);break;case 3:await this.refresh()}const{toSelectSrfkey:l}=r;l&&(this.toSelectSrfkey=l,this.setToSelectData())}}const O=h({name:"IBizLogicTreeDesignTree",props:{modelData:{type:Object,required:!0},context:{type:Object,required:!0},params:{type:Object,default:()=>({})},provider:{type:Object},mdctrlActiveMode:{type:Number,default:void 0},singleSelect:{type:Boolean,default:void 0},navigational:{type:Boolean,default:void 0},defaultExpandedKeys:{type:Array},loadDefault:{type:Boolean,default:!0}},setup(){const e=I(((...e)=>new B(...e))),t=C("logic-tree-design-tree"),n=p(null),o=p(null),a=p(""),s=p(null),i=p(null),r=p(null);y((()=>s.value),(e=>{e&&e.$el.getElementsByTagName("input")[0].focus()}));const l=()=>{var t;const o=null==(t=n.value)?void 0:t.getCurrentKey();if(!o||o===i.value)return;const a=P(o,e),s=e.getNodeModel(a._nodeId);(null==s?void 0:s.allowEditText)&&(i.value=o)},{updateUI:c}=function(e,t){const n=()=>{const t=e.value;if(!t)throw new d("找不到el-tree实例对象");return t},o=()=>{var n;const a=e.value;a?(Object.values(a.store.nodesMap).forEach((e=>{const n=t.state.expandedKeys.includes(e.data._id);n!==e.expanded&&(n?e.expand():e.collapse())})),t.state.singleSelect?e.value.setCurrentKey((null==(n=t.state.selectedData[0])?void 0:n._id)||void 0):a.setCheckedKeys(t.state.selectedData.map((e=>e._id)))):setTimeout((()=>{o()}),200)},a=S(o,500);return{getTreeInstance:n,updateUI:a,triggerNodeExpand:e=>{const t=n().store.nodesMap[e];if(t)return t.expanded?(t.collapse(),!1):(t.expand(),!0)}}}(n,e),h=e=>e.map((e=>({_id:e._id,_uuid:e._uuid,_leaf:e._leaf||e._children&&0===e._children.length,_text:e._text})));e.evt.on("onAfterRefreshParent",(e=>{if(n.value){const{parentNode:t,children:o}=e,a=h(o);n.value.updateKeyChildren(t._id,a),c()}})),e.evt.on("onAfterNodeDrop",(e=>{e.isChangedParent&&(a.value=u())}));const v=_((()=>e.state.isLoaded?e.model.rootVisible?e.state.rootNodes:e.state.rootNodes.reduce(((e,t)=>t._children?e.concat(t._children):e),[]):[]));y(v,((e,t)=>{e!==t&&(a.value=u())}));let N=!1;e.evt.on("onLoadSuccess",(()=>{N=!0,setTimeout((()=>{N=!1}),200)})),e.evt.on("onSelectionChange",(async()=>{var t;N&&await g(),e.state.singleSelect?n.value.setCurrentKey((null==(t=e.state.selectedData[0])?void 0:t._id)||void 0):n.value.setCheckedKeys(e.state.selectedData.map((e=>e._id)))}));let D=!1;const w=m("IBizIcon"),k=S((()=>{e.load()}),500),T=e=>{"F2"!==e.code&&"Enter"!==e.code||l()};x((()=>{var e;null==(e=o.value)||e.$el.addEventListener("keydown",T)})),b((()=>{var e;null==(e=o.value)||e.$el.removeEventListener("keydown",T)}));return{c:e,ns:t,treeRef:n,treeviewRef:o,treeNodeTextInputRef:s,treeData:v,treeRefreshKey:a,editingNodeKey:i,editingNodeText:r,findNodeData:P,onCheck:(t,n)=>{const{checkedNodes:o}=n;e.setSelection(o)},onNodeClick:(t,o)=>{var a,s;o.stopPropagation(),D||((null==(a=n.value)?void 0:a.getCurrentKey())===t._id&&l(),e.state.singleSelect||null==(s=n.value)||s.setCurrentKey(t._id),e.onTreeNodeClick(t,o),D=!0,setTimeout((()=>{D=!1}),200))},onNodeDbClick:(t,n)=>{n.stopPropagation(),e.onDbTreeNodeClick(t)},loadData:async(t,n)=>{let o;if(0===t.level)o=v.value,ibiz.log.debug("初始加载");else{const n=P(t.data._uuid,e);if(!n)return;n._children?(ibiz.log.debug("节点展开加载-本地",n),o=n._children):(ibiz.log.debug("节点展开加载-远程",n),o=await e.loadNodes(n))}ibiz.log.debug("给树返回值",o),n(h(o)),c()},renderContextMenu:(n,o)=>{var a,s,i;if(!(null==(s=null==(a=null==n?void 0:n.decontextMenu)?void 0:a.detoolbarItems)?void 0:s.length))return;const r=null==(i=o._deData)?void 0:i.srftype;return f("div",{class:t.b("context-menu")},[n.decontextMenu.detoolbarItems.map((t=>t.userTag&&r&&r!==t.userTag||!0===e.context.srfreadonly||"true"===e.context.srfreadonly?null:f(m("el-button"),{text:!0,size:"small",onClick:n=>{n.stopPropagation(),e.doUIAction(t.uiactionId,o,n,t.appId)},title:t.tooltip},{default:()=>[f(w,{icon:t.sysImage},null)]})))])},updateNodeExpand:(t,n)=>{const o=P(t._uuid,e);if(!o)throw new d("没有找到_uuid为".concat(t._uuid,"的节点"));e.onExpandChange(o,n)},onInput:t=>{e.state.query=t,k()},allowDrop:(t,n,o)=>{const a=P(t.data._uuid,e),s=P(n.data._uuid,e);return e.calcAllowDrop(a,s,o)},allowDrag:t=>{const n=P(t.data._uuid,e);return e.calcAllowDrag(n)},handleDrop:(t,n,o)=>{const a=function(e){switch(e){case"inner":return"inner";case"before":return"prev";case"after":return"next";default:throw new d("暂不支持dropType:".concat(e))}}(o),s=P(t.data._uuid,e),i=P(n.data._uuid,e);e.onNodeDrop(s,i,a)},onNodeTextEditBlur:async()=>{if(i.value)if(r.value){const t=P(i.value,e);await e.modifyNodeText(t,r.value),i.value=null,r.value=null}else i.value=null},renderDeNode:e=>{const n=e._deData;return[n.srficon&&f(w,{class:t.be("node","icon"),icon:n.srficon},null),f("span",{title:n.srfmajortext,class:t.be("node","label")},[n.srfmajortext])]}}},render(){const e={searchbar:()=>this.c.enableQuickSearch?f(m("el-input"),{"model-value":this.c.state.query,class:[this.ns.b("quick-search"),this.ns.b("quick-search")],placeholder:this.c.state.placeHolder,onInput:this.onInput},{prefix:()=>f("ion-icon",{class:this.ns.e("search-icon"),name:"search"},null)}):null},t=this.c.controlPanel?"tree":"default",n=!0===this.c.context.srfreadonly||"true"===this.c.context.srfreadonly;return e[t]=()=>{if(this.c.state.isLoaded&&this.treeRefreshKey)return f(m("el-tree"),{ref:"treeRef",key:this.treeRefreshKey,"node-key":"_id","highlight-current":!0,"expand-on-click-node":!1,"auto-expand-parent":!1,"show-checkbox":!this.c.state.singleSelect,"check-strictly":!0,"default-expanded-keys":this.c.state.expandedKeys,props:{label:"_text",children:"_children",isLeaf:"_leaf"},lazy:!0,load:this.loadData,onCheck:this.onCheck,onNodeExpand:e=>{this.updateNodeExpand(e,!0)},onNodeCollapse:e=>{this.updateNodeExpand(e,!1)},draggable:!n,"allow-drop":this.allowDrop,"allow-drag":this.allowDrag,onNodeDrop:this.handleDrop},{default:({data:e})=>{var t,n;const o=this.findNodeData(e._uuid,this.c);if(!o)return null;const a=this.c.getNodeModel(o._nodeId);if(this.editingNodeKey===o._id)return f("div",{class:[this.ns.b("node"),null==(t=a.sysCss)?void 0:t.cssName]},[f(m("el-input"),{modelValue:this.editingNodeText,"onUpdate:modelValue":e=>this.editingNodeText=e,ref:"treeNodeTextInputRef",class:this.ns.b("editing-node"),onBlur:()=>{this.onNodeTextEditBlur()},onKeydown:e=>{e.stopPropagation(),"Enter"===e.code&&this.onNodeTextEditBlur()}},null)]);const i=s(a);let r;return r=i?f(m("iBizControlShell"),{data:o,modelData:i,context:this.c.context,params:this.c.params},null):"DE"===a.treeNodeType?this.renderDeNode(o):[o._icon?f(m("iBizIcon"),{class:this.ns.be("node","icon"),icon:o._icon},null):null,o._textHtml?f("span",{class:this.ns.be("node","label"),innerHTML:o._textHtml},null):f("span",{class:this.ns.be("node","label")},[o._text])],f("div",{onDblclick:e=>this.onNodeDbClick(o,e),onClick:e=>this.onNodeClick(o,e),class:[this.ns.b("node"),null==(n=a.sysCss)?void 0:n.cssName,a.rootNode?this.ns.bm("node","root"):""]},[r,this.renderContextMenu(a,o)])}})},N(f(m("iBizControlBase"),{ref:"treeviewRef",controller:this.c},"function"==typeof(o=e)||"[object Object]"===Object.prototype.toString.call(o)&&!w(o)?e:{default:()=>[e]}),[[D("loading"),this.c.state.isLoading]]);var o}});var M=Object.defineProperty,R=(e,t,n)=>(((e,t,n)=>{t in e?M(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);class j{constructor(){R(this,"component","IBizLogicTreeDesignTree")}}const U="LogicTreeDesign",q=k(O,(function(e){e.component(O.name,O),i("TREE_RENDER_".concat(U,"_Tree"),(()=>new j))}));e("default",{install(e){const t=new A;r("DEUIACTION_".concat(U,"_AddLogic"),(()=>t)),e.use(q)}})}}}));
